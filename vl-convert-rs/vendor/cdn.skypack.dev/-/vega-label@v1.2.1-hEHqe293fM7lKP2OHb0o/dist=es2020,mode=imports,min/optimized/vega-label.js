import{textMetrics as U,Marks as ot}from"/-/vega-scenegraph@v4.11.2-ECjtKQ59x40n6e1Sr54c/dist=es2020,mode=imports,min/optimized/vega-scenegraph.js";import{canvas as X}from"/-/vega-canvas@v1.2.7-hCEcvULuKIOqBVGX1Tn8/dist=es2020,mode=imports,min/optimized/vega-canvas.js";import{Transform as nt,rederive as ft}from"/-/vega-dataflow@v5.7.5-asKYS4gpPLMPf64pSozt/dist=es2020,mode=imports,min/optimized/vega-dataflow.js";import{inherits as lt,isFunction as ut,error as st,array as rt}from"/-/vega-util@v1.17.2-LUfkDhormMyfWqy3Ts6U/dist=es2020,mode=imports,min/optimized/vega-util.js";const K=4278190080;function mt(t,a){const f=t.bitmap();return(a||[]).forEach(l=>f.set(t(l.boundary[0]),t(l.boundary[3]))),[f,void 0]}function ct(t,a,f,l,i){const n=t.width,e=t.height,m=l||i,A=X(n,e).getContext("2d"),r=X(n,e).getContext("2d"),s=m&&X(n,e).getContext("2d");f.forEach(y=>H(A,y,!1)),H(r,a,!1),m&&H(s,a,!0);const d=Y(A,n,e),o=Y(r,n,e),u=m&&Y(s,n,e),c=t.bitmap(),b=m&&t.bitmap();let g,v,x,p,w,k,R,h;for(v=0;v<e;++v)for(g=0;g<n;++g)w=v*n+g,k=d[w]&K,h=o[w]&K,R=m&&u[w]&K,(k||R||h)&&(x=t(g),p=t(v),!i&&(k||h)&&c.set(x,p),m&&(k||R)&&b.set(x,p));return[c,b]}function Y(t,a,f){return new Uint32Array(t.getImageData(0,0,a,f).data.buffer)}function H(t,a,f){if(!a.length)return;const l=a[0].mark.marktype;l==="group"?a.forEach(i=>{i.items.forEach(n=>H(t,n.items,f))}):ot[l].draw(t,{items:f?a.map(dt):a})}function dt(t){const a=ft(t,{});return a.stroke&&a.strokeOpacity!==0||a.fill&&a.fillOpacity!==0?{...a,strokeOpacity:1,stroke:"#000",fillOpacity:0}:a}const L=5,S=31,j=32,C=new Uint32Array(j+1),B=new Uint32Array(j+1);B[0]=0,C[0]=~B[0];for(let t=1;t<=j;++t)B[t]=B[t-1]<<1|1,C[t]=~B[t];function ht(t,a){const f=new Uint32Array(~~((t*a+j)/j));function l(n,e){f[n]|=e}function i(n,e){f[n]&=e}return{array:f,get:(n,e)=>{const m=e*t+n;return f[m>>>L]&1<<(m&S)},set:(n,e)=>{const m=e*t+n;l(m>>>L,1<<(m&S))},clear:(n,e)=>{const m=e*t+n;i(m>>>L,~(1<<(m&S)))},getRange:(n,e,m,A)=>{let r=A,s,d,o,u;for(;r>=e;--r)if(s=r*t+n,d=r*t+m,o=s>>>L,u=d>>>L,o===u){if(f[o]&C[s&S]&B[(d&S)+1])return!0}else{if(f[o]&C[s&S])return!0;if(f[u]&B[(d&S)+1])return!0;for(let c=o+1;c<u;++c)if(f[c])return!0}return!1},setRange:(n,e,m,A)=>{let r,s,d,o,u;for(;e<=A;++e)if(r=e*t+n,s=e*t+m,d=r>>>L,o=s>>>L,d===o)l(d,C[r&S]&B[(s&S)+1]);else for(l(d,C[r&S]),l(o,B[(s&S)+1]),u=d+1;u<o;++u)l(u,4294967295)},clearRange:(n,e,m,A)=>{let r,s,d,o,u;for(;e<=A;++e)if(r=e*t+n,s=e*t+m,d=r>>>L,o=s>>>L,d===o)i(d,B[r&S]|C[(s&S)+1]);else for(i(d,B[r&S]),i(o,C[(s&S)+1]),u=d+1;u<o;++u)i(u,0)},outOfBounds:(n,e,m,A)=>n<0||e<0||A>=a||m>=t}}function yt(t,a,f){const l=Math.max(1,Math.sqrt(t*a/1e6)),i=~~((t+2*f+l)/l),n=~~((a+2*f+l)/l),e=m=>~~((m+f)/l);return e.invert=m=>m*l-f,e.bitmap=()=>ht(i,n),e.ratio=l,e.padding=f,e.width=t,e.height=a,e}function xt(t,a,f,l){const i=t.width,n=t.height;return function(e){const m=e.datum.datum.items[l].items,A=m.length,r=e.datum.fontSize,s=U.width(e.datum,e.datum.text);let d=0,o,u,c,b,g,v,x;for(let p=0;p<A;++p)o=m[p].x,c=m[p].y,u=m[p].x2===void 0?o:m[p].x2,b=m[p].y2===void 0?c:m[p].y2,g=(o+u)/2,v=(c+b)/2,x=Math.abs(u-o+b-c),x>=d&&(d=x,e.x=g,e.y=v);return g=s/2,v=r/2,o=e.x-g,u=e.x+g,c=e.y-v,b=e.y+v,e.align="center",o<0&&u<=i?e.align="left":0<=o&&i<u&&(e.align="right"),e.baseline="middle",c<0&&b<=n?e.baseline="top":0<=c&&n<b&&(e.baseline="bottom"),!0}}function q(t,a,f,l,i,n){let e=f/2;return t-e<0||t+e>i||a-(e=l/2)<0||a+e>n}function P(t,a,f,l,i,n,e,m){const A=i*n/(l*2),r=t(a-A),s=t(a+A),d=t(f-(n=n/2)),o=t(f+n);return e.outOfBounds(r,d,s,o)||e.getRange(r,d,s,o)||m&&m.getRange(r,d,s,o)}function gt(t,a,f,l){const i=t.width,n=t.height,e=a[0],m=a[1];function A(r,s,d,o,u){const c=t.invert(r),b=t.invert(s);let g=d,v=n,x;if(!q(c,b,o,u,i,n)&&!P(t,c,b,u,o,g,e,m)&&!P(t,c,b,u,o,u,e,null)){for(;v-g>=1;)x=(g+v)/2,P(t,c,b,u,o,x,e,m)?v=x:g=x;if(g>d)return[c,b,g,!0]}}return function(r){const s=r.datum.datum.items[l].items,d=s.length,o=r.datum.fontSize,u=U.width(r.datum,r.datum.text);let c=f?o:0,b=!1,g=!1,v=0,x,p,w,k,R,h,y,z,M,E,O,I,F,T,W,N,G;for(let D=0;D<d;++D){for(x=s[D].x,w=s[D].y,p=s[D].x2===void 0?x:s[D].x2,k=s[D].y2===void 0?w:s[D].y2,x>p&&(G=x,x=p,p=G),w>k&&(G=w,w=k,k=G),M=t(x),O=t(p),E=~~((M+O)/2),I=t(w),T=t(k),F=~~((I+T)/2),y=E;y>=M;--y)for(z=F;z>=I;--z)N=A(y,z,c,u,o),N&&([r.x,r.y,c,b]=N);for(y=E;y<=O;++y)for(z=F;z<=T;++z)N=A(y,z,c,u,o),N&&([r.x,r.y,c,b]=N);!b&&!f&&(W=Math.abs(p-x+k-w),R=(x+p)/2,h=(w+k)/2,W>=v&&!q(R,h,u,o,i,n)&&!P(t,R,h,o,u,o,e,null)&&(v=W,r.x=R,r.y=h,g=!0))}return b||g?(R=u/2,h=o/2,e.setRange(t(r.x-R),t(r.y-h),t(r.x+R),t(r.y+h)),r.align="center",r.baseline="middle",!0):!1}}const pt=[-1,-1,1,1],bt=[-1,1,-1,1];function vt(t,a,f,l){const i=t.width,n=t.height,e=a[0],m=a[1],A=t.bitmap();return function(r){const s=r.datum.datum.items[l].items,d=s.length,o=r.datum.fontSize,u=U.width(r.datum,r.datum.text),c=[];let b=f?o:0,g=!1,v=!1,x=0,p,w,k,R,h,y,z,M,E,O,I,F;for(let T=0;T<d;++T){for(p=s[T].x,k=s[T].y,w=s[T].x2===void 0?p:s[T].x2,R=s[T].y2===void 0?k:s[T].y2,c.push([t((p+w)/2),t((k+R)/2)]);c.length;){if([z,M]=c.pop(),e.get(z,M)||m.get(z,M)||A.get(z,M))continue;A.set(z,M);for(let W=0;W<4;++W)h=z+pt[W],y=M+bt[W],A.outOfBounds(h,y,h,y)||c.push([h,y]);if(h=t.invert(z),y=t.invert(M),E=b,O=n,!q(h,y,u,o,i,n)&&!P(t,h,y,o,u,E,e,m)&&!P(t,h,y,o,u,o,e,null)){for(;O-E>=1;)I=(E+O)/2,P(t,h,y,o,u,I,e,m)?O=I:E=I;E>b&&(r.x=h,r.y=y,b=E,g=!0)}}!g&&!f&&(F=Math.abs(w-p+R-k),h=(p+w)/2,y=(k+R)/2,F>=x&&!q(h,y,u,o,i,n)&&!P(t,h,y,o,u,o,e,null)&&(x=F,r.x=h,r.y=y,v=!0))}return g||v?(h=u/2,y=o/2,e.setRange(t(r.x-h),t(r.y-y),t(r.x+h),t(r.y+y)),r.align="center",r.baseline="middle",!0):!1}}const At=["right","center","left"],Mt=["bottom","middle","top"];function wt(t,a,f,l){const i=t.width,n=t.height,e=a[0],m=a[1],A=l.length;return function(r){const s=r.boundary,d=r.datum.fontSize;if(s[2]<0||s[5]<0||s[0]>i||s[3]>n)return!1;let o=r.textWidth??0,u,c,b,g,v,x,p,w,k,R,h,y,z,M,E;for(let O=0;O<A;++O){if(u=(f[O]&3)-1,c=(f[O]>>>2&3)-1,b=u===0&&c===0||l[O]<0,g=u&&c?Math.SQRT1_2:1,v=l[O]<0?-1:1,x=s[1+u]+l[O]*u*g,h=s[4+c]+v*d*c/2+l[O]*c*g,w=h-d/2,k=h+d/2,y=t(x),M=t(w),E=t(k),!o)if(at(y,y,M,E,e,m,x,x,w,k,s,b))o=U.width(r.datum,r.datum.text);else continue;if(R=x+v*o*u/2,x=R-o/2,p=R+o/2,y=t(x),z=t(p),at(y,z,M,E,e,m,x,p,w,k,s,b))return r.x=u?u*v<0?p:x:R,r.y=c?c*v<0?k:w:h,r.align=At[u*v+1],r.baseline=Mt[c*v+1],e.setRange(y,M,z,E),!0}return!1}}function at(t,a,f,l,i,n,e,m,A,r,s,d){return!(i.outOfBounds(t,f,a,l)||(d&&n||i).getRange(t,f,a,l))}const V=0,Z=4,J=8,Q=0,_=1,$=2,kt={"top-left":V+Q,top:V+_,"top-right":V+$,left:Z+Q,middle:Z+_,right:Z+$,"bottom-left":J+Q,bottom:J+_,"bottom-right":J+$},Rt={naive:xt,"reduced-search":gt,floodfill:vt};function Ot(t,a,f,l,i,n,e,m,A,r,s){if(!t.length)return t;const d=Math.max(l.length,i.length),o=zt(l,d),u=Et(i,d),c=St(t[0].datum),b=c==="group"&&t[0].datum.items[A].marktype,g=b==="area",v=Tt(c,b,m,A),x=r===null||r===Infinity,p=g&&s==="naive";let w=-1,k=-1;const R=t.map(M=>{const E=x?U.width(M,M.text):void 0;return w=Math.max(w,E),k=Math.max(k,M.fontSize),{datum:M,opacity:0,x:void 0,y:void 0,align:void 0,baseline:void 0,boundary:v(M),textWidth:E}});r=r===null||r===Infinity?Math.max(w,k)+Math.max(...l):r;const h=yt(a[0],a[1],r);let y;if(!p){f&&R.sort((O,I)=>f(O.datum,I.datum));let M=!1;for(let O=0;O<u.length&&!M;++O)M=u[O]===5||o[O]<0;const E=(c&&e||g)&&t.map(O=>O.datum);y=n.length||E?ct(h,E||[],n,M,g):mt(h,e&&R)}const z=g?Rt[s](h,y,e,A):wt(h,y,u,o);return R.forEach(M=>M.opacity=+z(M)),R}function zt(t,a){const f=new Float64Array(a),l=t.length;for(let i=0;i<l;++i)f[i]=t[i]||0;for(let i=l;i<a;++i)f[i]=f[l-1];return f}function Et(t,a){const f=new Int8Array(a),l=t.length;for(let i=0;i<l;++i)f[i]|=kt[t[i]];for(let i=l;i<a;++i)f[i]=f[l-1];return f}function St(t){return t&&t.mark&&t.mark.marktype}function Tt(t,a,f,l){const i=n=>[n.x,n.x,n.x,n.y,n.y,n.y];return t?t==="line"||t==="area"?n=>i(n.datum):a==="line"?n=>{const e=n.datum.items[l].items;return i(e.length?e[f==="start"?0:e.length-1]:{x:NaN,y:NaN})}:n=>{const e=n.datum.bounds;return[e.x1,(e.x1+e.x2)/2,e.x2,e.y1,(e.y1+e.y2)/2,e.y2]}:i}const tt=["x","y","opacity","align","baseline"],it=["top-left","left","bottom-left","top","bottom","top-right","right","bottom-right"];function et(t){nt.call(this,null,t)}et.Definition={type:"Label",metadata:{modifies:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"sort",type:"compare"},{name:"anchor",type:"string",array:!0,default:it},{name:"offset",type:"number",array:!0,default:[1]},{name:"padding",type:"number",default:0,null:!0},{name:"lineAnchor",type:"string",values:["start","end"],default:"end"},{name:"markIndex",type:"number",default:0},{name:"avoidBaseMark",type:"boolean",default:!0},{name:"avoidMarks",type:"data",array:!0},{name:"method",type:"string",default:"naive"},{name:"as",type:"string",array:!0,length:tt.length,default:tt}]},lt(et,nt,{transform(t,a){function f(n){const e=t[n];return ut(e)&&a.modified(e.fields)}const l=t.modified();if(!(l||a.changed(a.ADD_REM)||f("sort")))return;(!t.size||t.size.length!==2)&&st("Size parameter should be specified as a [width, height] array.");const i=t.as||tt;return Ot(a.materialize(a.SOURCE).source||[],t.size,t.sort,rt(t.offset==null?1:t.offset),rt(t.anchor||it),t.avoidMarks||[],t.avoidBaseMark!==!1,t.lineAnchor||"end",t.markIndex||0,t.padding===void 0?0:t.padding,t.method||"naive").forEach(n=>{const e=n.datum;e[i[0]]=n.x,e[i[1]]=n.y,e[i[2]]=n.opacity,e[i[3]]=n.align,e[i[4]]=n.baseline}),a.reflow(l).modifies(i)}});export{et as label};export default null;
