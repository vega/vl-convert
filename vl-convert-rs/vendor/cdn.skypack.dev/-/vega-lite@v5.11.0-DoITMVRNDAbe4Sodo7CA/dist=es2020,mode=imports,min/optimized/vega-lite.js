import{hasOwnProperty as on,isNumber as G,isString as F,writeConfig as wf,splitAccessPath as an,stringValue as A,isObject as M,isBoolean as Dn,isArray as v,array as q,logger as $f,Warn as vf,isFunction as Ef,mergeConfig as Vo,identity as _f}from"/-/vega-util@v1.17.2-LUfkDhormMyfWqy3Ts6U/dist=es2020,mode=imports,min/optimized/vega-util.js";import kf from"/-/clone@v2.1.2-inH2VLNzDGiYU9HUWyZM/dist=es2020,mode=imports,min/optimized/clone.js";import Cf from"/-/fast-deep-equal@v3.1.3-ysejKs1WDEDPxUJhgGoP/dist=es2020,mode=imports,min/optimized/fast-deep-equal.js";import _r from"/-/fast-json-stable-stringify@v2.1.0-HLgsuOtxPikt0pw16nth/dist=es2020,mode=imports,min/optimized/fast-json-stable-stringify.js";import{isObject as kr,writeConfig as Nf,isArray as Xo,isString as gi}from"/-/vega@v5.25.0-r16knbfAAfBFDoUvoc7K/dist=es2020,mode=imports,min/optimized/vega.js";import{parseSelector as cn}from"/-/vega-event-selector@v3.0.1-UgiEAWJA4WQL4DTKnV4R/dist=es2020,mode=imports,min/optimized/vega-event-selector.js";import{parseExpression as Ff}from"/-/vega-expression@v5.1.0-2VnsdaYPtQ6Pi5w8JxN8/dist=es2020,mode=imports,min/optimized/vega-expression.js";const Tf="vega-lite",Af='Dominik Moritz, Kanit "Ham" Wongsuphasawat, Arvind Satyanarayan, Jeffrey Heer',Of="5.11.0",Pf=["Kanit Wongsuphasawat (http://kanitw.yellowpigz.com)","Dominik Moritz (https://www.domoritz.de)","Arvind Satyanarayan (https://arvindsatya.com)","Jeffrey Heer (https://jheer.org)"],zf="https://vega.github.io/vega-lite/",Rf="Vega-Lite is a concise high-level language for interactive visualization.",If=["vega","chart","visualization"],Lf="build/vega-lite.js",Mf="build/vega-lite.min.js",Df="build/vega-lite.min.js",jf="build/src/index",Uf="build/src/index.d.ts",Bf={vl2pdf:"./bin/vl2pdf",vl2png:"./bin/vl2png",vl2svg:"./bin/vl2svg",vl2vg:"./bin/vl2vg"},Wf=["bin","build","src","vega-lite*","tsconfig.json"],Hf={changelog:"conventional-changelog -p angular -r 2",prebuild:"yarn clean:build",build:"yarn build:only","build:only":"tsc -p tsconfig.build.json && rollup -c","prebuild:examples":"yarn build:only","build:examples":"yarn data && TZ=America/Los_Angeles scripts/build-examples.sh","prebuild:examples-full":"yarn build:only","build:examples-full":"TZ=America/Los_Angeles scripts/build-examples.sh 1","build:example":"TZ=America/Los_Angeles scripts/build-example.sh","build:toc":"yarn build:jekyll && scripts/generate-toc","build:site":"rollup -c site/rollup.config.mjs","build:jekyll":"pushd site && bundle exec jekyll build -q && popd","build:versions":"scripts/update-version.sh",clean:"yarn clean:build && del-cli 'site/data/*' 'examples/compiled/*.png' && find site/examples ! -name 'index.md' ! -name 'data' -type f -delete","clean:build":"del-cli 'build/*' !build/vega-lite-schema.json",data:"rsync -r node_modules/vega-datasets/data/* site/data",schema:"mkdir -p build && ts-json-schema-generator -f tsconfig.json -p src/index.ts -t TopLevelSpec --no-type-check --no-ref-encode > build/vega-lite-schema.json && yarn renameschema && cp build/vega-lite-schema.json site/_data/",renameschema:"scripts/rename-schema.sh",presite:"yarn data && yarn schema && yarn build:site && yarn build:versions && scripts/create-example-pages.sh",site:"yarn site:only","site:only":"pushd site && bundle exec jekyll serve -I -l && popd",prettierbase:"prettier '**/*.{md,css,yml}'",format:"eslint . --fix && yarn prettierbase --write",lint:"eslint . && yarn prettierbase --check",jest:"NODE_OPTIONS=--experimental-vm-modules npx jest",test:"yarn jest test/ && yarn lint && yarn schema && yarn jest examples/ && yarn test:runtime","test:cover":"yarn jest --collectCoverage test/","test:inspect":"node --inspect-brk --experimental-vm-modules ./node_modules/.bin/jest --runInBand test","test:runtime":"NODE_OPTIONS=--experimental-vm-modules TZ=America/Los_Angeles npx jest test-runtime/ --config test-runtime/jest-config.json","test:runtime:generate":"yarn build:only && del-cli test-runtime/resources && VL_GENERATE_TESTS=true yarn test:runtime",watch:"tsc -p tsconfig.build.json -w","watch:site":"yarn build:site -w","watch:test":"yarn jest --watch test/","watch:test:runtime":"NODE_OPTIONS=--experimental-vm-modules TZ=America/Los_Angeles npx jest --watch test-runtime/ --config test-runtime/jest-config.json",release:"release-it"},qf={type:"git",url:"https://github.com/vega/vega-lite.git"},Gf="BSD-3-Clause",Vf={url:"https://github.com/vega/vega-lite/issues"},Xf={"@babel/core":"^7.21.8","@babel/plugin-proposal-class-properties":"^7.18.6","@babel/preset-env":"^7.21.5","@babel/preset-typescript":"^7.21.5","@release-it/conventional-changelog":"^5.1.1","@rollup/plugin-alias":"^5.0.0","@rollup/plugin-babel":"^6.0.3","@rollup/plugin-commonjs":"^25.0.0","@rollup/plugin-json":"^6.0.0","@rollup/plugin-node-resolve":"^15.0.2","@rollup/plugin-terser":"^0.4.1","@types/chai":"^4.3.5","@types/d3":"^7.4.0","@types/jest":"^27.4.1","@types/pako":"^2.0.0","@typescript-eslint/eslint-plugin":"^5.59.5","@typescript-eslint/parser":"^5.59.5",ajv:"^8.12.0","ajv-formats":"^2.1.1",chai:"^4.3.7",cheerio:"^1.0.0-rc.12","conventional-changelog-cli":"^2.2.2",d3:"^7.8.4","del-cli":"^5.0.0",eslint:"^8.40.0","eslint-config-prettier":"^8.8.0","eslint-plugin-jest":"^27.2.1","eslint-plugin-prettier":"^4.2.1","highlight.js":"^11.8.0",jest:"^27.5.1","jest-dev-server":"^6.1.1",mkdirp:"^3.0.1",pako:"^2.1.0",prettier:"^2.8.8",puppeteer:"^15.0.0","release-it":"^15.10.3",rollup:"^3.21.6","rollup-plugin-bundle-size":"^1.0.3","rollup-plugin-sourcemaps":"^0.6.3",serve:"^14.2.0",terser:"^5.17.3","ts-jest":"^29.1.0","ts-json-schema-generator":"^1.2.0",typescript:"~4.9.5","vega-cli":"^5.25.0","vega-datasets":"^2.7.0","vega-embed":"^6.22.1","vega-tooltip":"^0.32.0","yaml-front-matter":"^4.1.1"},Yf={"@types/clone":"~2.1.1",clone:"~2.1.2","fast-deep-equal":"~3.1.3","fast-json-stable-stringify":"~2.1.0","json-stringify-pretty-compact":"~3.0.0",tslib:"~2.5.0","vega-event-selector":"~3.0.1","vega-expression":"~5.1.0","vega-util":"~1.17.2",yargs:"~17.7.2"},Kf={vega:"^5.24.0"},Qf={node:">=16"};var Zf={name:Tf,author:Af,version:Of,collaborators:Pf,homepage:zf,description:Rf,keywords:If,main:Lf,unpkg:Mf,jsdelivr:Df,module:jf,types:Uf,bin:Bf,files:Wf,scripts:Hf,repository:qf,license:Gf,bugs:Vf,devDependencies:Xf,dependencies:Yf,peerDependencies:Kf,engines:Qf};function Cr(e){return!!e.or}function Nr(e){return!!e.and}function Fr(e){return!!e.not}function mi(e,t){if(Fr(e))mi(e.not,t);else if(Nr(e))for(const n of e.and)mi(n,t);else if(Cr(e))for(const n of e.or)mi(n,t);else t(e)}function un(e,t){return Fr(e)?{not:un(e.not,t)}:Nr(e)?{and:e.and.map(n=>un(n,t))}:Cr(e)?{or:e.or.map(n=>un(n,t))}:t(e)}const De=Cf,k=kf;function Yo(e){throw new Error(e)}function ln(e,t){const n={};for(const i of t)on(e,i)&&(n[i]=e[i]);return n}function ue(e,t){const n={...e};for(const i of t)delete n[i];return n}Set.prototype.toJSON=function(){return`Set(${[...this].map(e=>_r(e)).join(",")})`};const D=_r;function O(e){if(G(e))return e;const t=F(e)?e:_r(e);if(t.length<250)return t;let n=0;for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);n=(n<<5)-n+r,n=n&n}return n}function Tr(e){return e===!1||e===null}function P(e,t){return e.includes(t)}function It(e,t){let n=0;for(const[i,r]of e.entries())if(t(r,i,n++))return!0;return!1}function Ar(e,t){let n=0;for(const[i,r]of e.entries())if(!t(r,i,n++))return!1;return!0}function Ko(e,...t){for(const n of t)Jf(e,n??{});return e}function Jf(e,t){for(const n of b(t))wf(e,n,t[n],!0)}function je(e,t){const n=[],i={};let r;for(const s of e){if(r=t(s),r in i)continue;i[r]=1,n.push(s)}return n}function ed(e,t){const n=b(e),i=b(t);if(n.length!==i.length)return!1;for(const r of n)if(e[r]!==t[r])return!1;return!0}function Qo(e,t){if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Or(e,t){for(const n of e)if(t.has(n))return!0;return!1}function Pr(e){const t=new Set;for(const n of e){const i=an(n),r=i.map((o,a)=>a===0?o:`[${o}]`),s=r.map((o,a)=>r.slice(0,a+1).join(""));for(const o of s)t.add(o)}return t}function zr(e,t){return e===void 0||t===void 0?!0:Or(Pr(e),Pr(t))}function I(e){return b(e).length===0}const b=Object.keys,ee=Object.values,bt=Object.entries;function jn(e){return e===!0||e===!1}function W(e){const t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function Un(e,t){return Fr(e)?`!(${Un(e.not,t)})`:Nr(e)?`(${e.and.map(n=>Un(n,t)).join(") && (")})`:Cr(e)?`(${e.or.map(n=>Un(n,t)).join(") || (")})`:t(e)}function hi(e,t){if(t.length===0)return!0;const n=t.shift();return n in e&&hi(e[n],t)&&delete e[n],I(e)}function Bn(e){return e.charAt(0).toUpperCase()+e.substr(1)}function Rr(e,t="datum"){const n=an(e),i=[];for(let r=1;r<=n.length;r++){const s=`[${n.slice(0,r).map(A).join("][")}]`;i.push(`${t}${s}`)}return i.join(" && ")}function Zo(e,t="datum"){return`${t}[${A(an(e).join("."))}]`}function td(e){return e.replace(/(\[|\]|\.|'|")/g,"\\$1")}function Se(e){return`${an(e).map(td).join("\\.")}`}function Lt(e,t,n){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),n)}function Ir(e){return`${an(e).join(".")}`}function fn(e){return e?an(e).length:0}function V(...e){for(const t of e)if(t!==void 0)return t;return}let Jo=42;function ea(e){const t=++Jo;return e?String(e)+t:t}function nd(){Jo=42}function ta(e){return na(e)?e:`__${e}`}function na(e){return e.startsWith("__")}function Wn(e){return e===void 0?void 0:(e%360+360)%360}function yi(e){return G(e)?!0:!isNaN(e)&&!isNaN(parseFloat(e))}const nt="row",it="column",bi="facet",H="x",K="y",_e="x2",Ue="y2",xt="xOffset",dn="yOffset",ke="radius",rt="radius2",we="theta",st="theta2",Ce="latitude",Ne="longitude",Fe="latitude2",$e="longitude2",le="color",Be="fill",We="stroke",fe="shape",ot="size",Mt="angle",at="opacity",St="fillOpacity",wt="strokeOpacity",$t="strokeWidth",vt="strokeDash",Hn="text",pn="order",qn="detail",xi="key",Dt="tooltip",Si="href",wi="url",$i="description",id={x:1,y:1,x2:1,y2:1},ia={theta:1,theta2:1,radius:1,radius2:1};function ra(e){return e in ia}const Lr={longitude:1,longitude2:1,latitude:1,latitude2:1};function sa(e){switch(e){case Ce:return"y";case Fe:return"y2";case Ne:return"x";case $e:return"x2"}}function oa(e){return e in Lr}const rd=b(Lr),Mr={...id,...ia,...Lr,xOffset:1,yOffset:1,color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeDash:1,size:1,angle:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1,url:1,description:1};function gn(e){return e===le||e===Be||e===We}const aa={row:1,column:1,facet:1},ve=b(aa),Dr={...Mr,...aa},sd=b(Dr),{order:AS,detail:OS,tooltip:PS,...od}=Dr,{row:zS,column:RS,facet:IS,...ad}=od;function cd(e){return!!ad[e]}function ca(e){return!!Dr[e]}const ud=[_e,Ue,Fe,$e,st,rt];function ua(e){const t=jt(e);return t!==e}function jt(e){switch(e){case _e:return H;case Ue:return K;case Fe:return Ce;case $e:return Ne;case st:return we;case rt:return ke}return e}function Et(e){if(ra(e))switch(e){case we:return"startAngle";case st:return"endAngle";case ke:return"outerRadius";case rt:return"innerRadius"}return e}function He(e){switch(e){case H:return _e;case K:return Ue;case Ce:return Fe;case Ne:return $e;case we:return st;case ke:return rt}return}function de(e){switch(e){case H:case _e:return"width";case K:case Ue:return"height"}return}function la(e){switch(e){case H:return"xOffset";case K:return"yOffset";case _e:return"x2Offset";case Ue:return"y2Offset";case we:return"thetaOffset";case ke:return"radiusOffset";case st:return"theta2Offset";case rt:return"radius2Offset"}return}function jr(e){switch(e){case H:return"xOffset";case K:return"yOffset"}return}function fa(e){switch(e){case"xOffset":return"x";case"yOffset":return"y"}}const ld=b(Mr),{x:LS,y:MS,x2:DS,y2:jS,xOffset:US,yOffset:BS,latitude:WS,longitude:HS,latitude2:qS,longitude2:GS,theta:VS,theta2:XS,radius:YS,radius2:KS,...Ur}=Mr,fd=b(Ur),Br={x:1,y:1},qe=b(Br);function Q(e){return e in Br}const Wr={theta:1,radius:1},dd=b(Wr);function vi(e){return e==="width"?H:K}const da={xOffset:1,yOffset:1};function mn(e){return e in da}const{text:QS,tooltip:ZS,href:JS,url:ew,description:tw,detail:nw,key:iw,order:rw,...pa}=Ur,pd=b(pa);function gd(e){return!!Ur[e]}function md(e){switch(e){case le:case Be:case We:case ot:case fe:case at:case $t:case vt:return!0;case St:case wt:case Mt:return!1}}const ga={...Br,...Wr,...da,...pa},Ei=b(ga);function ct(e){return!!ga[e]}function hd(e,t){return bd(e)[t]}const ma={arc:"always",area:"always",bar:"always",circle:"always",geoshape:"always",image:"always",line:"always",rule:"always",point:"always",rect:"always",square:"always",trail:"always",text:"always",tick:"always"},{geoshape:sw,...yd}=ma;function bd(e){switch(e){case le:case Be:case We:case $i:case qn:case xi:case Dt:case Si:case pn:case at:case St:case wt:case $t:case bi:case nt:case it:return ma;case H:case K:case xt:case dn:case Ce:case Ne:return yd;case _e:case Ue:case Fe:case $e:return{area:"always",bar:"always",image:"always",rect:"always",rule:"always",circle:"binned",point:"binned",square:"binned",tick:"binned",line:"binned",trail:"binned"};case ot:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case vt:return{line:"always",point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",geoshape:"always"};case fe:return{point:"always",geoshape:"always"};case Hn:return{text:"always"};case Mt:return{point:"always",square:"always",text:"always"};case wi:return{image:"always"};case we:return{text:"always",arc:"always"};case ke:return{text:"always",arc:"always"};case st:case rt:return{arc:"always"}}}function Hr(e){switch(e){case H:case K:case we:case ke:case xt:case dn:case ot:case Mt:case $t:case at:case St:case wt:case _e:case Ue:case st:case rt:return;case bi:case nt:case it:case fe:case vt:case Hn:case Dt:case Si:case wi:case $i:return"discrete";case le:case Be:case We:return"flexible";case Ce:case Ne:case Fe:case $e:case qn:case xi:case pn:return}}const xd={argmax:1,argmin:1,average:1,count:1,distinct:1,product:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},Sd={count:1,min:1,max:1};function ut(e){return!!e&&!!e.argmin}function _t(e){return!!e&&!!e.argmax}function qr(e){return F(e)&&!!xd[e]}const wd=new Set(["count","valid","missing","distinct"]);function ha(e){return F(e)&&wd.has(e)}function $d(e){return F(e)&&P(["min","max"],e)}const vd=new Set(["count","sum","distinct","valid","missing"]),Ed=new Set(["mean","average","median","q1","q3","min","max"]);function ya(e){return Dn(e)&&(e=Hi(e,void 0)),"bin"+b(e).map(t=>_i(e[t])?W(`_${t}_${bt(e[t])}`):W(`_${t}_${e[t]}`)).join("")}function j(e){return e===!0||Ut(e)&&!e.binned}function te(e){return e==="binned"||Ut(e)&&e.binned===!0}function Ut(e){return M(e)}function _i(e){return e?.param}function ba(e){switch(e){case nt:case it:case ot:case le:case Be:case We:case $t:case at:case St:case wt:case fe:return 6;case vt:return 4;default:return 10}}function Gn(e){return!!e?.expr}function pe(e){const t=b(e||{}),n={};for(const i of t)n[i]=ye(e[i]);return n}function xa(e){const{anchor:t,frame:n,offset:i,orient:r,angle:s,limit:o,color:a,subtitleColor:c,subtitleFont:u,subtitleFontSize:l,subtitleFontStyle:f,subtitleFontWeight:d,subtitleLineHeight:p,subtitlePadding:g,...m}=e,h={...m,...a?{fill:a}:{}},y={...t?{anchor:t}:{},...n?{frame:n}:{},...i?{offset:i}:{},...r?{orient:r}:{},...s!==void 0?{angle:s}:{},...o!==void 0?{limit:o}:{}},$={...c?{subtitleColor:c}:{},...u?{subtitleFont:u}:{},...l?{subtitleFontSize:l}:{},...f?{subtitleFontStyle:f}:{},...d?{subtitleFontWeight:d}:{},...p?{subtitleLineHeight:p}:{},...g?{subtitlePadding:g}:{}},C=ln(e,["align","baseline","dx","dy","limit"]);return{titleMarkConfig:h,subtitleMarkConfig:C,nonMarkTitleProperties:y,subtitle:$}}function kt(e){return F(e)||v(e)&&F(e[0])}function E(e){return!!e?.signal}function Ct(e){return!!e.step}function _d(e){return v(e)?!1:"fields"in e&&!("data"in e)}function kd(e){return v(e)?!1:"fields"in e&&"data"in e}function lt(e){return v(e)?!1:"field"in e&&"data"in e}const Cd={aria:1,description:1,ariaRole:1,ariaRoleDescription:1,blend:1,opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeOffset:1,strokeMiterLimit:1,startAngle:1,endAngle:1,padAngle:1,innerRadius:1,outerRadius:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,lineBreak:1,lineHeight:1,cursor:1,href:1,tooltip:1,cornerRadius:1,cornerRadiusTopLeft:1,cornerRadiusTopRight:1,cornerRadiusBottomLeft:1,cornerRadiusBottomRight:1,aspect:1,width:1,height:1,url:1,smooth:1},Nd=b(Cd),Fd={arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1},Gr=["cornerRadius","cornerRadiusTopLeft","cornerRadiusTopRight","cornerRadiusBottomLeft","cornerRadiusBottomRight"];function Sa(e){const t=v(e.condition)?e.condition.map(wa):wa(e.condition);return{...ye(e),condition:t}}function ye(e){if(Gn(e)){const{expr:t,...n}=e;return{signal:t,...n}}return e}function wa(e){if(Gn(e)){const{expr:t,...n}=e;return{signal:t,...n}}return e}function B(e){if(Gn(e)){const{expr:t,...n}=e;return{signal:t,...n}}return E(e)?e:e!==void 0?{value:e}:void 0}function Td(e){return E(e)?e.signal:A(e)}function $a(e){return E(e)?e.signal:A(e.value)}function Te(e){return E(e)?e.signal:e==null?null:A(e)}function Ad(e,t,n){for(const i of n){const r=ft(i,t.markDef,t.config);r!==void 0&&(e[i]=B(r))}return e}function va(e){return[].concat(e.type,e.style??[])}function z(e,t,n,i={}){const{vgChannel:r,ignoreVgConfig:s}=i;return r&&t[r]!==void 0?t[r]:t[e]!==void 0?t[e]:s&&(!r||r===e)?void 0:ft(e,t,n,i)}function ft(e,t,n,{vgChannel:i}={}){return V(i?ki(e,t,n.style):void 0,ki(e,t,n.style),i?n[t.type][i]:void 0,n[t.type][e],i?n.mark[i]:n.mark[e])}function ki(e,t,n){return Ea(e,va(t),n)}function Ea(e,t,n){t=q(t);let i;for(const r of t){const s=n[r];s&&s[e]!==void 0&&(i=s[e])}return i}function _a(e,t){return q(e).reduce((n,i)=>(n.field.push(w(i,t)),n.order.push(i.sort??"ascending"),n),{field:[],order:[]})}function ka(e,t){const n=[...e];return t.forEach(i=>{for(const r of n)if(De(r,i))return;n.push(i)}),n}function Ca(e,t){return De(e,t)||!t?e:e?[...q(e),...q(t)].join(", "):t}function Na(e,t){const n=e.value,i=t.value;if(n==null||i===null)return{explicit:e.explicit,value:null};if((kt(n)||E(n))&&(kt(i)||E(i)))return{explicit:e.explicit,value:Ca(n,i)};if(kt(n)||E(n))return{explicit:e.explicit,value:n};if(kt(i)||E(i))return{explicit:e.explicit,value:i};if(!kt(n)&&!E(n)&&!kt(i)&&!E(i))return{explicit:e.explicit,value:ka(n,i)};throw new Error("It should never reach here")}function Vr(e){return`Invalid specification ${D(e)}. Make sure the specification includes at least one of the following properties: "mark", "layer", "facet", "hconcat", "vconcat", "concat", or "repeat".`}const Od='Autosize "fit" only works for single views and layered views.';function Fa(e){const t=e=="width"?"Width":"Height";return`${t} "container" only works for single views and layered views.`}function Ta(e){const t=e=="width"?"Width":"Height",n=e=="width"?"x":"y";return`${t} "container" only works well with autosize "fit" or "fit-${n}".`}function Aa(e){return e?`Dropping "fit-${e}" because spec has discrete ${de(e)}.`:'Dropping "fit" because spec has discrete size.'}function Xr(e){return`Unknown field for ${e}. Cannot calculate view size.`}function Oa(e){return`Cannot project a selection on encoding channel "${e}", which has no field.`}function Pd(e,t){return`Cannot project a selection on encoding channel "${e}" as it uses an aggregate function ("${t}").`}function zd(e){return`The "nearest" transform is not supported for ${e} marks.`}function Pa(e){return`Selection not supported for ${e} yet.`}function Rd(e){return`Cannot find a selection named "${e}".`}const Id="Scale bindings are currently only supported for scales with unbinned, continuous domains.",Ld="Legend bindings are only supported for selections over an individual field or encoding channel.";function Md(e){return`Lookups can only be performed on selection parameters. "${e}" is a variable parameter.`}function Dd(e){return`Cannot define and lookup the "${e}" selection in the same view. Try moving the lookup into a second, layered view?`}const jd="The same selection must be used to override scale domains in a layered view.",Ud='Interval selections should be initialized using "x", "y", "longitude", or "latitude" keys.';function Bd(e){return`Unknown repeated value "${e}".`}function za(e){return`The "columns" property cannot be used when "${e}" has nested row/column.`}const Wd="Axes cannot be shared in concatenated or repeated views yet (https://github.com/vega/vega-lite/issues/2415).";function Hd(e){return`Unrecognized parse "${e}".`}function Ra(e,t,n){return`An ancestor parsed field "${e}" as ${n} but a child wants to parse the field as ${t}.`}const qd="Attempt to add the same child twice.";function Gd(e){return`Ignoring an invalid transform: ${D(e)}.`}const Vd='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.';function Ia(e){return`Config.customFormatTypes is not true, thus custom format type and format for channel ${e} are dropped.`}function Xd(e){const{parentProjection:t,projection:n}=e;return`Layer's shared projection ${D(t)} is overridden by a child projection ${D(n)}.`}const Yd="Arc marks uses theta channel rather than angle, replacing angle with theta.";function Kd(e){return`${e}Offset dropped because ${e} is continuous`}function Qd(e){return`There is no ${e} encoding. Replacing ${e}Offset encoding as ${e}.`}function Zd(e,t,n){return`Channel ${e} is a ${t}. Converted to {value: ${D(n)}}.`}function La(e){return`Invalid field type "${e}".`}function Jd(e,t){return`Invalid field type "${e}" for aggregate: "${t}", using "quantitative" instead.`}function ep(e){return`Invalid aggregation operator "${e}".`}function Ma(e,t){const{fill:n,stroke:i}=t;return`Dropping color ${e} as the plot also has ${n&&i?"fill and stroke":n?"fill":"stroke"}.`}function tp(e){return`Position range does not support relative band size for ${e}.`}function Yr(e,t){return`Dropping ${D(e)} from channel "${t}" since it does not contain any data field, datum, value, or signal.`}const np="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.";function Ci(e,t,n){return`${e} dropped as it is incompatible with "${t}"${n?` when ${n}`:""}.`}function ip(e){return`${e} encoding has no scale, so specified scale is ignored.`}function rp(e){return`${e}-encoding is dropped as ${e} is not a valid encoding channel.`}function sp(e){return`${e} encoding should be discrete (ordinal / nominal / binned).`}function op(e){return`${e} encoding should be discrete (ordinal / nominal / binned) or use a discretizing scale (e.g. threshold).`}function ap(e){return`Facet encoding dropped as ${e.join(" and ")} ${e.length>1?"are":"is"} also specified.`}function Kr(e,t){return`Using discrete channel "${e}" to encode "${t}" field can be misleading as it does not encode ${t==="ordinal"?"order":"magnitude"}.`}function cp(e){return`The ${e} for range marks cannot be an expression`}function up(e,t){const n=e&&t?"x2 and y2":e?"x2":"y2";return`Line mark is for continuous lines and thus cannot be used with ${n}. We will use the rule mark (line segments) instead.`}function lp(e,t){return`Specified orient "${e}" overridden with "${t}".`}function fp(e){return`Cannot use the scale property "${e}" with non-color channel.`}function dp(e){return`Cannot use the relative band size with ${e} scale.`}function pp(e){return`Using unaggregated domain with raw field has no effect (${D(e)}).`}function gp(e){return`Unaggregated domain not applicable for "${e}" since it produces values outside the origin domain of the source data.`}function mp(e){return`Unaggregated domain is currently unsupported for log scale (${D(e)}).`}function hp(e){return`Cannot apply size to non-oriented mark "${e}".`}function yp(e,t,n){return`Channel "${e}" does not work with "${t}" scale. We are using "${n}" scale instead.`}function bp(e,t){return`FieldDef does not work with "${e}" scale. We are using "${t}" scale instead.`}function Da(e,t,n){return`${n}-scale's "${t}" is dropped as it does not work with ${e} scale.`}function ja(e){return`The step for "${e}" is dropped because the ${e==="width"?"x":"y"} is continuous.`}function xp(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using ${D(n)}.`}function Sp(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using the union of the two domains.`}function wp(e){return`Setting the scale to be independent for "${e}" means we also have to set the guide (axis or legend) to be independent.`}function $p(e){return`Dropping sort property ${D(e)} as unioned domains only support boolean or op "count", "min", and "max".`}const Ua="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",vp="Detected faceted independent scales that union domain of multiple fields from different data sources. We will use the first field. The result view size may be incorrect.",Ep="Detected faceted independent scales that union domain of the same fields from different source. We will assume that this is the same field from a different fork of the same data source. However, if this is not the case, the result view size may be incorrect.",_p="Detected faceted independent scales that union domain of multiple fields from the same data source. We will use the first field. The result view size may be incorrect.";function kp(e){return`Cannot stack "${e}" if there is already "${e}2".`}function Cp(e){return`Cannot stack non-linear scale (${e}).`}function Np(e){return`Stacking is applied even though the aggregate function is non-summative ("${e}").`}function Ni(e,t){return`Invalid ${e}: ${D(t)}.`}function Fp(e){return`Dropping day from datetime ${D(e)} as day cannot be combined with other units.`}function Tp(e,t){return`${t?"extent ":""}${t&&e?"and ":""}${e?"center ":""}${t&&e?"are ":"is "}not needed when data are aggregated.`}function Ap(e,t,n){return`${e} is not usually used with ${t} for ${n}.`}function Op(e,t){return`Continuous axis should not have customized aggregation function ${e}; ${t} already agregates the axis.`}function Ba(e){return`1D error band does not support ${e}.`}function Wa(e){return`Channel ${e} is required for "binned" bin.`}function Pp(e){return`Channel ${e} should not be used with "binned" bin.`}function zp(e){return`Domain for ${e} is required for threshold scale.`}var ow=function(e,t,n,i,r){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?r.call(e,n):r?r.value=n:t.set(e,n),n},aw=function(e,t,n,i){if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(e):i?i.value:t.get(e)};const Ha=$f(vf);let hn=Ha;function Rp(e){return hn=e,hn}function Ip(){return hn=Ha,hn}function x(...e){hn.warn(...e)}function Lp(...e){hn.debug(...e)}function Bt(e){if(e&&M(e)){for(const t of Zr)if(t in e)return!0}return!1}const qa=["january","february","march","april","may","june","july","august","september","october","november","december"],Mp=qa.map(e=>e.substr(0,3)),Ga=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],Dp=Ga.map(e=>e.substr(0,3));function jp(e){if(yi(e)&&(e=+e),G(e))return e>4&&x(Ni("quarter",e)),e-1;throw new Error(Ni("quarter",e))}function Up(e){if(yi(e)&&(e=+e),G(e))return e-1;{const t=e.toLowerCase(),n=qa.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=Mp.indexOf(i);if(r!==-1)return r;throw new Error(Ni("month",e))}}function Bp(e){if(yi(e)&&(e=+e),G(e))return e%7;{const t=e.toLowerCase(),n=Ga.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=Dp.indexOf(i);if(r!==-1)return r;throw new Error(Ni("day",e))}}function Qr(e,t){const n=[];if(t&&e.day!==void 0&&(b(e).length>1&&(x(Fp(e)),e=k(e),delete e.day)),e.year!==void 0?n.push(e.year):n.push(2012),e.month!==void 0){const i=t?Up(e.month):e.month;n.push(i)}else if(e.quarter!==void 0){const i=t?jp(e.quarter):e.quarter;n.push(G(i)?i*3:`${i}*3`)}else n.push(0);if(e.date!==void 0)n.push(e.date);else if(e.day!==void 0){const i=t?Bp(e.day):e.day;n.push(G(i)?i+1:`${i}+1`)}else n.push(1);for(const i of["hours","minutes","seconds","milliseconds"]){const r=e[i];n.push(typeof r=="undefined"?0:r)}return n}function Wt(e){const t=Qr(e,!0),n=t.join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function Wp(e){const t=Qr(e,!1),n=t.join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function Hp(e){const t=Qr(e,!0);return e.utc?+new Date(Date.UTC(...t)):+new Date(...t)}const Va={year:1,quarter:1,month:1,week:1,day:1,dayofyear:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},Zr=b(Va);function qp(e){return!!Va[e]}function Jr(e){return e.startsWith("utc")}function Gp(e){return e.substr(3)}const Vp={"year-month":"%b %Y ","year-month-date":"%b %d, %Y "};function Fi(e){return Zr.filter(t=>Xa(e,t))}function Xp(e){const t=Fi(e);return t[t.length-1]}function Xa(e,t){const n=e.indexOf(t);return n<0||(n>0&&t==="seconds"&&e.charAt(n-1)==="i"||e.length>n+3&&t==="day"&&e.charAt(n+3)==="o")?!1:!(n>0&&t==="year"&&e.charAt(n-1)==="f")}function Yp(e,t,{end:n}={end:!1}){const i=Rr(t),r=Jr(e)?"utc":"";function s(c){return c==="quarter"?`(${r}quarter(${i})-1)`:`${r}${c}(${i})`}let o;const a={};for(const c of Zr)Xa(e,c)&&(a[c]=s(c),o=c);return n&&(a[o]+="+1"),Wp(a)}function Ya(e){if(!e)return;const t=Fi(e);return`timeUnitSpecifier(${D(t)}, ${D(Vp)})`}function Kp(e,t,n){if(!e)return;const i=Ya(e),r=n||Jr(e);return`${r?"utc":"time"}Format(${t}, ${i})`}function ne(e){if(!e)return;let t;return F(e)?t={unit:e}:M(e)&&(t={...e,...e.unit?{unit:e.unit}:{}}),Jr(t.unit)&&(t.utc=!0,t.unit=Gp(t.unit)),t}function Qp(e){const{utc:t,...n}=ne(e);return n.unit?(t?"utc":"")+b(n).map(i=>W(`${i==="unit"?"":`_${i}_`}${n[i]}`)).join(""):(t?"utc":"")+"timeunit"+b(n).map(i=>W(`_${i}_${n[i]}`)).join("")}function Ka(e,t=n=>n){const n=ne(e),i=Xp(n.unit);if(i&&i!=="day"){const r={year:2001,month:1,date:1,hours:0,minutes:0,seconds:0,milliseconds:0},s=n.step||1,o={...r,...i==="quarter"?{month:+r.month+s*3}:i==="week"?{date:+r.date+s*7}:{[i]:+r[i]+s}};return`${t(Wt(o))} - ${t(Wt(r))}`}return}function Zp(e){return e?.param}function es(e){return!!e?.field&&e.equal!==void 0}function ts(e){return!!e?.field&&e.lt!==void 0}function ns(e){return!!e?.field&&e.lte!==void 0}function is(e){return!!e?.field&&e.gt!==void 0}function rs(e){return!!e?.field&&e.gte!==void 0}function ss(e){if(e?.field){if(v(e.range)&&e.range.length===2)return!0;if(E(e.range))return!0}return!1}function os(e){return!!e?.field&&(v(e.oneOf)||v(e.in))}function Jp(e){return!!e?.field&&e.valid!==void 0}function Qa(e){return os(e)||es(e)||ss(e)||ts(e)||is(e)||ns(e)||rs(e)}function Ge(e,t){return qi(e,{timeUnit:t,wrapTime:!0})}function eg(e,t){return e.map(n=>Ge(n,t))}function Za(e,t=!0){const{field:n}=e,i=ne(e.timeUnit)?.unit,r=i?`time(${Yp(i,n)})`:w(e,{expr:"datum"});if(es(e))return`${r}===${Ge(e.equal,i)}`;if(ts(e)){const s=e.lt;return`${r}<${Ge(s,i)}`}else if(is(e)){const s=e.gt;return`${r}>${Ge(s,i)}`}else if(ns(e)){const s=e.lte;return`${r}<=${Ge(s,i)}`}else if(rs(e)){const s=e.gte;return`${r}>=${Ge(s,i)}`}else{if(os(e))return`indexof([${eg(e.oneOf,i).join(",")}], ${r}) !== -1`;if(Jp(e))return as(r,e.valid);if(ss(e)){const{range:s}=e,o=E(s)?{signal:`${s.signal}[0]`}:s[0],a=E(s)?{signal:`${s.signal}[1]`}:s[1];if(o!==null&&a!==null&&t)return"inrange("+r+", ["+Ge(o,i)+", "+Ge(a,i)+"])";const c=[];return o!==null&&c.push(`${r} >= ${Ge(o,i)}`),a!==null&&c.push(`${r} <= ${Ge(a,i)}`),c.length>0?c.join(" && "):"true"}}throw new Error(`Invalid field predicate: ${D(e)}`)}function as(e,t=!0){return t?`isValid(${e}) && isFinite(+${e})`:`!isValid(${e}) || !isFinite(+${e})`}function tg(e){return Qa(e)&&e.timeUnit?{...e,timeUnit:ne(e.timeUnit)?.unit}:e}const Vn={quantitative:"quantitative",ordinal:"ordinal",temporal:"temporal",nominal:"nominal",geojson:"geojson"};function ng(e){return e==="quantitative"||e==="temporal"}function Ja(e){return e==="ordinal"||e==="nominal"}const Ht=Vn.quantitative,cs=Vn.ordinal,yn=Vn.temporal,us=Vn.nominal,bn=Vn.geojson;function ig(e){if(e){e=e.toLowerCase();switch(e){case"q":case Ht:return"quantitative";case"t":case yn:return"temporal";case"o":case cs:return"ordinal";case"n":case us:return"nominal";case bn:return"geojson"}}return}const ge={LINEAR:"linear",LOG:"log",POW:"pow",SQRT:"sqrt",SYMLOG:"symlog",IDENTITY:"identity",SEQUENTIAL:"sequential",TIME:"time",UTC:"utc",QUANTILE:"quantile",QUANTIZE:"quantize",THRESHOLD:"threshold",BIN_ORDINAL:"bin-ordinal",ORDINAL:"ordinal",POINT:"point",BAND:"band"},ls={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric",symlog:"numeric",identity:"numeric",sequential:"numeric",time:"time",utc:"time",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"};function rg(e,t){const n=ls[e],i=ls[t];return n===i||n==="ordinal-position"&&i==="time"||i==="ordinal-position"&&n==="time"}const sg={linear:0,log:1,pow:1,sqrt:1,symlog:1,identity:1,sequential:1,time:0,utc:0,point:10,band:11,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function ec(e){return sg[e]}const tc=new Set(["linear","log","pow","sqrt","symlog"]),nc=new Set([...tc,"time","utc"]);function ic(e){return tc.has(e)}const rc=new Set(["quantile","quantize","threshold"]),og=new Set([...nc,...rc,"sequential","identity"]),ag=new Set(["ordinal","bin-ordinal","point","band"]);function Z(e){return ag.has(e)}function be(e){return og.has(e)}function Ae(e){return nc.has(e)}function xn(e){return rc.has(e)}const cg={pointPadding:.5,barBandPaddingInner:.1,rectBandPaddingInner:0,bandWithNestedOffsetPaddingInner:.2,bandWithNestedOffsetPaddingOuter:.2,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4,zero:!0};function ug(e){return!F(e)&&!!e.name}function sc(e){return e?.param}function lg(e){return e?.unionWith}function fg(e){return kr(e)&&"field"in e}const dg={type:1,domain:1,domainMax:1,domainMin:1,domainMid:1,align:1,range:1,rangeMax:1,rangeMin:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},{type:cw,domain:uw,range:lw,rangeMax:fw,rangeMin:dw,scheme:pw,...pg}=dg,gg=b(pg);function fs(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":case"interpolate":return!["point","band","identity"].includes(e);case"bins":return!["point","band","identity","ordinal"].includes(e);case"round":return Ae(e)||e==="band"||e==="point";case"padding":case"rangeMin":case"rangeMax":return Ae(e)||["point","band"].includes(e);case"paddingOuter":case"align":return["point","band"].includes(e);case"paddingInner":return e==="band";case"domainMax":case"domainMid":case"domainMin":case"clamp":return Ae(e);case"nice":return Ae(e)||e==="quantize"||e==="threshold";case"exponent":return e==="pow";case"base":return e==="log";case"constant":return e==="symlog";case"zero":return be(e)&&!P(["log","time","utc","threshold","quantile"],e)}}function oc(e,t){switch(t){case"interpolate":case"scheme":case"domainMid":return gn(e)?void 0:fp(t);case"align":case"type":case"bins":case"domain":case"domainMax":case"domainMin":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeMax":case"rangeMin":case"reverse":case"round":case"clamp":case"zero":return}}function mg(e,t){return P([cs,us],t)?e===void 0||Z(e):t===yn?P([ge.TIME,ge.UTC,void 0],e):t===Ht?ic(e)||xn(e)||e===void 0:!0}function hg(e,t,n=!1){if(!ct(e))return!1;switch(e){case H:case K:case xt:case dn:case we:case ke:return Ae(t)||t==="band"?!0:t==="point"?!n:!1;case ot:case $t:case at:case St:case wt:case Mt:return Ae(t)||xn(t)||P(["band","point","ordinal"],t);case le:case Be:case We:return t!=="band";case vt:case fe:return t==="ordinal"||xn(t)}}const oe={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"},ac=oe.arc,Ti=oe.area,Ai=oe.bar,yg=oe.image,Oi=oe.line,Pi=oe.point,bg=oe.rect,zi=oe.rule,cc=oe.text,ds=oe.tick,xg=oe.trail,ps=oe.circle,gs=oe.square,uc=oe.geoshape;function Nt(e){return["line","area","trail"].includes(e)}function lc(e){return["rect","bar","image","arc"].includes(e)}const Sg=new Set(b(oe));function Ve(e){return e.type}const wg=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],$g=["fill","fillOpacity"],vg=[...wg,...$g],Eg={color:1,filled:1,invalid:1,order:1,radius2:1,theta2:1,timeUnitBandSize:1,timeUnitBandPosition:1},fc=b(Eg),_g={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize","minBandSize"],rect:["binSpacing","continuousBandSize","discreteBandSize","minBandSize"],line:["point"],tick:["bandSize","thickness"]},kg={color:"#4c78a8",invalid:"filter",timeUnitBandSize:1},Cg={mark:1,arc:1,area:1,bar:1,circle:1,image:1,line:1,point:1,rect:1,rule:1,square:1,text:1,tick:1,trail:1,geoshape:1},dc=b(Cg);function qt(e){return e&&e.band!=null}const Ng={horizontal:["cornerRadiusTopRight","cornerRadiusBottomRight"],vertical:["cornerRadiusTopLeft","cornerRadiusTopRight"]},pc=5,Fg={binSpacing:1,continuousBandSize:pc,minBandSize:.25,timeUnitBandPosition:.5},Tg={binSpacing:0,continuousBandSize:pc,minBandSize:.25,timeUnitBandPosition:.5},Ag={thickness:1};function Og(e){return Ve(e)?e.type:e}function ms(e){const{channel:t,channelDef:n,markDef:i,scale:r,config:s}=e,o=ys(e);return S(n)&&!ha(n.aggregate)&&r&&Ae(r.get("type"))?Pg({fieldDef:n,channel:t,markDef:i,ref:o,config:s}):o}function Pg({fieldDef:e,channel:t,markDef:n,ref:i,config:r}){if(Nt(n.type))return i;const s=z("invalid",n,r);return s===null?[zg(e,t),i]:i}function zg(e,t){const n=hs(e,!0),i=jt(t),r=i==="y"?{field:{group:"height"}}:{value:0};return{test:n,...r}}function hs(e,t=!0){return as(F(e)?e:w(e,{expr:"datum"}),!t)}function Rg(e){const{datum:t}=e;return Bt(t)?Wt(t):`${D(t)}`}function Gt(e,t,n,i){const r={};if(t&&(r.scale=t),Ye(e)){const{datum:s}=e;Bt(s)?r.signal=Wt(s):E(s)?r.signal=s.signal:Gn(s)?r.signal=s.expr:r.value=s}else r.field=w(e,n);if(i){const{offset:s,band:o}=i;s&&(r.offset=s),o&&(r.band=o)}return r}function Ri({scaleName:e,fieldOrDatumDef:t,fieldOrDatumDef2:n,offset:i,startSuffix:r,bandPosition:s=.5}){const o=0<s&&s<1?"datum":void 0,a=w(t,{expr:o,suffix:r}),c=n!==void 0?w(n,{expr:o}):w(t,{suffix:"end",expr:o}),u={};if(s===0||s===1){u.scale=e;const l=s===0?a:c;u.field=l}else{const l=E(s)?`${s.signal} * ${a} + (1-${s.signal}) * ${c}`:`${s} * ${a} + ${1-s} * ${c}`;u.signal=`scale("${e}", ${l})`}return i&&(u.offset=i),u}function Ig({scaleName:e,fieldDef:t}){const n=w(t,{expr:"datum"}),i=w(t,{expr:"datum",suffix:"end"});return`abs(scale("${e}", ${i}) - scale("${e}", ${n}))`}function ys({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:u,bandPosition:l}){if(t){if(N(t)){const f=o?.get("type");if(ae(t)){l??(l=Ec({fieldDef:t,fieldDef2:n,markDef:i,config:r}));const{bin:d,timeUnit:p,type:g}=t;if(j(d)||l&&p&&g===yn)return a?.impute?Gt(t,s,{binSuffix:"mid"},{offset:c}):l&&!Z(f)?Ri({scaleName:s,fieldOrDatumDef:t,bandPosition:l,offset:c}):Gt(t,s,Zn(t,e)?{binSuffix:"range"}:{},{offset:c});if(te(d)){if(S(n))return Ri({scaleName:s,fieldOrDatumDef:t,fieldOrDatumDef2:n,bandPosition:l,offset:c});{const m=e===H?_e:Ue;x(Wa(m))}}}return Gt(t,s,Z(f)?{binSuffix:"range"}:{},{offset:c,band:f==="band"?l??t.bandPosition??.5:void 0})}else if(Pe(t)){const f=t.value,d=c?{offset:c}:{};return{...Xn(e,f),...d}}}return Ef(u)&&(u=u()),u&&{...u,...c?{offset:c}:{}}}function Xn(e,t){return P(["x","x2"],e)&&t==="width"?{field:{group:"width"}}:P(["y","y2"],e)&&t==="height"?{field:{group:"height"}}:B(t)}function Vt(e){return e&&e!=="number"&&e!=="time"}function gc(e,t,n){return`${e}(${t}${n?`, ${D(n)}`:""})`}const Lg=" \u2013 ";function bs({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s}){if(Vt(n))return Oe({fieldOrDatumDef:e,format:t,formatType:n,expr:i,config:s});const o=mc(e,i,r),a=Sn(e);if(t===void 0&&n===void 0&&s.customFormatTypes){if(a==="quantitative"){if(r&&s.normalizedNumberFormatType)return Oe({fieldOrDatumDef:e,format:s.normalizedNumberFormat,formatType:s.normalizedNumberFormatType,expr:i,config:s});if(s.numberFormatType)return Oe({fieldOrDatumDef:e,format:s.numberFormat,formatType:s.numberFormatType,expr:i,config:s})}if(a==="temporal"&&s.timeFormatType&&S(e)&&e.timeUnit===void 0)return Oe({fieldOrDatumDef:e,format:s.timeFormat,formatType:s.timeFormatType,expr:i,config:s})}if(En(e)){const c=Dg({field:o,timeUnit:S(e)?ne(e.timeUnit)?.unit:void 0,format:t,formatType:s.timeFormatType,rawTimeFormat:s.timeFormat,isUTCScale:Xt(e)&&e.scale?.type===ge.UTC});return c?{signal:c}:void 0}if(t=xs({type:a,specifiedFormat:t,config:s,normalizeStack:r}),S(e)&&j(e.bin)){const c=w(e,{expr:i,binSuffix:"end"});return{signal:Yn(o,c,t,n,s)}}else return t||Sn(e)==="quantitative"?{signal:`${bc(o,t)}`}:{signal:`isValid(${o}) ? ${o} : ""+${o}`}}function mc(e,t,n){return S(e)?n?`${w(e,{expr:t,suffix:"end"})}-${w(e,{expr:t,suffix:"start"})}`:w(e,{expr:t}):Rg(e)}function Oe({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s,field:o}){if(o??(o=mc(e,i,r)),o!=="datum.value"&&S(e)&&j(e.bin)){const a=w(e,{expr:i,binSuffix:"end"});return{signal:Yn(o,a,t,n,s)}}return{signal:gc(n,o,t)}}function hc(e,t,n,i,r,s){if(F(i)&&Vt(i))return;if(n===void 0&&i===void 0&&r.customFormatTypes&&Sn(e)==="quantitative"){if(r.normalizedNumberFormatType&&wn(e)&&e.stack==="normalize")return;if(r.numberFormatType)return}if(wn(e)&&e.stack==="normalize"&&r.normalizedNumberFormat)return xs({type:"quantitative",config:r,normalizeStack:!0});if(En(e)){const o=S(e)?ne(e.timeUnit)?.unit:void 0;return o===void 0&&r.customFormatTypes&&r.timeFormatType?void 0:Mg({specifiedFormat:n,timeUnit:o,config:r,omitTimeFormatConfig:s})}return xs({type:t,specifiedFormat:n,config:r})}function yc(e,t,n){return e&&(E(e)||e==="number"||e==="time")?e:En(t)&&n!=="time"&&n!=="utc"?S(t)&&ne(t?.timeUnit)?.utc?"utc":"time":void 0}function xs({type:e,specifiedFormat:t,config:n,normalizeStack:i}){return F(t)?t:e===Ht?i?n.normalizedNumberFormat:n.numberFormat:void 0}function Mg({specifiedFormat:e,timeUnit:t,config:n,omitTimeFormatConfig:i}){return e||(t?{signal:Ya(t)}:i?void 0:n.timeFormat)}function bc(e,t){return`format(${e}, "${t||""}")`}function xc(e,t,n,i){return Vt(n)?gc(n,e,t):bc(e,(F(t)?t:void 0)??i.numberFormat)}function Yn(e,t,n,i,r){if(n===void 0&&i===void 0&&r.customFormatTypes&&r.numberFormatType)return Yn(e,t,r.numberFormat,r.numberFormatType,r);const s=xc(e,n,i,r),o=xc(t,n,i,r);return`${as(e,!1)} ? "null" : ${s} + "${Lg}" + ${o}`}function Dg({field:e,timeUnit:t,format:n,formatType:i,rawTimeFormat:r,isUTCScale:s}){return!t||n?!t&&i?`${i}(${e}, '${n}')`:(n=F(n)?n:r,`${s?"utc":"time"}Format(${e}, '${n}')`):Kp(t,e,s)}const Ii="min",jg={x:1,y:1,color:1,fill:1,stroke:1,strokeWidth:1,size:1,shape:1,fillOpacity:1,strokeOpacity:1,opacity:1,text:1};function Sc(e){return e in jg}function wc(e){return!!e?.encoding}function Xe(e){return e&&(e.op==="count"||!!e.field)}function $c(e){return e&&v(e)}function Kn(e){return"row"in e||"column"in e}function Ss(e){return!!e&&"header"in e}function Li(e){return"facet"in e}function Ug(e){return e.param}function Bg(e){return e&&!F(e)&&"repeat"in e}function vc(e){const{field:t,timeUnit:n,bin:i,aggregate:r}=e;return{...n?{timeUnit:n}:{},...i?{bin:i}:{},...r?{aggregate:r}:{},field:t}}function ws(e){return"sort"in e}function Ec({fieldDef:e,fieldDef2:t,markDef:n,config:i}){if(N(e)&&e.bandPosition!==void 0)return e.bandPosition;if(S(e)){const{timeUnit:r,bin:s}=e;if(r&&!t)return lc(n.type)?0:ft("timeUnitBandPosition",n,i);if(j(s))return .5}return}function _c({channel:e,fieldDef:t,fieldDef2:n,markDef:i,config:r,scaleType:s,useVlSizeChannel:o}){const a=de(e),c=z(o?"size":a,i,r,{vgChannel:a});if(c!==void 0)return c;if(S(t)){const{timeUnit:u,bin:l}=t;if(u&&!n)return{band:ft("timeUnitBandSize",i,r)};if(j(l)&&!Z(s))return{band:1}}return lc(i.type)?s?Z(s)?r[i.type]?.discreteBandSize||{band:1}:r[i.type]?.continuousBandSize:r[i.type]?.discreteBandSize:void 0}function kc(e,t,n,i){return j(e.bin)||e.timeUnit&&ae(e)&&e.type==="temporal"?Ec({fieldDef:e,fieldDef2:t,markDef:n,config:i})!==void 0:!1}function Cc(e){return e&&!!e.sort&&!e.field}function Mi(e){return e&&"condition"in e}function Di(e){const t=e?.condition;return!!t&&!v(t)&&S(t)}function Qn(e){const t=e?.condition;return!!t&&!v(t)&&N(t)}function Wg(e){const t=e?.condition;return!!t&&(v(t)||Pe(t))}function S(e){return e&&(!!e.field||e.aggregate==="count")}function Sn(e){return e?.type}function Ye(e){return e&&"datum"in e}function Ft(e){return ae(e)&&!Ui(e)||ji(e)}function Nc(e){return ae(e)&&e.type==="quantitative"&&!e.bin||ji(e)}function ji(e){return Ye(e)&&G(e.datum)}function N(e){return S(e)||Ye(e)}function ae(e){return e&&("field"in e||e.aggregate==="count")&&"type"in e}function Pe(e){return e&&"value"in e&&"value"in e}function Xt(e){return e&&("scale"in e||"sort"in e)}function wn(e){return e&&("axis"in e||"stack"in e||"impute"in e)}function Fc(e){return e&&"legend"in e}function Tc(e){return e&&("format"in e||"formatType"in e)}function Hg(e){return ue(e,["legend","axis","header","scale"])}function qg(e){return"op"in e}function w(e,t={}){let n=e.field;const i=t.prefix;let r=t.suffix,s="";if(Vg(e))n=ta("count");else{let o;if(!t.nofn)if(qg(e))o=e.op;else{const{bin:a,aggregate:c,timeUnit:u}=e;j(a)?(o=ya(a),r=(t.binSuffix??"")+(t.suffix??"")):c?_t(c)?(s=`["${n}"]`,n=`argmax_${c.argmax}`):ut(c)?(s=`["${n}"]`,n=`argmin_${c.argmin}`):o=String(c):u&&(o=Qp(u),r=(!["range","mid"].includes(t.binSuffix)&&t.binSuffix||"")+(t.suffix??""))}o&&(n=n?`${o}_${n}`:o)}return r&&(n=`${n}_${r}`),i&&(n=`${i}_${n}`),t.forAs?Ir(n):t.expr?Zo(n,t.expr)+s:Se(n)+s}function Ui(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return S(e)&&!!e.bin;case"temporal":return!1}throw new Error(La(e.type))}function Gg(e){return Xt(e)&&xn(e.scale?.type)}function Vg(e){return e.aggregate==="count"}function Xg(e,t){const{field:n,bin:i,timeUnit:r,aggregate:s}=e;if(s==="count")return t.countTitle;if(j(i))return`${n} (binned)`;if(r){const o=ne(r)?.unit;if(o)return`${n} (${Fi(o).join("-")})`}else if(s)return _t(s)?`${n} for max ${s.argmax}`:ut(s)?`${n} for min ${s.argmin}`:`${Bn(s)} of ${n}`;return n}function Yg(e){const{aggregate:t,bin:n,timeUnit:i,field:r}=e;if(_t(t))return`${r} for argmax(${t.argmax})`;if(ut(t))return`${r} for argmin(${t.argmin})`;const s=ne(i),o=t||s?.unit||s?.maxbins&&"timeunit"||j(n)&&"bin";return o?`${o.toUpperCase()}(${r})`:r}const Ac=(e,t)=>{switch(t.fieldTitle){case"plain":return e.field;case"functional":return Yg(e);default:return Xg(e,t)}};let Oc=Ac;function Pc(e){Oc=e}function Kg(){Pc(Ac)}function $n(e,t,{allowDisabling:n,includeDefault:i=!0}){const r=$s(e)?.title;if(!S(e))return r??e.title;const s=e,o=i?vs(s,t):void 0;return n?V(r,s.title,o):r??s.title??o}function $s(e){return wn(e)&&e.axis?e.axis:Fc(e)&&e.legend?e.legend:Ss(e)&&e.header?e.header:void 0}function vs(e,t){return Oc(e,t)}function Bi(e){if(Tc(e)){const{format:t,formatType:n}=e;return{format:t,formatType:n}}else{const t=$s(e)??{},{format:n,formatType:i}=t;return{format:n,formatType:i}}}function Qg(e,t){switch(t){case"latitude":case"longitude":return"quantitative";case"row":case"column":case"facet":case"shape":case"strokeDash":return"nominal";case"order":return"ordinal"}if(ws(e)&&v(e.sort))return"ordinal";const{aggregate:n,bin:i,timeUnit:r}=e;if(r)return"temporal";if(i||n&&!_t(n)&&!ut(n))return"quantitative";if(Xt(e)&&e.scale?.type)switch(ls[e.scale.type]){case"numeric":case"discretizing":return"quantitative";case"time":return"temporal"}return"nominal"}function Ke(e){return S(e)?e:Di(e)?e.condition:void 0}function Y(e){return N(e)?e:Qn(e)?e.condition:void 0}function zc(e,t,n,i={}){if(F(e)||G(e)||Dn(e)){const r=F(e)?"string":G(e)?"number":"boolean";return x(Zd(t,r,e)),{value:e}}return N(e)?Wi(e,t,n,i):Qn(e)?{...e,condition:Wi(e.condition,t,n,i)}:e}function Wi(e,t,n,i){if(Tc(e)){const{format:r,formatType:s,...o}=e;if(Vt(s)&&!n.customFormatTypes)return x(Ia(t)),Wi(o,t,n,i)}else{const r=wn(e)?"axis":Fc(e)?"legend":Ss(e)?"header":null;if(r&&e[r]){const{format:s,formatType:o,...a}=e[r];if(Vt(o)&&!n.customFormatTypes)return x(Ia(t)),Wi({...e,[r]:a},t,n,i)}}return S(e)?Es(e,t,i):Zg(e)}function Zg(e){let t=e.type;if(t)return e;const{datum:n}=e;return t=G(n)?"quantitative":F(n)?"nominal":Bt(n)?"temporal":void 0,{...e,type:t}}function Es(e,t,{compositeMark:n=!1}={}){const{aggregate:i,timeUnit:r,bin:s,field:o}=e,a={...e};if(!n&&i&&!qr(i)&&!_t(i)&&!ut(i)&&(x(ep(i)),delete a.aggregate),r&&(a.timeUnit=ne(r)),o&&(a.field=`${o}`),j(s)&&(a.bin=Hi(s,t)),te(s)&&!Q(t)&&x(Pp(t)),ae(a)){const{type:c}=a,u=ig(c);c!==u&&(a.type=u),c!=="quantitative"&&(ha(i)&&(x(Jd(c,i)),a.type="quantitative"))}else if(!ua(t)){const c=Qg(a,t);a.type=c}if(ae(a)){const{compatible:c,warning:u}=Jg(a,t)||{};c===!1&&x(u)}if(ws(a)&&F(a.sort)){const{sort:c}=a;if(Sc(c))return{...a,sort:{encoding:c}};const u=c.substr(1);if(c.charAt(0)==="-"&&Sc(u))return{...a,sort:{encoding:u,order:"descending"}}}if(Ss(a)){const{header:c}=a;if(c){const{orient:u,...l}=c;if(u)return{...a,header:{...l,labelOrient:c.labelOrient||u,titleOrient:c.titleOrient||u}}}}return a}function Hi(e,t){return Dn(e)?{maxbins:ba(t)}:e==="binned"?{binned:!0}:!e.maxbins&&!e.step?{...e,maxbins:ba(t)}:e}const vn={compatible:!0};function Jg(e,t){const n=e.type;if(n==="geojson"&&t!=="shape")return{compatible:!1,warning:`Channel ${t} should not be used with a geojson data.`};switch(t){case nt:case it:case bi:return Ui(e)?vn:{compatible:!1,warning:sp(t)};case H:case K:case xt:case dn:case le:case Be:case We:case Hn:case qn:case xi:case Dt:case Si:case wi:case Mt:case we:case ke:case $i:return vn;case Ne:case $e:case Ce:case Fe:return n!==Ht?{compatible:!1,warning:`Channel ${t} should be used with a quantitative field only, not ${e.type} field.`}:vn;case at:case St:case wt:case $t:case ot:case st:case rt:case _e:case Ue:return n==="nominal"&&!e.sort?{compatible:!1,warning:`Channel ${t} should not be used with an unsorted discrete field.`}:vn;case fe:case vt:return!Ui(e)&&!Gg(e)?{compatible:!1,warning:op(t)}:vn;case pn:return e.type==="nominal"&&!("sort"in e)?{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}:vn}}function En(e){const{formatType:t}=Bi(e);return t==="time"||!t&&em(e)}function em(e){return e&&(e.type==="temporal"||S(e)&&!!e.timeUnit)}function qi(e,{timeUnit:t,type:n,wrapTime:i,undefinedIfExprNotRequired:r}){const s=t&&ne(t)?.unit;let o=s||n==="temporal",a;return Gn(e)?a=e.expr:E(e)?a=e.signal:Bt(e)?(o=!0,a=Wt(e)):(F(e)||G(e))&&(o&&(a=`datetime(${D(e)})`,qp(s)&&((G(e)&&e<1e4||F(e)&&isNaN(Date.parse(e)))&&(a=Wt({[s]:e}))))),a?i&&o?`time(${a})`:a:r?void 0:D(e)}function Rc(e,t){const{type:n}=e;return t.map(i=>{const r=qi(i,{timeUnit:S(e)?e.timeUnit:void 0,type:n,undefinedIfExprNotRequired:!0});return r!==void 0?{signal:r}:i})}function Zn(e,t){return j(e.bin)?ct(t)&&["ordinal","nominal"].includes(e.type):(console.warn("Only call this method for binned field defs."),!1)}const Ic={labelAlign:{part:"labels",vgProp:"align"},labelBaseline:{part:"labels",vgProp:"baseline"},labelColor:{part:"labels",vgProp:"fill"},labelFont:{part:"labels",vgProp:"font"},labelFontSize:{part:"labels",vgProp:"fontSize"},labelFontStyle:{part:"labels",vgProp:"fontStyle"},labelFontWeight:{part:"labels",vgProp:"fontWeight"},labelOpacity:{part:"labels",vgProp:"opacity"},labelOffset:null,labelPadding:null,gridColor:{part:"grid",vgProp:"stroke"},gridDash:{part:"grid",vgProp:"strokeDash"},gridDashOffset:{part:"grid",vgProp:"strokeDashOffset"},gridOpacity:{part:"grid",vgProp:"opacity"},gridWidth:{part:"grid",vgProp:"strokeWidth"},tickColor:{part:"ticks",vgProp:"stroke"},tickDash:{part:"ticks",vgProp:"strokeDash"},tickDashOffset:{part:"ticks",vgProp:"strokeDashOffset"},tickOpacity:{part:"ticks",vgProp:"opacity"},tickSize:null,tickWidth:{part:"ticks",vgProp:"strokeWidth"}};function Jn(e){return e?.condition}const Lc=["domain","grid","labels","ticks","title"],tm={grid:"grid",gridCap:"grid",gridColor:"grid",gridDash:"grid",gridDashOffset:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"both",aria:"main",description:"main",domain:"main",domainCap:"main",domainColor:"main",domainDash:"main",domainDashOffset:"main",domainOpacity:"main",domainWidth:"main",format:"main",formatType:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontStyle:"main",labelFontWeight:"main",labelLimit:"main",labelLineHeight:"main",labelOffset:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",labelSeparation:"main",maxExtent:"main",minExtent:"main",offset:"both",position:"main",tickCap:"main",tickColor:"main",tickDash:"main",tickDashOffset:"main",tickMinStep:"both",tickOffset:"both",tickOpacity:"main",tickRound:"both",ticks:"main",tickSize:"main",tickWidth:"both",title:"main",titleAlign:"main",titleAnchor:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontStyle:"main",titleFontWeight:"main",titleLimit:"main",titleLineHeight:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",encode:"both",scale:"both",tickBand:"both",tickCount:"both",tickExtra:"both",translate:"both",values:"both",zindex:"both"},Mc={orient:1,aria:1,bandPosition:1,description:1,domain:1,domainCap:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridCap:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelLineHeight:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickBand:1,tickCap:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,translate:1,values:1,zindex:1},nm={...Mc,style:1,labelExpr:1,encoding:1};function Dc(e){return!!nm[e]}const im={axis:1,axisBand:1,axisBottom:1,axisDiscrete:1,axisLeft:1,axisPoint:1,axisQuantitative:1,axisRight:1,axisTemporal:1,axisTop:1,axisX:1,axisXBand:1,axisXDiscrete:1,axisXPoint:1,axisXQuantitative:1,axisXTemporal:1,axisY:1,axisYBand:1,axisYDiscrete:1,axisYPoint:1,axisYQuantitative:1,axisYTemporal:1},jc=b(im);function dt(e){return"mark"in e}class Gi{constructor(t,n){this.name=t,this.run=n}hasMatchingType(t){return dt(t)?Og(t.mark)===this.name:!1}}function Yt(e,t){const n=e&&e[t];return n?v(n)?It(n,i=>!!i.field):S(n)||Di(n):!1}function Uc(e,t){const n=e&&e[t];return n?v(n)?It(n,i=>!!i.field):S(n)||Ye(n)||Qn(n):!1}function _s(e,t){if(Q(t)){const n=e[t];if((S(n)||Ye(n))&&(Ja(n.type)||S(n)&&n.timeUnit)){const i=jr(t);return Uc(e,i)}}return!1}function ks(e){return It(sd,t=>{if(Yt(e,t)){const n=e[t];if(v(n))return It(n,i=>!!i.aggregate);{const i=Ke(n);return i&&!!i.aggregate}}return!1})}function Bc(e,t){const n=[],i=[],r=[],s=[],o={};return Cs(e,(a,c)=>{if(S(a)){const{field:u,aggregate:l,bin:f,timeUnit:d,...p}=a;if(l||d||f){const g=$s(a),m=g?.title;let h=w(a,{forAs:!0});const y={...m?[]:{title:$n(a,t,{allowDisabling:!0})},...p,field:h};if(l){let $;if(_t(l)?($="argmax",h=w({op:"argmax",field:l.argmax},{forAs:!0}),y.field=`${h}.${u}`):ut(l)?($="argmin",h=w({op:"argmin",field:l.argmin},{forAs:!0}),y.field=`${h}.${u}`):l!=="boxplot"&&l!=="errorbar"&&l!=="errorband"&&($=l),$){const C={op:$,as:h};u&&(C.field=u),s.push(C)}}else if(n.push(h),ae(a)&&j(f)){if(i.push({bin:f,field:u,as:h}),n.push(w(a,{binSuffix:"end"})),Zn(a,c)&&n.push(w(a,{binSuffix:"range"})),Q(c)){const $={field:`${h}_end`};o[`${c}2`]=$}y.bin="binned",ua(c)||(y.type=Ht)}else if(d){r.push({timeUnit:d,field:u,as:h});const $=ae(a)&&a.type!==yn&&"time";$&&(c===Hn||c===Dt?y.formatType=$:gd(c)?y.legend={formatType:$,...y.legend}:Q(c)&&(y.axis={formatType:$,...y.axis}))}o[c]=y}else n.push(u),o[c]=e[c]}else o[c]=e[c]}),{bins:i,timeUnits:r,aggregate:s,groupby:n,encoding:o}}function rm(e,t,n){const i=hd(t,n);if(i){if(i==="binned"){const r=e[t===_e?H:K];return!!(S(r)&&S(e[t])&&te(r.bin))}}else return!1;return!0}function sm(e,t,n,i){const r={};for(const s of b(e))ca(s)||x(rp(s));for(let s of ld){if(!e[s])continue;const o=e[s];if(mn(s)){const a=fa(s),c=r[a];if(S(c)){if(ng(c.type)&&(S(o)&&!c.timeUnit)){x(Kd(a));continue}}else s=a,x(Qd(a))}if(s==="angle"&&t==="arc"&&!e.theta&&(x(Yd),s=we),!rm(e,s,t)){x(Ci(s,t));continue}if(s===ot&&t==="line"){const a=Ke(e[s]);if(a?.aggregate){x(np);continue}}if(s===le&&(n?"fill"in e:"stroke"in e)){x(Ma("encoding",{fill:"fill"in e,stroke:"stroke"in e}));continue}if(s===qn||s===pn&&!v(o)&&!Pe(o)||s===Dt&&v(o)){if(o){if(s===pn){const a=e[s];if(Cc(a)){r[s]=a;continue}}r[s]=q(o).reduce((a,c)=>(S(c)?a.push(Es(c,s)):x(Yr(c,s)),a),[])}}else{if(s===Dt&&o===null)r[s]=null;else if(!S(o)&&!Ye(o)&&!Pe(o)&&!Mi(o)&&!E(o)){x(Yr(o,s));continue}r[s]=zc(o,s,i)}}return r}function Vi(e,t){const n={};for(const i of b(e)){const r=zc(e[i],i,t,{compositeMark:!0});n[i]=r}return n}function om(e){const t=[];for(const n of b(e))if(Yt(e,n)){const i=e[n],r=q(i);for(const s of r)S(s)?t.push(s):Di(s)&&t.push(s.condition)}return t}function Cs(e,t,n){if(!e)return;for(const i of b(e)){const r=e[i];if(v(r))for(const s of r)t.call(n,s,i);else t.call(n,r,i)}}function am(e,t,n,i){return e?b(e).reduce((r,s)=>{const o=e[s];return v(o)?o.reduce((a,c)=>t.call(i,a,c,s),r):t.call(i,r,o,s)},n):n}function Wc(e,t){return b(t).reduce((n,i)=>{switch(i){case H:case K:case Si:case $i:case wi:case _e:case Ue:case xt:case dn:case we:case st:case ke:case rt:case Ce:case Ne:case Fe:case $e:case Hn:case fe:case Mt:case Dt:return n;case pn:if(e==="line"||e==="trail")return n;case qn:case xi:{const r=t[i];if(v(r)||S(r))for(const s of q(r))s.aggregate||n.push(w(s,{}));return n}case ot:if(e==="trail")return n;case le:case Be:case We:case at:case St:case wt:case vt:case $t:{const r=Ke(t[i]);return r&&!r.aggregate&&n.push(w(r,{})),n}}},[])}function cm(e){const{tooltip:t,...n}=e;if(!t)return{filteredEncoding:n};let i,r;if(v(t)){for(const s of t)s.aggregate?(i||(i=[]),i.push(s)):(r||(r=[]),r.push(s));i&&(n.tooltip=i)}else t.aggregate?n.tooltip=t:r=t;return v(r)&&r.length===1&&(r=r[0]),{customTooltipWithoutAggregatedField:r,filteredEncoding:n}}function Ns(e,t,n,i=!0){if("tooltip"in n)return{tooltip:n.tooltip};const r=e.map(({fieldPrefix:o,titlePrefix:a})=>{const c=i?` of ${Fs(t)}`:"";return{field:o+t.field,type:t.type,title:E(a)?{signal:`${a}"${escape(c)}"`}:a+c}}),s=om(n).map(Hg);return{tooltip:[...r,...je(s,O)]}}function Fs(e){const{title:t,field:n}=e;return V(t,n)}function Ts(e,t,n,i,r){const{scale:s,axis:o}=n;return({partName:a,mark:c,positionPrefix:u,endPositionPrefix:l=void 0,extraEncoding:f={}})=>{const d=Fs(n);return Hc(e,a,r,{mark:c,encoding:{[t]:{field:`${u}_${n.field}`,type:n.type,...d!==void 0?{title:d}:{},...s!==void 0?{scale:s}:{},...o!==void 0?{axis:o}:{}},...F(l)?{[`${t}2`]:{field:`${l}_${n.field}`}}:{},...i,...f}})}}function Hc(e,t,n,i){const{clip:r,color:s,opacity:o}=e,a=e.type;return e[t]||e[t]===void 0&&n[t]?[{...i,mark:{...n[t],...r?{clip:r}:{},...s?{color:s}:{},...o?{opacity:o}:{},...Ve(i.mark)?i.mark:{type:i.mark},style:`${a}-${String(t)}`,...Dn(e[t])?{}:e[t]}}]:[]}function qc(e,t,n){const{encoding:i}=e,r=t==="vertical"?"y":"x",s=i[r],o=i[`${r}2`],a=i[`${r}Error`],c=i[`${r}Error2`];return{continuousAxisChannelDef:Xi(s,n),continuousAxisChannelDef2:Xi(o,n),continuousAxisChannelDefError:Xi(a,n),continuousAxisChannelDefError2:Xi(c,n),continuousAxis:r}}function Xi(e,t){if(e?.aggregate){const{aggregate:n,...i}=e;return n!==t&&x(Op(n,t)),i}else return e}function Gc(e,t){const{mark:n,encoding:i}=e,{x:r,y:s}=i;if(Ve(n)&&n.orient)return n.orient;if(Ft(r)){if(Ft(s)){const o=S(r)&&r.aggregate,a=S(s)&&s.aggregate;if(!o&&a===t)return"vertical";if(!a&&o===t)return"horizontal";if(o===t&&a===t)throw new Error("Both x and y cannot have aggregate");return En(s)&&!En(r)?"horizontal":"vertical"}return"horizontal"}else{if(Ft(s))return"vertical";throw new Error(`Need a valid continuous axis for ${t}s`)}}const Yi="boxplot",um=["box","median","outliers","rule","ticks"],lm=new Gi(Yi,Xc);function Vc(e){return G(e)?"tukey":e}function Xc(e,{config:t}){e={...e,encoding:Vi(e.encoding,t)};const{mark:n,encoding:i,params:r,projection:s,...o}=e,a=Ve(n)?n:{type:n};r&&x(Pa("boxplot"));const c=a.extent??t.boxplot.extent,u=z("size",a,t),l=a.invalid,f=Vc(c),{bins:d,timeUnits:p,transform:g,continuousAxisChannelDef:m,continuousAxis:h,groupby:y,aggregate:$,encodingWithoutContinuousAxis:C,ticksOrient:_,boxOrient:T,customTooltipWithoutAggregatedField:L}=fm(e,c,t),{color:he,size:ie,...Me}=C,yt=Sf=>Ts(a,h,m,Sf,t.boxplot),tt=yt(Me),Er=yt(C),fi=yt({...Me,...ie?{size:ie}:{}}),rn=Ns([{fieldPrefix:f==="min-max"?"upper_whisker_":"max_",titlePrefix:"Max"},{fieldPrefix:"upper_box_",titlePrefix:"Q3"},{fieldPrefix:"mid_box_",titlePrefix:"Median"},{fieldPrefix:"lower_box_",titlePrefix:"Q1"},{fieldPrefix:f==="min-max"?"lower_whisker_":"min_",titlePrefix:"Min"}],m,C),Mn={type:"tick",color:"black",opacity:1,orient:_,invalid:l,aria:!1},sn=f==="min-max"?rn:Ns([{fieldPrefix:"upper_whisker_",titlePrefix:"Upper Whisker"},{fieldPrefix:"lower_whisker_",titlePrefix:"Lower Whisker"}],m,C),zo=[...tt({partName:"rule",mark:{type:"rule",invalid:l,aria:!1},positionPrefix:"lower_whisker",endPositionPrefix:"lower_box",extraEncoding:sn}),...tt({partName:"rule",mark:{type:"rule",invalid:l,aria:!1},positionPrefix:"upper_box",endPositionPrefix:"upper_whisker",extraEncoding:sn}),...tt({partName:"ticks",mark:Mn,positionPrefix:"lower_whisker",extraEncoding:sn}),...tt({partName:"ticks",mark:Mn,positionPrefix:"upper_whisker",extraEncoding:sn})],Ro=[...f!=="tukey"?zo:[],...Er({partName:"box",mark:{type:"bar",...u?{size:u}:{},orient:T,invalid:l,ariaRoleDescription:"box"},positionPrefix:"lower_box",endPositionPrefix:"upper_box",extraEncoding:rn}),...fi({partName:"median",mark:{type:"tick",invalid:l,...M(t.boxplot.median)&&t.boxplot.median.color?{color:t.boxplot.median.color}:{},...u?{size:u}:{},orient:_,aria:!1},positionPrefix:"mid_box",extraEncoding:rn})];if(f==="min-max")return{...o,transform:(o.transform??[]).concat(g),layer:Ro};const Io=`datum["lower_box_${m.field}"]`,Lo=`datum["upper_box_${m.field}"]`,Mo=`(${Lo} - ${Io})`,Do=`${Io} - ${c} * ${Mo}`,jo=`${Lo} + ${c} * ${Mo}`,di=`datum["${m.field}"]`,yf={joinaggregate:Yc(m.field),groupby:y},Uo={transform:[{filter:`(${Do} <= ${di}) && (${di} <= ${jo})`},{aggregate:[{op:"min",field:m.field,as:`lower_whisker_${m.field}`},{op:"max",field:m.field,as:`upper_whisker_${m.field}`},{op:"min",field:`lower_box_${m.field}`,as:`lower_box_${m.field}`},{op:"max",field:`upper_box_${m.field}`,as:`upper_box_${m.field}`},...$],groupby:y}],layer:zo},{tooltip:vS,...bf}=Me,{scale:Bo,axis:xf}=m,Wo=Fs(m),Ho=ue(xf,["title"]),qo=Hc(a,"outliers",t.boxplot,{transform:[{filter:`(${di} < ${Do}) || (${di} > ${jo})`}],mark:"point",encoding:{[h]:{field:m.field,type:m.type,...Wo!==void 0?{title:Wo}:{},...Bo!==void 0?{scale:Bo}:{},...I(Ho)?{}:{axis:Ho}},...bf,...he?{color:he}:{},...L?{tooltip:L}:{}}})[0];let pi;const Go=[...d,...p,yf];return qo?pi={transform:Go,layer:[qo,Uo]}:(pi=Uo,pi.transform.unshift(...Go)),{...o,layer:[pi,{transform:g,layer:Ro}]}}function Yc(e){return[{op:"q1",field:e,as:`lower_box_${e}`},{op:"q3",field:e,as:`upper_box_${e}`}]}function fm(e,t,n){const i=Gc(e,Yi),{continuousAxisChannelDef:r,continuousAxis:s}=qc(e,i,Yi),o=r.field,a=Vc(t),c=[...Yc(o),{op:"median",field:o,as:`mid_box_${o}`},{op:"min",field:o,as:(a==="min-max"?"lower_whisker_":"min_")+o},{op:"max",field:o,as:(a==="min-max"?"upper_whisker_":"max_")+o}],u=a==="min-max"||a==="tukey"?[]:[{calculate:`datum["upper_box_${o}"] - datum["lower_box_${o}"]`,as:`iqr_${o}`},{calculate:`min(datum["upper_box_${o}"] + datum["iqr_${o}"] * ${t}, datum["max_${o}"])`,as:`upper_whisker_${o}`},{calculate:`max(datum["lower_box_${o}"] - datum["iqr_${o}"] * ${t}, datum["min_${o}"])`,as:`lower_whisker_${o}`}],{[s]:l,...f}=e.encoding,{customTooltipWithoutAggregatedField:d,filteredEncoding:p}=cm(f),{bins:g,timeUnits:m,aggregate:h,groupby:y,encoding:$}=Bc(p,n),C=i==="vertical"?"horizontal":"vertical",_=i,T=[...g,...m,{aggregate:[...h,...c],groupby:y},...u];return{bins:g,timeUnits:m,transform:T,groupby:y,aggregate:h,continuousAxisChannelDef:r,continuousAxis:s,encodingWithoutContinuousAxis:$,ticksOrient:C,boxOrient:_,customTooltipWithoutAggregatedField:d}}const As="errorbar",dm=["ticks","rule"],pm=new Gi(As,Kc);function Kc(e,{config:t}){e={...e,encoding:Vi(e.encoding,t)};const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,ticksOrient:o,markDef:a,outerSpec:c,tooltipEncoding:u}=Qc(e,As,t);delete s.size;const l=Ts(a,r,i,s,t.errorbar),f=a.thickness,d=a.size,p={type:"tick",orient:o,aria:!1,...f!==void 0?{thickness:f}:{},...d!==void 0?{size:d}:{}},g=[...l({partName:"ticks",mark:p,positionPrefix:"lower",extraEncoding:u}),...l({partName:"ticks",mark:p,positionPrefix:"upper",extraEncoding:u}),...l({partName:"rule",mark:{type:"rule",ariaRoleDescription:"errorbar",...f!==void 0?{size:f}:{}},positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:u})];return{...c,transform:n,...g.length>1?{layer:g}:{...g[0]}}}function gm(e,t){const{encoding:n}=e;if(mm(n))return{orient:Gc(e,t),inputType:"raw"};const i=hm(n),r=ym(n),s=n.x,o=n.y;if(i){if(r)throw new Error(`${t} cannot be both type aggregated-upper-lower and aggregated-error`);const a=n.x2,c=n.y2;if(N(a)&&N(c))throw new Error(`${t} cannot have both x2 and y2`);if(N(a)){if(Ft(s))return{orient:"horizontal",inputType:"aggregated-upper-lower"};throw new Error(`Both x and x2 have to be quantitative in ${t}`)}else if(N(c)){if(Ft(o))return{orient:"vertical",inputType:"aggregated-upper-lower"};throw new Error(`Both y and y2 have to be quantitative in ${t}`)}throw new Error("No ranged axis")}else{const a=n.xError,c=n.xError2,u=n.yError,l=n.yError2;if(N(c)&&!N(a))throw new Error(`${t} cannot have xError2 without xError`);if(N(l)&&!N(u))throw new Error(`${t} cannot have yError2 without yError`);if(N(a)&&N(u))throw new Error(`${t} cannot have both xError and yError with both are quantiative`);if(N(a)){if(Ft(s))return{orient:"horizontal",inputType:"aggregated-error"};throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}else if(N(u)){if(Ft(o))return{orient:"vertical",inputType:"aggregated-error"};throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}throw new Error("No ranged axis")}}function mm(e){return(N(e.x)||N(e.y))&&!N(e.x2)&&!N(e.y2)&&!N(e.xError)&&!N(e.xError2)&&!N(e.yError)&&!N(e.yError2)}function hm(e){return N(e.x2)||N(e.y2)}function ym(e){return N(e.xError)||N(e.xError2)||N(e.yError)||N(e.yError2)}function Qc(e,t,n){const{mark:i,encoding:r,params:s,projection:o,...a}=e,c=Ve(i)?i:{type:i};s&&x(Pa(t));const{orient:u,inputType:l}=gm(e,t),{continuousAxisChannelDef:f,continuousAxisChannelDef2:d,continuousAxisChannelDefError:p,continuousAxisChannelDefError2:g,continuousAxis:m}=qc(e,u,t),{errorBarSpecificAggregate:h,postAggregateCalculates:y,tooltipSummary:$,tooltipTitleWithFieldName:C}=bm(c,f,d,p,g,l,t,n),{[m]:_,[m==="x"?"x2":"y2"]:T,[m==="x"?"xError":"yError"]:L,[m==="x"?"xError2":"yError2"]:he,...ie}=r,{bins:Me,timeUnits:yt,aggregate:tt,groupby:Er,encoding:fi}=Bc(ie,n),rn=[...tt,...h],Mn=l!=="raw"?[]:Er,sn=Ns($,f,fi,C);return{transform:[...a.transform??[],...Me,...yt,...rn.length===0?[]:[{aggregate:rn,groupby:Mn}],...y],groupby:Mn,continuousAxisChannelDef:f,continuousAxis:m,encodingWithoutContinuousAxis:fi,ticksOrient:u==="vertical"?"horizontal":"vertical",markDef:c,outerSpec:a,tooltipEncoding:sn}}function bm(e,t,n,i,r,s,o,a){let c=[],u=[];const l=t.field;let f,d=!1;if(s==="raw"){const p=e.center?e.center:e.extent?e.extent==="iqr"?"median":"mean":a.errorbar.center,g=e.extent?e.extent:p==="mean"?"stderr":"iqr";if(p==="median"!==(g==="iqr")&&x(Ap(p,g,o)),g==="stderr"||g==="stdev")c=[{op:g,field:l,as:`extent_${l}`},{op:p,field:l,as:`center_${l}`}],u=[{calculate:`datum["center_${l}"] + datum["extent_${l}"]`,as:`upper_${l}`},{calculate:`datum["center_${l}"] - datum["extent_${l}"]`,as:`lower_${l}`}],f=[{fieldPrefix:"center_",titlePrefix:Bn(p)},{fieldPrefix:"upper_",titlePrefix:Zc(p,g,"+")},{fieldPrefix:"lower_",titlePrefix:Zc(p,g,"-")}],d=!0;else{let m,h,y;g==="ci"?(m="mean",h="ci0",y="ci1"):(m="median",h="q1",y="q3"),c=[{op:h,field:l,as:`lower_${l}`},{op:y,field:l,as:`upper_${l}`},{op:m,field:l,as:`center_${l}`}],f=[{fieldPrefix:"upper_",titlePrefix:$n({field:l,aggregate:y,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"lower_",titlePrefix:$n({field:l,aggregate:h,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"center_",titlePrefix:$n({field:l,aggregate:m,type:"quantitative"},a,{allowDisabling:!1})}]}}else{(e.center||e.extent)&&x(Tp(e.center,e.extent)),s==="aggregated-upper-lower"?(f=[],u=[{calculate:`datum["${n.field}"]`,as:`upper_${l}`},{calculate:`datum["${l}"]`,as:`lower_${l}`}]):s==="aggregated-error"&&(f=[{fieldPrefix:"",titlePrefix:l}],u=[{calculate:`datum["${l}"] + datum["${i.field}"]`,as:`upper_${l}`}],r?u.push({calculate:`datum["${l}"] + datum["${r.field}"]`,as:`lower_${l}`}):u.push({calculate:`datum["${l}"] - datum["${i.field}"]`,as:`lower_${l}`}));for(const p of u)f.push({fieldPrefix:p.as.substring(0,6),titlePrefix:Lt(Lt(p.calculate,'datum["',""),'"]',"")})}return{postAggregateCalculates:u,errorBarSpecificAggregate:c,tooltipSummary:f,tooltipTitleWithFieldName:d}}function Zc(e,t,n){return`${Bn(e)} ${n} ${t}`}const Os="errorband",xm=["band","borders"],Sm=new Gi(Os,Jc);function Jc(e,{config:t}){e={...e,encoding:Vi(e.encoding,t)};const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,markDef:o,outerSpec:a,tooltipEncoding:c}=Qc(e,Os,t),u=o,l=Ts(u,r,i,s,t.errorband),f=e.encoding.x!==void 0&&e.encoding.y!==void 0;let d={type:f?"area":"rect"},p={type:f?"line":"rule"};const g={...u.interpolate?{interpolate:u.interpolate}:{},...u.tension&&u.interpolate?{tension:u.tension}:{}};return f?(d={...d,...g,ariaRoleDescription:"errorband"},p={...p,...g,aria:!1}):u.interpolate?x(Ba("interpolate")):u.tension&&x(Ba("tension")),{...a,transform:n,layer:[...l({partName:"band",mark:d,positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:c}),...l({partName:"borders",mark:p,positionPrefix:"lower",extraEncoding:c}),...l({partName:"borders",mark:p,positionPrefix:"upper",extraEncoding:c})]}}const eu={};function Ps(e,t,n){const i=new Gi(e,t);eu[e]={normalizer:i,parts:n}}function wm(){return b(eu)}Ps(Yi,Xc,um),Ps(As,Kc,dm),Ps(Os,Jc,xm);const $m=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength","unselectedOpacity"],tu={titleAlign:"align",titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontStyle:"fontStyle",titleFontWeight:"fontWeight",titleLimit:"limit",titleLineHeight:"lineHeight",titleOrient:"orient",titlePadding:"offset"},nu={labelAlign:"align",labelAnchor:"anchor",labelAngle:"angle",labelBaseline:"baseline",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelFontStyle:"fontStyle",labelFontWeight:"fontWeight",labelLimit:"limit",labelLineHeight:"lineHeight",labelOrient:"orient",labelPadding:"offset"},vm=b(tu),Em=b(nu),_m={header:1,headerRow:1,headerColumn:1,headerFacet:1},iu=b(_m),ru=["size","shape","fill","stroke","strokeDash","strokeWidth","opacity"],km={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64,unselectedOpacity:.35},Cm={aria:1,clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,description:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolLimit:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1},ze="_vgsid_",Nm={point:{on:"click",fields:[ze],toggle:"event.shiftKey",resolve:"global",clear:"dblclick"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global",clear:"dblclick"}};function zs(e){return e==="legend"||!!e?.legend}function Rs(e){return zs(e)&&M(e)}function Is(e){return!!e?.select}function su(e){const t=[];for(const n of e||[]){if(Is(n))continue;const{expr:i,bind:r,...s}=n;if(r&&i){const o={...s,bind:r,init:i};t.push(o)}else{const o={...s,...i?{update:i}:{},...r?{bind:r}:{}};t.push(o)}}return t}function Fm(e){return Ki(e)||Ms(e)||Ls(e)}function Ls(e){return"concat"in e}function Ki(e){return"vconcat"in e}function Ms(e){return"hconcat"in e}function ou({step:e,offsetIsDiscrete:t}){return t?e.for??"offset":"position"}function Qe(e){return M(e)&&e.step!==void 0}function au(e){return e.view||e.width||e.height}const cu=20,Tm={align:1,bounds:1,center:1,columns:1,spacing:1},Am=b(Tm);function Om(e,t,n){const i=n[t],r={},{spacing:s,columns:o}=i;s!==void 0&&(r.spacing=s),o!==void 0&&((Li(e)&&!Kn(e.facet)||Ls(e))&&(r.columns=o)),Ki(e)&&(r.columns=1);for(const a of Am)if(e[a]!==void 0)if(a==="spacing"){const c=e[a];r[a]=G(c)?c:{row:c.row??s,column:c.column??s}}else r[a]=e[a];return r}function Ds(e,t){return e[t]??e[t==="width"?"continuousWidth":"continuousHeight"]}function Qi(e,t){const n=Zi(e,t);return Qe(n)?n.step:uu}function Zi(e,t){const n=e[t]??e[t==="width"?"discreteWidth":"discreteHeight"];return V(n,{step:e.step})}const uu=20,Pm={continuousWidth:200,continuousHeight:200,step:uu},zm={background:"white",padding:5,timeFormat:"%b %d, %Y",countTitle:"Count of Records",view:Pm,mark:kg,arc:{},area:{},bar:Fg,circle:{},geoshape:{},image:{},line:{},point:{},rect:Tg,rule:{color:"black"},square:{},text:{color:"black"},tick:Ag,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:cg,projection:{},legend:km,header:{titlePadding:10,labelPadding:10},headerColumn:{},headerRow:{},headerFacet:{},selection:Nm,style:{},title:{},facet:{spacing:cu},concat:{spacing:cu},normalizedNumberFormat:".0%"},pt=["#4c78a8","#f58518","#e45756","#72b7b2","#54a24b","#eeca3b","#b279a2","#ff9da6","#9d755d","#bab0ac"],lu={text:11,guideLabel:10,guideTitle:11,groupTitle:13,groupSubtitle:12},fu={blue:pt[0],orange:pt[1],red:pt[2],teal:pt[3],green:pt[4],yellow:pt[5],purple:pt[6],pink:pt[7],brown:pt[8],gray0:"#000",gray1:"#111",gray2:"#222",gray3:"#333",gray4:"#444",gray5:"#555",gray6:"#666",gray7:"#777",gray8:"#888",gray9:"#999",gray10:"#aaa",gray11:"#bbb",gray12:"#ccc",gray13:"#ddd",gray14:"#eee",gray15:"#fff"};function Rm(e={}){return{signals:[{name:"color",value:M(e)?{...fu,...e}:fu}],mark:{color:{signal:"color.blue"}},rule:{color:{signal:"color.gray0"}},text:{color:{signal:"color.gray0"}},style:{"guide-label":{fill:{signal:"color.gray0"}},"guide-title":{fill:{signal:"color.gray0"}},"group-title":{fill:{signal:"color.gray0"}},"group-subtitle":{fill:{signal:"color.gray0"}},cell:{stroke:{signal:"color.gray8"}}},axis:{domainColor:{signal:"color.gray13"},gridColor:{signal:"color.gray8"},tickColor:{signal:"color.gray13"}},range:{category:[{signal:"color.blue"},{signal:"color.orange"},{signal:"color.red"},{signal:"color.teal"},{signal:"color.green"},{signal:"color.yellow"},{signal:"color.purple"},{signal:"color.pink"},{signal:"color.brown"},{signal:"color.grey8"}]}}}function Im(e){return{signals:[{name:"fontSize",value:M(e)?{...lu,...e}:lu}],text:{fontSize:{signal:"fontSize.text"}},style:{"guide-label":{fontSize:{signal:"fontSize.guideLabel"}},"guide-title":{fontSize:{signal:"fontSize.guideTitle"}},"group-title":{fontSize:{signal:"fontSize.groupTitle"}},"group-subtitle":{fontSize:{signal:"fontSize.groupSubtitle"}}}}}function Lm(e){return{text:{font:e},style:{"guide-label":{font:e},"guide-title":{font:e},"group-title":{font:e},"group-subtitle":{font:e}}}}function du(e){const t=b(e||{}),n={};for(const i of t){const r=e[i];n[i]=Jn(r)?Sa(r):ye(r)}return n}function Mm(e){const t=b(e),n={};for(const i of t)n[i]=du(e[i]);return n}const Dm=[...dc,...jc,...iu,"background","padding","legend","lineBreak","scale","style","title","view"];function pu(e={}){const{color:t,font:n,fontSize:i,selection:r,...s}=e,o=Vo({},k(zm),n?Lm(n):{},t?Rm(t):{},i?Im(i):{},s||{});r&&Nf(o,"selection",r,!0);const a=ue(o,Dm);for(const c of["background","lineBreak","padding"])o[c]&&(a[c]=ye(o[c]));for(const c of dc)o[c]&&(a[c]=pe(o[c]));for(const c of jc)o[c]&&(a[c]=du(o[c]));for(const c of iu)o[c]&&(a[c]=pe(o[c]));return o.legend&&(a.legend=pe(o.legend)),o.scale&&(a.scale=pe(o.scale)),o.style&&(a.style=Mm(o.style)),o.title&&(a.title=pe(o.title)),o.view&&(a.view=pe(o.view)),a}const jm=new Set(["view",...Sg]),Um=["color","fontSize","background","padding","facet","concat","numberFormat","numberFormatType","normalizedNumberFormat","normalizedNumberFormatType","timeFormat","countTitle","header","axisQuantitative","axisTemporal","axisDiscrete","axisPoint","axisXBand","axisXPoint","axisXDiscrete","axisXQuantitative","axisXTemporal","axisYBand","axisYPoint","axisYDiscrete","axisYQuantitative","axisYTemporal","scale","selection","overlay"],Bm={view:["continuousWidth","continuousHeight","discreteWidth","discreteHeight","step"],..._g};function Wm(e){e=k(e);for(const t of Um)delete e[t];if(e.axis)for(const t in e.axis)Jn(e.axis[t])&&delete e.axis[t];if(e.legend)for(const t of $m)delete e.legend[t];if(e.mark){for(const t of fc)delete e.mark[t];e.mark.tooltip&&M(e.mark.tooltip)&&delete e.mark.tooltip}e.params&&(e.signals=(e.signals||[]).concat(su(e.params)),delete e.params);for(const t of jm){for(const i of fc)delete e[t][i];const n=Bm[t];if(n)for(const i of n)delete e[t][i];qm(e,t)}for(const t of wm())delete e[t];Hm(e);for(const t in e)M(e[t])&&I(e[t])&&delete e[t];return I(e)?void 0:e}function Hm(e){const{titleMarkConfig:t,subtitleMarkConfig:n,subtitle:i}=xa(e.title);I(t)||(e.style["group-title"]={...e.style["group-title"],...t}),I(n)||(e.style["group-subtitle"]={...e.style["group-subtitle"],...n}),I(i)?delete e.title:e.title=i}function qm(e,t,n,i){const r=i?e[t][i]:e[t];t==="view"&&(n="cell");const s={...r,...e.style[n??t]};I(s)||(e.style[n??t]=s),i||delete e[t]}function Ji(e){return"layer"in e}function Gm(e){return"repeat"in e}function Vm(e){return!v(e.repeat)&&e.repeat.layer}class js{map(t,n){return Li(t)?this.mapFacet(t,n):Gm(t)?this.mapRepeat(t,n):Ms(t)?this.mapHConcat(t,n):Ki(t)?this.mapVConcat(t,n):Ls(t)?this.mapConcat(t,n):this.mapLayerOrUnit(t,n)}mapLayerOrUnit(t,n){if(Ji(t))return this.mapLayer(t,n);if(dt(t))return this.mapUnit(t,n);throw new Error(Vr(t))}mapLayer(t,n){return{...t,layer:t.layer.map(i=>this.mapLayerOrUnit(i,n))}}mapHConcat(t,n){return{...t,hconcat:t.hconcat.map(i=>this.map(i,n))}}mapVConcat(t,n){return{...t,vconcat:t.vconcat.map(i=>this.map(i,n))}}mapConcat(t,n){const{concat:i,...r}=t;return{...r,concat:i.map(s=>this.map(s,n))}}mapFacet(t,n){return{...t,spec:this.map(t.spec,n)}}mapRepeat(t,n){return{...t,spec:this.map(t.spec,n)}}}const Xm={zero:1,center:1,normalize:1};function Ym(e){return e in Xm}const Km=new Set([ac,Ai,Ti,zi,Pi,ps,gs,Oi,cc,ds]),Qm=new Set([Ai,Ti,ac]);function _n(e){return S(e)&&Sn(e)==="quantitative"&&!e.bin}function gu(e,t,{orient:n,type:i}){const r=t==="x"?"y":"radius",s=t==="x",o=e[t],a=e[r];if(S(o)&&S(a))if(_n(o)&&_n(a)){if(o.stack)return t;if(a.stack)return r;const c=S(o)&&!!o.aggregate,u=S(a)&&!!a.aggregate;if(c!==u)return c?t:r;if(s&&i==="bar"){if(n==="vertical")return r;if(n==="horizontal")return t}}else{if(_n(o))return t;if(_n(a))return r}else{if(_n(o))return t;if(_n(a))return r}return}function Zm(e){switch(e){case"x":return"y";case"y":return"x";case"theta":return"radius";case"radius":return"theta"}}function mu(e,t){const n=Ve(e)?e:{type:e},i=n.type;if(!Km.has(i))return null;const r=gu(t,"x",n)||gu(t,"theta",n);if(!r)return null;const s=t[r],o=S(s)?w(s,{}):void 0,a=Zm(r),c=[],u=new Set;if(t[a]){const d=t[a],p=S(d)?w(d,{}):void 0;p&&p!==o&&(c.push(a),u.add(p));const g=a==="x"?"xOffset":"yOffset",m=t[g],h=S(m)?w(m,{}):void 0;h&&h!==o&&(c.push(g),u.add(h))}const l=fd.reduce((d,p)=>{if(p!=="tooltip"&&Yt(t,p)){const g=t[p];for(const m of q(g)){const h=Ke(m);if(h.aggregate)continue;const y=w(h,{});(!y||!u.has(y))&&d.push({channel:p,fieldDef:h})}}return d},[]);let f;return s.stack!==void 0?Dn(s.stack)?f=s.stack?"zero":null:f=s.stack:Qm.has(i)&&(f="zero"),!f||!Ym(f)||ks(t)&&l.length===0?null:s?.scale?.type&&s?.scale?.type!==ge.LINEAR?(s?.stack&&x(Cp(s.scale.type)),null):N(t[He(r)])?(s.stack!==void 0&&x(kp(r)),null):(S(s)&&s.aggregate&&!vd.has(s.aggregate)&&x(Np(s.aggregate)),{groupbyChannels:c,groupbyFields:u,fieldChannel:r,impute:s.impute===null?!1:Nt(i),stackBy:l,offset:f})}function Jm(e){const{point:t,line:n,...i}=e;return b(i).length>1?i:i.type}function eh(e){for(const t of["line","area","rule","trail"])e[t]&&(e={...e,[t]:ue(e[t],["point","line"])});return e}function Us(e,t={},n){return e.point==="transparent"?{opacity:0}:e.point?M(e.point)?e.point:{}:e.point!==void 0?null:t.point||n.shape?M(t.point)?t.point:{}:void 0}function hu(e,t={}){return e.line?e.line===!0?{}:e.line:e.line!==void 0?null:t.line?t.line===!0?{}:t.line:void 0}class th{constructor(){this.name="path-overlay"}hasMatchingType(t,n){if(dt(t)){const{mark:i,encoding:r}=t,s=Ve(i)?i:{type:i};switch(s.type){case"line":case"rule":case"trail":return!!Us(s,n[s.type],r);case"area":return!!Us(s,n[s.type],r)||!!hu(s,n[s.type])}}return!1}run(t,n,i){const{config:r}=n,{params:s,projection:o,mark:a,name:c,encoding:u,...l}=t,f=Vi(u,r),d=Ve(a)?a:{type:a},p=Us(d,r[d.type],f),g=d.type==="area"&&hu(d,r[d.type]),m=[{name:c,...s?{params:s}:{},mark:Jm({...d.type==="area"&&d.opacity===void 0&&d.fillOpacity===void 0?{opacity:.7}:{},...d}),encoding:ue(f,["shape"])}],h=mu(d,f);let y=f;if(h){const{fieldChannel:$,offset:C}=h;y={...f,[$]:{...f[$],...C?{stack:C}:{}}}}return y=ue(y,["y2","x2"]),g&&m.push({...o?{projection:o}:{},mark:{type:"line",...ln(d,["clip","interpolate","tension","tooltip"]),...g},encoding:y}),p&&m.push({...o?{projection:o}:{},mark:{type:"point",opacity:1,filled:!0,...ln(d,["clip","tooltip"]),...p},encoding:y}),i({...l,layer:m},{...n,config:eh(r)})}}function nh(e,t){return t?Kn(e)?Su(e,t):yu(e,t):e}function Bs(e,t){return t?Su(e,t):e}function Ws(e,t,n){const i=t[e];if(Bg(i)){if(i.repeat in n)return{...t,[e]:n[i.repeat]};x(Bd(i.repeat));return}return t}function yu(e,t){if(e=Ws("field",e,t),e===void 0)return;if(e===null)return null;if(ws(e)&&Xe(e.sort)){const n=Ws("field",e.sort,t);e={...e,...n?{sort:n}:{}}}return e}function bu(e,t){if(S(e))return yu(e,t);{const n=Ws("datum",e,t);return n!==e&&!n.type&&(n.type="nominal"),n}}function xu(e,t){if(N(e)){const n=bu(e,t);if(n)return n;if(Mi(e))return{condition:e.condition}}else{if(Qn(e)){const n=bu(e.condition,t);if(n)return{...e,condition:n};{const{condition:i,...r}=e;return r}}return e}return}function Su(e,t){const n={};for(const i in e)if(on(e,i)){const r=e[i];if(v(r))n[i]=r.map(s=>xu(s,t)).filter(s=>s);else{const s=xu(r,t);s!==void 0&&(n[i]=s)}}return n}class ih{constructor(){this.name="RuleForRangedLine"}hasMatchingType(t){if(dt(t)){const{encoding:n,mark:i}=t;if(i==="line"||Ve(i)&&i.type==="line")for(const r of ud){const s=jt(r),o=n[s];if(n[r]&&(S(o)&&!te(o.bin)||Ye(o)))return!0}}return!1}run(t,n,i){const{encoding:r,mark:s}=t;return x(up(!!r.x2,!!r.y2)),i({...t,mark:M(s)?{...s,type:"rule"}:"rule"},n)}}class rh extends js{constructor(){super(...arguments);this.nonFacetUnitNormalizers=[lm,pm,Sm,new th,new ih]}map(t,n){if(dt(t)){const i=Yt(t.encoding,nt),r=Yt(t.encoding,it),s=Yt(t.encoding,bi);if(i||r||s)return this.mapFacetedUnit(t,n)}return super.map(t,n)}mapUnit(t,n){const{parentEncoding:i,parentProjection:r}=n,s=Bs(t.encoding,n.repeater),o={...t,...t.name?{name:[n.repeaterPrefix,t.name].filter(c=>c).join("_")}:{},...s?{encoding:s}:{}};if(i||r)return this.mapUnitWithParentEncodingOrProjection(o,n);const a=this.mapLayerOrUnit.bind(this);for(const c of this.nonFacetUnitNormalizers)if(c.hasMatchingType(o,n.config))return c.run(o,n,a);return o}mapRepeat(t,n){return Vm(t)?this.mapLayerRepeat(t,n):this.mapNonLayerRepeat(t,n)}mapLayerRepeat(t,n){const{repeat:i,spec:r,...s}=t,{row:o,column:a,layer:c}=i,{repeater:u={},repeaterPrefix:l=""}=n;return o||a?this.mapRepeat({...t,repeat:{...o?{row:o}:{},...a?{column:a}:{}},spec:{repeat:{layer:c},spec:r}},n):{...s,layer:c.map(f=>{const d={...u,layer:f},p=`${(r.name?`${r.name}_`:"")+l}child__layer_${W(f)}`,g=this.mapLayerOrUnit(r,{...n,repeater:d,repeaterPrefix:p});return g.name=p,g})}}mapNonLayerRepeat(t,n){const{repeat:i,spec:r,data:s,...o}=t;!v(i)&&t.columns&&(t=ue(t,["columns"]),x(za("repeat")));const a=[],{repeater:c={},repeaterPrefix:u=""}=n,l=!v(i)&&i.row||[c?c.row:null],f=!v(i)&&i.column||[c?c.column:null],d=v(i)&&i||[c?c.repeat:null];for(const g of d)for(const m of l)for(const h of f){const y={repeat:g,row:m,column:h,layer:c.layer},$=(r.name?`${r.name}_`:"")+u+"child__"+(v(i)?`${W(g)}`:(i.row?`row_${W(m)}`:"")+(i.column?`column_${W(h)}`:"")),C=this.map(r,{...n,repeater:y,repeaterPrefix:$});C.name=$,a.push(ue(C,["data"]))}const p=v(i)?t.columns:i.column?i.column.length:1;return{data:r.data??s,align:"all",...o,columns:p,concat:a}}mapFacet(t,n){const{facet:i}=t;return Kn(i)&&t.columns&&(t=ue(t,["columns"]),x(za("facet"))),super.mapFacet(t,n)}mapUnitWithParentEncodingOrProjection(t,n){const{encoding:i,projection:r}=t,{parentEncoding:s,parentProjection:o,config:a}=n,c=$u({parentProjection:o,projection:r}),u=wu({parentEncoding:s,encoding:Bs(i,n.repeater)});return this.mapUnit({...t,...c?{projection:c}:{},...u?{encoding:u}:{}},{config:a})}mapFacetedUnit(t,n){const{row:i,column:r,facet:s,...o}=t.encoding,{mark:a,width:c,projection:u,height:l,view:f,params:d,encoding:p,...g}=t,{facetMapping:m,layout:h}=this.getFacetMappingAndLayout({row:i,column:r,facet:s},n),y=Bs(o,n.repeater);return this.mapFacet({...g,...h,facet:m,spec:{...c?{width:c}:{},...l?{height:l}:{},...f?{view:f}:{},...u?{projection:u}:{},mark:a,encoding:y,...d?{params:d}:{}}},n)}getFacetMappingAndLayout(t,n){const{row:i,column:r,facet:s}=t;if(i||r){s&&x(ap([...i?[nt]:[],...r?[it]:[]]));const o={},a={};for(const c of[nt,it]){const u=t[c];if(u){const{align:l,center:f,spacing:d,columns:p,...g}=u;o[c]=g;for(const m of["align","center","spacing"])u[m]!==void 0&&(a[m]??(a[m]={}),a[m][c]=u[m])}}return{facetMapping:o,layout:a}}else{const{align:o,center:a,spacing:c,columns:u,...l}=s;return{facetMapping:nh(l,n.repeater),layout:{...o?{align:o}:{},...a?{center:a}:{},...c?{spacing:c}:{},...u?{columns:u}:{}}}}}mapLayer(t,{parentEncoding:n,parentProjection:i,...r}){const{encoding:s,projection:o,...a}=t,c={...r,parentEncoding:wu({parentEncoding:n,encoding:s,layer:!0}),parentProjection:$u({parentProjection:i,projection:o})};return super.mapLayer({...a,...t.name?{name:[c.repeaterPrefix,t.name].filter(u=>u).join("_")}:{}},c)}}function wu({parentEncoding:e,encoding:t={},layer:n}){let i={};if(e){const r=new Set([...b(e),...b(t)]);for(const s of r){const o=t[s],a=e[s];if(N(o)){const c={...a,...o};i[s]=c}else Qn(o)?i[s]={...o,condition:{...a,...o.condition}}:o||o===null?i[s]=o:(n||Pe(a)||E(a)||N(a)||v(a))&&(i[s]=a)}}else i=t;return!i||I(i)?void 0:i}function $u(e){const{parentProjection:t,projection:n}=e;return t&&n&&x(Xd({parentProjection:t,projection:n})),n??t}function Hs(e){return"filter"in e}function sh(e){return e?.stop!==void 0}function vu(e){return"lookup"in e}function oh(e){return"data"in e}function ah(e){return"param"in e}function ch(e){return"pivot"in e}function uh(e){return"density"in e}function lh(e){return"quantile"in e}function fh(e){return"regression"in e}function dh(e){return"loess"in e}function ph(e){return"sample"in e}function gh(e){return"window"in e}function mh(e){return"joinaggregate"in e}function hh(e){return"flatten"in e}function yh(e){return"calculate"in e}function Eu(e){return"bin"in e}function bh(e){return"impute"in e}function xh(e){return"timeUnit"in e}function Sh(e){return"aggregate"in e}function wh(e){return"stack"in e}function $h(e){return"fold"in e}function vh(e){return"extent"in e&&!("density"in e)}function Eh(e){return e.map(t=>Hs(t)?{filter:un(t.filter,tg)}:t)}class _h extends js{map(t,n){return n.emptySelections??(n.emptySelections={}),n.selectionPredicates??(n.selectionPredicates={}),t=_u(t,n),super.map(t,n)}mapLayerOrUnit(t,n){if(t=_u(t,n),t.encoding){const i={};for(const[r,s]of bt(t.encoding))i[r]=ku(s,n);t={...t,encoding:i}}return super.mapLayerOrUnit(t,n)}mapUnit(t,n){const{selection:i,...r}=t;return i?{...r,params:bt(i).map(([s,o])=>{const{init:a,bind:c,empty:u,...l}=o;l.type==="single"?(l.type="point",l.toggle=!1):l.type==="multi"&&(l.type="point"),n.emptySelections[s]=u!=="none";for(const f of ee(n.selectionPredicates[s]??{}))f.empty=u!=="none";return{name:s,value:a,select:l,bind:c}})}:t}}function _u(e,t){const{transform:n,...i}=e;if(n){const r=n.map(s=>{if(Hs(s))return{filter:qs(s,t)};if(Eu(s)&&Ut(s.bin))return{...s,bin:Cu(s.bin)};if(vu(s)){const{selection:o,...a}=s.from;return o?{...s,from:{param:o,...a}}:s}return s});return{...i,transform:r}}return e}function ku(e,t){const n=k(e);if(S(n)&&Ut(n.bin)&&(n.bin=Cu(n.bin)),Xt(n)&&n.scale?.domain?.selection){const{selection:i,...r}=n.scale.domain;n.scale.domain={...r,...i?{param:i}:{}}}if(Mi(n))if(Xo(n.condition))n.condition=n.condition.map(i=>{const{selection:r,param:s,test:o,...a}=i;return s?i:{...a,test:qs(i,t)}});else{const{selection:i,param:r,test:s,...o}=ku(n.condition,t);n.condition=r?n.condition:{...o,test:qs(n.condition,t)}}return n}function Cu(e){const t=e.extent;if(t?.selection){const{selection:n,...i}=t;return{...e,extent:{...i,param:n}}}return e}function qs(e,t){const n=i=>un(i,r=>{var s;const o=t.emptySelections[r]??!0,a={param:r,empty:o};return(s=t.selectionPredicates)[r]??(s[r]=[]),t.selectionPredicates[r].push(a),a});return e.selection?n(e.selection):un(e.test||e.filter,i=>i.selection?n(i.selection):i)}class Gs extends js{map(t,n){const i=n.selections??[];if(t.params&&!dt(t)){const r=[];for(const s of t.params)Is(s)?i.push(s):r.push(s);t.params=r}return n.selections=i,super.map(t,n)}mapUnit(t,n){const i=n.selections;if(!i||!i.length)return t;const r=(n.path??[]).concat(t.name),s=[];for(const o of i)if(!o.views||!o.views.length)s.push(o);else for(const a of o.views)(gi(a)&&(a===t.name||r.includes(a))||Xo(a)&&a.map(c=>r.indexOf(c)).every((c,u,l)=>c!==-1&&(u===0||c>l[u-1])))&&s.push(o);return s.length&&(t.params=s),t}}for(const e of["mapFacet","mapRepeat","mapHConcat","mapVConcat","mapLayer"]){const t=Gs.prototype[e];Gs.prototype[e]=function(n,i){return t.call(this,n,kh(n,i))}}function kh(e,t){return e.name?{...t,path:(t.path??[]).concat(e.name)}:t}function Nu(e,t){t===void 0&&(t=pu(e.config));const n=Th(e,t),{width:i,height:r}=e,s=Ah(n,{width:i,height:r,autosize:e.autosize},t);return{...n,...s?{autosize:s}:{}}}const Ch=new rh,Nh=new _h,Fh=new Gs;function Th(e,t={}){const n={config:t};return Fh.map(Ch.map(Nh.map(e,n),n),n)}function Fu(e){return F(e)?{type:e}:e??{}}function Ah(e,t,n){let{width:i,height:r}=t;const s=dt(e)||Ji(e),o={};s?i=="container"&&r=="container"?(o.type="fit",o.contains="padding"):i=="container"?(o.type="fit-x",o.contains="padding"):r=="container"&&(o.type="fit-y",o.contains="padding"):(i=="container"&&(x(Fa("width")),i=void 0),r=="container"&&(x(Fa("height")),r=void 0));const a={type:"pad",...o,...n?Fu(n.autosize):{},...Fu(e.autosize)};return a.type==="fit"&&!s&&(x(Od),a.type="pad"),i=="container"&&!(a.type=="fit"||a.type=="fit-x")&&x(Ta("width")),r=="container"&&!(a.type=="fit"||a.type=="fit-y")&&x(Ta("height")),De(a,{type:"pad"})?void 0:a}function Oh(e){return e==="fit"||e==="fit-x"||e==="fit-y"}function Ph(e){return e?`fit-${vi(e)}`:"fit"}const zh=["background","padding"];function Tu(e,t){const n={};for(const i of zh)e&&e[i]!==void 0&&(n[i]=ye(e[i]));return t&&(n.params=e.params),n}class gt{constructor(t={},n={}){this.explicit=t,this.implicit=n}clone(){return new gt(k(this.explicit),k(this.implicit))}combine(){return{...this.explicit,...this.implicit}}get(t){return V(this.explicit[t],this.implicit[t])}getWithExplicit(t){return this.explicit[t]!==void 0?{explicit:!0,value:this.explicit[t]}:this.implicit[t]!==void 0?{explicit:!1,value:this.implicit[t]}:{explicit:!1,value:void 0}}setWithExplicit(t,{value:n,explicit:i}){n!==void 0&&this.set(t,n,i)}set(t,n,i){return delete this[i?"implicit":"explicit"][t],this[i?"explicit":"implicit"][t]=n,this}copyKeyFromSplit(t,{explicit:n,implicit:i}){n[t]!==void 0?this.set(t,n[t],!0):i[t]!==void 0&&this.set(t,i[t],!1)}copyKeyFromObject(t,n){n[t]!==void 0&&this.set(t,n[t],!0)}copyAll(t){for(const n of b(t.combine())){const i=t.getWithExplicit(n);this.setWithExplicit(n,i)}}}function Ze(e){return{explicit:!0,value:e}}function xe(e){return{explicit:!1,value:e}}function Au(e){return(t,n,i,r)=>{const s=e(t.value,n.value);return s>0?t:s<0?n:er(t,n,i,r)}}function er(e,t,n,i){return e.explicit&&t.explicit&&x(xp(n,i,e.value,t.value)),e}function Tt(e,t,n,i,r=er){return e===void 0||e.value===void 0?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:De(e.value,t.value)?e:r(e,t,n,i)}class Rh extends gt{constructor(t={},n={},i=!1){super(t,n);this.explicit=t,this.implicit=n,this.parseNothing=i}clone(){const t=super.clone();return t.parseNothing=this.parseNothing,t}}function kn(e){return"url"in e}function ei(e){return"values"in e}function Ou(e){return"name"in e&&!kn(e)&&!ei(e)&&!At(e)}function At(e){return e&&(Pu(e)||zu(e)||Vs(e))}function Pu(e){return"sequence"in e}function zu(e){return"sphere"in e}function Vs(e){return"graticule"in e}var U;(function(e){e[e.Raw=0]="Raw",e[e.Main=1]="Main",e[e.Row=2]="Row",e[e.Column=3]="Column",e[e.Lookup=4]="Lookup"})(U||(U={}));function Ru(e){const{signals:t,hasLegend:n,index:i,...r}=e;return r.field=Se(r.field),r}function Kt(e,t=!0,n=_f){if(v(e)){const i=e.map(r=>Kt(r,t,n));return t?`[${i.join(", ")}]`:i}else if(Bt(e))return n(t?Wt(e):Hp(e));return t?n(D(e)):e}function Ih(e,t){for(const n of ee(e.component.selection??{})){const i=n.name;let r=`${i}${Pt}, ${n.resolve==="global"?"true":`{unit: ${Zt(e)}}`}`;for(const s of sr){if(!s.defined(n))continue;s.signals&&(t=s.signals(e,n,t)),s.modifyExpr&&(r=s.modifyExpr(e,n,r))}t.push({name:i+gy,on:[{events:{signal:n.name+Pt},update:`modify(${A(n.name+Qt)}, ${r})`}]})}return Xs(t)}function Lh(e,t){if(e.component.selection&&b(e.component.selection).length){const n=A(e.getName("cell"));t.unshift({name:"facet",value:{},on:[{events:cn("mousemove","scope"),update:`isTuple(facet) ? facet : group(${n}).datum`}]})}return Xs(t)}function Mh(e,t){let n=!1;for(const i of ee(e.component.selection??{})){const r=i.name,s=A(r+Qt),o=t.filter(a=>a.name===r);if(o.length===0){const a=i.resolve==="global"?"union":i.resolve,c=i.type==="point"?", true, true)":")";t.push({name:i.name,update:`${sl}(${s}, ${A(a)}${c}`})}n=!0;for(const a of sr)a.defined(i)&&a.topLevelSignals&&(t=a.topLevelSignals(e,i,t))}if(n){const i=t.filter(r=>r.name==="unit");i.length===0&&t.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})}return Xs(t)}function Dh(e,t){const n=[...t],i=Zt(e,{escape:!1});for(const r of ee(e.component.selection??{})){const s={name:r.name+Qt};if(r.project.hasSelectionId&&(s.transform=[{type:"collect",sort:{field:ze}}]),r.init){const a=r.project.items.map(Ru);s.values=r.project.hasSelectionId?r.init.map(c=>({unit:i,[ze]:Kt(c,!1)[0]})):r.init.map(c=>({unit:i,fields:a,values:Kt(c,!1)}))}const o=n.filter(a=>a.name===r.name+Qt);o.length||n.push(s)}return n}function Iu(e,t){for(const n of ee(e.component.selection??{}))for(const i of sr)i.defined(n)&&i.marks&&(t=i.marks(e,n,t));return t}function jh(e,t){for(const n of e.children)X(n)&&(t=Iu(n,t));return t}function Uh(e,t,n,i){const r=ll(e,t.param,t);return{signal:be(n.get("type"))&&v(i)&&i[0]>i[1]?`isValid(${r}) && reverse(${r})`:r}}function Xs(e){return e.map(t=>(t.on&&!t.on.length&&delete t.on,t))}class R{constructor(t,n){this.debugName=n,this._children=[],this._parent=null,t&&(this.parent=t)}clone(){throw new Error("Cannot clone node")}get parent(){return this._parent}set parent(t){this._parent=t,t&&t.addChild(this)}get children(){return this._children}numChildren(){return this._children.length}addChild(t,n){if(this._children.includes(t)){x(qd);return}n!==void 0?this._children.splice(n,0,t):this._children.push(t)}removeChild(t){const n=this._children.indexOf(t);return this._children.splice(n,1),n}remove(){let t=this._parent.removeChild(this);for(const n of this._children)n._parent=this._parent,this._parent.addChild(n,t++)}insertAsParentOf(t){const n=t.parent;n.removeChild(this),this.parent=n,t.parent=this}swapWithParent(){const t=this._parent,n=t.parent;for(const r of this._children)r.parent=t;this._children=[],t.removeChild(this);const i=t.parent.removeChild(t);this._parent=n,n.addChild(this,i),t.parent=this}}class ce extends R{clone(){const t=new this.constructor;return t.debugName=`clone_${this.debugName}`,t._source=this._source,t._name=`clone_${this._name}`,t.type=this.type,t.refCounts=this.refCounts,t.refCounts[t._name]=0,t}constructor(t,n,i,r){super(t,n);this.type=i,this.refCounts=r,this._source=this._name=n,this.refCounts&&!(this._name in this.refCounts)&&(this.refCounts[this._name]=0)}dependentFields(){return new Set}producedFields(){return new Set}hash(){return this._hash===void 0&&(this._hash=`Output ${ea()}`),this._hash}getSource(){return this.refCounts[this._name]++,this._source}isRequired(){return!!this.refCounts[this._name]}setSource(t){this._source=t}}class Je extends R{clone(){return new Je(null,k(this.formula))}constructor(t,n){super(t);this.formula=n}static makeFromEncoding(t,n){const i=n.reduceFieldDef((r,s)=>{const{field:o,timeUnit:a}=s;if(a){const c=w(s,{forAs:!0});r[O({as:c,field:o,timeUnit:a})]={as:c,field:o,timeUnit:a}}return r},{});return I(i)?null:new Je(t,i)}static makeFromTransform(t,n){const{timeUnit:i,...r}={...n},s=ne(i),o={...r,timeUnit:s};return new Je(t,{[O(o)]:o})}merge(t){this.formula={...this.formula};for(const n in t.formula)this.formula[n]||(this.formula[n]=t.formula[n]);for(const n of t.children)t.removeChild(n),n.parent=this;t.remove()}removeFormulas(t){const n={};for(const[i,r]of bt(this.formula))t.has(r.as)||(n[i]=r);this.formula=n}producedFields(){return new Set(ee(this.formula).map(t=>t.as))}dependentFields(){return new Set(ee(this.formula).map(t=>t.field))}hash(){return`TimeUnit ${O(this.formula)}`}assemble(){const t=[];for(const n of ee(this.formula)){const{field:i,as:r,timeUnit:s}=n,{unit:o,utc:a,...c}=ne(s);t.push({field:Se(i),type:"timeunit",...o?{units:Fi(o)}:{},...a?{timezone:"utc"}:{},...c,as:[r,`${r}_end`]})}return t}}const ti="_tuple_fields";class Bh{constructor(...t){this.items=t,this.hasChannel={},this.hasField={},this.hasSelectionId=!1}}const Wh={defined:()=>!0,parse:(e,t,n)=>{const i=t.name,r=t.project??(t.project=new Bh),s={},o={},a=new Set,c=(g,m)=>{const h=m==="visual"?g.channel:g.field;let y=W(`${i}_${h}`);for(let $=1;a.has(y);$++)y=W(`${i}_${h}_${$}`);return a.add(y),{[m]:y}},u=t.type,l=e.config.selection[u],f=n.value!==void 0?q(n.value):null;let{fields:d,encodings:p}=M(n.select)?n.select:{};if(!d&&!p&&f)for(const g of f){if(!M(g))continue;for(const m of b(g))cd(m)?(p||(p=[])).push(m):u==="interval"?(x(Ud),p=l.encodings):(d??(d=[])).push(m)}!d&&!p&&(p=l.encodings,"fields"in l&&(d=l.fields));for(const g of p??[]){const m=e.fieldDef(g);if(m){let h=m.field;if(m.aggregate){x(Pd(g,m.aggregate));continue}else if(!h){x(Oa(g));continue}if(m.timeUnit){h=e.vgField(g);const y={timeUnit:m.timeUnit,as:h,field:m.field};o[O(y)]=y}if(!s[h]){const y=u==="interval"&&ct(g)&&be(e.getScaleComponent(g).get("type"))?"R":m.bin?"R-RE":"E",$={field:h,channel:g,type:y,index:r.items.length};$.signals={...c($,"data"),...c($,"visual")},r.items.push(s[h]=$),r.hasField[h]=s[h],r.hasSelectionId=r.hasSelectionId||h===ze,oa(g)?($.geoChannel=g,$.channel=sa(g),r.hasChannel[$.channel]=s[h]):r.hasChannel[g]=s[h]}}else x(Oa(g))}for(const g of d??[]){if(r.hasField[g])continue;const m={type:"E",field:g,index:r.items.length};m.signals={...c(m,"data")},r.items.push(m),r.hasField[g]=m,r.hasSelectionId=r.hasSelectionId||g===ze}f&&(t.init=f.map(g=>r.items.map(m=>M(g)?g[m.geoChannel||m.channel]!==void 0?g[m.geoChannel||m.channel]:g[m.field]:g))),I(o)||(r.timeUnit=new Je(null,o))},signals:(e,t,n)=>{const i=t.name+ti,r=n.filter(s=>s.name===i);return r.length>0||t.project.hasSelectionId?n:n.concat({name:i,value:t.project.items.map(Ru)})}},mt={defined:e=>e.type==="interval"&&e.resolve==="global"&&e.bind&&e.bind==="scales",parse:(e,t)=>{const n=t.scales=[];for(const i of t.project.items){const r=i.channel;if(!ct(r))continue;const s=e.getScaleComponent(r),o=s?s.get("type"):void 0;if(!s||!be(o)){x(Id);continue}s.set("selectionExtent",{param:t.name,field:i.field},!0),n.push(i)}},topLevelSignals:(e,t,n)=>{const i=t.scales.filter(o=>n.filter(a=>a.name===o.signals.data).length===0);if(!e.parent||Ks(e)||i.length===0)return n;const r=n.filter(o=>o.name===t.name)[0];let s=r.update;if(s.indexOf(sl)>=0)r.update=`{${i.map(o=>`${A(Se(o.field))}: ${o.signals.data}`).join(", ")}}`;else{for(const o of i){const a=`${A(Se(o.field))}: ${o.signals.data}`;s.includes(a)||(s=`${s.substring(0,s.length-1)}, ${a}}`)}r.update=s}return n.concat(i.map(o=>({name:o.signals.data})))},signals:(e,t,n)=>{if(e.parent&&!Ks(e))for(const i of t.scales){const r=n.filter(s=>s.name===i.signals.data)[0];r.push="outer",delete r.value,delete r.update}return n}};function Ys(e,t){const n=A(e.scaleName(t));return`domain(${n})`}function Ks(e){return e.parent&&In(e.parent)&&(!e.parent.parent??Ks(e.parent.parent))}const Cn="_brush",Lu="_scale_trigger",ni="geo_interval_init_tick",Mu="_init",Hh="_center",qh={defined:e=>e.type==="interval",parse:(e,t,n)=>{var i;if(e.hasProjection){const r={...kr(n.select)?n.select:{}};r.fields=[ze],r.encodings||(r.encodings=n.value?b(n.value):[Ne,Ce]),n.select={type:"interval",...r}}if(t.translate&&!mt.defined(t)){const r=`!event.item || event.item.mark.name !== ${A(t.name+Cn)}`;for(const s of t.events){if(!s.between){x(`${s} is not an ordered event stream for interval selections.`);continue}const o=q((i=s.between[0]).filter??(i.filter=[]));o.indexOf(r)<0&&o.push(r)}}},signals:(e,t,n)=>{const i=t.name,r=i+Pt,s=ee(t.project.hasChannel).filter(a=>a.channel===H||a.channel===K),o=t.init?t.init[0]:null;if(n.push(...s.reduce((a,c)=>a.concat(Gh(e,t,c,o&&o[c.index])),[])),e.hasProjection){const a=A(e.projectionName()),c=e.projectionName()+Hh,{x:u,y:l}=t.project.hasChannel,f=u&&u.signals.visual,d=l&&l.signals.visual,p=u?o&&o[u.index]:`${c}[0]`,g=l?o&&o[l.index]:`${c}[1]`,m=T=>e.getSizeSignalRef(T).signal,h=`[[${f?f+"[0]":"0"}, ${d?d+"[0]":"0"}],[${f?f+"[1]":m("width")}, ${d?d+"[1]":m("height")}]]`;if(o&&(n.unshift({name:i+Mu,init:`[scale(${a}, [${u?p[0]:p}, ${l?g[0]:g}]), scale(${a}, [${u?p[1]:p}, ${l?g[1]:g}])]`}),!u||!l)){const T=n.find(L=>L.name===c);T||n.unshift({name:c,update:`invert(${a}, [${m("width")}/2, ${m("height")}/2])`})}const y=`intersect(${h}, {markname: ${A(e.getName("marks"))}}, unit.mark)`,$=`{unit: ${Zt(e)}}`,C=`vlSelectionTuples(${y}, ${$})`,_=s.map(T=>T.signals.visual);return n.concat({name:r,on:[{events:[..._.length?[{signal:_.join(" || ")}]:[],...o?[{signal:ni}]:[]],update:C}]})}else{if(!mt.defined(t)){const u=i+Lu,l=s.map(f=>{const d=f.channel,{data:p,visual:g}=f.signals,m=A(e.scaleName(d)),h=e.getScaleComponent(d).get("type"),y=be(h)?"+":"";return`(!isArray(${p}) || (${y}invert(${m}, ${g})[0] === ${y}${p}[0] && ${y}invert(${m}, ${g})[1] === ${y}${p}[1]))`});l.length&&n.push({name:u,value:{},on:[{events:s.map(f=>({scale:e.scaleName(f.channel)})),update:l.join(" && ")+` ? ${u} : {}`}]})}const a=s.map(u=>u.signals.data),c=`unit: ${Zt(e)}, fields: ${i+ti}, values`;return n.concat({name:r,...o?{init:`{${c}: ${Kt(o)}}`}:{},...a.length?{on:[{events:[{signal:a.join(" || ")}],update:`${a.join(" && ")} ? {${c}: [${a}]} : null`}]}:{}})}},topLevelSignals:(e,t,n)=>{if(X(e)&&e.hasProjection&&t.init){const i=n.filter(r=>r.name===ni);i.length||n.unshift({name:ni,value:null,on:[{events:"timer{1}",update:`${ni} === null ? {} : ${ni}`}]})}return n},marks:(e,t,n)=>{const i=t.name,{x:r,y:s}=t.project.hasChannel,o=r?.signals.visual,a=s?.signals.visual,c=`data(${A(t.name+Qt)})`;if(mt.defined(t)||!r&&!s)return n;const u={x:r!==void 0?{signal:`${o}[0]`}:{value:0},y:s!==void 0?{signal:`${a}[0]`}:{value:0},x2:r!==void 0?{signal:`${o}[1]`}:{field:{group:"width"}},y2:s!==void 0?{signal:`${a}[1]`}:{field:{group:"height"}}};if(t.resolve==="global")for(const m of b(u))u[m]=[{test:`${c}.length && ${c}[0].unit === ${Zt(e)}`,...u[m]},{value:0}];const{fill:l,fillOpacity:f,cursor:d,...p}=t.mark,g=b(p).reduce((m,h)=>(m[h]=[{test:[r!==void 0&&`${o}[0] !== ${o}[1]`,s!==void 0&&`${a}[0] !== ${a}[1]`].filter(y=>y).join(" && "),value:p[h]},{value:null}],m),{});return[{name:`${i+Cn}_bg`,type:"rect",clip:!0,encode:{enter:{fill:{value:l},fillOpacity:{value:f}},update:u}},...n,{name:i+Cn,type:"rect",clip:!0,encode:{enter:{...d?{cursor:{value:d}}:{},fill:{value:"transparent"}},update:{...u,...g}}}]}};function Gh(e,t,n,i){const r=!e.hasProjection,s=n.channel,o=n.signals.visual,a=A(r?e.scaleName(s):e.projectionName()),c=d=>`scale(${a}, ${d})`,u=e.getSizeSignalRef(s===H?"width":"height").signal,l=`${s}(unit)`,f=t.events.reduce((d,p)=>[...d,{events:p.between[0],update:`[${l}, ${l}]`},{events:p,update:`[${o}[0], clamp(${l}, 0, ${u})]`}],[]);if(r){const d=n.signals.data,p=mt.defined(t),g=e.getScaleComponent(s),m=g?g.get("type"):void 0,h=i?{init:Kt(i,!0,c)}:{value:[]};return f.push({events:{signal:t.name+Lu},update:be(m)?`[${c(`${d}[0]`)}, ${c(`${d}[1]`)}]`:"[0, 0]"}),p?[{name:d,on:[]}]:[{name:o,...h,on:f},{name:d,...i?{init:Kt(i)}:{},on:[{events:{signal:o},update:`${o}[0] === ${o}[1] ? null : invert(${a}, ${o})`}]}]}else{const d=s===H?0:1,p=t.name+Mu,g=i?{init:`[${p}[0][${d}], ${p}[1][${d}]]`}:{value:[]};return[{name:o,...g,on:f}]}}const Vh={defined:e=>e.type==="point",signals:(e,t,n)=>{const i=t.name,r=i+ti,s=t.project,o="(item().isVoronoi ? datum.datum : datum)",a=ee(e.component.selection??{}).reduce((f,d)=>d.type==="interval"?f.concat(d.name+Cn):f,[]).map(f=>`indexof(item().mark.name, '${f}') < 0`).join(" && "),c=`datum && item().mark.marktype !== 'group' && indexof(item().mark.role, 'legend') < 0${a?` && ${a}`:""}`;let u=`unit: ${Zt(e)}, `;if(t.project.hasSelectionId)u+=`${ze}: ${o}[${A(ze)}]`;else{const f=s.items.map(d=>{const p=e.fieldDef(d.channel);return p?.bin?`[${o}[${A(e.vgField(d.channel,{}))}], ${o}[${A(e.vgField(d.channel,{binSuffix:"end"}))}]]`:`${o}[${A(d.field)}]`}).join(", ");u+=`fields: ${r}, values: [${f}]`}const l=t.events;return n.concat([{name:i+Pt,on:l?[{events:l,update:`${c} ? {${u}} : null`,force:!0}]:[]}])}};function Nn(e,t,n,i){const r=Mi(t)&&t.condition,s=i(t);if(r){const o=q(r),a=o.map(c=>{const u=i(c);if(Ug(c)){const{param:l,empty:f}=c,d=ul(e,{param:l,empty:f});return{test:d,...u}}else{const l=or(e,c.test);return{test:l,...u}}});return{[n]:[...a,...s!==void 0?[s]:[]]}}else return s!==void 0?{[n]:s}:{}}function Qs(e,t="text"){const n=e.encoding[t];return Nn(e,n,t,i=>tr(i,e.config))}function tr(e,t,n="datum"){if(e){if(Pe(e))return B(e.value);if(N(e)){const{format:i,formatType:r}=Bi(e);return bs({fieldOrDatumDef:e,format:i,formatType:r,expr:n,config:t})}}return}function Du(e,t={}){const{encoding:n,markDef:i,config:r,stack:s}=e,o=n.tooltip;if(v(o))return{tooltip:Uu({tooltip:o},s,r,t)};{const a=t.reactiveGeom?"datum.datum":"datum";return Nn(e,o,"tooltip",c=>{const u=tr(c,r,a);if(u)return u;if(c===null)return;let l=z("tooltip",i,r);return l===!0&&(l={content:"encoding"}),F(l)?{value:l}:M(l)?E(l)?l:l.content==="encoding"?Uu(n,s,r,t):{signal:a}:void 0})}}function ju(e,t,n,{reactiveGeom:i}={}){const r={...n,...n.tooltipFormat},s={},o=i?"datum.datum":"datum",a=[];function c(l,f){const d=jt(f),p=ae(l)?l:{...l,type:e[d].type},g=p.title||vs(p,r),m=q(g).join(", ");let h;if(Q(f)){const y=f==="x"?"x2":"y2",$=Ke(e[y]);if(te(p.bin)&&$){const C=w(p,{expr:o}),_=w($,{expr:o}),{format:T,formatType:L}=Bi(p);h=Yn(C,_,T,L,r),s[y]=!0}}if((Q(f)||f===we||f===ke)&&t&&t.fieldChannel===f&&t.offset==="normalize"){const{format:y,formatType:$}=Bi(p);h=bs({fieldOrDatumDef:p,format:y,formatType:$,expr:o,config:r,normalizeStack:!0}).signal}h??(h=tr(p,r,o).signal),a.push({channel:f,key:m,value:h})}Cs(e,(l,f)=>{S(l)?c(l,f):Di(l)&&c(l.condition,f)});const u={};for(const{channel:l,key:f,value:d}of a)!s[l]&&!u[f]&&(u[f]=d);return u}function Uu(e,t,n,{reactiveGeom:i}={}){const r=ju(e,t,n,{reactiveGeom:i}),s=bt(r).map(([o,a])=>`"${o}": ${a}`);return s.length>0?{signal:`{${s.join(", ")}}`}:void 0}function Xh(e){const{markDef:t,config:n}=e,i=z("aria",t,n);return i===!1?{}:{...i?{aria:i}:{},...Yh(e),...Kh(e)}}function Yh(e){const{mark:t,markDef:n,config:i}=e;if(i.aria===!1)return{};const r=z("ariaRoleDescription",n,i);return r!=null?{ariaRoleDescription:{value:r}}:t in Fd?{}:{ariaRoleDescription:{value:t}}}function Kh(e){const{encoding:t,markDef:n,config:i,stack:r}=e,s=t.description;if(s)return Nn(e,s,"description",c=>tr(c,e.config));const o=z("description",n,i);if(o!=null)return{description:B(o)};if(i.aria===!1)return{};const a=ju(t,r,i);return I(a)?void 0:{description:{signal:bt(a).map(([c,u],l)=>`"${l>0?"; ":""}${c}: " + (${u})`).join(" + ")}}}function J(e,t,n={}){const{markDef:i,encoding:r,config:s}=t,{vgChannel:o}=n;let{defaultRef:a,defaultValue:c}=n;a===void 0&&(c??(c=z(e,i,s,{vgChannel:o,ignoreVgConfig:!0})),c!==void 0&&(a=B(c)));const u=r[e];return Nn(t,u,o??e,l=>ys({channel:e,channelDef:l,markDef:i,config:s,scaleName:t.scaleName(e),scale:t.getScaleComponent(e),stack:null,defaultRef:a}))}function Bu(e,t={filled:void 0}){const{markDef:n,encoding:i,config:r}=e,{type:s}=n,o=t.filled??z("filled",n,r),a=P(["bar","point","circle","square","geoshape"],s)?"transparent":void 0,c=z(o===!0?"color":void 0,n,r,{vgChannel:"fill"})??r.mark[o===!0&&"color"]??a,u=z(o===!1?"color":void 0,n,r,{vgChannel:"stroke"})??r.mark[o===!1&&"color"],l=o?"fill":"stroke",f={...c?{fill:B(c)}:{},...u?{stroke:B(u)}:{}};return n.color&&(o?n.fill:n.stroke)&&x(Ma("property",{fill:"fill"in n,stroke:"stroke"in n})),{...f,...J("color",e,{vgChannel:l,defaultValue:o?c:u}),...J("fill",e,{defaultValue:i.fill?c:void 0}),...J("stroke",e,{defaultValue:i.stroke?u:void 0})}}function Qh(e){const{encoding:t,mark:n}=e,i=t.order;return!Nt(n)&&Pe(i)?Nn(e,i,"zindex",r=>B(r.value)):{}}function Fn({channel:e,markDef:t,encoding:n={},model:i,bandPosition:r}){const s=`${e}Offset`,o=t[s],a=n[s];if((s==="xOffset"||s==="yOffset")&&a){const u=ys({channel:s,channelDef:a,markDef:t,config:i?.config,scaleName:i.scaleName(s),scale:i.getScaleComponent(s),stack:null,defaultRef:B(o),bandPosition:r});return{offsetType:"encoding",offset:u}}const c=t[s];return c?{offsetType:"visual",offset:c}:{}}function re(e,t,{defaultPos:n,vgChannel:i}){const{encoding:r,markDef:s,config:o,stack:a}=t,c=r[e],u=r[He(e)],l=t.scaleName(e),f=t.getScaleComponent(e),{offset:d,offsetType:p}=Fn({channel:e,markDef:s,encoding:r,model:t,bandPosition:.5}),g=Zs({model:t,defaultPos:n,channel:e,scaleName:l,scale:f}),m=!c&&Q(e)&&(r.latitude||r.longitude)?{field:t.getName(e)}:Zh({channel:e,channelDef:c,channel2Def:u,markDef:s,config:o,scaleName:l,scale:f,stack:a,offset:d,defaultRef:g,bandPosition:p==="encoding"?0:void 0});return m?{[i||e]:m}:void 0}function Zh(e){const{channel:t,channelDef:n,scaleName:i,stack:r,offset:s,markDef:o}=e;if(N(n)&&r&&t===r.fieldChannel){if(S(n)){let a=n.bandPosition;if(a===void 0&&o.type==="text"&&(t==="radius"||t==="theta")&&(a=.5),a!==void 0)return Ri({scaleName:i,fieldOrDatumDef:n,startSuffix:"start",bandPosition:a,offset:s})}return Gt(n,i,{suffix:"end"},{offset:s})}return ms(e)}function Zs({model:e,defaultPos:t,channel:n,scaleName:i,scale:r}){const{markDef:s,config:o}=e;return()=>{const a=jt(n),c=Et(n),u=z(n,s,o,{vgChannel:c});if(u!==void 0)return Xn(n,u);switch(t){case"zeroOrMin":case"zeroOrMax":if(i){const l=r.get("type");if(!P([ge.LOG,ge.TIME,ge.UTC],l)){if(r.domainDefinitelyIncludesZero())return{scale:i,value:0}}}if(t==="zeroOrMin")return a==="y"?{field:{group:"height"}}:{value:0};switch(a){case"radius":return{signal:`min(${e.width.signal},${e.height.signal})/2`};case"theta":return{signal:"2*PI"};case"x":return{field:{group:"width"}};case"y":return{value:0}}break;case"mid":{const l=e[de(n)];return{...l,mult:.5}}}return}}const Jh={left:"x",center:"xc",right:"x2"},ey={top:"y",middle:"yc",bottom:"y2"};function Wu(e,t,n,i="middle"){if(e==="radius"||e==="theta")return Et(e);const r=e==="x"?"align":"baseline",s=z(r,t,n);let o;return E(s)?(x(cp(r)),o=void 0):o=s,e==="x"?Jh[o||(i==="top"?"left":"center")]:ey[o||i]}function nr(e,t,{defaultPos:n,defaultPos2:i,range:r}){return r?Hu(e,t,{defaultPos:n,defaultPos2:i}):re(e,t,{defaultPos:n})}function Hu(e,t,{defaultPos:n,defaultPos2:i}){const{markDef:r,config:s}=t,o=He(e),a=de(e),c=ty(t,i,o),u=c[a]?Wu(e,r,s):Et(e);return{...re(e,t,{defaultPos:n,vgChannel:u}),...c}}function ty(e,t,n){const{encoding:i,mark:r,markDef:s,stack:o,config:a}=e,c=jt(n),u=de(n),l=Et(n),f=i[c],d=e.scaleName(c),p=e.getScaleComponent(c),{offset:g}=n in i||n in s?Fn({channel:n,markDef:s,encoding:i,model:e}):Fn({channel:c,markDef:s,encoding:i,model:e});if(!f&&(n==="x2"||n==="y2")&&(i.latitude||i.longitude)){const h=de(n),y=e.markDef[h];return y!=null?{[h]:{value:y}}:{[l]:{field:e.getName(n)}}}const m=ny({channel:n,channelDef:f,channel2Def:i[n],markDef:s,config:a,scaleName:d,scale:p,stack:o,offset:g,defaultRef:void 0});return m!==void 0?{[l]:m}:ir(n,s)||ir(n,{[n]:ki(n,s,a.style),[u]:ki(u,s,a.style)})||ir(n,a[r])||ir(n,a.mark)||{[l]:Zs({model:e,defaultPos:t,channel:n,scaleName:d,scale:p})()}}function ny({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:u}){return N(t)&&a&&e.charAt(0)===a.fieldChannel.charAt(0)?Gt(t,s,{suffix:"start"},{offset:c}):ms({channel:e,channelDef:n,scaleName:s,scale:o,stack:a,markDef:i,config:r,offset:c,defaultRef:u})}function ir(e,t){const n=de(e),i=Et(e);if(t[i]!==void 0)return{[i]:Xn(e,t[i])};if(t[e]!==void 0)return{[i]:Xn(e,t[e])};if(t[n]){const r=t[n];if(qt(r))x(tp(n));else return{[n]:Xn(e,r)}}return}function Ot(e,t){const{config:n,encoding:i,markDef:r}=e,s=r.type,o=He(t),a=de(t),c=i[t],u=i[o],l=e.getScaleComponent(t),f=l?l.get("type"):void 0,d=r.orient,p=i[a]??i.size??z("size",r,n,{vgChannel:a}),g=la(t),m=s==="bar"&&(t==="x"?d==="vertical":d==="horizontal");return S(c)&&(j(c.bin)||te(c.bin)||c.timeUnit&&!u)&&!(p&&!qt(p))&&!i[g]&&!Z(f)?sy({fieldDef:c,fieldDef2:u,channel:t,model:e}):(N(c)&&Z(f)||m)&&!u?ry(c,t,e):Hu(t,e,{defaultPos:"zeroOrMax",defaultPos2:"zeroOrMin"})}function iy(e,t,n,i,r,s,o){if(qt(r))if(n){const c=n.get("type");if(c==="band"){let u=`bandwidth('${t}')`;r.band!==1&&(u=`${r.band} * ${u}`);const l=ft("minBandSize",{type:o},i);return{signal:l?`max(${Te(l)}, ${u})`:u}}else r.band!==1&&(x(dp(c)),r=void 0)}else return{mult:r.band,field:{group:e}};else{if(E(r))return r;if(r)return{value:r}}if(n){const c=n.get("range");if(Ct(c)&&G(c.step))return{value:c.step-2}}if(!s){const{bandPaddingInner:c,barBandPaddingInner:u,rectBandPaddingInner:l}=i.scale,f=V(c,o==="bar"?u:l);if(E(f))return{signal:`(1 - (${f.signal})) * ${e}`};if(G(f))return{signal:`${1-f} * ${e}`}}const a=Qi(i.view,e);return{value:a-2}}function ry(e,t,n){const{markDef:i,encoding:r,config:s,stack:o}=n,a=i.orient,c=n.scaleName(t),u=n.getScaleComponent(t),l=de(t),f=He(t),d=la(t),p=n.scaleName(d),g=n.getScaleComponent(jr(t)),m=a==="horizontal"&&t==="y"||a==="vertical"&&t==="x";let h;(r.size||i.size)&&(m?h=J("size",n,{vgChannel:l,defaultRef:B(i.size)}):x(hp(i.type)));const y=!!h,$=_c({channel:t,fieldDef:e,markDef:i,config:s,scaleType:u?.get("type"),useVlSizeChannel:m});h=h||{[l]:iy(l,p||c,g||u,s,$,!!e,i.type)};const C=u?.get("type")==="band"&&qt($)&&!y?"top":"middle",_=Wu(t,i,s,C),T=_==="xc"||_==="yc",{offset:L,offsetType:he}=Fn({channel:t,markDef:i,encoding:r,model:n,bandPosition:T?.5:0}),ie=ms({channel:t,channelDef:e,markDef:i,config:s,scaleName:c,scale:u,stack:o,offset:L,defaultRef:Zs({model:n,defaultPos:"mid",channel:t,scaleName:c,scale:u}),bandPosition:T?he==="encoding"?0:.5:E($)?{signal:`(1-${$})/2`}:qt($)?(1-$.band)/2:0});if(l)return{[_]:ie,...h};{const Me=Et(f),yt=h[l],tt=L?{...yt,offset:L}:yt;return{[_]:ie,[Me]:v(ie)?[ie[0],{...ie[1],offset:tt}]:{...ie,offset:tt}}}}function qu(e,t,n,i,r,s,o){if(ra(e))return 0;const a=e==="x"||e==="y2",c=a?-t/2:t/2;if(E(n)||E(r)||E(i)||s){const u=Te(n),l=Te(r),f=Te(i),d=Te(s),p=a?"":"-",g=s?`(${o} < ${d} ? ${p}0.5 * (${d} - (${o})) : ${c})`:c,m=f?`${f} + `:"",h=u?`(${u} ? -1 : 1) * `:"",y=l?`(${l} + ${g})`:g;return{signal:m+h+y}}else return r=r||0,i+(n?-r-c:+r+c)}function sy({fieldDef:e,fieldDef2:t,channel:n,model:i}){const{config:r,markDef:s,encoding:o}=i,a=i.getScaleComponent(n),c=i.scaleName(n),u=a?a.get("type"):void 0,l=a.get("reverse"),f=_c({channel:n,fieldDef:e,markDef:s,config:r,scaleType:u}),d=i.component.axes[n]?.[0],p=d?.get("translate")??.5,g=Q(n)?z("binSpacing",s,r)??0:0,m=He(n),h=Et(n),y=Et(m),$=ft("minBandSize",s,r),{offset:C}=Fn({channel:n,markDef:s,encoding:o,model:i,bandPosition:0}),{offset:_}=Fn({channel:m,markDef:s,encoding:o,model:i,bandPosition:0}),T=Ig({fieldDef:e,scaleName:c}),L=qu(n,g,l,p,C,$,T),he=qu(m,g,l,p,_??C,$,T),ie=E(f)?{signal:`(1-${f.signal})/2`}:qt(f)?(1-f.band)/2:.5;if(j(e.bin)||e.timeUnit)return{[y]:Gu({fieldDef:e,scaleName:c,bandPosition:ie,offset:he}),[h]:Gu({fieldDef:e,scaleName:c,bandPosition:E(ie)?{signal:`1-${ie.signal}`}:1-ie,offset:L})};if(te(e.bin)){const Me=Gt(e,c,{},{offset:he});if(S(t))return{[y]:Me,[h]:Gt(t,c,{},{offset:L})};if(Ut(e.bin)&&e.bin.step)return{[y]:Me,[h]:{signal:`scale("${c}", ${w(e,{expr:"datum"})} + ${e.bin.step})`,offset:L}}}x(Wa(m));return}function Gu({fieldDef:e,scaleName:t,bandPosition:n,offset:i}){return Ri({scaleName:t,fieldOrDatumDef:e,bandPosition:n,offset:i})}const oy=new Set(["aria","width","height"]);function Ee(e,t){const{fill:n=void 0,stroke:i=void 0}=t.color==="include"?Bu(e):{};return{...ay(e.markDef,t),...Vu(e,"fill",n),...Vu(e,"stroke",i),...J("opacity",e),...J("fillOpacity",e),...J("strokeOpacity",e),...J("strokeWidth",e),...J("strokeDash",e),...Qh(e),...Du(e),...Qs(e,"href"),...Xh(e)}}function Vu(e,t,n){const{config:i,mark:r,markDef:s}=e,o=z("invalid",s,i);if(o==="hide"&&n&&!Nt(r)){const a=cy(e,{invalid:!0,channels:Ei});if(a)return{[t]:[{test:a,value:null},...q(n)]}}return n?{[t]:n}:{}}function ay(e,t){return Nd.reduce((n,i)=>(!oy.has(i)&&e[i]!==void 0&&t[i]!=="ignore"&&(n[i]=B(e[i])),n),{})}function cy(e,{invalid:t=!1,channels:n}){const i=n.reduce((s,o)=>{const a=e.getScaleComponent(o);if(a){const c=a.get("type"),u=e.vgField(o,{expr:"datum"});u&&be(c)&&(s[u]=!0)}return s},{}),r=b(i);if(r.length>0){const s=t?"||":"&&";return r.map(o=>hs(o,t)).join(` ${s} `)}return}function Js(e){const{config:t,markDef:n}=e,i=z("invalid",n,t);if(i){const r=uy(e,{channels:qe});if(r)return{defined:{signal:r}}}return{}}function uy(e,{invalid:t=!1,channels:n}){const i=n.reduce((s,o)=>{const a=e.getScaleComponent(o);if(a){const c=a.get("type"),u=e.vgField(o,{expr:"datum",binSuffix:e.stack?.impute?"mid":void 0});u&&be(c)&&(s[u]=!0)}return s},{}),r=b(i);if(r.length>0){const s=t?"||":"&&";return r.map(o=>hs(o,t)).join(` ${s} `)}return}function Xu(e,t){return t!==void 0?{[e]:B(t)}:void 0}const eo="voronoi",Yu={defined:e=>e.type==="point"&&e.nearest,parse:(e,t)=>{if(t.events)for(const n of t.events)n.markname=e.getName(eo)},marks:(e,t,n)=>{const{x:i,y:r}=t.project.hasChannel,s=e.mark;if(Nt(s))return x(zd(s)),n;const o={name:e.getName(eo),type:"path",interactive:!0,from:{data:e.getName("marks")},encode:{update:{fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0},...Du(e,{reactiveGeom:!0})}},transform:[{type:"voronoi",x:{expr:i||!r?"datum.datum.x || 0":"0"},y:{expr:r||!i?"datum.datum.y || 0":"0"},size:[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]}]};let a=0,c=!1;return n.forEach((u,l)=>{const f=u.name??"";f===e.component.mark[0].name?a=l:f.indexOf(eo)>=0&&(c=!0)}),c||n.splice(a+1,0,o),n}},Ku={defined:e=>e.type==="point"&&e.resolve==="global"&&e.bind&&e.bind!=="scales"&&!zs(e.bind),parse:(e,t,n)=>ol(t,n),topLevelSignals:(e,t,n)=>{const i=t.name,r=t.project,s=t.bind,o=t.init&&t.init[0],a=Yu.defined(t)?"(item().isVoronoi ? datum.datum : datum)":"datum";return r.items.forEach((c,u)=>{const l=W(`${i}_${c.field}`),f=n.filter(d=>d.name===l);f.length||n.unshift({name:l,...o?{init:Kt(o[u])}:{value:null},on:t.events?[{events:t.events,update:`datum && item().mark.marktype !== 'group' ? ${a}[${A(c.field)}] : null`}]:[],bind:s[c.field]??s[c.channel]??s})}),n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.filter(u=>u.name===i+Pt)[0],o=i+ti,a=r.items.map(u=>W(`${i}_${u.field}`)),c=a.map(u=>`${u} !== null`).join(" && ");return a.length&&(s.update=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`),delete s.value,delete s.on,n}},rr="_toggle",Qu={defined:e=>e.type==="point"&&!!e.toggle,signals:(e,t,n)=>n.concat({name:t.name+rr,value:!1,on:[{events:t.events,update:t.toggle}]}),modifyExpr:(e,t)=>{const n=t.name+Pt,i=t.name+rr;return`${i} ? null : ${n}, `+(t.resolve==="global"?`${i} ? null : true, `:`${i} ? null : {unit: ${Zt(e)}}, `)+`${i} ? ${n} : null`}},ly={defined:e=>e.clear!==void 0&&e.clear!==!1,parse:(e,t)=>{t.clear&&(t.clear=F(t.clear)?cn(t.clear,"view"):t.clear)},topLevelSignals:(e,t,n)=>{if(Ku.defined(t))for(const i of t.project.items){const r=n.findIndex(s=>s.name===W(`${t.name}_${i.field}`));r!==-1&&n[r].on.push({events:t.clear,update:"null"})}return n},signals:(e,t,n)=>{function i(r,s){r!==-1&&n[r].on&&n[r].on.push({events:t.clear,update:s})}if(t.type==="interval")for(const r of t.project.items){const s=n.findIndex(o=>o.name===r.signals.visual);if(i(s,"[0, 0]"),s===-1){const o=n.findIndex(a=>a.name===r.signals.data);i(o,"null")}}else{let r=n.findIndex(s=>s.name===t.name+Pt);i(r,"null"),Qu.defined(t)&&(r=n.findIndex(s=>s.name===t.name+rr),i(r,"false"))}return n}},Zu={defined:e=>{const t=e.resolve==="global"&&e.bind&&zs(e.bind),n=e.project.items.length===1&&e.project.items[0].field!==ze;return t&&!n&&x(Ld),t&&n},parse:(e,t,n)=>{const i=k(n);if(i.select=F(i.select)?{type:i.select,toggle:t.toggle}:{...i.select,toggle:t.toggle},ol(t,i),kr(n.select)&&(n.select.on||n.select.clear)){const o='event.item && indexof(event.item.mark.role, "legend") < 0';for(const a of t.events)a.filter=q(a.filter??[]),a.filter.includes(o)||a.filter.push(o)}const r=Rs(t.bind)?t.bind.legend:"click",s=F(r)?cn(r,"view"):q(r);t.bind={legend:{merge:s}}},topLevelSignals:(e,t,n)=>{const i=t.name,r=Rs(t.bind)&&t.bind.legend,s=o=>a=>{const c=k(a);return c.markname=o,c};for(const o of t.project.items){if(!o.hasLegend)continue;const a=`${W(o.field)}_legend`,c=`${i}_${a}`,u=n.filter(l=>l.name===c);if(u.length===0){const l=r.merge.map(s(`${a}_symbols`)).concat(r.merge.map(s(`${a}_labels`))).concat(r.merge.map(s(`${a}_entries`)));n.unshift({name:c,...t.init?{}:{value:null},on:[{events:l,update:"isDefined(datum.value) ? datum.value : item().items[0].items[0].datum.value",force:!0},{events:r.merge,update:`!event.item || !datum ? null : ${c}`,force:!0}]})}}return n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.find(d=>d.name===i+Pt),o=i+ti,a=r.items.filter(d=>d.hasLegend).map(d=>W(`${i}_${W(d.field)}_legend`)),c=a.map(d=>`${d} !== null`).join(" && "),u=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`;t.events&&a.length>0?s.on.push({events:a.map(d=>({signal:d})),update:u}):a.length>0&&(s.update=u,delete s.value,delete s.on);const l=n.find(d=>d.name===i+rr),f=Rs(t.bind)&&t.bind.legend;return l&&(t.events?l.on.push({...l.on[0],events:f}):l.on[0].events=f),n}};function fy(e,t,n){const i=e.fieldDef(t)?.field;for(const r of ee(e.component.selection??{})){const s=r.project.hasField[i]??r.project.hasChannel[t];if(s&&Zu.defined(r)){const o=n.get("selections")??[];o.push(r.name),n.set("selections",o,!1),s.hasLegend=!0}}}const Ju="_translate_anchor",el="_translate_delta",dy={defined:e=>e.type==="interval"&&e.translate,signals:(e,t,n)=>{const i=t.name,r=mt.defined(t),s=i+Ju,{x:o,y:a}=t.project.hasChannel;let c=cn(t.translate,"scope");return r||(c=c.map(u=>(u.between[0].markname=i+Cn,u))),n.push({name:s,value:{},on:[{events:c.map(u=>u.between[0]),update:"{x: x(unit), y: y(unit)"+(o!==void 0?`, extent_x: ${r?Ys(e,H):`slice(${o.signals.visual})`}`:"")+(a!==void 0?`, extent_y: ${r?Ys(e,K):`slice(${a.signals.visual})`}`:"")+"}"}]},{name:i+el,value:{},on:[{events:c,update:`{x: ${s}.x - x(unit), y: ${s}.y - y(unit)}`}]}),o!==void 0&&tl(e,t,o,"width",n),a!==void 0&&tl(e,t,a,"height",n),n}};function tl(e,t,n,i,r){const s=t.name,o=s+Ju,a=s+el,c=n.channel,u=mt.defined(t),l=r.filter(T=>T.name===n.signals[u?"data":"visual"])[0],f=e.getSizeSignalRef(i).signal,d=e.getScaleComponent(c),p=d&&d.get("type"),g=d&&d.get("reverse"),m=u?c===H?g?"":"-":g?"-":"":"",h=`${o}.extent_${c}`,y=`${m}${a}.${c} / ${u?`${f}`:`span(${h})`}`,$=!u||!d?"panLinear":p==="log"?"panLog":p==="symlog"?"panSymlog":p==="pow"?"panPow":"panLinear",C=u?p==="pow"?`, ${d.get("exponent")??1}`:p==="symlog"?`, ${d.get("constant")??1}`:"":"",_=`${$}(${h}, ${y}${C})`;l.on.push({events:{signal:a},update:u?_:`clampRange(${_}, 0, ${f})`})}const nl="_zoom_anchor",il="_zoom_delta",py={defined:e=>e.type==="interval"&&e.zoom,signals:(e,t,n)=>{const i=t.name,r=mt.defined(t),s=i+il,{x:o,y:a}=t.project.hasChannel,c=A(e.scaleName(H)),u=A(e.scaleName(K));let l=cn(t.zoom,"scope");return r||(l=l.map(f=>(f.markname=i+Cn,f))),n.push({name:i+nl,on:[{events:l,update:r?"{"+[c?`x: invert(${c}, x(unit))`:"",u?`y: invert(${u}, y(unit))`:""].filter(f=>f).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:s,on:[{events:l,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),o!==void 0&&rl(e,t,o,"width",n),a!==void 0&&rl(e,t,a,"height",n),n}};function rl(e,t,n,i,r){const s=t.name,o=n.channel,a=mt.defined(t),c=r.filter($=>$.name===n.signals[a?"data":"visual"])[0],u=e.getSizeSignalRef(i).signal,l=e.getScaleComponent(o),f=l&&l.get("type"),d=a?Ys(e,o):c.name,p=s+il,g=`${s}${nl}.${o}`,m=!a||!l?"zoomLinear":f==="log"?"zoomLog":f==="symlog"?"zoomSymlog":f==="pow"?"zoomPow":"zoomLinear",h=a?f==="pow"?`, ${l.get("exponent")??1}`:f==="symlog"?`, ${l.get("constant")??1}`:"":"",y=`${m}(${d}, ${g}, ${p}${h})`;c.on.push({events:{signal:p},update:a?y:`clampRange(${y}, 0, ${u})`})}const Qt="_store",Pt="_tuple",gy="_modify",sl="vlSelectionResolve",sr=[Vh,qh,Wh,Qu,Ku,mt,Zu,ly,dy,py,Yu];function my(e){let t=e.parent;for(;t&&!Le(t);)t=t.parent;return t}function Zt(e,{escape:t}={escape:!0}){let n=t?A(e.name):e.name;const i=my(e);if(i){const{facet:r}=i;for(const s of ve)r[s]&&(n+=` + '__facet_${s}_' + (facet[${A(i.vgField(s))}])`)}return n}function to(e){return ee(e.component.selection??{}).reduce((t,n)=>t||n.project.hasSelectionId,!1)}function ol(e,t){(gi(t.select)||!t.select.on)&&delete e.events,(gi(t.select)||!t.select.clear)&&delete e.clear,(gi(t.select)||!t.select.toggle)&&delete e.toggle}function no(e){const t=[];return e.type==="Identifier"?[e.name]:e.type==="Literal"?[e.value]:(e.type==="MemberExpression"&&(t.push(...no(e.object)),t.push(...no(e.property))),t)}function al(e){return e.object.type==="MemberExpression"?al(e.object):e.object.name==="datum"}function cl(e){const t=Ff(e),n=new Set;return t.visit(i=>{i.type==="MemberExpression"&&al(i)&&n.add(no(i).slice(1).join("."))}),n}class Tn extends R{clone(){return new Tn(null,this.model,k(this.filter))}constructor(t,n,i){super(t);this.model=n,this.filter=i,this.expr=or(this.model,this.filter,this),this._dependentFields=cl(this.expr)}dependentFields(){return this._dependentFields}producedFields(){return new Set}assemble(){return{type:"filter",expr:this.expr}}hash(){return`Filter ${this.expr}`}}function hy(e,t){const n={},i=e.config.selection;if(!t||!t.length)return n;for(const r of t){const s=W(r.name),o=r.select,a=F(o)?o:o.type,c=M(o)?k(o):{type:a},u=i[a];for(const d in u){if(d==="fields"||d==="encodings")continue;d==="mark"&&(c[d]={...u[d],...c[d]}),(c[d]===void 0||c[d]===!0)&&(c[d]=k(u[d]??c[d]))}const l=n[s]={...c,name:s,type:a,init:r.value,bind:r.bind,events:F(c.on)?cn(c.on,"scope"):q(k(c.on))},f=k(r);for(const d of sr)d.defined(l)&&d.parse&&d.parse(e,l,f)}return n}function ul(e,t,n,i="datum"){const r=F(t)?t:t.param,s=W(r),o=A(s+Qt);let a;try{a=e.getSelectionComponent(s,r)}catch(d){return`!!${s}`}if(a.project.timeUnit){const d=n??e.component.data.raw,p=a.project.timeUnit.clone();d.parent?p.insertAsParentOf(d):d.parent=p}const c=a.project.hasSelectionId?"vlSelectionIdTest(":"vlSelectionTest(",u=a.resolve==="global"?")":`, ${A(a.resolve)})`,l=`${c}${o}, ${i}${u}`,f=`length(data(${o}))`;return t.empty===!1?`${f} && ${l}`:`!${f} || ${l}`}function ll(e,t,n){const i=W(t),r=n.encoding;let s=n.field,o;try{o=e.getSelectionComponent(i,t)}catch(a){return i}if(!r&&!s)s=o.project.items[0].field,o.project.items.length>1&&x(`A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": ${A(s)}.`);else if(r&&!s){const a=o.project.items.filter(c=>c.channel===r);!a.length||a.length>1?(s=o.project.items[0].field,x((a.length?"Multiple ":"No ")+`matching ${A(r)} encoding found for selection ${A(n.param)}. Using "field": ${A(s)}.`)):s=a[0].field}return`${o.name}[${A(Se(s))}]`}function yy(e,t){for(const[n,i]of bt(e.component.selection??{})){const r=e.getName(`lookup_${n}`);e.component.data.outputNodes[r]=i.materialized=new ce(new Tn(t,e,{param:n}),r,U.Lookup,e.component.data.outputNodeRefCounts)}}function or(e,t,n){return Un(t,i=>F(i)?i:Zp(i)?ul(e,i,n):Za(i))}function by(e,t){return e?v(e)&&!kt(e)?e.map(n=>vs(n,t)).join(", "):e:void 0}function io(e,t,n,i){var r,s;e.encode??(e.encode={}),(r=e.encode)[t]??(r[t]={}),(s=e.encode[t]).update??(s.update={}),e.encode[t].update[n]=i}function ii(e,t,n,i={header:!1}){const{disable:r,orient:s,scale:o,labelExpr:a,title:c,zindex:u,...l}=e.combine();if(r)return;for(const f in l){const d=tm[f],p=l[f];if(d&&d!==t&&d!=="both")delete l[f];else if(Jn(p)){const{condition:g,...m}=p,h=q(g),y=Ic[f];if(y){const{vgProp:$,part:C}=y,_=[...h.map(T=>{const{test:L,...he}=T;return{test:or(null,L),...he}}),m];io(l,C,$,_),delete l[f]}else if(y===null){const $={signal:h.map(C=>{const{test:_,...T}=C;return`${or(null,_)} ? ${$a(T)} : `}).join("")+$a(m)};l[f]=$}}else if(E(p)){const g=Ic[f];if(g){const{vgProp:m,part:h}=g;io(l,h,m,p),delete l[f]}}P(["labelAlign","labelBaseline"],f)&&l[f]===null&&delete l[f]}if(t==="grid"){if(!l.grid)return;if(l.encode){const{grid:f}=l.encode;l.encode={...f?{grid:f}:{}},I(l.encode)&&delete l.encode}return{scale:o,orient:s,...l,domain:!1,labels:!1,aria:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:V(u,0)}}else{if(!i.header&&e.mainExtracted)return;if(a!==void 0){let d=a;l.encode?.labels?.update&&E(l.encode.labels.update.text)&&(d=Lt(a,"datum.label",l.encode.labels.update.text.signal)),io(l,"labels","text",{signal:d})}if(l.labelAlign===null&&delete l.labelAlign,l.encode){for(const d of Lc)e.hasAxisPart(d)||delete l.encode[d];I(l.encode)&&delete l.encode}const f=by(c,n);return{scale:o,orient:s,grid:!1,...f?{title:f}:{},...l,...n.aria===!1?{aria:!1}:{},zindex:V(u,0)}}}function fl(e){const{axes:t}=e.component,n=[];for(const i of qe)if(t[i]){for(const r of t[i])if(!r.get("disable")&&!r.get("gridScale")){const s=i==="x"?"height":"width",o=e.getSizeSignalRef(s).signal;s!==o&&n.push({name:s,update:o})}}return n}function xy(e,t){const{x:n=[],y:i=[]}=e;return[...n.map(r=>ii(r,"grid",t)),...i.map(r=>ii(r,"grid",t)),...n.map(r=>ii(r,"main",t)),...i.map(r=>ii(r,"main",t))].filter(r=>r)}function dl(e,t,n,i){return Object.assign.apply(null,[{},...e.map(r=>{if(r==="axisOrient"){const s=n==="x"?"bottom":"left",o=t[n==="x"?"axisBottom":"axisLeft"]||{},a=t[n==="x"?"axisTop":"axisRight"]||{},c=new Set([...b(o),...b(a)]),u={};for(const l of c.values())u[l]={signal:`${i.signal} === "${s}" ? ${Te(o[l])} : ${Te(a[l])}`};return u}return t[r]})])}function Sy(e,t,n,i){const r=t==="band"?["axisDiscrete","axisBand"]:t==="point"?["axisDiscrete","axisPoint"]:ic(t)?["axisQuantitative"]:t==="time"||t==="utc"?["axisTemporal"]:[],s=e==="x"?"axisX":"axisY",o=E(n)?"axisOrient":`axis${Bn(n)}`,a=[...r,...r.map(u=>s+u.substr(4))],c=["axis",o,s];return{vlOnlyAxisConfig:dl(a,i,e,n),vgAxisConfig:dl(c,i,e,n),axisConfigStyle:wy([...c,...a],i)}}function wy(e,t){const n=[{}];for(const i of e){let r=t[i]?.style;if(r){r=q(r);for(const s of r)n.push(t.style[s])}}return Object.assign.apply(null,n)}function ro(e,t,n,i={}){const r=Ea(e,n,t);if(r!==void 0)return{configFrom:"style",configValue:r};for(const s of["vlOnlyAxisConfig","vgAxisConfig","axisConfigStyle"])if(i[s]?.[e]!==void 0)return{configFrom:s,configValue:i[s][e]};return{}}const pl={scale:({model:e,channel:t})=>e.scaleName(t),format:({format:e})=>e,formatType:({formatType:e})=>e,grid:({fieldOrDatumDef:e,axis:t,scaleType:n})=>t.grid??$y(n,e),gridScale:({model:e,channel:t})=>vy(e,t),labelAlign:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelAlign||ml(t,n,i),labelAngle:({labelAngle:e})=>e,labelBaseline:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelBaseline||gl(t,n,i),labelFlush:({axis:e,fieldOrDatumDef:t,channel:n})=>e.labelFlush??_y(t.type,n),labelOverlap:({axis:e,fieldOrDatumDef:t,scaleType:n})=>e.labelOverlap??ky(t.type,n,S(t)&&!!t.timeUnit,S(t)?t.sort:void 0),orient:({orient:e})=>e,tickCount:({channel:e,model:t,axis:n,fieldOrDatumDef:i,scaleType:r})=>{const s=e==="x"?"width":e==="y"?"height":void 0,o=s?t.getSizeSignalRef(s):void 0;return n.tickCount??Ny({fieldOrDatumDef:i,scaleType:r,size:o,values:n.values})},tickMinStep:Fy,title:({axis:e,model:t,channel:n})=>{if(e.title!==void 0)return e.title;const i=hl(t,n);if(i!==void 0)return i;const r=t.typedFieldDef(n),s=n==="x"?"x2":"y2",o=t.fieldDef(s);return ka(r?[vc(r)]:[],S(o)?[vc(o)]:[])},values:({axis:e,fieldOrDatumDef:t})=>Ty(e,t),zindex:({axis:e,fieldOrDatumDef:t,mark:n})=>e.zindex??Ay(n,t)};function $y(e,t){return!Z(e)&&S(t)&&!j(t?.bin)&&!te(t?.bin)}function vy(e,t){const n=t==="x"?"y":"x";return e.getScaleComponent(n)?e.scaleName(n):void 0}function Ey(e,t,n,i,r){const s=t?.labelAngle;if(s!==void 0)return E(s)?s:Wn(s);{const{configValue:o}=ro("labelAngle",i,t?.style,r);return o!==void 0?Wn(o):n===H&&P([us,cs],e.type)&&!(S(e)&&e.timeUnit)?270:void 0}}function so(e){return`(((${e.signal} % 360) + 360) % 360)`}function gl(e,t,n,i){if(e!==void 0)if(n==="x"){if(E(e)){const r=so(e),s=E(t)?`(${t.signal} === "top")`:t==="top";return{signal:`(45 < ${r} && ${r} < 135) || (225 < ${r} && ${r} < 315) ? "middle" :(${r} <= 45 || 315 <= ${r}) === ${s} ? "bottom" : "top"`}}if(45<e&&e<135||225<e&&e<315)return"middle";if(E(t)){const r=e<=45||315<=e?"===":"!==";return{signal:`${t.signal} ${r} "top" ? "bottom" : "top"`}}return(e<=45||315<=e)===(t==="top")?"bottom":"top"}else{if(E(e)){const r=so(e),s=E(t)?`(${t.signal} === "left")`:t==="left",o=i?'"middle"':"null";return{signal:`${r} <= 45 || 315 <= ${r} || (135 <= ${r} && ${r} <= 225) ? ${o} : (45 <= ${r} && ${r} <= 135) === ${s} ? "top" : "bottom"`}}if(e<=45||315<=e||135<=e&&e<=225)return i?"middle":null;if(E(t)){const r=45<=e&&e<=135?"===":"!==";return{signal:`${t.signal} ${r} "left" ? "top" : "bottom"`}}return(45<=e&&e<=135)===(t==="left")?"top":"bottom"}return}function ml(e,t,n){if(e===void 0)return;const i=n==="x",r=i?0:90,s=i?"bottom":"left";if(E(e)){const o=so(e),a=E(t)?`(${t.signal} === "${s}")`:t===s;return{signal:`(${r?`(${o} + 90)`:o} % 180 === 0) ? ${i?null:'"center"'} :(${r} < ${o} && ${o} < ${180+r}) === ${a} ? "left" : "right"`}}if((e+r)%180===0)return i?null:"center";if(E(t)){const o=r<e&&e<180+r?"===":"!==",a=`${t.signal} ${o} "${s}"`;return{signal:`${a} ? "left" : "right"`}}return(r<e&&e<180+r)===(t===s)?"left":"right"}function _y(e,t){return t==="x"&&P(["quantitative","temporal"],e)?!0:void 0}function ky(e,t,n,i){return n&&!M(i)||e!=="nominal"&&e!=="ordinal"?t==="log"||t==="symlog"?"greedy":!0:void 0}function Cy(e){return e==="x"?"bottom":"left"}function Ny({fieldOrDatumDef:e,scaleType:t,size:n,values:i}){if(!i&&!Z(t)&&t!=="log"){if(S(e)){if(j(e.bin))return{signal:`ceil(${n.signal}/10)`};if(e.timeUnit&&P(["month","hours","day","quarter"],ne(e.timeUnit)?.unit))return}return{signal:`ceil(${n.signal}/40)`}}return}function Fy({format:e,fieldOrDatumDef:t}){if(e==="d")return 1;if(S(t)){const{timeUnit:n}=t;if(n){const i=Ka(n);if(i)return{signal:i}}}return}function hl(e,t){const n=t==="x"?"x2":"y2",i=e.fieldDef(t),r=e.fieldDef(n),s=i?i.title:void 0,o=r?r.title:void 0;return s&&o?Ca(s,o):s||(o||(s!==void 0?s:o!==void 0?o:void 0))}function Ty(e,t){const n=e.values;return v(n)?Rc(t,n):E(n)?n:void 0}function Ay(e,t){return e==="rect"&&Ui(t)?1:0}class An extends R{clone(){return new An(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this._dependentFields=cl(this.transform.calculate)}static parseAllForSortIndex(t,n){return n.forEachFieldDef((i,r)=>{if(!Xt(i))return;if($c(i.sort)){const{field:s,timeUnit:o}=i,a=i.sort,c=a.map((u,l)=>`${Za({field:s,timeUnit:o,equal:u})} ? ${l} : `).join("")+a.length;t=new An(t,{calculate:c,as:On(i,r,{forAs:!0})})}}),t}producedFields(){return new Set([this.transform.as])}dependentFields(){return this._dependentFields}assemble(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}}hash(){return`Calculate ${O(this.transform)}`}}function On(e,t,n){return w(e,{prefix:t,suffix:"sort_index",...n??{}})}function ar(e,t){return P(["top","bottom"],t)?"column":P(["left","right"],t)||e==="row"?"row":"column"}function Pn(e,t,n,i){const r=i==="row"?n.headerRow:i==="column"?n.headerColumn:n.headerFacet;return V((t||{})[e],r[e],n.header[e])}function cr(e,t,n,i){const r={};for(const s of e){const o=Pn(s,t||{},n,i);o!==void 0&&(r[s]=o)}return r}const oo=["row","column"],ao=["header","footer"];function Oy(e,t){const n=e.component.layoutHeaders[t].title,i=e.config?e.config:void 0,r=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0,{titleAnchor:s,titleAngle:o,titleOrient:a}=cr(["titleAnchor","titleAngle","titleOrient"],r.header,i,t),c=ar(t,a),u=Wn(o);return{name:`${t}-title`,type:"group",role:`${c}-title`,title:{text:n,...t==="row"?{orient:"left"}:{},style:"guide-title",...bl(u,c),...yl(c,u,s),...xl(i,r,t,vm,tu)}}}function yl(e,t,n="middle"){switch(n){case"start":return{align:"left"};case"end":return{align:"right"}}const i=ml(t,e==="row"?"left":"top",e==="row"?"y":"x");return i?{align:i}:{}}function bl(e,t){const n=gl(e,t==="row"?"left":"top",t==="row"?"y":"x",!0);return n?{baseline:n}:{}}function Py(e,t){const n=e.component.layoutHeaders[t],i=[];for(const r of ao)if(n[r])for(const s of n[r]){const o=Ry(e,t,r,n,s);o!=null&&i.push(o)}return i}function zy(e,t){const{sort:n}=e;return Xe(n)?{field:w(n,{expr:"datum"}),order:n.order??"ascending"}:v(n)?{field:On(e,t,{expr:"datum"}),order:"ascending"}:{field:w(e,{expr:"datum"}),order:n??"ascending"}}function co(e,t,n){const{format:i,formatType:r,labelAngle:s,labelAnchor:o,labelOrient:a,labelExpr:c}=cr(["format","formatType","labelAngle","labelAnchor","labelOrient","labelExpr"],e.header,n,t),u=bs({fieldOrDatumDef:e,format:i,formatType:r,expr:"parent",config:n}).signal,l=ar(t,a);return{text:{signal:c?Lt(Lt(c,"datum.label",u),"datum.value",w(e,{expr:"parent"})):u},...t==="row"?{orient:"left"}:{},style:"guide-label",frame:"group",...bl(s,l),...yl(l,s,o),...xl(n,e,t,Em,nu)}}function Ry(e,t,n,i,r){if(r){let s=null;const{facetFieldDef:o}=i,a=e.config?e.config:void 0;if(o&&r.labels){const{labelOrient:f}=cr(["labelOrient"],o.header,a,t);(t==="row"&&!P(["top","bottom"],f)||t==="column"&&!P(["left","right"],f))&&(s=co(o,t,a))}const c=Le(e)&&!Kn(e.facet),u=r.axes,l=u?.length>0;if(s||l){const f=t==="row"?"height":"width";return{name:e.getName(`${t}_${n}`),type:"group",role:`${t}-${n}`,...i.facetFieldDef?{from:{data:e.getName(`${t}_domain`)},sort:zy(o,t)}:{},...l&&c?{from:{data:e.getName(`facet_domain_${t}`)}}:{},...s?{title:s}:{},...r.sizeSignal?{encode:{update:{[f]:r.sizeSignal}}}:{},...l?{axes:u}:{}}}}return null}const Iy={column:{start:0,end:1},row:{start:1,end:0}};function Ly(e,t){return Iy[t][e]}function My(e,t){const n={};for(const i of ve){const r=e[i];if(r?.facetFieldDef){const{titleAnchor:s,titleOrient:o}=cr(["titleAnchor","titleOrient"],r.facetFieldDef.header,t,i),a=ar(i,o),c=Ly(s,a);c!==void 0&&(n[a]=c)}}return I(n)?void 0:n}function xl(e,t,n,i,r){const s={};for(const o of i){if(!r[o])continue;const a=Pn(o,t?.header,e,n);a!==void 0&&(s[r[o]]=a)}return s}function uo(e){return[...ur(e,"width"),...ur(e,"height"),...ur(e,"childWidth"),...ur(e,"childHeight")]}function ur(e,t){const n=t==="width"?"x":"y",i=e.component.layoutSize.get(t);if(!i||i==="merged")return[];const r=e.getSizeSignalRef(t).signal;if(i==="step"){const s=e.getScaleComponent(n);if(s){const o=s.get("type"),a=s.get("range");if(Z(o)&&Ct(a)){const c=e.scaleName(n);if(Le(e.parent)){const u=e.parent.component.resolve;if(u.scale[n]==="independent")return[Sl(c,a)]}return[Sl(c,a),{name:r,update:wl(c,s,`domain('${c}').length`)}]}}throw new Error("layout size is step although width/height is not step.")}else if(i=="container"){const s=r.endsWith("width"),o=s?"containerSize()[0]":"containerSize()[1]",a=Ds(e.config.view,s?"width":"height"),c=`isFinite(${o}) ? ${o} : ${a}`;return[{name:r,init:c,on:[{update:c,events:"window:resize"}]}]}else return[{name:r,value:i}]}function Sl(e,t){const n=`${e}_step`;return E(t.step)?{name:n,update:t.step.signal}:{name:n,value:t.step}}function wl(e,t,n){const i=t.get("type"),r=t.get("padding"),s=V(t.get("paddingOuter"),r);let o=t.get("paddingInner");return o=i==="band"?o!==void 0?o:r:1,`bandspace(${n}, ${Te(o)}, ${Te(s)}) * ${e}_step`}function $l(e){return e==="childWidth"?"width":e==="childHeight"?"height":e}function vl(e,t){return b(e).reduce((n,i)=>{const r=e[i];return{...n,...Nn(t,r,i,s=>B(s.value))}},{})}function El(e,t){if(Le(t))return e==="theta"?"independent":"shared";if(In(t))return"shared";if(_o(t))return Q(e)||e==="theta"||e==="radius"?"independent":"shared";throw new Error("invalid model type for resolve")}function lo(e,t){const n=e.scale[t],i=Q(t)?"axis":"legend";return n==="independent"?(e[i][t]==="shared"&&x(wp(t)),"independent"):e[i][t]||"shared"}const Dy={...Cm,disable:1,labelExpr:1,selections:1,opacity:1,shape:1,stroke:1,fill:1,size:1,strokeWidth:1,strokeDash:1,encode:1},_l=b(Dy);class jy extends gt{}const kl={symbols:Uy,gradient:By,labels:Wy,entries:Hy};function Uy(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r,legendType:s}){if(s!=="symbol")return;const{markDef:o,encoding:a,config:c,mark:u}=n,l=o.filled&&u!=="trail";let f={...Ad({},n,vg),...Bu(n,{filled:l})};const d=r.get("symbolOpacity")??c.legend.symbolOpacity,p=r.get("symbolFillColor")??c.legend.symbolFillColor,g=r.get("symbolStrokeColor")??c.legend.symbolStrokeColor,m=d===void 0?Cl(a.opacity)??o.opacity:void 0;if(f.fill){if(i==="fill"||l&&i===le)delete f.fill;else if(f.fill.field)p?delete f.fill:(f.fill=B(c.legend.symbolBaseFillColor??"black"),f.fillOpacity=B(m??1));else if(v(f.fill)){const h=fo(a.fill??a.color)??o.fill??(l&&o.color);h&&(f.fill=B(h))}}if(f.stroke){if(i==="stroke"||!l&&i===le)delete f.stroke;else if(f.stroke.field||g)delete f.stroke;else if(v(f.stroke)){const h=V(fo(a.stroke||a.color),o.stroke,l?o.color:void 0);h&&(f.stroke={value:h})}}if(i!==at){const h=S(t)&&Fl(n,r,t);h?f.opacity=[{test:h,...B(m??1)},B(c.legend.unselectedOpacity)]:m&&(f.opacity=B(m))}return f={...f,...e},I(f)?void 0:f}function By(e,{model:t,legendType:n,legendCmpt:i}){if(n!=="gradient")return;const{config:r,markDef:s,encoding:o}=t;let a={};const c=i.get("gradientOpacity")??r.legend.gradientOpacity,u=c===void 0?Cl(o.opacity)||s.opacity:void 0;return u&&(a.opacity=B(u)),a={...a,...e},I(a)?void 0:a}function Wy(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r}){const s=n.legend(i)||{},o=n.config,a=S(t)?Fl(n,r,t):void 0,c=a?[{test:a,value:1},{value:o.legend.unselectedOpacity}]:void 0,{format:u,formatType:l}=s;let f;Vt(l)?f=Oe({fieldOrDatumDef:t,field:"datum.value",format:u,formatType:l,config:o}):u===void 0&&l===void 0&&o.customFormatTypes&&(t.type==="quantitative"&&o.numberFormatType?f=Oe({fieldOrDatumDef:t,field:"datum.value",format:o.numberFormat,formatType:o.numberFormatType,config:o}):t.type==="temporal"&&o.timeFormatType&&S(t)&&t.timeUnit===void 0&&(f=Oe({fieldOrDatumDef:t,field:"datum.value",format:o.timeFormat,formatType:o.timeFormatType,config:o})));const d={...c?{opacity:c}:{},...f?{text:f}:{},...e};return I(d)?void 0:d}function Hy(e,{legendCmpt:t}){const n=t.get("selections");return n?.length?{...e,fill:{value:"transparent"}}:e}function Cl(e){return Nl(e,(t,n)=>Math.max(t,n.value))}function fo(e){return Nl(e,(t,n)=>V(t,n.value))}function Nl(e,t){return Wg(e)?q(e.condition).reduce(t,e.value):Pe(e)?e.value:void 0}function Fl(e,t,n){const i=t.get("selections");if(!i?.length)return;const r=A(n.field);return i.map(s=>{const o=A(W(s)+Qt);return`(!length(data(${o})) || (${s}[${r}] && indexof(${s}[${r}], datum.value) >= 0))`}).join(" || ")}const Tl={direction:({direction:e})=>e,format:({fieldOrDatumDef:e,legend:t,config:n})=>{const{format:i,formatType:r}=t;return hc(e,e.type,i,r,n,!1)},formatType:({legend:e,fieldOrDatumDef:t,scaleType:n})=>{const{formatType:i}=e;return yc(i,t,n)},gradientLength:e=>{const{legend:t,legendConfig:n}=e;return t.gradientLength??n.gradientLength??Qy(e)},labelOverlap:({legend:e,legendConfig:t,scaleType:n})=>e.labelOverlap??t.labelOverlap??Zy(n),symbolType:({legend:e,markDef:t,channel:n,encoding:i})=>e.symbolType??Gy(t.type,n,i.shape,t.shape),title:({fieldOrDatumDef:e,config:t})=>$n(e,t,{allowDisabling:!0}),type:({legendType:e,scaleType:t,channel:n})=>{if(gn(n)&&Ae(t)){if(e==="gradient")return}else if(e==="symbol")return;return e},values:({fieldOrDatumDef:e,legend:t})=>qy(t,e)};function qy(e,t){const n=e.values;return v(n)?Rc(t,n):E(n)?n:void 0}function Gy(e,t,n,i){if(t!=="shape"){const r=fo(n)??i;if(r)return r}switch(e){case"bar":case"rect":case"image":case"square":return"square";case"line":case"trail":case"rule":return"stroke";case"arc":case"point":case"circle":case"tick":case"geoshape":case"area":case"text":return"circle"}}function Vy(e){const{legend:t}=e;return V(t.type,Xy(e))}function Xy({channel:e,timeUnit:t,scaleType:n}){if(gn(e)){if(P(["quarter","month","day"],t))return"symbol";if(Ae(n))return"gradient"}return"symbol"}function Yy({legendConfig:e,legendType:t,orient:n,legend:i}){return i.direction??e[t?"gradientDirection":"symbolDirection"]??Ky(n,t)}function Ky(e,t){switch(e){case"top":case"bottom":return"horizontal";case"left":case"right":case"none":case void 0:return;default:return t==="gradient"?"horizontal":void 0}}function Qy({legendConfig:e,model:t,direction:n,orient:i,scaleType:r}){const{gradientHorizontalMaxLength:s,gradientHorizontalMinLength:o,gradientVerticalMaxLength:a,gradientVerticalMinLength:c}=e;return Ae(r)?n==="horizontal"?i==="top"||i==="bottom"?Al(t,"width",o,s):o:Al(t,"height",c,a):void 0}function Al(e,t,n,i){const r=e.getSizeSignalRef(t).signal;return{signal:`clamp(${r}, ${n}, ${i})`}}function Zy(e){return P(["quantile","threshold","log","symlog"],e)?"greedy":void 0}function Ol(e){const t=X(e)?Jy(e):ib(e);return e.component.legends=t,t}function Jy(e){const{encoding:t}=e,n={};for(const i of[le,...ru]){const r=Y(t[i]);if(!r||!e.getScaleComponent(i))continue;if(i===fe&&S(r)&&r.type===bn)continue;n[i]=nb(e,i)}return n}function eb(e,t){const n=e.scaleName(t);if(e.mark==="trail"){if(t==="color")return{stroke:n};if(t==="size")return{strokeWidth:n}}return t==="color"?e.markDef.filled?{fill:n}:{stroke:n}:{[t]:n}}function tb(e,t,n,i){switch(t){case"disable":return n!==void 0;case"values":return!!n?.values;case"title":if(t==="title"&&e===i?.title)return!0}return e===(n||{})[t]}function nb(e,t){let n=e.legend(t);const{markDef:i,encoding:r,config:s}=e,o=s.legend,a=new jy({},eb(e,t));fy(e,t,a);const c=n!==void 0?!n:o.disable;if(a.set("disable",c,n!==void 0),c)return a;n=n||{};const u=e.getScaleComponent(t).get("type"),l=Y(r[t]),f=S(l)?ne(l.timeUnit)?.unit:void 0,d=n.orient||s.legend.orient||"right",p=Vy({legend:n,channel:t,timeUnit:f,scaleType:u}),g=Yy({legend:n,legendType:p,orient:d,legendConfig:o}),m={legend:n,channel:t,model:e,markDef:i,encoding:r,fieldOrDatumDef:l,legendConfig:o,config:s,scaleType:u,orient:d,legendType:p,direction:g};for(const _ of _l){if(p==="gradient"&&_.startsWith("symbol")||p==="symbol"&&_.startsWith("gradient"))continue;const T=_ in Tl?Tl[_](m):n[_];if(T!==void 0){const L=tb(T,_,n,e.fieldDef(t));(L||s.legend[_]===void 0)&&a.set(_,T,L)}}const h=n?.encoding??{},y=a.get("selections"),$={},C={fieldOrDatumDef:l,model:e,channel:t,legendCmpt:a,legendType:p};for(const _ of["labels","legend","title","symbols","gradient","entries"]){const T=vl(h[_]??{},e),L=_ in kl?kl[_](T,C):T;L!==void 0&&!I(L)&&($[_]={...y?.length&&S(l)?{name:`${W(l.field)}_legend_${_}`}:{},...y?.length?{interactive:!!y}:{},update:L})}return I($)||a.set("encode",$,!!n?.encoding),a}function ib(e){const{legends:t,resolve:n}=e.component;for(const i of e.children){Ol(i);for(const r of b(i.component.legends))n.legend[r]=lo(e.component.resolve,r),n.legend[r]==="shared"&&(t[r]=Pl(t[r],i.component.legends[r]),t[r]||(n.legend[r]="independent",delete t[r]))}for(const i of b(t))for(const r of e.children){if(!r.component.legends[i])continue;n.legend[i]==="shared"&&delete r.component.legends[i]}return t}function Pl(e,t){if(!e)return t.clone();const n=e.getWithExplicit("orient"),i=t.getWithExplicit("orient");if(n.explicit&&i.explicit&&n.value!==i.value)return;let r=!1;for(const s of _l){const o=Tt(e.getWithExplicit(s),t.getWithExplicit(s),s,"legend",(a,c)=>{switch(s){case"symbolType":return rb(a,c);case"title":return Na(a,c);case"type":return r=!0,xe("symbol")}return er(a,c,s,"legend")});e.setWithExplicit(s,o)}return r&&(e.implicit?.encode?.gradient&&hi(e.implicit,["encode","gradient"]),e.explicit?.encode?.gradient&&hi(e.explicit,["encode","gradient"])),e}function rb(e,t){return t.value==="circle"?t:e}function sb(e,t,n,i){var r,s;e.encode??(e.encode={}),(r=e.encode)[t]??(r[t]={}),(s=e.encode[t]).update??(s.update={}),e.encode[t].update[n]=i}function zl(e){const t=e.component.legends,n={};for(const r of b(t)){const s=e.getScaleComponent(r),o=D(s.get("domains"));if(n[o])for(const a of n[o]){const c=Pl(a,t[r]);c||n[o].push(t[r])}else n[o]=[t[r].clone()]}const i=ee(n).flat().map(r=>ob(r,e.config)).filter(r=>r!==void 0);return i}function ob(e,t){const{disable:n,labelExpr:i,selections:r,...s}=e.combine();if(n)return;if(t.aria===!1&&s.aria==null&&(s.aria=!1),s.encode?.symbols){const o=s.encode.symbols.update;o.fill&&o.fill.value!=="transparent"&&!o.stroke&&!s.stroke&&(o.stroke={value:"transparent"});for(const a of ru)s[a]&&delete o[a]}if(s.title||delete s.title,i!==void 0){let o=i;s.encode?.labels?.update&&E(s.encode.labels.update.text)&&(o=Lt(i,"datum.label",s.encode.labels.update.text.signal)),sb(s,"labels","text",{signal:o})}return s}function ab(e){return In(e)||_o(e)?cb(e):Rl(e)}function cb(e){return e.children.reduce((t,n)=>t.concat(n.assembleProjections()),Rl(e))}function Rl(e){const t=e.component.projection;if(!t||t.merged)return[];const n=t.combine(),{name:i}=n;if(t.data){const r={signal:`[${t.size.map(o=>o.signal).join(", ")}]`},s=t.data.reduce((o,a)=>{const c=E(a)?a.signal:`data('${e.lookupDataSource(a)}')`;return P(o,c)||o.push(c),o},[]);if(s.length<=0)throw new Error("Projection's fit didn't find any data sources");return[{name:i,size:r,fit:{signal:s.length>1?`[${s.join(", ")}]`:s[0]},...n}]}else return[{name:i,translate:{signal:"[width / 2, height / 2]"},...n}]}const ub=["type","clipAngle","clipExtent","center","rotate","precision","reflectX","reflectY","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];class Il extends gt{constructor(t,n,i,r){super({...n},{name:t});this.specifiedProjection=n,this.size=i,this.data=r,this.merged=!1}get isFit(){return!!this.data}}function Ll(e){e.component.projection=X(e)?lb(e):pb(e)}function lb(e){if(e.hasProjection){const t=pe(e.specifiedProjection),n=!(t&&(t.scale!=null||t.translate!=null)),i=n?[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]:void 0,r=n?fb(e):void 0,s=new Il(e.projectionName(!0),{...pe(e.config.projection)??{},...t??{}},i,r);return s.get("type")||s.set("type","equalEarth",!1),s}return}function fb(e){const t=[],{encoding:n}=e;for(const i of[[Ne,Ce],[$e,Fe]])(Y(n[i[0]])||Y(n[i[1]]))&&t.push({signal:e.getName(`geojson_${t.length}`)});return e.channelHasField(fe)&&e.typedFieldDef(fe).type===bn&&t.push({signal:e.getName(`geojson_${t.length}`)}),t.length===0&&t.push(e.requestDataName(U.Main)),t}function db(e,t){const n=Ar(ub,r=>!on(e.explicit,r)&&!on(t.explicit,r)?!0:!!(on(e.explicit,r)&&on(t.explicit,r)&&De(e.get(r),t.get(r)))),i=De(e.size,t.size);if(i){if(n)return e;if(De(e.explicit,{}))return t;if(De(t.explicit,{}))return e}return null}function pb(e){if(e.children.length===0)return;let t;for(const i of e.children)Ll(i);const n=Ar(e.children,i=>{const r=i.component.projection;if(r)if(t){const s=db(t,r);return s&&(t=s),!!s}else return t=r,!0;else return!0});if(t&&n){const i=e.projectionName(!0),r=new Il(i,t.specifiedProjection,t.size,k(t.data));for(const s of e.children){const o=s.component.projection;o&&(o.isFit&&r.data.push(...s.component.projection.data),s.renameProjection(o.get("name"),i),o.merged=!0)}return r}return}function gb(e,t,n,i){if(Zn(t,n)){const r=X(e)?e.axis(n)??e.legend(n)??{}:{},s=w(t,{expr:"datum"}),o=w(t,{expr:"datum",binSuffix:"end"});return{formulaAs:w(t,{binSuffix:"range",forAs:!0}),formula:Yn(s,o,r.format,r.formatType,i)}}return{}}function Ml(e,t){return`${ya(e)}_${t}`}function mb(e,t){return{signal:e.getName(`${t}_bins`),extentSignal:e.getName(`${t}_extent`)}}function po(e,t,n){const i=Hi(n,void 0)??{},r=Ml(i,t);return e.getName(`${r}_bins`)}function hb(e){return"as"in e}function Dl(e,t,n){let i,r;hb(e)?i=F(e.as)?[e.as,`${e.as}_end`]:[e.as[0],e.as[1]]:i=[w(e,{forAs:!0}),w(e,{binSuffix:"end",forAs:!0})];const s={...Hi(t,void 0)},o=Ml(s,e.field),{signal:a,extentSignal:c}=mb(n,o);if(_i(s.extent)){const l=s.extent;r=ll(n,l.param,l),delete s.extent}const u={bin:s,field:e.field,as:[i],...a?{signal:a}:{},...c?{extentSignal:c}:{},...r?{span:r}:{}};return{key:o,binComponent:u}}class et extends R{clone(){return new et(null,k(this.bins))}constructor(t,n){super(t);this.bins=n}static makeFromEncoding(t,n){const i=n.reduceFieldDef((r,s,o)=>{if(ae(s)&&j(s.bin)){const{key:a,binComponent:c}=Dl(s,s.bin,n);r[a]={...c,...r[a],...gb(n,s,o,n.config)}}return r},{});return I(i)?null:new et(t,i)}static makeFromTransform(t,n,i){const{key:r,binComponent:s}=Dl(n,n.bin,i);return new et(t,{[r]:s})}merge(t,n){for(const i of b(t.bins))i in this.bins?(n(t.bins[i].signal,this.bins[i].signal),this.bins[i].as=je([...this.bins[i].as,...t.bins[i].as],O)):this.bins[i]=t.bins[i];for(const i of t.children)t.removeChild(i),i.parent=this;t.remove()}producedFields(){return new Set(ee(this.bins).map(t=>t.as).flat(2))}dependentFields(){return new Set(ee(this.bins).map(t=>t.field))}hash(){return`Bin ${O(this.bins)}`}assemble(){return ee(this.bins).flatMap(t=>{const n=[],[i,...r]=t.as,{extent:s,...o}=t.bin,a={type:"bin",field:Se(t.field),as:i,signal:t.signal,..._i(s)?{extent:null}:{extent:s},...t.span?{span:{signal:`span(${t.span})`}}:{},...o};!s&&t.extentSignal&&(n.push({type:"extent",field:Se(t.field),signal:t.extentSignal}),a.extent={signal:t.extentSignal}),n.push(a);for(const c of r)for(let u=0;u<2;u++)n.push({type:"formula",expr:w({field:i[u]},{expr:"datum"}),as:c[u]});return t.formula&&n.push({type:"formula",expr:t.formula,as:t.formulaAs}),n})}}function yb(e,t,n,i){const r=X(i)?i.encoding[He(t)]:void 0;if(ae(n)&&X(i)&&kc(n,r,i.markDef,i.config))e.add(w(n,{})),e.add(w(n,{suffix:"end"})),n.bin&&Zn(n,t)&&e.add(w(n,{binSuffix:"range"}));else if(oa(t)){const s=sa(t);e.add(i.getName(s))}else e.add(w(n));return Xt(n)&&fg(n.scale?.range)&&e.add(n.scale.range.field),e}function bb(e,t){for(const n of b(t)){const i=t[n];for(const r of b(i))n in e?e[n][r]=new Set([...e[n][r]??[],...i[r]]):e[n]={[r]:i[r]}}}class Re extends R{clone(){return new Re(null,new Set(this.dimensions),k(this.measures))}constructor(t,n,i){super(t);this.dimensions=n,this.measures=i}get groupBy(){return this.dimensions}static makeFromEncoding(t,n){let i=!1;n.forEachFieldDef(o=>{o.aggregate&&(i=!0)});const r={},s=new Set;return i?(n.forEachFieldDef((o,a)=>{const{aggregate:c,field:u}=o;if(c)if(c==="count")r["*"]??(r["*"]={}),r["*"].count=new Set([w(o,{forAs:!0})]);else{if(ut(c)||_t(c)){const l=ut(c)?"argmin":"argmax",f=c[l];r[f]??(r[f]={}),r[f][l]=new Set([w({op:l,field:f},{forAs:!0})])}else r[u]??(r[u]={}),r[u][c]=new Set([w(o,{forAs:!0})]);ct(a)&&n.scaleDomain(a)==="unaggregated"&&(r[u]??(r[u]={}),r[u].min=new Set([w({field:u,aggregate:"min"},{forAs:!0})]),r[u].max=new Set([w({field:u,aggregate:"max"},{forAs:!0})]))}else yb(s,a,o,n)}),s.size+b(r).length===0?null:new Re(t,s,r)):null}static makeFromTransform(t,n){const i=new Set,r={};for(const s of n.aggregate){const{op:o,field:a,as:c}=s;o&&(o==="count"?(r["*"]??(r["*"]={}),r["*"].count=new Set([c||w(s,{forAs:!0})])):(r[a]??(r[a]={}),r[a][o]=new Set([c||w(s,{forAs:!0})])))}for(const s of n.groupby??[])i.add(s);return i.size+b(r).length===0?null:new Re(t,i,r)}merge(t){return Qo(this.dimensions,t.dimensions)?(bb(this.measures,t.measures),!0):(Lp("different dimensions, cannot merge"),!1)}addDimensions(t){t.forEach(this.dimensions.add,this.dimensions)}dependentFields(){return new Set([...this.dimensions,...b(this.measures)])}producedFields(){const t=new Set;for(const n of b(this.measures))for(const i of b(this.measures[n])){const r=this.measures[n][i];r.size===0?t.add(`${i}_${n}`):r.forEach(t.add,t)}return t}hash(){return`Aggregate ${O({dimensions:this.dimensions,measures:this.measures})}`}assemble(){const t=[],n=[],i=[];for(const s of b(this.measures))for(const o of b(this.measures[s]))for(const a of this.measures[s][o])i.push(a),t.push(o),n.push(s==="*"?null:Se(s));const r={type:"aggregate",groupby:[...this.dimensions].map(Se),ops:t,fields:n,as:i};return r}}class zn extends R{constructor(t,n,i,r){super(t);this.model=n,this.name=i,this.data=r;for(const s of ve){const o=n.facet[s];if(o){const{bin:a,sort:c}=o;this[s]={name:n.getName(`${s}_domain`),fields:[w(o),...j(a)?[w(o,{binSuffix:"end"})]:[]],...Xe(c)?{sortField:c}:v(c)?{sortIndexField:On(o,s)}:{}}}}this.childModel=n.child}hash(){let t="Facet";for(const n of ve)this[n]&&(t+=` ${n.charAt(0)}:${O(this[n])}`);return t}get fields(){const t=[];for(const n of ve)this[n]?.fields&&t.push(...this[n].fields);return t}dependentFields(){const t=new Set(this.fields);for(const n of ve)this[n]&&(this[n].sortField&&t.add(this[n].sortField.field),this[n].sortIndexField&&t.add(this[n].sortIndexField));return t}producedFields(){return new Set}getSource(){return this.name}getChildIndependentFieldsWithStep(){const t={};for(const n of qe){const i=this.childModel.component.scales[n];if(i&&!i.merged){const r=i.get("type"),s=i.get("range");if(Z(r)&&Ct(s)){const o=fr(this.childModel,n),a=vo(o);a?t[n]=a:x(Xr(n))}}}return t}assembleRowColumnHeaderData(t,n,i){const r={row:"y",column:"x",facet:void 0}[t],s=[],o=[],a=[];r&&i&&i[r]&&(n?(s.push(`distinct_${i[r]}`),o.push("max")):(s.push(i[r]),o.push("distinct")),a.push(`distinct_${i[r]}`));const{sortField:c,sortIndexField:u}=this[t];if(c){const{op:l=Ii,field:f}=c;s.push(f),o.push(l),a.push(w(c,{forAs:!0}))}else u&&(s.push(u),o.push("max"),a.push(u));return{name:this[t].name,source:n??this.data,transform:[{type:"aggregate",groupby:this[t].fields,...s.length?{fields:s,ops:o,as:a}:{}}]}}assembleFacetHeaderData(t){const{columns:n}=this.model.layout,{layoutHeaders:i}=this.model.component,r=[],s={};for(const c of oo){for(const u of ao){const l=(i[c]&&i[c][u])??[];for(const f of l)if(f.axes?.length>0){s[c]=!0;break}}if(s[c]){const u=`length(data("${this.facet.name}"))`,l=c==="row"?n?{signal:`ceil(${u} / ${n})`}:1:n?{signal:`min(${u}, ${n})`}:{signal:u};r.push({name:`${this.facet.name}_${c}`,transform:[{type:"sequence",start:0,stop:l}]})}}const{row:o,column:a}=s;return(o||a)&&r.unshift(this.assembleRowColumnHeaderData("facet",null,t)),r}assemble(){const t=[];let n=null;const i=this.getChildIndependentFieldsWithStep(),{column:r,row:s,facet:o}=this;if(r&&s&&(i.x||i.y)){n=`cross_${this.column.name}_${this.row.name}`;const a=[].concat(i.x??[],i.y??[]),c=a.map(()=>"distinct");t.push({name:n,source:this.data,transform:[{type:"aggregate",groupby:this.fields,fields:a,ops:c}]})}for(const a of[it,nt])this[a]&&t.push(this.assembleRowColumnHeaderData(a,n,i));if(o){const a=this.assembleFacetHeaderData(i);a&&t.push(...a)}return t}}function jl(e){return e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}function xb(e,t){const n=Rr(e);if(t==="number")return`toNumber(${n})`;if(t==="boolean")return`toBoolean(${n})`;if(t==="string")return`toString(${n})`;if(t==="date")return`toDate(${n})`;if(t==="flatten")return n;if(t.startsWith("date:")){const i=jl(t.slice(5,t.length));return`timeParse(${n},'${i}')`}else if(t.startsWith("utc:")){const i=jl(t.slice(4,t.length));return`utcParse(${n},'${i}')`}else return x(Hd(t)),null}function Sb(e){const t={};return mi(e.filter,n=>{if(Qa(n)){let i=null;es(n)?i=ye(n.equal):ns(n)?i=ye(n.lte):ts(n)?i=ye(n.lt):is(n)?i=ye(n.gt):rs(n)?i=ye(n.gte):ss(n)?i=n.range[0]:os(n)&&(i=(n.oneOf??n.in)[0]),i&&(Bt(i)?t[n.field]="date":G(i)?t[n.field]="number":F(i)&&(t[n.field]="string")),n.timeUnit&&(t[n.field]="date")}}),t}function wb(e){const t={};function n(i){En(i)?t[i.field]="date":i.type==="quantitative"&&$d(i.aggregate)?t[i.field]="number":fn(i.field)>1?i.field in t||(t[i.field]="flatten"):Xt(i)&&Xe(i.sort)&&fn(i.sort.field)>1&&(i.sort.field in t||(t[i.sort.field]="flatten"))}if((X(e)||Le(e))&&e.forEachFieldDef((i,r)=>{if(ae(i))n(i);else{const s=jt(r),o=e.fieldDef(s);n({...i,type:o.type})}}),X(e)){const{mark:i,markDef:r,encoding:s}=e;if(Nt(i)&&!e.encoding.order){const o=r.orient==="horizontal"?"y":"x",a=s[o];S(a)&&a.type==="quantitative"&&!(a.field in t)&&(t[a.field]="number")}}return t}function $b(e){const t={};if(X(e)&&e.component.selection)for(const n of b(e.component.selection)){const i=e.component.selection[n];for(const r of i.project.items)!r.channel&&fn(r.field)>1&&(t[r.field]="flatten")}return t}class se extends R{clone(){return new se(null,k(this._parse))}constructor(t,n){super(t);this._parse=n}hash(){return`Parse ${O(this._parse)}`}static makeExplicit(t,n,i){let r={};const s=n.data;return!At(s)&&s?.format?.parse&&(r=s.format.parse),this.makeWithAncestors(t,r,{},i)}static makeWithAncestors(t,n,i,r){for(const a of b(i)){const c=r.getWithExplicit(a);c.value!==void 0&&(c.explicit||c.value===i[a]||c.value==="derived"||i[a]==="flatten"?delete i[a]:x(Ra(a,i[a],c.value)))}for(const a of b(n)){const c=r.get(a);c!==void 0&&(c===n[a]?delete n[a]:x(Ra(a,n[a],c)))}const s=new gt(n,i);r.copyAll(s);const o={};for(const a of b(s.combine())){const c=s.get(a);c!==null&&(o[a]=c)}return b(o).length===0||r.parseNothing?null:new se(t,o)}get parse(){return this._parse}merge(t){this._parse={...this._parse,...t.parse},t.remove()}assembleFormatParse(){const t={};for(const n of b(this._parse)){const i=this._parse[n];fn(n)===1&&(t[n]=i)}return t}producedFields(){return new Set(b(this._parse))}dependentFields(){return new Set(b(this._parse))}assembleTransforms(t=!1){return b(this._parse).filter(n=>t?fn(n)>1:!0).map(n=>{const i=xb(n,this._parse[n]);if(!i)return null;const r={type:"formula",expr:i,as:Ir(n)};return r}).filter(n=>n!==null)}}class zt extends R{clone(){return new zt(null)}constructor(t){super(t)}dependentFields(){return new Set}producedFields(){return new Set([ze])}hash(){return"Identifier"}assemble(){return{type:"identifier",as:ze}}}class ri extends R{clone(){return new ri(null,this.params)}constructor(t,n){super(t);this.params=n}dependentFields(){return new Set}producedFields(){return}hash(){return`Graticule ${O(this.params)}`}assemble(){return{type:"graticule",...this.params===!0?{}:this.params}}}class si extends R{clone(){return new si(null,this.params)}constructor(t,n){super(t);this.params=n}dependentFields(){return new Set}producedFields(){return new Set([this.params.as??"data"])}hash(){return`Hash ${O(this.params)}`}assemble(){return{type:"sequence",...this.params}}}class Jt extends R{constructor(t){super(null);t??(t={name:"source"});let n;if(At(t)||(n=t.format?{...ue(t.format,["parse"])}:{}),ei(t))this._data={values:t.values};else if(kn(t)){if(this._data={url:t.url},!n.type){let i=/(?:\.([^.]+))?$/.exec(t.url)[1];P(["json","csv","tsv","dsv","topojson"],i)||(i="json"),n.type=i}}else zu(t)?this._data={values:[{type:"Sphere"}]}:(Ou(t)||At(t))&&(this._data={});this._generator=At(t),t.name&&(this._name=t.name),n&&!I(n)&&(this._data.format=n)}dependentFields(){return new Set}producedFields(){return}get data(){return this._data}hasName(){return!!this._name}get isGenerator(){return this._generator}get dataName(){return this._name}set dataName(t){this._name=t}set parent(t){throw new Error("Source nodes have to be roots.")}remove(){throw new Error("Source nodes are roots and cannot be removed.")}hash(){throw new Error("Cannot hash sources")}assemble(){return{name:this._name,...this._data,transform:[]}}}var Ul=function(e,t,n,i,r){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?r.call(e,n):r?r.value=n:t.set(e,n),n},vb=function(e,t,n,i){if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(e):i?i.value:t.get(e)},oi;function go(e){return e instanceof Jt||e instanceof ri||e instanceof si}class mo{constructor(){oi.set(this,void 0),Ul(this,oi,!1,"f")}setModified(){Ul(this,oi,!0,"f")}get modifiedFlag(){return vb(this,oi,"f")}}oi=new WeakMap;class en extends mo{getNodeDepths(t,n,i){i.set(t,n);for(const r of t.children)this.getNodeDepths(r,n+1,i);return i}optimize(t){const n=this.getNodeDepths(t,0,new Map),i=[...n.entries()].sort((r,s)=>s[1]-r[1]);for(const r of i)this.run(r[0]);return this.modifiedFlag}}class ho extends mo{optimize(t){this.run(t);for(const n of t.children)this.optimize(n);return this.modifiedFlag}}class Eb extends ho{mergeNodes(t,n){const i=n.shift();for(const r of n)t.removeChild(r),r.parent=i,r.remove()}run(t){const n=t.children.map(r=>r.hash()),i={};for(let r=0;r<n.length;r++)i[n[r]]===void 0?i[n[r]]=[t.children[r]]:i[n[r]].push(t.children[r]);for(const r of b(i))i[r].length>1&&(this.setModified(),this.mergeNodes(t,i[r]))}}class _b extends ho{constructor(t){super();this.requiresSelectionId=t&&to(t)}run(t){t instanceof zt&&(this.requiresSelectionId&&(go(t.parent)||t.parent instanceof Re||t.parent instanceof se)||(this.setModified(),t.remove()))}}class kb extends mo{optimize(t){return this.run(t,new Set),this.modifiedFlag}run(t,n){let i=new Set;t instanceof Je&&(i=t.producedFields(),Or(i,n)&&(this.setModified(),t.removeFormulas(n),t.producedFields.length===0&&t.remove()));for(const r of t.children)this.run(r,new Set([...n,...i]))}}class Cb extends ho{constructor(){super()}run(t){t instanceof ce&&!t.isRequired()&&(this.setModified(),t.remove())}}class Nb extends en{run(t){if(go(t))return;if(t.numChildren()>1)return;for(const n of t.children)if(n instanceof se)if(t instanceof se)this.setModified(),t.merge(n);else{if(zr(t.producedFields(),n.dependentFields()))continue;this.setModified(),n.swapWithParent()}return}}class Fb extends en{run(t){const n=[...t.children],i=t.children.filter(r=>r instanceof se);if(t.numChildren()>1&&i.length>=1){const r={},s=new Set;for(const o of i){const a=o.parse;for(const c of b(a))c in r?r[c]!==a[c]&&s.add(c):r[c]=a[c]}for(const o of s)delete r[o];if(!I(r)){this.setModified();const o=new se(t,r);for(const a of n){if(a instanceof se)for(const c of b(r))delete a.parse[c];t.removeChild(a),a.parent=o,a instanceof se&&b(a.parse).length===0&&a.remove()}}}}}class Tb extends en{run(t){t instanceof ce||t.numChildren()>0||t instanceof zn||(t instanceof Jt||(this.setModified(),t.remove()))}}class Ab extends en{run(t){const n=t.children.filter(r=>r instanceof Je),i=n.pop();for(const r of n)this.setModified(),i.merge(r)}}class Ob extends en{run(t){const n=t.children.filter(r=>r instanceof Re),i={};for(const r of n){const s=O(r.groupBy);s in i||(i[s]=[]),i[s].push(r)}for(const r of b(i)){const s=i[r];if(s.length>1){const o=s.pop();for(const a of s)o.merge(a)&&(t.removeChild(a),a.parent=o,a.remove(),this.setModified())}}}}class Pb extends en{constructor(t){super();this.model=t}run(t){const n=!(go(t)||t instanceof Tn||t instanceof se||t instanceof zt),i=[],r=[];for(const s of t.children)s instanceof et&&(n&&!zr(t.producedFields(),s.dependentFields())?i.push(s):r.push(s));if(i.length>0){const s=i.pop();for(const o of i)s.merge(o,this.model.renameSignal.bind(this.model));this.setModified(),t instanceof et?t.merge(s,this.model.renameSignal.bind(this.model)):s.swapWithParent()}if(r.length>1){const s=r.pop();for(const o of r)s.merge(o,this.model.renameSignal.bind(this.model));this.setModified()}}}class zb extends en{run(t){const n=[...t.children],i=It(n,o=>o instanceof ce);if(!i||t.numChildren()<=1)return;const r=[];let s;for(const o of n)if(o instanceof ce){let a=o;for(;a.numChildren()===1;){const[c]=a.children;if(c instanceof ce)a=c;else break}r.push(...a.children),s?(t.removeChild(o),o.parent=s.parent,s.parent.removeChild(s),s.parent=a,this.setModified()):s=a}else r.push(o);if(r.length){this.setModified();for(const o of r)o.parent.removeChild(o),o.parent=s}}}class tn extends R{clone(){return new tn(null,k(this.transform))}constructor(t,n){super(t);this.transform=n}addDimensions(t){this.transform.groupby=je(this.transform.groupby.concat(t),n=>n)}dependentFields(){const t=new Set;return this.transform.groupby&&this.transform.groupby.forEach(t.add,t),this.transform.joinaggregate.map(n=>n.field).filter(n=>n!==void 0).forEach(t.add,t),t}producedFields(){return new Set(this.transform.joinaggregate.map(this.getDefaultName))}getDefaultName(t){return t.as??w(t)}hash(){return`JoinAggregateTransform ${O(this.transform)}`}assemble(){const t=[],n=[],i=[];for(const s of this.transform.joinaggregate)n.push(s.op),i.push(this.getDefaultName(s)),t.push(s.field===void 0?null:s.field);const r=this.transform.groupby;return{type:"joinaggregate",as:i,ops:n,fields:t,...r!==void 0?{groupby:r}:{}}}}function Rb(e){return e.stack.stackBy.reduce((t,n)=>{const i=n.fieldDef,r=w(i);return r&&t.push(r),t},[])}function Ib(e){return v(e)&&e.every(t=>F(t))&&e.length>1}class ht extends R{clone(){return new ht(null,k(this._stack))}constructor(t,n){super(t);this._stack=n}static makeFromTransform(t,n){const{stack:i,groupby:r,as:s,offset:o="zero"}=n,a=[],c=[];if(n.sort!==void 0)for(const f of n.sort)a.push(f.field),c.push(V(f.order,"ascending"));const u={field:a,order:c};let l;return Ib(s)?l=s:F(s)?l=[s,`${s}_end`]:l=[`${n.stack}_start`,`${n.stack}_end`],new ht(t,{dimensionFieldDefs:[],stackField:i,groupby:r,offset:o,sort:u,facetby:[],as:l})}static makeFromEncoding(t,n){const i=n.stack,{encoding:r}=n;if(!i)return null;const{groupbyChannels:s,fieldChannel:o,offset:a,impute:c}=i,u=s.map(p=>{const g=r[p];return Ke(g)}).filter(p=>!!p),l=Rb(n),f=n.encoding.order;let d;if(v(f)||S(f))d=_a(f);else{const p=Cc(f)?f.sort:o==="y"?"descending":"ascending";d=l.reduce((g,m)=>(g.field.push(m),g.order.push(p),g),{field:[],order:[]})}return new ht(t,{dimensionFieldDefs:u,stackField:n.vgField(o),facetby:[],stackby:l,sort:d,offset:a,impute:c,as:[n.vgField(o,{suffix:"start",forAs:!0}),n.vgField(o,{suffix:"end",forAs:!0})]})}get stack(){return this._stack}addDimensions(t){this._stack.facetby.push(...t)}dependentFields(){const t=new Set;return t.add(this._stack.stackField),this.getGroupbyFields().forEach(t.add,t),this._stack.facetby.forEach(t.add,t),this._stack.sort.field.forEach(t.add,t),t}producedFields(){return new Set(this._stack.as)}hash(){return`Stack ${O(this._stack)}`}getGroupbyFields(){const{dimensionFieldDefs:t,impute:n,groupby:i}=this._stack;return t.length>0?t.map(r=>r.bin?n?[w(r,{binSuffix:"mid"})]:[w(r,{}),w(r,{binSuffix:"end"})]:[w(r)]).flat():i??[]}assemble(){const t=[],{facetby:n,dimensionFieldDefs:i,stackField:r,stackby:s,sort:o,offset:a,impute:c,as:u}=this._stack;if(c)for(const l of i){const{bandPosition:f=.5,bin:d}=l;if(d){const p=w(l,{expr:"datum"}),g=w(l,{expr:"datum",binSuffix:"end"});t.push({type:"formula",expr:`${f}*${p}+${1-f}*${g}`,as:w(l,{binSuffix:"mid",forAs:!0})})}t.push({type:"impute",field:r,groupby:[...s,...n],key:w(l,{binSuffix:"mid"}),method:"value",value:0})}return t.push({type:"stack",groupby:[...this.getGroupbyFields(),...n],field:r,sort:o,as:u,offset:a}),t}}class Rn extends R{clone(){return new Rn(null,k(this.transform))}constructor(t,n){super(t);this.transform=n}addDimensions(t){this.transform.groupby=je(this.transform.groupby.concat(t),n=>n)}dependentFields(){const t=new Set;return(this.transform.groupby??[]).forEach(t.add,t),(this.transform.sort??[]).forEach(n=>t.add(n.field)),this.transform.window.map(n=>n.field).filter(n=>n!==void 0).forEach(t.add,t),t}producedFields(){return new Set(this.transform.window.map(this.getDefaultName))}getDefaultName(t){return t.as??w(t)}hash(){return`WindowTransform ${O(this.transform)}`}assemble(){const t=[],n=[],i=[],r=[];for(const f of this.transform.window)n.push(f.op),i.push(this.getDefaultName(f)),r.push(f.param===void 0?null:f.param),t.push(f.field===void 0?null:f.field);const s=this.transform.frame,o=this.transform.groupby;if(s&&s[0]===null&&s[1]===null&&n.every(f=>qr(f)))return{type:"joinaggregate",as:i,ops:n,fields:t,...o!==void 0?{groupby:o}:{}};const a=[],c=[];if(this.transform.sort!==void 0)for(const f of this.transform.sort)a.push(f.field),c.push(f.order??"ascending");const u={field:a,order:c},l=this.transform.ignorePeers;return{type:"window",params:r,as:i,ops:n,fields:t,sort:u,...l!==void 0?{ignorePeers:l}:{},...o!==void 0?{groupby:o}:{},...s!==void 0?{frame:s}:{}}}}function Lb(e){function t(n){if(!(n instanceof zn)){const i=n.clone();if(i instanceof ce){const r=bo+i.getSource();i.setSource(r),e.model.component.data.outputNodes[r]=i}else(i instanceof Re||i instanceof ht||i instanceof Rn||i instanceof tn)&&i.addDimensions(e.fields);for(const r of n.children.flatMap(t))r.parent=i;return[i]}return n.children.flatMap(t)}return t}function yo(e){if(e instanceof zn)if(e.numChildren()===1&&!(e.children[0]instanceof ce)){const t=e.children[0];(t instanceof Re||t instanceof ht||t instanceof Rn||t instanceof tn)&&t.addDimensions(e.fields),t.swapWithParent(),yo(e)}else{const t=e.model.component.data.main;Bl(t);const n=Lb(e),i=e.children.map(n).flat();for(const r of i)r.parent=t}else e.children.map(yo)}function Bl(e){if(e instanceof ce&&e.type===U.Main&&e.numChildren()===1){const t=e.children[0];t instanceof zn||(t.swapWithParent(),Bl(e))}}const bo="scale_",lr=5;function xo(e){for(const t of e){for(const n of t.children)if(n.parent!==t)return!1;if(!xo(t.children))return!1}return!0}function Ie(e,t){let n=!1;for(const i of t)n=e.optimize(i)||n;return n}function Wl(e,t,n){let i=e.sources,r=!1;return r=Ie(new Cb,i)||r,r=Ie(new _b(t),i)||r,i=i.filter(s=>s.numChildren()>0),r=Ie(new Tb,i)||r,i=i.filter(s=>s.numChildren()>0),n||(r=Ie(new Nb,i)||r,r=Ie(new Pb(t),i)||r,r=Ie(new kb,i)||r,r=Ie(new Fb,i)||r,r=Ie(new Ob,i)||r,r=Ie(new Ab,i)||r,r=Ie(new Eb,i)||r,r=Ie(new zb,i)||r),e.sources=i,r}function Mb(e,t){xo(e.sources);let n=0,i=0;for(let r=0;r<lr&&Wl(e,t,!0);r++)n++;e.sources.map(yo);for(let r=0;r<lr&&Wl(e,t,!1);r++)i++;xo(e.sources),Math.max(n,i)===lr&&x(`Maximum optimization runs(${lr}) reached.`)}class me{constructor(t){Object.defineProperty(this,"signal",{enumerable:!0,get:t})}static fromName(t,n){return new me(()=>t(n))}}function Hl(e){X(e)?Db(e):jb(e)}function Db(e){const t=e.component.scales;for(const n of b(t)){const i=Bb(e,n),r=t[n];if(r.setWithExplicit("domains",i),Hb(e,n),e.component.data.isFaceted){let s=e;for(;!Le(s)&&s.parent;)s=s.parent;const o=s.component.resolve.scale[n];if(o==="shared")for(const a of i.value)lt(a)&&(a.data=bo+a.data.replace(bo,""))}}}function jb(e){for(const n of e.children)Hl(n);const t=e.component.scales;for(const n of b(t)){let i,r=null;for(const s of e.children){const o=s.component.scales[n];if(o){i===void 0?i=o.getWithExplicit("domains"):i=Tt(i,o.getWithExplicit("domains"),"domains","scale",$o);const a=o.get("selectionExtent");r&&a&&r.param!==a.param&&x(jd),r=a}}t[n].setWithExplicit("domains",i),r&&t[n].set("selectionExtent",r,!0)}}function Ub(e,t,n,i){if(e==="unaggregated"){const{valid:r,reason:s}=ql(t,n);if(!r){x(s);return}}else if(e===void 0&&i.useUnaggregatedDomain){const{valid:r}=ql(t,n);if(r)return"unaggregated"}return e}function Bb(e,t){const n=e.getScaleComponent(t).get("type"),{encoding:i}=e,r=Ub(e.scaleDomain(t),e.typedFieldDef(t),n,e.config.scale);return r!==e.scaleDomain(t)&&(e.specifiedScales[t]={...e.specifiedScales[t],domain:r}),t==="x"&&Y(i.x2)?Y(i.x)?Tt(Rt(n,r,e,"x"),Rt(n,r,e,"x2"),"domain","scale",$o):Rt(n,r,e,"x2"):t==="y"&&Y(i.y2)?Y(i.y)?Tt(Rt(n,r,e,"y"),Rt(n,r,e,"y2"),"domain","scale",$o):Rt(n,r,e,"y2"):Rt(n,r,e,t)}function Wb(e,t,n){return e.map(i=>{const r=qi(i,{timeUnit:n,type:t});return{signal:`{data: ${r}}`}})}function So(e,t,n){const i=ne(n)?.unit;return t==="temporal"||i?Wb(e,t,i):[e]}function Rt(e,t,n,i){const{encoding:r}=n,s=Y(r[i]),{type:o}=s,a=s.timeUnit;if(lg(t)){const f=Rt(e,void 0,n,i),d=So(t.unionWith,o,a);return Ze([...d,...f.value])}else{if(E(t))return Ze([t]);if(t&&t!=="unaggregated"&&!sc(t))return Ze(So(t,o,a))}const c=n.stack;if(c&&i===c.fieldChannel){if(c.offset==="normalize")return xe([[0,1]]);const f=n.requestDataName(U.Main);return xe([{data:f,field:n.vgField(i,{suffix:"start"})},{data:f,field:n.vgField(i,{suffix:"end"})}])}const u=ct(i)&&S(s)?qb(n,i,e):void 0;if(Ye(s)){const f=So([s.datum],o,a);return xe(f)}const l=s;if(t==="unaggregated"){const f=n.requestDataName(U.Main),{field:d}=s;return xe([{data:f,field:w({field:d,aggregate:"min"})},{data:f,field:w({field:d,aggregate:"max"})}])}else if(j(l.bin)){if(Z(e))return e==="bin-ordinal"?xe([]):xe([{data:jn(u)?n.requestDataName(U.Main):n.requestDataName(U.Raw),field:n.vgField(i,Zn(l,i)?{binSuffix:"range"}:{}),sort:u===!0||!M(u)?{field:n.vgField(i,{}),op:"min"}:u}]);{const{bin:f}=l;if(j(f)){const d=po(n,l.field,f);return xe([new me(()=>{const p=n.getSignalName(d);return`[${p}.start, ${p}.stop]`})])}else return xe([{data:n.requestDataName(U.Main),field:n.vgField(i,{})}])}}else if(l.timeUnit&&P(["time","utc"],e)&&kc(l,X(n)?n.encoding[He(i)]:void 0,n.markDef,n.config)){const f=n.requestDataName(U.Main);return xe([{data:f,field:n.vgField(i)},{data:f,field:n.vgField(i,{suffix:"end"})}])}else return xe(u?[{data:jn(u)?n.requestDataName(U.Main):n.requestDataName(U.Raw),field:n.vgField(i),sort:u}]:[{data:n.requestDataName(U.Main),field:n.vgField(i)}])}function wo(e,t){const{op:n,field:i,order:r}=e;return{op:n??(t?"sum":Ii),...i?{field:Se(i)}:{},...r?{order:r}:{}}}function Hb(e,t){const n=e.component.scales[t],i=e.specifiedScales[t].domain,r=e.fieldDef(t)?.bin,s=sc(i)&&i,o=Ut(r)&&_i(r.extent)&&r.extent;(s||o)&&n.set("selectionExtent",s??o,!0)}function qb(e,t,n){if(!Z(n))return;const i=e.fieldDef(t),r=i.sort;if($c(r))return{op:"min",field:On(i,t),order:"ascending"};const{stack:s}=e,o=s?new Set([...s.groupbyFields,...s.stackBy.map(a=>a.fieldDef.field)]):void 0;if(Xe(r)){const a=s&&!o.has(r.field);return wo(r,a)}else if(wc(r)){const{encoding:a,order:c}=r,u=e.fieldDef(a),{aggregate:l,field:f}=u,d=s&&!o.has(f);if(ut(l)||_t(l))return wo({field:w(u),order:c},d);if(qr(l)||!l)return wo({op:l,field:f,order:c},d)}else{if(r==="descending")return{op:"min",field:e.vgField(t),order:"descending"};if(P(["ascending",void 0],r))return!0}return}function ql(e,t){const{aggregate:n,type:i}=e;return n?F(n)&&!Ed.has(n)?{valid:!1,reason:gp(n)}:i==="quantitative"&&t==="log"?{valid:!1,reason:mp(e)}:{valid:!0}:{valid:!1,reason:pp(e)}}function $o(e,t,n,i){return e.explicit&&t.explicit&&x(Sp(n,i,e.value,t.value)),{explicit:e.explicit,value:[...e.value,...t.value]}}function Gb(e){const t=je(e.map(o=>{if(lt(o)){const{sort:a,...c}=o;return c}return o}),O),n=je(e.map(o=>{if(lt(o)){const a=o.sort;return a!==void 0&&!jn(a)&&("op"in a&&a.op==="count"&&delete a.field,a.order==="ascending"&&delete a.order),a}return}).filter(o=>o!==void 0),O);if(t.length===0)return;if(t.length===1){const o=e[0];if(lt(o)&&n.length>0){let a=n[0];if(n.length>1){x(Ua);const c=n.filter(u=>M(u)&&"op"in u&&u.op!=="min");n.every(u=>M(u)&&"op"in u)&&c.length===1?a=c[0]:a=!0}else if(M(a)&&"field"in a){const c=a.field;o.field===c&&(a=a.order?{order:a.order}:!0)}return{...o,sort:a}}return o}const i=je(n.map(o=>jn(o)||!("op"in o)||F(o.op)&&o.op in Sd?o:(x($p(o)),!0)),O);let r;i.length===1?r=i[0]:i.length>1&&(x(Ua),r=!0);const s=je(e.map(o=>lt(o)?o.data:null),o=>o);if(s.length===1&&s[0]!==null){const o={data:s[0],fields:t.map(a=>a.field),...r?{sort:r}:{}};return o}return{fields:t,...r?{sort:r}:{}}}function vo(e){if(lt(e)&&F(e.field))return e.field;if(_d(e)){let t;for(const n of e.fields)if(lt(n)&&F(n.field)){if(!t)t=n.field;else if(t!==n.field)return x(vp),t}return x(Ep),t}else if(kd(e)){x(_p);const t=e.fields[0];return F(t)?t:void 0}return}function fr(e,t){const n=e.component.scales[t],i=n.get("domains").map(r=>(lt(r)&&(r.data=e.lookupDataSource(r.data)),r));return Gb(i)}function Gl(e){return In(e)||_o(e)?e.children.reduce((t,n)=>t.concat(Gl(n)),Vl(e)):Vl(e)}function Vl(e){return b(e.component.scales).reduce((t,n)=>{const i=e.component.scales[n];if(i.merged)return t;const r=i.combine(),{name:s,type:o,selectionExtent:a,domains:c,range:u,reverse:l,...f}=r,d=Vb(r.range,s,n,e),p=fr(e,n),g=a?Uh(e,a,i,p):null;return t.push({name:s,type:o,...p?{domain:p}:{},...g?{domainRaw:g}:{},range:d,...l!==void 0?{reverse:l}:{},...f}),t},[])}function Vb(e,t,n,i){if(Q(n)){if(Ct(e))return{step:{signal:`${t}_step`}}}else if(M(e)&&lt(e))return{...e,data:i.lookupDataSource(e.data)};return e}class Xl extends gt{constructor(t,n){super({},{name:t});this.merged=!1,this.setWithExplicit("type",n)}domainDefinitelyIncludesZero(){return this.get("zero")!==!1?!0:It(this.get("domains"),t=>v(t)&&t.length===2&&t[0]<=0&&t[1]>=0)}}const Xb=["range","scheme"];function Yb(e){const t=e.component.scales;for(const n of Ei){const i=t[n];if(!i)continue;const r=Kb(n,e);i.setWithExplicit("range",r)}}function Yl(e,t){const n=e.fieldDef(t);if(n?.bin){const{bin:i,field:r}=n,s=de(t),o=e.getName(s);if(M(i)&&i.binned&&i.step!==void 0)return new me(()=>{const a=e.scaleName(t),c=`(domain("${a}")[1] - domain("${a}")[0]) / ${i.step}`;return`${e.getSignalName(o)} / (${c})`});if(j(i)){const a=po(e,r,i);return new me(()=>{const c=e.getSignalName(a),u=`(${c}.stop - ${c}.start) / ${c}.step`;return`${e.getSignalName(o)} / (${u})`})}}return}function Kb(e,t){const n=t.specifiedScales[e],{size:i}=t,r=t.getScaleComponent(e),s=r.get("type");for(const f of Xb)if(n[f]!==void 0){const d=fs(s,f),p=oc(e,f);if(!d)x(Da(s,f,e));else if(p)x(p);else switch(f){case"range":{const g=n.range;if(v(g)){if(Q(e))return Ze(g.map(m=>{if(m==="width"||m==="height"){const h=t.getName(m),y=t.getSignalName.bind(t);return me.fromName(y,h)}return m}))}else if(M(g))return Ze({data:t.requestDataName(U.Main),field:g.field,sort:{op:"min",field:t.vgField(e)}});return Ze(g)}case"scheme":return Ze(Qb(n[f]))}}const o=e===H||e==="xOffset"?"width":"height",a=i[o];if(Qe(a)){if(Q(e))if(Z(s)){const f=Kl(a,t,e);if(f)return Ze({step:f})}else x(ja(o));else if(mn(e)){const f=e===xt?"x":"y",d=t.getScaleComponent(f),p=d.get("type");if(p==="band"){const g=Ql(a,s);if(g)return Ze(g)}}}const{rangeMin:c,rangeMax:u}=n,l=Zb(e,t);return(c!==void 0||u!==void 0)&&fs(s,"rangeMin")&&v(l)&&l.length===2?Ze([c??l[0],u??l[1]]):xe(l)}function Qb(e){return ug(e)?{scheme:e.name,...ue(e,["name"])}:{scheme:e}}function Zb(e,t){const{size:n,config:i,mark:r,encoding:s}=t,o=t.getSignalName.bind(t),{type:a}=Y(s[e]),c=t.getScaleComponent(e),u=c.get("type"),{domain:l,domainMid:f}=t.specifiedScales[e];switch(e){case H:case K:{if(P(["point","band"],u)){const g=Zl(e,n,i.view);if(Qe(g)){const m=Kl(g,t,e);return{step:m}}}const d=de(e),p=t.getName(d);return e===K&&be(u)?[me.fromName(o,p),0]:[0,me.fromName(o,p)]}case xt:case dn:return Jb(e,t,u);case ot:{const d=t.component.scales[e].get("zero"),p=Jl(r,d,i),g=nx(r,n,t,i);return xn(u)?tx(p,g,ex(u,i,l,e)):[p,g]}case we:return[0,Math.PI*2];case Mt:return[0,360];case ke:return[0,new me(()=>{const d=t.getSignalName("width"),p=t.getSignalName("height");return`min(${d},${p})/2`})];case $t:return[i.scale.minStrokeWidth,i.scale.maxStrokeWidth];case vt:return[[1,0],[4,2],[2,1],[1,1],[1,2,4,2]];case fe:return"symbol";case le:case Be:case We:return u==="ordinal"?a==="nominal"?"category":"ordinal":f!==void 0?"diverging":r==="rect"||r==="geoshape"?"heatmap":"ramp";case at:case St:case wt:return[i.scale.minOpacity,i.scale.maxOpacity]}}function Kl(e,t,n){const{encoding:i}=t,r=t.getScaleComponent(n),s=jr(n),o=i[s],a=ou({step:e,offsetIsDiscrete:N(o)&&Ja(o.type)});if(a==="offset"&&Uc(i,s)){const c=t.getScaleComponent(s),u=t.scaleName(s);let l=`domain('${u}').length`;if(c.get("type")==="band"){const d=c.get("paddingInner")??c.get("padding")??0,p=c.get("paddingOuter")??c.get("padding")??0;l=`bandspace(${l}, ${d}, ${p})`}const f=r.get("paddingInner")??r.get("padding");return{signal:`${e.step} * ${l} / (1-${Td(f)})`}}else return e.step}function Ql(e,t){const n=ou({step:e,offsetIsDiscrete:Z(t)});return n==="offset"?{step:e.step}:void 0}function Jb(e,t,n){const i=e===xt?"x":"y",r=t.getScaleComponent(i),s=r.get("type"),o=t.scaleName(i);if(s==="band"){const a=Zl(i,t.size,t.config.view);if(Qe(a)){const c=Ql(a,n);if(c)return c}return[0,{signal:`bandwidth('${o}')`}]}else{const a=t.encoding[i];if(S(a)&&a.timeUnit){const c=Ka(a.timeUnit,l=>`scale('${o}', ${l})`),u=t.config.scale.bandWithNestedOffsetPaddingInner;if(u){const l=E(u)?`${u.signal}/2`:`${u/2}`,f=E(u)?`(1 - ${u.signal}/2)`:`${1-u/2}`;return[{signal:`${l} * (${c})`},{signal:`${f} * (${c})`}]}return[0,{signal:c}]}return Yo(`Cannot use ${e} scale if ${i} scale is not discrete.`)}}function Zl(e,t,n){const i=e===H?"width":"height",r=t[i];return r||Zi(n,i)}function ex(e,t,n,i){switch(e){case"quantile":return t.scale.quantileCount;case"quantize":return t.scale.quantizeCount;case"threshold":return n!==void 0&&v(n)?n.length+1:(x(zp(i)),3)}}function tx(e,t,n){const i=()=>{const r=Te(t),s=Te(e),o=`(${r} - ${s}) / (${n} - 1)`;return`sequence(${s}, ${r} + ${o}, ${o})`};return E(t)?new me(i):{signal:i()}}function Jl(e,t,n){if(t)return E(t)?{signal:`${t.signal} ? 0 : ${Jl(e,!1,n)}`}:0;switch(e){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(Ci("size",e))}const ef=.95;function nx(e,t,n,i){const r={x:Yl(n,"x"),y:Yl(n,"y")};switch(e){case"bar":case"tick":{if(i.scale.maxBandSize!==void 0)return i.scale.maxBandSize;const s=tf(t,r,i.view);return G(s)?s-1:new me(()=>`${s.signal} - 1`)}case"line":case"trail":case"rule":return i.scale.maxStrokeWidth;case"text":return i.scale.maxFontSize;case"point":case"square":case"circle":{if(i.scale.maxSize)return i.scale.maxSize;const s=tf(t,r,i.view);return G(s)?Math.pow(ef*s,2):new me(()=>`pow(${ef} * ${s.signal}, 2)`)}}throw new Error(Ci("size",e))}function tf(e,t,n){const i=Qe(e.width)?e.width.step:Qi(n,"width"),r=Qe(e.height)?e.height.step:Qi(n,"height");return t.x||t.y?new me(()=>{const s=[t.x?t.x.signal:i,t.y?t.y.signal:r];return`min(${s.join(", ")})`}):Math.min(i,r)}function nf(e,t){X(e)?ix(e,t):of(e,t)}function ix(e,t){const n=e.component.scales,{config:i,encoding:r,markDef:s,specifiedScales:o}=e;for(const a of b(n)){const c=o[a],u=n[a],l=e.getScaleComponent(a),f=Y(r[a]),d=c[t],p=l.get("type"),g=l.get("padding"),m=l.get("paddingInner"),h=fs(p,t),y=oc(a,t);if(d!==void 0&&(h?y&&x(y):x(Da(p,t,a))),h&&y===void 0)if(d!==void 0){const $=f.timeUnit,C=f.type;switch(t){case"domainMax":case"domainMin":Bt(c[t])||C==="temporal"||$?u.set(t,{signal:qi(c[t],{type:C,timeUnit:$})},!0):u.set(t,c[t],!0);break;default:u.copyKeyFromObject(t,c)}}else{const $=t in rf?rf[t]({model:e,channel:a,fieldOrDatumDef:f,scaleType:p,scalePadding:g,scalePaddingInner:m,domain:c.domain,domainMin:c.domainMin,domainMax:c.domainMax,markDef:s,config:i,hasNestedOffsetScale:_s(r,a),hasSecondaryRangeChannel:!!r[He(a)]}):i.scale[t];$!==void 0&&u.set(t,$,!1)}}}const rf={bins:({model:e,fieldOrDatumDef:t})=>S(t)?rx(e,t):void 0,interpolate:({channel:e,fieldOrDatumDef:t})=>sx(e,t.type),nice:({scaleType:e,channel:t,domain:n,domainMin:i,domainMax:r,fieldOrDatumDef:s})=>ox(e,t,n,i,r,s),padding:({channel:e,scaleType:t,fieldOrDatumDef:n,markDef:i,config:r})=>ax(e,t,r.scale,n,i,r.bar),paddingInner:({scalePadding:e,channel:t,markDef:n,scaleType:i,config:r,hasNestedOffsetScale:s})=>cx(e,t,n.type,i,r.scale,s),paddingOuter:({scalePadding:e,channel:t,scaleType:n,scalePaddingInner:i,config:r,hasNestedOffsetScale:s})=>ux(e,t,n,i,r.scale,s),reverse:({fieldOrDatumDef:e,scaleType:t,channel:n,config:i})=>{const r=S(e)?e.sort:void 0;return lx(t,r,n,i.scale)},zero:({channel:e,fieldOrDatumDef:t,domain:n,markDef:i,scaleType:r,config:s,hasSecondaryRangeChannel:o})=>fx(e,t,n,i,r,s.scale,o)};function sf(e){X(e)?Yb(e):of(e,"range")}function of(e,t){const n=e.component.scales;for(const i of e.children)t==="range"?sf(i):nf(i,t);for(const i of b(n)){let r;for(const s of e.children){const o=s.component.scales[i];if(o){const a=o.getWithExplicit(t);r=Tt(r,a,t,"scale",Au((c,u)=>{switch(t){case"range":return c.step&&u.step?c.step-u.step:0}return 0}))}}n[i].setWithExplicit(t,r)}}function rx(e,t){const n=t.bin;if(j(n)){const i=po(e,t.field,n);return new me(()=>e.getSignalName(i))}else if(te(n)&&Ut(n)&&n.step!==void 0)return{step:n.step};return}function sx(e,t){return P([le,Be,We],e)&&t!=="nominal"?"hcl":void 0}function ox(e,t,n,i,r,s){return Ke(s)?.bin||v(n)||r!=null||i!=null||P([ge.TIME,ge.UTC],e)?void 0:Q(t)?!0:void 0}function ax(e,t,n,i,r,s){if(Q(e)){if(Ae(t)){if(n.continuousPadding!==void 0)return n.continuousPadding;const{type:o,orient:a}=r;if(o==="bar"&&!(S(i)&&(i.bin||i.timeUnit))&&(a==="vertical"&&e==="x"||a==="horizontal"&&e==="y"))return s.continuousBandSize}if(t===ge.POINT)return n.pointPadding}return}function cx(e,t,n,i,r,s=!1){if(e!==void 0)return;if(Q(t)){const{bandPaddingInner:o,barBandPaddingInner:a,rectBandPaddingInner:c,bandWithNestedOffsetPaddingInner:u}=r;return s?u:V(o,n==="bar"?a:c)}else if(mn(t)&&i===ge.BAND)return r.offsetBandPaddingInner;return}function ux(e,t,n,i,r,s=!1){if(e!==void 0)return;if(Q(t)){const{bandPaddingOuter:o,bandWithNestedOffsetPaddingOuter:a}=r;if(s)return a;if(n===ge.BAND)return V(o,E(i)?{signal:`${i.signal}/2`}:i/2)}else if(mn(t)){if(n===ge.POINT)return .5;if(n===ge.BAND)return r.offsetBandPaddingOuter}return}function lx(e,t,n,i){return n==="x"&&i.xReverse!==void 0?be(e)&&t==="descending"?E(i.xReverse)?{signal:`!${i.xReverse.signal}`}:!i.xReverse:i.xReverse:be(e)&&t==="descending"?!0:void 0}function fx(e,t,n,i,r,s,o){const a=!!n&&n!=="unaggregated";if(a&&be(r)){if(v(n)){const c=n[0],u=n[n.length-1];if(c<=0&&u>=0)return!0}return!1}if(e==="size"&&t.type==="quantitative"&&!xn(r))return!0;if(!(S(t)&&t.bin)&&P([...qe,...dd],e)){const{orient:c,type:u}=i;return P(["bar","area","line","trail"],u)&&(c==="horizontal"&&e==="y"||c==="vertical"&&e==="x")?!1:P(["bar","area"],u)&&!o?!0:s?.zero}return!1}function dx(e,t,n,i,r=!1){const s=px(t,n,i,r),{type:o}=e;return ct(t)?o!==void 0?hg(t,o)?S(n)&&!mg(o,n.type)?(x(bp(o,s)),s):o:(x(yp(t,o,s)),s):s:null}function px(e,t,n,i){switch(t.type){case"nominal":case"ordinal":{if(gn(e)||Hr(e)==="discrete")return e==="shape"&&t.type==="ordinal"&&x(Kr(e,"ordinal")),"ordinal";if(Q(e)||mn(e)){if(P(["rect","bar","image","rule"],n.type))return"band";if(i)return"band"}else if(n.type==="arc"&&e in Wr)return"band";const r=n[de(e)];return qt(r)||wn(t)&&t.axis?.tickBand?"band":"point"}case"temporal":return gn(e)?"time":Hr(e)==="discrete"?(x(Kr(e,"temporal")),"ordinal"):S(t)&&t.timeUnit&&ne(t.timeUnit).utc?"utc":"time";case"quantitative":return gn(e)?S(t)&&j(t.bin)?"bin-ordinal":"linear":Hr(e)==="discrete"?(x(Kr(e,"quantitative")),"ordinal"):"linear";case"geojson":return}throw new Error(La(t.type))}function gx(e,{ignoreRange:t}={}){af(e),Hl(e);for(const n of gg)nf(e,n);t||sf(e)}function af(e){X(e)?e.component.scales=mx(e):e.component.scales=yx(e)}function mx(e){const{encoding:t,mark:n,markDef:i}=e,r={};for(const s of Ei){const o=Y(t[s]);if(o&&n===uc&&s===fe&&o.type===bn)continue;let a=o&&o.scale;if(mn(s)){const c=fa(s);if(!_s(t,c)){a&&x(ip(s));continue}}if(o&&a!==null&&a!==!1){a??(a={});const c=_s(t,s),u=dx(a,s,o,i,c);r[s]=new Xl(e.scaleName(`${s}`,!0),{value:u,explicit:a.type===u})}}return r}const hx=Au((e,t)=>ec(e)-ec(t));function yx(e){var t;const n=e.component.scales={},i={},r=e.component.resolve;for(const s of e.children){af(s);for(const o of b(s.component.scales))if((t=r.scale)[o]??(t[o]=El(o,e)),r.scale[o]==="shared"){const a=i[o],c=s.component.scales[o].getWithExplicit("type");a?rg(a.value,c.value)?i[o]=Tt(a,c,"type","scale",hx):(r.scale[o]="independent",delete i[o]):i[o]=c}}for(const s of b(i)){const o=e.scaleName(s,!0),a=i[s];n[s]=new Xl(o,a);for(const c of e.children){const u=c.component.scales[s];u&&(c.renameScale(u.get("name"),o),u.merged=!0)}}return n}class Eo{constructor(){this.nameMap={}}rename(t,n){this.nameMap[t]=n}has(t){return this.nameMap[t]!==void 0}get(t){for(;this.nameMap[t]&&t!==this.nameMap[t];)t=this.nameMap[t];return t}}function X(e){return e?.type==="unit"}function Le(e){return e?.type==="facet"}function _o(e){return e?.type==="concat"}function In(e){return e?.type==="layer"}class ko{constructor(t,n,i,r,s,o,a){this.type=n,this.parent=i,this.config=s,this.correctDataNames=c=>(c.from?.data&&(c.from.data=this.lookupDataSource(c.from.data)),c.from?.facet?.data&&(c.from.facet.data=this.lookupDataSource(c.from.facet.data)),c),this.parent=i,this.config=s,this.view=pe(a),this.name=t.name??r,this.title=kt(t.title)?{text:t.title}:t.title?pe(t.title):void 0,this.scaleNameMap=i?i.scaleNameMap:new Eo,this.projectionNameMap=i?i.projectionNameMap:new Eo,this.signalNameMap=i?i.signalNameMap:new Eo,this.data=t.data,this.description=t.description,this.transforms=Eh(t.transform??[]),this.layout=n==="layer"||n==="unit"?{}:Om(t,n,s),this.component={data:{sources:i?i.component.data.sources:[],outputNodes:i?i.component.data.outputNodes:{},outputNodeRefCounts:i?i.component.data.outputNodeRefCounts:{},isFaceted:Li(t)||i?.component.data.isFaceted&&t.data===void 0},layoutSize:new gt,layoutHeaders:{row:{},column:{},facet:{}},mark:null,resolve:{scale:{},axis:{},legend:{},...o?k(o):{}},selection:null,scales:null,projection:null,axes:{},legends:{}}}get width(){return this.getSizeSignalRef("width")}get height(){return this.getSizeSignalRef("height")}parse(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSizeSignal(),this.parseSelections(),this.parseProjection(),this.parseData(),this.parseAxesAndHeaders(),this.parseLegends(),this.parseMarkGroup()}parseScale(){gx(this)}parseProjection(){Ll(this)}renameTopLevelLayoutSizeSignal(){this.getName("width")!=="width"&&this.renameSignal(this.getName("width"),"width"),this.getName("height")!=="height"&&this.renameSignal(this.getName("height"),"height")}parseLegends(){Ol(this)}assembleEncodeFromView(t){const{style:n,...i}=t,r={};for(const s of b(i)){const o=i[s];o!==void 0&&(r[s]=B(o))}return r}assembleGroupEncodeEntry(t){let n={};return this.view&&(n=this.assembleEncodeFromView(this.view)),!t&&(this.description&&(n.description=B(this.description)),this.type==="unit"||this.type==="layer")?{width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height"),...n??{}}:I(n)?void 0:n}assembleLayout(){if(!this.layout)return;const{spacing:t,...n}=this.layout,{component:i,config:r}=this,s=My(i.layoutHeaders,r);return{padding:t,...this.assembleDefaultLayout(),...n,...s?{titleBand:s}:{}}}assembleDefaultLayout(){return{}}assembleHeaderMarks(){const{layoutHeaders:t}=this.component;let n=[];for(const i of ve)t[i].title&&n.push(Oy(this,i));for(const i of oo)n=n.concat(Py(this,i));return n}assembleAxes(){return xy(this.component.axes,this.config)}assembleLegends(){return zl(this)}assembleProjections(){return ab(this)}assembleTitle(){const{encoding:t,...n}=this.title??{},i={...xa(this.config.title).nonMarkTitleProperties,...n,...t?{encode:{update:t}}:{}};return i.text?(P(["unit","layer"],this.type)?P(["middle",void 0],i.anchor)&&(i.frame??(i.frame="group")):i.anchor??(i.anchor="start"),I(i)?void 0:i):void 0}assembleGroup(t=[]){const n={};t=t.concat(this.assembleSignals()),t.length>0&&(n.signals=t);const i=this.assembleLayout();i&&(n.layout=i),n.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());const r=!this.parent||Le(this.parent)?Gl(this):[];r.length>0&&(n.scales=r);const s=this.assembleAxes();s.length>0&&(n.axes=s);const o=this.assembleLegends();return o.length>0&&(n.legends=o),n}getName(t){return W((this.name?`${this.name}_`:"")+t)}getDataName(t){return this.getName(U[t].toLowerCase())}requestDataName(t){const n=this.getDataName(t),i=this.component.data.outputNodeRefCounts;return i[n]=(i[n]||0)+1,n}getSizeSignalRef(t){if(Le(this.parent)){const n=$l(t),i=vi(n),r=this.component.scales[i];if(r&&!r.merged){const s=r.get("type"),o=r.get("range");if(Z(s)&&Ct(o)){const a=r.get("name"),c=fr(this,i),u=vo(c);if(u){const l=w({aggregate:"distinct",field:u},{expr:"datum"});return{signal:wl(a,r,l)}}else return x(Xr(i)),null}}}return{signal:this.signalNameMap.get(this.getName(t))}}lookupDataSource(t){const n=this.component.data.outputNodes[t];return n?n.getSource():t}getSignalName(t){return this.signalNameMap.get(t)}renameSignal(t,n){this.signalNameMap.rename(t,n)}renameScale(t,n){this.scaleNameMap.rename(t,n)}renameProjection(t,n){this.projectionNameMap.rename(t,n)}scaleName(t,n){return n?this.getName(t):ca(t)&&ct(t)&&this.component.scales[t]||this.scaleNameMap.has(this.getName(t))?this.scaleNameMap.get(this.getName(t)):void 0}projectionName(t){return t?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0}getScaleComponent(t){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale(). Make sure you have called parseScale or use parseUnitModelWithScale().");const n=this.component.scales[t];return n&&!n.merged?n:this.parent?this.parent.getScaleComponent(t):void 0}getSelectionComponent(t,n){let i=this.component.selection[t];if(!i&&this.parent&&(i=this.parent.getSelectionComponent(t,n)),!i)throw new Error(Rd(n));return i}hasAxisOrientSignalRef(){return this.component.axes.x?.some(t=>t.hasOrientSignalRef())||this.component.axes.y?.some(t=>t.hasOrientSignalRef())}}class cf extends ko{vgField(t,n={}){const i=this.fieldDef(t);return i?w(i,n):void 0}reduceFieldDef(t,n){return am(this.getMapping(),(i,r,s)=>{const o=Ke(r);return o?t(i,o,s):i},n)}forEachFieldDef(t,n){Cs(this.getMapping(),(i,r)=>{const s=Ke(i);s&&t(s,r)},n)}}class dr extends R{clone(){return new dr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const i=this.transform.as??[void 0,void 0];this.transform.as=[i[0]??"value",i[1]??"density"],n.groupby&&n.minsteps==null&&n.maxsteps==null&&n.steps==null&&(this.transform.steps=200)}dependentFields(){return new Set([this.transform.density,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`DensityTransform ${O(this.transform)}`}assemble(){const{density:t,...n}=this.transform,i={type:"kde",field:t,...n};return i}}class pr extends R{clone(){return new pr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n)}dependentFields(){return new Set([this.transform.extent])}producedFields(){return new Set([])}hash(){return`ExtentTransform ${O(this.transform)}`}assemble(){const{extent:t,param:n}=this.transform,i={type:"extent",field:t,signal:n};return i}}class ai extends R{clone(){return new ai(null,{...this.filter})}constructor(t,n){super(t);this.filter=n}static make(t,n){const{config:i,mark:r,markDef:s}=n,o=z("invalid",s,i);if(o!=="filter")return null;const a=n.reduceFieldDef((c,u,l)=>{const f=ct(l)&&n.getScaleComponent(l);if(f){const d=f.get("type");be(d)&&u.aggregate!=="count"&&!Nt(r)&&(c[u.field]=u)}return c},{});return b(a).length?new ai(t,a):null}dependentFields(){return new Set(b(this.filter))}producedFields(){return new Set}hash(){return`FilterInvalid ${O(this.filter)}`}assemble(){const t=b(this.filter).reduce((n,i)=>{const r=this.filter[i],s=w(r,{expr:"datum"});return r!==null&&(r.type==="temporal"?n.push(`(isDate(${s}) || (isValid(${s}) && isFinite(+${s})))`):r.type==="quantitative"&&(n.push(`isValid(${s})`),n.push(`isFinite(+${s})`))),n},[]);return t.length>0?{type:"filter",expr:t.join(" && ")}:null}}class gr extends R{clone(){return new gr(this.parent,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const{flatten:i,as:r=[]}=this.transform;this.transform.as=i.map((s,o)=>r[o]??s)}dependentFields(){return new Set(this.transform.flatten)}producedFields(){return new Set(this.transform.as)}hash(){return`FlattenTransform ${O(this.transform)}`}assemble(){const{flatten:t,as:n}=this.transform,i={type:"flatten",fields:t,as:n};return i}}class mr extends R{clone(){return new mr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const i=this.transform.as??[void 0,void 0];this.transform.as=[i[0]??"key",i[1]??"value"]}dependentFields(){return new Set(this.transform.fold)}producedFields(){return new Set(this.transform.as)}hash(){return`FoldTransform ${O(this.transform)}`}assemble(){const{fold:t,as:n}=this.transform,i={type:"fold",fields:t,as:n};return i}}class Ln extends R{clone(){return new Ln(null,k(this.fields),this.geojson,this.signal)}static parseAll(t,n){if(n.component.projection&&!n.component.projection.isFit)return t;let i=0;for(const r of[[Ne,Ce],[$e,Fe]]){const s=r.map(o=>{const a=Y(n.encoding[o]);return S(a)?a.field:Ye(a)?{expr:`${a.datum}`}:Pe(a)?{expr:`${a.value}`}:void 0});(s[0]||s[1])&&(t=new Ln(t,s,null,n.getName(`geojson_${i++}`)))}if(n.channelHasField(fe)){const r=n.typedFieldDef(fe);r.type===bn&&(t=new Ln(t,null,r.field,n.getName(`geojson_${i++}`)))}return t}constructor(t,n,i,r){super(t);this.fields=n,this.geojson=i,this.signal=r}dependentFields(){const t=(this.fields??[]).filter(F);return new Set([...this.geojson?[this.geojson]:[],...t])}producedFields(){return new Set}hash(){return`GeoJSON ${this.geojson} ${this.signal} ${O(this.fields)}`}assemble(){return[...this.geojson?[{type:"filter",expr:`isValid(datum["${this.geojson}"])`}]:[],{type:"geojson",...this.fields?{fields:this.fields}:{},...this.geojson?{geojson:this.geojson}:{},signal:this.signal}]}}class ci extends R{clone(){return new ci(null,this.projection,k(this.fields),k(this.as))}constructor(t,n,i,r){super(t);this.projection=n,this.fields=i,this.as=r}static parseAll(t,n){if(!n.projectionName())return t;for(const i of[[Ne,Ce],[$e,Fe]]){const r=i.map(o=>{const a=Y(n.encoding[o]);return S(a)?a.field:Ye(a)?{expr:`${a.datum}`}:Pe(a)?{expr:`${a.value}`}:void 0}),s=i[0]===$e?"2":"";(r[0]||r[1])&&(t=new ci(t,n.projectionName(),r,[n.getName(`x${s}`),n.getName(`y${s}`)]))}return t}dependentFields(){return new Set(this.fields.filter(F))}producedFields(){return new Set(this.as)}hash(){return`Geopoint ${this.projection} ${O(this.fields)} ${O(this.as)}`}assemble(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}}}class nn extends R{clone(){return new nn(null,k(this.transform))}constructor(t,n){super(t);this.transform=n}dependentFields(){return new Set([this.transform.impute,this.transform.key,...this.transform.groupby??[]])}producedFields(){return new Set([this.transform.impute])}processSequence(t){const{start:n=0,stop:i,step:r}=t,s=[n,i,...r?[r]:[]].join(",");return{signal:`sequence(${s})`}}static makeFromTransform(t,n){return new nn(t,n)}static makeFromEncoding(t,n){const i=n.encoding,r=i.x,s=i.y;if(S(r)&&S(s)){const o=r.impute?r:s.impute?s:void 0;if(o===void 0)return;const a=r.impute?s:s.impute?r:void 0,{method:c,value:u,frame:l,keyvals:f}=o.impute,d=Wc(n.mark,i);return new nn(t,{impute:o.field,key:a.field,...c?{method:c}:{},...u!==void 0?{value:u}:{},...l?{frame:l}:{},...f!==void 0?{keyvals:f}:{},...d.length?{groupby:d}:{}})}return null}hash(){return`Impute ${O(this.transform)}`}assemble(){const{impute:t,key:n,keyvals:i,method:r,groupby:s,value:o,frame:a=[null,null]}=this.transform,c={type:"impute",field:t,key:n,...i?{keyvals:sh(i)?this.processSequence(i):i}:{},method:"value",...s?{groupby:s}:{},value:!r||r==="value"?o:null};if(r&&r!=="value"){const u={type:"window",as:[`imputed_${t}_value`],ops:[r],fields:[t],frame:a,ignorePeers:!1,...s?{groupby:s}:{}},l={type:"formula",expr:`datum.${t} === null ? datum.imputed_${t}_value : datum.${t}`,as:t};return[c,u,l]}else return[c]}}class hr extends R{clone(){return new hr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const i=this.transform.as??[void 0,void 0];this.transform.as=[i[0]??n.on,i[1]??n.loess]}dependentFields(){return new Set([this.transform.loess,this.transform.on,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`LoessTransform ${O(this.transform)}`}assemble(){const{loess:t,on:n,...i}=this.transform,r={type:"loess",x:n,y:t,...i};return r}}class ui extends R{clone(){return new ui(null,k(this.transform),this.secondary)}constructor(t,n,i){super(t);this.transform=n,this.secondary=i}static make(t,n,i,r){const s=n.component.data.sources,{from:o}=i;let a=null;if(oh(o)){let c=df(o.data,s);c||(c=new Jt(o.data),s.push(c));const u=n.getName(`lookup_${r}`);a=new ce(c,u,U.Lookup,n.component.data.outputNodeRefCounts),n.component.data.outputNodes[u]=a}else if(ah(o)){const c=o.param;i={as:c,...i};let u;try{u=n.getSelectionComponent(W(c),c)}catch(l){throw new Error(Md(c))}if(a=u.materialized,!a)throw new Error(Dd(c))}return new ui(t,i,a.getSource())}dependentFields(){return new Set([this.transform.lookup])}producedFields(){return new Set(this.transform.as?q(this.transform.as):this.transform.from.fields)}hash(){return`Lookup ${O({transform:this.transform,secondary:this.secondary})}`}assemble(){let t;if(this.transform.from.fields)t={values:this.transform.from.fields,...this.transform.as?{as:q(this.transform.as)}:{}};else{let n=this.transform.as;F(n)||(x(Vd),n="_lookup"),t={as:[n]}}return{type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup],...t,...this.transform.default?{default:this.transform.default}:{}}}}class yr extends R{clone(){return new yr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const i=this.transform.as??[void 0,void 0];this.transform.as=[i[0]??"prob",i[1]??"value"]}dependentFields(){return new Set([this.transform.quantile,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`QuantileTransform ${O(this.transform)}`}assemble(){const{quantile:t,...n}=this.transform,i={type:"quantile",field:t,...n};return i}}class br extends R{clone(){return new br(null,k(this.transform))}constructor(t,n){super(t);this.transform=n,this.transform=k(n);const i=this.transform.as??[void 0,void 0];this.transform.as=[i[0]??n.on,i[1]??n.regression]}dependentFields(){return new Set([this.transform.regression,this.transform.on,...this.transform.groupby??[]])}producedFields(){return new Set(this.transform.as)}hash(){return`RegressionTransform ${O(this.transform)}`}assemble(){const{regression:t,on:n,...i}=this.transform,r={type:"regression",x:n,y:t,...i};return r}}class xr extends R{clone(){return new xr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n}addDimensions(t){this.transform.groupby=je((this.transform.groupby??[]).concat(t),n=>n)}producedFields(){return}dependentFields(){return new Set([this.transform.pivot,this.transform.value,...this.transform.groupby??[]])}hash(){return`PivotTransform ${O(this.transform)}`}assemble(){const{pivot:t,value:n,groupby:i,limit:r,op:s}=this.transform;return{type:"pivot",field:t,value:n,...r!==void 0?{limit:r}:{},...s!==void 0?{op:s}:{},...i!==void 0?{groupby:i}:{}}}}class Sr extends R{clone(){return new Sr(null,k(this.transform))}constructor(t,n){super(t);this.transform=n}dependentFields(){return new Set}producedFields(){return new Set}hash(){return`SampleTransform ${O(this.transform)}`}assemble(){return{type:"sample",size:this.transform.sample}}}function uf(e){let t=0;function n(i,r){if(i instanceof Jt&&(!i.isGenerator&&!kn(i.data))){e.push(r);const s={name:null,source:r.name,transform:[]};r=s}if(i instanceof se&&(i.parent instanceof Jt&&!r.source?(r.format={...r.format??{},parse:i.assembleFormatParse()},r.transform.push(...i.assembleTransforms(!0))):r.transform.push(...i.assembleTransforms())),i instanceof zn){r.name||(r.name=`data_${t++}`),!r.source||r.transform.length>0?(e.push(r),i.data=r.name):i.data=r.source,e.push(...i.assemble());return}if((i instanceof ri||i instanceof si||i instanceof ai||i instanceof Tn||i instanceof An||i instanceof ci||i instanceof Re||i instanceof ui||i instanceof Rn||i instanceof tn||i instanceof mr||i instanceof gr||i instanceof dr||i instanceof hr||i instanceof yr||i instanceof br||i instanceof zt||i instanceof Sr||i instanceof xr||i instanceof pr)&&r.transform.push(i.assemble()),(i instanceof et||i instanceof Je||i instanceof nn||i instanceof ht||i instanceof Ln)&&r.transform.push(...i.assemble()),i instanceof ce){if(r.source&&r.transform.length===0)i.setSource(r.source);else if(i.parent instanceof ce)i.setSource(r.name);else if(r.name||(r.name=`data_${t++}`),i.setSource(r.name),i.numChildren()===1){e.push(r);const s={name:null,source:r.name,transform:[]};r=s}}switch(i.numChildren()){case 0:i instanceof ce&&(!r.source||r.transform.length>0)&&e.push(r);break;case 1:n(i.children[0],r);break;default:{r.name||(r.name=`data_${t++}`);let s=r.name;!r.source||r.transform.length>0?e.push(r):s=r.source;for(const o of i.children){const a={name:null,source:s,transform:[]};n(o,a)}break}}}return n}function bx(e){const t=[],n=uf(t);for(const i of e.children)n(i,{source:e.name,name:null,transform:[]});return t}function xx(e,t){const n=[],i=uf(n);let r=0;for(const o of e.sources){o.hasName()||(o.dataName=`source_${r++}`);const a=o.assemble();i(o,a)}for(const o of n)o.transform.length===0&&delete o.transform;let s=0;for(const[o,a]of n.entries())(a.transform??[]).length===0&&!a.source&&n.splice(s++,0,n.splice(o,1)[0]);for(const o of n)for(const a of o.transform??[])a.type==="lookup"&&(a.from=e.outputNodes[a.from].getSource());for(const o of n)o.name in t&&(o.values=t[o.name]);return n}function Sx(e){return e==="top"||e==="left"||E(e)?"header":"footer"}function wx(e){for(const t of ve)$x(e,t);ff(e,"x"),ff(e,"y")}function $x(e,t){const{facet:n,config:i,child:r,component:s}=e;if(e.channelHasField(t)){const o=n[t],a=Pn("title",null,i,t);let c=$n(o,i,{allowDisabling:!0,includeDefault:a===void 0||!!a});r.component.layoutHeaders[t].title&&(c=v(c)?c.join(", "):c,c+=` / ${r.component.layoutHeaders[t].title}`,r.component.layoutHeaders[t].title=null);const u=Pn("labelOrient",o.header,i,t),l=o.header!==null?V(o.header?.labels,i.header.labels,!0):!1,f=P(["bottom","right"],u)?"footer":"header";s.layoutHeaders[t]={title:o.header!==null?c:null,facetFieldDef:o,[f]:t==="facet"?[]:[lf(e,t,l)]}}}function lf(e,t,n){const i=t==="row"?"height":"width";return{labels:n,sizeSignal:e.child.component.layoutSize.get(i)?e.child.getSizeSignalRef(i):void 0,axes:[]}}function ff(e,t){const{child:n}=e;if(n.component.axes[t]){const{layoutHeaders:i,resolve:r}=e.component;if(r.axis[t]=lo(r,t),r.axis[t]==="shared"){const s=t==="x"?"column":"row",o=i[s];for(const a of n.component.axes[t]){const c=Sx(a.get("orient"));o[c]??(o[c]=[lf(e,s,!1)]);const u=ii(a,"main",e.config,{header:!0});u&&o[c][0].axes.push(u),a.mainExtracted=!0}}}}function vx(e){Co(e),wr(e,"width"),wr(e,"height")}function Ex(e){Co(e);const t=e.layout.columns===1?"width":"childWidth",n=e.layout.columns===void 0?"height":"childHeight";wr(e,t),wr(e,n)}function Co(e){for(const t of e.children)t.parseLayoutSize()}function wr(e,t){const n=$l(t),i=vi(n),r=e.component.resolve,s=e.component.layoutSize;let o;for(const a of e.children){const c=a.component.layoutSize.getWithExplicit(n),u=r.scale[i]??El(i,e);if(u==="independent"&&c.value==="step"){o=void 0;break}if(o){if(u==="independent"&&o.value!==c.value){o=void 0;break}o=Tt(o,c,n,"")}else o=c}if(o){for(const a of e.children)e.renameSignal(a.getName(n),e.getName(t)),a.component.layoutSize.set(n,"merged",!1);s.setWithExplicit(t,o)}else s.setWithExplicit(t,{explicit:!1,value:void 0})}function _x(e){const{size:t,component:n}=e;for(const i of qe){const r=de(i);if(t[r]){const s=t[r];n.layoutSize.set(r,Qe(s)?"step":s,!0)}else{const s=kx(e,r);n.layoutSize.set(r,s,!1)}}}function kx(e,t){const n=t==="width"?"x":"y",i=e.config,r=e.getScaleComponent(n);if(r){const s=r.get("type"),o=r.get("range");if(Z(s)){const a=Zi(i.view,t);return Ct(o)||Qe(a)?"step":a}else return Ds(i.view,t)}else{if(e.hasProjection||e.mark==="arc")return Ds(i.view,t);{const s=Zi(i.view,t);return Qe(s)?s.step:s}}}function No(e,t,n){return w(t,{suffix:`by_${w(e)}`,...n??{}})}class li extends cf{constructor(t,n,i,r){super(t,"facet",n,i,r,t.resolve);this.child=Po(t.spec,this,this.getName("child"),void 0,r),this.children=[this.child],this.facet=this.initFacet(t.facet)}initFacet(t){if(!Kn(t))return{facet:this.initFacetFieldDef(t,"facet")};const n=b(t),i={};for(const r of n){if(![nt,it].includes(r)){x(Ci(r,"facet"));break}const s=t[r];if(s.field===void 0){x(Yr(s,r));break}i[r]=this.initFacetFieldDef(s,r)}return i}initFacetFieldDef(t,n){const i=Es(t,n);return i.header?i.header=pe(i.header):i.header===null&&(i.header=null),i}channelHasField(t){return!!this.facet[t]}fieldDef(t){return this.facet[t]}parseData(){this.component.data=$r(this),this.child.parseData()}parseLayoutSize(){Co(this)}parseSelections(){this.child.parseSelections(),this.component.selection=this.child.component.selection}parseMarkGroup(){this.child.parseMarkGroup()}parseAxesAndHeaders(){this.child.parseAxesAndHeaders(),wx(this)}assembleSelectionTopLevelSignals(t){return this.child.assembleSelectionTopLevelSignals(t)}assembleSignals(){return this.child.assembleSignals(),[]}assembleSelectionData(t){return this.child.assembleSelectionData(t)}getHeaderLayoutMixins(){const t={};for(const n of ve)for(const i of ao){const r=this.component.layoutHeaders[n],s=r[i],{facetFieldDef:o}=r;if(o){const a=Pn("titleOrient",o.header,this.config,n);if(["right","bottom"].includes(a)){const c=ar(n,a);t.titleAnchor??(t.titleAnchor={}),t.titleAnchor[c]="end"}}if(s?.[0]){const a=n==="row"?"height":"width",c=i==="header"?"headerBand":"footerBand";n!=="facet"&&!this.child.component.layoutSize.get(a)&&(t[c]??(t[c]={}),t[c][n]=.5),r.title&&(t.offset??(t.offset={}),t.offset[n==="row"?"rowTitle":"columnTitle"]=10)}}return t}assembleDefaultLayout(){const{column:t,row:n}=this.facet,i=t?this.columnDistinctSignal():n?1:void 0;let r="all";return(!n&&this.component.resolve.scale.x==="independent"||!t&&this.component.resolve.scale.y==="independent")&&(r="none"),{...this.getHeaderLayoutMixins(),...i?{columns:i}:{},bounds:"full",align:r}}assembleLayoutSignals(){return this.child.assembleLayoutSignals()}columnDistinctSignal(){if(this.parent&&this.parent instanceof li)return;{const t=this.getName("column_domain");return{signal:`length(data('${t}'))`}}}assembleGroupStyle(){return}assembleGroup(t){return this.parent&&this.parent instanceof li?{...this.channelHasField("column")?{encode:{update:{columns:{field:w(this.facet.column,{prefix:"distinct"})}}}}:{},...super.assembleGroup(t)}:super.assembleGroup(t)}getCardinalityAggregateForChild(){const t=[],n=[],i=[];if(this.child instanceof li){if(this.child.channelHasField("column")){const r=w(this.child.facet.column);t.push(r),n.push("distinct"),i.push(`distinct_${r}`)}}else for(const r of qe){const s=this.child.component.scales[r];if(s&&!s.merged){const o=s.get("type"),a=s.get("range");if(Z(o)&&Ct(a)){const c=fr(this.child,r),u=vo(c);u?(t.push(u),n.push("distinct"),i.push(`distinct_${u}`)):x(Xr(r))}}}return{fields:t,ops:n,as:i}}assembleFacet(){const{name:t,data:n}=this.component.data.facetRoot,{row:i,column:r}=this.facet,{fields:s,ops:o,as:a}=this.getCardinalityAggregateForChild(),c=[];for(const l of ve){const f=this.facet[l];if(f){c.push(w(f));const{bin:d,sort:p}=f;if(j(d)&&c.push(w(f,{binSuffix:"end"})),Xe(p)){const{field:g,op:m=Ii}=p,h=No(f,p);i&&r?(s.push(h),o.push("max"),a.push(h)):(s.push(g),o.push(m),a.push(h))}else if(v(p)){const g=On(f,l);s.push(g),o.push("max"),a.push(g)}}}const u=!!i&&!!r;return{name:t,data:n,groupby:c,...u||s.length>0?{aggregate:{...u?{cross:u}:{},...s.length?{fields:s,ops:o,as:a}:{}}}:{}}}facetSortFields(t){const{facet:n}=this,i=n[t];return i?Xe(i.sort)?[No(i,i.sort,{expr:"datum"})]:v(i.sort)?[On(i,t,{expr:"datum"})]:[w(i,{expr:"datum"})]:[]}facetSortOrder(t){const{facet:n}=this,i=n[t];if(i){const{sort:r}=i,s=(Xe(r)?r.order:!v(r)&&r)||"ascending";return[s]}return[]}assembleLabelTitle(){const{facet:t,config:n}=this;if(t.facet)return co(t.facet,"facet",n);const i={row:["top","bottom"],column:["left","right"]};for(const r of oo)if(t[r]){const s=Pn("labelOrient",t[r]?.header,n,r);if(i[r].includes(s))return co(t[r],r,n)}return}assembleMarks(){const{child:t}=this,n=this.component.data.facetRoot,i=bx(n),r=t.assembleGroupEncodeEntry(!1),s=this.assembleLabelTitle()||t.assembleTitle(),o=t.assembleGroupStyle(),a={name:this.getName("cell"),type:"group",...s?{title:s}:{},...o?{style:o}:{},from:{facet:this.assembleFacet()},sort:{field:ve.map(c=>this.facetSortFields(c)).flat(),order:ve.map(c=>this.facetSortOrder(c)).flat()},...i.length>0?{data:i}:{},...r?{encode:{update:r}}:{},...t.assembleGroup(Lh(this,[]))};return[a]}getMapping(){return this.facet}}function Cx(e,t){const{row:n,column:i}=t;if(n&&i){let r=null;for(const s of[n,i])if(Xe(s.sort)){const{field:o,op:a=Ii}=s.sort;e=r=new tn(e,{joinaggregate:[{op:a,field:o,as:No(s,s.sort,{forAs:!0})}],groupby:[w(s)]})}return r}return null}function df(e,t){for(const n of t){const i=n.data;if(e.name&&n.hasName()&&e.name!==n.dataName)continue;const r=e.format?.mesh,s=i.format?.feature;if(r&&s)continue;const o=e.format?.feature;if((o||s)&&o!==s)continue;const a=i.format?.mesh;if((r||a)&&r!==a)continue;if(ei(e)&&ei(i)){if(De(e.values,i.values))return n}else if(kn(e)&&kn(i)){if(e.url===i.url)return n}else if(Ou(e)&&e.name===n.dataName)return n}return null}function Nx(e,t){if(e.data||!e.parent){if(e.data===null){const i=new Jt({values:[]});return t.push(i),i}const n=df(e.data,t);if(n)return At(e.data)||(n.data.format=Ko({},e.data.format,n.data.format)),!n.hasName()&&e.data.name&&(n.dataName=e.data.name),n;{const i=new Jt(e.data);return t.push(i),i}}else return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main}function Fx(e,t,n){let i=0;for(const r of t.transforms){let s,o;if(yh(r))o=e=new An(e,r),s="derived";else if(Hs(r)){const a=Sb(r);o=e=se.makeWithAncestors(e,{},a,n)??e,e=new Tn(e,t,r.filter)}else if(Eu(r))o=e=et.makeFromTransform(e,r,t),s="number";else if(xh(r)){s="date";const a=n.getWithExplicit(r.field);a.value===void 0&&(e=new se(e,{[r.field]:s}),n.set(r.field,s,!1)),o=e=Je.makeFromTransform(e,r)}else if(Sh(r))o=e=Re.makeFromTransform(e,r),s="number",to(t)&&(e=new zt(e));else if(vu(r))o=e=ui.make(e,t,r,i++),s="derived";else if(gh(r))o=e=new Rn(e,r),s="number";else if(mh(r))o=e=new tn(e,r),s="number";else if(wh(r))o=e=ht.makeFromTransform(e,r),s="derived";else if($h(r))o=e=new mr(e,r),s="derived";else if(vh(r))o=e=new pr(e,r),s="derived";else if(hh(r))o=e=new gr(e,r),s="derived";else if(ch(r))o=e=new xr(e,r),s="derived";else if(ph(r))e=new Sr(e,r);else if(bh(r))o=e=nn.makeFromTransform(e,r),s="derived";else if(uh(r))o=e=new dr(e,r),s="derived";else if(lh(r))o=e=new yr(e,r),s="derived";else if(fh(r))o=e=new br(e,r),s="derived";else if(dh(r))o=e=new hr(e,r),s="derived";else{x(Gd(r));continue}if(o&&s!==void 0)for(const a of o.producedFields()??[])n.set(a,s,!1)}return e}function $r(e){let t=Nx(e,e.component.data.sources);const{outputNodes:n,outputNodeRefCounts:i}=e.component.data,r=e.data,s=r&&(At(r)||kn(r)||ei(r)),o=!s&&e.parent?e.parent.component.data.ancestorParse.clone():new Rh;At(r)?(Pu(r)?t=new si(t,r.sequence):Vs(r)&&(t=new ri(t,r.graticule)),o.parseNothing=!0):r?.format?.parse===null&&(o.parseNothing=!0),t=se.makeExplicit(t,e,o)??t,t=new zt(t);const a=e.parent&&In(e.parent);(X(e)||Le(e))&&(a&&(t=et.makeFromEncoding(t,e)??t)),e.transforms.length>0&&(t=Fx(t,e,o));const c=$b(e),u=wb(e);t=se.makeWithAncestors(t,{},{...c,...u},o)??t,X(e)&&(t=Ln.parseAll(t,e),t=ci.parseAll(t,e)),(X(e)||Le(e))&&(a||(t=et.makeFromEncoding(t,e)??t),t=Je.makeFromEncoding(t,e)??t,t=An.parseAllForSortIndex(t,e));const l=e.getDataName(U.Raw),f=new ce(t,l,U.Raw,i);if(n[l]=f,t=f,X(e)){const m=Re.makeFromEncoding(t,e);m&&(t=m,to(e)&&(t=new zt(t))),t=nn.makeFromEncoding(t,e)??t,t=ht.makeFromEncoding(t,e)??t}X(e)&&(t=ai.make(t,e)??t);const d=e.getDataName(U.Main),p=new ce(t,d,U.Main,i);n[d]=p,t=p,X(e)&&yy(e,p);let g=null;if(Le(e)){const m=e.getName("facet");t=Cx(t,e.facet)??t,g=new zn(t,e,m,p.getSource()),n[m]=g}return{...e.component.data,outputNodes:n,outputNodeRefCounts:i,raw:f,main:p,facetRoot:g,ancestorParse:o}}class Tx extends ko{constructor(t,n,i,r){super(t,"concat",n,i,r,t.resolve);(t.resolve?.axis?.x==="shared"||t.resolve?.axis?.y==="shared")&&x(Wd),this.children=this.getChildren(t).map((s,o)=>Po(s,this,this.getName(`concat_${o}`),void 0,r))}parseData(){this.component.data=$r(this);for(const t of this.children)t.parseData()}parseSelections(){this.component.selection={};for(const t of this.children){t.parseSelections();for(const n of b(t.component.selection))this.component.selection[n]=t.component.selection[n]}}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxesAndHeaders(){for(const t of this.children)t.parseAxesAndHeaders()}getChildren(t){return Ki(t)?t.vconcat:Ms(t)?t.hconcat:t.concat}parseLayoutSize(){Ex(this)}parseAxisGroup(){return null}assembleSelectionTopLevelSignals(t){return this.children.reduce((n,i)=>i.assembleSelectionTopLevelSignals(n),t)}assembleSignals(){return this.children.forEach(t=>t.assembleSignals()),[]}assembleLayoutSignals(){const t=uo(this);for(const n of this.children)t.push(...n.assembleLayoutSignals());return t}assembleSelectionData(t){return this.children.reduce((n,i)=>i.assembleSelectionData(n),t)}assembleMarks(){return this.children.map(t=>{const n=t.assembleTitle(),i=t.assembleGroupStyle(),r=t.assembleGroupEncodeEntry(!1);return{type:"group",name:t.getName("group"),...n?{title:n}:{},...i?{style:i}:{},...r?{encode:{update:r}}:{},...t.assembleGroup()}})}assembleGroupStyle(){return}assembleDefaultLayout(){const t=this.layout.columns;return{...t!=null?{columns:t}:{},bounds:"full",align:"each"}}}function Ax(e){return e===!1||e===null}const Ox={disable:1,gridScale:1,scale:1,...Mc,labelExpr:1,encode:1},pf=b(Ox);class Fo extends gt{constructor(t={},n={},i=!1){super();this.explicit=t,this.implicit=n,this.mainExtracted=i}clone(){return new Fo(k(this.explicit),k(this.implicit),this.mainExtracted)}hasAxisPart(t){return t==="axis"?!0:t==="grid"||t==="title"?!!this.get(t):!Ax(this.get(t))}hasOrientSignalRef(){return E(this.explicit.orient)}}function Px(e,t,n){const{encoding:i,config:r}=e,s=Y(i[t])??Y(i[He(t)]),o=e.axis(t)||{},{format:a,formatType:c}=o;if(Vt(c))return{text:Oe({fieldOrDatumDef:s,field:"datum.value",format:a,formatType:c,config:r}),...n};if(a===void 0&&c===void 0&&r.customFormatTypes){if(Sn(s)==="quantitative"){if(wn(s)&&s.stack==="normalize"&&r.normalizedNumberFormatType)return{text:Oe({fieldOrDatumDef:s,field:"datum.value",format:r.normalizedNumberFormat,formatType:r.normalizedNumberFormatType,config:r}),...n};if(r.numberFormatType)return{text:Oe({fieldOrDatumDef:s,field:"datum.value",format:r.numberFormat,formatType:r.numberFormatType,config:r}),...n}}if(Sn(s)==="temporal"&&r.timeFormatType&&S(s)&&!s.timeUnit)return{text:Oe({fieldOrDatumDef:s,field:"datum.value",format:r.timeFormat,formatType:r.timeFormatType,config:r}),...n}}return n}function zx(e){return qe.reduce((t,n)=>(e.component.scales[n]&&(t[n]=[Ux(n,e)]),t),{})}const Rx={bottom:"top",top:"bottom",left:"right",right:"left"};function Ix(e){const{axes:t,resolve:n}=e.component,i={top:0,bottom:0,right:0,left:0};for(const r of e.children){r.parseAxesAndHeaders();for(const s of b(r.component.axes))n.axis[s]=lo(e.component.resolve,s),n.axis[s]==="shared"&&(t[s]=Lx(t[s],r.component.axes[s]),t[s]||(n.axis[s]="independent",delete t[s]))}for(const r of qe){for(const s of e.children){if(!s.component.axes[r])continue;if(n.axis[r]==="independent"){t[r]=(t[r]??[]).concat(s.component.axes[r]);for(const o of s.component.axes[r]){const{value:a,explicit:c}=o.getWithExplicit("orient");if(E(a))continue;if(i[a]>0&&!c){const u=Rx[a];i[a]>i[u]&&o.set("orient",u,!1)}i[a]++}}delete s.component.axes[r]}if(n.axis[r]==="independent"&&t[r]&&t[r].length>1)for(const s of t[r])!!s.get("grid")&&!s.explicit.grid&&(s.implicit.grid=!1)}}function Lx(e,t){if(e){if(e.length!==t.length)return;const n=e.length;for(let i=0;i<n;i++){const r=e[i],s=t[i];if(!!r!==!!s)return;if(r&&s){const o=r.getWithExplicit("orient"),a=s.getWithExplicit("orient");if(o.explicit&&a.explicit&&o.value!==a.value)return;e[i]=Mx(r,s)}}}else return t.map(n=>n.clone());return e}function Mx(e,t){for(const n of pf){const i=Tt(e.getWithExplicit(n),t.getWithExplicit(n),n,"axis",(r,s)=>{switch(n){case"title":return Na(r,s);case"gridScale":return{explicit:r.explicit,value:V(r.value,s.value)}}return er(r,s,n,"axis")});e.setWithExplicit(n,i)}return e}function Dx(e,t,n,i,r){if(t==="disable")return n!==void 0;n=n||{};switch(t){case"titleAngle":case"labelAngle":return e===(E(n.labelAngle)?n.labelAngle:Wn(n.labelAngle));case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(e===hl(i,r))return!0}return e===n[t]}const jx=new Set(["grid","translate","format","formatType","orient","labelExpr","tickCount","position","tickMinStep"]);function Ux(e,t){let n=t.axis(e);const i=new Fo,r=Y(t.encoding[e]),{mark:s,config:o}=t,a=n?.orient||o[e==="x"?"axisX":"axisY"]?.orient||o.axis?.orient||Cy(e),c=t.getScaleComponent(e).get("type"),u=Sy(e,c,a,t.config),l=n!==void 0?!n:ro("disable",o.style,n?.style,u).configValue;if(i.set("disable",l,n!==void 0),l)return i;n=n||{};const f=Ey(r,n,e,o.style,u),d=yc(n.formatType,r,c),p=hc(r,r.type,n.format,n.formatType,o,!0),g={fieldOrDatumDef:r,axis:n,channel:e,model:t,scaleType:c,orient:a,labelAngle:f,format:p,formatType:d,mark:s,config:o};for(const y of pf){const $=y in pl?pl[y](g):Dc(y)?n[y]:void 0,C=$!==void 0,_=Dx($,y,n,t,e);if(C&&_)i.set(y,$,_);else{const{configValue:T=void 0,configFrom:L=void 0}=Dc(y)&&y!=="values"?ro(y,o.style,n.style,u):{},he=T!==void 0;C&&!he?i.set(y,$,_):(!(L==="vgAxisConfig")||jx.has(y)&&he||Jn(T)||E(T))&&i.set(y,T,!1)}}const m=n.encoding??{},h=Lc.reduce((y,$)=>{if(!i.hasAxisPart($))return y;const C=vl(m[$]??{},t),_=$==="labels"?Px(t,e,C):C;return _!==void 0&&!I(_)&&(y[$]={update:_}),y},{});return I(h)||i.set("encode",h,!!n.encoding||n.labelAngle!==void 0),i}function Bx({encoding:e,size:t}){for(const n of qe){const i=de(n);Qe(t[i])&&(Ft(e[n])&&(delete t[i],x(ja(i))))}return t}function Wx(e,t,n){const i=pe(e),r=z("orient",i,n);if(i.orient=Vx(i.type,t,r),r!==void 0&&r!==i.orient&&x(lp(i.orient,r)),i.type==="bar"&&i.orient){const a=z("cornerRadiusEnd",i,n);if(a!==void 0){const c=i.orient==="horizontal"&&t.x2||i.orient==="vertical"&&t.y2?["cornerRadius"]:Ng[i.orient];for(const u of c)i[u]=a;i.cornerRadiusEnd!==void 0&&delete i.cornerRadiusEnd}}const s=z("opacity",i,n);s===void 0&&(i.opacity=qx(i.type,t));const o=z("cursor",i,n);return o===void 0&&(i.cursor=Hx(i,t,n)),i}function Hx(e,t,n){return t.href||e.href||z("href",e,n)?"pointer":e.cursor}function qx(e,t){return P([Pi,ds,ps,gs],e)&&!ks(t)?.7:void 0}function Gx(e,t,{graticule:n}){if(n)return!1;const i=ft("filled",e,t),r=e.type;return V(i,r!==Pi&&r!==Oi&&r!==zi)}function Vx(e,t,n){switch(e){case Pi:case ps:case gs:case cc:case bg:case yg:return}const{x:i,y:r,x2:s,y2:o}=t;switch(e){case Ai:if(S(i)&&(te(i.bin)||S(r)&&r.aggregate&&!i.aggregate))return"vertical";if(S(r)&&(te(r.bin)||S(i)&&i.aggregate&&!r.aggregate))return"horizontal";if(o||s){if(n)return n;if(!s)return(S(i)&&i.type===Ht&&!j(i.bin)||ji(i))&&(S(r)&&te(r.bin))?"horizontal":"vertical";if(!o)return(S(r)&&r.type===Ht&&!j(r.bin)||ji(r))&&(S(i)&&te(i.bin))?"vertical":"horizontal"}case zi:if(s&&!(S(i)&&te(i.bin))&&o&&!(S(r)&&te(r.bin)))return;case Ti:if(o)return S(r)&&te(r.bin)?"horizontal":"vertical";if(s)return S(i)&&te(i.bin)?"vertical":"horizontal";if(e===zi){if(i&&!r)return"vertical";if(r&&!i)return"horizontal"}case Oi:case ds:{const a=Nc(i),c=Nc(r);if(n)return n;if(a&&!c)return e!=="tick"?"horizontal":"vertical";if(!a&&c)return e!=="tick"?"vertical":"horizontal";if(a&&c)return"vertical";{const u=ae(i)&&i.type===yn,l=ae(r)&&r.type===yn;if(u&&!l)return"vertical";if(!u&&l)return"horizontal"}return}}return"vertical"}const Xx={vgMark:"arc",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"}),...re("x",e,{defaultPos:"mid"}),...re("y",e,{defaultPos:"mid"}),...Ot(e,"radius"),...Ot(e,"theta")})},Yx={vgMark:"area",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",orient:"include",size:"ignore",theta:"ignore"}),...nr("x",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="horizontal"}),...nr("y",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="vertical"}),...Js(e)})},Kx={vgMark:"rect",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...Ot(e,"x"),...Ot(e,"y")})},Qx={vgMark:"shape",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})}),postEncodingTransform:e=>{const{encoding:t}=e,n=t.shape,i={type:"geoshape",projection:e.projectionName(),...n&&S(n)&&n.type===bn?{field:w(n,{expr:"datum"})}:{}};return[i]}},Zx={vgMark:"image",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"ignore",orient:"ignore",size:"ignore",theta:"ignore"}),...Ot(e,"x"),...Ot(e,"y"),...Qs(e,"url")})},Jx={vgMark:"line",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"}),...re("x",e,{defaultPos:"mid"}),...re("y",e,{defaultPos:"mid"}),...J("size",e,{vgChannel:"strokeWidth"}),...Js(e)})},eS={vgMark:"trail",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"}),...re("x",e,{defaultPos:"mid"}),...re("y",e,{defaultPos:"mid"}),...J("size",e),...Js(e)})};function To(e,t){const{config:n}=e;return{...Ee(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"}),...re("x",e,{defaultPos:"mid"}),...re("y",e,{defaultPos:"mid"}),...J("size",e),...J("angle",e),...tS(e,n,t)}}function tS(e,t,n){return n?{shape:{value:n}}:J("shape",e)}const nS={vgMark:"symbol",encodeEntry:e=>To(e)},iS={vgMark:"symbol",encodeEntry:e=>To(e,"circle")},rS={vgMark:"symbol",encodeEntry:e=>To(e,"square")},sS={vgMark:"rect",encodeEntry:e=>({...Ee(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...Ot(e,"x"),...Ot(e,"y")})},oS={vgMark:"rule",encodeEntry:e=>{const{markDef:t}=e,n=t.orient;return!e.encoding.x&&!e.encoding.y&&!e.encoding.latitude&&!e.encoding.longitude?{}:{...Ee(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...nr("x",e,{defaultPos:n==="horizontal"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="vertical"}),...nr("y",e,{defaultPos:n==="vertical"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="horizontal"}),...J("size",e,{vgChannel:"strokeWidth"})}}},aS={vgMark:"text",encodeEntry:e=>{const{config:t,encoding:n}=e;return{...Ee(e,{align:"include",baseline:"include",color:"include",size:"ignore",orient:"ignore",theta:"include"}),...re("x",e,{defaultPos:"mid"}),...re("y",e,{defaultPos:"mid"}),...Qs(e),...J("size",e,{vgChannel:"fontSize"}),...J("angle",e),...Xu("align",cS(e.markDef,n,t)),...Xu("baseline",uS(e.markDef,n,t)),...re("radius",e,{defaultPos:null}),...re("theta",e,{defaultPos:null})}}};function cS(e,t,n){const i=z("align",e,n);return i===void 0?"center":void 0}function uS(e,t,n){const i=z("baseline",e,n);return i===void 0?"middle":void 0}const lS={vgMark:"rect",encodeEntry:e=>{const{config:t,markDef:n}=e,i=n.orient,r=i==="horizontal"?"width":"height",s=i==="horizontal"?"height":"width";return{...Ee(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"}),...re("x",e,{defaultPos:"mid",vgChannel:"xc"}),...re("y",e,{defaultPos:"mid",vgChannel:"yc"}),...J("size",e,{defaultValue:fS(e),vgChannel:r}),[s]:B(z("thickness",n,t))}}};function fS(e){const{config:t,markDef:n}=e,{orient:i}=n,r=i==="horizontal"?"width":"height",s=e.getScaleComponent(i==="horizontal"?"x":"y"),o=z("size",n,t,{vgChannel:r})??t.tick.bandSize;if(o!==void 0)return o;{const a=s?s.get("range"):void 0;if(a&&Ct(a)&&G(a.step))return a.step*3/4;const c=Qi(t.view,r);return c*3/4}}const vr={arc:Xx,area:Yx,bar:Kx,circle:iS,geoshape:Qx,image:Zx,line:Jx,point:nS,rect:sS,rule:oS,square:rS,text:aS,tick:lS,trail:eS};function dS(e){if(P([Oi,Ti,xg],e.mark)){const t=Wc(e.mark,e.encoding);if(t.length>0)return pS(e,t)}else if(e.mark===Ai){const t=Gr.some(n=>z(n,e.markDef,e.config));if(e.stack&&!e.fieldDef("size")&&t)return gS(e)}return Ao(e)}const gf="faceted_path_";function pS(e,t){return[{name:e.getName("pathgroup"),type:"group",from:{facet:{name:gf+e.requestDataName(U.Main),data:e.requestDataName(U.Main),groupby:t}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:Ao(e,{fromPrefix:gf})}]}const mf="stack_group_";function gS(e){const[t]=Ao(e,{fromPrefix:mf}),n=e.scaleName(e.stack.fieldChannel),i=(u={})=>e.vgField(e.stack.fieldChannel,u),r=(u,l)=>{const f=[i({prefix:"min",suffix:"start",expr:l}),i({prefix:"max",suffix:"start",expr:l}),i({prefix:"min",suffix:"end",expr:l}),i({prefix:"max",suffix:"end",expr:l})];return`${u}(${f.map(d=>`scale('${n}',${d})`).join(",")})`};let s,o;e.stack.fieldChannel==="x"?(s={...ln(t.encode.update,["y","yc","y2","height",...Gr]),x:{signal:r("min","datum")},x2:{signal:r("max","datum")},clip:{value:!0}},o={x:{field:{group:"x"},mult:-1},height:{field:{group:"height"}}},t.encode.update={...ue(t.encode.update,["y","yc","y2"]),height:{field:{group:"height"}}}):(s={...ln(t.encode.update,["x","xc","x2","width"]),y:{signal:r("min","datum")},y2:{signal:r("max","datum")},clip:{value:!0}},o={y:{field:{group:"y"},mult:-1},width:{field:{group:"width"}}},t.encode.update={...ue(t.encode.update,["x","xc","x2"]),width:{field:{group:"width"}}});for(const u of Gr){const l=ft(u,e.markDef,e.config);t.encode.update[u]?(s[u]=t.encode.update[u],delete t.encode.update[u]):l&&(s[u]=B(l)),l&&(t.encode.update[u]={value:0})}const a=[];if(e.stack.groupbyChannels?.length>0)for(const u of e.stack.groupbyChannels){const l=e.fieldDef(u),f=w(l);f&&a.push(f),(l?.bin||l?.timeUnit)&&a.push(w(l,{binSuffix:"end"}))}const c=["stroke","strokeWidth","strokeJoin","strokeCap","strokeDash","strokeDashOffset","strokeMiterLimit","strokeOpacity"];return s=c.reduce((u,l)=>{if(t.encode.update[l])return{...u,[l]:t.encode.update[l]};{const f=ft(l,e.markDef,e.config);return f!==void 0?{...u,[l]:B(f)}:u}},s),s.stroke&&(s.strokeForeground={value:!0},s.strokeOffset={value:0}),[{type:"group",from:{facet:{data:e.requestDataName(U.Main),name:mf+e.requestDataName(U.Main),groupby:a,aggregate:{fields:[i({suffix:"start"}),i({suffix:"start"}),i({suffix:"end"}),i({suffix:"end"})],ops:["min","max","min","max"]}}},encode:{update:s},marks:[{type:"group",encode:{update:o},marks:[t]}]}]}function mS(e){const{encoding:t,stack:n,mark:i,markDef:r,config:s}=e,o=t.order;if(!v(o)&&Pe(o)&&Tr(o.value)||!o&&Tr(z("order",r,s)))return;if((v(o)||S(o))&&!n)return _a(o,{expr:"datum"});if(Nt(i)){const a=r.orient==="horizontal"?"y":"x",c=t[a];if(S(c)){const u=c.sort;if(v(u))return{field:w(c,{prefix:a,suffix:"sort_index",expr:"datum"})};if(Xe(u))return{field:w({aggregate:ks(e.encoding)?u.op:void 0,field:u.field},{expr:"datum"})};if(wc(u)){const l=e.fieldDef(u.encoding);return{field:w(l,{expr:"datum"}),order:u.order}}else return u===null?void 0:{field:w(c,{binSuffix:e.stack?.impute?"mid":void 0,expr:"datum"})}}return}return}function Ao(e,t={fromPrefix:""}){const{mark:n,markDef:i,encoding:r,config:s}=e,o=V(i.clip,hS(e),yS(e)),a=va(i),c=r.key,u=mS(e),l=bS(e),f=z("aria",i,s),d=vr[n].postEncodingTransform?vr[n].postEncodingTransform(e):null;return[{name:e.getName("marks"),type:vr[n].vgMark,...o?{clip:!0}:{},...a?{style:a}:{},...c?{key:c.field}:{},...u?{sort:u}:{},...l||{},...f===!1?{aria:f}:{},from:{data:t.fromPrefix+e.requestDataName(U.Main)},encode:{update:vr[n].encodeEntry(e)},...d?{transform:d}:{}}]}function hS(e){const t=e.getScaleComponent("x"),n=e.getScaleComponent("y");return t?.get("selectionExtent")||n?.get("selectionExtent")?!0:void 0}function yS(e){const t=e.component.projection;return t&&!t.isFit?!0:void 0}function bS(e){if(!e.component.selection)return null;const t=b(e.component.selection).length;let n=t,i=e.parent;for(;i&&n===0;)n=b(i.component.selection).length,i=i.parent;return n?{interactive:t>0||e.mark==="geoshape"||!!e.encoding.tooltip}:null}class hf extends cf{constructor(t,n,i,r={},s){super(t,"unit",n,i,s,void 0,au(t)?t.view:void 0);this.specifiedScales={},this.specifiedAxes={},this.specifiedLegends={},this.specifiedProjection={},this.selection=[],this.children=[];const o=Ve(t.mark)?{...t.mark}:{type:t.mark},a=o.type;o.filled===void 0&&(o.filled=Gx(o,s,{graticule:t.data&&Vs(t.data)}));const c=this.encoding=sm(t.encoding||{},a,o.filled,s);this.markDef=Wx(o,c,s),this.size=Bx({encoding:c,size:au(t)?{...r,...t.width?{width:t.width}:{},...t.height?{height:t.height}:{}}:r}),this.stack=mu(this.markDef,c),this.specifiedScales=this.initScales(a,c),this.specifiedAxes=this.initAxes(c),this.specifiedLegends=this.initLegends(c),this.specifiedProjection=t.projection,this.selection=(t.params??[]).filter(u=>Is(u))}get hasProjection(){const{encoding:t}=this,n=this.mark===uc,i=t&&rd.some(r=>N(t[r]));return n||i}scaleDomain(t){const n=this.specifiedScales[t];return n?n.domain:void 0}axis(t){return this.specifiedAxes[t]}legend(t){return this.specifiedLegends[t]}initScales(t,n){return Ei.reduce((i,r)=>{const s=Y(n[r]);return s&&(i[r]=this.initScale(s.scale??{})),i},{})}initScale(t){const{domain:n,range:i}=t,r=pe(t);return v(n)&&(r.domain=n.map(ye)),v(i)&&(r.range=i.map(ye)),r}initAxes(t){return qe.reduce((n,i)=>{const r=t[i];if(N(r)||i===H&&N(t.x2)||i===K&&N(t.y2)){const s=N(r)?r.axis:void 0;n[i]=s&&this.initAxis({...s})}return n},{})}initAxis(t){const n=b(t),i={};for(const r of n){const s=t[r];i[r]=Jn(s)?Sa(s):ye(s)}return i}initLegends(t){return pd.reduce((n,i)=>{const r=Y(t[i]);if(r&&md(i)){const s=r.legend;n[i]=s&&pe(s)}return n},{})}parseData(){this.component.data=$r(this)}parseLayoutSize(){_x(this)}parseSelections(){this.component.selection=hy(this,this.selection)}parseMarkGroup(){this.component.mark=dS(this)}parseAxesAndHeaders(){this.component.axes=zx(this)}assembleSelectionTopLevelSignals(t){return Mh(this,t)}assembleSignals(){return[...fl(this),...Ih(this,[])]}assembleSelectionData(t){return Dh(this,t)}assembleLayout(){return null}assembleLayoutSignals(){return uo(this)}assembleMarks(){let t=this.component.mark??[];return(!this.parent||!In(this.parent))&&(t=Iu(this,t)),t.map(this.correctDataNames)}assembleGroupStyle(){const{style:t}=this.view||{};return t!==void 0?t:this.encoding.x||this.encoding.y?"cell":"view"}getMapping(){return this.encoding}get mark(){return this.markDef.type}channelHasField(t){return Yt(this.encoding,t)}fieldDef(t){const n=this.encoding[t];return Ke(n)}typedFieldDef(t){const n=this.fieldDef(t);return ae(n)?n:null}}class Oo extends ko{constructor(t,n,i,r,s){super(t,"layer",n,i,s,t.resolve,t.view);const o={...r,...t.width?{width:t.width}:{},...t.height?{height:t.height}:{}};this.children=t.layer.map((a,c)=>{if(Ji(a))return new Oo(a,this,this.getName(`layer_${c}`),o,s);if(dt(a))return new hf(a,this,this.getName(`layer_${c}`),o,s);throw new Error(Vr(a))})}parseData(){this.component.data=$r(this);for(const t of this.children)t.parseData()}parseLayoutSize(){vx(this)}parseSelections(){this.component.selection={};for(const t of this.children){t.parseSelections();for(const n of b(t.component.selection))this.component.selection[n]=t.component.selection[n]}}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxesAndHeaders(){Ix(this)}assembleSelectionTopLevelSignals(t){return this.children.reduce((n,i)=>i.assembleSelectionTopLevelSignals(n),t)}assembleSignals(){return this.children.reduce((t,n)=>t.concat(n.assembleSignals()),fl(this))}assembleLayoutSignals(){return this.children.reduce((t,n)=>t.concat(n.assembleLayoutSignals()),uo(this))}assembleSelectionData(t){return this.children.reduce((n,i)=>i.assembleSelectionData(n),t)}assembleGroupStyle(){const t=new Set;for(const i of this.children)for(const r of q(i.assembleGroupStyle()))t.add(r);const n=Array.from(t);return n.length>1?n:n.length===1?n[0]:void 0}assembleTitle(){let t=super.assembleTitle();if(t)return t;for(const n of this.children)if(t=n.assembleTitle(),t)return t;return}assembleLayout(){return null}assembleMarks(){return jh(this,this.children.flatMap(t=>t.assembleMarks()))}assembleLegends(){return this.children.reduce((t,n)=>t.concat(n.assembleLegends()),zl(this))}}function Po(e,t,n,i,r){if(Li(e))return new li(e,t,n,r);if(Ji(e))return new Oo(e,t,n,i,r);if(dt(e))return new hf(e,t,n,i,r);if(Fm(e))return new Tx(e,t,n,r);throw new Error(Vr(e))}function xS(e,t={}){t.logger&&Rp(t.logger),t.fieldTitle&&Pc(t.fieldTitle);try{const n=pu(Vo(t.config,e.config)),i=Nu(e,n),r=Po(i,null,"",void 0,n);r.parse(),Mb(r.component.data,r);const s=wS(r,SS(e,i.autosize,n,r),e.datasets,e.usermeta);return{spec:s,normalized:i}}finally{t.logger&&Ip(),t.fieldTitle&&Kg()}}function SS(e,t,n,i){const r=i.component.layoutSize.get("width"),s=i.component.layoutSize.get("height");if(t===void 0?(t={type:"pad"},i.hasAxisOrientSignalRef()&&(t.resize=!0)):F(t)&&(t={type:t}),r&&s&&Oh(t.type)){if(r==="step"&&s==="step")x(Aa()),t.type="pad";else if(r==="step"||s==="step"){const o=r==="step"?"width":"height";x(Aa(vi(o)));const a=o==="width"?"height":"width";t.type=Ph(a)}}return{...b(t).length===1&&t.type?t.type==="pad"?{}:{autosize:t.type}:{autosize:t},...Tu(n,!1),...Tu(e,!0)}}function wS(e,t,n={},i){const r=e.config?Wm(e.config):void 0,s=[].concat(e.assembleSelectionData([]),xx(e.component.data,n)),o=e.assembleProjections(),a=e.assembleTitle(),c=e.assembleGroupStyle(),u=e.assembleGroupEncodeEntry(!0);let l=e.assembleLayoutSignals();l=l.filter(p=>(p.name==="width"||p.name==="height")&&p.value!==void 0?(t[p.name]=+p.value,!1):!0);const{params:f,...d}=t;return{$schema:"https://vega.github.io/schema/vega/v5.json",...e.description?{description:e.description}:{},...d,...a?{title:a}:{},...c?{style:c}:{},...u?{encode:{update:u}}:{},data:s,...o.length>0?{projections:o}:{},...e.assembleGroup([...l,...e.assembleSelectionTopLevelSignals([]),...su(f)]),...r?{config:r}:{},...i?{usermeta:i}:{}}}const $S=Zf.version;export{fn as accessPathDepth,Rr as accessPathWithDatum,xS as compile,P as contains,De as deepEqual,hi as deleteNestedProperty,k as duplicate,bt as entries,Ar as every,zr as fieldIntersection,Zo as flatAccessWithDatum,V as getFirstDefined,Or as hasIntersection,O as hash,ta as internalField,jn as isBoolean,I as isEmpty,ed as isEqual,na as isInternalField,Tr as isNullOrFalse,yi as isNumeric,b as keys,Un as logicalExpr,Ko as mergeDeep,Yo as never,Nu as normalize,Wn as normalizeAngle,ue as omit,ln as pick,Pr as prefixGenerator,Ir as removePathFromField,Lt as replaceAll,Se as replacePathInField,nd as resetIdCounter,Qo as setEqual,It as some,D as stringify,Bn as titleCase,je as unique,ea as uniqueId,ee as vals,W as varName,$S as version};export default null;
