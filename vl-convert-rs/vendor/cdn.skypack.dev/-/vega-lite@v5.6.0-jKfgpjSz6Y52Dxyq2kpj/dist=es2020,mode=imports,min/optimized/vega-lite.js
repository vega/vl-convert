import{hasOwnProperty as sn,isNumber as Y,isString as N,writeConfig as Ef,splitAccessPath as on,stringValue as I,isObject as H,isBoolean as Un,isArray as j,array as V,logger as kf,Warn as Cf,isFunction as Ff,mergeConfig as ta,identity as Nf}from"/-/vega-util@v1.17.0-uRskU0IBL2vWCP4Va8OC/dist=es2020,mode=imports,min/optimized/vega-util.js";import Pf from"/-/clone@v2.1.2-inH2VLNzDGiYU9HUWyZM/dist=es2020,mode=imports,min/optimized/clone.js";import Tf from"/-/fast-deep-equal@v3.1.3-ysejKs1WDEDPxUJhgGoP/dist=es2020,mode=imports,min/optimized/fast-deep-equal.js";import Tr from"/-/fast-json-stable-stringify@v2.1.0-HLgsuOtxPikt0pw16nth/dist=es2020,mode=imports,min/optimized/fast-json-stable-stringify.js";import{isObject as na,writeConfig as Af,isArray as ia,isString as Si}from"/-/vega@v5.22.1-1GozmoxV3boOt3w4YuEn/dist=es2020,mode=imports,min/optimized/vega.js";import{parseSelector as an}from"/-/vega-event-selector@v3.0.0-l4odHnkvkuEDkNxAGBfX/dist=es2020,mode=imports,min/optimized/vega-event-selector.js";import{parseExpression as zf}from"/-/vega-expression@v5.0.0-kP0F2avA8xgwhtleXksI/dist=es2020,mode=imports,min/optimized/vega-expression.js";const If="vega-lite",Rf='Dominik Moritz, Kanit "Ham" Wongsuphasawat, Arvind Satyanarayan, Jeffrey Heer',Lf="5.5.0",Mf=["Kanit Wongsuphasawat (http://kanitw.yellowpigz.com)","Dominik Moritz (https://www.domoritz.de)","Arvind Satyanarayan (https://arvindsatya.com)","Jeffrey Heer (https://jheer.org)"],Df="https://vega.github.io/vega-lite/",Uf="Vega-Lite is a concise high-level language for interactive visualization.",Wf=["vega","chart","visualization"],Bf="build/vega-lite.js",Hf="build/vega-lite.min.js",qf="build/vega-lite.min.js",Gf="build/src/index",Vf="build/src/index.d.ts",Xf={vl2png:"./bin/vl2png",vl2svg:"./bin/vl2svg",vl2pdf:"./bin/vl2pdf",vl2vg:"./bin/vl2vg"},Yf=["bin","build","src","vega-lite*","tsconfig.json"],Kf={changelog:"conventional-changelog -p angular -r 2",prebuild:"yarn clean:build",build:"yarn build:only","build:only":"tsc -p tsconfig.build.json && rollup -c","prebuild:examples":"yarn build:only","build:examples":"yarn data && TZ=America/Los_Angeles scripts/build-examples.sh","prebuild:examples-full":"yarn build:only","build:examples-full":"TZ=America/Los_Angeles scripts/build-examples.sh 1","build:example":"TZ=America/Los_Angeles scripts/build-example.sh","build:toc":"yarn build:jekyll && scripts/generate-toc","build:site":"rollup -c site/rollup.config.js","build:jekyll":"pushd site && bundle exec jekyll build -q && popd","build:versions":"scripts/update-version.sh",clean:"yarn clean:build && del-cli 'site/data/*' 'examples/compiled/*.png' && find site/examples ! -name 'index.md' ! -name 'data' -type f -delete","clean:build":"del-cli 'build/*' !build/vega-lite-schema.json","predeploy:site":"yarn presite","deploy:site":"gh-pages -d site",data:"rsync -r node_modules/vega-datasets/data/* site/data",schema:"mkdir -p build && ts-json-schema-generator -f tsconfig.json -p src/index.ts -t TopLevelSpec --no-type-check --no-ref-encode > build/vega-lite-schema.json && yarn renameschema && cp build/vega-lite-schema.json site/_data/",renameschema:"scripts/rename-schema.sh",presite:"yarn data && yarn schema && yarn build:site && yarn build:versions && scripts/create-example-pages.sh",site:"yarn site:only","site:only":"pushd site && bundle exec jekyll serve -I -l && popd",prettierbase:"prettier '**/*.{md,css,yml}'",eslintbase:"eslint .",format:"yarn eslintbase --fix && yarn prettierbase --write",lint:"yarn eslintbase && yarn prettierbase --check",jest:"NODE_OPTIONS=--experimental-vm-modules npx jest",test:"yarn jest test/ && yarn lint && yarn schema && yarn jest examples/ && yarn test:runtime","test:cover":"yarn jest --collectCoverage test/","test:inspect":"node --inspect-brk --experimental-vm-modules ./node_modules/.bin/jest --runInBand test","test:runtime":"NODE_OPTIONS=--experimental-vm-modules TZ=America/Los_Angeles npx jest test-runtime/ --config test-runtime/jest-config.json","test:runtime:generate":"yarn build:only && del-cli test-runtime/resources && VL_GENERATE_TESTS=true yarn test:runtime",watch:"tsc -p tsconfig.build.json -w","watch:site":"yarn build:site -w","watch:test":"yarn jest --watch test/","watch:test:runtime":"NODE_OPTIONS=--experimental-vm-modules TZ=America/Los_Angeles npx jest --watch test-runtime/ --config test-runtime/jest-config.json",release:"yarn run prebuild && yarn build && yarn shipit",shipit:"auto shipit"},Qf={type:"git",url:"https://github.com/vega/vega-lite.git"},Zf="BSD-3-Clause",Jf={url:"https://github.com/vega/vega-lite/issues"},ed={"@auto-it/conventional-commits":"^10.37.6","@auto-it/first-time-contributor":"^10.37.6","@babel/core":"^7.19.1","@babel/preset-env":"^7.19.1","@babel/preset-typescript":"^7.18.6","@rollup/plugin-alias":"^4.0.0","@rollup/plugin-babel":"^6.0.0","@rollup/plugin-commonjs":"^23.0.0","@rollup/plugin-json":"^4.1.0","@types/jest":"^27.4.1","@rollup/plugin-node-resolve":"^14.1.0","@types/chai":"^4.3.3","@types/d3":"^7.4.0","@types/mkdirp":"^1.0.2","@types/pako":"^2.0.0","@typescript-eslint/eslint-plugin":"^5.38.0","@typescript-eslint/parser":"^5.38.0",ajv:"^8.11.0","ajv-formats":"^2.1.1",auto:"^10.37.6",chai:"^4.3.6",cheerio:"^1.0.0-rc.12","conventional-changelog-cli":"^2.2.2",d3:"^7.6.1","del-cli":"^5.0.0",eslint:"^8.23.1","eslint-config-prettier":"^8.5.0","eslint-plugin-jest":"^27.0.4","eslint-plugin-prettier":"^4.2.1","gh-pages":"^4.0.0",jest:"^27.5.1","highlight.js":"^11.6.0","jest-dev-server":"^6.1.1",mkdirp:"^1.0.4",pako:"^2.0.4",prettier:"^2.7.1",puppeteer:"^15.0.0",rollup:"^2.79.1","rollup-plugin-bundle-size":"^1.0.3","rollup-plugin-sourcemaps":"^0.6.3","rollup-plugin-terser":"^7.0.2",serve:"^14.0.1",terser:"^5.15.0","ts-jest":"^29.0.1","ts-json-schema-generator":"^1.1.1","vega-cli":"^5.22.1",typescript:"~4.8.3","vega-datasets":"~2.5.1","vega-embed":"^6.21.0","vega-tooltip":"^0.28.0","yaml-front-matter":"^4.1.1"},td={"@types/clone":"~2.1.1",clone:"~2.1.2","fast-deep-equal":"~3.1.3","fast-json-stable-stringify":"~2.1.0","json-stringify-pretty-compact":"~3.0.0",tslib:"~2.4.0","vega-event-selector":"~3.0.0","vega-expression":"~5.0.0","vega-util":"~1.17.0",yargs:"~17.6.0"},nd={vega:"^5.22.0"},id={node:">=12"};var rd={name:If,author:Rf,version:Lf,collaborators:Mf,homepage:Df,description:Uf,keywords:Wf,main:Bf,unpkg:Hf,jsdelivr:qf,module:Gf,types:Vf,bin:Xf,files:Yf,scripts:Kf,repository:Qf,license:Zf,bugs:Jf,devDependencies:ed,dependencies:td,peerDependencies:nd,engines:id};function Ar(e){return!!e.or}function zr(e){return!!e.and}function Ir(e){return!!e.not}function _i(e,t){if(Ir(e))_i(e.not,t);else if(zr(e))for(const n of e.and)_i(n,t);else if(Ar(e))for(const n of e.or)_i(n,t);else t(e)}function cn(e,t){return Ir(e)?{not:cn(e.not,t)}:zr(e)?{and:e.and.map(n=>cn(n,t))}:Ar(e)?{or:e.or.map(n=>cn(n,t))}:t(e)}const Ie=Tf,F=Pf;function ra(e){throw new Error(e)}function ln(e,t){const n={};for(const i of t)sn(e,i)&&(n[i]=e[i]);return n}function ue(e,t){const n=Object.assign({},e);for(const i of t)delete n[i];return n}Set.prototype.toJSON=function(){return`Set(${[...this].map(e=>Tr(e)).join(",")})`};const D=Tr;function z(e){if(Y(e))return e;const t=N(e)?e:Tr(e);if(t.length<250)return t;let n=0;for(let i=0;i<t.length;i++){const r=t.charCodeAt(i);n=(n<<5)-n+r,n=n&n}return n}function Rr(e){return e===!1||e===null}function A(e,t){return e.includes(t)}function Rt(e,t){let n=0;for(const[i,r]of e.entries())if(t(r,i,n++))return!0;return!1}function Lr(e,t){let n=0;for(const[i,r]of e.entries())if(!t(r,i,n++))return!1;return!0}function sa(e,...t){for(const n of t)sd(e,n??{});return e}function sd(e,t){for(const n of v(t))Ef(e,n,t[n],!0)}function Re(e,t){const n=[],i={};let r;for(const s of e){if(r=t(s),r in i)continue;i[r]=1,n.push(s)}return n}function od(e,t){const n=v(e),i=v(t);if(n.length!==i.length)return!1;for(const r of n)if(e[r]!==t[r])return!1;return!0}function oa(e,t){if(e.size!==t.size)return!1;for(const n of e)if(!t.has(n))return!1;return!0}function Mr(e,t){for(const n of e)if(t.has(n))return!0;return!1}function Dr(e){const t=new Set;for(const n of e){const i=on(n),r=i.map((o,a)=>a===0?o:`[${o}]`),s=r.map((o,a)=>r.slice(0,a+1).join(""));for(const o of s)t.add(o)}return t}function Ur(e,t){return e===void 0||t===void 0?!0:Mr(Dr(e),Dr(t))}function L(e){return v(e).length===0}const v=Object.keys,re=Object.values,ht=Object.entries;function Wn(e){return e===!0||e===!1}function q(e){const t=e.replace(/\W/g,"_");return(e.match(/^\d+/)?"_":"")+t}function Bn(e,t){return Ir(e)?`!(${Bn(e.not,t)})`:zr(e)?`(${e.and.map(n=>Bn(n,t)).join(") && (")})`:Ar(e)?`(${e.or.map(n=>Bn(n,t)).join(") || (")})`:t(e)}function ji(e,t){if(t.length===0)return!0;const n=t.shift();return n in e&&ji(e[n],t)&&delete e[n],L(e)}function Hn(e){return e.charAt(0).toUpperCase()+e.substr(1)}function Wr(e,t="datum"){const n=on(e),i=[];for(let r=1;r<=n.length;r++){const s=`[${n.slice(0,r).map(I).join("][")}]`;i.push(`${t}${s}`)}return i.join(" && ")}function aa(e,t="datum"){return`${t}[${I(on(e).join("."))}]`}function ad(e){return e.replace(/(\[|\]|\.|'|")/g,"\\$1")}function xe(e){return`${on(e).map(ad).join("\\.")}`}function Lt(e,t,n){return e.replace(new RegExp(t.replace(/[-/\\^$*+?.()|[\]{}]/g,"\\$&"),"g"),n)}function Br(e){return`${on(e).join(".")}`}function un(e){return e?on(e).length:0}function K(...e){for(const t of e)if(t!==void 0)return t;return}let ca=42;function la(e){const t=++ca;return e?String(e)+t:t}function cd(){ca=42}function ua(e){return fa(e)?e:`__${e}`}function fa(e){return e.startsWith("__")}function qn(e){return e===void 0?void 0:(e%360+360)%360}function wi(e){return Y(e)?!0:!isNaN(e)&&!isNaN(parseFloat(e))}var Gn=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const nt="row",it="column",$i="facet",G="x",J="y",Ee="x2",Le="y2",bt="xOffset",fn="yOffset",ke="radius",rt="radius2",Se="theta",st="theta2",Me="latitude",De="longitude",Ce="latitude2",_e="longitude2",fe="color",Ue="fill",We="stroke",de="shape",ot="size",Mt="angle",at="opacity",yt="fillOpacity",vt="strokeOpacity",Ot="strokeWidth",xt="strokeDash",Vn="text",Xn="order",Yn="detail",Ei="key",Dt="tooltip",ki="href",Ci="url",Fi="description",ld={x:1,y:1,x2:1,y2:1},da={theta:1,theta2:1,radius:1,radius2:1};function ga(e){return e in da}const Hr={longitude:1,longitude2:1,latitude:1,latitude2:1};function ud(e){switch(e){case Me:return"y";case Ce:return"y2";case De:return"x";case _e:return"x2"}}function fd(e){return e in Hr}const dd=v(Hr),qr=Object.assign(Object.assign(Object.assign(Object.assign({},ld),da),Hr),{xOffset:1,yOffset:1,color:1,fill:1,stroke:1,opacity:1,fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeDash:1,size:1,angle:1,shape:1,order:1,text:1,detail:1,key:1,tooltip:1,href:1,url:1,description:1});function dn(e){return e===fe||e===Ue||e===We}const pa={row:1,column:1,facet:1},je=v(pa),Gr=Object.assign(Object.assign({},qr),pa),gd=v(Gr),pd=Gn(Gr,["order","detail","tooltip"]),md=Gn(pd,["row","column","facet"]);function hd(e){return!!md[e]}function ma(e){return!!Gr[e]}const bd=[Ee,Le,Ce,_e,st,rt];function ha(e){const t=Ut(e);return t!==e}function Ut(e){switch(e){case Ee:return G;case Le:return J;case Ce:return Me;case _e:return De;case st:return Se;case rt:return ke}return e}function St(e){if(ga(e))switch(e){case Se:return"startAngle";case st:return"endAngle";case ke:return"outerRadius";case rt:return"innerRadius"}return e}function Be(e){switch(e){case G:return Ee;case J:return Le;case Me:return Ce;case De:return _e;case Se:return st;case ke:return rt}return}function ge(e){switch(e){case G:case Ee:return"width";case J:case Le:return"height"}return}function yd(e){switch(e){case G:return"xOffset";case J:return"yOffset";case Ee:return"x2Offset";case Le:return"y2Offset";case Se:return"thetaOffset";case ke:return"radiusOffset";case st:return"theta2Offset";case rt:return"radius2Offset"}return}function ba(e){switch(e){case G:return"xOffset";case J:return"yOffset"}return}function ya(e){switch(e){case"xOffset":return"x";case"yOffset":return"y"}}const vd=v(qr),Vr=Gn(qr,["x","y","x2","y2","xOffset","yOffset","latitude","longitude","latitude2","longitude2","theta","theta2","radius","radius2"]),Od=v(Vr),Xr={x:1,y:1},He=v(Xr);function ee(e){return e in Xr}const Yr={theta:1,radius:1},xd=v(Yr);function Ni(e){return e==="width"?G:J}const va={xOffset:1,yOffset:1};function gn(e){return e in va}const Oa=Gn(Vr,["text","tooltip","href","url","description","detail","key","order"]),Sd=v(Oa);function _d(e){return!!Vr[e]}function jd(e){switch(e){case fe:case Ue:case We:case ot:case de:case at:case Ot:case xt:return!0;case yt:case vt:case Mt:return!1}}const xa=Object.assign(Object.assign(Object.assign(Object.assign({},Xr),Yr),va),Oa),Pi=v(xa);function _t(e){return!!xa[e]}function wd(e,t){return Ed(e)[t]}const Sa={arc:"always",area:"always",bar:"always",circle:"always",geoshape:"always",image:"always",line:"always",rule:"always",point:"always",rect:"always",square:"always",trail:"always",text:"always",tick:"always"},$d=Gn(Sa,["geoshape"]);function Ed(e){switch(e){case fe:case Ue:case We:case Fi:case Yn:case Ei:case Dt:case ki:case Xn:case at:case yt:case vt:case Ot:case $i:case nt:case it:return Sa;case G:case J:case bt:case fn:case Me:case De:return $d;case Ee:case Le:case Ce:case _e:return{area:"always",bar:"always",image:"always",rect:"always",rule:"always",circle:"binned",point:"binned",square:"binned",tick:"binned",line:"binned",trail:"binned"};case ot:return{point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",text:"always",line:"always",trail:"always"};case xt:return{line:"always",point:"always",tick:"always",rule:"always",circle:"always",square:"always",bar:"always",geoshape:"always"};case de:return{point:"always",geoshape:"always"};case Vn:return{text:"always"};case Mt:return{point:"always",square:"always",text:"always"};case Ci:return{image:"always"};case Se:return{text:"always",arc:"always"};case ke:return{text:"always",arc:"always"};case st:case rt:return{arc:"always"}}}function Kr(e){switch(e){case G:case J:case Se:case ke:case bt:case fn:case ot:case Mt:case Ot:case at:case yt:case vt:case Ee:case Le:case st:case rt:return;case $i:case nt:case it:case de:case xt:case Vn:case Dt:case ki:case Ci:case Fi:return"discrete";case fe:case Ue:case We:return"flexible";case Me:case De:case Ce:case _e:case Yn:case Ei:case Xn:return}}const kd={argmax:1,argmin:1,average:1,count:1,distinct:1,product:1,max:1,mean:1,median:1,min:1,missing:1,q1:1,q3:1,ci0:1,ci1:1,stderr:1,stdev:1,stdevp:1,sum:1,valid:1,values:1,variance:1,variancep:1},Cd={count:1,min:1,max:1};function ct(e){return!!e&&!!e.argmin}function jt(e){return!!e&&!!e.argmax}function Qr(e){return N(e)&&!!kd[e]}const Fd=new Set(["count","valid","missing","distinct"]);function _a(e){return N(e)&&Fd.has(e)}function Nd(e){return N(e)&&A(["min","max"],e)}const Pd=new Set(["count","sum","distinct","valid","missing"]),Td=new Set(["mean","average","median","q1","q3","min","max"]);function ja(e){return Un(e)&&(e=Ki(e,void 0)),"bin"+v(e).map(t=>Ti(e[t])?q(`_${t}_${ht(e[t])}`):q(`_${t}_${e[t]}`)).join("")}function U(e){return e===!0||Wt(e)&&!e.binned}function ie(e){return e==="binned"||Wt(e)&&e.binned===!0}function Wt(e){return H(e)}function Ti(e){return e==null?void 0:e.param}function wa(e){switch(e){case nt:case it:case ot:case fe:case Ue:case We:case Ot:case at:case yt:case vt:case de:return 6;case xt:return 4;default:return 10}}function Kn(e){return!!(e==null?void 0:e.expr)}function pe(e){const t=v(e||{}),n={};for(const i of t)n[i]=be(e[i]);return n}var Ad=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function $a(e){const{anchor:t,frame:n,offset:i,orient:r,angle:s,limit:o,color:a,subtitleColor:c,subtitleFont:l,subtitleFontSize:u,subtitleFontStyle:f,subtitleFontWeight:d,subtitleLineHeight:g,subtitlePadding:p}=e,m=Ad(e,["anchor","frame","offset","orient","angle","limit","color","subtitleColor","subtitleFont","subtitleFontSize","subtitleFontStyle","subtitleFontWeight","subtitleLineHeight","subtitlePadding"]),h=Object.assign(Object.assign({},m),a?{fill:a}:{}),b=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},t?{anchor:t}:{}),n?{frame:n}:{}),i?{offset:i}:{}),r?{orient:r}:{}),s!==void 0?{angle:s}:{}),o!==void 0?{limit:o}:{}),y=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},c?{subtitleColor:c}:{}),l?{subtitleFont:l}:{}),u?{subtitleFontSize:u}:{}),f?{subtitleFontStyle:f}:{}),d?{subtitleFontWeight:d}:{}),g?{subtitleLineHeight:g}:{}),p?{subtitlePadding:p}:{}),S=ln(e,["align","baseline","dx","dy","limit"]);return{titleMarkConfig:h,subtitleMarkConfig:S,nonMarkTitleProperties:b,subtitle:y}}function wt(e){return N(e)||j(e)&&N(e[0])}function w(e){return!!(e==null?void 0:e.signal)}function $t(e){return!!e.step}function zd(e){return j(e)?!1:"fields"in e&&!("data"in e)}function Id(e){return j(e)?!1:"fields"in e&&"data"in e}function lt(e){return j(e)?!1:"field"in e&&"data"in e}const Rd={aria:1,description:1,ariaRole:1,ariaRoleDescription:1,blend:1,opacity:1,fill:1,fillOpacity:1,stroke:1,strokeCap:1,strokeWidth:1,strokeOpacity:1,strokeDash:1,strokeDashOffset:1,strokeJoin:1,strokeOffset:1,strokeMiterLimit:1,startAngle:1,endAngle:1,padAngle:1,innerRadius:1,outerRadius:1,size:1,shape:1,interpolate:1,tension:1,orient:1,align:1,baseline:1,text:1,dir:1,dx:1,dy:1,ellipsis:1,limit:1,radius:1,theta:1,angle:1,font:1,fontSize:1,fontWeight:1,fontStyle:1,lineBreak:1,lineHeight:1,cursor:1,href:1,tooltip:1,cornerRadius:1,cornerRadiusTopLeft:1,cornerRadiusTopRight:1,cornerRadiusBottomLeft:1,cornerRadiusBottomRight:1,aspect:1,width:1,height:1,url:1,smooth:1},Ld=v(Rd),Md={arc:1,area:1,group:1,image:1,line:1,path:1,rect:1,rule:1,shape:1,symbol:1,text:1,trail:1},Zr=["cornerRadius","cornerRadiusTopLeft","cornerRadiusTopRight","cornerRadiusBottomLeft","cornerRadiusBottomRight"];var Jr=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Ea(e){const t=j(e.condition)?e.condition.map(ka):ka(e.condition);return Object.assign(Object.assign({},be(e)),{condition:t})}function be(e){if(Kn(e)){const{expr:t}=e,n=Jr(e,["expr"]);return Object.assign({signal:t},n)}return e}function ka(e){if(Kn(e)){const{expr:t}=e,n=Jr(e,["expr"]);return Object.assign({signal:t},n)}return e}function B(e){if(Kn(e)){const{expr:t}=e,n=Jr(e,["expr"]);return Object.assign({signal:t},n)}return w(e)?e:e!==void 0?{value:e}:void 0}function Dd(e){return w(e)?e.signal:I(e)}function Ca(e){return w(e)?e.signal:I(e.value)}function ut(e){return w(e)?e.signal:e==null?null:I(e)}function Ud(e,t,n){for(const i of n){const r=Bt(i,t.markDef,t.config);r!==void 0&&(e[i]=B(r))}return e}function Fa(e){var t;return[].concat(e.type,(t=e.style)!==null&&t!==void 0?t:[])}function R(e,t,n,i={}){const{vgChannel:r,ignoreVgConfig:s}=i;return r&&t[r]!==void 0?t[r]:t[e]!==void 0?t[e]:s&&(!r||r===e)?void 0:Bt(e,t,n,i)}function Bt(e,t,n,{vgChannel:i}={}){return K(i?Ai(e,t,n.style):void 0,Ai(e,t,n.style),i?n[t.type][i]:void 0,n[t.type][e],i?n.mark[i]:n.mark[e])}function Ai(e,t,n){return Na(e,Fa(t),n)}function Na(e,t,n){t=V(t);let i;for(const r of t){const s=n[r];s&&s[e]!==void 0&&(i=s[e])}return i}function Pa(e,t){return V(e).reduce((n,i)=>{var r;return n.field.push(_(i,t)),n.order.push((r=i.sort)!==null&&r!==void 0?r:"ascending"),n},{field:[],order:[]})}function Ta(e,t){const n=[...e];return t.forEach(i=>{for(const r of n)if(Ie(r,i))return;n.push(i)}),n}function Aa(e,t){return Ie(e,t)||!t?e:e?[...V(e),...V(t)].join(", "):t}function za(e,t){const n=e.value,i=t.value;if(n==null||i===null)return{explicit:e.explicit,value:null};if((wt(n)||w(n))&&(wt(i)||w(i)))return{explicit:e.explicit,value:Aa(n,i)};if(wt(n)||w(n))return{explicit:e.explicit,value:n};if(wt(i)||w(i))return{explicit:e.explicit,value:i};if(!wt(n)&&!w(n)&&!wt(i)&&!w(i))return{explicit:e.explicit,value:Ta(n,i)};throw new Error("It should never reach here")}function es(e){return`Invalid specification ${D(e)}. Make sure the specification includes at least one of the following properties: "mark", "layer", "facet", "hconcat", "vconcat", "concat", or "repeat".`}const Wd='Autosize "fit" only works for single views and layered views.';function Ia(e){const t=e=="width"?"Width":"Height";return`${t} "container" only works for single views and layered views.`}function Ra(e){const t=e=="width"?"Width":"Height",n=e=="width"?"x":"y";return`${t} "container" only works well with autosize "fit" or "fit-${n}".`}function La(e){return e?`Dropping "fit-${e}" because spec has discrete ${ge(e)}.`:'Dropping "fit" because spec has discrete size.'}function ts(e){return`Unknown field for ${e}. Cannot calculate view size.`}function Ma(e){return`Cannot project a selection on encoding channel "${e}", which has no field.`}function Bd(e,t){return`Cannot project a selection on encoding channel "${e}" as it uses an aggregate function ("${t}").`}function Hd(e){return`The "nearest" transform is not supported for ${e} marks.`}function Da(e){return`Selection not supported for ${e} yet.`}function qd(e){return`Cannot find a selection named "${e}".`}const Gd="Scale bindings are currently only supported for scales with unbinned, continuous domains.",Vd="Legend bindings are only supported for selections over an individual field or encoding channel.";function Xd(e){return`Lookups can only be performed on selection parameters. "${e}" is a variable parameter.`}function Yd(e){return`Cannot define and lookup the "${e}" selection in the same view. Try moving the lookup into a second, layered view?`}const Kd="The same selection must be used to override scale domains in a layered view.",Qd='Interval selections should be initialized using "x" and/or "y" keys.';function Zd(e){return`Unknown repeated value "${e}".`}function Ua(e){return`The "columns" property cannot be used when "${e}" has nested row/column.`}const Jd="Axes cannot be shared in concatenated or repeated views yet (https://github.com/vega/vega-lite/issues/2415).";function eg(e){return`Unrecognized parse "${e}".`}function Wa(e,t,n){return`An ancestor parsed field "${e}" as ${n} but a child wants to parse the field as ${t}.`}const tg="Attempt to add the same child twice.";function ng(e){return`Ignoring an invalid transform: ${D(e)}.`}const ig='If "from.fields" is not specified, "as" has to be a string that specifies the key to be used for the data from the secondary source.';function Ba(e){return`Config.customFormatTypes is not true, thus custom format type and format for channel ${e} are dropped.`}function rg(e){const{parentProjection:t,projection:n}=e;return`Layer's shared projection ${D(t)} is overridden by a child projection ${D(n)}.`}const sg="Arc marks uses theta channel rather than angle, replacing angle with theta.";function og(e){return`${e}Offset dropped because ${e} is continuous`}function ag(e){return`There is no ${e} encoding. Replacing ${e}Offset encoding as ${e}.`}function cg(e,t,n){return`Channel ${e} is a ${t}. Converted to {value: ${D(n)}}.`}function Ha(e){return`Invalid field type "${e}".`}function lg(e,t){return`Invalid field type "${e}" for aggregate: "${t}", using "quantitative" instead.`}function ug(e){return`Invalid aggregation operator "${e}".`}function qa(e,t){const{fill:n,stroke:i}=t;return`Dropping color ${e} as the plot also has ${n&&i?"fill and stroke":n?"fill":"stroke"}.`}function fg(e){return`Position range does not support relative band size for ${e}.`}function ns(e,t){return`Dropping ${D(e)} from channel "${t}" since it does not contain any data field, datum, value, or signal.`}const dg="Line marks cannot encode size with a non-groupby field. You may want to use trail marks instead.";function zi(e,t,n){return`${e} dropped as it is incompatible with "${t}"${n?` when ${n}`:""}.`}function gg(e){return`${e} encoding has no scale, so specified scale is ignored.`}function pg(e){return`${e}-encoding is dropped as ${e} is not a valid encoding channel.`}function mg(e){return`${e} encoding should be discrete (ordinal / nominal / binned).`}function hg(e){return`${e} encoding should be discrete (ordinal / nominal / binned) or use a discretizing scale (e.g. threshold).`}function bg(e){return`Facet encoding dropped as ${e.join(" and ")} ${e.length>1?"are":"is"} also specified.`}function is(e,t){return`Using discrete channel "${e}" to encode "${t}" field can be misleading as it does not encode ${t==="ordinal"?"order":"magnitude"}.`}function yg(e){return`The ${e} for range marks cannot be an expression`}function vg(e,t){const n=e&&t?"x2 and y2":e?"x2":"y2";return`Line mark is for continuous lines and thus cannot be used with ${n}. We will use the rule mark (line segments) instead.`}function Og(e,t){return`Specified orient "${e}" overridden with "${t}".`}function xg(e){return`Cannot use the scale property "${e}" with non-color channel.`}function Sg(e){return`Cannot use the relative band size with ${e} scale.`}function _g(e){return`Using unaggregated domain with raw field has no effect (${D(e)}).`}function jg(e){return`Unaggregated domain not applicable for "${e}" since it produces values outside the origin domain of the source data.`}function wg(e){return`Unaggregated domain is currently unsupported for log scale (${D(e)}).`}function $g(e){return`Cannot apply size to non-oriented mark "${e}".`}function Eg(e,t,n){return`Channel "${e}" does not work with "${t}" scale. We are using "${n}" scale instead.`}function kg(e,t){return`FieldDef does not work with "${e}" scale. We are using "${t}" scale instead.`}function Ga(e,t,n){return`${n}-scale's "${t}" is dropped as it does not work with ${e} scale.`}function Va(e){return`The step for "${e}" is dropped because the ${e==="width"?"x":"y"} is continuous.`}function Cg(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using ${D(n)}.`}function Fg(e,t,n,i){return`Conflicting ${t.toString()} property "${e.toString()}" (${D(n)} and ${D(i)}). Using the union of the two domains.`}function Ng(e){return`Setting the scale to be independent for "${e}" means we also have to set the guide (axis or legend) to be independent.`}function Pg(e){return`Dropping sort property ${D(e)} as unioned domains only support boolean or op "count", "min", and "max".`}const Xa="Domains that should be unioned has conflicting sort properties. Sort will be set to true.",Tg="Detected faceted independent scales that union domain of multiple fields from different data sources. We will use the first field. The result view size may be incorrect.",Ag="Detected faceted independent scales that union domain of the same fields from different source. We will assume that this is the same field from a different fork of the same data source. However, if this is not the case, the result view size may be incorrect.",zg="Detected faceted independent scales that union domain of multiple fields from the same data source. We will use the first field. The result view size may be incorrect.";function Ig(e){return`Cannot stack "${e}" if there is already "${e}2".`}function Rg(e){return`Cannot stack non-linear scale (${e}).`}function Lg(e){return`Stacking is applied even though the aggregate function is non-summative ("${e}").`}function Ii(e,t){return`Invalid ${e}: ${D(t)}.`}function Mg(e){return`Dropping day from datetime ${D(e)} as day cannot be combined with other units.`}function Dg(e,t){return`${t?"extent ":""}${t&&e?"and ":""}${e?"center ":""}${t&&e?"are ":"is "}not needed when data are aggregated.`}function Ug(e,t,n){return`${e} is not usually used with ${t} for ${n}.`}function Wg(e,t){return`Continuous axis should not have customized aggregation function ${e}; ${t} already agregates the axis.`}function Ya(e){return`1D error band does not support ${e}.`}function Ka(e){return`Channel ${e} is required for "binned" bin.`}function Bg(e){return`Channel ${e} should not be used with "binned" bin.`}function Hg(e){return`Domain for ${e} is required for threshold scale.`}var JO=function(e,t,n,i,r){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?r.call(e,n):r?r.value=n:t.set(e,n),n},ex=function(e,t,n,i){if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(e):i?i.value:t.get(e)};const Qa=kf(Cf);let pn=Qa;function qg(e){return pn=e,pn}function Gg(){return pn=Qa,pn}function O(...e){pn.warn(...e)}function Vg(...e){pn.debug(...e)}function Ht(e){if(e&&H(e)){for(const t of ss)if(t in e)return!0}return!1}const Za=["january","february","march","april","may","june","july","august","september","october","november","december"],Xg=Za.map(e=>e.substr(0,3)),Ja=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"],Yg=Ja.map(e=>e.substr(0,3));function Kg(e){if(wi(e)&&(e=+e),Y(e))return e>4&&O(Ii("quarter",e)),e-1;throw new Error(Ii("quarter",e))}function Qg(e){if(wi(e)&&(e=+e),Y(e))return e-1;{const t=e.toLowerCase(),n=Za.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=Xg.indexOf(i);if(r!==-1)return r;throw new Error(Ii("month",e))}}function Zg(e){if(wi(e)&&(e=+e),Y(e))return e%7;{const t=e.toLowerCase(),n=Ja.indexOf(t);if(n!==-1)return n;const i=t.substr(0,3),r=Yg.indexOf(i);if(r!==-1)return r;throw new Error(Ii("day",e))}}function rs(e,t){const n=[];if(t&&e.day!==void 0&&(v(e).length>1&&(O(Mg(e)),e=F(e),delete e.day)),e.year!==void 0?n.push(e.year):n.push(2012),e.month!==void 0){const i=t?Qg(e.month):e.month;n.push(i)}else if(e.quarter!==void 0){const i=t?Kg(e.quarter):e.quarter;n.push(Y(i)?i*3:`${i}*3`)}else n.push(0);if(e.date!==void 0)n.push(e.date);else if(e.day!==void 0){const i=t?Zg(e.day):e.day;n.push(Y(i)?i+1:`${i}+1`)}else n.push(1);for(const i of["hours","minutes","seconds","milliseconds"]){const r=e[i];n.push(typeof r=="undefined"?0:r)}return n}function Qn(e){const t=rs(e,!0),n=t.join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function Jg(e){const t=rs(e,!1),n=t.join(", ");return e.utc?`utc(${n})`:`datetime(${n})`}function ep(e){const t=rs(e,!0);return e.utc?+new Date(Date.UTC(...t)):+new Date(...t)}var tp=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const ec={year:1,quarter:1,month:1,week:1,day:1,dayofyear:1,date:1,hours:1,minutes:1,seconds:1,milliseconds:1},ss=v(ec);function np(e){return!!ec[e]}function os(e){return e.startsWith("utc")}function ip(e){return e.substr(3)}const rp={"year-month":"%b %Y ","year-month-date":"%b %d, %Y "};function as(e){return ss.filter(t=>tc(e,t))}function tc(e,t){const n=e.indexOf(t);return n<0||(n>0&&t==="seconds"&&e.charAt(n-1)==="i"||e.length>n+3&&t==="day"&&e.charAt(n+3)==="o")?!1:!(n>0&&t==="year"&&e.charAt(n-1)==="f")}function sp(e,t,{end:n}={end:!1}){const i=Wr(t),r=os(e)?"utc":"";function s(c){return c==="quarter"?`(${r}quarter(${i})-1)`:`${r}${c}(${i})`}let o;const a={};for(const c of ss)tc(e,c)&&(a[c]=s(c),o=c);return n&&(a[o]+="+1"),Jg(a)}function nc(e){if(!e)return;const t=as(e);return`timeUnitSpecifier(${D(t)}, ${D(rp)})`}function op(e,t,n){if(!e)return;const i=nc(e),r=n||os(e);return`${r?"utc":"time"}Format(${t}, ${i})`}function se(e){if(!e)return;let t;return N(e)?t={unit:e}:H(e)&&(t=Object.assign(Object.assign({},e),e.unit?{unit:e.unit}:{})),os(t.unit)&&(t.utc=!0,t.unit=ip(t.unit)),t}function ap(e){const t=se(e),{utc:n}=t,i=tp(t,["utc"]);return i.unit?(n?"utc":"")+v(i).map(r=>q(`${r==="unit"?"":`_${r}_`}${i[r]}`)).join(""):(n?"utc":"")+"timeunit"+v(i).map(r=>q(`_${r}_${i[r]}`)).join("")}function cp(e){return e==null?void 0:e.param}function cs(e){return!!(e==null?void 0:e.field)&&e.equal!==void 0}function ls(e){return!!(e==null?void 0:e.field)&&e.lt!==void 0}function us(e){return!!(e==null?void 0:e.field)&&e.lte!==void 0}function fs(e){return!!(e==null?void 0:e.field)&&e.gt!==void 0}function ds(e){return!!(e==null?void 0:e.field)&&e.gte!==void 0}function gs(e){if(e==null?void 0:e.field){if(j(e.range)&&e.range.length===2)return!0;if(w(e.range))return!0}return!1}function ps(e){return!!(e==null?void 0:e.field)&&(j(e.oneOf)||j(e.in))}function lp(e){return!!(e==null?void 0:e.field)&&e.valid!==void 0}function ic(e){return ps(e)||cs(e)||gs(e)||ls(e)||fs(e)||us(e)||ds(e)}function qe(e,t){return Qi(e,{timeUnit:t,wrapTime:!0})}function up(e,t){return e.map(n=>qe(n,t))}function rc(e,t=!0){var n;const{field:i}=e,r=(n=se(e.timeUnit))===null||n===void 0?void 0:n.unit,s=r?`time(${sp(r,i)})`:_(e,{expr:"datum"});if(cs(e))return`${s}===${qe(e.equal,r)}`;if(ls(e)){const o=e.lt;return`${s}<${qe(o,r)}`}else if(fs(e)){const o=e.gt;return`${s}>${qe(o,r)}`}else if(us(e)){const o=e.lte;return`${s}<=${qe(o,r)}`}else if(ds(e)){const o=e.gte;return`${s}>=${qe(o,r)}`}else{if(ps(e))return`indexof([${up(e.oneOf,r).join(",")}], ${s}) !== -1`;if(lp(e))return ms(s,e.valid);if(gs(e)){const{range:o}=e,a=w(o)?{signal:`${o.signal}[0]`}:o[0],c=w(o)?{signal:`${o.signal}[1]`}:o[1];if(a!==null&&c!==null&&t)return"inrange("+s+", ["+qe(a,r)+", "+qe(c,r)+"])";const l=[];return a!==null&&l.push(`${s} >= ${qe(a,r)}`),c!==null&&l.push(`${s} <= ${qe(c,r)}`),l.length>0?l.join(" && "):"true"}}throw new Error(`Invalid field predicate: ${D(e)}`)}function ms(e,t=!0){return t?`isValid(${e}) && isFinite(+${e})`:`!isValid(${e}) || !isFinite(+${e})`}function fp(e){var t;return ic(e)&&e.timeUnit?Object.assign(Object.assign({},e),{timeUnit:(t=se(e.timeUnit))===null||t===void 0?void 0:t.unit}):e}const Zn={quantitative:"quantitative",ordinal:"ordinal",temporal:"temporal",nominal:"nominal",geojson:"geojson"};function dp(e){return e==="quantitative"||e==="temporal"}function sc(e){return e==="ordinal"||e==="nominal"}const qt=Zn.quantitative,hs=Zn.ordinal,mn=Zn.temporal,bs=Zn.nominal,hn=Zn.geojson;function gp(e){if(e){e=e.toLowerCase();switch(e){case"q":case qt:return"quantitative";case"t":case mn:return"temporal";case"o":case hs:return"ordinal";case"n":case bs:return"nominal";case hn:return"geojson"}}return}var pp=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const me={LINEAR:"linear",LOG:"log",POW:"pow",SQRT:"sqrt",SYMLOG:"symlog",IDENTITY:"identity",SEQUENTIAL:"sequential",TIME:"time",UTC:"utc",QUANTILE:"quantile",QUANTIZE:"quantize",THRESHOLD:"threshold",BIN_ORDINAL:"bin-ordinal",ORDINAL:"ordinal",POINT:"point",BAND:"band"},ys={linear:"numeric",log:"numeric",pow:"numeric",sqrt:"numeric",symlog:"numeric",identity:"numeric",sequential:"numeric",time:"time",utc:"time",ordinal:"ordinal","bin-ordinal":"bin-ordinal",point:"ordinal-position",band:"ordinal-position",quantile:"discretizing",quantize:"discretizing",threshold:"discretizing"};function mp(e,t){const n=ys[e],i=ys[t];return n===i||n==="ordinal-position"&&i==="time"||i==="ordinal-position"&&n==="time"}const hp={linear:0,log:1,pow:1,sqrt:1,symlog:1,identity:1,sequential:1,time:0,utc:0,point:10,band:11,ordinal:0,"bin-ordinal":0,quantile:0,quantize:0,threshold:0};function oc(e){return hp[e]}const ac=new Set(["linear","log","pow","sqrt","symlog"]),cc=new Set([...ac,"time","utc"]);function lc(e){return ac.has(e)}const uc=new Set(["quantile","quantize","threshold"]),bp=new Set([...cc,...uc,"sequential","identity"]),yp=new Set(["ordinal","bin-ordinal","point","band"]);function te(e){return yp.has(e)}function ye(e){return bp.has(e)}function Fe(e){return cc.has(e)}function bn(e){return uc.has(e)}const vp={pointPadding:.5,barBandPaddingInner:.1,rectBandPaddingInner:0,bandWithNestedOffsetPaddingInner:.2,bandWithNestedOffsetPaddingOuter:.2,minBandSize:2,minFontSize:8,maxFontSize:40,minOpacity:.3,maxOpacity:.8,minSize:9,minStrokeWidth:1,maxStrokeWidth:4,quantileCount:4,quantizeCount:4,zero:!0};function Op(e){return!N(e)&&!!e.name}function fc(e){return e==null?void 0:e.param}function xp(e){return e==null?void 0:e.unionWith}function Sp(e){return na(e)&&"field"in e}const _p={type:1,domain:1,domainMax:1,domainMin:1,domainMid:1,align:1,range:1,rangeMax:1,rangeMin:1,scheme:1,bins:1,reverse:1,round:1,clamp:1,nice:1,base:1,exponent:1,constant:1,interpolate:1,zero:1,padding:1,paddingInner:1,paddingOuter:1},jp=pp(_p,["type","domain","range","rangeMax","rangeMin","scheme"]),wp=v(jp);function vs(e,t){switch(t){case"type":case"domain":case"reverse":case"range":return!0;case"scheme":case"interpolate":return!["point","band","identity"].includes(e);case"bins":return!["point","band","identity","ordinal"].includes(e);case"round":return Fe(e)||e==="band"||e==="point";case"padding":case"rangeMin":case"rangeMax":return Fe(e)||["point","band"].includes(e);case"paddingOuter":case"align":return["point","band"].includes(e);case"paddingInner":return e==="band";case"domainMax":case"domainMid":case"domainMin":case"clamp":return Fe(e);case"nice":return Fe(e)||e==="quantize"||e==="threshold";case"exponent":return e==="pow";case"base":return e==="log";case"constant":return e==="symlog";case"zero":return ye(e)&&!A(["log","time","utc","threshold","quantile"],e)}}function dc(e,t){switch(t){case"interpolate":case"scheme":case"domainMid":return dn(e)?void 0:xg(t);case"align":case"type":case"bins":case"domain":case"domainMax":case"domainMin":case"range":case"base":case"exponent":case"constant":case"nice":case"padding":case"paddingInner":case"paddingOuter":case"rangeMax":case"rangeMin":case"reverse":case"round":case"clamp":case"zero":return}}function $p(e,t){return A([hs,bs],t)?e===void 0||te(e):t===mn?A([me.TIME,me.UTC,void 0],e):t===qt?lc(e)||bn(e)||e===void 0:!0}function Ep(e,t,n=!1){if(!_t(e))return!1;switch(e){case G:case J:case bt:case fn:case Se:case ke:return Fe(t)||t==="band"?!0:t==="point"?!n:!1;case ot:case Ot:case at:case yt:case vt:case Mt:return Fe(t)||bn(t)||A(["band","point","ordinal"],t);case fe:case Ue:case We:return t!=="band";case xt:case de:return t==="ordinal"||bn(t)}}const ce={arc:"arc",area:"area",bar:"bar",image:"image",line:"line",point:"point",rect:"rect",rule:"rule",text:"text",tick:"tick",trail:"trail",circle:"circle",square:"square",geoshape:"geoshape"},gc=ce.arc,Ri=ce.area,Li=ce.bar,kp=ce.image,Mi=ce.line,Di=ce.point,Cp=ce.rect,Ui=ce.rule,pc=ce.text,Os=ce.tick,Fp=ce.trail,xs=ce.circle,Ss=ce.square,mc=ce.geoshape;function Et(e){return["line","area","trail"].includes(e)}function hc(e){return["rect","bar","image","arc"].includes(e)}const Np=new Set(v(ce));function Ge(e){return e.type}const Pp=["stroke","strokeWidth","strokeDash","strokeDashOffset","strokeOpacity","strokeJoin","strokeMiterLimit"],Tp=["fill","fillOpacity"],Ap=[...Pp,...Tp],zp={color:1,filled:1,invalid:1,order:1,radius2:1,theta2:1,timeUnitBandSize:1,timeUnitBandPosition:1},bc=v(zp),Ip={area:["line","point"],bar:["binSpacing","continuousBandSize","discreteBandSize"],rect:["binSpacing","continuousBandSize","discreteBandSize"],line:["point"],tick:["bandSize","thickness"]},Rp={color:"#4c78a8",invalid:"filter",timeUnitBandSize:1},Lp={mark:1,arc:1,area:1,bar:1,circle:1,image:1,line:1,point:1,rect:1,rule:1,square:1,text:1,tick:1,trail:1,geoshape:1},yc=v(Lp);function Gt(e){return e&&e.band!=null}const Mp={horizontal:["cornerRadiusTopRight","cornerRadiusBottomRight"],vertical:["cornerRadiusTopLeft","cornerRadiusTopRight"]},vc=5,Dp={binSpacing:1,continuousBandSize:vc,timeUnitBandPosition:.5},Up={binSpacing:0,continuousBandSize:vc,timeUnitBandPosition:.5},Wp={thickness:1};function Bp(e){return Ge(e)?e.type:e}function _s(e){const{channel:t,channelDef:n,markDef:i,scale:r,config:s}=e,o=ws(e);return x(n)&&!_a(n.aggregate)&&r&&Fe(r.get("type"))?Hp({fieldDef:n,channel:t,markDef:i,ref:o,config:s}):o}function Hp({fieldDef:e,channel:t,markDef:n,ref:i,config:r}){if(Et(n.type))return i;const s=R("invalid",n,r);return s===null?[qp(e,t),i]:i}function qp(e,t){const n=js(e,!0),i=Ut(t),r=i==="y"?{field:{group:"height"}}:{value:0};return Object.assign({test:n},r)}function js(e,t=!0){return ms(N(e)?e:_(e,{expr:"datum"}),!t)}function Gp(e){const{datum:t}=e;return Ht(t)?Qn(t):`${D(t)}`}function Vt(e,t,n,i){const r={};if(t&&(r.scale=t),Xe(e)){const{datum:s}=e;Ht(s)?r.signal=Qn(s):w(s)?r.signal=s.signal:Kn(s)?r.signal=s.expr:r.value=s}else r.field=_(e,n);if(i){const{offset:s,band:o}=i;s&&(r.offset=s),o&&(r.band=o)}return r}function Wi({scaleName:e,fieldOrDatumDef:t,fieldOrDatumDef2:n,offset:i,startSuffix:r,bandPosition:s=.5}){const o=0<s&&s<1?"datum":void 0,a=_(t,{expr:o,suffix:r}),c=n!==void 0?_(n,{expr:o}):_(t,{suffix:"end",expr:o}),l={};if(s===0||s===1){l.scale=e;const u=s===0?a:c;l.field=u}else{const u=w(s)?`${s.signal} * ${a} + (1-${s.signal}) * ${c}`:`${s} * ${a} + ${1-s} * ${c}`;l.signal=`scale("${e}", ${u})`}return i&&(l.offset=i),l}function ws({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:l,bandPosition:u}){var f;if(t){if(C(t)){const d=o==null?void 0:o.get("type");if(we(t)){u??(u=Fc({fieldDef:t,fieldDef2:n,markDef:i,config:r}));const{bin:g,timeUnit:p,type:m}=t;if(U(g)||u&&p&&m===mn)return(a==null?void 0:a.impute)?Vt(t,s,{binSuffix:"mid"},{offset:c}):u&&!te(d)?Wi({scaleName:s,fieldOrDatumDef:t,bandPosition:u,offset:c}):Vt(t,s,ii(t,e)?{binSuffix:"range"}:{},{offset:c});if(ie(g)){if(x(n))return Wi({scaleName:s,fieldOrDatumDef:t,fieldOrDatumDef2:n,bandPosition:u,offset:c});{const h=e===G?Ee:Le;O(Ka(h))}}}return Vt(t,s,te(d)?{binSuffix:"range"}:{},{offset:c,band:d==="band"?(f=u??t.bandPosition)!==null&&f!==void 0?f:.5:void 0})}else if(Pe(t)){const d=t.value,g=c?{offset:c}:{};return Object.assign(Object.assign({},Jn(e,d)),g)}}return Ff(l)&&(l=l()),l&&Object.assign(Object.assign({},l),c?{offset:c}:{})}function Jn(e,t){return A(["x","x2"],e)&&t==="width"?{field:{group:"width"}}:A(["y","y2"],e)&&t==="height"?{field:{group:"height"}}:B(t)}function Xt(e){return e&&e!=="number"&&e!=="time"}function Oc(e,t,n){return`${e}(${t}${n?`, ${D(n)}`:""})`}const Vp=" \u2013 ";function $s({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s}){var o,a;if(Xt(n))return Ne({fieldOrDatumDef:e,format:t,formatType:n,expr:i,config:s});const c=xc(e,i,r),l=yn(e);if(t===void 0&&n===void 0&&s.customFormatTypes){if(l==="quantitative"){if(r&&s.normalizedNumberFormatType)return Ne({fieldOrDatumDef:e,format:s.normalizedNumberFormat,formatType:s.normalizedNumberFormatType,expr:i,config:s});if(s.numberFormatType)return Ne({fieldOrDatumDef:e,format:s.numberFormat,formatType:s.numberFormatType,expr:i,config:s})}if(l==="temporal"&&s.timeFormatType&&x(e)&&e.timeUnit===void 0)return Ne({fieldOrDatumDef:e,format:s.timeFormat,formatType:s.timeFormatType,expr:i,config:s})}if(Sn(e)){const u=Yp({field:c,timeUnit:x(e)?(o=se(e.timeUnit))===null||o===void 0?void 0:o.unit:void 0,format:t,formatType:s.timeFormatType,rawTimeFormat:s.timeFormat,isUTCScale:Yt(e)&&((a=e.scale)===null||a===void 0?void 0:a.type)===me.UTC});return u?{signal:u}:void 0}if(t=Es({type:l,specifiedFormat:t,config:s,normalizeStack:r}),x(e)&&U(e.bin)){const u=_(e,{expr:i,binSuffix:"end"});return{signal:ei(c,u,t,n,s)}}else return t||yn(e)==="quantitative"?{signal:`${jc(c,t)}`}:{signal:`isValid(${c}) ? ${c} : ""+${c}`}}function xc(e,t,n){return x(e)?n?`${_(e,{expr:t,suffix:"end"})}-${_(e,{expr:t,suffix:"start"})}`:_(e,{expr:t}):Gp(e)}function Ne({fieldOrDatumDef:e,format:t,formatType:n,expr:i,normalizeStack:r,config:s,field:o}){if(o??(o=xc(e,i,r)),o!=="datum.value"&&x(e)&&U(e.bin)){const a=_(e,{expr:i,binSuffix:"end"});return{signal:ei(o,a,t,n,s)}}return{signal:Oc(n,o,t)}}function Sc(e,t,n,i,r,s){var o;if(Xt(i))return;if(n===void 0&&i===void 0&&r.customFormatTypes&&yn(e)==="quantitative"){if(r.normalizedNumberFormatType&&vn(e)&&e.stack==="normalize")return;if(r.numberFormatType)return}if(vn(e)&&e.stack==="normalize"&&r.normalizedNumberFormat)return Es({type:"quantitative",config:r,normalizeStack:!0});if(Sn(e)){const a=x(e)?(o=se(e.timeUnit))===null||o===void 0?void 0:o.unit:void 0;return a===void 0&&r.customFormatTypes&&r.timeFormatType?void 0:Xp({specifiedFormat:n,timeUnit:a,config:r,omitTimeFormatConfig:s})}return Es({type:t,specifiedFormat:n,config:r})}function _c(e,t,n){var i;return e&&(w(e)||e==="number"||e==="time")?e:Sn(t)&&n!=="time"&&n!=="utc"?x(t)&&((i=se(t==null?void 0:t.timeUnit))===null||i===void 0?void 0:i.utc)?"utc":"time":void 0}function Es({type:e,specifiedFormat:t,config:n,normalizeStack:i}){return N(t)?t:e===qt?i?n.normalizedNumberFormat:n.numberFormat:void 0}function Xp({specifiedFormat:e,timeUnit:t,config:n,omitTimeFormatConfig:i}){return e||(t?{signal:nc(t)}:i?void 0:n.timeFormat)}function jc(e,t){return`format(${e}, "${t||""}")`}function wc(e,t,n,i){var r;return Xt(n)?Oc(n,e,t):jc(e,(r=N(t)?t:void 0)!==null&&r!==void 0?r:i.numberFormat)}function ei(e,t,n,i,r){if(n===void 0&&i===void 0&&r.customFormatTypes&&r.numberFormatType)return ei(e,t,r.numberFormat,r.numberFormatType,r);const s=wc(e,n,i,r),o=wc(t,n,i,r);return`${ms(e,!1)} ? "null" : ${s} + "${Vp}" + ${o}`}function Yp({field:e,timeUnit:t,format:n,formatType:i,rawTimeFormat:r,isUTCScale:s}){return!t||n?!t&&i?`${i}(${e}, '${n}')`:(n=N(n)?n:r,`${s?"utc":"time"}Format(${e}, '${n}')`):op(t,e,s)}const Bi="min",Kp={x:1,y:1,color:1,fill:1,stroke:1,strokeWidth:1,size:1,shape:1,fillOpacity:1,strokeOpacity:1,opacity:1,text:1};function $c(e){return e in Kp}function Ec(e){return!!(e==null?void 0:e.encoding)}function Ve(e){return e&&(e.op==="count"||!!e.field)}function kc(e){return e&&j(e)}function ti(e){return"row"in e||"column"in e}function ks(e){return!!e&&"header"in e}function Hi(e){return"facet"in e}var Cs=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Qp(e){return e.param}function Zp(e){return e&&!N(e)&&"repeat"in e}function Cc(e){const{field:t,timeUnit:n,bin:i,aggregate:r}=e;return Object.assign(Object.assign(Object.assign(Object.assign({},n?{timeUnit:n}:{}),i?{bin:i}:{}),r?{aggregate:r}:{}),{field:t})}function Fs(e){return"sort"in e}function Fc({fieldDef:e,fieldDef2:t,markDef:n,config:i}){if(C(e)&&e.bandPosition!==void 0)return e.bandPosition;if(x(e)){const{timeUnit:r,bin:s}=e;if(r&&!t)return hc(n.type)?0:Bt("timeUnitBandPosition",n,i);if(U(s))return .5}return}function Nc({channel:e,fieldDef:t,fieldDef2:n,markDef:i,config:r,scaleType:s,useVlSizeChannel:o}){var a,c,l;const u=ge(e),f=R(o?"size":u,i,r,{vgChannel:u});if(f!==void 0)return f;if(x(t)){const{timeUnit:d,bin:g}=t;if(d&&!n)return{band:Bt("timeUnitBandSize",i,r)};if(U(g)&&!te(s))return{band:1}}return hc(i.type)?s?te(s)?((a=r[i.type])===null||a===void 0?void 0:a.discreteBandSize)||{band:1}:(c=r[i.type])===null||c===void 0?void 0:c.continuousBandSize:(l=r[i.type])===null||l===void 0?void 0:l.discreteBandSize:void 0}function Pc(e,t,n,i){return U(e.bin)||e.timeUnit&&we(e)&&e.type==="temporal"?Fc({fieldDef:e,fieldDef2:t,markDef:n,config:i})!==void 0:!1}function qi(e){return e&&"condition"in e}function Gi(e){const t=e==null?void 0:e.condition;return!!t&&!j(t)&&x(t)}function ni(e){const t=e==null?void 0:e.condition;return!!t&&!j(t)&&C(t)}function Jp(e){const t=e==null?void 0:e.condition;return!!t&&(j(t)||Pe(t))}function x(e){return e&&(!!e.field||e.aggregate==="count")}function yn(e){return e==null?void 0:e.type}function Xe(e){return e&&"datum"in e}function Ye(e){return we(e)&&!Vi(e)||Ns(e)}function Ns(e){return Xe(e)&&Y(e.datum)}function C(e){return x(e)||Xe(e)}function we(e){return e&&("field"in e||e.aggregate==="count")&&"type"in e}function Pe(e){return e&&"value"in e&&"value"in e}function Yt(e){return e&&("scale"in e||"sort"in e)}function vn(e){return e&&("axis"in e||"stack"in e||"impute"in e)}function Tc(e){return e&&"legend"in e}function Ac(e){return e&&("format"in e||"formatType"in e)}function em(e){return ue(e,["legend","axis","header","scale"])}function tm(e){return"op"in e}function _(e,t={}){var n,i,r;let s=e.field;const o=t.prefix;let a=t.suffix,c="";if(im(e))s=ua("count");else{let l;if(!t.nofn)if(tm(e))l=e.op;else{const{bin:u,aggregate:f,timeUnit:d}=e;U(u)?(l=ja(u),a=((n=t.binSuffix)!==null&&n!==void 0?n:"")+((i=t.suffix)!==null&&i!==void 0?i:"")):f?jt(f)?(c=`["${s}"]`,s=`argmax_${f.argmax}`):ct(f)?(c=`["${s}"]`,s=`argmin_${f.argmin}`):l=String(f):d&&(l=ap(d),a=(!["range","mid"].includes(t.binSuffix)&&t.binSuffix||"")+((r=t.suffix)!==null&&r!==void 0?r:""))}l&&(s=s?`${l}_${s}`:l)}return a&&(s=`${s}_${a}`),o&&(s=`${o}_${s}`),t.forAs?Br(s):t.expr?aa(s,t.expr)+c:xe(s)+c}function Vi(e){switch(e.type){case"nominal":case"ordinal":case"geojson":return!0;case"quantitative":return x(e)&&!!e.bin;case"temporal":return!1}throw new Error(Ha(e.type))}function nm(e){var t;return Yt(e)&&bn((t=e.scale)===null||t===void 0?void 0:t.type)}function im(e){return e.aggregate==="count"}function rm(e,t){var n;const{field:i,bin:r,timeUnit:s,aggregate:o}=e;if(o==="count")return t.countTitle;if(U(r))return`${i} (binned)`;if(s){const a=(n=se(s))===null||n===void 0?void 0:n.unit;if(a)return`${i} (${as(a).join("-")})`}else if(o)return jt(o)?`${i} for max ${o.argmax}`:ct(o)?`${i} for min ${o.argmin}`:`${Hn(o)} of ${i}`;return i}function sm(e){const{aggregate:t,bin:n,timeUnit:i,field:r}=e;if(jt(t))return`${r} for argmax(${t.argmax})`;if(ct(t))return`${r} for argmin(${t.argmin})`;const s=se(i),o=t||(s==null?void 0:s.unit)||(s==null?void 0:s.maxbins)&&"timeunit"||U(n)&&"bin";return o?`${o.toUpperCase()}(${r})`:r}const zc=(e,t)=>{switch(t.fieldTitle){case"plain":return e.field;case"functional":return sm(e);default:return rm(e,t)}};let Ic=zc;function Rc(e){Ic=e}function om(){Rc(zc)}function On(e,t,{allowDisabling:n,includeDefault:i=!0}){var r,s;const o=(r=Ps(e))===null||r===void 0?void 0:r.title;if(!x(e))return o??e.title;const a=e,c=i?Ts(a,t):void 0;return n?K(o,a.title,c):(s=o??a.title)!==null&&s!==void 0?s:c}function Ps(e){return vn(e)&&e.axis?e.axis:Tc(e)&&e.legend?e.legend:ks(e)&&e.header?e.header:void 0}function Ts(e,t){return Ic(e,t)}function Xi(e){var t;if(Ac(e)){const{format:n,formatType:i}=e;return{format:n,formatType:i}}else{const n=(t=Ps(e))!==null&&t!==void 0?t:{},{format:i,formatType:r}=n;return{format:i,formatType:r}}}function am(e,t){var n;switch(t){case"latitude":case"longitude":return"quantitative";case"row":case"column":case"facet":case"shape":case"strokeDash":return"nominal";case"order":return"ordinal"}if(Fs(e)&&j(e.sort))return"ordinal";const{aggregate:i,bin:r,timeUnit:s}=e;if(s)return"temporal";if(r||i&&!jt(i)&&!ct(i))return"quantitative";if(Yt(e)&&((n=e.scale)===null||n===void 0?void 0:n.type))switch(ys[e.scale.type]){case"numeric":case"discretizing":return"quantitative";case"time":return"temporal"}return"nominal"}function Ke(e){return x(e)?e:Gi(e)?e.condition:void 0}function Z(e){return C(e)?e:ni(e)?e.condition:void 0}function Lc(e,t,n,i={}){if(N(e)||Y(e)||Un(e)){const r=N(e)?"string":Y(e)?"number":"boolean";return O(cg(t,r,e)),{value:e}}return C(e)?Yi(e,t,n,i):ni(e)?Object.assign(Object.assign({},e),{condition:Yi(e.condition,t,n,i)}):e}function Yi(e,t,n,i){if(Ac(e)){const{format:r,formatType:s}=e,o=Cs(e,["format","formatType"]);if(Xt(s)&&!n.customFormatTypes)return O(Ba(t)),Yi(o,t,n,i)}else{const r=vn(e)?"axis":Tc(e)?"legend":ks(e)?"header":null;if(r&&e[r]){const s=e[r],{format:o,formatType:a}=s,c=Cs(s,["format","formatType"]);if(Xt(a)&&!n.customFormatTypes)return O(Ba(t)),Yi(Object.assign(Object.assign({},e),{[r]:c}),t,n,i)}}return x(e)?As(e,t,i):cm(e)}function cm(e){let t=e.type;if(t)return e;const{datum:n}=e;return t=Y(n)?"quantitative":N(n)?"nominal":Ht(n)?"temporal":void 0,Object.assign(Object.assign({},e),{type:t})}function As(e,t,{compositeMark:n=!1}={}){const{aggregate:i,timeUnit:r,bin:s,field:o}=e,a=Object.assign({},e);if(!n&&i&&!Qr(i)&&!jt(i)&&!ct(i)&&(O(ug(i)),delete a.aggregate),r&&(a.timeUnit=se(r)),o&&(a.field=`${o}`),U(s)&&(a.bin=Ki(s,t)),ie(s)&&!ee(t)&&O(Bg(t)),we(a)){const{type:c}=a,l=gp(c);c!==l&&(a.type=l),c!=="quantitative"&&(_a(i)&&(O(lg(c,i)),a.type="quantitative"))}else if(!ha(t)){const c=am(a,t);a.type=c}if(we(a)){const{compatible:c,warning:l}=lm(a,t)||{};c===!1&&O(l)}if(Fs(a)&&N(a.sort)){const{sort:c}=a;if($c(c))return Object.assign(Object.assign({},a),{sort:{encoding:c}});const l=c.substr(1);if(c.charAt(0)==="-"&&$c(l))return Object.assign(Object.assign({},a),{sort:{encoding:l,order:"descending"}})}if(ks(a)){const{header:c}=a;if(c){const{orient:l}=c,u=Cs(c,["orient"]);if(l)return Object.assign(Object.assign({},a),{header:Object.assign(Object.assign({},u),{labelOrient:c.labelOrient||l,titleOrient:c.titleOrient||l})})}}return a}function Ki(e,t){return Un(e)?{maxbins:wa(t)}:e==="binned"?{binned:!0}:!e.maxbins&&!e.step?Object.assign(Object.assign({},e),{maxbins:wa(t)}):e}const xn={compatible:!0};function lm(e,t){const n=e.type;if(n==="geojson"&&t!=="shape")return{compatible:!1,warning:`Channel ${t} should not be used with a geojson data.`};switch(t){case nt:case it:case $i:return Vi(e)?xn:{compatible:!1,warning:mg(t)};case G:case J:case bt:case fn:case fe:case Ue:case We:case Vn:case Yn:case Ei:case Dt:case ki:case Ci:case Mt:case Se:case ke:case Fi:return xn;case De:case _e:case Me:case Ce:return n!==qt?{compatible:!1,warning:`Channel ${t} should be used with a quantitative field only, not ${e.type} field.`}:xn;case at:case yt:case vt:case Ot:case ot:case st:case rt:case Ee:case Le:return n==="nominal"&&!e.sort?{compatible:!1,warning:`Channel ${t} should not be used with an unsorted discrete field.`}:xn;case de:case xt:return!Vi(e)&&!nm(e)?{compatible:!1,warning:hg(t)}:xn;case Xn:return e.type==="nominal"&&!("sort"in e)?{compatible:!1,warning:"Channel order is inappropriate for nominal field, which has no inherent order."}:xn}}function Sn(e){const{formatType:t}=Xi(e);return t==="time"||!t&&um(e)}function um(e){return e&&(e.type==="temporal"||x(e)&&!!e.timeUnit)}function Qi(e,{timeUnit:t,type:n,wrapTime:i,undefinedIfExprNotRequired:r}){var s;const o=t&&((s=se(t))===null||s===void 0?void 0:s.unit);let a=o||n==="temporal",c;return Kn(e)?c=e.expr:w(e)?c=e.signal:Ht(e)?(a=!0,c=Qn(e)):(N(e)||Y(e))&&(a&&(c=`datetime(${D(e)})`,np(o)&&((Y(e)&&e<1e4||N(e)&&isNaN(Date.parse(e)))&&(c=Qn({[o]:e}))))),c?i&&a?`time(${c})`:c:r?void 0:D(e)}function Mc(e,t){const{type:n}=e;return t.map(i=>{const r=Qi(i,{timeUnit:x(e)?e.timeUnit:void 0,type:n,undefinedIfExprNotRequired:!0});return r!==void 0?{signal:r}:i})}function ii(e,t){return U(e.bin)?_t(t)&&["ordinal","nominal"].includes(e.type):(console.warn("Only call this method for binned field defs."),!1)}const Dc={labelAlign:{part:"labels",vgProp:"align"},labelBaseline:{part:"labels",vgProp:"baseline"},labelColor:{part:"labels",vgProp:"fill"},labelFont:{part:"labels",vgProp:"font"},labelFontSize:{part:"labels",vgProp:"fontSize"},labelFontStyle:{part:"labels",vgProp:"fontStyle"},labelFontWeight:{part:"labels",vgProp:"fontWeight"},labelOpacity:{part:"labels",vgProp:"opacity"},labelOffset:null,labelPadding:null,gridColor:{part:"grid",vgProp:"stroke"},gridDash:{part:"grid",vgProp:"strokeDash"},gridDashOffset:{part:"grid",vgProp:"strokeDashOffset"},gridOpacity:{part:"grid",vgProp:"opacity"},gridWidth:{part:"grid",vgProp:"strokeWidth"},tickColor:{part:"ticks",vgProp:"stroke"},tickDash:{part:"ticks",vgProp:"strokeDash"},tickDashOffset:{part:"ticks",vgProp:"strokeDashOffset"},tickOpacity:{part:"ticks",vgProp:"opacity"},tickSize:null,tickWidth:{part:"ticks",vgProp:"strokeWidth"}};function ri(e){return e==null?void 0:e.condition}const Uc=["domain","grid","labels","ticks","title"],fm={grid:"grid",gridCap:"grid",gridColor:"grid",gridDash:"grid",gridDashOffset:"grid",gridOpacity:"grid",gridScale:"grid",gridWidth:"grid",orient:"main",bandPosition:"both",aria:"main",description:"main",domain:"main",domainCap:"main",domainColor:"main",domainDash:"main",domainDashOffset:"main",domainOpacity:"main",domainWidth:"main",format:"main",formatType:"main",labelAlign:"main",labelAngle:"main",labelBaseline:"main",labelBound:"main",labelColor:"main",labelFlush:"main",labelFlushOffset:"main",labelFont:"main",labelFontSize:"main",labelFontStyle:"main",labelFontWeight:"main",labelLimit:"main",labelLineHeight:"main",labelOffset:"main",labelOpacity:"main",labelOverlap:"main",labelPadding:"main",labels:"main",labelSeparation:"main",maxExtent:"main",minExtent:"main",offset:"both",position:"main",tickCap:"main",tickColor:"main",tickDash:"main",tickDashOffset:"main",tickMinStep:"both",tickOffset:"both",tickOpacity:"main",tickRound:"both",ticks:"main",tickSize:"main",tickWidth:"both",title:"main",titleAlign:"main",titleAnchor:"main",titleAngle:"main",titleBaseline:"main",titleColor:"main",titleFont:"main",titleFontSize:"main",titleFontStyle:"main",titleFontWeight:"main",titleLimit:"main",titleLineHeight:"main",titleOpacity:"main",titlePadding:"main",titleX:"main",titleY:"main",encode:"both",scale:"both",tickBand:"both",tickCount:"both",tickExtra:"both",translate:"both",values:"both",zindex:"both"},Wc={orient:1,aria:1,bandPosition:1,description:1,domain:1,domainCap:1,domainColor:1,domainDash:1,domainDashOffset:1,domainOpacity:1,domainWidth:1,format:1,formatType:1,grid:1,gridCap:1,gridColor:1,gridDash:1,gridDashOffset:1,gridOpacity:1,gridWidth:1,labelAlign:1,labelAngle:1,labelBaseline:1,labelBound:1,labelColor:1,labelFlush:1,labelFlushOffset:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelLineHeight:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labels:1,labelSeparation:1,maxExtent:1,minExtent:1,offset:1,position:1,tickBand:1,tickCap:1,tickColor:1,tickCount:1,tickDash:1,tickDashOffset:1,tickExtra:1,tickMinStep:1,tickOffset:1,tickOpacity:1,tickRound:1,ticks:1,tickSize:1,tickWidth:1,title:1,titleAlign:1,titleAnchor:1,titleAngle:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titlePadding:1,titleX:1,titleY:1,translate:1,values:1,zindex:1},dm=Object.assign(Object.assign({},Wc),{style:1,labelExpr:1,encoding:1});function Bc(e){return!!dm[e]}const gm={axis:1,axisBand:1,axisBottom:1,axisDiscrete:1,axisLeft:1,axisPoint:1,axisQuantitative:1,axisRight:1,axisTemporal:1,axisTop:1,axisX:1,axisXBand:1,axisXDiscrete:1,axisXPoint:1,axisXQuantitative:1,axisXTemporal:1,axisY:1,axisYBand:1,axisYDiscrete:1,axisYPoint:1,axisYQuantitative:1,axisYTemporal:1},Hc=v(gm);function ft(e){return"mark"in e}class Zi{constructor(t,n){this.name=t,this.run=n}hasMatchingType(t){return ft(t)?Bp(t.mark)===this.name:!1}}var pm=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Kt(e,t){const n=e&&e[t];return n?j(n)?Rt(n,i=>!!i.field):x(n)||Gi(n):!1}function qc(e,t){const n=e&&e[t];return n?j(n)?Rt(n,i=>!!i.field):x(n)||Xe(n)||ni(n):!1}function zs(e,t){if(ee(t)){const n=e[t];if((x(n)||Xe(n))&&sc(n.type)){const i=ba(t);return qc(e,i)}}return!1}function Is(e){return Rt(gd,t=>{if(Kt(e,t)){const n=e[t];if(j(n))return Rt(n,i=>!!i.aggregate);{const i=Ke(n);return i&&!!i.aggregate}}return!1})}function Gc(e,t){const n=[],i=[],r=[],s=[],o={};return Rs(e,(a,c)=>{if(x(a)){const{field:l,aggregate:u,bin:f,timeUnit:d}=a,g=pm(a,["field","aggregate","bin","timeUnit"]);if(u||d||f){const p=Ps(a),m=p==null?void 0:p.title;let h=_(a,{forAs:!0});const b=Object.assign(Object.assign(Object.assign({},m?[]:{title:On(a,t,{allowDisabling:!0})}),g),{field:h});if(u){let y;if(jt(u)?(y="argmax",h=_({op:"argmax",field:u.argmax},{forAs:!0}),b.field=`${h}.${l}`):ct(u)?(y="argmin",h=_({op:"argmin",field:u.argmin},{forAs:!0}),b.field=`${h}.${l}`):u!=="boxplot"&&u!=="errorbar"&&u!=="errorband"&&(y=u),y){const S={op:y,as:h};l&&(S.field=l),s.push(S)}}else if(n.push(h),we(a)&&U(f)){if(i.push({bin:f,field:l,as:h}),n.push(_(a,{binSuffix:"end"})),ii(a,c)&&n.push(_(a,{binSuffix:"range"})),ee(c)){const y={field:`${h}_end`};o[`${c}2`]=y}b.bin="binned",ha(c)||(b.type=qt)}else if(d){r.push({timeUnit:d,field:l,as:h});const y=we(a)&&a.type!==mn&&"time";y&&(c===Vn||c===Dt?b.formatType=y:_d(c)?b.legend=Object.assign({formatType:y},b.legend):ee(c)&&(b.axis=Object.assign({formatType:y},b.axis)))}o[c]=b}else n.push(l),o[c]=e[c]}else o[c]=e[c]}),{bins:i,timeUnits:r,aggregate:s,groupby:n,encoding:o}}function mm(e,t,n){const i=wd(t,n);if(i){if(i==="binned"){const r=e[t===Ee?G:J];return!!(x(r)&&x(e[t])&&ie(r.bin))}}else return!1;return!0}function hm(e,t,n,i){const r={};for(const s of v(e))ma(s)||O(pg(s));for(let s of vd){if(!e[s])continue;const o=e[s];if(gn(s)){const a=ya(s),c=r[a];if(x(c)){if(dp(c.type)&&x(o)){O(og(a));continue}}else s=a,O(ag(a))}if(s==="angle"&&t==="arc"&&!e.theta&&(O(sg),s=Se),!mm(e,s,t)){O(zi(s,t));continue}if(s===ot&&t==="line"){const a=Ke(e[s]);if(a==null?void 0:a.aggregate){O(dg);continue}}if(s===fe&&(n?"fill"in e:"stroke"in e)){O(qa("encoding",{fill:"fill"in e,stroke:"stroke"in e}));continue}if(s===Yn||s===Xn&&!j(o)&&!Pe(o)||s===Dt&&j(o))o&&(r[s]=V(o).reduce((a,c)=>(x(c)?a.push(As(c,s)):O(ns(c,s)),a),[]));else{if(s===Dt&&o===null)r[s]=null;else if(!x(o)&&!Xe(o)&&!Pe(o)&&!qi(o)&&!w(o)){O(ns(o,s));continue}r[s]=Lc(o,s,i)}}return r}function Ji(e,t){const n={};for(const i of v(e)){const r=Lc(e[i],i,t,{compositeMark:!0});n[i]=r}return n}function bm(e){const t=[];for(const n of v(e))if(Kt(e,n)){const i=e[n],r=V(i);for(const s of r)x(s)?t.push(s):Gi(s)&&t.push(s.condition)}return t}function Rs(e,t,n){if(!e)return;for(const i of v(e)){const r=e[i];if(j(r))for(const s of r)t.call(n,s,i);else t.call(n,r,i)}}function ym(e,t,n,i){return e?v(e).reduce((r,s)=>{const o=e[s];return j(o)?o.reduce((a,c)=>t.call(i,a,c,s),r):t.call(i,r,o,s)},n):n}function Vc(e,t){return v(t).reduce((n,i)=>{switch(i){case G:case J:case ki:case Fi:case Ci:case Ee:case Le:case bt:case fn:case Se:case st:case ke:case rt:case Me:case De:case Ce:case _e:case Vn:case de:case Mt:case Dt:return n;case Xn:if(e==="line"||e==="trail")return n;case Yn:case Ei:{const r=t[i];if(j(r)||x(r))for(const s of V(r))s.aggregate||n.push(_(s,{}));return n}case ot:if(e==="trail")return n;case fe:case Ue:case We:case at:case yt:case vt:case xt:case Ot:{const r=Ke(t[i]);return r&&!r.aggregate&&n.push(_(r,{})),n}}},[])}var Xc=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function vm(e){const{tooltip:t}=e,n=Xc(e,["tooltip"]);if(!t)return{filteredEncoding:n};let i,r;if(j(t)){for(const s of t)s.aggregate?(i||(i=[]),i.push(s)):(r||(r=[]),r.push(s));i&&(n.tooltip=i)}else t.aggregate?n.tooltip=t:r=t;return j(r)&&r.length===1&&(r=r[0]),{customTooltipWithoutAggregatedField:r,filteredEncoding:n}}function Ls(e,t,n,i=!0){if("tooltip"in n)return{tooltip:n.tooltip};const r=e.map(({fieldPrefix:o,titlePrefix:a})=>{const c=i?` of ${Ms(t)}`:"";return{field:o+t.field,type:t.type,title:w(a)?{signal:`${a}"${escape(c)}"`}:a+c}}),s=bm(n).map(em);return{tooltip:[...r,...Re(s,z)]}}function Ms(e){const{title:t,field:n}=e;return K(t,n)}function Ds(e,t,n,i,r){const{scale:s,axis:o}=n;return({partName:a,mark:c,positionPrefix:l,endPositionPrefix:u=void 0,extraEncoding:f={}})=>{const d=Ms(n);return Yc(e,a,r,{mark:c,encoding:Object.assign(Object.assign(Object.assign({[t]:Object.assign(Object.assign(Object.assign({field:`${l}_${n.field}`,type:n.type},d!==void 0?{title:d}:{}),s!==void 0?{scale:s}:{}),o!==void 0?{axis:o}:{})},N(u)?{[`${t}2`]:{field:`${u}_${n.field}`}}:{}),i),f)})}}function Yc(e,t,n,i){const{clip:r,color:s,opacity:o}=e,a=e.type;return e[t]||e[t]===void 0&&n[t]?[Object.assign(Object.assign({},i),{mark:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},n[t]),r?{clip:r}:{}),s?{color:s}:{}),o?{opacity:o}:{}),Ge(i.mark)?i.mark:{type:i.mark}),{style:`${a}-${String(t)}`}),Un(e[t])?{}:e[t])})]:[]}function Kc(e,t,n){const{encoding:i}=e,r=t==="vertical"?"y":"x",s=i[r],o=i[`${r}2`],a=i[`${r}Error`],c=i[`${r}Error2`];return{continuousAxisChannelDef:er(s,n),continuousAxisChannelDef2:er(o,n),continuousAxisChannelDefError:er(a,n),continuousAxisChannelDefError2:er(c,n),continuousAxis:r}}function er(e,t){if(e==null?void 0:e.aggregate){const{aggregate:n}=e,i=Xc(e,["aggregate"]);return n!==t&&O(Wg(n,t)),i}else return e}function Qc(e,t){const{mark:n,encoding:i}=e,{x:r,y:s}=i;if(Ge(n)&&n.orient)return n.orient;if(Ye(r)){if(Ye(s)){const o=x(r)&&r.aggregate,a=x(s)&&s.aggregate;if(!o&&a===t)return"vertical";if(!a&&o===t)return"horizontal";if(o===t&&a===t)throw new Error("Both x and y cannot have aggregate");return Sn(s)&&!Sn(r)?"horizontal":"vertical"}return"horizontal"}else{if(Ye(s))return"vertical";throw new Error(`Need a valid continuous axis for ${t}s`)}}var tr=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const nr="boxplot",Om=["box","median","outliers","rule","ticks"],xm=new Zi(nr,Jc);function Zc(e){return Y(e)?"tukey":e}function Jc(e,{config:t}){var n,i;e=Object.assign(Object.assign({},e),{encoding:Ji(e.encoding,t)});const{mark:r,encoding:s,params:o,projection:a}=e,c=tr(e,["mark","encoding","params","projection"]),l=Ge(r)?r:{type:r};o&&O(Da("boxplot"));const u=(n=l.extent)!==null&&n!==void 0?n:t.boxplot.extent,f=R("size",l,t),d=l.invalid,g=Zc(u),{bins:p,timeUnits:m,transform:h,continuousAxisChannelDef:b,continuousAxis:y,groupby:S,aggregate:k,encodingWithoutContinuousAxis:E,ticksOrient:P,boxOrient:$,customTooltipWithoutAggregatedField:T}=Sm(e,u,t),{color:X,size:Oe}=E,bi=tr(E,["color","size"]),mt=$f=>Ds(l,y,b,$f,t.boxplot),In=mt(bi),Nr=mt(E),Pr=mt(Object.assign(Object.assign({},bi),Oe?{size:Oe}:{})),Rn=Ls([{fieldPrefix:g==="min-max"?"upper_whisker_":"max_",titlePrefix:"Max"},{fieldPrefix:"upper_box_",titlePrefix:"Q3"},{fieldPrefix:"mid_box_",titlePrefix:"Median"},{fieldPrefix:"lower_box_",titlePrefix:"Q1"},{fieldPrefix:g==="min-max"?"lower_whisker_":"min_",titlePrefix:"Min"}],b,E),yi={type:"tick",color:"black",opacity:1,orient:P,invalid:d,aria:!1},rn=g==="min-max"?Rn:Ls([{fieldPrefix:"upper_whisker_",titlePrefix:"Upper Whisker"},{fieldPrefix:"lower_whisker_",titlePrefix:"Lower Whisker"}],b,E),Ln=[...In({partName:"rule",mark:{type:"rule",invalid:d,aria:!1},positionPrefix:"lower_whisker",endPositionPrefix:"lower_box",extraEncoding:rn}),...In({partName:"rule",mark:{type:"rule",invalid:d,aria:!1},positionPrefix:"upper_box",endPositionPrefix:"upper_whisker",extraEncoding:rn}),...In({partName:"ticks",mark:yi,positionPrefix:"lower_whisker",extraEncoding:rn}),...In({partName:"ticks",mark:yi,positionPrefix:"upper_whisker",extraEncoding:rn})],Mn=[...g!=="tukey"?Ln:[],...Nr({partName:"box",mark:Object.assign(Object.assign({type:"bar"},f?{size:f}:{}),{orient:$,invalid:d,ariaRoleDescription:"box"}),positionPrefix:"lower_box",endPositionPrefix:"upper_box",extraEncoding:Rn}),...Pr({partName:"median",mark:Object.assign(Object.assign(Object.assign({type:"tick",invalid:d},H(t.boxplot.median)&&t.boxplot.median.color?{color:t.boxplot.median.color}:{}),f?{size:f}:{}),{orient:P,aria:!1}),positionPrefix:"mid_box",extraEncoding:Rn})];if(g==="min-max")return Object.assign(Object.assign({},c),{transform:((i=c.transform)!==null&&i!==void 0?i:[]).concat(h),layer:Mn});const Dn=`datum["lower_box_${b.field}"]`,vi=`datum["upper_box_${b.field}"]`,Go=`(${vi} - ${Dn})`,Vo=`${Dn} - ${u} * ${Go}`,Xo=`${vi} + ${u} * ${Go}`,Oi=`datum["${b.field}"]`,_f={joinaggregate:el(b.field),groupby:S},Yo={transform:[{filter:`(${Vo} <= ${Oi}) && (${Oi} <= ${Xo})`},{aggregate:[{op:"min",field:b.field,as:`lower_whisker_${b.field}`},{op:"max",field:b.field,as:`upper_whisker_${b.field}`},{op:"min",field:`lower_box_${b.field}`,as:`lower_box_${b.field}`},{op:"max",field:`upper_box_${b.field}`,as:`upper_box_${b.field}`},...k],groupby:S}],layer:Ln},jf=tr(bi,["tooltip"]),{scale:Ko,axis:wf}=b,Qo=Ms(b),Zo=ue(wf,["title"]),Jo=Yc(l,"outliers",t.boxplot,{transform:[{filter:`(${Oi} < ${Vo}) || (${Oi} > ${Xo})`}],mark:"point",encoding:Object.assign(Object.assign(Object.assign({[y]:Object.assign(Object.assign(Object.assign({field:b.field,type:b.type},Qo!==void 0?{title:Qo}:{}),Ko!==void 0?{scale:Ko}:{}),L(Zo)?{}:{axis:Zo})},jf),X?{color:X}:{}),T?{tooltip:T}:{})})[0];let xi;const ea=[...p,...m,_f];return Jo?xi={transform:ea,layer:[Jo,Yo]}:(xi=Yo,xi.transform.unshift(...ea)),Object.assign(Object.assign({},c),{layer:[xi,{transform:h,layer:Mn}]})}function el(e){return[{op:"q1",field:e,as:`lower_box_${e}`},{op:"q3",field:e,as:`upper_box_${e}`}]}function Sm(e,t,n){const i=Qc(e,nr),{continuousAxisChannelDef:r,continuousAxis:s}=Kc(e,i,nr),o=r.field,a=Zc(t),c=[...el(o),{op:"median",field:o,as:`mid_box_${o}`},{op:"min",field:o,as:(a==="min-max"?"lower_whisker_":"min_")+o},{op:"max",field:o,as:(a==="min-max"?"upper_whisker_":"max_")+o}],l=a==="min-max"||a==="tukey"?[]:[{calculate:`datum["upper_box_${o}"] - datum["lower_box_${o}"]`,as:`iqr_${o}`},{calculate:`min(datum["upper_box_${o}"] + datum["iqr_${o}"] * ${t}, datum["max_${o}"])`,as:`upper_whisker_${o}`},{calculate:`max(datum["lower_box_${o}"] - datum["iqr_${o}"] * ${t}, datum["min_${o}"])`,as:`lower_whisker_${o}`}],u=e.encoding,f=s,d=u[f],g=tr(u,[typeof f=="symbol"?f:f+""]),{customTooltipWithoutAggregatedField:p,filteredEncoding:m}=vm(g),{bins:h,timeUnits:b,aggregate:y,groupby:S,encoding:k}=Gc(m,n),E=i==="vertical"?"horizontal":"vertical",P=i,$=[...h,...b,{aggregate:[...y,...c],groupby:S},...l];return{bins:h,timeUnits:b,transform:$,groupby:S,aggregate:y,continuousAxisChannelDef:r,continuousAxis:s,encodingWithoutContinuousAxis:k,ticksOrient:E,boxOrient:P,customTooltipWithoutAggregatedField:p}}var tl=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const Us="errorbar",_m=["ticks","rule"],jm=new Zi(Us,nl);function nl(e,{config:t}){e=Object.assign(Object.assign({},e),{encoding:Ji(e.encoding,t)});const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,ticksOrient:o,markDef:a,outerSpec:c,tooltipEncoding:l}=il(e,Us,t);delete s.size;const u=Ds(a,r,i,s,t.errorbar),f=a.thickness,d=a.size,g=Object.assign(Object.assign({type:"tick",orient:o,aria:!1},f!==void 0?{thickness:f}:{}),d!==void 0?{size:d}:{}),p=[...u({partName:"ticks",mark:g,positionPrefix:"lower",extraEncoding:l}),...u({partName:"ticks",mark:g,positionPrefix:"upper",extraEncoding:l}),...u({partName:"rule",mark:Object.assign({type:"rule",ariaRoleDescription:"errorbar"},f!==void 0?{size:f}:{}),positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:l})];return Object.assign(Object.assign(Object.assign({},c),{transform:n}),p.length>1?{layer:p}:Object.assign({},p[0]))}function wm(e,t){const{encoding:n}=e;if($m(n))return{orient:Qc(e,t),inputType:"raw"};const i=Em(n),r=km(n),s=n.x,o=n.y;if(i){if(r)throw new Error(`${t} cannot be both type aggregated-upper-lower and aggregated-error`);const a=n.x2,c=n.y2;if(C(a)&&C(c))throw new Error(`${t} cannot have both x2 and y2`);if(C(a)){if(Ye(s))return{orient:"horizontal",inputType:"aggregated-upper-lower"};throw new Error(`Both x and x2 have to be quantitative in ${t}`)}else if(C(c)){if(Ye(o))return{orient:"vertical",inputType:"aggregated-upper-lower"};throw new Error(`Both y and y2 have to be quantitative in ${t}`)}throw new Error("No ranged axis")}else{const a=n.xError,c=n.xError2,l=n.yError,u=n.yError2;if(C(c)&&!C(a))throw new Error(`${t} cannot have xError2 without xError`);if(C(u)&&!C(l))throw new Error(`${t} cannot have yError2 without yError`);if(C(a)&&C(l))throw new Error(`${t} cannot have both xError and yError with both are quantiative`);if(C(a)){if(Ye(s))return{orient:"horizontal",inputType:"aggregated-error"};throw new Error("All x, xError, and xError2 (if exist) have to be quantitative")}else if(C(l)){if(Ye(o))return{orient:"vertical",inputType:"aggregated-error"};throw new Error("All y, yError, and yError2 (if exist) have to be quantitative")}throw new Error("No ranged axis")}}function $m(e){return(C(e.x)||C(e.y))&&!C(e.x2)&&!C(e.y2)&&!C(e.xError)&&!C(e.xError2)&&!C(e.yError)&&!C(e.yError2)}function Em(e){return C(e.x2)||C(e.y2)}function km(e){return C(e.xError)||C(e.xError2)||C(e.yError)||C(e.yError2)}function il(e,t,n){var i;const{mark:r,encoding:s,params:o,projection:a}=e,c=tl(e,["mark","encoding","params","projection"]),l=Ge(r)?r:{type:r};o&&O(Da(t));const{orient:u,inputType:f}=wm(e,t),{continuousAxisChannelDef:d,continuousAxisChannelDef2:g,continuousAxisChannelDefError:p,continuousAxisChannelDefError2:m,continuousAxis:h}=Kc(e,u,t),{errorBarSpecificAggregate:b,postAggregateCalculates:y,tooltipSummary:S,tooltipTitleWithFieldName:k}=Cm(l,d,g,p,m,f,t,n),E=s,P=h,$=E[P],T=h==="x"?"x2":"y2",X=E[T],Oe=h==="x"?"xError":"yError",bi=E[Oe],mt=h==="x"?"xError2":"yError2",In=E[mt],Nr=tl(E,[typeof P=="symbol"?P:P+"",typeof T=="symbol"?T:T+"",typeof Oe=="symbol"?Oe:Oe+"",typeof mt=="symbol"?mt:mt+""]),{bins:Pr,timeUnits:Rn,aggregate:yi,groupby:rn,encoding:Ln}=Gc(Nr,n),Mn=[...yi,...b],Dn=f!=="raw"?[]:rn,vi=Ls(S,d,Ln,k);return{transform:[...(i=c.transform)!==null&&i!==void 0?i:[],...Pr,...Rn,...Mn.length===0?[]:[{aggregate:Mn,groupby:Dn}],...y],groupby:Dn,continuousAxisChannelDef:d,continuousAxis:h,encodingWithoutContinuousAxis:Ln,ticksOrient:u==="vertical"?"horizontal":"vertical",markDef:l,outerSpec:c,tooltipEncoding:vi}}function Cm(e,t,n,i,r,s,o,a){let c=[],l=[];const u=t.field;let f,d=!1;if(s==="raw"){const g=e.center?e.center:e.extent?e.extent==="iqr"?"median":"mean":a.errorbar.center,p=e.extent?e.extent:g==="mean"?"stderr":"iqr";if(g==="median"!==(p==="iqr")&&O(Ug(g,p,o)),p==="stderr"||p==="stdev")c=[{op:p,field:u,as:`extent_${u}`},{op:g,field:u,as:`center_${u}`}],l=[{calculate:`datum["center_${u}"] + datum["extent_${u}"]`,as:`upper_${u}`},{calculate:`datum["center_${u}"] - datum["extent_${u}"]`,as:`lower_${u}`}],f=[{fieldPrefix:"center_",titlePrefix:Hn(g)},{fieldPrefix:"upper_",titlePrefix:rl(g,p,"+")},{fieldPrefix:"lower_",titlePrefix:rl(g,p,"-")}],d=!0;else{let m,h,b;p==="ci"?(m="mean",h="ci0",b="ci1"):(m="median",h="q1",b="q3"),c=[{op:h,field:u,as:`lower_${u}`},{op:b,field:u,as:`upper_${u}`},{op:m,field:u,as:`center_${u}`}],f=[{fieldPrefix:"upper_",titlePrefix:On({field:u,aggregate:b,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"lower_",titlePrefix:On({field:u,aggregate:h,type:"quantitative"},a,{allowDisabling:!1})},{fieldPrefix:"center_",titlePrefix:On({field:u,aggregate:m,type:"quantitative"},a,{allowDisabling:!1})}]}}else{(e.center||e.extent)&&O(Dg(e.center,e.extent)),s==="aggregated-upper-lower"?(f=[],l=[{calculate:`datum["${n.field}"]`,as:`upper_${u}`},{calculate:`datum["${u}"]`,as:`lower_${u}`}]):s==="aggregated-error"&&(f=[{fieldPrefix:"",titlePrefix:u}],l=[{calculate:`datum["${u}"] + datum["${i.field}"]`,as:`upper_${u}`}],r?l.push({calculate:`datum["${u}"] + datum["${r.field}"]`,as:`lower_${u}`}):l.push({calculate:`datum["${u}"] - datum["${i.field}"]`,as:`lower_${u}`}));for(const g of l)f.push({fieldPrefix:g.as.substring(0,6),titlePrefix:Lt(Lt(g.calculate,'datum["',""),'"]',"")})}return{postAggregateCalculates:l,errorBarSpecificAggregate:c,tooltipSummary:f,tooltipTitleWithFieldName:d}}function rl(e,t,n){return`${Hn(e)} ${n} ${t}`}const Ws="errorband",Fm=["band","borders"],Nm=new Zi(Ws,sl);function sl(e,{config:t}){e=Object.assign(Object.assign({},e),{encoding:Ji(e.encoding,t)});const{transform:n,continuousAxisChannelDef:i,continuousAxis:r,encodingWithoutContinuousAxis:s,markDef:o,outerSpec:a,tooltipEncoding:c}=il(e,Ws,t),l=o,u=Ds(l,r,i,s,t.errorband),f=e.encoding.x!==void 0&&e.encoding.y!==void 0;let d={type:f?"area":"rect"},g={type:f?"line":"rule"};const p=Object.assign(Object.assign({},l.interpolate?{interpolate:l.interpolate}:{}),l.tension&&l.interpolate?{tension:l.tension}:{});return f?(d=Object.assign(Object.assign(Object.assign({},d),p),{ariaRoleDescription:"errorband"}),g=Object.assign(Object.assign(Object.assign({},g),p),{aria:!1})):l.interpolate?O(Ya("interpolate")):l.tension&&O(Ya("tension")),Object.assign(Object.assign({},a),{transform:n,layer:[...u({partName:"band",mark:d,positionPrefix:"lower",endPositionPrefix:"upper",extraEncoding:c}),...u({partName:"borders",mark:g,positionPrefix:"lower",extraEncoding:c}),...u({partName:"borders",mark:g,positionPrefix:"upper",extraEncoding:c})]})}const ol={};function Bs(e,t,n){const i=new Zi(e,t);ol[e]={normalizer:i,parts:n}}function Pm(){return v(ol)}Bs(nr,Jc,Om),Bs(Us,nl,_m),Bs(Ws,sl,Fm);const Tm=["gradientHorizontalMaxLength","gradientHorizontalMinLength","gradientVerticalMaxLength","gradientVerticalMinLength","unselectedOpacity"],al={titleAlign:"align",titleAnchor:"anchor",titleAngle:"angle",titleBaseline:"baseline",titleColor:"color",titleFont:"font",titleFontSize:"fontSize",titleFontStyle:"fontStyle",titleFontWeight:"fontWeight",titleLimit:"limit",titleLineHeight:"lineHeight",titleOrient:"orient",titlePadding:"offset"},cl={labelAlign:"align",labelAnchor:"anchor",labelAngle:"angle",labelBaseline:"baseline",labelColor:"color",labelFont:"font",labelFontSize:"fontSize",labelFontStyle:"fontStyle",labelFontWeight:"fontWeight",labelLimit:"limit",labelLineHeight:"lineHeight",labelOrient:"orient",labelPadding:"offset"},Am=v(al),zm=v(cl),Im={header:1,headerRow:1,headerColumn:1,headerFacet:1},ll=v(Im),ul=["size","shape","fill","stroke","strokeDash","strokeWidth","opacity"],Rm={gradientHorizontalMaxLength:200,gradientHorizontalMinLength:100,gradientVerticalMaxLength:200,gradientVerticalMinLength:64,unselectedOpacity:.35},Lm={aria:1,clipHeight:1,columnPadding:1,columns:1,cornerRadius:1,description:1,direction:1,fillColor:1,format:1,formatType:1,gradientLength:1,gradientOpacity:1,gradientStrokeColor:1,gradientStrokeWidth:1,gradientThickness:1,gridAlign:1,labelAlign:1,labelBaseline:1,labelColor:1,labelFont:1,labelFontSize:1,labelFontStyle:1,labelFontWeight:1,labelLimit:1,labelOffset:1,labelOpacity:1,labelOverlap:1,labelPadding:1,labelSeparation:1,legendX:1,legendY:1,offset:1,orient:1,padding:1,rowPadding:1,strokeColor:1,symbolDash:1,symbolDashOffset:1,symbolFillColor:1,symbolLimit:1,symbolOffset:1,symbolOpacity:1,symbolSize:1,symbolStrokeColor:1,symbolStrokeWidth:1,symbolType:1,tickCount:1,tickMinStep:1,title:1,titleAlign:1,titleAnchor:1,titleBaseline:1,titleColor:1,titleFont:1,titleFontSize:1,titleFontStyle:1,titleFontWeight:1,titleLimit:1,titleLineHeight:1,titleOpacity:1,titleOrient:1,titlePadding:1,type:1,values:1,zindex:1},Qe="_vgsid_",Mm={point:{on:"click",fields:[Qe],toggle:"event.shiftKey",resolve:"global",clear:"dblclick"},interval:{on:"[mousedown, window:mouseup] > window:mousemove!",encodings:["x","y"],translate:"[mousedown, window:mouseup] > window:mousemove!",zoom:"wheel!",mark:{fill:"#333",fillOpacity:.125,stroke:"white"},resolve:"global",clear:"dblclick"}};function Hs(e){return e==="legend"||!!(e==null?void 0:e.legend)}function qs(e){return Hs(e)&&H(e)}function Gs(e){return!!(e==null?void 0:e.select)}var Dm=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function fl(e){const t=[];for(const n of e||[]){if(Gs(n))continue;const{expr:i,bind:r}=n,s=Dm(n,["expr","bind"]);if(r&&i){const o=Object.assign(Object.assign({},s),{bind:r,init:i});t.push(o)}else{const o=Object.assign(Object.assign(Object.assign({},s),i?{update:i}:{}),r?{bind:r}:{});t.push(o)}}return t}function Um(e){return ir(e)||Xs(e)||Vs(e)}function Vs(e){return"concat"in e}function ir(e){return"vconcat"in e}function Xs(e){return"hconcat"in e}function dl({step:e,offsetIsDiscrete:t}){var n;return t?(n=e.for)!==null&&n!==void 0?n:"offset":"position"}function Ze(e){return H(e)&&e.step!==void 0}function gl(e){return e.view||e.width||e.height}const pl=20,Wm={align:1,bounds:1,center:1,columns:1,spacing:1},Bm=v(Wm);function Hm(e,t,n){var i,r;const s=n[t],o={},{spacing:a,columns:c}=s;a!==void 0&&(o.spacing=a),c!==void 0&&((Hi(e)&&!ti(e.facet)||Vs(e))&&(o.columns=c)),ir(e)&&(o.columns=1);for(const l of Bm)if(e[l]!==void 0)if(l==="spacing"){const u=e[l];o[l]=Y(u)?u:{row:(i=u.row)!==null&&i!==void 0?i:a,column:(r=u.column)!==null&&r!==void 0?r:a}}else o[l]=e[l];return o}var qm=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Ys(e,t){var n;return(n=e[t])!==null&&n!==void 0?n:e[t==="width"?"continuousWidth":"continuousHeight"]}function rr(e,t){const n=sr(e,t);return Ze(n)?n.step:ml}function sr(e,t){var n;const i=(n=e[t])!==null&&n!==void 0?n:e[t==="width"?"discreteWidth":"discreteHeight"];return K(i,{step:e.step})}const ml=20,Gm={continuousWidth:200,continuousHeight:200,step:ml},Vm={background:"white",padding:5,timeFormat:"%b %d, %Y",countTitle:"Count of Records",view:Gm,mark:Rp,arc:{},area:{},bar:Dp,circle:{},geoshape:{},image:{},line:{},point:{},rect:Up,rule:{color:"black"},square:{},text:{color:"black"},tick:Wp,trail:{},boxplot:{size:14,extent:1.5,box:{},median:{color:"white"},outliers:{},rule:{},ticks:null},errorbar:{center:"mean",rule:!0,ticks:!1},errorband:{band:{opacity:.3},borders:!1},scale:vp,projection:{},legend:Rm,header:{titlePadding:10,labelPadding:10},headerColumn:{},headerRow:{},headerFacet:{},selection:Mm,style:{},title:{},facet:{spacing:pl},concat:{spacing:pl},normalizedNumberFormat:".0%"},dt=["#4c78a8","#f58518","#e45756","#72b7b2","#54a24b","#eeca3b","#b279a2","#ff9da6","#9d755d","#bab0ac"],hl={text:11,guideLabel:10,guideTitle:11,groupTitle:13,groupSubtitle:12},bl={blue:dt[0],orange:dt[1],red:dt[2],teal:dt[3],green:dt[4],yellow:dt[5],purple:dt[6],pink:dt[7],brown:dt[8],gray0:"#000",gray1:"#111",gray2:"#222",gray3:"#333",gray4:"#444",gray5:"#555",gray6:"#666",gray7:"#777",gray8:"#888",gray9:"#999",gray10:"#aaa",gray11:"#bbb",gray12:"#ccc",gray13:"#ddd",gray14:"#eee",gray15:"#fff"};function Xm(e={}){return{signals:[{name:"color",value:H(e)?Object.assign(Object.assign({},bl),e):bl}],mark:{color:{signal:"color.blue"}},rule:{color:{signal:"color.gray0"}},text:{color:{signal:"color.gray0"}},style:{"guide-label":{fill:{signal:"color.gray0"}},"guide-title":{fill:{signal:"color.gray0"}},"group-title":{fill:{signal:"color.gray0"}},"group-subtitle":{fill:{signal:"color.gray0"}},cell:{stroke:{signal:"color.gray8"}}},axis:{domainColor:{signal:"color.gray13"},gridColor:{signal:"color.gray8"},tickColor:{signal:"color.gray13"}},range:{category:[{signal:"color.blue"},{signal:"color.orange"},{signal:"color.red"},{signal:"color.teal"},{signal:"color.green"},{signal:"color.yellow"},{signal:"color.purple"},{signal:"color.pink"},{signal:"color.brown"},{signal:"color.grey8"}]}}}function Ym(e){return{signals:[{name:"fontSize",value:H(e)?Object.assign(Object.assign({},hl),e):hl}],text:{fontSize:{signal:"fontSize.text"}},style:{"guide-label":{fontSize:{signal:"fontSize.guideLabel"}},"guide-title":{fontSize:{signal:"fontSize.guideTitle"}},"group-title":{fontSize:{signal:"fontSize.groupTitle"}},"group-subtitle":{fontSize:{signal:"fontSize.groupSubtitle"}}}}}function Km(e){return{text:{font:e},style:{"guide-label":{font:e},"guide-title":{font:e},"group-title":{font:e},"group-subtitle":{font:e}}}}function yl(e){const t=v(e||{}),n={};for(const i of t){const r=e[i];n[i]=ri(r)?Ea(r):be(r)}return n}function Qm(e){const t=v(e),n={};for(const i of t)n[i]=yl(e[i]);return n}const Zm=[...yc,...Hc,...ll,"background","padding","legend","lineBreak","scale","style","title","view"];function vl(e={}){const{color:t,font:n,fontSize:i,selection:r}=e,s=qm(e,["color","font","fontSize","selection"]),o=ta({},F(Vm),n?Km(n):{},t?Xm(t):{},i?Ym(i):{},s||{});r&&Af(o,"selection",r,!0);const a=ue(o,Zm);for(const c of["background","lineBreak","padding"])o[c]&&(a[c]=be(o[c]));for(const c of yc)o[c]&&(a[c]=pe(o[c]));for(const c of Hc)o[c]&&(a[c]=yl(o[c]));for(const c of ll)o[c]&&(a[c]=pe(o[c]));return o.legend&&(a.legend=pe(o.legend)),o.scale&&(a.scale=pe(o.scale)),o.style&&(a.style=Qm(o.style)),o.title&&(a.title=pe(o.title)),o.view&&(a.view=pe(o.view)),a}const Jm=new Set(["view",...Np]),eh=["color","fontSize","background","padding","facet","concat","numberFormat","numberFormatType","normalizedNumberFormat","normalizedNumberFormatType","timeFormat","countTitle","header","axisQuantitative","axisTemporal","axisDiscrete","axisPoint","axisXBand","axisXPoint","axisXDiscrete","axisXQuantitative","axisXTemporal","axisYBand","axisYPoint","axisYDiscrete","axisYQuantitative","axisYTemporal","scale","selection","overlay"],th=Object.assign({view:["continuousWidth","continuousHeight","discreteWidth","discreteHeight","step"]},Ip);function nh(e){e=F(e);for(const t of eh)delete e[t];if(e.axis)for(const t in e.axis)ri(e.axis[t])&&delete e.axis[t];if(e.legend)for(const t of Tm)delete e.legend[t];if(e.mark){for(const t of bc)delete e.mark[t];e.mark.tooltip&&H(e.mark.tooltip)&&delete e.mark.tooltip}e.params&&(e.signals=(e.signals||[]).concat(fl(e.params)),delete e.params);for(const t of Jm){for(const i of bc)delete e[t][i];const n=th[t];if(n)for(const i of n)delete e[t][i];rh(e,t)}for(const t of Pm())delete e[t];ih(e);for(const t in e)H(e[t])&&L(e[t])&&delete e[t];return L(e)?void 0:e}function ih(e){const{titleMarkConfig:t,subtitleMarkConfig:n,subtitle:i}=$a(e.title);L(t)||(e.style["group-title"]=Object.assign(Object.assign({},e.style["group-title"]),t)),L(n)||(e.style["group-subtitle"]=Object.assign(Object.assign({},e.style["group-subtitle"]),n)),L(i)?delete e.title:e.title=i}function rh(e,t,n,i){const r=i?e[t][i]:e[t];t==="view"&&(n="cell");const s=Object.assign(Object.assign({},r),e.style[n??t]);L(s)||(e.style[n??t]=s),i||delete e[t]}function or(e){return"layer"in e}function sh(e){return"repeat"in e}function oh(e){return!j(e.repeat)&&e.repeat.layer}var ah=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class Ks{map(t,n){return Hi(t)?this.mapFacet(t,n):sh(t)?this.mapRepeat(t,n):Xs(t)?this.mapHConcat(t,n):ir(t)?this.mapVConcat(t,n):Vs(t)?this.mapConcat(t,n):this.mapLayerOrUnit(t,n)}mapLayerOrUnit(t,n){if(or(t))return this.mapLayer(t,n);if(ft(t))return this.mapUnit(t,n);throw new Error(es(t))}mapLayer(t,n){return Object.assign(Object.assign({},t),{layer:t.layer.map(i=>this.mapLayerOrUnit(i,n))})}mapHConcat(t,n){return Object.assign(Object.assign({},t),{hconcat:t.hconcat.map(i=>this.map(i,n))})}mapVConcat(t,n){return Object.assign(Object.assign({},t),{vconcat:t.vconcat.map(i=>this.map(i,n))})}mapConcat(t,n){const{concat:i}=t,r=ah(t,["concat"]);return Object.assign(Object.assign({},r),{concat:i.map(s=>this.map(s,n))})}mapFacet(t,n){return Object.assign(Object.assign({},t),{spec:this.map(t.spec,n)})}mapRepeat(t,n){return Object.assign(Object.assign({},t),{spec:this.map(t.spec,n)})}}const ch={zero:1,center:1,normalize:1};function lh(e){return e in ch}const uh=new Set([gc,Li,Ri,Ui,Di,xs,Ss,Mi,pc,Os]),fh=new Set([Li,Ri,gc]);function _n(e){return x(e)&&yn(e)==="quantitative"&&!e.bin}function Ol(e,t){var n,i;const r=t==="x"?"y":"radius",s=e[t],o=e[r];if(x(s)&&x(o))if(_n(s)&&_n(o)){if(s.stack)return t;if(o.stack)return r;const a=x(s)&&!!s.aggregate,c=x(o)&&!!o.aggregate;if(a!==c)return a?t:r;{const l=(n=s.scale)===null||n===void 0?void 0:n.type,u=(i=o.scale)===null||i===void 0?void 0:i.type;if(l&&l!=="linear")return r;if(u&&u!=="linear")return t}}else{if(_n(s))return t;if(_n(o))return r}else{if(_n(s))return t;if(_n(o))return r}return}function dh(e){switch(e){case"x":return"y";case"y":return"x";case"theta":return"radius";case"radius":return"theta"}}function xl(e,t){var n,i;const r=Ge(e)?e.type:e;if(!uh.has(r))return null;const s=Ol(t,"x")||Ol(t,"theta");if(!s)return null;const o=t[s],a=x(o)?_(o,{}):void 0,c=dh(s),l=[],u=new Set;if(t[c]){const g=t[c],p=x(g)?_(g,{}):void 0;p&&p!==a&&(l.push(c),u.add(p));const m=c==="x"?"xOffset":"yOffset",h=t[m],b=x(h)?_(h,{}):void 0;b&&b!==a&&(l.push(m),u.add(b))}const f=Od.reduce((g,p)=>{if(p!=="tooltip"&&Kt(t,p)){const m=t[p];for(const h of V(m)){const b=Ke(h);if(b.aggregate)continue;const y=_(b,{});(!y||!u.has(y))&&g.push({channel:p,fieldDef:b})}}return g},[]);let d;return o.stack!==void 0?Un(o.stack)?d=o.stack?"zero":null:d=o.stack:fh.has(r)&&(d="zero"),!d||!lh(d)||Is(t)&&f.length===0?null:((n=o==null?void 0:o.scale)===null||n===void 0?void 0:n.type)&&((i=o==null?void 0:o.scale)===null||i===void 0?void 0:i.type)!==me.LINEAR?(O(Rg(o.scale.type)),null):C(t[Be(s)])?(o.stack!==void 0&&O(Ig(s)),null):(x(o)&&o.aggregate&&!Pd.has(o.aggregate)&&O(Lg(o.aggregate)),{groupbyChannels:l,groupbyFields:u,fieldChannel:s,impute:o.impute===null?!1:Et(r),stackBy:f,offset:d})}var Sl=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function gh(e){const t=Sl(e,["point","line"]);return v(t).length>1?t:t.type}function ph(e){for(const t of["line","area","rule","trail"])e[t]&&(e=Object.assign(Object.assign({},e),{[t]:ue(e[t],["point","line"])}));return e}function Qs(e,t={},n){return e.point==="transparent"?{opacity:0}:e.point?H(e.point)?e.point:{}:e.point!==void 0?null:t.point||n.shape?H(t.point)?t.point:{}:void 0}function _l(e,t={}){return e.line?e.line===!0?{}:e.line:e.line!==void 0?null:t.line?t.line===!0?{}:t.line:void 0}class mh{constructor(){this.name="path-overlay"}hasMatchingType(t,n){if(ft(t)){const{mark:i,encoding:r}=t,s=Ge(i)?i:{type:i};switch(s.type){case"line":case"rule":case"trail":return!!Qs(s,n[s.type],r);case"area":return!!Qs(s,n[s.type],r)||!!_l(s,n[s.type])}}return!1}run(t,n,i){const{config:r}=n,{params:s,projection:o,mark:a,encoding:c}=t,l=Sl(t,["params","projection","mark","encoding"]),u=Ji(c,r),f=Ge(a)?a:{type:a},d=Qs(f,r[f.type],u),g=f.type==="area"&&_l(f,r[f.type]),p=[Object.assign(Object.assign({},s?{params:s}:{}),{mark:gh(Object.assign(Object.assign({},f.type==="area"&&f.opacity===void 0&&f.fillOpacity===void 0?{opacity:.7}:{}),f)),encoding:ue(u,["shape"])})],m=xl(f,u);let h=u;if(m){const{fieldChannel:b,offset:y}=m;h=Object.assign(Object.assign({},u),{[b]:Object.assign(Object.assign({},u[b]),y?{stack:y}:{})})}return h=ue(h,["y2","x2"]),g&&p.push(Object.assign(Object.assign({},o?{projection:o}:{}),{mark:Object.assign(Object.assign({type:"line"},ln(f,["clip","interpolate","tension","tooltip"])),g),encoding:h})),d&&p.push(Object.assign(Object.assign({},o?{projection:o}:{}),{mark:Object.assign(Object.assign({type:"point",opacity:1,filled:!0},ln(f,["clip","tooltip"])),d),encoding:h})),i(Object.assign(Object.assign({},l),{layer:p}),Object.assign(Object.assign({},n),{config:ph(r)}))}}var hh=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function bh(e,t){return t?ti(e)?El(e,t):jl(e,t):e}function Zs(e,t){return t?El(e,t):e}function Js(e,t,n){const i=t[e];if(Zp(i)){if(i.repeat in n)return Object.assign(Object.assign({},t),{[e]:n[i.repeat]});O(Zd(i.repeat));return}return t}function jl(e,t){if(e=Js("field",e,t),e===void 0)return;if(e===null)return null;if(Fs(e)&&Ve(e.sort)){const n=Js("field",e.sort,t);e=Object.assign(Object.assign({},e),n?{sort:n}:{})}return e}function wl(e,t){if(x(e))return jl(e,t);{const n=Js("datum",e,t);return n!==e&&!n.type&&(n.type="nominal"),n}}function $l(e,t){if(C(e)){const n=wl(e,t);if(n)return n;if(qi(e))return{condition:e.condition}}else{if(ni(e)){const n=wl(e.condition,t);if(n)return Object.assign(Object.assign({},e),{condition:n});{const i=hh(e,["condition"]);return i}}return e}return}function El(e,t){const n={};for(const i in e)if(sn(e,i)){const r=e[i];if(j(r))n[i]=r.map(s=>$l(s,t)).filter(s=>s);else{const s=$l(r,t);s!==void 0&&(n[i]=s)}}return n}class yh{constructor(){this.name="RuleForRangedLine"}hasMatchingType(t){if(ft(t)){const{encoding:n,mark:i}=t;if(i==="line"||Ge(i)&&i.type==="line")for(const r of bd){const s=Ut(r),o=n[s];if(n[r]&&(x(o)&&!ie(o.bin)||Xe(o)))return!0}}return!1}run(t,n,i){const{encoding:r,mark:s}=t;return O(vg(!!r.x2,!!r.y2)),i(Object.assign(Object.assign({},t),{mark:H(s)?Object.assign(Object.assign({},s),{type:"rule"}):"rule"}),n)}}var kt=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class vh extends Ks{constructor(){super(...arguments);this.nonFacetUnitNormalizers=[xm,jm,Nm,new mh,new yh]}map(t,n){if(ft(t)){const i=Kt(t.encoding,nt),r=Kt(t.encoding,it),s=Kt(t.encoding,$i);if(i||r||s)return this.mapFacetedUnit(t,n)}return super.map(t,n)}mapUnit(t,n){const{parentEncoding:i,parentProjection:r}=n,s=Zs(t.encoding,n.repeater),o=Object.assign(Object.assign({},t),s?{encoding:s}:{});if(i||r)return this.mapUnitWithParentEncodingOrProjection(o,n);const a=this.mapLayerOrUnit.bind(this);for(const c of this.nonFacetUnitNormalizers)if(c.hasMatchingType(o,n.config))return c.run(o,n,a);return o}mapRepeat(t,n){return oh(t)?this.mapLayerRepeat(t,n):this.mapNonLayerRepeat(t,n)}mapLayerRepeat(t,n){const{repeat:i,spec:r}=t,s=kt(t,["repeat","spec"]),{row:o,column:a,layer:c}=i,{repeater:l={},repeaterPrefix:u=""}=n;return o||a?this.mapRepeat(Object.assign(Object.assign({},t),{repeat:Object.assign(Object.assign({},o?{row:o}:{}),a?{column:a}:{}),spec:{repeat:{layer:c},spec:r}}),n):Object.assign(Object.assign({},s),{layer:c.map(f=>{const d=Object.assign(Object.assign({},l),{layer:f}),g=`${(r.name||"")+u}child__layer_${q(f)}`,p=this.mapLayerOrUnit(r,Object.assign(Object.assign({},n),{repeater:d,repeaterPrefix:g}));return p.name=g,p})})}mapNonLayerRepeat(t,n){var i;const{repeat:r,spec:s,data:o}=t,a=kt(t,["repeat","spec","data"]);!j(r)&&t.columns&&(t=ue(t,["columns"]),O(Ua("repeat")));const c=[],{repeater:l={},repeaterPrefix:u=""}=n,f=!j(r)&&r.row||[l?l.row:null],d=!j(r)&&r.column||[l?l.column:null],g=j(r)&&r||[l?l.repeat:null];for(const m of g)for(const h of f)for(const b of d){const y={repeat:m,row:h,column:b,layer:l.layer},S=(s.name||"")+u+"child__"+(j(r)?`${q(m)}`:(r.row?`row_${q(h)}`:"")+(r.column?`column_${q(b)}`:"")),k=this.map(s,Object.assign(Object.assign({},n),{repeater:y,repeaterPrefix:S}));k.name=S,c.push(ue(k,["data"]))}const p=j(r)?t.columns:r.column?r.column.length:1;return Object.assign(Object.assign({data:(i=s.data)!==null&&i!==void 0?i:o,align:"all"},a),{columns:p,concat:c})}mapFacet(t,n){const{facet:i}=t;return ti(i)&&t.columns&&(t=ue(t,["columns"]),O(Ua("facet"))),super.mapFacet(t,n)}mapUnitWithParentEncodingOrProjection(t,n){const{encoding:i,projection:r}=t,{parentEncoding:s,parentProjection:o,config:a}=n,c=Cl({parentProjection:o,projection:r}),l=kl({parentEncoding:s,encoding:Zs(i,n.repeater)});return this.mapUnit(Object.assign(Object.assign(Object.assign({},t),c?{projection:c}:{}),l?{encoding:l}:{}),{config:a})}mapFacetedUnit(t,n){const i=t.encoding,{row:r,column:s,facet:o}=i,a=kt(i,["row","column","facet"]),{mark:c,width:l,projection:u,height:f,view:d,params:g,encoding:p}=t,m=kt(t,["mark","width","projection","height","view","params","encoding"]),{facetMapping:h,layout:b}=this.getFacetMappingAndLayout({row:r,column:s,facet:o},n),y=Zs(a,n.repeater);return this.mapFacet(Object.assign(Object.assign(Object.assign({},m),b),{facet:h,spec:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},l?{width:l}:{}),f?{height:f}:{}),d?{view:d}:{}),u?{projection:u}:{}),{mark:c,encoding:y}),g?{params:g}:{})}),n)}getFacetMappingAndLayout(t,n){var i;const{row:r,column:s,facet:o}=t;if(r||s){o&&O(bg([...r?[nt]:[],...s?[it]:[]]));const a={},c={};for(const l of[nt,it]){const u=t[l];if(u){const f=kt(u,["align","center","spacing","columns"]);a[l]=f;for(const d of["align","center","spacing"])u[d]!==void 0&&((i=c[d])!==null&&i!==void 0||(c[d]={}),c[d][l]=u[d])}}return{facetMapping:a,layout:c}}else{const{align:a,center:c,spacing:l,columns:u}=o,f=kt(o,["align","center","spacing","columns"]);return{facetMapping:bh(f,n.repeater),layout:Object.assign(Object.assign(Object.assign(Object.assign({},a?{align:a}:{}),c?{center:c}:{}),l?{spacing:l}:{}),u?{columns:u}:{})}}}mapLayer(t,n){var{parentEncoding:i,parentProjection:r}=n,s=kt(n,["parentEncoding","parentProjection"]);const{encoding:o,projection:a}=t,c=kt(t,["encoding","projection"]),l=Object.assign(Object.assign({},s),{parentEncoding:kl({parentEncoding:i,encoding:o,layer:!0}),parentProjection:Cl({parentProjection:r,projection:a})});return super.mapLayer(c,l)}}function kl({parentEncoding:e,encoding:t={},layer:n}){let i={};if(e){const r=new Set([...v(e),...v(t)]);for(const s of r){const o=t[s],a=e[s];if(C(o)){const c=Object.assign(Object.assign({},a),o);i[s]=c}else ni(o)?i[s]=Object.assign(Object.assign({},o),{condition:Object.assign(Object.assign({},a),o.condition)}):o||o===null?i[s]=o:(n||Pe(a)||w(a)||C(a)||j(a))&&(i[s]=a)}}else i=t;return!i||L(i)?void 0:i}function Cl(e){const{parentProjection:t,projection:n}=e;return t&&n&&O(rg({parentProjection:t,projection:n})),n??t}function eo(e){return"filter"in e}function Oh(e){return(e==null?void 0:e.stop)!==void 0}function Fl(e){return"lookup"in e}function xh(e){return"data"in e}function Sh(e){return"param"in e}function _h(e){return"pivot"in e}function jh(e){return"density"in e}function wh(e){return"quantile"in e}function $h(e){return"regression"in e}function Eh(e){return"loess"in e}function kh(e){return"sample"in e}function Ch(e){return"window"in e}function Fh(e){return"joinaggregate"in e}function Nh(e){return"flatten"in e}function Ph(e){return"calculate"in e}function Nl(e){return"bin"in e}function Th(e){return"impute"in e}function Ah(e){return"timeUnit"in e}function zh(e){return"aggregate"in e}function Ih(e){return"stack"in e}function Rh(e){return"fold"in e}function Lh(e){return e.map(t=>eo(t)?{filter:cn(t.filter,fp)}:t)}var Ct=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class Mh extends Ks{map(t,n){var i,r;return(i=n.emptySelections)!==null&&i!==void 0||(n.emptySelections={}),(r=n.selectionPredicates)!==null&&r!==void 0||(n.selectionPredicates={}),t=Pl(t,n),super.map(t,n)}mapLayerOrUnit(t,n){if(t=Pl(t,n),t.encoding){const i={};for(const[r,s]of ht(t.encoding))i[r]=Tl(s,n);t=Object.assign(Object.assign({},t),{encoding:i})}return super.mapLayerOrUnit(t,n)}mapUnit(t,n){const i=t,{selection:r}=i,s=Ct(i,["selection"]);return r?Object.assign(Object.assign({},s),{params:ht(r).map(([o,a])=>{var c;const l=a,{init:u,bind:f,empty:d}=l,g=Ct(l,["init","bind","empty"]);g.type==="single"?(g.type="point",g.toggle=!1):g.type==="multi"&&(g.type="point"),n.emptySelections[o]=d!=="none";for(const p of re((c=n.selectionPredicates[o])!==null&&c!==void 0?c:{}))p.empty=d!=="none";return{name:o,value:u,select:g,bind:f}})}):t}}function Pl(e,t){const{transform:n}=e,i=Ct(e,["transform"]);if(n){const r=n.map(s=>{if(eo(s))return{filter:to(s,t)};if(Nl(s)&&Wt(s.bin))return Object.assign(Object.assign({},s),{bin:Al(s.bin)});if(Fl(s)){const o=s.from,{selection:a}=o,c=Ct(o,["selection"]);return a?Object.assign(Object.assign({},s),{from:Object.assign({param:a},c)}):s}return s});return Object.assign(Object.assign({},i),{transform:r})}return e}function Tl(e,t){var n,i;const r=F(e);if(x(r)&&Wt(r.bin)&&(r.bin=Al(r.bin)),Yt(r)&&((i=(n=r.scale)===null||n===void 0?void 0:n.domain)===null||i===void 0?void 0:i.selection)){const s=r.scale.domain,{selection:o}=s,a=Ct(s,["selection"]);r.scale.domain=Object.assign(Object.assign({},a),o?{param:o}:{})}if(qi(r))if(ia(r.condition))r.condition=r.condition.map(s=>{const{selection:o,param:a,test:c}=s,l=Ct(s,["selection","param","test"]);return a?s:Object.assign(Object.assign({},l),{test:to(s,t)})});else{const s=Tl(r.condition,t),{selection:o,param:a,test:c}=s,l=Ct(s,["selection","param","test"]);r.condition=a?r.condition:Object.assign(Object.assign({},l),{test:to(r.condition,t)})}return r}function Al(e){const t=e.extent;if(t==null?void 0:t.selection){const{selection:n}=t,i=Ct(t,["selection"]);return Object.assign(Object.assign({},e),{extent:Object.assign(Object.assign({},i),{param:n})})}return e}function to(e,t){const n=i=>cn(i,r=>{var s,o,a;const c=(s=t.emptySelections[r])!==null&&s!==void 0?s:!0,l={param:r,empty:c};return(o=(a=t.selectionPredicates)[r])!==null&&o!==void 0||(a[r]=[]),t.selectionPredicates[r].push(l),l});return e.selection?n(e.selection):cn(e.test||e.filter,i=>i.selection?n(i.selection):i)}class no extends Ks{map(t,n){var i;const r=(i=n.selections)!==null&&i!==void 0?i:[];if(t.params&&!ft(t)){const s=[];for(const o of t.params)Gs(o)?r.push(o):s.push(o);t.params=s}return n.selections=r,super.map(t,zl(t,n))}mapUnit(t,n){var i;const r=n.selections;if(!r||!r.length)return t;const s=((i=n.path)!==null&&i!==void 0?i:[]).concat(t.name),o=[];for(const a of r)if(!a.views||!a.views.length)o.push(a);else for(const c of a.views)(Si(c)&&(c===t.name||s.indexOf(c)>=0)||ia(c)&&c.map(l=>s.indexOf(l)).every((l,u,f)=>l!==-1&&(u===0||l>f[u-1])))&&o.push(a);return o.length&&(t.params=o),t}}for(const e of["mapFacet","mapRepeat","mapHConcat","mapVConcat","mapLayer"]){const t=no.prototype[e];no.prototype[e]=function(n,i){return t.call(this,n,zl(n,i))}}function zl(e,t){var n;return e.name?Object.assign(Object.assign({},t),{path:((n=t.path)!==null&&n!==void 0?n:[]).concat(e.name)}):t}function Il(e,t){t===void 0&&(t=vl(e.config));const n=Bh(e,t),{width:i,height:r}=e,s=Hh(n,{width:i,height:r,autosize:e.autosize},t);return Object.assign(Object.assign({},n),s?{autosize:s}:{})}const Dh=new vh,Uh=new Mh,Wh=new no;function Bh(e,t={}){const n={config:t};return Wh.map(Dh.map(Uh.map(e,n),n),n)}function Rl(e){return N(e)?{type:e}:e??{}}function Hh(e,t,n){let{width:i,height:r}=t;const s=ft(e)||or(e),o={};s?i=="container"&&r=="container"?(o.type="fit",o.contains="padding"):i=="container"?(o.type="fit-x",o.contains="padding"):r=="container"&&(o.type="fit-y",o.contains="padding"):(i=="container"&&(O(Ia("width")),i=void 0),r=="container"&&(O(Ia("height")),r=void 0));const a=Object.assign(Object.assign(Object.assign({type:"pad"},o),n?Rl(n.autosize):{}),Rl(e.autosize));return a.type==="fit"&&!s&&(O(Wd),a.type="pad"),i=="container"&&!(a.type=="fit"||a.type=="fit-x")&&O(Ra("width")),r=="container"&&!(a.type=="fit"||a.type=="fit-y")&&O(Ra("height")),Ie(a,{type:"pad"})?void 0:a}function qh(e){return e==="fit"||e==="fit-x"||e==="fit-y"}function Gh(e){return e?`fit-${Ni(e)}`:"fit"}const Vh=["background","padding"];function Ll(e,t){const n={};for(const i of Vh)e&&e[i]!==void 0&&(n[i]=be(e[i]));return t&&(n.params=e.params),n}class gt{constructor(t={},n={}){this.explicit=t,this.implicit=n}clone(){return new gt(F(this.explicit),F(this.implicit))}combine(){return Object.assign(Object.assign({},this.explicit),this.implicit)}get(t){return K(this.explicit[t],this.implicit[t])}getWithExplicit(t){return this.explicit[t]!==void 0?{explicit:!0,value:this.explicit[t]}:this.implicit[t]!==void 0?{explicit:!1,value:this.implicit[t]}:{explicit:!1,value:void 0}}setWithExplicit(t,{value:n,explicit:i}){n!==void 0&&this.set(t,n,i)}set(t,n,i){return delete this[i?"implicit":"explicit"][t],this[i?"explicit":"implicit"][t]=n,this}copyKeyFromSplit(t,{explicit:n,implicit:i}){n[t]!==void 0?this.set(t,n[t],!0):i[t]!==void 0&&this.set(t,i[t],!1)}copyKeyFromObject(t,n){n[t]!==void 0&&this.set(t,n[t],!0)}copyAll(t){for(const n of v(t.combine())){const i=t.getWithExplicit(n);this.setWithExplicit(n,i)}}}function Je(e){return{explicit:!0,value:e}}function ve(e){return{explicit:!1,value:e}}function Ml(e){return(t,n,i,r)=>{const s=e(t.value,n.value);return s>0?t:s<0?n:ar(t,n,i,r)}}function ar(e,t,n,i){return e.explicit&&t.explicit&&O(Cg(n,i,e.value,t.value)),e}function Ft(e,t,n,i,r=ar){return e===void 0||e.value===void 0?t:e.explicit&&!t.explicit?e:t.explicit&&!e.explicit?t:Ie(e.value,t.value)?e:r(e,t,n,i)}class Xh extends gt{constructor(t={},n={},i=!1){super(t,n);this.explicit=t,this.implicit=n,this.parseNothing=i}clone(){const t=super.clone();return t.parseNothing=this.parseNothing,t}}function jn(e){return"url"in e}function si(e){return"values"in e}function Dl(e){return"name"in e&&!jn(e)&&!si(e)&&!Nt(e)}function Nt(e){return e&&(Ul(e)||Wl(e)||io(e))}function Ul(e){return"sequence"in e}function Wl(e){return"sphere"in e}function io(e){return"graticule"in e}var W;(function(e){e[e.Raw=0]="Raw",e[e.Main=1]="Main",e[e.Row=2]="Row",e[e.Column=3]="Column",e[e.Lookup=4]="Lookup"})(W||(W={}));var Yh=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Qt(e,t=!0,n=Nf){if(j(e)){const i=e.map(r=>Qt(r,t,n));return t?`[${i.join(", ")}]`:i}else if(Ht(e))return n(t?Qn(e):ep(e));return t?n(D(e)):e}function Kh(e,t){var n;for(const i of re((n=e.component.selection)!==null&&n!==void 0?n:{})){const r=i.name;let s=`${r}${At}, ${i.resolve==="global"?"true":`{unit: ${En(e)}}`}`;for(const o of dr){if(!o.defined(i))continue;o.signals&&(t=o.signals(e,i,t)),o.modifyExpr&&(s=o.modifyExpr(e,i,s))}t.push({name:r+Cb,on:[{events:{signal:i.name+At},update:`modify(${I(i.name+Zt)}, ${s})`}]})}return ro(t)}function Qh(e,t){if(e.component.selection&&v(e.component.selection).length){const n=I(e.getName("cell"));t.unshift({name:"facet",value:{},on:[{events:an("mousemove","scope"),update:`isTuple(facet) ? facet : group(${n}).datum`}]})}return ro(t)}function Zh(e,t){var n;let i=!1;for(const r of re((n=e.component.selection)!==null&&n!==void 0?n:{})){const s=r.name,o=I(s+Zt),a=t.filter(c=>c.name===s);if(a.length===0){const c=r.resolve==="global"?"union":r.resolve,l=r.type==="point"?", true, true)":")";t.push({name:r.name,update:`${fu}(${o}, ${I(c)}${l}`})}i=!0;for(const c of dr)c.defined(r)&&c.topLevelSignals&&(t=c.topLevelSignals(e,r,t))}if(i){const r=t.filter(s=>s.name==="unit");r.length===0&&t.unshift({name:"unit",value:{},on:[{events:"mousemove",update:"isTuple(group()) ? group() : unit"}]})}return ro(t)}function Jh(e,t){var n;const i=[...t],r=En(e,{escape:!1});for(const s of re((n=e.component.selection)!==null&&n!==void 0?n:{})){const o={name:s.name+Zt};if(s.project.hasSelectionId&&(o.transform=[{type:"collect",sort:{field:Qe}}]),s.init){const c=s.project.items.map(l=>{const u=Yh(l,["signals"]);return u});o.values=s.project.hasSelectionId?s.init.map(l=>({unit:r,[Qe]:Qt(l,!1)[0]})):s.init.map(l=>({unit:r,fields:c,values:Qt(l,!1)}))}const a=i.filter(c=>c.name===s.name+Zt);a.length||i.push(o)}return i}function Bl(e,t){var n;for(const i of re((n=e.component.selection)!==null&&n!==void 0?n:{}))for(const r of dr)r.defined(i)&&r.marks&&(t=r.marks(e,i,t));return t}function eb(e,t){for(const n of e.children)Q(n)&&(t=Bl(n,t));return t}function tb(e,t,n,i){const r=hu(e,t.param,t);return{signal:ye(n.get("type"))&&j(i)&&i[0]>i[1]?`isValid(${r}) && reverse(${r})`:r}}function ro(e){return e.map(t=>(t.on&&!t.on.length&&delete t.on,t))}class M{constructor(t,n){this.debugName=n,this._children=[],this._parent=null,t&&(this.parent=t)}clone(){throw new Error("Cannot clone node")}get parent(){return this._parent}set parent(t){this._parent=t,t&&t.addChild(this)}get children(){return this._children}numChildren(){return this._children.length}addChild(t,n){if(this._children.includes(t)){O(tg);return}n!==void 0?this._children.splice(n,0,t):this._children.push(t)}removeChild(t){const n=this._children.indexOf(t);return this._children.splice(n,1),n}remove(){let t=this._parent.removeChild(this);for(const n of this._children)n._parent=this._parent,this._parent.addChild(n,t++)}insertAsParentOf(t){const n=t.parent;n.removeChild(this),this.parent=n,t.parent=this}swapWithParent(){const t=this._parent,n=t.parent;for(const r of this._children)r.parent=t;this._children=[],t.removeChild(this);const i=t.parent.removeChild(t);this._parent=n,n.addChild(this,i),t.parent=this}}class le extends M{constructor(t,n,i,r){super(t,n);this.type=i,this.refCounts=r,this._source=this._name=n,this.refCounts&&!(this._name in this.refCounts)&&(this.refCounts[this._name]=0)}clone(){const t=new this.constructor;return t.debugName=`clone_${this.debugName}`,t._source=this._source,t._name=`clone_${this._name}`,t.type=this.type,t.refCounts=this.refCounts,t.refCounts[t._name]=0,t}dependentFields(){return new Set}producedFields(){return new Set}hash(){return this._hash===void 0&&(this._hash=`Output ${la()}`),this._hash}getSource(){return this.refCounts[this._name]++,this._source}isRequired(){return!!this.refCounts[this._name]}setSource(t){this._source=t}}var Hl=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class et extends M{constructor(t,n){super(t);this.formula=n}clone(){return new et(null,F(this.formula))}static makeFromEncoding(t,n){const i=n.reduceFieldDef((r,s)=>{const{field:o,timeUnit:a}=s;if(a){const c=_(s,{forAs:!0});r[z({as:c,field:o,timeUnit:a})]={as:c,field:o,timeUnit:a}}return r},{});return L(i)?null:new et(t,i)}static makeFromTransform(t,n){const i=Object.assign({},n),{timeUnit:r}=i,s=Hl(i,["timeUnit"]),o=se(r),a=Object.assign(Object.assign({},s),{timeUnit:o});return new et(t,{[z(a)]:a})}merge(t){this.formula=Object.assign({},this.formula);for(const n in t.formula)this.formula[n]||(this.formula[n]=t.formula[n]);for(const n of t.children)t.removeChild(n),n.parent=this;t.remove()}removeFormulas(t){const n={};for(const[i,r]of ht(this.formula))t.has(r.as)||(n[i]=r);this.formula=n}producedFields(){return new Set(re(this.formula).map(t=>t.as))}dependentFields(){return new Set(re(this.formula).map(t=>t.field))}hash(){return`TimeUnit ${z(this.formula)}`}assemble(){const t=[];for(const n of re(this.formula)){const{field:i,as:r,timeUnit:s}=n,o=se(s),{unit:a,utc:c}=o,l=Hl(o,["unit","utc"]);t.push(Object.assign(Object.assign(Object.assign(Object.assign({field:xe(i),type:"timeunit"},a?{units:as(a)}:{}),c?{timezone:"utc"}:{}),l),{as:[r,`${r}_end`]}))}return t}}var nb=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const oi="_tuple_fields";class ib{constructor(...t){this.items=t,this.hasChannel={},this.hasField={},this.hasSelectionId=!1}}const rb={defined:()=>!0,parse:(e,t,n)=>{var i;const r=t.name,s=(i=t.project)!==null&&i!==void 0?i:t.project=new ib,o={},a={},c=new Set,l=(m,h)=>{const b=h==="visual"?m.channel:m.field;let y=q(`${r}_${b}`);for(let S=1;c.has(y);S++)y=q(`${r}_${b}_${S}`);return c.add(y),{[h]:y}},u=t.type,f=e.config.selection[u],d=n.value!==void 0?V(n.value):null;let{fields:g,encodings:p}=H(n.select)?n.select:{};if(!g&&!p&&d)for(const m of d){if(!H(m))continue;for(const h of v(m))hd(h)?(p||(p=[])).push(h):u==="interval"?(O(Qd),p=f.encodings):(g||(g=[])).push(h)}!g&&!p&&(p=f.encodings,"fields"in f&&(g=f.fields));for(const m of p??[]){const h=e.fieldDef(m);if(h){let b=h.field;if(h.aggregate){O(Bd(m,h.aggregate));continue}else if(!b){O(Ma(m));continue}if(h.timeUnit){b=e.vgField(m);const y={timeUnit:h.timeUnit,as:b,field:h.field};a[z(y)]=y}if(!o[b]){let y="E";if(u==="interval"){const k=e.getScaleComponent(m).get("type");ye(k)&&(y="R")}else h.bin&&(y="R-RE");const S={field:b,channel:m,type:y};S.signals=Object.assign(Object.assign({},l(S,"data")),l(S,"visual")),s.items.push(o[b]=S),s.hasField[b]=s.hasChannel[m]=o[b],s.hasSelectionId=s.hasSelectionId||b===Qe}}else O(Ma(m))}for(const m of g??[]){if(s.hasField[m])continue;const h={type:"E",field:m};h.signals=Object.assign({},l(h,"data")),s.items.push(h),s.hasField[m]=h,s.hasSelectionId=s.hasSelectionId||m===Qe}d&&(t.init=d.map(m=>s.items.map(h=>H(m)?m[h.channel]!==void 0?m[h.channel]:m[h.field]:m))),L(a)||(s.timeUnit=new et(null,a))},signals:(e,t,n)=>{const i=t.name+oi,r=n.filter(s=>s.name===i);return r.length>0||t.project.hasSelectionId?n:n.concat({name:i,value:t.project.items.map(s=>{const o=nb(s,["signals","hasLegend"]);return o.field=xe(o.field),o})})}},Pt={defined:e=>e.type==="interval"&&e.resolve==="global"&&e.bind&&e.bind==="scales",parse:(e,t)=>{const n=t.scales=[];for(const i of t.project.items){const r=i.channel;if(!_t(r))continue;const s=e.getScaleComponent(r),o=s?s.get("type"):void 0;if(!s||!ye(o)){O(Gd);continue}s.set("selectionExtent",{param:t.name,field:i.field},!0),n.push(i)}},topLevelSignals:(e,t,n)=>{const i=t.scales.filter(o=>n.filter(a=>a.name===o.signals.data).length===0);if(!e.parent||oo(e)||i.length===0)return n;const r=n.filter(o=>o.name===t.name)[0];let s=r.update;if(s.indexOf(fu)>=0)r.update=`{${i.map(o=>`${I(xe(o.field))}: ${o.signals.data}`).join(", ")}}`;else{for(const o of i){const a=`${I(xe(o.field))}: ${o.signals.data}`;s.includes(a)||(s=`${s.substring(0,s.length-1)}, ${a}}`)}r.update=s}return n.concat(i.map(o=>({name:o.signals.data})))},signals:(e,t,n)=>{if(e.parent&&!oo(e))for(const i of t.scales){const r=n.filter(s=>s.name===i.signals.data)[0];r.push="outer",delete r.value,delete r.update}return n}};function so(e,t){const n=I(e.scaleName(t));return`domain(${n})`}function oo(e){var t;return e.parent&&An(e.parent)&&((t=!e.parent.parent)!==null&&t!==void 0?t:oo(e.parent.parent))}var sb=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};const wn="_brush",ao="_scale_trigger",ob={defined:e=>e.type==="interval",signals:(e,t,n)=>{const i=t.name,r=i+oi,s=Pt.defined(t),o=t.init?t.init[0]:null,a=[],c=[];if(t.translate&&!s){const u=`!event.item || event.item.mark.name !== ${I(i+wn)}`;ql(t,(f,d)=>{var g,p;const m=V((g=(p=d.between[0]).filter)!==null&&g!==void 0?g:p.filter=[]);return m.includes(u)||m.push(u),f})}t.project.items.forEach((u,f)=>{const d=u.channel;if(d!==G&&d!==J){O("Interval selections only support x and y encoding channels.");return}const g=o?o[f]:null,p=ab(e,t,u,g),m=u.signals.data,h=u.signals.visual,b=I(e.scaleName(d)),y=e.getScaleComponent(d).get("type"),S=ye(y)?"+":"";n.push(...p),a.push(m),c.push({scaleName:e.scaleName(d),expr:`(!isArray(${m}) || (${S}invert(${b}, ${h})[0] === ${S}${m}[0] && ${S}invert(${b}, ${h})[1] === ${S}${m}[1]))`})}),!s&&c.length&&n.push({name:i+ao,value:{},on:[{events:c.map(u=>({scale:u.scaleName})),update:`${c.map(u=>u.expr).join(" && ")} ? ${i+ao} : {}`}]});const l=`unit: ${En(e)}, fields: ${r}, values`;return n.concat(Object.assign(Object.assign({name:i+At},o?{init:`{${l}: ${Qt(o)}}`}:{}),a.length?{on:[{events:[{signal:a.join(" || ")}],update:`${a.join(" && ")} ? {${l}: [${a}]} : null`}]}:{}))},marks:(e,t,n)=>{const i=t.name,{x:r,y:s}=t.project.hasChannel,o=r==null?void 0:r.signals.visual,a=s==null?void 0:s.signals.visual,c=`data(${I(t.name+Zt)})`;if(Pt.defined(t)||!r&&!s)return n;const l={x:r!==void 0?{signal:`${o}[0]`}:{value:0},y:s!==void 0?{signal:`${a}[0]`}:{value:0},x2:r!==void 0?{signal:`${o}[1]`}:{field:{group:"width"}},y2:s!==void 0?{signal:`${a}[1]`}:{field:{group:"height"}}};if(t.resolve==="global")for(const h of v(l))l[h]=[Object.assign({test:`${c}.length && ${c}[0].unit === ${En(e)}`},l[h]),{value:0}];const u=t.mark,{fill:f,fillOpacity:d,cursor:g}=u,p=sb(u,["fill","fillOpacity","cursor"]),m=v(p).reduce((h,b)=>(h[b]=[{test:[r!==void 0&&`${o}[0] !== ${o}[1]`,s!==void 0&&`${a}[0] !== ${a}[1]`].filter(y=>y).join(" && "),value:p[b]},{value:null}],h),{});return[{name:`${i+wn}_bg`,type:"rect",clip:!0,encode:{enter:{fill:{value:f},fillOpacity:{value:d}},update:l}},...n,{name:i+wn,type:"rect",clip:!0,encode:{enter:Object.assign(Object.assign({},g?{cursor:{value:g}}:{}),{fill:{value:"transparent"}}),update:Object.assign(Object.assign({},l),m)}}]}};function ab(e,t,n,i){const r=n.channel,s=n.signals.visual,o=n.signals.data,a=Pt.defined(t),c=I(e.scaleName(r)),l=e.getScaleComponent(r),u=l?l.get("type"):void 0,f=m=>`scale(${c}, ${m})`,d=e.getSizeSignalRef(r===G?"width":"height").signal,g=`${r}(unit)`,p=ql(t,(m,h)=>[...m,{events:h.between[0],update:`[${g}, ${g}]`},{events:h,update:`[${s}[0], clamp(${g}, 0, ${d})]`}]);return p.push({events:{signal:t.name+ao},update:ye(u)?`[${f(`${o}[0]`)}, ${f(`${o}[1]`)}]`:"[0, 0]"}),a?[{name:o,on:[]}]:[Object.assign(Object.assign({name:s},i?{init:Qt(i,!0,f)}:{value:[]}),{on:p}),Object.assign(Object.assign({name:o},i?{init:Qt(i)}:{}),{on:[{events:{signal:s},update:`${s}[0] === ${s}[1] ? null : invert(${c}, ${s})`}]})]}function ql(e,t){return e.events.reduce((n,i)=>i.between?t(n,i):(O(`${i} is not an ordered event stream for interval selections.`),n),[])}const cb={defined:e=>e.type==="point",signals:(e,t,n)=>{var i;const r=t.name,s=r+oi,o=t.project,a="(item().isVoronoi ? datum.datum : datum)",c=re((i=e.component.selection)!==null&&i!==void 0?i:{}).reduce((d,g)=>g.type==="interval"?d.concat(g.name+wn):d,[]).map(d=>`indexof(item().mark.name, '${d}') < 0`).join(" && "),l=`datum && item().mark.marktype !== 'group' && indexof(item().mark.role, 'legend') < 0${c?` && ${c}`:""}`;let u=`unit: ${En(e)}, `;if(t.project.hasSelectionId)u+=`${Qe}: ${a}[${I(Qe)}]`;else{const d=o.items.map(g=>{const p=e.fieldDef(g.channel);return(p==null?void 0:p.bin)?`[${a}[${I(e.vgField(g.channel,{}))}], ${a}[${I(e.vgField(g.channel,{binSuffix:"end"}))}]]`:`${a}[${I(g.field)}]`}).join(", ");u+=`fields: ${s}, values: [${d}]`}const f=t.events;return n.concat([{name:r+At,on:f?[{events:f,update:`${l} ? {${u}} : null`,force:!0}]:[]}])}};function $n(e,t,n,i){const r=qi(t)&&t.condition,s=i(t);if(r){const o=V(r),a=o.map(c=>{const l=i(c);if(Qp(c)){const{param:u,empty:f}=c,d=mu(e,{param:u,empty:f});return Object.assign({test:d},l)}else{const u=gr(e,c.test);return Object.assign({test:u},l)}});return{[n]:[...a,...s!==void 0?[s]:[]]}}else return s!==void 0?{[n]:s}:{}}function co(e,t="text"){const n=e.encoding[t];return $n(e,n,t,i=>cr(i,e.config))}function cr(e,t,n="datum"){if(e){if(Pe(e))return B(e.value);if(C(e)){const{format:i,formatType:r}=Xi(e);return $s({fieldOrDatumDef:e,format:i,formatType:r,expr:n,config:t})}}return}function Gl(e,t={}){const{encoding:n,markDef:i,config:r,stack:s}=e,o=n.tooltip;if(j(o))return{tooltip:Xl({tooltip:o},s,r,t)};{const a=t.reactiveGeom?"datum.datum":"datum";return $n(e,o,"tooltip",c=>{const l=cr(c,r,a);if(l)return l;if(c===null)return;let u=R("tooltip",i,r);return u===!0&&(u={content:"encoding"}),N(u)?{value:u}:H(u)?w(u)?u:u.content==="encoding"?Xl(n,s,r,t):{signal:a}:void 0})}}function Vl(e,t,n,{reactiveGeom:i}={}){const r={},s=i?"datum.datum":"datum",o=[];function a(l,u){const f=Ut(u),d=we(l)?l:Object.assign(Object.assign({},l),{type:e[f].type}),g=d.title||Ts(d,n),p=V(g).join(", ");let m;if(ee(u)){const h=u==="x"?"x2":"y2",b=Ke(e[h]);if(ie(d.bin)&&b){const y=_(d,{expr:s}),S=_(b,{expr:s}),{format:k,formatType:E}=Xi(d);m=ei(y,S,k,E,n),r[h]=!0}}if((ee(u)||u===Se||u===ke)&&t&&t.fieldChannel===u&&t.offset==="normalize"){const{format:h,formatType:b}=Xi(d);m=$s({fieldOrDatumDef:d,format:h,formatType:b,expr:s,config:n,normalizeStack:!0}).signal}m??(m=cr(d,n,s).signal),o.push({channel:u,key:p,value:m})}Rs(e,(l,u)=>{x(l)?a(l,u):Gi(l)&&a(l.condition,u)});const c={};for(const{channel:l,key:u,value:f}of o)!r[l]&&!c[u]&&(c[u]=f);return c}function Xl(e,t,n,{reactiveGeom:i}={}){const r=Vl(e,t,n,{reactiveGeom:i}),s=ht(r).map(([o,a])=>`"${o}": ${a}`);return s.length>0?{signal:`{${s.join(", ")}}`}:void 0}function lb(e){const{markDef:t,config:n}=e,i=R("aria",t,n);return i===!1?{}:Object.assign(Object.assign(Object.assign({},i?{aria:i}:{}),ub(e)),fb(e))}function ub(e){const{mark:t,markDef:n,config:i}=e;if(i.aria===!1)return{};const r=R("ariaRoleDescription",n,i);return r!=null?{ariaRoleDescription:{value:r}}:t in Md?{}:{ariaRoleDescription:{value:t}}}function fb(e){const{encoding:t,markDef:n,config:i,stack:r}=e,s=t.description;if(s)return $n(e,s,"description",c=>cr(c,e.config));const o=R("description",n,i);if(o!=null)return{description:B(o)};if(i.aria===!1)return{};const a=Vl(t,r,i);return L(a)?void 0:{description:{signal:ht(a).map(([c,l],u)=>`"${u>0?"; ":""}${c}: " + (${l})`).join(" + ")}}}function ne(e,t,n={}){const{markDef:i,encoding:r,config:s}=t,{vgChannel:o}=n;let{defaultRef:a,defaultValue:c}=n;a===void 0&&(c??(c=R(e,i,s,{vgChannel:o,ignoreVgConfig:!0})),c!==void 0&&(a=B(c)));const l=r[e];return $n(t,l,o??e,u=>ws({channel:e,channelDef:u,markDef:i,config:s,scaleName:t.scaleName(e),scale:t.getScaleComponent(e),stack:null,defaultRef:a}))}function Yl(e,t={filled:void 0}){var n,i,r,s;const{markDef:o,encoding:a,config:c}=e,{type:l}=o,u=(n=t.filled)!==null&&n!==void 0?n:R("filled",o,c),f=A(["bar","point","circle","square","geoshape"],l)?"transparent":void 0,d=(r=(i=R(u===!0?"color":void 0,o,c,{vgChannel:"fill"}))!==null&&i!==void 0?i:c.mark[u===!0&&"color"])!==null&&r!==void 0?r:f,g=(s=R(u===!1?"color":void 0,o,c,{vgChannel:"stroke"}))!==null&&s!==void 0?s:c.mark[u===!1&&"color"],p=u?"fill":"stroke",m=Object.assign(Object.assign({},d?{fill:B(d)}:{}),g?{stroke:B(g)}:{});return o.color&&(u?o.fill:o.stroke)&&O(qa("property",{fill:"fill"in o,stroke:"stroke"in o})),Object.assign(Object.assign(Object.assign(Object.assign({},m),ne("color",e,{vgChannel:p,defaultValue:u?d:g})),ne("fill",e,{defaultValue:a.fill?d:void 0})),ne("stroke",e,{defaultValue:a.stroke?g:void 0}))}function db(e){const{encoding:t,mark:n}=e,i=t.order;return!Et(n)&&Pe(i)?$n(e,i,"zindex",r=>B(r.value)):{}}function ai({channel:e,markDef:t,encoding:n={},model:i,bandPosition:r}){const s=`${e}Offset`,o=t[s],a=n[s];if((s==="xOffset"||s==="yOffset")&&a){const l=ws({channel:s,channelDef:a,markDef:t,config:i==null?void 0:i.config,scaleName:i.scaleName(s),scale:i.getScaleComponent(s),stack:null,defaultRef:B(o),bandPosition:r});return{offsetType:"encoding",offset:l}}const c=t[s];return c?{offsetType:"visual",offset:c}:{}}function oe(e,t,{defaultPos:n,vgChannel:i}){const{encoding:r,markDef:s,config:o,stack:a}=t,c=r[e],l=r[Be(e)],u=t.scaleName(e),f=t.getScaleComponent(e),{offset:d,offsetType:g}=ai({channel:e,markDef:s,encoding:r,model:t,bandPosition:.5}),p=lo({model:t,defaultPos:n,channel:e,scaleName:u,scale:f}),m=!c&&ee(e)&&(r.latitude||r.longitude)?{field:t.getName(e)}:gb({channel:e,channelDef:c,channel2Def:l,markDef:s,config:o,scaleName:u,scale:f,stack:a,offset:d,defaultRef:p,bandPosition:g==="encoding"?0:void 0});return m?{[i||e]:m}:void 0}function gb(e){const{channel:t,channelDef:n,scaleName:i,stack:r,offset:s,markDef:o}=e;if(C(n)&&r&&t===r.fieldChannel){if(x(n)){let a=n.bandPosition;if(a===void 0&&o.type==="text"&&(t==="radius"||t==="theta")&&(a=.5),a!==void 0)return Wi({scaleName:i,fieldOrDatumDef:n,startSuffix:"start",bandPosition:a,offset:s})}return Vt(n,i,{suffix:"end"},{offset:s})}return _s(e)}function lo({model:e,defaultPos:t,channel:n,scaleName:i,scale:r}){const{markDef:s,config:o}=e;return()=>{const a=Ut(n),c=St(n),l=R(n,s,o,{vgChannel:c});if(l!==void 0)return Jn(n,l);switch(t){case"zeroOrMin":case"zeroOrMax":if(i){const u=r.get("type");if(!A([me.LOG,me.TIME,me.UTC],u)){if(r.domainDefinitelyIncludesZero())return{scale:i,value:0}}}if(t==="zeroOrMin")return a==="y"?{field:{group:"height"}}:{value:0};switch(a){case"radius":return{signal:`min(${e.width.signal},${e.height.signal})/2`};case"theta":return{signal:"2*PI"};case"x":return{field:{group:"width"}};case"y":return{value:0}}break;case"mid":{const u=e[ge(n)];return Object.assign(Object.assign({},u),{mult:.5})}}return}}const pb={left:"x",center:"xc",right:"x2"},mb={top:"y",middle:"yc",bottom:"y2"};function Kl(e,t,n,i="middle"){if(e==="radius"||e==="theta")return St(e);const r=e==="x"?"align":"baseline",s=R(r,t,n);let o;return w(s)?(O(yg(r)),o=void 0):o=s,e==="x"?pb[o||(i==="top"?"left":"center")]:mb[o||i]}function lr(e,t,{defaultPos:n,defaultPos2:i,range:r}){return r?Ql(e,t,{defaultPos:n,defaultPos2:i}):oe(e,t,{defaultPos:n})}function Ql(e,t,{defaultPos:n,defaultPos2:i}){const{markDef:r,config:s}=t,o=Be(e),a=ge(e),c=hb(t,i,o),l=c[a]?Kl(e,r,s):St(e);return Object.assign(Object.assign({},oe(e,t,{defaultPos:n,vgChannel:l})),c)}function hb(e,t,n){const{encoding:i,mark:r,markDef:s,stack:o,config:a}=e,c=Ut(n),l=ge(n),u=St(n),f=i[c],d=e.scaleName(c),g=e.getScaleComponent(c),{offset:p}=n in i||n in s?ai({channel:n,markDef:s,encoding:i,model:e}):ai({channel:c,markDef:s,encoding:i,model:e});if(!f&&(n==="x2"||n==="y2")&&(i.latitude||i.longitude)){const h=ge(n),b=e.markDef[h];return b!=null?{[h]:{value:b}}:{[u]:{field:e.getName(n)}}}const m=bb({channel:n,channelDef:f,channel2Def:i[n],markDef:s,config:a,scaleName:d,scale:g,stack:o,offset:p,defaultRef:void 0});return m!==void 0?{[u]:m}:ur(n,s)||ur(n,{[n]:Ai(n,s,a.style),[l]:Ai(l,s,a.style)})||ur(n,a[r])||ur(n,a.mark)||{[u]:lo({model:e,defaultPos:t,channel:n,scaleName:d,scale:g})()}}function bb({channel:e,channelDef:t,channel2Def:n,markDef:i,config:r,scaleName:s,scale:o,stack:a,offset:c,defaultRef:l}){return C(t)&&a&&e.charAt(0)===a.fieldChannel.charAt(0)?Vt(t,s,{suffix:"start"},{offset:c}):_s({channel:e,channelDef:n,scaleName:s,scale:o,stack:a,markDef:i,config:r,offset:c,defaultRef:l})}function ur(e,t){const n=ge(e),i=St(e);if(t[i]!==void 0)return{[i]:Jn(e,t[i])};if(t[e]!==void 0)return{[i]:Jn(e,t[e])};if(t[n]){const r=t[n];if(Gt(r))O(fg(n));else return{[n]:Jn(e,r)}}return}function Tt(e,t){var n,i;const{config:r,encoding:s,markDef:o}=e,a=o.type,c=Be(t),l=ge(t),u=s[t],f=s[c],d=e.getScaleComponent(t),g=d?d.get("type"):void 0,p=o.orient,m=(i=(n=s[l])!==null&&n!==void 0?n:s.size)!==null&&i!==void 0?i:R("size",o,r,{vgChannel:l}),h=a==="bar"&&(t==="x"?p==="vertical":p==="horizontal");return x(u)&&(U(u.bin)||ie(u.bin)||u.timeUnit&&!f)&&!(m&&!Gt(m))&&!te(g)?Ob({fieldDef:u,fieldDef2:f,channel:t,model:e}):(C(u)&&te(g)||h)&&!f?vb(u,t,e):Ql(t,e,{defaultPos:"zeroOrMax",defaultPos2:"zeroOrMin"})}function yb(e,t,n,i,r){if(Gt(r))if(n){const o=n.get("type");if(o==="band"){let a=`bandwidth('${t}')`;return r.band!==1&&(a=`${r.band} * ${a}`),{signal:`max(0.25, ${a})`}}else r.band!==1&&(O(Sg(o)),r=void 0)}else return{mult:r.band,field:{group:e}};else{if(w(r))return r;if(r)return{value:r}}if(n){const o=n.get("range");if($t(o)&&Y(o.step))return{value:o.step-2}}const s=rr(i.view,e);return{value:s-2}}function vb(e,t,n){const{markDef:i,encoding:r,config:s,stack:o}=n,a=i.orient,c=n.scaleName(t),l=n.getScaleComponent(t),u=ge(t),f=Be(t),d=yd(t),g=n.scaleName(d),p=a==="horizontal"&&t==="y"||a==="vertical"&&t==="x";let m;(r.size||i.size)&&(p?m=ne("size",n,{vgChannel:u,defaultRef:B(i.size)}):O($g(i.type)));const h=!!m,b=Nc({channel:t,fieldDef:e,markDef:i,config:s,scaleType:l==null?void 0:l.get("type"),useVlSizeChannel:p});m=m||{[u]:yb(u,g||c,l,s,b)};const y=(l==null?void 0:l.get("type"))==="band"&&Gt(b)&&!h?"top":"middle",S=Kl(t,i,s,y),k=S==="xc"||S==="yc",{offset:E,offsetType:P}=ai({channel:t,markDef:i,encoding:r,model:n,bandPosition:k?.5:0}),$=_s({channel:t,channelDef:e,markDef:i,config:s,scaleName:c,scale:l,stack:o,offset:E,defaultRef:lo({model:n,defaultPos:"mid",channel:t,scaleName:c,scale:l}),bandPosition:k?P==="encoding"?0:.5:w(b)?{signal:`(1-${b})/2`}:Gt(b)?(1-b.band)/2:0});if(u)return Object.assign({[S]:$},m);{const T=St(f),X=m[u],Oe=E?Object.assign(Object.assign({},X),{offset:E}):X;return{[S]:$,[T]:j($)?[$[0],Object.assign(Object.assign({},$[1]),{offset:Oe})]:Object.assign(Object.assign({},$),{offset:Oe})}}}function ci(e,t,n,i,r){if(ga(e))return 0;const s=e==="x"||e==="y2"?-t/2:t/2;if(w(n)||w(r)||w(i)){const o=ut(n),a=ut(r),c=ut(i),l=c?`${c} + `:"",u=o?`(${o} ? -1 : 1) * `:"",f=a?`(${a} + ${s})`:s;return{signal:l+u+f}}else return r=r||0,i+(n?-r-s:+r+s)}function Ob({fieldDef:e,fieldDef2:t,channel:n,model:i}){var r,s,o;const{config:a,markDef:c,encoding:l}=i,u=i.getScaleComponent(n),f=i.scaleName(n),d=u?u.get("type"):void 0,g=u.get("reverse"),p=Nc({channel:n,fieldDef:e,markDef:c,config:a,scaleType:d}),m=(r=i.component.axes[n])===null||r===void 0?void 0:r[0],h=(s=m==null?void 0:m.get("translate"))!==null&&s!==void 0?s:.5,b=ee(n)&&((o=R("binSpacing",c,a))!==null&&o!==void 0)?o:0,y=Be(n),S=St(n),k=St(y),{offset:E}=ai({channel:n,markDef:c,encoding:l,model:i,bandPosition:0}),P=w(p)?{signal:`(1-${p.signal})/2`}:Gt(p)?(1-p.band)/2:.5;if(U(e.bin)||e.timeUnit)return{[k]:Zl({fieldDef:e,scaleName:f,bandPosition:P,offset:ci(y,b,g,h,E)}),[S]:Zl({fieldDef:e,scaleName:f,bandPosition:w(P)?{signal:`1-${P.signal}`}:1-P,offset:ci(n,b,g,h,E)})};if(ie(e.bin)){const $=Vt(e,f,{},{offset:ci(y,b,g,h,E)});if(x(t))return{[k]:$,[S]:Vt(t,f,{},{offset:ci(n,b,g,h,E)})};if(Wt(e.bin)&&e.bin.step)return{[k]:$,[S]:{signal:`scale("${f}", ${_(e,{expr:"datum"})} + ${e.bin.step})`,offset:ci(n,b,g,h,E)}}}O(Ka(y));return}function Zl({fieldDef:e,scaleName:t,bandPosition:n,offset:i}){return Wi({scaleName:t,fieldOrDatumDef:e,bandPosition:n,offset:i})}const xb=new Set(["aria","width","height"]);function $e(e,t){const{fill:n=void 0,stroke:i=void 0}=t.color==="include"?Yl(e):{};return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},Sb(e.markDef,t)),Jl(e,"fill",n)),Jl(e,"stroke",i)),ne("opacity",e)),ne("fillOpacity",e)),ne("strokeOpacity",e)),ne("strokeWidth",e)),ne("strokeDash",e)),db(e)),Gl(e)),co(e,"href")),lb(e))}function Jl(e,t,n){const{config:i,mark:r,markDef:s}=e,o=R("invalid",s,i);if(o==="hide"&&n&&!Et(r)){const a=_b(e,{invalid:!0,channels:Pi});if(a)return{[t]:[{test:a,value:null},...V(n)]}}return n?{[t]:n}:{}}function Sb(e,t){return Ld.reduce((n,i)=>(!xb.has(i)&&e[i]!==void 0&&t[i]!=="ignore"&&(n[i]=B(e[i])),n),{})}function _b(e,{invalid:t=!1,channels:n}){const i=n.reduce((s,o)=>{const a=e.getScaleComponent(o);if(a){const c=a.get("type"),l=e.vgField(o,{expr:"datum"});l&&ye(c)&&(s[l]=!0)}return s},{}),r=v(i);if(r.length>0){const s=t?"||":"&&";return r.map(o=>js(o,t)).join(` ${s} `)}return}function uo(e){const{config:t,markDef:n}=e,i=R("invalid",n,t);if(i){const r=jb(e,{channels:He});if(r)return{defined:{signal:r}}}return{}}function jb(e,{invalid:t=!1,channels:n}){const i=n.reduce((s,o)=>{var a;const c=e.getScaleComponent(o);if(c){const l=c.get("type"),u=e.vgField(o,{expr:"datum",binSuffix:((a=e.stack)===null||a===void 0?void 0:a.impute)?"mid":void 0});u&&ye(l)&&(s[u]=!0)}return s},{}),r=v(i);if(r.length>0){const s=t?"||":"&&";return r.map(o=>js(o,t)).join(` ${s} `)}return}function eu(e,t){return t!==void 0?{[e]:B(t)}:void 0}const fo="voronoi",tu={defined:e=>e.type==="point"&&e.nearest,parse:(e,t)=>{if(t.events)for(const n of t.events)n.markname=e.getName(fo)},marks:(e,t,n)=>{const{x:i,y:r}=t.project.hasChannel,s=e.mark;if(Et(s))return O(Hd(s)),n;const o={name:e.getName(fo),type:"path",interactive:!0,from:{data:e.getName("marks")},encode:{update:Object.assign({fill:{value:"transparent"},strokeWidth:{value:.35},stroke:{value:"transparent"},isVoronoi:{value:!0}},Gl(e,{reactiveGeom:!0}))},transform:[{type:"voronoi",x:{expr:i||!r?"datum.datum.x || 0":"0"},y:{expr:r||!i?"datum.datum.y || 0":"0"},size:[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]}]};let a=0,c=!1;return n.forEach((l,u)=>{var f;const d=(f=l.name)!==null&&f!==void 0?f:"";d===e.component.mark[0].name?a=u:d.indexOf(fo)>=0&&(c=!0)}),c||n.splice(a+1,0,o),n}},nu={defined:e=>e.type==="point"&&e.resolve==="global"&&e.bind&&e.bind!=="scales"&&!Hs(e.bind),parse:(e,t,n)=>du(t,n),topLevelSignals:(e,t,n)=>{const i=t.name,r=t.project,s=t.bind,o=t.init&&t.init[0],a=tu.defined(t)?"(item().isVoronoi ? datum.datum : datum)":"datum";return r.items.forEach((c,l)=>{var u,f;const d=q(`${i}_${c.field}`),g=n.filter(p=>p.name===d);g.length||n.unshift(Object.assign(Object.assign({name:d},o?{init:Qt(o[l])}:{value:null}),{on:t.events?[{events:t.events,update:`datum && item().mark.marktype !== 'group' ? ${a}[${I(c.field)}] : null`}]:[],bind:(f=(u=s[c.field])!==null&&u!==void 0?u:s[c.channel])!==null&&f!==void 0?f:s}))}),n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.filter(l=>l.name===i+At)[0],o=i+oi,a=r.items.map(l=>q(`${i}_${l.field}`)),c=a.map(l=>`${l} !== null`).join(" && ");return a.length&&(s.update=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`),delete s.value,delete s.on,n}},fr="_toggle",iu={defined:e=>e.type==="point"&&!!e.toggle,signals:(e,t,n)=>n.concat({name:t.name+fr,value:!1,on:[{events:t.events,update:t.toggle}]}),modifyExpr:(e,t)=>{const n=t.name+At,i=t.name+fr;return`${i} ? null : ${n}, `+(t.resolve==="global"?`${i} ? null : true, `:`${i} ? null : {unit: ${En(e)}}, `)+`${i} ? ${n} : null`}},wb={defined:e=>e.clear!==void 0&&e.clear!==!1,parse:(e,t)=>{t.clear&&(t.clear=N(t.clear)?an(t.clear,"view"):t.clear)},topLevelSignals:(e,t,n)=>{if(nu.defined(t))for(const i of t.project.items){const r=n.findIndex(s=>s.name===q(`${t.name}_${i.field}`));r!==-1&&n[r].on.push({events:t.clear,update:"null"})}return n},signals:(e,t,n)=>{function i(r,s){r!==-1&&n[r].on&&n[r].on.push({events:t.clear,update:s})}if(t.type==="interval")for(const r of t.project.items){const s=n.findIndex(o=>o.name===r.signals.visual);if(i(s,"[0, 0]"),s===-1){const o=n.findIndex(a=>a.name===r.signals.data);i(o,"null")}}else{let r=n.findIndex(s=>s.name===t.name+At);i(r,"null"),iu.defined(t)&&(r=n.findIndex(s=>s.name===t.name+fr),i(r,"false"))}return n}},ru={defined:e=>{const t=e.resolve==="global"&&e.bind&&Hs(e.bind),n=e.project.items.length===1&&e.project.items[0].field!==Qe;return t&&!n&&O(Vd),t&&n},parse:(e,t,n)=>{var i;const r=F(n);if(r.select=N(r.select)?{type:r.select,toggle:t.toggle}:Object.assign(Object.assign({},r.select),{toggle:t.toggle}),du(t,r),na(n.select)&&(n.select.on||n.select.clear)){const a='event.item && indexof(event.item.mark.role, "legend") < 0';for(const c of t.events)c.filter=V((i=c.filter)!==null&&i!==void 0?i:[]),c.filter.includes(a)||c.filter.push(a)}const s=qs(t.bind)?t.bind.legend:"click",o=N(s)?an(s,"view"):V(s);t.bind={legend:{merge:o}}},topLevelSignals:(e,t,n)=>{const i=t.name,r=qs(t.bind)&&t.bind.legend,s=o=>a=>{const c=F(a);return c.markname=o,c};for(const o of t.project.items){if(!o.hasLegend)continue;const a=`${q(o.field)}_legend`,c=`${i}_${a}`,l=n.filter(u=>u.name===c);if(l.length===0){const u=r.merge.map(s(`${a}_symbols`)).concat(r.merge.map(s(`${a}_labels`))).concat(r.merge.map(s(`${a}_entries`)));n.unshift(Object.assign(Object.assign({name:c},t.init?{}:{value:null}),{on:[{events:u,update:"datum.value || item().items[0].items[0].datum.value",force:!0},{events:r.merge,update:`!event.item || !datum ? null : ${c}`,force:!0}]}))}}return n},signals:(e,t,n)=>{const i=t.name,r=t.project,s=n.find(d=>d.name===i+At),o=i+oi,a=r.items.filter(d=>d.hasLegend).map(d=>q(`${i}_${q(d.field)}_legend`)),c=a.map(d=>`${d} !== null`).join(" && "),l=`${c} ? {fields: ${o}, values: [${a.join(", ")}]} : null`;t.events&&a.length>0?s.on.push({events:a.map(d=>({signal:d})),update:l}):a.length>0&&(s.update=l,delete s.value,delete s.on);const u=n.find(d=>d.name===i+fr),f=qs(t.bind)&&t.bind.legend;return u&&(t.events?u.on.push(Object.assign(Object.assign({},u.on[0]),{events:f})):u.on[0].events=f),n}};function $b(e,t,n){var i,r,s,o;const a=(i=e.fieldDef(t))===null||i===void 0?void 0:i.field;for(const c of re((r=e.component.selection)!==null&&r!==void 0?r:{})){const l=(s=c.project.hasField[a])!==null&&s!==void 0?s:c.project.hasChannel[t];if(l&&ru.defined(c)){const u=(o=n.get("selections"))!==null&&o!==void 0?o:[];u.push(c.name),n.set("selections",u,!1),l.hasLegend=!0}}}const su="_translate_anchor",ou="_translate_delta",Eb={defined:e=>e.type==="interval"&&e.translate,signals:(e,t,n)=>{const i=t.name,r=Pt.defined(t),s=i+su,{x:o,y:a}=t.project.hasChannel;let c=an(t.translate,"scope");return r||(c=c.map(l=>(l.between[0].markname=i+wn,l))),n.push({name:s,value:{},on:[{events:c.map(l=>l.between[0]),update:"{x: x(unit), y: y(unit)"+(o!==void 0?`, extent_x: ${r?so(e,G):`slice(${o.signals.visual})`}`:"")+(a!==void 0?`, extent_y: ${r?so(e,J):`slice(${a.signals.visual})`}`:"")+"}"}]},{name:i+ou,value:{},on:[{events:c,update:`{x: ${s}.x - x(unit), y: ${s}.y - y(unit)}`}]}),o!==void 0&&au(e,t,o,"width",n),a!==void 0&&au(e,t,a,"height",n),n}};function au(e,t,n,i,r){var s,o;const a=t.name,c=a+su,l=a+ou,u=n.channel,f=Pt.defined(t),d=r.filter($=>$.name===n.signals[f?"data":"visual"])[0],g=e.getSizeSignalRef(i).signal,p=e.getScaleComponent(u),m=p.get("type"),h=p.get("reverse"),b=f?u===G?h?"":"-":h?"-":"":"",y=`${c}.extent_${u}`,S=`${b}${l}.${u} / ${f?`${g}`:`span(${y})`}`,k=f?m==="log"?"panLog":m==="symlog"?"panSymlog":m==="pow"?"panPow":"panLinear":"panLinear",E=f?m==="pow"?`, ${(s=p.get("exponent"))!==null&&s!==void 0?s:1}`:m==="symlog"?`, ${(o=p.get("constant"))!==null&&o!==void 0?o:1}`:"":"",P=`${k}(${y}, ${S}${E})`;d.on.push({events:{signal:l},update:f?P:`clampRange(${P}, 0, ${g})`})}const cu="_zoom_anchor",lu="_zoom_delta",kb={defined:e=>e.type==="interval"&&e.zoom,signals:(e,t,n)=>{const i=t.name,r=Pt.defined(t),s=i+lu,{x:o,y:a}=t.project.hasChannel,c=I(e.scaleName(G)),l=I(e.scaleName(J));let u=an(t.zoom,"scope");return r||(u=u.map(f=>(f.markname=i+wn,f))),n.push({name:i+cu,on:[{events:u,update:r?"{"+[c?`x: invert(${c}, x(unit))`:"",l?`y: invert(${l}, y(unit))`:""].filter(f=>!!f).join(", ")+"}":"{x: x(unit), y: y(unit)}"}]},{name:s,on:[{events:u,force:!0,update:"pow(1.001, event.deltaY * pow(16, event.deltaMode))"}]}),o!==void 0&&uu(e,t,o,"width",n),a!==void 0&&uu(e,t,a,"height",n),n}};function uu(e,t,n,i,r){var s,o;const a=t.name,c=n.channel,l=Pt.defined(t),u=r.filter(k=>k.name===n.signals[l?"data":"visual"])[0],f=e.getSizeSignalRef(i).signal,d=e.getScaleComponent(c),g=d.get("type"),p=l?so(e,c):u.name,m=a+lu,h=`${a}${cu}.${c}`,b=l?g==="log"?"zoomLog":g==="symlog"?"zoomSymlog":g==="pow"?"zoomPow":"zoomLinear":"zoomLinear",y=l?g==="pow"?`, ${(s=d.get("exponent"))!==null&&s!==void 0?s:1}`:g==="symlog"?`, ${(o=d.get("constant"))!==null&&o!==void 0?o:1}`:"":"",S=`${b}(${p}, ${h}, ${m}${y})`;u.on.push({events:{signal:m},update:l?S:`clampRange(${S}, 0, ${f})`})}const Zt="_store",At="_tuple",Cb="_modify",fu="vlSelectionResolve",dr=[cb,ob,rb,iu,nu,Pt,ru,wb,Eb,kb,tu];function Fb(e){let t=e.parent;for(;t&&!ze(t);)t=t.parent;return t}function En(e,{escape:t}={escape:!0}){let n=t?I(e.name):e.name;const i=Fb(e);if(i){const{facet:r}=i;for(const s of je)r[s]&&(n+=` + '__facet_${s}_' + (facet[${I(i.vgField(s))}])`)}return n}function go(e){var t;return re((t=e.component.selection)!==null&&t!==void 0?t:{}).reduce((n,i)=>n||i.project.hasSelectionId,!1)}function du(e,t){(Si(t.select)||!t.select.on)&&delete e.events,(Si(t.select)||!t.select.clear)&&delete e.clear,(Si(t.select)||!t.select.toggle)&&delete e.toggle}function po(e){const t=[];return e.type==="Identifier"?[e.name]:e.type==="Literal"?[e.value]:(e.type==="MemberExpression"&&(t.push(...po(e.object)),t.push(...po(e.property))),t)}function gu(e){return e.object.type==="MemberExpression"?gu(e.object):e.object.name==="datum"}function pu(e){const t=zf(e),n=new Set;return t.visit(i=>{i.type==="MemberExpression"&&gu(i)&&n.add(po(i).slice(1).join("."))}),n}class kn extends M{constructor(t,n,i){super(t);this.model=n,this.filter=i,this.expr=gr(this.model,this.filter,this),this._dependentFields=pu(this.expr)}clone(){return new kn(null,this.model,F(this.filter))}dependentFields(){return this._dependentFields}producedFields(){return new Set}assemble(){return{type:"filter",expr:this.expr}}hash(){return`Filter ${this.expr}`}}function Nb(e,t){var n;const i={},r=e.config.selection;if(!t||!t.length)return i;for(const s of t){const o=q(s.name),a=s.select,c=N(a)?a:a.type,l=H(a)?F(a):{type:c},u=r[c];for(const d in u){if(d==="fields"||d==="encodings")continue;d==="mark"&&(l[d]=Object.assign(Object.assign({},u[d]),l[d])),(l[d]===void 0||l[d]===!0)&&(l[d]=(n=u[d])!==null&&n!==void 0?n:l[d])}const f=i[o]=Object.assign(Object.assign({},l),{name:o,type:c,init:s.value,bind:s.bind,events:N(l.on)?an(l.on,"scope"):V(F(l.on))});for(const d of dr)d.defined(f)&&d.parse&&d.parse(e,f,s)}return i}function mu(e,t,n,i="datum"){const r=N(t)?t:t.param,s=q(r),o=I(s+Zt);let a;try{a=e.getSelectionComponent(s,r)}catch(d){return`!!${s}`}if(a.project.timeUnit){const d=n??e.component.data.raw,g=a.project.timeUnit.clone();d.parent?g.insertAsParentOf(d):d.parent=g}const c=a.project.hasSelectionId?"vlSelectionIdTest(":"vlSelectionTest(",l=a.resolve==="global"?")":`, ${I(a.resolve)})`,u=`${c}${o}, ${i}${l}`,f=`length(data(${o}))`;return t.empty===!1?`${f} && ${u}`:`!${f} || ${u}`}function hu(e,t,n){const i=q(t),r=n.encoding;let s=n.field,o;try{o=e.getSelectionComponent(i,t)}catch(a){return i}if(!r&&!s)s=o.project.items[0].field,o.project.items.length>1&&O(`A "field" or "encoding" must be specified when using a selection as a scale domain. Using "field": ${I(s)}.`);else if(r&&!s){const a=o.project.items.filter(c=>c.channel===r);!a.length||a.length>1?(s=o.project.items[0].field,O((a.length?"Multiple ":"No ")+`matching ${I(r)} encoding found for selection ${I(n.param)}. Using "field": ${I(s)}.`)):s=a[0].field}return`${o.name}[${I(xe(s))}]`}function Pb(e,t){var n;for(const[i,r]of ht((n=e.component.selection)!==null&&n!==void 0?n:{})){const s=e.getName(`lookup_${i}`);e.component.data.outputNodes[s]=r.materialized=new le(new kn(t,e,{param:i}),s,W.Lookup,e.component.data.outputNodeRefCounts)}}function gr(e,t,n){return Bn(t,i=>N(i)?i:cp(i)?mu(e,i,n):rc(i))}var pr=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Tb(e,t){return e?j(e)&&!wt(e)?e.map(n=>Ts(n,t)).join(", "):e:void 0}function mo(e,t,n,i){var r,s,o,a,c;(r=e.encode)!==null&&r!==void 0||(e.encode={}),(s=(a=e.encode)[t])!==null&&s!==void 0||(a[t]={}),(o=(c=e.encode[t]).update)!==null&&o!==void 0||(c.update={}),e.encode[t].update[n]=i}function li(e,t,n,i={header:!1}){var r,s;const o=e.combine(),{disable:a,orient:c,scale:l,labelExpr:u,title:f,zindex:d}=o,g=pr(o,["disable","orient","scale","labelExpr","title","zindex"]);if(a)return;for(const p in g){const m=fm[p],h=g[p];if(m&&m!==t&&m!=="both")delete g[p];else if(ri(h)){const{condition:b}=h,y=pr(h,["condition"]),S=V(b),k=Dc[p];if(k){const{vgProp:E,part:P}=k,$=[...S.map(T=>{const{test:X}=T,Oe=pr(T,["test"]);return Object.assign({test:gr(null,X)},Oe)}),y];mo(g,P,E,$),delete g[p]}else if(k===null){const E={signal:S.map(P=>{const{test:$}=P,T=pr(P,["test"]);return`${gr(null,$)} ? ${Ca(T)} : `}).join("")+Ca(y)};g[p]=E}}else if(w(h)){const b=Dc[p];if(b){const{vgProp:y,part:S}=b;mo(g,S,y,h),delete g[p]}}A(["labelAlign","labelBaseline"],p)&&g[p]===null&&delete g[p]}if(t==="grid"){if(!g.grid)return;if(g.encode){const{grid:p}=g.encode;g.encode=Object.assign({},p?{grid:p}:{}),L(g.encode)&&delete g.encode}return Object.assign(Object.assign({scale:l,orient:c},g),{domain:!1,labels:!1,aria:!1,maxExtent:0,minExtent:0,ticks:!1,zindex:K(d,0)})}else{if(!i.header&&e.mainExtracted)return;if(u!==void 0){let m=u;((s=(r=g.encode)===null||r===void 0?void 0:r.labels)===null||s===void 0?void 0:s.update)&&w(g.encode.labels.update.text)&&(m=Lt(u,"datum.label",g.encode.labels.update.text.signal)),mo(g,"labels","text",{signal:m})}if(g.labelAlign===null&&delete g.labelAlign,g.encode){for(const m of Uc)e.hasAxisPart(m)||delete g.encode[m];L(g.encode)&&delete g.encode}const p=Tb(f,n);return Object.assign(Object.assign(Object.assign(Object.assign({scale:l,orient:c,grid:!1},p?{title:p}:{}),g),n.aria===!1?{aria:!1}:{}),{zindex:K(d,0)})}}function bu(e){const{axes:t}=e.component,n=[];for(const i of He)if(t[i]){for(const r of t[i])if(!r.get("disable")&&!r.get("gridScale")){const s=i==="x"?"height":"width",o=e.getSizeSignalRef(s).signal;s!==o&&n.push({name:s,update:o})}}return n}function Ab(e,t){const{x:n=[],y:i=[]}=e;return[...n.map(r=>li(r,"grid",t)),...i.map(r=>li(r,"grid",t)),...n.map(r=>li(r,"main",t)),...i.map(r=>li(r,"main",t))].filter(r=>r)}function yu(e,t,n,i){return Object.assign.apply(null,[{},...e.map(r=>{if(r==="axisOrient"){const s=n==="x"?"bottom":"left",o=t[n==="x"?"axisBottom":"axisLeft"]||{},a=t[n==="x"?"axisTop":"axisRight"]||{},c=new Set([...v(o),...v(a)]),l={};for(const u of c.values())l[u]={signal:`${i.signal} === "${s}" ? ${ut(o[u])} : ${ut(a[u])}`};return l}return t[r]})])}function zb(e,t,n,i){const r=t==="band"?["axisDiscrete","axisBand"]:t==="point"?["axisDiscrete","axisPoint"]:lc(t)?["axisQuantitative"]:t==="time"||t==="utc"?["axisTemporal"]:[],s=e==="x"?"axisX":"axisY",o=w(n)?"axisOrient":`axis${Hn(n)}`,a=[...r,...r.map(l=>s+l.substr(4))],c=["axis",o,s];return{vlOnlyAxisConfig:yu(a,i,e,n),vgAxisConfig:yu(c,i,e,n),axisConfigStyle:Ib([...c,...a],i)}}function Ib(e,t){var n;const i=[{}];for(const r of e){let s=(n=t[r])===null||n===void 0?void 0:n.style;if(s){s=V(s);for(const o of s)i.push(t.style[o])}}return Object.assign.apply(null,i)}function ho(e,t,n,i={}){var r;const s=Na(e,n,t);if(s!==void 0)return{configFrom:"style",configValue:s};for(const o of["vlOnlyAxisConfig","vgAxisConfig","axisConfigStyle"])if(((r=i[o])===null||r===void 0?void 0:r[e])!==void 0)return{configFrom:o,configValue:i[o][e]};return{}}const vu={scale:({model:e,channel:t})=>e.scaleName(t),format:({fieldOrDatumDef:e,config:t,axis:n})=>{const{format:i,formatType:r}=n;return Sc(e,e.type,i,r,t,!0)},formatType:({axis:e,fieldOrDatumDef:t,scaleType:n})=>{const{formatType:i}=e;return _c(i,t,n)},grid:({fieldOrDatumDef:e,axis:t,scaleType:n})=>{var i;return(i=t.grid)!==null&&i!==void 0?i:Rb(n,e)},gridScale:({model:e,channel:t})=>Lb(e,t),labelAlign:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelAlign||xu(t,n,i),labelAngle:({labelAngle:e})=>e,labelBaseline:({axis:e,labelAngle:t,orient:n,channel:i})=>e.labelBaseline||Ou(t,n,i),labelFlush:({axis:e,fieldOrDatumDef:t,channel:n})=>{var i;return(i=e.labelFlush)!==null&&i!==void 0?i:Db(t.type,n)},labelOverlap:({axis:e,fieldOrDatumDef:t,scaleType:n})=>{var i;return(i=e.labelOverlap)!==null&&i!==void 0?i:Ub(t.type,n,x(t)&&!!t.timeUnit,x(t)?t.sort:void 0)},orient:({orient:e})=>e,tickCount:({channel:e,model:t,axis:n,fieldOrDatumDef:i,scaleType:r})=>{var s;const o=e==="x"?"width":e==="y"?"height":void 0,a=o?t.getSizeSignalRef(o):void 0;return(s=n.tickCount)!==null&&s!==void 0?s:Bb({fieldOrDatumDef:i,scaleType:r,size:a,values:n.values})},title:({axis:e,model:t,channel:n})=>{if(e.title!==void 0)return e.title;const i=Su(t,n);if(i!==void 0)return i;const r=t.typedFieldDef(n),s=n==="x"?"x2":"y2",o=t.fieldDef(s);return Ta(r?[Cc(r)]:[],x(o)?[Cc(o)]:[])},values:({axis:e,fieldOrDatumDef:t})=>Hb(e,t),zindex:({axis:e,fieldOrDatumDef:t,mark:n})=>{var i;return(i=e.zindex)!==null&&i!==void 0?i:qb(n,t)}};function Rb(e,t){return!te(e)&&x(t)&&!U(t==null?void 0:t.bin)&&!ie(t==null?void 0:t.bin)}function Lb(e,t){const n=t==="x"?"y":"x";return e.getScaleComponent(n)?e.scaleName(n):void 0}function Mb(e,t,n,i,r){const s=t==null?void 0:t.labelAngle;if(s!==void 0)return w(s)?s:qn(s);{const{configValue:o}=ho("labelAngle",i,t==null?void 0:t.style,r);return o!==void 0?qn(o):n===G&&A([bs,hs],e.type)&&!(x(e)&&e.timeUnit)?270:void 0}}function bo(e){return`(((${e.signal} % 360) + 360) % 360)`}function Ou(e,t,n,i){if(e!==void 0)if(n==="x"){if(w(e)){const r=bo(e),s=w(t)?`(${t.signal} === "top")`:t==="top";return{signal:`(45 < ${r} && ${r} < 135) || (225 < ${r} && ${r} < 315) ? "middle" :(${r} <= 45 || 315 <= ${r}) === ${s} ? "bottom" : "top"`}}if(45<e&&e<135||225<e&&e<315)return"middle";if(w(t)){const r=e<=45||315<=e?"===":"!==";return{signal:`${t.signal} ${r} "top" ? "bottom" : "top"`}}return(e<=45||315<=e)===(t==="top")?"bottom":"top"}else{if(w(e)){const r=bo(e),s=w(t)?`(${t.signal} === "left")`:t==="left",o=i?'"middle"':"null";return{signal:`${r} <= 45 || 315 <= ${r} || (135 <= ${r} && ${r} <= 225) ? ${o} : (45 <= ${r} && ${r} <= 135) === ${s} ? "top" : "bottom"`}}if(e<=45||315<=e||135<=e&&e<=225)return i?"middle":null;if(w(t)){const r=45<=e&&e<=135?"===":"!==";return{signal:`${t.signal} ${r} "left" ? "top" : "bottom"`}}return(45<=e&&e<=135)===(t==="left")?"top":"bottom"}return}function xu(e,t,n){if(e===void 0)return;const i=n==="x",r=i?0:90,s=i?"bottom":"left";if(w(e)){const o=bo(e),a=w(t)?`(${t.signal} === "${s}")`:t===s;return{signal:`(${r?`(${o} + 90)`:o} % 180 === 0) ? ${i?null:'"center"'} :(${r} < ${o} && ${o} < ${180+r}) === ${a} ? "left" : "right"`}}if((e+r)%180===0)return i?null:"center";if(w(t)){const o=r<e&&e<180+r?"===":"!==",a=`${t.signal} ${o} "${s}"`;return{signal:`${a} ? "left" : "right"`}}return(r<e&&e<180+r)===(t===s)?"left":"right"}function Db(e,t){return t==="x"&&A(["quantitative","temporal"],e)?!0:void 0}function Ub(e,t,n,i){return n&&!H(i)||e!=="nominal"&&e!=="ordinal"?t==="log"||t==="symlog"?"greedy":!0:void 0}function Wb(e){return e==="x"?"bottom":"left"}function Bb({fieldOrDatumDef:e,scaleType:t,size:n,values:i}){var r;if(!i&&!te(t)&&t!=="log"){if(x(e)){if(U(e.bin))return{signal:`ceil(${n.signal}/10)`};if(e.timeUnit&&A(["month","hours","day","quarter"],(r=se(e.timeUnit))===null||r===void 0?void 0:r.unit))return}return{signal:`ceil(${n.signal}/40)`}}return}function Su(e,t){const n=t==="x"?"x2":"y2",i=e.fieldDef(t),r=e.fieldDef(n),s=i?i.title:void 0,o=r?r.title:void 0;return s&&o?Aa(s,o):s||(o||(s!==void 0?s:o!==void 0?o:void 0))}function Hb(e,t){const n=e.values;return j(n)?Mc(t,n):w(n)?n:void 0}function qb(e,t){return e==="rect"&&Vi(t)?1:0}class Cn extends M{constructor(t,n){super(t);this.transform=n,this._dependentFields=pu(this.transform.calculate)}clone(){return new Cn(null,F(this.transform))}static parseAllForSortIndex(t,n){return n.forEachFieldDef((i,r)=>{if(!Yt(i))return;if(kc(i.sort)){const{field:s,timeUnit:o}=i,a=i.sort,c=a.map((l,u)=>`${rc({field:s,timeUnit:o,equal:l})} ? ${u} : `).join("")+a.length;t=new Cn(t,{calculate:c,as:Fn(i,r,{forAs:!0})})}}),t}producedFields(){return new Set([this.transform.as])}dependentFields(){return this._dependentFields}assemble(){return{type:"formula",expr:this.transform.calculate,as:this.transform.as}}hash(){return`Calculate ${z(this.transform)}`}}function Fn(e,t,n){return _(e,Object.assign({prefix:t,suffix:"sort_index"},n??{}))}function mr(e,t){return A(["top","bottom"],t)?"column":A(["left","right"],t)||e==="row"?"row":"column"}function Nn(e,t,n,i){const r=i==="row"?n.headerRow:i==="column"?n.headerColumn:n.headerFacet;return K((t||{})[e],r[e],n.header[e])}function hr(e,t,n,i){const r={};for(const s of e){const o=Nn(s,t||{},n,i);o!==void 0&&(r[s]=o)}return r}const yo=["row","column"],vo=["header","footer"];function Gb(e,t){const n=e.component.layoutHeaders[t].title,i=e.config?e.config:void 0,r=e.component.layoutHeaders[t].facetFieldDef?e.component.layoutHeaders[t].facetFieldDef:void 0,{titleAnchor:s,titleAngle:o,titleOrient:a}=hr(["titleAnchor","titleAngle","titleOrient"],r.header,i,t),c=mr(t,a),l=qn(o);return{name:`${t}-title`,type:"group",role:`${c}-title`,title:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({text:n},t==="row"?{orient:"left"}:{}),{style:"guide-title"}),ju(l,c)),_u(c,l,s)),wu(i,r,t,Am,al))}}function _u(e,t,n="middle"){switch(n){case"start":return{align:"left"};case"end":return{align:"right"}}const i=xu(t,e==="row"?"left":"top",e==="row"?"y":"x");return i?{align:i}:{}}function ju(e,t){const n=Ou(e,t==="row"?"left":"top",t==="row"?"y":"x",!0);return n?{baseline:n}:{}}function Vb(e,t){const n=e.component.layoutHeaders[t],i=[];for(const r of vo)if(n[r])for(const s of n[r]){const o=Yb(e,t,r,n,s);o!=null&&i.push(o)}return i}function Xb(e,t){var n;const{sort:i}=e;return Ve(i)?{field:_(i,{expr:"datum"}),order:(n=i.order)!==null&&n!==void 0?n:"ascending"}:j(i)?{field:Fn(e,t,{expr:"datum"}),order:"ascending"}:{field:_(e,{expr:"datum"}),order:i??"ascending"}}function Oo(e,t,n){const{format:i,formatType:r,labelAngle:s,labelAnchor:o,labelOrient:a,labelExpr:c}=hr(["format","formatType","labelAngle","labelAnchor","labelOrient","labelExpr"],e.header,n,t),l=$s({fieldOrDatumDef:e,format:i,formatType:r,expr:"parent",config:n}).signal,u=mr(t,a);return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({text:{signal:c?Lt(Lt(c,"datum.label",l),"datum.value",_(e,{expr:"parent"})):l}},t==="row"?{orient:"left"}:{}),{style:"guide-label",frame:"group"}),ju(s,u)),_u(u,s,o)),wu(n,e,t,zm,cl))}function Yb(e,t,n,i,r){if(r){let s=null;const{facetFieldDef:o}=i,a=e.config?e.config:void 0;if(o&&r.labels){const{labelOrient:f}=hr(["labelOrient"],o.header,a,t);(t==="row"&&!A(["top","bottom"],f)||t==="column"&&!A(["left","right"],f))&&(s=Oo(o,t,a))}const c=ze(e)&&!ti(e.facet),l=r.axes,u=(l==null?void 0:l.length)>0;if(s||u){const f=t==="row"?"height":"width";return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({name:e.getName(`${t}_${n}`),type:"group",role:`${t}-${n}`},i.facetFieldDef?{from:{data:e.getName(`${t}_domain`)},sort:Xb(o,t)}:{}),u&&c?{from:{data:e.getName(`facet_domain_${t}`)}}:{}),s?{title:s}:{}),r.sizeSignal?{encode:{update:{[f]:r.sizeSignal}}}:{}),u?{axes:l}:{})}}return null}const Kb={column:{start:0,end:1},row:{start:1,end:0}};function Qb(e,t){return Kb[t][e]}function Zb(e,t){const n={};for(const i of je){const r=e[i];if(r==null?void 0:r.facetFieldDef){const{titleAnchor:s,titleOrient:o}=hr(["titleAnchor","titleOrient"],r.facetFieldDef.header,t,i),a=mr(i,o),c=Qb(s,a);c!==void 0&&(n[a]=c)}}return L(n)?void 0:n}function wu(e,t,n,i,r){const s={};for(const o of i){if(!r[o])continue;const a=Nn(o,t==null?void 0:t.header,e,n);a!==void 0&&(s[r[o]]=a)}return s}function xo(e){return[...br(e,"width"),...br(e,"height"),...br(e,"childWidth"),...br(e,"childHeight")]}function br(e,t){const n=t==="width"?"x":"y",i=e.component.layoutSize.get(t);if(!i||i==="merged")return[];const r=e.getSizeSignalRef(t).signal;if(i==="step"){const s=e.getScaleComponent(n);if(s){const o=s.get("type"),a=s.get("range");if(te(o)&&$t(a)){const c=e.scaleName(n);if(ze(e.parent)){const l=e.parent.component.resolve;if(l.scale[n]==="independent")return[$u(c,a)]}return[$u(c,a),{name:r,update:Eu(c,s,`domain('${c}').length`)}]}}throw new Error("layout size is step although width/height is not step.")}else if(i=="container"){const s=r.endsWith("width"),o=s?"containerSize()[0]":"containerSize()[1]",a=Ys(e.config.view,s?"width":"height"),c=`isFinite(${o}) ? ${o} : ${a}`;return[{name:r,init:c,on:[{update:c,events:"window:resize"}]}]}else return[{name:r,value:i}]}function $u(e,t){const n=`${e}_step`;return w(t.step)?{name:n,update:t.step.signal}:{name:n,value:t.step}}function Eu(e,t,n){const i=t.get("type"),r=t.get("padding"),s=K(t.get("paddingOuter"),r);let o=t.get("paddingInner");return o=i==="band"?o!==void 0?o:r:1,`bandspace(${n}, ${ut(o)}, ${ut(s)}) * ${e}_step`}function ku(e){return e==="childWidth"?"width":e==="childHeight"?"height":e}function Cu(e,t){return v(e).reduce((n,i)=>{const r=e[i];return Object.assign(Object.assign({},n),$n(t,r,i,s=>B(s.value)))},{})}function Fu(e,t){if(ze(t))return e==="theta"?"independent":"shared";if(An(t))return"shared";if(Ro(t))return ee(e)||e==="theta"||e==="radius"?"independent":"shared";throw new Error("invalid model type for resolve")}function So(e,t){const n=e.scale[t],i=ee(t)?"axis":"legend";return n==="independent"?(e[i][t]==="shared"&&O(Ng(t)),"independent"):e[i][t]||"shared"}const Jb=Object.assign(Object.assign({},Lm),{disable:1,labelExpr:1,selections:1,opacity:1,shape:1,stroke:1,fill:1,size:1,strokeWidth:1,strokeDash:1,encode:1}),Nu=v(Jb);class ey extends gt{}const Pu={symbols:ty,gradient:ny,labels:iy,entries:ry};function ty(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r,legendType:s}){var o,a,c,l,u,f,d,g;if(s!=="symbol")return;const{markDef:p,encoding:m,config:h,mark:b}=n,y=p.filled&&b!=="trail";let S=Object.assign(Object.assign({},Ud({},n,Ap)),Yl(n,{filled:y}));const k=(o=r.get("symbolOpacity"))!==null&&o!==void 0?o:h.legend.symbolOpacity,E=(a=r.get("symbolFillColor"))!==null&&a!==void 0?a:h.legend.symbolFillColor,P=(c=r.get("symbolStrokeColor"))!==null&&c!==void 0?c:h.legend.symbolStrokeColor,$=k===void 0?(l=Tu(m.opacity))!==null&&l!==void 0?l:p.opacity:void 0;if(S.fill){if(i==="fill"||y&&i===fe)delete S.fill;else if(S.fill.field)E?delete S.fill:(S.fill=B((u=h.legend.symbolBaseFillColor)!==null&&u!==void 0?u:"black"),S.fillOpacity=B($??1));else if(j(S.fill)){const T=(g=(d=_o((f=m.fill)!==null&&f!==void 0?f:m.color))!==null&&d!==void 0?d:p.fill)!==null&&g!==void 0?g:y&&p.color;T&&(S.fill=B(T))}}if(S.stroke){if(i==="stroke"||!y&&i===fe)delete S.stroke;else if(S.stroke.field||P)delete S.stroke;else if(j(S.stroke)){const T=K(_o(m.stroke||m.color),p.stroke,y?p.color:void 0);T&&(S.stroke={value:T})}}if(i!==at){const T=x(t)&&zu(n,r,t);T?S.opacity=[Object.assign({test:T},B($??1)),B(h.legend.unselectedOpacity)]:$&&(S.opacity=B($))}return S=Object.assign(Object.assign({},S),e),L(S)?void 0:S}function ny(e,{model:t,legendType:n,legendCmpt:i}){var r;if(n!=="gradient")return;const{config:s,markDef:o,encoding:a}=t;let c={};const l=(r=i.get("gradientOpacity"))!==null&&r!==void 0?r:s.legend.gradientOpacity,u=l===void 0?Tu(a.opacity)||o.opacity:void 0;return u&&(c.opacity=B(u)),c=Object.assign(Object.assign({},c),e),L(c)?void 0:c}function iy(e,{fieldOrDatumDef:t,model:n,channel:i,legendCmpt:r}){const s=n.legend(i)||{},o=n.config,a=x(t)?zu(n,r,t):void 0,c=a?[{test:a,value:1},{value:o.legend.unselectedOpacity}]:void 0,{format:l,formatType:u}=s;let f;Xt(u)?f=Ne({fieldOrDatumDef:t,field:"datum.value",format:l,formatType:u,config:o}):l===void 0&&u===void 0&&o.customFormatTypes&&(t.type==="quantitative"&&o.numberFormatType?f=Ne({fieldOrDatumDef:t,field:"datum.value",format:o.numberFormat,formatType:o.numberFormatType,config:o}):t.type==="temporal"&&o.timeFormatType&&x(t)&&t.timeUnit===void 0&&(f=Ne({fieldOrDatumDef:t,field:"datum.value",format:o.timeFormat,formatType:o.timeFormatType,config:o})));const d=Object.assign(Object.assign(Object.assign({},c?{opacity:c}:{}),f?{text:f}:{}),e);return L(d)?void 0:d}function ry(e,{legendCmpt:t}){const n=t.get("selections");return(n==null?void 0:n.length)?Object.assign(Object.assign({},e),{fill:{value:"transparent"}}):e}function Tu(e){return Au(e,(t,n)=>Math.max(t,n.value))}function _o(e){return Au(e,(t,n)=>K(t,n.value))}function Au(e,t){return Jp(e)?V(e.condition).reduce(t,e.value):Pe(e)?e.value:void 0}function zu(e,t,n){const i=t.get("selections");if(!(i==null?void 0:i.length))return;const r=I(n.field);return i.map(s=>{const o=I(q(s)+Zt);return`(!length(data(${o})) || (${s}[${r}] && indexof(${s}[${r}], datum.value) >= 0))`}).join(" || ")}const Iu={direction:({direction:e})=>e,format:({fieldOrDatumDef:e,legend:t,config:n})=>{const{format:i,formatType:r}=t;return Sc(e,e.type,i,r,n,!1)},formatType:({legend:e,fieldOrDatumDef:t,scaleType:n})=>{const{formatType:i}=e;return _c(i,t,n)},gradientLength:e=>{var t,n;const{legend:i,legendConfig:r}=e;return(n=(t=i.gradientLength)!==null&&t!==void 0?t:r.gradientLength)!==null&&n!==void 0?n:fy(e)},labelOverlap:({legend:e,legendConfig:t,scaleType:n})=>{var i,r;return(r=(i=e.labelOverlap)!==null&&i!==void 0?i:t.labelOverlap)!==null&&r!==void 0?r:dy(n)},symbolType:({legend:e,markDef:t,channel:n,encoding:i})=>{var r;return(r=e.symbolType)!==null&&r!==void 0?r:oy(t.type,n,i.shape,t.shape)},title:({fieldOrDatumDef:e,config:t})=>On(e,t,{allowDisabling:!0}),type:({legendType:e,scaleType:t,channel:n})=>{if(dn(n)&&Fe(t)){if(e==="gradient")return}else if(e==="symbol")return;return e},values:({fieldOrDatumDef:e,legend:t})=>sy(t,e)};function sy(e,t){const n=e.values;return j(n)?Mc(t,n):w(n)?n:void 0}function oy(e,t,n,i){var r;if(t!=="shape"){const s=(r=_o(n))!==null&&r!==void 0?r:i;if(s)return s}switch(e){case"bar":case"rect":case"image":case"square":return"square";case"line":case"trail":case"rule":return"stroke";case"arc":case"point":case"circle":case"tick":case"geoshape":case"area":case"text":return"circle"}}function ay(e){const{legend:t}=e;return K(t.type,cy(e))}function cy({channel:e,timeUnit:t,scaleType:n}){if(dn(e)){if(A(["quarter","month","day"],t))return"symbol";if(Fe(n))return"gradient"}return"symbol"}function ly({legendConfig:e,legendType:t,orient:n,legend:i}){var r,s;return(s=(r=i.direction)!==null&&r!==void 0?r:e[t?"gradientDirection":"symbolDirection"])!==null&&s!==void 0?s:uy(n,t)}function uy(e,t){switch(e){case"top":case"bottom":return"horizontal";case"left":case"right":case"none":case void 0:return;default:return t==="gradient"?"horizontal":void 0}}function fy({legendConfig:e,model:t,direction:n,orient:i,scaleType:r}){const{gradientHorizontalMaxLength:s,gradientHorizontalMinLength:o,gradientVerticalMaxLength:a,gradientVerticalMinLength:c}=e;return Fe(r)?n==="horizontal"?i==="top"||i==="bottom"?Ru(t,"width",o,s):o:Ru(t,"height",c,a):void 0}function Ru(e,t,n,i){const r=e.getSizeSignalRef(t).signal;return{signal:`clamp(${r}, ${n}, ${i})`}}function dy(e){return A(["quantile","threshold","log","symlog"],e)?"greedy":void 0}function Lu(e){const t=Q(e)?gy(e):by(e);return e.component.legends=t,t}function gy(e){const{encoding:t}=e,n={};for(const i of[fe,...ul]){const r=Z(t[i]);if(!r||!e.getScaleComponent(i))continue;if(i===de&&x(r)&&r.type===hn)continue;n[i]=hy(e,i)}return n}function py(e,t){const n=e.scaleName(t);if(e.mark==="trail"){if(t==="color")return{stroke:n};if(t==="size")return{strokeWidth:n}}return t==="color"?e.markDef.filled?{fill:n}:{stroke:n}:{[t]:n}}function my(e,t,n,i){switch(t){case"disable":return n!==void 0;case"values":return!!(n==null?void 0:n.values);case"title":if(t==="title"&&e===(i==null?void 0:i.title))return!0}return e===(n||{})[t]}function hy(e,t){var n,i,r;let s=e.legend(t);const{markDef:o,encoding:a,config:c}=e,l=c.legend,u=new ey({},py(e,t));$b(e,t,u);const f=s!==void 0?!s:l.disable;if(u.set("disable",f,s!==void 0),f)return u;s=s||{};const d=e.getScaleComponent(t).get("type"),g=Z(a[t]),p=x(g)?(n=se(g.timeUnit))===null||n===void 0?void 0:n.unit:void 0,m=s.orient||c.legend.orient||"right",h=ay({legend:s,channel:t,timeUnit:p,scaleType:d}),b=ly({legend:s,legendType:h,orient:m,legendConfig:l}),y={legend:s,channel:t,model:e,markDef:o,encoding:a,fieldOrDatumDef:g,legendConfig:l,config:c,scaleType:d,orient:m,legendType:h,direction:b};for(const $ of Nu){if(h==="gradient"&&$.startsWith("symbol")||h==="symbol"&&$.startsWith("gradient"))continue;const T=$ in Iu?Iu[$](y):s[$];if(T!==void 0){const X=my(T,$,s,e.fieldDef(t));(X||c.legend[$]===void 0)&&u.set($,T,X)}}const S=(i=s==null?void 0:s.encoding)!==null&&i!==void 0?i:{},k=u.get("selections"),E={},P={fieldOrDatumDef:g,model:e,channel:t,legendCmpt:u,legendType:h};for(const $ of["labels","legend","title","symbols","gradient","entries"]){const T=Cu((r=S[$])!==null&&r!==void 0?r:{},e),X=$ in Pu?Pu[$](T,P):T;X!==void 0&&!L(X)&&(E[$]=Object.assign(Object.assign(Object.assign({},(k==null?void 0:k.length)&&x(g)?{name:`${q(g.field)}_legend_${$}`}:{}),(k==null?void 0:k.length)?{interactive:!!k}:{}),{update:X}))}return L(E)||u.set("encode",E,!!(s==null?void 0:s.encoding)),u}function by(e){const{legends:t,resolve:n}=e.component;for(const i of e.children){Lu(i);for(const r of v(i.component.legends))n.legend[r]=So(e.component.resolve,r),n.legend[r]==="shared"&&(t[r]=Mu(t[r],i.component.legends[r]),t[r]||(n.legend[r]="independent",delete t[r]))}for(const i of v(t))for(const r of e.children){if(!r.component.legends[i])continue;n.legend[i]==="shared"&&delete r.component.legends[i]}return t}function Mu(e,t){var n,i,r,s;if(!e)return t.clone();const o=e.getWithExplicit("orient"),a=t.getWithExplicit("orient");if(o.explicit&&a.explicit&&o.value!==a.value)return;let c=!1;for(const l of Nu){const u=Ft(e.getWithExplicit(l),t.getWithExplicit(l),l,"legend",(f,d)=>{switch(l){case"symbolType":return yy(f,d);case"title":return za(f,d);case"type":return c=!0,ve("symbol")}return ar(f,d,l,"legend")});e.setWithExplicit(l,u)}return c&&(((i=(n=e.implicit)===null||n===void 0?void 0:n.encode)===null||i===void 0?void 0:i.gradient)&&ji(e.implicit,["encode","gradient"]),((s=(r=e.explicit)===null||r===void 0?void 0:r.encode)===null||s===void 0?void 0:s.gradient)&&ji(e.explicit,["encode","gradient"])),e}function yy(e,t){return t.value==="circle"?t:e}var vy=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Oy(e,t,n,i){var r,s,o,a,c;(r=e.encode)!==null&&r!==void 0||(e.encode={}),(s=(a=e.encode)[t])!==null&&s!==void 0||(a[t]={}),(o=(c=e.encode[t]).update)!==null&&o!==void 0||(c.update={}),e.encode[t].update[n]=i}function Du(e){const t=e.component.legends,n={};for(const r of v(t)){const s=e.getScaleComponent(r),o=D(s.get("domains"));if(n[o])for(const a of n[o]){const c=Mu(a,t[r]);c||n[o].push(t[r])}else n[o]=[t[r].clone()]}const i=re(n).flat().map(r=>xy(r,e.config)).filter(r=>r!==void 0);return i}function xy(e,t){var n,i,r;const s=e.combine(),{disable:o,labelExpr:a,selections:c}=s,l=vy(s,["disable","labelExpr","selections"]);if(o)return;if(t.aria===!1&&l.aria==null&&(l.aria=!1),(n=l.encode)===null||n===void 0?void 0:n.symbols){const u=l.encode.symbols.update;u.fill&&u.fill.value!=="transparent"&&!u.stroke&&!l.stroke&&(u.stroke={value:"transparent"});for(const f of ul)l[f]&&delete u[f]}if(l.title||delete l.title,a!==void 0){let u=a;((r=(i=l.encode)===null||i===void 0?void 0:i.labels)===null||r===void 0?void 0:r.update)&&w(l.encode.labels.update.text)&&(u=Lt(a,"datum.label",l.encode.labels.update.text.signal)),Oy(l,"labels","text",{signal:u})}return l}function Sy(e){return An(e)||Ro(e)?_y(e):Uu(e)}function _y(e){return e.children.reduce((t,n)=>t.concat(n.assembleProjections()),Uu(e))}function Uu(e){const t=e.component.projection;if(!t||t.merged)return[];const n=t.combine(),{name:i}=n;if(t.data){const r={signal:`[${t.size.map(o=>o.signal).join(", ")}]`},s=t.data.reduce((o,a)=>{const c=w(a)?a.signal:`data('${e.lookupDataSource(a)}')`;return A(o,c)||o.push(c),o},[]);if(s.length<=0)throw new Error("Projection's fit didn't find any data sources");return[Object.assign({name:i,size:r,fit:{signal:s.length>1?`[${s.join(", ")}]`:s[0]}},n)]}else return[Object.assign(Object.assign({name:i},{translate:{signal:"[width / 2, height / 2]"}}),n)]}const jy=["type","clipAngle","clipExtent","center","rotate","precision","reflectX","reflectY","coefficient","distance","fraction","lobes","parallel","radius","ratio","spacing","tilt"];class Wu extends gt{constructor(t,n,i,r){super(Object.assign({},n),{name:t});this.specifiedProjection=n,this.size=i,this.data=r,this.merged=!1}get isFit(){return!!this.data}}function Bu(e){e.component.projection=Q(e)?wy(e):ky(e)}function wy(e){var t;if(e.hasProjection){const n=pe(e.specifiedProjection),i=!(n&&(n.scale!=null||n.translate!=null)),r=i?[e.getSizeSignalRef("width"),e.getSizeSignalRef("height")]:void 0,s=i?$y(e):void 0,o=new Wu(e.projectionName(!0),Object.assign(Object.assign({},(t=pe(e.config.projection))!==null&&t!==void 0?t:{}),n??{}),r,s);return o.get("type")||o.set("type","equalEarth",!1),o}return}function $y(e){const t=[],{encoding:n}=e;for(const i of[[De,Me],[_e,Ce]])(Z(n[i[0]])||Z(n[i[1]]))&&t.push({signal:e.getName(`geojson_${t.length}`)});return e.channelHasField(de)&&e.typedFieldDef(de).type===hn&&t.push({signal:e.getName(`geojson_${t.length}`)}),t.length===0&&t.push(e.requestDataName(W.Main)),t}function Ey(e,t){const n=Lr(jy,r=>!sn(e.explicit,r)&&!sn(t.explicit,r)?!0:!!(sn(e.explicit,r)&&sn(t.explicit,r)&&Ie(e.get(r),t.get(r)))),i=Ie(e.size,t.size);if(i){if(n)return e;if(Ie(e.explicit,{}))return t;if(Ie(t.explicit,{}))return e}return null}function ky(e){if(e.children.length===0)return;let t;for(const i of e.children)Bu(i);const n=Lr(e.children,i=>{const r=i.component.projection;if(r)if(t){const s=Ey(t,r);return s&&(t=s),!!s}else return t=r,!0;else return!0});if(t&&n){const i=e.projectionName(!0),r=new Wu(i,t.specifiedProjection,t.size,F(t.data));for(const s of e.children){const o=s.component.projection;o&&(o.isFit&&r.data.push(...s.component.projection.data),s.renameProjection(o.get("name"),i),o.merged=!0)}return r}return}var Cy=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Fy(e,t,n,i){var r,s;if(ii(t,n)){const o=Q(e)?(s=(r=e.axis(n))!==null&&r!==void 0?r:e.legend(n))!==null&&s!==void 0?s:{}:{},a=_(t,{expr:"datum"}),c=_(t,{expr:"datum",binSuffix:"end"});return{formulaAs:_(t,{binSuffix:"range",forAs:!0}),formula:ei(a,c,o.format,o.formatType,i)}}return{}}function Hu(e,t){return`${ja(e)}_${t}`}function Ny(e,t){return{signal:e.getName(`${t}_bins`),extentSignal:e.getName(`${t}_extent`)}}function jo(e,t,n){var i;const r=(i=Ki(n,void 0))!==null&&i!==void 0?i:{},s=Hu(r,t);return e.getName(`${s}_bins`)}function Py(e){return"as"in e}function qu(e,t,n){let i,r;Py(e)?i=N(e.as)?[e.as,`${e.as}_end`]:[e.as[0],e.as[1]]:i=[_(e,{forAs:!0}),_(e,{binSuffix:"end",forAs:!0})];const s=Object.assign({},Ki(t,void 0)),o=Hu(s,e.field),{signal:a,extentSignal:c}=Ny(n,o);if(Ti(s.extent)){const u=s.extent;r=hu(n,u.param,u),delete s.extent}const l=Object.assign(Object.assign(Object.assign({bin:s,field:e.field,as:[i]},a?{signal:a}:{}),c?{extentSignal:c}:{}),r?{span:r}:{});return{key:o,binComponent:l}}class tt extends M{constructor(t,n){super(t);this.bins=n}clone(){return new tt(null,F(this.bins))}static makeFromEncoding(t,n){const i=n.reduceFieldDef((r,s,o)=>{if(we(s)&&U(s.bin)){const{key:a,binComponent:c}=qu(s,s.bin,n);r[a]=Object.assign(Object.assign(Object.assign({},c),r[a]),Fy(n,s,o,n.config))}return r},{});return L(i)?null:new tt(t,i)}static makeFromTransform(t,n,i){const{key:r,binComponent:s}=qu(n,n.bin,i);return new tt(t,{[r]:s})}merge(t,n){for(const i of v(t.bins))i in this.bins?(n(t.bins[i].signal,this.bins[i].signal),this.bins[i].as=Re([...this.bins[i].as,...t.bins[i].as],z)):this.bins[i]=t.bins[i];for(const i of t.children)t.removeChild(i),i.parent=this;t.remove()}producedFields(){return new Set(re(this.bins).map(t=>t.as).flat(2))}dependentFields(){return new Set(re(this.bins).map(t=>t.field))}hash(){return`Bin ${z(this.bins)}`}assemble(){return re(this.bins).flatMap(t=>{const n=[],[i,...r]=t.as,s=t.bin,{extent:o}=s,a=Cy(s,["extent"]),c=Object.assign(Object.assign(Object.assign({type:"bin",field:xe(t.field),as:i,signal:t.signal},Ti(o)?{extent:null}:{extent:o}),t.span?{span:{signal:`span(${t.span})`}}:{}),a);!o&&t.extentSignal&&(n.push({type:"extent",field:xe(t.field),signal:t.extentSignal}),c.extent={signal:t.extentSignal}),n.push(c);for(const l of r)for(let u=0;u<2;u++)n.push({type:"formula",expr:_({field:i[u]},{expr:"datum"}),as:l[u]});return t.formula&&n.push({type:"formula",expr:t.formula,as:t.formulaAs}),n})}}function Ty(e,t,n,i){var r;const s=Q(i)?i.encoding[Be(t)]:void 0;if(we(n)&&Q(i)&&Pc(n,s,i.markDef,i.config))e.add(_(n,{})),e.add(_(n,{suffix:"end"})),n.bin&&ii(n,t)&&e.add(_(n,{binSuffix:"range"}));else if(fd(t)){const o=ud(t);e.add(i.getName(o))}else e.add(_(n));return Yt(n)&&Sp((r=n.scale)===null||r===void 0?void 0:r.range)&&e.add(n.scale.range.field),e}function Ay(e,t){var n;for(const i of v(t)){const r=t[i];for(const s of v(r))i in e?e[i][s]=new Set([...(n=e[i][s])!==null&&n!==void 0?n:[],...r[s]]):e[i]={[s]:r[s]}}}class Te extends M{constructor(t,n,i){super(t);this.dimensions=n,this.measures=i}clone(){return new Te(null,new Set(this.dimensions),F(this.measures))}get groupBy(){return this.dimensions}static makeFromEncoding(t,n){let i=!1;n.forEachFieldDef(o=>{o.aggregate&&(i=!0)});const r={},s=new Set;return i?(n.forEachFieldDef((o,a)=>{var c,l,u,f;const{aggregate:d,field:g}=o;if(d)if(d==="count")(c=r["*"])!==null&&c!==void 0||(r["*"]={}),r["*"].count=new Set([_(o,{forAs:!0})]);else{if(ct(d)||jt(d)){const p=ct(d)?"argmin":"argmax",m=d[p];(l=r[m])!==null&&l!==void 0||(r[m]={}),r[m][p]=new Set([_({op:p,field:m},{forAs:!0})])}else(u=r[g])!==null&&u!==void 0||(r[g]={}),r[g][d]=new Set([_(o,{forAs:!0})]);_t(a)&&n.scaleDomain(a)==="unaggregated"&&((f=r[g])!==null&&f!==void 0||(r[g]={}),r[g].min=new Set([_({field:g,aggregate:"min"},{forAs:!0})]),r[g].max=new Set([_({field:g,aggregate:"max"},{forAs:!0})]))}else Ty(s,a,o,n)}),s.size+v(r).length===0?null:new Te(t,s,r)):null}static makeFromTransform(t,n){var i,r,s;const o=new Set,a={};for(const c of n.aggregate){const{op:l,field:u,as:f}=c;l&&(l==="count"?((i=a["*"])!==null&&i!==void 0||(a["*"]={}),a["*"].count=new Set([f||_(c,{forAs:!0})])):((r=a[u])!==null&&r!==void 0||(a[u]={}),a[u][l]=new Set([f||_(c,{forAs:!0})])))}for(const c of(s=n.groupby)!==null&&s!==void 0?s:[])o.add(c);return o.size+v(a).length===0?null:new Te(t,o,a)}merge(t){return oa(this.dimensions,t.dimensions)?(Ay(this.measures,t.measures),!0):(Vg("different dimensions, cannot merge"),!1)}addDimensions(t){t.forEach(this.dimensions.add,this.dimensions)}dependentFields(){return new Set([...this.dimensions,...v(this.measures)])}producedFields(){const t=new Set;for(const n of v(this.measures))for(const i of v(this.measures[n])){const r=this.measures[n][i];r.size===0?t.add(`${i}_${n}`):r.forEach(t.add,t)}return t}hash(){return`Aggregate ${z({dimensions:this.dimensions,measures:this.measures})}`}assemble(){const t=[],n=[],i=[];for(const s of v(this.measures))for(const o of v(this.measures[s]))for(const a of this.measures[s][o])i.push(a),t.push(o),n.push(s==="*"?null:xe(s));const r={type:"aggregate",groupby:[...this.dimensions].map(xe),ops:t,fields:n,as:i};return r}}class Pn extends M{constructor(t,n,i,r){super(t);this.model=n,this.name=i,this.data=r;for(const s of je){const o=n.facet[s];if(o){const{bin:a,sort:c}=o;this[s]=Object.assign({name:n.getName(`${s}_domain`),fields:[_(o),...U(a)?[_(o,{binSuffix:"end"})]:[]]},Ve(c)?{sortField:c}:j(c)?{sortIndexField:Fn(o,s)}:{})}}this.childModel=n.child}hash(){let t="Facet";for(const n of je)this[n]&&(t+=` ${n.charAt(0)}:${z(this[n])}`);return t}get fields(){var t;const n=[];for(const i of je)((t=this[i])===null||t===void 0?void 0:t.fields)&&n.push(...this[i].fields);return n}dependentFields(){const t=new Set(this.fields);for(const n of je)this[n]&&(this[n].sortField&&t.add(this[n].sortField.field),this[n].sortIndexField&&t.add(this[n].sortIndexField));return t}producedFields(){return new Set}getSource(){return this.name}getChildIndependentFieldsWithStep(){const t={};for(const n of He){const i=this.childModel.component.scales[n];if(i&&!i.merged){const r=i.get("type"),s=i.get("range");if(te(r)&&$t(s)){const o=vr(this.childModel,n),a=Ao(o);a?t[n]=a:O(ts(n))}}}return t}assembleRowColumnHeaderData(t,n,i){const r={row:"y",column:"x",facet:void 0}[t],s=[],o=[],a=[];r&&i&&i[r]&&(n?(s.push(`distinct_${i[r]}`),o.push("max")):(s.push(i[r]),o.push("distinct")),a.push(`distinct_${i[r]}`));const{sortField:c,sortIndexField:l}=this[t];if(c){const{op:u=Bi,field:f}=c;s.push(f),o.push(u),a.push(_(c,{forAs:!0}))}else l&&(s.push(l),o.push("max"),a.push(l));return{name:this[t].name,source:n??this.data,transform:[Object.assign({type:"aggregate",groupby:this[t].fields},s.length?{fields:s,ops:o,as:a}:{})]}}assembleFacetHeaderData(t){var n,i;const{columns:r}=this.model.layout,{layoutHeaders:s}=this.model.component,o=[],a={};for(const u of yo){for(const f of vo){const d=(n=s[u]&&s[u][f])!==null&&n!==void 0?n:[];for(const g of d)if(((i=g.axes)===null||i===void 0?void 0:i.length)>0){a[u]=!0;break}}if(a[u]){const f=`length(data("${this.facet.name}"))`,d=u==="row"?r?{signal:`ceil(${f} / ${r})`}:1:r?{signal:`min(${f}, ${r})`}:{signal:f};o.push({name:`${this.facet.name}_${u}`,transform:[{type:"sequence",start:0,stop:d}]})}}const{row:c,column:l}=a;return(c||l)&&o.unshift(this.assembleRowColumnHeaderData("facet",null,t)),o}assemble(){var t,n;const i=[];let r=null;const s=this.getChildIndependentFieldsWithStep(),{column:o,row:a,facet:c}=this;if(o&&a&&(s.x||s.y)){r=`cross_${this.column.name}_${this.row.name}`;const l=[].concat((t=s.x)!==null&&t!==void 0?t:[],(n=s.y)!==null&&n!==void 0?n:[]),u=l.map(()=>"distinct");i.push({name:r,source:this.data,transform:[{type:"aggregate",groupby:this.fields,fields:l,ops:u}]})}for(const l of[it,nt])this[l]&&i.push(this.assembleRowColumnHeaderData(l,r,s));if(c){const l=this.assembleFacetHeaderData(s);l&&i.push(...l)}return i}}function Gu(e){return e.startsWith("'")&&e.endsWith("'")||e.startsWith('"')&&e.endsWith('"')?e.slice(1,-1):e}function zy(e,t){const n=Wr(e);if(t==="number")return`toNumber(${n})`;if(t==="boolean")return`toBoolean(${n})`;if(t==="string")return`toString(${n})`;if(t==="date")return`toDate(${n})`;if(t==="flatten")return n;if(t.startsWith("date:")){const i=Gu(t.slice(5,t.length));return`timeParse(${n},'${i}')`}else if(t.startsWith("utc:")){const i=Gu(t.slice(4,t.length));return`utcParse(${n},'${i}')`}else return O(eg(t)),null}function Iy(e){const t={};return _i(e.filter,n=>{var i;if(ic(n)){let r=null;cs(n)?r=be(n.equal):us(n)?r=be(n.lte):ls(n)?r=be(n.lt):fs(n)?r=be(n.gt):ds(n)?r=be(n.gte):gs(n)?r=n.range[0]:ps(n)&&(r=((i=n.oneOf)!==null&&i!==void 0?i:n.in)[0]),r&&(Ht(r)?t[n.field]="date":Y(r)?t[n.field]="number":N(r)&&(t[n.field]="string")),n.timeUnit&&(t[n.field]="date")}}),t}function Ry(e){const t={};function n(i){Sn(i)?t[i.field]="date":i.type==="quantitative"&&Nd(i.aggregate)?t[i.field]="number":un(i.field)>1?i.field in t||(t[i.field]="flatten"):Yt(i)&&Ve(i.sort)&&un(i.sort.field)>1&&(i.sort.field in t||(t[i.sort.field]="flatten"))}if((Q(e)||ze(e))&&e.forEachFieldDef((i,r)=>{if(we(i))n(i);else{const s=Ut(r),o=e.fieldDef(s);n(Object.assign(Object.assign({},i),{type:o.type}))}}),Q(e)){const{mark:i,markDef:r,encoding:s}=e;if(Et(i)&&!e.encoding.order){const o=r.orient==="horizontal"?"y":"x",a=s[o];x(a)&&a.type==="quantitative"&&!(a.field in t)&&(t[a.field]="number")}}return t}function Ly(e){const t={};if(Q(e)&&e.component.selection)for(const n of v(e.component.selection)){const i=e.component.selection[n];for(const r of i.project.items)!r.channel&&un(r.field)>1&&(t[r.field]="flatten")}return t}class ae extends M{constructor(t,n){super(t);this._parse=n}clone(){return new ae(null,F(this._parse))}hash(){return`Parse ${z(this._parse)}`}static makeExplicit(t,n,i){var r;let s={};const o=n.data;return!Nt(o)&&((r=o==null?void 0:o.format)===null||r===void 0?void 0:r.parse)&&(s=o.format.parse),this.makeWithAncestors(t,s,{},i)}static makeWithAncestors(t,n,i,r){for(const a of v(i)){const c=r.getWithExplicit(a);c.value!==void 0&&(c.explicit||c.value===i[a]||c.value==="derived"||i[a]==="flatten"?delete i[a]:O(Wa(a,i[a],c.value)))}for(const a of v(n)){const c=r.get(a);c!==void 0&&(c===n[a]?delete n[a]:O(Wa(a,n[a],c)))}const s=new gt(n,i);r.copyAll(s);const o={};for(const a of v(s.combine())){const c=s.get(a);c!==null&&(o[a]=c)}return v(o).length===0||r.parseNothing?null:new ae(t,o)}get parse(){return this._parse}merge(t){this._parse=Object.assign(Object.assign({},this._parse),t.parse),t.remove()}assembleFormatParse(){const t={};for(const n of v(this._parse)){const i=this._parse[n];un(n)===1&&(t[n]=i)}return t}producedFields(){return new Set(v(this._parse))}dependentFields(){return new Set(v(this._parse))}assembleTransforms(t=!1){return v(this._parse).filter(n=>t?un(n)>1:!0).map(n=>{const i=zy(n,this._parse[n]);if(!i)return null;const r={type:"formula",expr:i,as:Br(n)};return r}).filter(n=>n!==null)}}class zt extends M{clone(){return new zt(null)}constructor(t){super(t)}dependentFields(){return new Set}producedFields(){return new Set([Qe])}hash(){return"Identifier"}assemble(){return{type:"identifier",as:Qe}}}class ui extends M{constructor(t,n){super(t);this.params=n}clone(){return new ui(null,this.params)}dependentFields(){return new Set}producedFields(){return}hash(){return`Graticule ${z(this.params)}`}assemble(){return Object.assign({type:"graticule"},this.params===!0?{}:this.params)}}class fi extends M{constructor(t,n){super(t);this.params=n}clone(){return new fi(null,this.params)}dependentFields(){return new Set}producedFields(){var t;return new Set([(t=this.params.as)!==null&&t!==void 0?t:"data"])}hash(){return`Hash ${z(this.params)}`}assemble(){return Object.assign({type:"sequence"},this.params)}}class Jt extends M{constructor(t){super(null);t??(t={name:"source"});let n;if(Nt(t)||(n=t.format?Object.assign({},ue(t.format,["parse"])):{}),si(t))this._data={values:t.values};else if(jn(t)){if(this._data={url:t.url},!n.type){let i=/(?:\.([^.]+))?$/.exec(t.url)[1];A(["json","csv","tsv","dsv","topojson"],i)||(i="json"),n.type=i}}else Wl(t)?this._data={values:[{type:"Sphere"}]}:(Dl(t)||Nt(t))&&(this._data={});this._generator=Nt(t),t.name&&(this._name=t.name),n&&!L(n)&&(this._data.format=n)}dependentFields(){return new Set}producedFields(){return}get data(){return this._data}hasName(){return!!this._name}get isGenerator(){return this._generator}get dataName(){return this._name}set dataName(t){this._name=t}set parent(t){throw new Error("Source nodes have to be roots.")}remove(){throw new Error("Source nodes are roots and cannot be removed.")}hash(){throw new Error("Cannot hash sources")}assemble(){return Object.assign(Object.assign({name:this._name},this._data),{transform:[]})}}var Vu=function(e,t,n,i,r){if(i==="m")throw new TypeError("Private method is not writable");if(i==="a"&&!r)throw new TypeError("Private accessor was defined without a setter");if(typeof t=="function"?e!==t||!r:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return i==="a"?r.call(e,n):r?r.value=n:t.set(e,n),n},My=function(e,t,n,i){if(n==="a"&&!i)throw new TypeError("Private accessor was defined without a getter");if(typeof t=="function"?e!==t||!i:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return n==="m"?i:n==="a"?i.call(e):i?i.value:t.get(e)},di;function wo(e){return e instanceof Jt||e instanceof ui||e instanceof fi}class $o{constructor(){di.set(this,void 0),Vu(this,di,!1,"f")}setModified(){Vu(this,di,!0,"f")}get modifiedFlag(){return My(this,di,"f")}}di=new WeakMap;class en extends $o{getNodeDepths(t,n,i){i.set(t,n);for(const r of t.children)this.getNodeDepths(r,n+1,i);return i}optimize(t){const n=this.getNodeDepths(t,0,new Map),i=[...n.entries()].sort((r,s)=>s[1]-r[1]);for(const r of i)this.run(r[0]);return this.modifiedFlag}}class Eo extends $o{optimize(t){this.run(t);for(const n of t.children)this.optimize(n);return this.modifiedFlag}}class Dy extends Eo{mergeNodes(t,n){const i=n.shift();for(const r of n)t.removeChild(r),r.parent=i,r.remove()}run(t){const n=t.children.map(r=>r.hash()),i={};for(let r=0;r<n.length;r++)i[n[r]]===void 0?i[n[r]]=[t.children[r]]:i[n[r]].push(t.children[r]);for(const r of v(i))i[r].length>1&&(this.setModified(),this.mergeNodes(t,i[r]))}}class Uy extends Eo{constructor(t){super();this.requiresSelectionId=t&&go(t)}run(t){t instanceof zt&&(this.requiresSelectionId&&(wo(t.parent)||t.parent instanceof Te||t.parent instanceof ae)||(this.setModified(),t.remove()))}}class Wy extends $o{optimize(t){return this.run(t,new Set),this.modifiedFlag}run(t,n){let i=new Set;t instanceof et&&(i=t.producedFields(),Mr(i,n)&&(this.setModified(),t.removeFormulas(n),t.producedFields.length===0&&t.remove()));for(const r of t.children)this.run(r,new Set([...n,...i]))}}class By extends Eo{constructor(){super()}run(t){t instanceof le&&!t.isRequired()&&(this.setModified(),t.remove())}}class Hy extends en{run(t){if(wo(t))return;if(t.numChildren()>1)return;for(const n of t.children)if(n instanceof ae)if(t instanceof ae)this.setModified(),t.merge(n);else{if(Ur(t.producedFields(),n.dependentFields()))continue;this.setModified(),n.swapWithParent()}return}}class qy extends en{run(t){const n=[...t.children],i=t.children.filter(r=>r instanceof ae);if(t.numChildren()>1&&i.length>=1){const r={},s=new Set;for(const o of i){const a=o.parse;for(const c of v(a))c in r?r[c]!==a[c]&&s.add(c):r[c]=a[c]}for(const o of s)delete r[o];if(!L(r)){this.setModified();const o=new ae(t,r);for(const a of n){if(a instanceof ae)for(const c of v(r))delete a.parse[c];t.removeChild(a),a.parent=o,a instanceof ae&&v(a.parse).length===0&&a.remove()}}}}}class Gy extends en{run(t){t instanceof le||t.numChildren()>0||t instanceof Pn||(t instanceof Jt||(this.setModified(),t.remove()))}}class Vy extends en{run(t){const n=t.children.filter(r=>r instanceof et),i=n.pop();for(const r of n)this.setModified(),i.merge(r)}}class Xy extends en{run(t){const n=t.children.filter(r=>r instanceof Te),i={};for(const r of n){const s=z(r.groupBy);s in i||(i[s]=[]),i[s].push(r)}for(const r of v(i)){const s=i[r];if(s.length>1){const o=s.pop();for(const a of s)o.merge(a)&&(t.removeChild(a),a.parent=o,a.remove(),this.setModified())}}}}class Yy extends en{constructor(t){super();this.model=t}run(t){const n=!(wo(t)||t instanceof kn||t instanceof ae||t instanceof zt),i=[],r=[];for(const s of t.children)s instanceof tt&&(n&&!Ur(t.producedFields(),s.dependentFields())?i.push(s):r.push(s));if(i.length>0){const s=i.pop();for(const o of i)s.merge(o,this.model.renameSignal.bind(this.model));this.setModified(),t instanceof tt?t.merge(s,this.model.renameSignal.bind(this.model)):s.swapWithParent()}if(r.length>1){const s=r.pop();for(const o of r)s.merge(o,this.model.renameSignal.bind(this.model));this.setModified()}}}class Ky extends en{run(t){const n=[...t.children],i=Rt(n,o=>o instanceof le);if(!i||t.numChildren()<=1)return;const r=[];let s;for(const o of n)if(o instanceof le){let a=o;for(;a.numChildren()===1;){const[c]=a.children;if(c instanceof le)a=c;else break}r.push(...a.children),s?(t.removeChild(o),o.parent=s.parent,s.parent.removeChild(s),s.parent=a,this.setModified()):s=a}else r.push(o);if(r.length){this.setModified();for(const o of r)o.parent.removeChild(o),o.parent=s}}}class tn extends M{constructor(t,n){super(t);this.transform=n}clone(){return new tn(null,F(this.transform))}addDimensions(t){this.transform.groupby=Re(this.transform.groupby.concat(t),n=>n)}dependentFields(){const t=new Set;return this.transform.groupby&&this.transform.groupby.forEach(t.add,t),this.transform.joinaggregate.map(n=>n.field).filter(n=>n!==void 0).forEach(t.add,t),t}producedFields(){return new Set(this.transform.joinaggregate.map(this.getDefaultName))}getDefaultName(t){var n;return(n=t.as)!==null&&n!==void 0?n:_(t)}hash(){return`JoinAggregateTransform ${z(this.transform)}`}assemble(){const t=[],n=[],i=[];for(const s of this.transform.joinaggregate)n.push(s.op),i.push(this.getDefaultName(s)),t.push(s.field===void 0?null:s.field);const r=this.transform.groupby;return Object.assign({type:"joinaggregate",as:i,ops:n,fields:t},r!==void 0?{groupby:r}:{})}}function Qy(e){return e.stack.stackBy.reduce((t,n)=>{const i=n.fieldDef,r=_(i);return r&&t.push(r),t},[])}function Zy(e){return j(e)&&e.every(t=>N(t))&&e.length>1}class pt extends M{constructor(t,n){super(t);this._stack=n}clone(){return new pt(null,F(this._stack))}static makeFromTransform(t,n){const{stack:i,groupby:r,as:s,offset:o="zero"}=n,a=[],c=[];if(n.sort!==void 0)for(const f of n.sort)a.push(f.field),c.push(K(f.order,"ascending"));const l={field:a,order:c};let u;return Zy(s)?u=s:N(s)?u=[s,`${s}_end`]:u=[`${n.stack}_start`,`${n.stack}_end`],new pt(t,{dimensionFieldDefs:[],stackField:i,groupby:r,offset:o,sort:l,facetby:[],as:u})}static makeFromEncoding(t,n){const i=n.stack,{encoding:r}=n;if(!i)return null;const{groupbyChannels:s,fieldChannel:o,offset:a,impute:c}=i,l=s.map(g=>{const p=r[g];return Ke(p)}).filter(g=>!!g),u=Qy(n),f=n.encoding.order;let d;return j(f)||x(f)?d=Pa(f):d=u.reduce((g,p)=>(g.field.push(p),g.order.push(o==="y"?"descending":"ascending"),g),{field:[],order:[]}),new pt(t,{dimensionFieldDefs:l,stackField:n.vgField(o),facetby:[],stackby:u,sort:d,offset:a,impute:c,as:[n.vgField(o,{suffix:"start",forAs:!0}),n.vgField(o,{suffix:"end",forAs:!0})]})}get stack(){return this._stack}addDimensions(t){this._stack.facetby.push(...t)}dependentFields(){const t=new Set;return t.add(this._stack.stackField),this.getGroupbyFields().forEach(t.add,t),this._stack.facetby.forEach(t.add,t),this._stack.sort.field.forEach(t.add,t),t}producedFields(){return new Set(this._stack.as)}hash(){return`Stack ${z(this._stack)}`}getGroupbyFields(){const{dimensionFieldDefs:t,impute:n,groupby:i}=this._stack;return t.length>0?t.map(r=>r.bin?n?[_(r,{binSuffix:"mid"})]:[_(r,{}),_(r,{binSuffix:"end"})]:[_(r)]).flat():i??[]}assemble(){const t=[],{facetby:n,dimensionFieldDefs:i,stackField:r,stackby:s,sort:o,offset:a,impute:c,as:l}=this._stack;if(c)for(const u of i){const{bandPosition:f=.5,bin:d}=u;if(d){const g=_(u,{expr:"datum"}),p=_(u,{expr:"datum",binSuffix:"end"});t.push({type:"formula",expr:`${f}*${g}+${1-f}*${p}`,as:_(u,{binSuffix:"mid",forAs:!0})})}t.push({type:"impute",field:r,groupby:[...s,...n],key:_(u,{binSuffix:"mid"}),method:"value",value:0})}return t.push({type:"stack",groupby:[...this.getGroupbyFields(),...n],field:r,sort:o,as:l,offset:a}),t}}class Tn extends M{constructor(t,n){super(t);this.transform=n}clone(){return new Tn(null,F(this.transform))}addDimensions(t){this.transform.groupby=Re(this.transform.groupby.concat(t),n=>n)}dependentFields(){var t,n;const i=new Set;return((t=this.transform.groupby)!==null&&t!==void 0?t:[]).forEach(i.add,i),((n=this.transform.sort)!==null&&n!==void 0?n:[]).forEach(r=>i.add(r.field)),this.transform.window.map(r=>r.field).filter(r=>r!==void 0).forEach(i.add,i),i}producedFields(){return new Set(this.transform.window.map(this.getDefaultName))}getDefaultName(t){var n;return(n=t.as)!==null&&n!==void 0?n:_(t)}hash(){return`WindowTransform ${z(this.transform)}`}assemble(){var t;const n=[],i=[],r=[],s=[];for(const d of this.transform.window)i.push(d.op),r.push(this.getDefaultName(d)),s.push(d.param===void 0?null:d.param),n.push(d.field===void 0?null:d.field);const o=this.transform.frame,a=this.transform.groupby;if(o&&o[0]===null&&o[1]===null&&i.every(d=>Qr(d)))return Object.assign({type:"joinaggregate",as:r,ops:i,fields:n},a!==void 0?{groupby:a}:{});const c=[],l=[];if(this.transform.sort!==void 0)for(const d of this.transform.sort)c.push(d.field),l.push((t=d.order)!==null&&t!==void 0?t:"ascending");const u={field:c,order:l},f=this.transform.ignorePeers;return Object.assign(Object.assign(Object.assign({type:"window",params:s,as:r,ops:i,fields:n,sort:u},f!==void 0?{ignorePeers:f}:{}),a!==void 0?{groupby:a}:{}),o!==void 0?{frame:o}:{})}}function Jy(e){function t(n){if(!(n instanceof Pn)){const i=n.clone();if(i instanceof le){const r=Co+i.getSource();i.setSource(r),e.model.component.data.outputNodes[r]=i}else(i instanceof Te||i instanceof pt||i instanceof Tn||i instanceof tn)&&i.addDimensions(e.fields);for(const r of n.children.flatMap(t))r.parent=i;return[i]}return n.children.flatMap(t)}return t}function ko(e){if(e instanceof Pn)if(e.numChildren()===1&&!(e.children[0]instanceof le)){const t=e.children[0];(t instanceof Te||t instanceof pt||t instanceof Tn||t instanceof tn)&&t.addDimensions(e.fields),t.swapWithParent(),ko(e)}else{const t=e.model.component.data.main;Xu(t);const n=Jy(e),i=e.children.map(n).flat();for(const r of i)r.parent=t}else e.children.map(ko)}function Xu(e){if(e instanceof le&&e.type===W.Main&&e.numChildren()===1){const t=e.children[0];t instanceof Pn||(t.swapWithParent(),Xu(e))}}const Co="scale_",yr=5;function Fo(e){for(const t of e){for(const n of t.children)if(n.parent!==t)return!1;if(!Fo(t.children))return!1}return!0}function Ae(e,t){let n=!1;for(const i of t)n=e.optimize(i)||n;return n}function Yu(e,t,n){let i=e.sources,r=!1;return r=Ae(new By,i)||r,r=Ae(new Uy(t),i)||r,i=i.filter(s=>s.numChildren()>0),r=Ae(new Gy,i)||r,i=i.filter(s=>s.numChildren()>0),n||(r=Ae(new Hy,i)||r,r=Ae(new Yy(t),i)||r,r=Ae(new Wy,i)||r,r=Ae(new qy,i)||r,r=Ae(new Xy,i)||r,r=Ae(new Vy,i)||r,r=Ae(new Dy,i)||r,r=Ae(new Ky,i)||r),e.sources=i,r}function ev(e,t){Fo(e.sources);let n=0,i=0;for(let r=0;r<yr&&Yu(e,t,!0);r++)n++;e.sources.map(ko);for(let r=0;r<yr&&Yu(e,t,!1);r++)i++;Fo(e.sources),Math.max(n,i)===yr&&O(`Maximum optimization runs(${yr}) reached.`)}class he{constructor(t){Object.defineProperty(this,"signal",{enumerable:!0,get:t})}static fromName(t,n){return new he(()=>t(n))}}var tv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Ku(e){Q(e)?nv(e):iv(e)}function nv(e){const t=e.component.scales;for(const n of v(t)){const i=sv(e,n),r=t[n];if(r.setWithExplicit("domains",i),av(e,n),e.component.data.isFaceted){let s=e;for(;!ze(s)&&s.parent;)s=s.parent;const o=s.component.resolve.scale[n];if(o==="shared")for(const a of i.value)lt(a)&&(a.data=Co+a.data.replace(Co,""))}}}function iv(e){for(const n of e.children)Ku(n);const t=e.component.scales;for(const n of v(t)){let i,r=null;for(const s of e.children){const o=s.component.scales[n];if(o){i===void 0?i=o.getWithExplicit("domains"):i=Ft(i,o.getWithExplicit("domains"),"domains","scale",To);const a=o.get("selectionExtent");r&&a&&r.param!==a.param&&O(Kd),r=a}}t[n].setWithExplicit("domains",i),r&&t[n].set("selectionExtent",r,!0)}}function rv(e,t,n,i){if(e==="unaggregated"){const{valid:r,reason:s}=Qu(t,n);if(!r){O(s);return}}else if(e===void 0&&i.useUnaggregatedDomain){const{valid:r}=Qu(t,n);if(r)return"unaggregated"}return e}function sv(e,t){const n=e.getScaleComponent(t).get("type"),{encoding:i}=e,r=rv(e.scaleDomain(t),e.typedFieldDef(t),n,e.config.scale);return r!==e.scaleDomain(t)&&(e.specifiedScales[t]=Object.assign(Object.assign({},e.specifiedScales[t]),{domain:r})),t==="x"&&Z(i.x2)?Z(i.x)?Ft(It(n,r,e,"x"),It(n,r,e,"x2"),"domain","scale",To):It(n,r,e,"x2"):t==="y"&&Z(i.y2)?Z(i.y)?Ft(It(n,r,e,"y"),It(n,r,e,"y2"),"domain","scale",To):It(n,r,e,"y2"):It(n,r,e,t)}function ov(e,t,n){return e.map(i=>{const r=Qi(i,{timeUnit:n,type:t});return{signal:`{data: ${r}}`}})}function No(e,t,n){var i;const r=(i=se(n))===null||i===void 0?void 0:i.unit;return t==="temporal"||r?ov(e,t,r):[e]}function It(e,t,n,i){const{encoding:r}=n,s=Z(r[i]),{type:o}=s,a=s.timeUnit;if(xp(t)){const f=It(e,void 0,n,i),d=No(t.unionWith,o,a);return Je([...d,...f.value])}else{if(w(t))return Je([t]);if(t&&t!=="unaggregated"&&!fc(t))return Je(No(t,o,a))}const c=n.stack;if(c&&i===c.fieldChannel){if(c.offset==="normalize")return ve([[0,1]]);const f=n.requestDataName(W.Main);return ve([{data:f,field:n.vgField(i,{suffix:"start"})},{data:f,field:n.vgField(i,{suffix:"end"})}])}const l=_t(i)&&x(s)?cv(n,i,e):void 0;if(Xe(s)){const f=No([s.datum],o,a);return ve(f)}const u=s;if(t==="unaggregated"){const f=n.requestDataName(W.Main),{field:d}=s;return ve([{data:f,field:_({field:d,aggregate:"min"})},{data:f,field:_({field:d,aggregate:"max"})}])}else if(U(u.bin)){if(te(e))return e==="bin-ordinal"?ve([]):ve([{data:Wn(l)?n.requestDataName(W.Main):n.requestDataName(W.Raw),field:n.vgField(i,ii(u,i)?{binSuffix:"range"}:{}),sort:l===!0||!H(l)?{field:n.vgField(i,{}),op:"min"}:l}]);{const{bin:f}=u;if(U(f)){const d=jo(n,u.field,f);return ve([new he(()=>{const g=n.getSignalName(d);return`[${g}.start, ${g}.stop]`})])}else return ve([{data:n.requestDataName(W.Main),field:n.vgField(i,{})}])}}else if(u.timeUnit&&A(["time","utc"],e)&&Pc(u,Q(n)?n.encoding[Be(i)]:void 0,n.markDef,n.config)){const f=n.requestDataName(W.Main);return ve([{data:f,field:n.vgField(i)},{data:f,field:n.vgField(i,{suffix:"end"})}])}else return ve(l?[{data:Wn(l)?n.requestDataName(W.Main):n.requestDataName(W.Raw),field:n.vgField(i),sort:l}]:[{data:n.requestDataName(W.Main),field:n.vgField(i)}])}function Po(e,t){const{op:n,field:i,order:r}=e;return Object.assign(Object.assign({op:n??(t?"sum":Bi)},i?{field:xe(i)}:{}),r?{order:r}:{})}function av(e,t){var n;const i=e.component.scales[t],r=e.specifiedScales[t].domain,s=(n=e.fieldDef(t))===null||n===void 0?void 0:n.bin,o=fc(r)&&r,a=Wt(s)&&Ti(s.extent)&&s.extent;(o||a)&&i.set("selectionExtent",o??a,!0)}function cv(e,t,n){if(!te(n))return;const i=e.fieldDef(t),r=i.sort;if(kc(r))return{op:"min",field:Fn(i,t),order:"ascending"};const{stack:s}=e,o=s?new Set([...s.groupbyFields,...s.stackBy.map(a=>a.fieldDef.field)]):void 0;if(Ve(r)){const a=s&&!o.has(r.field);return Po(r,a)}else if(Ec(r)){const{encoding:a,order:c}=r,l=e.fieldDef(a),{aggregate:u,field:f}=l,d=s&&!o.has(f);if(ct(u)||jt(u))return Po({field:_(l),order:c},d);if(Qr(u)||!u)return Po({op:u,field:f,order:c},d)}else{if(r==="descending")return{op:"min",field:e.vgField(t),order:"descending"};if(A(["ascending",void 0],r))return!0}return}function Qu(e,t){const{aggregate:n,type:i}=e;return n?N(n)&&!Td.has(n)?{valid:!1,reason:jg(n)}:i==="quantitative"&&t==="log"?{valid:!1,reason:wg(e)}:{valid:!0}:{valid:!1,reason:_g(e)}}function To(e,t,n,i){return e.explicit&&t.explicit&&O(Fg(n,i,e.value,t.value)),{explicit:e.explicit,value:[...e.value,...t.value]}}function lv(e){const t=Re(e.map(o=>{if(lt(o)){const a=tv(o,["sort"]);return a}return o}),z),n=Re(e.map(o=>{if(lt(o)){const a=o.sort;return a!==void 0&&!Wn(a)&&("op"in a&&a.op==="count"&&delete a.field,a.order==="ascending"&&delete a.order),a}return}).filter(o=>o!==void 0),z);if(t.length===0)return;if(t.length===1){const o=e[0];if(lt(o)&&n.length>0){let a=n[0];if(n.length>1)O(Xa),a=!0;else if(H(a)&&"field"in a){const c=a.field;o.field===c&&(a=a.order?{order:a.order}:!0)}return Object.assign(Object.assign({},o),{sort:a})}return o}const i=Re(n.map(o=>Wn(o)||!("op"in o)||N(o.op)&&o.op in Cd?o:(O(Pg(o)),!0)),z);let r;i.length===1?r=i[0]:i.length>1&&(O(Xa),r=!0);const s=Re(e.map(o=>lt(o)?o.data:null),o=>o);if(s.length===1&&s[0]!==null){const o=Object.assign({data:s[0],fields:t.map(a=>a.field)},r?{sort:r}:{});return o}return Object.assign({fields:t},r?{sort:r}:{})}function Ao(e){if(lt(e)&&N(e.field))return e.field;if(zd(e)){let t;for(const n of e.fields)if(lt(n)&&N(n.field)){if(!t)t=n.field;else if(t!==n.field)return O(Tg),t}return O(Ag),t}else if(Id(e)){O(zg);const t=e.fields[0];return N(t)?t:void 0}return}function vr(e,t){const n=e.component.scales[t],i=n.get("domains").map(r=>(lt(r)&&(r.data=e.lookupDataSource(r.data)),r));return lv(i)}var uv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function Zu(e){return An(e)||Ro(e)?e.children.reduce((t,n)=>t.concat(Zu(n)),Ju(e)):Ju(e)}function Ju(e){return v(e.component.scales).reduce((t,n)=>{const i=e.component.scales[n];if(i.merged)return t;const r=i.combine(),{name:s,type:o,selectionExtent:a,domains:c,range:l,reverse:u}=r,f=uv(r,["name","type","selectionExtent","domains","range","reverse"]),d=fv(r.range,s,n,e),g=vr(e,n),p=a?tb(e,a,i,g):null;return t.push(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({name:s,type:o},g?{domain:g}:{}),p?{domainRaw:p}:{}),{range:d}),u!==void 0?{reverse:u}:{}),f)),t},[])}function fv(e,t,n,i){if(ee(n)){if($t(e))return{step:{signal:`${t}_step`}}}else if(H(e)&&lt(e))return Object.assign(Object.assign({},e),{data:i.lookupDataSource(e.data)});return e}class ef extends gt{constructor(t,n){super({},{name:t});this.merged=!1,this.setWithExplicit("type",n)}domainDefinitelyIncludesZero(){return this.get("zero")!==!1?!0:Rt(this.get("domains"),t=>j(t)&&t.length===2&&t[0]<=0&&t[1]>=0)}}const dv=["range","scheme"];function gv(e){const t=e.component.scales;for(const n of Pi){const i=t[n];if(!i)continue;const r=pv(n,e);i.setWithExplicit("range",r)}}function tf(e,t){const n=e.fieldDef(t);if(n==null?void 0:n.bin){const{bin:i,field:r}=n,s=ge(t),o=e.getName(s);if(H(i)&&i.binned&&i.step!==void 0)return new he(()=>{const a=e.scaleName(t),c=`(domain("${a}")[1] - domain("${a}")[0]) / ${i.step}`;return`${e.getSignalName(o)} / (${c})`});if(U(i)){const a=jo(e,r,i);return new he(()=>{const c=e.getSignalName(a),l=`(${c}.stop - ${c}.start) / ${c}.step`;return`${e.getSignalName(o)} / (${l})`})}}return}function pv(e,t){const n=t.specifiedScales[e],{size:i}=t,r=t.getScaleComponent(e),s=r.get("type");for(const f of dv)if(n[f]!==void 0){const d=vs(s,f),g=dc(e,f);if(!d)O(Ga(s,f,e));else if(g)O(g);else switch(f){case"range":{const p=n.range;if(j(p)){if(ee(e))return Je(p.map(m=>{if(m==="width"||m==="height"){const h=t.getName(m),b=t.getSignalName.bind(t);return he.fromName(b,h)}return m}))}else if(H(p))return Je({data:t.requestDataName(W.Main),field:p.field,sort:{op:"min",field:t.vgField(e)}});return Je(p)}case"scheme":return Je(mv(n[f]))}}const o=e===G||e==="xOffset"?"width":"height",a=i[o];if(Ze(a)){if(ee(e))if(te(s)){const f=nf(a,t,e);if(f)return Je({step:f})}else O(Va(o));else if(gn(e)){const f=e===bt?"x":"y",d=t.getScaleComponent(f),g=d.get("type");if(g==="band"){const p=rf(a,s);if(p)return Je(p)}}}const{rangeMin:c,rangeMax:l}=n,u=hv(e,t);return(c!==void 0||l!==void 0)&&vs(s,"rangeMin")&&j(u)&&u.length===2?Je([c??u[0],l??u[1]]):ve(u)}function mv(e){return Op(e)?Object.assign({scheme:e.name},ue(e,["name"])):{scheme:e}}function hv(e,t){const{size:n,config:i,mark:r,encoding:s}=t,o=t.getSignalName.bind(t),{type:a}=Z(s[e]),c=t.getScaleComponent(e),l=c.get("type"),{domain:u,domainMid:f}=t.specifiedScales[e];switch(e){case G:case J:{if(A(["point","band"],l)){const p=sf(e,n,i.view);if(Ze(p)){const m=nf(p,t,e);return{step:m}}}const d=ge(e),g=t.getName(d);return e===J&&ye(l)?[he.fromName(o,g),0]:[0,he.fromName(o,g)]}case bt:case fn:return bv(e,t,l);case ot:{const d=t.component.scales[e].get("zero"),g=of(r,d,i),p=Ov(r,n,t,i);return bn(l)?vv(g,p,yv(l,i,u,e)):[g,p]}case Se:return[0,Math.PI*2];case Mt:return[0,360];case ke:return[0,new he(()=>{const d=t.getSignalName("width"),g=t.getSignalName("height");return`min(${d},${g})/2`})];case Ot:return[i.scale.minStrokeWidth,i.scale.maxStrokeWidth];case xt:return[[1,0],[4,2],[2,1],[1,1],[1,2,4,2]];case de:return"symbol";case fe:case Ue:case We:return l==="ordinal"?a==="nominal"?"category":"ordinal":f!==void 0?"diverging":r==="rect"||r==="geoshape"?"heatmap":"ramp";case at:case yt:case vt:return[i.scale.minOpacity,i.scale.maxOpacity]}}function nf(e,t,n){var i,r,s,o,a;const{encoding:c}=t,l=t.getScaleComponent(n),u=ba(n),f=c[u],d=dl({step:e,offsetIsDiscrete:C(f)&&sc(f.type)});if(d==="offset"&&qc(c,u)){const g=t.getScaleComponent(u),p=t.scaleName(u);let m=`domain('${p}').length`;if(g.get("type")==="band"){const b=(r=(i=g.get("paddingInner"))!==null&&i!==void 0?i:g.get("padding"))!==null&&r!==void 0?r:0,y=(o=(s=g.get("paddingOuter"))!==null&&s!==void 0?s:g.get("padding"))!==null&&o!==void 0?o:0;m=`bandspace(${m}, ${b}, ${y})`}const h=(a=l.get("paddingInner"))!==null&&a!==void 0?a:l.get("padding");return{signal:`${e.step} * ${m} / (1-${Dd(h)})`}}else return e.step}function rf(e,t){const n=dl({step:e,offsetIsDiscrete:te(t)});return n==="offset"?{step:e.step}:void 0}function bv(e,t,n){const i=e===bt?"x":"y",r=t.getScaleComponent(i),s=r.get("type"),o=t.scaleName(i);if(s==="band"){const a=sf(i,t.size,t.config.view);if(Ze(a)){const c=rf(a,n);if(c)return c}return[0,{signal:`bandwidth('${o}')`}]}else return ra(`Cannot use ${e} scale if ${i} scale is not discrete.`)}function sf(e,t,n){const i=e===G?"width":"height",r=t[i];return r||sr(n,i)}function yv(e,t,n,i){switch(e){case"quantile":return t.scale.quantileCount;case"quantize":return t.scale.quantizeCount;case"threshold":return n!==void 0&&j(n)?n.length+1:(O(Hg(i)),3)}}function vv(e,t,n){const i=()=>{const r=ut(t),s=ut(e),o=`(${r} - ${s}) / (${n} - 1)`;return`sequence(${s}, ${r} + ${o}, ${o})`};return w(t)?new he(i):{signal:i()}}function of(e,t,n){if(t)return w(t)?{signal:`${t.signal} ? 0 : ${of(e,!1,n)}`}:0;switch(e){case"bar":case"tick":return n.scale.minBandSize;case"line":case"trail":case"rule":return n.scale.minStrokeWidth;case"text":return n.scale.minFontSize;case"point":case"square":case"circle":return n.scale.minSize}throw new Error(zi("size",e))}const af=.95;function Ov(e,t,n,i){const r={x:tf(n,"x"),y:tf(n,"y")};switch(e){case"bar":case"tick":{if(i.scale.maxBandSize!==void 0)return i.scale.maxBandSize;const s=cf(t,r,i.view);return Y(s)?s-1:new he(()=>`${s.signal} - 1`)}case"line":case"trail":case"rule":return i.scale.maxStrokeWidth;case"text":return i.scale.maxFontSize;case"point":case"square":case"circle":{if(i.scale.maxSize)return i.scale.maxSize;const s=cf(t,r,i.view);return Y(s)?Math.pow(af*s,2):new he(()=>`pow(${af} * ${s.signal}, 2)`)}}throw new Error(zi("size",e))}function cf(e,t,n){const i=Ze(e.width)?e.width.step:rr(n,"width"),r=Ze(e.height)?e.height.step:rr(n,"height");return t.x||t.y?new he(()=>{const s=[t.x?t.x.signal:i,t.y?t.y.signal:r];return`min(${s.join(", ")})`}):Math.min(i,r)}function lf(e,t){Q(e)?xv(e,t):df(e,t)}function xv(e,t){const n=e.component.scales,{config:i,encoding:r,markDef:s,specifiedScales:o}=e;for(const a of v(n)){const c=o[a],l=n[a],u=e.getScaleComponent(a),f=Z(r[a]),d=c[t],g=u.get("type"),p=u.get("padding"),m=u.get("paddingInner"),h=vs(g,t),b=dc(a,t);if(d!==void 0&&(h?b&&O(b):O(Ga(g,t,a))),h&&b===void 0)if(d!==void 0){const y=f.timeUnit,S=f.type;switch(t){case"domainMax":case"domainMin":Ht(c[t])||S==="temporal"||y?l.set(t,{signal:Qi(c[t],{type:S,timeUnit:y})},!0):l.set(t,c[t],!0);break;default:l.copyKeyFromObject(t,c)}}else{const y=t in uf?uf[t]({model:e,channel:a,fieldOrDatumDef:f,scaleType:g,scalePadding:p,scalePaddingInner:m,domain:c.domain,domainMin:c.domainMin,domainMax:c.domainMax,markDef:s,config:i,hasNestedOffsetScale:zs(r,a),hasSecondaryRangeChannel:!!r[Be(a)]}):i.scale[t];y!==void 0&&l.set(t,y,!1)}}}const uf={bins:({model:e,fieldOrDatumDef:t})=>x(t)?Sv(e,t):void 0,interpolate:({channel:e,fieldOrDatumDef:t})=>_v(e,t.type),nice:({scaleType:e,channel:t,domain:n,domainMin:i,domainMax:r,fieldOrDatumDef:s})=>jv(e,t,n,i,r,s),padding:({channel:e,scaleType:t,fieldOrDatumDef:n,markDef:i,config:r})=>wv(e,t,r.scale,n,i,r.bar),paddingInner:({scalePadding:e,channel:t,markDef:n,scaleType:i,config:r,hasNestedOffsetScale:s})=>$v(e,t,n.type,i,r.scale,s),paddingOuter:({scalePadding:e,channel:t,scaleType:n,scalePaddingInner:i,config:r,hasNestedOffsetScale:s})=>Ev(e,t,n,i,r.scale,s),reverse:({fieldOrDatumDef:e,scaleType:t,channel:n,config:i})=>{const r=x(e)?e.sort:void 0;return kv(t,r,n,i.scale)},zero:({channel:e,fieldOrDatumDef:t,domain:n,markDef:i,scaleType:r,config:s,hasSecondaryRangeChannel:o})=>Cv(e,t,n,i,r,s.scale,o)};function ff(e){Q(e)?gv(e):df(e,"range")}function df(e,t){const n=e.component.scales;for(const i of e.children)t==="range"?ff(i):lf(i,t);for(const i of v(n)){let r;for(const s of e.children){const o=s.component.scales[i];if(o){const a=o.getWithExplicit(t);r=Ft(r,a,t,"scale",Ml((c,l)=>{switch(t){case"range":return c.step&&l.step?c.step-l.step:0}return 0}))}}n[i].setWithExplicit(t,r)}}function Sv(e,t){const n=t.bin;if(U(n)){const i=jo(e,t.field,n);return new he(()=>e.getSignalName(i))}else if(ie(n)&&Wt(n)&&n.step!==void 0)return{step:n.step};return}function _v(e,t){return A([fe,Ue,We],e)&&t!=="nominal"?"hcl":void 0}function jv(e,t,n,i,r,s){var o;return((o=Ke(s))===null||o===void 0?void 0:o.bin)||j(n)||r!=null||i!=null||A([me.TIME,me.UTC],e)?void 0:ee(t)?!0:void 0}function wv(e,t,n,i,r,s){if(ee(e)){if(Fe(t)){if(n.continuousPadding!==void 0)return n.continuousPadding;const{type:o,orient:a}=r;if(o==="bar"&&!(x(i)&&(i.bin||i.timeUnit))&&(a==="vertical"&&e==="x"||a==="horizontal"&&e==="y"))return s.continuousBandSize}if(t===me.POINT)return n.pointPadding}return}function $v(e,t,n,i,r,s=!1){if(e!==void 0)return;if(ee(t)){const{bandPaddingInner:o,barBandPaddingInner:a,rectBandPaddingInner:c,bandWithNestedOffsetPaddingInner:l}=r;return s?l:K(o,n==="bar"?a:c)}else if(gn(t)&&i===me.BAND)return r.offsetBandPaddingInner;return}function Ev(e,t,n,i,r,s=!1){if(e!==void 0)return;if(ee(t)){const{bandPaddingOuter:o,bandWithNestedOffsetPaddingOuter:a}=r;if(s)return a;if(n===me.BAND)return K(o,w(i)?{signal:`${i.signal}/2`}:i/2)}else if(gn(t)){if(n===me.POINT)return .5;if(n===me.BAND)return r.offsetBandPaddingOuter}return}function kv(e,t,n,i){return n==="x"&&i.xReverse!==void 0?ye(e)&&t==="descending"?w(i.xReverse)?{signal:`!${i.xReverse.signal}`}:!i.xReverse:i.xReverse:ye(e)&&t==="descending"?!0:void 0}function Cv(e,t,n,i,r,s,o){const a=!!n&&n!=="unaggregated";if(a&&ye(r)){if(j(n)){const c=n[0],l=n[n.length-1];if(c<=0&&l>=0)return!0}return!1}if(e==="size"&&t.type==="quantitative"&&!bn(r))return!0;if(!(x(t)&&t.bin)&&A([...He,...xd],e)){const{orient:c,type:l}=i;return A(["bar","area","line","trail"],l)&&(c==="horizontal"&&e==="y"||c==="vertical"&&e==="x")?!1:A(["bar","area"],l)&&!o?!0:s==null?void 0:s.zero}return!1}function Fv(e,t,n,i,r=!1){const s=Nv(t,n,i,r),{type:o}=e;return _t(t)?o!==void 0?Ep(t,o)?x(n)&&!$p(o,n.type)?(O(kg(o,s)),s):o:(O(Eg(t,o,s)),s):s:null}function Nv(e,t,n,i){var r;switch(t.type){case"nominal":case"ordinal":{if(dn(e)||Kr(e)==="discrete")return e==="shape"&&t.type==="ordinal"&&O(is(e,"ordinal")),"ordinal";if(ee(e)||gn(e)){if(A(["rect","bar","image","rule"],n.type))return"band";if(i)return"band"}else if(n.type==="arc"&&e in Yr)return"band";const s=n[ge(e)];return Gt(s)||vn(t)&&((r=t.axis)===null||r===void 0?void 0:r.tickBand)?"band":"point"}case"temporal":return dn(e)?"time":Kr(e)==="discrete"?(O(is(e,"temporal")),"ordinal"):x(t)&&t.timeUnit&&se(t.timeUnit).utc?"utc":"time";case"quantitative":return dn(e)?x(t)&&U(t.bin)?"bin-ordinal":"linear":Kr(e)==="discrete"?(O(is(e,"quantitative")),"ordinal"):"linear";case"geojson":return}throw new Error(Ha(t.type))}function Pv(e,{ignoreRange:t}={}){gf(e),Ku(e);for(const n of wp)lf(e,n);t||ff(e)}function gf(e){Q(e)?e.component.scales=Tv(e):e.component.scales=zv(e)}function Tv(e){const{encoding:t,mark:n,markDef:i}=e,r={};for(const s of Pi){const o=Z(t[s]);if(o&&n===mc&&s===de&&o.type===hn)continue;let a=o&&o.scale;if(gn(s)){const c=ya(s);if(!zs(t,c)){a&&O(gg(s));continue}}if(o&&a!==null&&a!==!1){a??(a={});const c=zs(t,s),l=Fv(a,s,o,i,c);r[s]=new ef(e.scaleName(`${s}`,!0),{value:l,explicit:a.type===l})}}return r}const Av=Ml((e,t)=>oc(e)-oc(t));function zv(e){var t,n;const i=e.component.scales={},r={},s=e.component.resolve;for(const o of e.children){gf(o);for(const a of v(o.component.scales))if((t=(n=s.scale)[a])!==null&&t!==void 0||(n[a]=Fu(a,e)),s.scale[a]==="shared"){const c=r[a],l=o.component.scales[a].getWithExplicit("type");c?mp(c.value,l.value)?r[a]=Ft(c,l,"type","scale",Av):(s.scale[a]="independent",delete r[a]):r[a]=l}}for(const o of v(r)){const a=e.scaleName(o,!0),c=r[o];i[o]=new ef(a,c);for(const l of e.children){const u=l.component.scales[o];u&&(l.renameScale(u.get("name"),a),u.merged=!0)}}return i}var zo=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class Io{constructor(){this.nameMap={}}rename(t,n){this.nameMap[t]=n}has(t){return this.nameMap[t]!==void 0}get(t){for(;this.nameMap[t]&&t!==this.nameMap[t];)t=this.nameMap[t];return t}}function Q(e){return(e==null?void 0:e.type)==="unit"}function ze(e){return(e==null?void 0:e.type)==="facet"}function Ro(e){return(e==null?void 0:e.type)==="concat"}function An(e){return(e==null?void 0:e.type)==="layer"}class Lo{constructor(t,n,i,r,s,o,a){var c,l;this.type=n,this.parent=i,this.config=s,this.correctDataNames=u=>{var f,d,g;return((f=u.from)===null||f===void 0?void 0:f.data)&&(u.from.data=this.lookupDataSource(u.from.data)),((g=(d=u.from)===null||d===void 0?void 0:d.facet)===null||g===void 0?void 0:g.data)&&(u.from.facet.data=this.lookupDataSource(u.from.facet.data)),u},this.parent=i,this.config=s,this.view=pe(a),this.name=(c=t.name)!==null&&c!==void 0?c:r,this.title=wt(t.title)?{text:t.title}:t.title?pe(t.title):void 0,this.scaleNameMap=i?i.scaleNameMap:new Io,this.projectionNameMap=i?i.projectionNameMap:new Io,this.signalNameMap=i?i.signalNameMap:new Io,this.data=t.data,this.description=t.description,this.transforms=Lh((l=t.transform)!==null&&l!==void 0?l:[]),this.layout=n==="layer"||n==="unit"?{}:Hm(t,n,s),this.component={data:{sources:i?i.component.data.sources:[],outputNodes:i?i.component.data.outputNodes:{},outputNodeRefCounts:i?i.component.data.outputNodeRefCounts:{},isFaceted:Hi(t)||(i==null?void 0:i.component.data.isFaceted)&&t.data===void 0},layoutSize:new gt,layoutHeaders:{row:{},column:{},facet:{}},mark:null,resolve:Object.assign({scale:{},axis:{},legend:{}},o?F(o):{}),selection:null,scales:null,projection:null,axes:{},legends:{}}}get width(){return this.getSizeSignalRef("width")}get height(){return this.getSizeSignalRef("height")}parse(){this.parseScale(),this.parseLayoutSize(),this.renameTopLevelLayoutSizeSignal(),this.parseSelections(),this.parseProjection(),this.parseData(),this.parseAxesAndHeaders(),this.parseLegends(),this.parseMarkGroup()}parseScale(){Pv(this)}parseProjection(){Bu(this)}renameTopLevelLayoutSizeSignal(){this.getName("width")!=="width"&&this.renameSignal(this.getName("width"),"width"),this.getName("height")!=="height"&&this.renameSignal(this.getName("height"),"height")}parseLegends(){Lu(this)}assembleEncodeFromView(t){const n=zo(t,["style"]),i={};for(const r of v(n)){const s=n[r];s!==void 0&&(i[r]=B(s))}return i}assembleGroupEncodeEntry(t){let n={};return this.view&&(n=this.assembleEncodeFromView(this.view)),!t&&(this.description&&(n.description=B(this.description)),this.type==="unit"||this.type==="layer")?Object.assign({width:this.getSizeSignalRef("width"),height:this.getSizeSignalRef("height")},n??{}):L(n)?void 0:n}assembleLayout(){if(!this.layout)return;const t=this.layout,{spacing:n}=t,i=zo(t,["spacing"]),{component:r,config:s}=this,o=Zb(r.layoutHeaders,s);return Object.assign(Object.assign(Object.assign({padding:n},this.assembleDefaultLayout()),i),o?{titleBand:o}:{})}assembleDefaultLayout(){return{}}assembleHeaderMarks(){const{layoutHeaders:t}=this.component;let n=[];for(const i of je)t[i].title&&n.push(Gb(this,i));for(const i of yo)n=n.concat(Vb(this,i));return n}assembleAxes(){return Ab(this.component.axes,this.config)}assembleLegends(){return Du(this)}assembleProjections(){return Sy(this)}assembleTitle(){var t,n,i;const r=(t=this.title)!==null&&t!==void 0?t:{},{encoding:s}=r,o=zo(r,["encoding"]),a=Object.assign(Object.assign(Object.assign({},$a(this.config.title).nonMarkTitleProperties),o),s?{encode:{update:s}}:{});return a.text?(A(["unit","layer"],this.type)?A(["middle",void 0],a.anchor)&&((n=a.frame)!==null&&n!==void 0||(a.frame="group")):(i=a.anchor)!==null&&i!==void 0||(a.anchor="start"),L(a)?void 0:a):void 0}assembleGroup(t=[]){const n={};t=t.concat(this.assembleSignals()),t.length>0&&(n.signals=t);const i=this.assembleLayout();i&&(n.layout=i),n.marks=[].concat(this.assembleHeaderMarks(),this.assembleMarks());const r=!this.parent||ze(this.parent)?Zu(this):[];r.length>0&&(n.scales=r);const s=this.assembleAxes();s.length>0&&(n.axes=s);const o=this.assembleLegends();return o.length>0&&(n.legends=o),n}getName(t){return q((this.name?`${this.name}_`:"")+t)}getDataName(t){return this.getName(W[t].toLowerCase())}requestDataName(t){const n=this.getDataName(t),i=this.component.data.outputNodeRefCounts;return i[n]=(i[n]||0)+1,n}getSizeSignalRef(t){if(ze(this.parent)){const n=ku(t),i=Ni(n),r=this.component.scales[i];if(r&&!r.merged){const s=r.get("type"),o=r.get("range");if(te(s)&&$t(o)){const a=r.get("name"),c=vr(this,i),l=Ao(c);if(l){const u=_({aggregate:"distinct",field:l},{expr:"datum"});return{signal:Eu(a,r,u)}}else return O(ts(i)),null}}}return{signal:this.signalNameMap.get(this.getName(t))}}lookupDataSource(t){const n=this.component.data.outputNodes[t];return n?n.getSource():t}getSignalName(t){return this.signalNameMap.get(t)}renameSignal(t,n){this.signalNameMap.rename(t,n)}renameScale(t,n){this.scaleNameMap.rename(t,n)}renameProjection(t,n){this.projectionNameMap.rename(t,n)}scaleName(t,n){return n?this.getName(t):ma(t)&&_t(t)&&this.component.scales[t]||this.scaleNameMap.has(this.getName(t))?this.scaleNameMap.get(this.getName(t)):void 0}projectionName(t){return t?this.getName("projection"):this.component.projection&&!this.component.projection.merged||this.projectionNameMap.has(this.getName("projection"))?this.projectionNameMap.get(this.getName("projection")):void 0}getScaleComponent(t){if(!this.component.scales)throw new Error("getScaleComponent cannot be called before parseScale(). Make sure you have called parseScale or use parseUnitModelWithScale().");const n=this.component.scales[t];return n&&!n.merged?n:this.parent?this.parent.getScaleComponent(t):void 0}getSelectionComponent(t,n){let i=this.component.selection[t];if(!i&&this.parent&&(i=this.parent.getSelectionComponent(t,n)),!i)throw new Error(qd(n));return i}hasAxisOrientSignalRef(){var t,n;return((t=this.component.axes.x)===null||t===void 0?void 0:t.some(i=>i.hasOrientSignalRef()))||((n=this.component.axes.y)===null||n===void 0?void 0:n.some(i=>i.hasOrientSignalRef()))}}class pf extends Lo{vgField(t,n={}){const i=this.fieldDef(t);return i?_(i,n):void 0}reduceFieldDef(t,n){return ym(this.getMapping(),(i,r,s)=>{const o=Ke(r);return o?t(i,o,s):i},n)}forEachFieldDef(t,n){Rs(this.getMapping(),(i,r)=>{const s=Ke(i);s&&t(s,r)},n)}}var Iv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class Or extends M{constructor(t,n){var i,r,s;super(t);this.transform=n,this.transform=F(n);const o=(i=this.transform.as)!==null&&i!==void 0?i:[void 0,void 0];this.transform.as=[(r=o[0])!==null&&r!==void 0?r:"value",(s=o[1])!==null&&s!==void 0?s:"density"],n.groupby&&n.minsteps==null&&n.maxsteps==null&&n.steps==null&&(this.transform.steps=200)}clone(){return new Or(null,F(this.transform))}dependentFields(){var t;return new Set([this.transform.density,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}producedFields(){return new Set(this.transform.as)}hash(){return`DensityTransform ${z(this.transform)}`}assemble(){const t=this.transform,{density:n}=t,i=Iv(t,["density"]),r=Object.assign({type:"kde",field:n},i);return r}}class gi extends M{constructor(t,n){super(t);this.filter=n}clone(){return new gi(null,Object.assign({},this.filter))}static make(t,n){const{config:i,mark:r,markDef:s}=n,o=R("invalid",s,i);if(o!=="filter")return null;const a=n.reduceFieldDef((c,l,u)=>{const f=_t(u)&&n.getScaleComponent(u);if(f){const d=f.get("type");ye(d)&&l.aggregate!=="count"&&!Et(r)&&(c[l.field]=l)}return c},{});return v(a).length?new gi(t,a):null}dependentFields(){return new Set(v(this.filter))}producedFields(){return new Set}hash(){return`FilterInvalid ${z(this.filter)}`}assemble(){const t=v(this.filter).reduce((n,i)=>{const r=this.filter[i],s=_(r,{expr:"datum"});return r!==null&&(r.type==="temporal"?n.push(`(isDate(${s}) || (isValid(${s}) && isFinite(+${s})))`):r.type==="quantitative"&&(n.push(`isValid(${s})`),n.push(`isFinite(+${s})`))),n},[]);return t.length>0?{type:"filter",expr:t.join(" && ")}:null}}class xr extends M{constructor(t,n){super(t);this.transform=n,this.transform=F(n);const{flatten:i,as:r=[]}=this.transform;this.transform.as=i.map((s,o)=>{var a;return(a=r[o])!==null&&a!==void 0?a:s})}clone(){return new xr(this.parent,F(this.transform))}dependentFields(){return new Set(this.transform.flatten)}producedFields(){return new Set(this.transform.as)}hash(){return`FlattenTransform ${z(this.transform)}`}assemble(){const{flatten:t,as:n}=this.transform,i={type:"flatten",fields:t,as:n};return i}}class Sr extends M{constructor(t,n){var i,r,s;super(t);this.transform=n,this.transform=F(n);const o=(i=this.transform.as)!==null&&i!==void 0?i:[void 0,void 0];this.transform.as=[(r=o[0])!==null&&r!==void 0?r:"key",(s=o[1])!==null&&s!==void 0?s:"value"]}clone(){return new Sr(null,F(this.transform))}dependentFields(){return new Set(this.transform.fold)}producedFields(){return new Set(this.transform.as)}hash(){return`FoldTransform ${z(this.transform)}`}assemble(){const{fold:t,as:n}=this.transform,i={type:"fold",fields:t,as:n};return i}}class zn extends M{constructor(t,n,i,r){super(t);this.fields=n,this.geojson=i,this.signal=r}clone(){return new zn(null,F(this.fields),this.geojson,this.signal)}static parseAll(t,n){if(n.component.projection&&!n.component.projection.isFit)return t;let i=0;for(const r of[[De,Me],[_e,Ce]]){const s=r.map(o=>{const a=Z(n.encoding[o]);return x(a)?a.field:Xe(a)?{expr:`${a.datum}`}:Pe(a)?{expr:`${a.value}`}:void 0});(s[0]||s[1])&&(t=new zn(t,s,null,n.getName(`geojson_${i++}`)))}if(n.channelHasField(de)){const r=n.typedFieldDef(de);r.type===hn&&(t=new zn(t,null,r.field,n.getName(`geojson_${i++}`)))}return t}dependentFields(){var t;const n=((t=this.fields)!==null&&t!==void 0?t:[]).filter(N);return new Set([...this.geojson?[this.geojson]:[],...n])}producedFields(){return new Set}hash(){return`GeoJSON ${this.geojson} ${this.signal} ${z(this.fields)}`}assemble(){return[...this.geojson?[{type:"filter",expr:`isValid(datum["${this.geojson}"])`}]:[],Object.assign(Object.assign(Object.assign({type:"geojson"},this.fields?{fields:this.fields}:{}),this.geojson?{geojson:this.geojson}:{}),{signal:this.signal})]}}class pi extends M{constructor(t,n,i,r){super(t);this.projection=n,this.fields=i,this.as=r}clone(){return new pi(null,this.projection,F(this.fields),F(this.as))}static parseAll(t,n){if(!n.projectionName())return t;for(const i of[[De,Me],[_e,Ce]]){const r=i.map(o=>{const a=Z(n.encoding[o]);return x(a)?a.field:Xe(a)?{expr:`${a.datum}`}:Pe(a)?{expr:`${a.value}`}:void 0}),s=i[0]===_e?"2":"";(r[0]||r[1])&&(t=new pi(t,n.projectionName(),r,[n.getName(`x${s}`),n.getName(`y${s}`)]))}return t}dependentFields(){return new Set(this.fields.filter(N))}producedFields(){return new Set(this.as)}hash(){return`Geopoint ${this.projection} ${z(this.fields)} ${z(this.as)}`}assemble(){return{type:"geopoint",projection:this.projection,fields:this.fields,as:this.as}}}class nn extends M{constructor(t,n){super(t);this.transform=n}clone(){return new nn(null,F(this.transform))}dependentFields(){var t;return new Set([this.transform.impute,this.transform.key,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}producedFields(){return new Set([this.transform.impute])}processSequence(t){const{start:n=0,stop:i,step:r}=t,s=[n,i,...r?[r]:[]].join(",");return{signal:`sequence(${s})`}}static makeFromTransform(t,n){return new nn(t,n)}static makeFromEncoding(t,n){const i=n.encoding,r=i.x,s=i.y;if(x(r)&&x(s)){const o=r.impute?r:s.impute?s:void 0;if(o===void 0)return;const a=r.impute?s:s.impute?r:void 0,{method:c,value:l,frame:u,keyvals:f}=o.impute,d=Vc(n.mark,i);return new nn(t,Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({impute:o.field,key:a.field},c?{method:c}:{}),l!==void 0?{value:l}:{}),u?{frame:u}:{}),f!==void 0?{keyvals:f}:{}),d.length?{groupby:d}:{}))}return null}hash(){return`Impute ${z(this.transform)}`}assemble(){const{impute:t,key:n,keyvals:i,method:r,groupby:s,value:o,frame:a=[null,null]}=this.transform,c=Object.assign(Object.assign(Object.assign(Object.assign({type:"impute",field:t,key:n},i?{keyvals:Oh(i)?this.processSequence(i):i}:{}),{method:"value"}),s?{groupby:s}:{}),{value:!r||r==="value"?o:null});if(r&&r!=="value"){const l=Object.assign({type:"window",as:[`imputed_${t}_value`],ops:[r],fields:[t],frame:a,ignorePeers:!1},s?{groupby:s}:{}),u={type:"formula",expr:`datum.${t} === null ? datum.imputed_${t}_value : datum.${t}`,as:t};return[c,l,u]}else return[c]}}var Rv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class _r extends M{constructor(t,n){var i,r,s;super(t);this.transform=n,this.transform=F(n);const o=(i=this.transform.as)!==null&&i!==void 0?i:[void 0,void 0];this.transform.as=[(r=o[0])!==null&&r!==void 0?r:n.on,(s=o[1])!==null&&s!==void 0?s:n.loess]}clone(){return new _r(null,F(this.transform))}dependentFields(){var t;return new Set([this.transform.loess,this.transform.on,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}producedFields(){return new Set(this.transform.as)}hash(){return`LoessTransform ${z(this.transform)}`}assemble(){const t=this.transform,{loess:n,on:i}=t,r=Rv(t,["loess","on"]),s=Object.assign({type:"loess",x:i,y:n},r);return s}}class mi extends M{constructor(t,n,i){super(t);this.transform=n,this.secondary=i}clone(){return new mi(null,F(this.transform),this.secondary)}static make(t,n,i,r){const s=n.component.data.sources,{from:o}=i;let a=null;if(xh(o)){let c=yf(o.data,s);c||(c=new Jt(o.data),s.push(c));const l=n.getName(`lookup_${r}`);a=new le(c,l,W.Lookup,n.component.data.outputNodeRefCounts),n.component.data.outputNodes[l]=a}else if(Sh(o)){const c=o.param;i=Object.assign({as:c},i);let l;try{l=n.getSelectionComponent(q(c),c)}catch(u){throw new Error(Xd(c))}if(a=l.materialized,!a)throw new Error(Yd(c))}return new mi(t,i,a.getSource())}dependentFields(){return new Set([this.transform.lookup])}producedFields(){return new Set(this.transform.as?V(this.transform.as):this.transform.from.fields)}hash(){return`Lookup ${z({transform:this.transform,secondary:this.secondary})}`}assemble(){let t;if(this.transform.from.fields)t=Object.assign({values:this.transform.from.fields},this.transform.as?{as:V(this.transform.as)}:{});else{let n=this.transform.as;N(n)||(O(ig),n="_lookup"),t={as:[n]}}return Object.assign(Object.assign({type:"lookup",from:this.secondary,key:this.transform.from.key,fields:[this.transform.lookup]},t),this.transform.default?{default:this.transform.default}:{})}}var Lv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class jr extends M{constructor(t,n){var i,r,s;super(t);this.transform=n,this.transform=F(n);const o=(i=this.transform.as)!==null&&i!==void 0?i:[void 0,void 0];this.transform.as=[(r=o[0])!==null&&r!==void 0?r:"prob",(s=o[1])!==null&&s!==void 0?s:"value"]}clone(){return new jr(null,F(this.transform))}dependentFields(){var t;return new Set([this.transform.quantile,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}producedFields(){return new Set(this.transform.as)}hash(){return`QuantileTransform ${z(this.transform)}`}assemble(){const t=this.transform,{quantile:n}=t,i=Lv(t,["quantile"]),r=Object.assign({type:"quantile",field:n},i);return r}}var Mv=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};class wr extends M{constructor(t,n){var i,r,s;super(t);this.transform=n,this.transform=F(n);const o=(i=this.transform.as)!==null&&i!==void 0?i:[void 0,void 0];this.transform.as=[(r=o[0])!==null&&r!==void 0?r:n.on,(s=o[1])!==null&&s!==void 0?s:n.regression]}clone(){return new wr(null,F(this.transform))}dependentFields(){var t;return new Set([this.transform.regression,this.transform.on,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}producedFields(){return new Set(this.transform.as)}hash(){return`RegressionTransform ${z(this.transform)}`}assemble(){const t=this.transform,{regression:n,on:i}=t,r=Mv(t,["regression","on"]),s=Object.assign({type:"regression",x:i,y:n},r);return s}}class $r extends M{constructor(t,n){super(t);this.transform=n}clone(){return new $r(null,F(this.transform))}addDimensions(t){var n;this.transform.groupby=Re(((n=this.transform.groupby)!==null&&n!==void 0?n:[]).concat(t),i=>i)}producedFields(){return}dependentFields(){var t;return new Set([this.transform.pivot,this.transform.value,...(t=this.transform.groupby)!==null&&t!==void 0?t:[]])}hash(){return`PivotTransform ${z(this.transform)}`}assemble(){const{pivot:t,value:n,groupby:i,limit:r,op:s}=this.transform;return Object.assign(Object.assign(Object.assign({type:"pivot",field:t,value:n},r!==void 0?{limit:r}:{}),s!==void 0?{op:s}:{}),i!==void 0?{groupby:i}:{})}}class Er extends M{constructor(t,n){super(t);this.transform=n}clone(){return new Er(null,F(this.transform))}dependentFields(){return new Set}producedFields(){return new Set}hash(){return`SampleTransform ${z(this.transform)}`}assemble(){return{type:"sample",size:this.transform.sample}}}function mf(e){let t=0;function n(i,r){var s;if(i instanceof Jt&&(!i.isGenerator&&!jn(i.data))){e.push(r);const o={name:null,source:r.name,transform:[]};r=o}if(i instanceof ae&&(i.parent instanceof Jt&&!r.source?(r.format=Object.assign(Object.assign({},(s=r.format)!==null&&s!==void 0?s:{}),{parse:i.assembleFormatParse()}),r.transform.push(...i.assembleTransforms(!0))):r.transform.push(...i.assembleTransforms())),i instanceof Pn){r.name||(r.name=`data_${t++}`),!r.source||r.transform.length>0?(e.push(r),i.data=r.name):i.data=r.source,e.push(...i.assemble());return}if((i instanceof ui||i instanceof fi||i instanceof gi||i instanceof kn||i instanceof Cn||i instanceof pi||i instanceof Te||i instanceof mi||i instanceof Tn||i instanceof tn||i instanceof Sr||i instanceof xr||i instanceof Or||i instanceof _r||i instanceof jr||i instanceof wr||i instanceof zt||i instanceof Er||i instanceof $r)&&r.transform.push(i.assemble()),(i instanceof tt||i instanceof et||i instanceof nn||i instanceof pt||i instanceof zn)&&r.transform.push(...i.assemble()),i instanceof le){if(r.source&&r.transform.length===0)i.setSource(r.source);else if(i.parent instanceof le)i.setSource(r.name);else if(r.name||(r.name=`data_${t++}`),i.setSource(r.name),i.numChildren()===1){e.push(r);const o={name:null,source:r.name,transform:[]};r=o}}switch(i.numChildren()){case 0:i instanceof le&&(!r.source||r.transform.length>0)&&e.push(r);break;case 1:n(i.children[0],r);break;default:{r.name||(r.name=`data_${t++}`);let o=r.name;!r.source||r.transform.length>0?e.push(r):o=r.source;for(const a of i.children){const c={name:null,source:o,transform:[]};n(a,c)}break}}}return n}function Dv(e){const t=[],n=mf(t);for(const i of e.children)n(i,{source:e.name,name:null,transform:[]});return t}function Uv(e,t){var n,i;const r=[],s=mf(r);let o=0;for(const c of e.sources){c.hasName()||(c.dataName=`source_${o++}`);const l=c.assemble();s(c,l)}for(const c of r)c.transform.length===0&&delete c.transform;let a=0;for(const[c,l]of r.entries())((n=l.transform)!==null&&n!==void 0?n:[]).length===0&&!l.source&&r.splice(a++,0,r.splice(c,1)[0]);for(const c of r)for(const l of(i=c.transform)!==null&&i!==void 0?i:[])l.type==="lookup"&&(l.from=e.outputNodes[l.from].getSource());for(const c of r)c.name in t&&(c.values=t[c.name]);return r}function Wv(e){return e==="top"||e==="left"||w(e)?"header":"footer"}function Bv(e){for(const t of je)Hv(e,t);bf(e,"x"),bf(e,"y")}function Hv(e,t){var n;const{facet:i,config:r,child:s,component:o}=e;if(e.channelHasField(t)){const a=i[t],c=Nn("title",null,r,t);let l=On(a,r,{allowDisabling:!0,includeDefault:c===void 0||!!c});s.component.layoutHeaders[t].title&&(l=j(l)?l.join(", "):l,l+=` / ${s.component.layoutHeaders[t].title}`,s.component.layoutHeaders[t].title=null);const u=Nn("labelOrient",a.header,r,t),f=a.header!==null?K((n=a.header)===null||n===void 0?void 0:n.labels,r.header.labels,!0):!1,d=A(["bottom","right"],u)?"footer":"header";o.layoutHeaders[t]={title:a.header!==null?l:null,facetFieldDef:a,[d]:t==="facet"?[]:[hf(e,t,f)]}}}function hf(e,t,n){const i=t==="row"?"height":"width";return{labels:n,sizeSignal:e.child.component.layoutSize.get(i)?e.child.getSizeSignalRef(i):void 0,axes:[]}}function bf(e,t){var n;const{child:i}=e;if(i.component.axes[t]){const{layoutHeaders:r,resolve:s}=e.component;if(s.axis[t]=So(s,t),s.axis[t]==="shared"){const o=t==="x"?"column":"row",a=r[o];for(const c of i.component.axes[t]){const l=Wv(c.get("orient"));(n=a[l])!==null&&n!==void 0||(a[l]=[hf(e,o,!1)]);const u=li(c,"main",e.config,{header:!0});u&&a[l][0].axes.push(u),c.mainExtracted=!0}}}}function qv(e){Mo(e),kr(e,"width"),kr(e,"height")}function Gv(e){Mo(e);const t=e.layout.columns===1?"width":"childWidth",n=e.layout.columns===void 0?"height":"childHeight";kr(e,t),kr(e,n)}function Mo(e){for(const t of e.children)t.parseLayoutSize()}function kr(e,t){var n;const i=ku(t),r=Ni(i),s=e.component.resolve,o=e.component.layoutSize;let a;for(const c of e.children){const l=c.component.layoutSize.getWithExplicit(i),u=(n=s.scale[r])!==null&&n!==void 0?n:Fu(r,e);if(u==="independent"&&l.value==="step"){a=void 0;break}if(a){if(u==="independent"&&a.value!==l.value){a=void 0;break}a=Ft(a,l,i,"")}else a=l}if(a){for(const c of e.children)e.renameSignal(c.getName(i),e.getName(t)),c.component.layoutSize.set(i,"merged",!1);o.setWithExplicit(t,a)}else o.setWithExplicit(t,{explicit:!1,value:void 0})}function Vv(e){const{size:t,component:n}=e;for(const i of He){const r=ge(i);if(t[r]){const s=t[r];n.layoutSize.set(r,Ze(s)?"step":s,!0)}else{const s=Xv(e,r);n.layoutSize.set(r,s,!1)}}}function Xv(e,t){const n=t==="width"?"x":"y",i=e.config,r=e.getScaleComponent(n);if(r){const s=r.get("type"),o=r.get("range");if(te(s)){const a=sr(i.view,t);return $t(o)||Ze(a)?"step":a}else return Ys(i.view,t)}else{if(e.hasProjection||e.mark==="arc")return Ys(i.view,t);{const s=sr(i.view,t);return Ze(s)?s.step:s}}}function Do(e,t,n){return _(t,Object.assign({suffix:`by_${_(e)}`},n??{}))}class hi extends pf{constructor(t,n,i,r){super(t,"facet",n,i,r,t.resolve);this.child=qo(t.spec,this,this.getName("child"),void 0,r),this.children=[this.child],this.facet=this.initFacet(t.facet)}initFacet(t){if(!ti(t))return{facet:this.initFacetFieldDef(t,"facet")};const n=v(t),i={};for(const r of n){if(![nt,it].includes(r)){O(zi(r,"facet"));break}const s=t[r];if(s.field===void 0){O(ns(s,r));break}i[r]=this.initFacetFieldDef(s,r)}return i}initFacetFieldDef(t,n){const i=As(t,n);return i.header?i.header=pe(i.header):i.header===null&&(i.header=null),i}channelHasField(t){return!!this.facet[t]}fieldDef(t){return this.facet[t]}parseData(){this.component.data=Cr(this),this.child.parseData()}parseLayoutSize(){Mo(this)}parseSelections(){this.child.parseSelections(),this.component.selection=this.child.component.selection}parseMarkGroup(){this.child.parseMarkGroup()}parseAxesAndHeaders(){this.child.parseAxesAndHeaders(),Bv(this)}assembleSelectionTopLevelSignals(t){return this.child.assembleSelectionTopLevelSignals(t)}assembleSignals(){return this.child.assembleSignals(),[]}assembleSelectionData(t){return this.child.assembleSelectionData(t)}getHeaderLayoutMixins(){var t,n,i;const r={};for(const s of je)for(const o of vo){const a=this.component.layoutHeaders[s],c=a[o],{facetFieldDef:l}=a;if(l){const u=Nn("titleOrient",l.header,this.config,s);if(["right","bottom"].includes(u)){const f=mr(s,u);(t=r.titleAnchor)!==null&&t!==void 0||(r.titleAnchor={}),r.titleAnchor[f]="end"}}if(c==null?void 0:c[0]){const u=s==="row"?"height":"width",f=o==="header"?"headerBand":"footerBand";s!=="facet"&&!this.child.component.layoutSize.get(u)&&((n=r[f])!==null&&n!==void 0||(r[f]={}),r[f][s]=.5),a.title&&((i=r.offset)!==null&&i!==void 0||(r.offset={}),r.offset[s==="row"?"rowTitle":"columnTitle"]=10)}}return r}assembleDefaultLayout(){const{column:t,row:n}=this.facet,i=t?this.columnDistinctSignal():n?1:void 0;let r="all";return(!n&&this.component.resolve.scale.x==="independent"||!t&&this.component.resolve.scale.y==="independent")&&(r="none"),Object.assign(Object.assign(Object.assign({},this.getHeaderLayoutMixins()),i?{columns:i}:{}),{bounds:"full",align:r})}assembleLayoutSignals(){return this.child.assembleLayoutSignals()}columnDistinctSignal(){if(this.parent&&this.parent instanceof hi)return;{const t=this.getName("column_domain");return{signal:`length(data('${t}'))`}}}assembleGroupStyle(){return}assembleGroup(t){return this.parent&&this.parent instanceof hi?Object.assign(Object.assign({},this.channelHasField("column")?{encode:{update:{columns:{field:_(this.facet.column,{prefix:"distinct"})}}}}:{}),super.assembleGroup(t)):super.assembleGroup(t)}getCardinalityAggregateForChild(){const t=[],n=[],i=[];if(this.child instanceof hi){if(this.child.channelHasField("column")){const r=_(this.child.facet.column);t.push(r),n.push("distinct"),i.push(`distinct_${r}`)}}else for(const r of He){const s=this.child.component.scales[r];if(s&&!s.merged){const o=s.get("type"),a=s.get("range");if(te(o)&&$t(a)){const c=vr(this.child,r),l=Ao(c);l?(t.push(l),n.push("distinct"),i.push(`distinct_${l}`)):O(ts(r))}}}return{fields:t,ops:n,as:i}}assembleFacet(){const{name:t,data:n}=this.component.data.facetRoot,{row:i,column:r}=this.facet,{fields:s,ops:o,as:a}=this.getCardinalityAggregateForChild(),c=[];for(const u of je){const f=this.facet[u];if(f){c.push(_(f));const{bin:d,sort:g}=f;if(U(d)&&c.push(_(f,{binSuffix:"end"})),Ve(g)){const{field:p,op:m=Bi}=g,h=Do(f,g);i&&r?(s.push(h),o.push("max"),a.push(h)):(s.push(p),o.push(m),a.push(h))}else if(j(g)){const p=Fn(f,u);s.push(p),o.push("max"),a.push(p)}}}const l=!!i&&!!r;return Object.assign({name:t,data:n,groupby:c},l||s.length>0?{aggregate:Object.assign(Object.assign({},l?{cross:l}:{}),s.length?{fields:s,ops:o,as:a}:{})}:{})}facetSortFields(t){const{facet:n}=this,i=n[t];return i?Ve(i.sort)?[Do(i,i.sort,{expr:"datum"})]:j(i.sort)?[Fn(i,t,{expr:"datum"})]:[_(i,{expr:"datum"})]:[]}facetSortOrder(t){const{facet:n}=this,i=n[t];if(i){const{sort:r}=i,s=(Ve(r)?r.order:!j(r)&&r)||"ascending";return[s]}return[]}assembleLabelTitle(){var t;const{facet:n,config:i}=this;if(n.facet)return Oo(n.facet,"facet",i);const r={row:["top","bottom"],column:["left","right"]};for(const s of yo)if(n[s]){const o=Nn("labelOrient",(t=n[s])===null||t===void 0?void 0:t.header,i,s);if(r[s].includes(o))return Oo(n[s],s,i)}return}assembleMarks(){const{child:t}=this,n=this.component.data.facetRoot,i=Dv(n),r=t.assembleGroupEncodeEntry(!1),s=this.assembleLabelTitle()||t.assembleTitle(),o=t.assembleGroupStyle(),a=Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({name:this.getName("cell"),type:"group"},s?{title:s}:{}),o?{style:o}:{}),{from:{facet:this.assembleFacet()},sort:{field:je.map(c=>this.facetSortFields(c)).flat(),order:je.map(c=>this.facetSortOrder(c)).flat()}}),i.length>0?{data:i}:{}),r?{encode:{update:r}}:{}),t.assembleGroup(Qh(this,[])));return[a]}getMapping(){return this.facet}}function Yv(e,t){const{row:n,column:i}=t;if(n&&i){let r=null;for(const s of[n,i])if(Ve(s.sort)){const{field:o,op:a=Bi}=s.sort;e=r=new tn(e,{joinaggregate:[{op:a,field:o,as:Do(s,s.sort,{forAs:!0})}],groupby:[_(s)]})}return r}return null}function yf(e,t){var n,i,r,s;for(const o of t){const a=o.data;if(e.name&&o.hasName()&&e.name!==o.dataName)continue;const c=(n=e.format)===null||n===void 0?void 0:n.mesh,l=(i=a.format)===null||i===void 0?void 0:i.feature;if(c&&l)continue;const u=(r=e.format)===null||r===void 0?void 0:r.feature;if((u||l)&&u!==l)continue;const f=(s=a.format)===null||s===void 0?void 0:s.mesh;if((c||f)&&c!==f)continue;if(si(e)&&si(a)){if(Ie(e.values,a.values))return o}else if(jn(e)&&jn(a)){if(e.url===a.url)return o}else if(Dl(e)&&e.name===o.dataName)return o}return null}function Kv(e,t){if(e.data||!e.parent){if(e.data===null){const i=new Jt({values:[]});return t.push(i),i}const n=yf(e.data,t);if(n)return Nt(e.data)||(n.data.format=sa({},e.data.format,n.data.format)),!n.hasName()&&e.data.name&&(n.dataName=e.data.name),n;{const i=new Jt(e.data);return t.push(i),i}}else return e.parent.component.data.facetRoot?e.parent.component.data.facetRoot:e.parent.component.data.main}function Qv(e,t,n){var i,r;let s=0;for(const o of t.transforms){let a,c;if(Ph(o))c=e=new Cn(e,o),a="derived";else if(eo(o)){const l=Iy(o);c=e=(i=ae.makeWithAncestors(e,{},l,n))!==null&&i!==void 0?i:e,e=new kn(e,t,o.filter)}else if(Nl(o))c=e=tt.makeFromTransform(e,o,t),a="number";else if(Ah(o)){a="date";const l=n.getWithExplicit(o.field);l.value===void 0&&(e=new ae(e,{[o.field]:a}),n.set(o.field,a,!1)),c=e=et.makeFromTransform(e,o)}else if(zh(o))c=e=Te.makeFromTransform(e,o),a="number",go(t)&&(e=new zt(e));else if(Fl(o))c=e=mi.make(e,t,o,s++),a="derived";else if(Ch(o))c=e=new Tn(e,o),a="number";else if(Fh(o))c=e=new tn(e,o),a="number";else if(Ih(o))c=e=pt.makeFromTransform(e,o),a="derived";else if(Rh(o))c=e=new Sr(e,o),a="derived";else if(Nh(o))c=e=new xr(e,o),a="derived";else if(_h(o))c=e=new $r(e,o),a="derived";else if(kh(o))e=new Er(e,o);else if(Th(o))c=e=nn.makeFromTransform(e,o),a="derived";else if(jh(o))c=e=new Or(e,o),a="derived";else if(wh(o))c=e=new jr(e,o),a="derived";else if($h(o))c=e=new wr(e,o),a="derived";else if(Eh(o))c=e=new _r(e,o),a="derived";else{O(ng(o));continue}if(c&&a!==void 0)for(const l of(r=c.producedFields())!==null&&r!==void 0?r:[])n.set(l,a,!1)}return e}function Cr(e){var t,n,i,r,s,o,a,c,l,u;let f=Kv(e,e.component.data.sources);const{outputNodes:d,outputNodeRefCounts:g}=e.component.data,p=e.data,m=p&&(Nt(p)||jn(p)||si(p)),h=!m&&e.parent?e.parent.component.data.ancestorParse.clone():new Xh;Nt(p)?(Ul(p)?f=new fi(f,p.sequence):io(p)&&(f=new ui(f,p.graticule)),h.parseNothing=!0):((t=p==null?void 0:p.format)===null||t===void 0?void 0:t.parse)===null&&(h.parseNothing=!0),f=(n=ae.makeExplicit(f,e,h))!==null&&n!==void 0?n:f,f=new zt(f);const b=e.parent&&An(e.parent);(Q(e)||ze(e))&&(b&&(f=(i=tt.makeFromEncoding(f,e))!==null&&i!==void 0?i:f)),e.transforms.length>0&&(f=Qv(f,e,h));const y=Ly(e),S=Ry(e);f=(r=ae.makeWithAncestors(f,{},Object.assign(Object.assign({},y),S),h))!==null&&r!==void 0?r:f,Q(e)&&(f=zn.parseAll(f,e),f=pi.parseAll(f,e)),(Q(e)||ze(e))&&(b||(f=(s=tt.makeFromEncoding(f,e))!==null&&s!==void 0?s:f),f=(o=et.makeFromEncoding(f,e))!==null&&o!==void 0?o:f,f=Cn.parseAllForSortIndex(f,e));const k=e.getDataName(W.Raw),E=new le(f,k,W.Raw,g);if(d[k]=E,f=E,Q(e)){const X=Te.makeFromEncoding(f,e);X&&(f=X,go(e)&&(f=new zt(f))),f=(a=nn.makeFromEncoding(f,e))!==null&&a!==void 0?a:f,f=(c=pt.makeFromEncoding(f,e))!==null&&c!==void 0?c:f}Q(e)&&(f=(l=gi.make(f,e))!==null&&l!==void 0?l:f);const P=e.getDataName(W.Main),$=new le(f,P,W.Main,g);d[P]=$,f=$,Q(e)&&Pb(e,$);let T=null;if(ze(e)){const X=e.getName("facet");f=(u=Yv(f,e.facet))!==null&&u!==void 0?u:f,T=new Pn(f,e,X,$.getSource()),d[X]=T}return Object.assign(Object.assign({},e.component.data),{outputNodes:d,outputNodeRefCounts:g,raw:E,main:$,facetRoot:T,ancestorParse:h})}class Zv extends Lo{constructor(t,n,i,r){var s,o,a,c;super(t,"concat",n,i,r,t.resolve);(((o=(s=t.resolve)===null||s===void 0?void 0:s.axis)===null||o===void 0?void 0:o.x)==="shared"||((c=(a=t.resolve)===null||a===void 0?void 0:a.axis)===null||c===void 0?void 0:c.y)==="shared")&&O(Jd),this.children=this.getChildren(t).map((l,u)=>qo(l,this,this.getName(`concat_${u}`),void 0,r))}parseData(){this.component.data=Cr(this);for(const t of this.children)t.parseData()}parseSelections(){this.component.selection={};for(const t of this.children){t.parseSelections();for(const n of v(t.component.selection))this.component.selection[n]=t.component.selection[n]}}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxesAndHeaders(){for(const t of this.children)t.parseAxesAndHeaders()}getChildren(t){return ir(t)?t.vconcat:Xs(t)?t.hconcat:t.concat}parseLayoutSize(){Gv(this)}parseAxisGroup(){return null}assembleSelectionTopLevelSignals(t){return this.children.reduce((n,i)=>i.assembleSelectionTopLevelSignals(n),t)}assembleSignals(){return this.children.forEach(t=>t.assembleSignals()),[]}assembleLayoutSignals(){const t=xo(this);for(const n of this.children)t.push(...n.assembleLayoutSignals());return t}assembleSelectionData(t){return this.children.reduce((n,i)=>i.assembleSelectionData(n),t)}assembleMarks(){return this.children.map(t=>{const n=t.assembleTitle(),i=t.assembleGroupStyle(),r=t.assembleGroupEncodeEntry(!1);return Object.assign(Object.assign(Object.assign(Object.assign({type:"group",name:t.getName("group")},n?{title:n}:{}),i?{style:i}:{}),r?{encode:{update:r}}:{}),t.assembleGroup())})}assembleGroupStyle(){return}assembleDefaultLayout(){const t=this.layout.columns;return Object.assign(Object.assign({},t!=null?{columns:t}:{}),{bounds:"full",align:"each"})}}function Jv(e){return e===!1||e===null}const eO=Object.assign(Object.assign({disable:1,gridScale:1,scale:1},Wc),{labelExpr:1,encode:1}),vf=v(eO);class Uo extends gt{constructor(t={},n={},i=!1){super();this.explicit=t,this.implicit=n,this.mainExtracted=i}clone(){return new Uo(F(this.explicit),F(this.implicit),this.mainExtracted)}hasAxisPart(t){return t==="axis"?!0:t==="grid"||t==="title"?!!this.get(t):!Jv(this.get(t))}hasOrientSignalRef(){return w(this.explicit.orient)}}function tO(e,t,n){var i;const{encoding:r,config:s}=e,o=(i=Z(r[t]))!==null&&i!==void 0?i:Z(r[Be(t)]),a=e.axis(t)||{},{format:c,formatType:l}=a;if(Xt(l))return Object.assign({text:Ne({fieldOrDatumDef:o,field:"datum.value",format:c,formatType:l,config:s})},n);if(c===void 0&&l===void 0&&s.customFormatTypes){if(yn(o)==="quantitative"){if(vn(o)&&o.stack==="normalize"&&s.normalizedNumberFormatType)return Object.assign({text:Ne({fieldOrDatumDef:o,field:"datum.value",format:s.normalizedNumberFormat,formatType:s.normalizedNumberFormatType,config:s})},n);if(s.numberFormatType)return Object.assign({text:Ne({fieldOrDatumDef:o,field:"datum.value",format:s.numberFormat,formatType:s.numberFormatType,config:s})},n)}if(yn(o)==="temporal"&&s.timeFormatType&&x(o)&&!o.timeUnit)return Object.assign({text:Ne({fieldOrDatumDef:o,field:"datum.value",format:s.timeFormat,formatType:s.timeFormatType,config:s})},n)}return n}function nO(e){return He.reduce((t,n)=>(e.component.scales[n]&&(t[n]=[lO(n,e)]),t),{})}const iO={bottom:"top",top:"bottom",left:"right",right:"left"};function rO(e){var t;const{axes:n,resolve:i}=e.component,r={top:0,bottom:0,right:0,left:0};for(const s of e.children){s.parseAxesAndHeaders();for(const o of v(s.component.axes))i.axis[o]=So(e.component.resolve,o),i.axis[o]==="shared"&&(n[o]=sO(n[o],s.component.axes[o]),n[o]||(i.axis[o]="independent",delete n[o]))}for(const s of He){for(const o of e.children){if(!o.component.axes[s])continue;if(i.axis[s]==="independent"){n[s]=((t=n[s])!==null&&t!==void 0?t:[]).concat(o.component.axes[s]);for(const a of o.component.axes[s]){const{value:c,explicit:l}=a.getWithExplicit("orient");if(w(c))continue;if(r[c]>0&&!l){const u=iO[c];r[c]>r[u]&&a.set("orient",u,!1)}r[c]++}}delete o.component.axes[s]}if(i.axis[s]==="independent"&&n[s]&&n[s].length>1)for(const o of n[s])!!o.get("grid")&&!o.explicit.grid&&(o.implicit.grid=!1)}}function sO(e,t){if(e){if(e.length!==t.length)return;const n=e.length;for(let i=0;i<n;i++){const r=e[i],s=t[i];if(!!r!==!!s)return;if(r&&s){const o=r.getWithExplicit("orient"),a=s.getWithExplicit("orient");if(o.explicit&&a.explicit&&o.value!==a.value)return;e[i]=oO(r,s)}}}else return t.map(n=>n.clone());return e}function oO(e,t){for(const n of vf){const i=Ft(e.getWithExplicit(n),t.getWithExplicit(n),n,"axis",(r,s)=>{switch(n){case"title":return za(r,s);case"gridScale":return{explicit:r.explicit,value:K(r.value,s.value)}}return ar(r,s,n,"axis")});e.setWithExplicit(n,i)}return e}function aO(e,t,n,i,r){if(t==="disable")return n!==void 0;n=n||{};switch(t){case"titleAngle":case"labelAngle":return e===(w(n.labelAngle)?n.labelAngle:qn(n.labelAngle));case"values":return!!n.values;case"encode":return!!n.encoding||!!n.labelAngle;case"title":if(e===Su(i,r))return!0}return e===n[t]}const cO=new Set(["grid","translate","format","formatType","orient","labelExpr","tickCount","position","tickMinStep"]);function lO(e,t){var n,i,r;let s=t.axis(e);const o=new Uo,a=Z(t.encoding[e]),{mark:c,config:l}=t,u=(s==null?void 0:s.orient)||((n=l[e==="x"?"axisX":"axisY"])===null||n===void 0?void 0:n.orient)||((i=l.axis)===null||i===void 0?void 0:i.orient)||Wb(e),f=t.getScaleComponent(e).get("type"),d=zb(e,f,u,t.config),g=s!==void 0?!s:ho("disable",l.style,s==null?void 0:s.style,d).configValue;if(o.set("disable",g,s!==void 0),g)return o;s=s||{};const p=Mb(a,s,e,l.style,d),m={fieldOrDatumDef:a,axis:s,channel:e,model:t,scaleType:f,orient:u,labelAngle:p,mark:c,config:l};for(const y of vf){const S=y in vu?vu[y](m):Bc(y)?s[y]:void 0,k=S!==void 0,E=aO(S,y,s,t,e);if(k&&E)o.set(y,S,E);else{const{configValue:P=void 0,configFrom:$=void 0}=Bc(y)&&y!=="values"?ho(y,l.style,s.style,d):{},T=P!==void 0;k&&!T?o.set(y,S,E):(!($==="vgAxisConfig")||cO.has(y)&&T||ri(P)||w(P))&&o.set(y,P,!1)}}const h=(r=s.encoding)!==null&&r!==void 0?r:{},b=Uc.reduce((y,S)=>{var k;if(!o.hasAxisPart(S))return y;const E=Cu((k=h[S])!==null&&k!==void 0?k:{},t),P=S==="labels"?tO(t,e,E):E;return P!==void 0&&!L(P)&&(y[S]={update:P}),y},{});return L(b)||o.set("encode",b,!!s.encoding||s.labelAngle!==void 0),o}function uO({encoding:e,size:t}){for(const n of He){const i=ge(n);Ze(t[i])&&(Ye(e[n])&&(delete t[i],O(Va(i))))}return t}function fO(e,t,n){const i=pe(e),r=R("orient",i,n);if(i.orient=mO(i.type,t,r),r!==void 0&&r!==i.orient&&O(Og(i.orient,r)),i.type==="bar"&&i.orient){const a=R("cornerRadiusEnd",i,n);if(a!==void 0){const c=i.orient==="horizontal"&&t.x2||i.orient==="vertical"&&t.y2?["cornerRadius"]:Mp[i.orient];for(const l of c)i[l]=a;i.cornerRadiusEnd!==void 0&&delete i.cornerRadiusEnd}}const s=R("opacity",i,n);s===void 0&&(i.opacity=gO(i.type,t));const o=R("cursor",i,n);return o===void 0&&(i.cursor=dO(i,t,n)),i}function dO(e,t,n){return t.href||e.href||R("href",e,n)?"pointer":e.cursor}function gO(e,t){return A([Di,Os,xs,Ss],e)&&!Is(t)?.7:void 0}function pO(e,t,{graticule:n}){if(n)return!1;const i=Bt("filled",e,t),r=e.type;return K(i,r!==Di&&r!==Mi&&r!==Ui)}function mO(e,t,n){switch(e){case Di:case xs:case Ss:case pc:case Cp:case kp:return}const{x:i,y:r,x2:s,y2:o}=t;switch(e){case Li:if(x(i)&&(ie(i.bin)||x(r)&&r.aggregate&&!i.aggregate))return"vertical";if(x(r)&&(ie(r.bin)||x(i)&&i.aggregate&&!r.aggregate))return"horizontal";if(o||s){if(n)return n;if(!s)return(x(i)&&i.type===qt&&!U(i.bin)||Ns(i))&&(x(r)&&ie(r.bin))?"horizontal":"vertical";if(!o)return(x(r)&&r.type===qt&&!U(r.bin)||Ns(r))&&(x(i)&&ie(i.bin))?"vertical":"horizontal"}case Ui:if(s&&!(x(i)&&ie(i.bin))&&o&&!(x(r)&&ie(r.bin)))return;case Ri:if(o)return x(r)&&ie(r.bin)?"horizontal":"vertical";if(s)return x(i)&&ie(i.bin)?"vertical":"horizontal";if(e===Ui){if(i&&!r)return"vertical";if(r&&!i)return"horizontal"}case Mi:case Os:{const a=Ye(i),c=Ye(r);if(n)return n;if(a&&!c)return e!=="tick"?"horizontal":"vertical";if(!a&&c)return e!=="tick"?"vertical":"horizontal";if(a&&c){const l=i,u=r,f=l.type===mn,d=u.type===mn;return f&&!d?e!=="tick"?"vertical":"horizontal":!f&&d?e!=="tick"?"horizontal":"vertical":!l.aggregate&&u.aggregate?e!=="tick"?"vertical":"horizontal":l.aggregate&&!u.aggregate&&e!=="tick"?"horizontal":"vertical"}else return}}return"vertical"}const hO={vgMark:"arc",encodeEntry:e=>Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})),oe("x",e,{defaultPos:"mid"})),oe("y",e,{defaultPos:"mid"})),Tt(e,"radius")),Tt(e,"theta"))},bO={vgMark:"area",encodeEntry:e=>Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",orient:"include",size:"ignore",theta:"ignore"})),lr("x",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="horizontal"})),lr("y",e,{defaultPos:"zeroOrMin",defaultPos2:"zeroOrMin",range:e.markDef.orient==="vertical"})),uo(e))},yO={vgMark:"rect",encodeEntry:e=>Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),Tt(e,"x")),Tt(e,"y"))},vO={vgMark:"shape",encodeEntry:e=>Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})),postEncodingTransform:e=>{const{encoding:t}=e,n=t.shape,i=Object.assign({type:"geoshape",projection:e.projectionName()},n&&x(n)&&n.type===hn?{field:_(n,{expr:"datum"})}:{});return[i]}},OO={vgMark:"image",encodeEntry:e=>Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"ignore",orient:"ignore",size:"ignore",theta:"ignore"})),Tt(e,"x")),Tt(e,"y")),co(e,"url"))},xO={vgMark:"line",encodeEntry:e=>Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",size:"ignore",orient:"ignore",theta:"ignore"})),oe("x",e,{defaultPos:"mid"})),oe("y",e,{defaultPos:"mid"})),ne("size",e,{vgChannel:"strokeWidth"})),uo(e))},SO={vgMark:"trail",encodeEntry:e=>Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"})),oe("x",e,{defaultPos:"mid"})),oe("y",e,{defaultPos:"mid"})),ne("size",e)),uo(e))};function Wo(e,t){const{config:n}=e;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",size:"include",orient:"ignore",theta:"ignore"})),oe("x",e,{defaultPos:"mid"})),oe("y",e,{defaultPos:"mid"})),ne("size",e)),ne("angle",e)),_O(e,n,t))}function _O(e,t,n){return n?{shape:{value:n}}:ne("shape",e)}const jO={vgMark:"symbol",encodeEntry:e=>Wo(e)},wO={vgMark:"symbol",encodeEntry:e=>Wo(e,"circle")},$O={vgMark:"symbol",encodeEntry:e=>Wo(e,"square")},EO={vgMark:"rect",encodeEntry:e=>Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),Tt(e,"x")),Tt(e,"y"))},kO={vgMark:"rule",encodeEntry:e=>{const{markDef:t}=e,n=t.orient;return!e.encoding.x&&!e.encoding.y&&!e.encoding.latitude&&!e.encoding.longitude?{}:Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),lr("x",e,{defaultPos:n==="horizontal"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="vertical"})),lr("y",e,{defaultPos:n==="vertical"?"zeroOrMax":"mid",defaultPos2:"zeroOrMin",range:n!=="horizontal"})),ne("size",e,{vgChannel:"strokeWidth"}))}},CO={vgMark:"text",encodeEntry:e=>{const{config:t,encoding:n}=e;return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"include",baseline:"include",color:"include",size:"ignore",orient:"ignore",theta:"include"})),oe("x",e,{defaultPos:"mid"})),oe("y",e,{defaultPos:"mid"})),co(e)),ne("size",e,{vgChannel:"fontSize"})),ne("angle",e)),eu("align",FO(e.markDef,n,t))),eu("baseline",NO(e.markDef,n,t))),oe("radius",e,{defaultPos:null})),oe("theta",e,{defaultPos:null}))}};function FO(e,t,n){const i=R("align",e,n);return i===void 0?"center":void 0}function NO(e,t,n){const i=R("baseline",e,n);return i===void 0?"middle":void 0}const PO={vgMark:"rect",encodeEntry:e=>{const{config:t,markDef:n}=e,i=n.orient,r=i==="horizontal"?"width":"height",s=i==="horizontal"?"height":"width";return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},$e(e,{align:"ignore",baseline:"ignore",color:"include",orient:"ignore",size:"ignore",theta:"ignore"})),oe("x",e,{defaultPos:"mid",vgChannel:"xc"})),oe("y",e,{defaultPos:"mid",vgChannel:"yc"})),ne("size",e,{defaultValue:TO(e),vgChannel:r})),{[s]:B(R("thickness",n,t))})}};function TO(e){var t;const{config:n,markDef:i}=e,{orient:r}=i,s=r==="horizontal"?"width":"height",o=e.getScaleComponent(r==="horizontal"?"x":"y"),a=(t=R("size",i,n,{vgChannel:s}))!==null&&t!==void 0?t:n.tick.bandSize;if(a!==void 0)return a;{const c=o?o.get("range"):void 0;if(c&&$t(c)&&Y(c.step))return c.step*3/4;const l=rr(n.view,s);return l*3/4}}const Fr={arc:hO,area:bO,bar:yO,circle:wO,geoshape:vO,image:OO,line:xO,point:jO,rect:EO,rule:kO,square:$O,text:CO,tick:PO,trail:SO};function AO(e){if(A([Mi,Ri,Fp],e.mark)){const t=Vc(e.mark,e.encoding);if(t.length>0)return zO(e,t)}else if(e.mark===Li){const t=Zr.some(n=>R(n,e.markDef,e.config));if(e.stack&&!e.fieldDef("size")&&t)return IO(e)}return Bo(e)}const Of="faceted_path_";function zO(e,t){return[{name:e.getName("pathgroup"),type:"group",from:{facet:{name:Of+e.requestDataName(W.Main),data:e.requestDataName(W.Main),groupby:t}},encode:{update:{width:{field:{group:"width"}},height:{field:{group:"height"}}}},marks:Bo(e,{fromPrefix:Of})}]}const xf="stack_group_";function IO(e){var t;const[n]=Bo(e,{fromPrefix:xf}),i=e.scaleName(e.stack.fieldChannel),r=(u={})=>e.vgField(e.stack.fieldChannel,u),s=(u,f)=>{const d=[r({prefix:"min",suffix:"start",expr:f}),r({prefix:"max",suffix:"start",expr:f}),r({prefix:"min",suffix:"end",expr:f}),r({prefix:"max",suffix:"end",expr:f})];return`${u}(${d.map(g=>`scale('${i}',${g})`).join(",")})`};let o,a;e.stack.fieldChannel==="x"?(o=Object.assign(Object.assign({},ln(n.encode.update,["y","yc","y2","height",...Zr])),{x:{signal:s("min","datum")},x2:{signal:s("max","datum")},clip:{value:!0}}),a={x:{field:{group:"x"},mult:-1},height:{field:{group:"height"}}},n.encode.update=Object.assign(Object.assign({},ue(n.encode.update,["y","yc","y2"])),{height:{field:{group:"height"}}})):(o=Object.assign(Object.assign({},ln(n.encode.update,["x","xc","x2","width"])),{y:{signal:s("min","datum")},y2:{signal:s("max","datum")},clip:{value:!0}}),a={y:{field:{group:"y"},mult:-1},width:{field:{group:"width"}}},n.encode.update=Object.assign(Object.assign({},ue(n.encode.update,["x","xc","x2"])),{width:{field:{group:"width"}}}));for(const u of Zr){const f=Bt(u,e.markDef,e.config);n.encode.update[u]?(o[u]=n.encode.update[u],delete n.encode.update[u]):f&&(o[u]=B(f)),f&&(n.encode.update[u]={value:0})}const c=[];if(((t=e.stack.groupbyChannels)===null||t===void 0?void 0:t.length)>0)for(const u of e.stack.groupbyChannels){const f=e.fieldDef(u),d=_(f);d&&c.push(d),((f==null?void 0:f.bin)||(f==null?void 0:f.timeUnit))&&c.push(_(f,{binSuffix:"end"}))}const l=["stroke","strokeWidth","strokeJoin","strokeCap","strokeDash","strokeDashOffset","strokeMiterLimit","strokeOpacity"];return o=l.reduce((u,f)=>{if(n.encode.update[f])return Object.assign(Object.assign({},u),{[f]:n.encode.update[f]});{const d=Bt(f,e.markDef,e.config);return d!==void 0?Object.assign(Object.assign({},u),{[f]:B(d)}):u}},o),o.stroke&&(o.strokeForeground={value:!0},o.strokeOffset={value:0}),[{type:"group",from:{facet:{data:e.requestDataName(W.Main),name:xf+e.requestDataName(W.Main),groupby:c,aggregate:{fields:[r({suffix:"start"}),r({suffix:"start"}),r({suffix:"end"}),r({suffix:"end"})],ops:["min","max","min","max"]}}},encode:{update:o},marks:[{type:"group",encode:{update:a},marks:[n]}]}]}function RO(e){var t;const{encoding:n,stack:i,mark:r,markDef:s,config:o}=e,a=n.order;if(!j(a)&&Pe(a)&&Rr(a.value)||!a&&Rr(R("order",s,o)))return;if((j(a)||x(a))&&!i)return Pa(a,{expr:"datum"});if(Et(r)){const c=s.orient==="horizontal"?"y":"x",l=n[c];if(x(l)){const u=l.sort;if(j(u))return{field:_(l,{prefix:c,suffix:"sort_index",expr:"datum"})};if(Ve(u))return{field:_({aggregate:Is(e.encoding)?u.op:void 0,field:u.field},{expr:"datum"})};if(Ec(u)){const f=e.fieldDef(u.encoding);return{field:_(f,{expr:"datum"}),order:u.order}}else return u===null?void 0:{field:_(l,{binSuffix:((t=e.stack)===null||t===void 0?void 0:t.impute)?"mid":void 0,expr:"datum"})}}return}return}function Bo(e,t={fromPrefix:""}){const{mark:n,markDef:i,encoding:r,config:s}=e,o=K(i.clip,LO(e),MO(e)),a=Fa(i),c=r.key,l=RO(e),u=DO(e),f=R("aria",i,s),d=Fr[n].postEncodingTransform?Fr[n].postEncodingTransform(e):null;return[Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({name:e.getName("marks"),type:Fr[n].vgMark},o?{clip:!0}:{}),a?{style:a}:{}),c?{key:c.field}:{}),l?{sort:l}:{}),u||{}),f===!1?{aria:f}:{}),{from:{data:t.fromPrefix+e.requestDataName(W.Main)},encode:{update:Fr[n].encodeEntry(e)}}),d?{transform:d}:{})]}function LO(e){const t=e.getScaleComponent("x"),n=e.getScaleComponent("y");return(t==null?void 0:t.get("selectionExtent"))||(n==null?void 0:n.get("selectionExtent"))?!0:void 0}function MO(e){const t=e.component.projection;return t&&!t.isFit?!0:void 0}function DO(e){if(!e.component.selection)return null;const t=v(e.component.selection).length;let n=t,i=e.parent;for(;i&&n===0;)n=v(i.component.selection).length,i=i.parent;return n?{interactive:t>0||!!e.encoding.tooltip}:null}class Sf extends pf{constructor(t,n,i,r={},s){var o;super(t,"unit",n,i,s,void 0,gl(t)?t.view:void 0);this.specifiedScales={},this.specifiedAxes={},this.specifiedLegends={},this.specifiedProjection={},this.selection=[],this.children=[];const a=Ge(t.mark)?Object.assign({},t.mark):{type:t.mark},c=a.type;a.filled===void 0&&(a.filled=pO(a,s,{graticule:t.data&&io(t.data)}));const l=this.encoding=hm(t.encoding||{},c,a.filled,s);this.markDef=fO(a,l,s),this.size=uO({encoding:l,size:gl(t)?Object.assign(Object.assign(Object.assign({},r),t.width?{width:t.width}:{}),t.height?{height:t.height}:{}):r}),this.stack=xl(c,l),this.specifiedScales=this.initScales(c,l),this.specifiedAxes=this.initAxes(l),this.specifiedLegends=this.initLegends(l),this.specifiedProjection=t.projection,this.selection=((o=t.params)!==null&&o!==void 0?o:[]).filter(u=>Gs(u))}get hasProjection(){const{encoding:t}=this,n=this.mark===mc,i=t&&dd.some(r=>C(t[r]));return n||i}scaleDomain(t){const n=this.specifiedScales[t];return n?n.domain:void 0}axis(t){return this.specifiedAxes[t]}legend(t){return this.specifiedLegends[t]}initScales(t,n){return Pi.reduce((i,r)=>{var s;const o=Z(n[r]);return o&&(i[r]=this.initScale((s=o.scale)!==null&&s!==void 0?s:{})),i},{})}initScale(t){const{domain:n,range:i}=t,r=pe(t);return j(n)&&(r.domain=n.map(be)),j(i)&&(r.range=i.map(be)),r}initAxes(t){return He.reduce((n,i)=>{const r=t[i];if(C(r)||i===G&&C(t.x2)||i===J&&C(t.y2)){const s=C(r)?r.axis:void 0;n[i]=s&&this.initAxis(Object.assign({},s))}return n},{})}initAxis(t){const n=v(t),i={};for(const r of n){const s=t[r];i[r]=ri(s)?Ea(s):be(s)}return i}initLegends(t){return Sd.reduce((n,i)=>{const r=Z(t[i]);if(r&&jd(i)){const s=r.legend;n[i]=s&&pe(s)}return n},{})}parseData(){this.component.data=Cr(this)}parseLayoutSize(){Vv(this)}parseSelections(){this.component.selection=Nb(this,this.selection)}parseMarkGroup(){this.component.mark=AO(this)}parseAxesAndHeaders(){this.component.axes=nO(this)}assembleSelectionTopLevelSignals(t){return Zh(this,t)}assembleSignals(){return[...bu(this),...Kh(this,[])]}assembleSelectionData(t){return Jh(this,t)}assembleLayout(){return null}assembleLayoutSignals(){return xo(this)}assembleMarks(){var t;let n=(t=this.component.mark)!==null&&t!==void 0?t:[];return(!this.parent||!An(this.parent))&&(n=Bl(this,n)),n.map(this.correctDataNames)}assembleGroupStyle(){const{style:t}=this.view||{};return t!==void 0?t:this.encoding.x||this.encoding.y?"cell":void 0}getMapping(){return this.encoding}get mark(){return this.markDef.type}channelHasField(t){return Kt(this.encoding,t)}fieldDef(t){const n=this.encoding[t];return Ke(n)}typedFieldDef(t){const n=this.fieldDef(t);return we(n)?n:null}}class Ho extends Lo{constructor(t,n,i,r,s){super(t,"layer",n,i,s,t.resolve,t.view);const o=Object.assign(Object.assign(Object.assign({},r),t.width?{width:t.width}:{}),t.height?{height:t.height}:{});this.children=t.layer.map((a,c)=>{if(or(a))return new Ho(a,this,this.getName(`layer_${c}`),o,s);if(ft(a))return new Sf(a,this,this.getName(`layer_${c}`),o,s);throw new Error(es(a))})}parseData(){this.component.data=Cr(this);for(const t of this.children)t.parseData()}parseLayoutSize(){qv(this)}parseSelections(){this.component.selection={};for(const t of this.children){t.parseSelections();for(const n of v(t.component.selection))this.component.selection[n]=t.component.selection[n]}}parseMarkGroup(){for(const t of this.children)t.parseMarkGroup()}parseAxesAndHeaders(){rO(this)}assembleSelectionTopLevelSignals(t){return this.children.reduce((n,i)=>i.assembleSelectionTopLevelSignals(n),t)}assembleSignals(){return this.children.reduce((t,n)=>t.concat(n.assembleSignals()),bu(this))}assembleLayoutSignals(){return this.children.reduce((t,n)=>t.concat(n.assembleLayoutSignals()),xo(this))}assembleSelectionData(t){return this.children.reduce((n,i)=>i.assembleSelectionData(n),t)}assembleGroupStyle(){const t=new Set;for(const i of this.children)for(const r of V(i.assembleGroupStyle()))t.add(r);const n=Array.from(t);return n.length>1?n:n.length===1?n[0]:void 0}assembleTitle(){let t=super.assembleTitle();if(t)return t;for(const n of this.children)if(t=n.assembleTitle(),t)return t;return}assembleLayout(){return null}assembleMarks(){return eb(this,this.children.flatMap(t=>t.assembleMarks()))}assembleLegends(){return this.children.reduce((t,n)=>t.concat(n.assembleLegends()),Du(this))}}function qo(e,t,n,i,r){if(Hi(e))return new hi(e,t,n,r);if(or(e))return new Ho(e,t,n,i,r);if(ft(e))return new Sf(e,t,n,i,r);if(Um(e))return new Zv(e,t,n,r);throw new Error(es(e))}var UO=function(e,t){var n={};for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.indexOf(i)<0&&(n[i]=e[i]);if(e!=null&&typeof Object.getOwnPropertySymbols=="function")for(var r=0,i=Object.getOwnPropertySymbols(e);r<i.length;r++)t.indexOf(i[r])<0&&Object.prototype.propertyIsEnumerable.call(e,i[r])&&(n[i[r]]=e[i[r]]);return n};function WO(e,t={}){t.logger&&qg(t.logger),t.fieldTitle&&Rc(t.fieldTitle);try{const n=vl(ta(t.config,e.config)),i=Il(e,n),r=qo(i,null,"",void 0,n);r.parse(),ev(r.component.data,r);const s=HO(r,BO(e,i.autosize,n,r),e.datasets,e.usermeta);return{spec:s,normalized:i}}finally{t.logger&&Gg(),t.fieldTitle&&om()}}function BO(e,t,n,i){const r=i.component.layoutSize.get("width"),s=i.component.layoutSize.get("height");if(t===void 0?(t={type:"pad"},i.hasAxisOrientSignalRef()&&(t.resize=!0)):N(t)&&(t={type:t}),r&&s&&qh(t.type)){if(r==="step"&&s==="step")O(La()),t.type="pad";else if(r==="step"||s==="step"){const o=r==="step"?"width":"height";O(La(Ni(o)));const a=o==="width"?"height":"width";t.type=Gh(a)}}return Object.assign(Object.assign(Object.assign({},v(t).length===1&&t.type?t.type==="pad"?{}:{autosize:t.type}:{autosize:t}),Ll(n,!1)),Ll(e,!0))}function HO(e,t,n={},i){const r=e.config?nh(e.config):void 0,s=[].concat(e.assembleSelectionData([]),Uv(e.component.data,n)),o=e.assembleProjections(),a=e.assembleTitle(),c=e.assembleGroupStyle(),l=e.assembleGroupEncodeEntry(!0);let u=e.assembleLayoutSignals();u=u.filter(g=>(g.name==="width"||g.name==="height")&&g.value!==void 0?(t[g.name]=+g.value,!1):!0);const{params:f}=t,d=UO(t,["params"]);return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({$schema:"https://vega.github.io/schema/vega/v5.json"},e.description?{description:e.description}:{}),d),a?{title:a}:{}),c?{style:c}:{}),l?{encode:{update:l}}:{}),{data:s}),o.length>0?{projections:o}:{}),e.assembleGroup([...u,...e.assembleSelectionTopLevelSignals([]),...fl(f)])),r?{config:r}:{}),i?{usermeta:i}:{})}const qO=rd.version;export{un as accessPathDepth,Wr as accessPathWithDatum,WO as compile,A as contains,Ie as deepEqual,ji as deleteNestedProperty,F as duplicate,ht as entries,Lr as every,Ur as fieldIntersection,aa as flatAccessWithDatum,K as getFirstDefined,Mr as hasIntersection,z as hash,ua as internalField,Wn as isBoolean,L as isEmpty,od as isEqual,fa as isInternalField,Rr as isNullOrFalse,wi as isNumeric,v as keys,Bn as logicalExpr,sa as mergeDeep,ra as never,Il as normalize,qn as normalizeAngle,ue as omit,ln as pick,Dr as prefixGenerator,Br as removePathFromField,Lt as replaceAll,xe as replacePathInField,cd as resetIdCounter,oa as setEqual,Rt as some,D as stringify,Hn as titleCase,Re as unique,la as uniqueId,re as vals,q as varName,qO as version};export default null;
