import{extend as be,inherits as v,array as M,accessorName as q,error as S,accessorFields as C,accessor as $,merge as tt,compare as it,truthy as nt,extent as U,span as at,toNumber as De,fastmap as V,hasOwnProperty as z,isArray as rt,field as W,key as st,ascending as ot,peek as ut,constant as lt,extentIndex as dt,identity as Oe,zero as ft}from"/-/vega-util@v1.17.2-LUfkDhormMyfWqy3Ts6U/dist=es2020,mode=imports,min/optimized/vega-util.js";import{Transform as h,replace as mt,ingest as N,tupleid as D,stableCompare as L,Operator as _,derive as K,rederive as ct}from"/-/vega-dataflow@v5.7.5-asKYS4gpPLMPf64pSozt/dist=es2020,mode=imports,min/optimized/vega-dataflow.js";import{bin as ht,sampleCurve as Ee,dotbin as pt,randomKDE as ke,quantiles as gt,quartiles as vt,bootstrapCI as yt,random as xt,randomMixture as bt,randomNormal as Dt,randomLogNormal as Ot,randomUniform as Et}from"/-/vega-statistics@v1.9.0-Qw8CjSQVQOg2M6VMgsme/dist=es2020,mode=imports,min/optimized/vega-statistics.js";import{range as qe,bisector as kt,median as qt,mean as St,min as _t,max as Nt}from"/-/d3-array@v3.2.4-G4hy00bPnjF6FrSYpT32/dist=es2020,mode=imports,min/optimized/d3-array.js";import{TIME_UNITS as Mt,utcInterval as Rt,timeInterval as Ct,timeBin as wt,timeUnits as Ut,utcFloor as At,timeFloor as It}from"/-/vega-time@v2.1.1-Q1TxQbneCNdh5ryZm2Gf/dist=es2020,mode=imports,min/optimized/vega-time.js";function Ft(e){return t=>{const i=e.length;let n=1,r=String(e[0](t));for(;n<i;++n)r+="|"+e[n](t);return r}}function Q(e){return!e||!e.length?function(){return""}:e.length===1?e[0]:Ft(e)}function Se(e,t,i){return i||e+(t?"_"+t:"")}const B=()=>{},zt={init:B,add:B,rem:B,idx:0},A={values:{init:e=>e.cell.store=!0,value:e=>e.cell.data.values(),idx:-1},count:{value:e=>e.cell.num},__count__:{value:e=>e.missing+e.valid},missing:{value:e=>e.missing},valid:{value:e=>e.valid},sum:{init:e=>e.sum=0,value:e=>e.valid?e.sum:void 0,add:(e,t)=>e.sum+=+t,rem:(e,t)=>e.sum-=t},product:{init:e=>e.product=1,value:e=>e.valid?e.product:void 0,add:(e,t)=>e.product*=t,rem:(e,t)=>e.product/=t},mean:{init:e=>e.mean=0,value:e=>e.valid?e.mean:void 0,add:(e,t)=>(e.mean_d=t-e.mean,e.mean+=e.mean_d/e.valid),rem:(e,t)=>(e.mean_d=t-e.mean,e.mean-=e.valid?e.mean_d/e.valid:e.mean)},average:{value:e=>e.valid?e.mean:void 0,req:["mean"],idx:1},variance:{init:e=>e.dev=0,value:e=>e.valid>1?e.dev/(e.valid-1):void 0,add:(e,t)=>e.dev+=e.mean_d*(t-e.mean),rem:(e,t)=>e.dev-=e.mean_d*(t-e.mean),req:["mean"],idx:1},variancep:{value:e=>e.valid>1?e.dev/e.valid:void 0,req:["variance"],idx:2},stdev:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid-1)):void 0,req:["variance"],idx:2},stdevp:{value:e=>e.valid>1?Math.sqrt(e.dev/e.valid):void 0,req:["variance"],idx:2},stderr:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid*(e.valid-1))):void 0,req:["variance"],idx:2},distinct:{value:e=>e.cell.data.distinct(e.get),req:["values"],idx:3},ci0:{value:e=>e.cell.data.ci0(e.get),req:["values"],idx:3},ci1:{value:e=>e.cell.data.ci1(e.get),req:["values"],idx:3},median:{value:e=>e.cell.data.q2(e.get),req:["values"],idx:3},q1:{value:e=>e.cell.data.q1(e.get),req:["values"],idx:3},q3:{value:e=>e.cell.data.q3(e.get),req:["values"],idx:3},min:{init:e=>e.min=void 0,value:e=>e.min=Number.isNaN(e.min)?e.cell.data.min(e.get):e.min,add:(e,t)=>{(t<e.min||e.min===void 0)&&(e.min=t)},rem:(e,t)=>{t<=e.min&&(e.min=NaN)},req:["values"],idx:4},max:{init:e=>e.max=void 0,value:e=>e.max=Number.isNaN(e.max)?e.cell.data.max(e.get):e.max,add:(e,t)=>{(t>e.max||e.max===void 0)&&(e.max=t)},rem:(e,t)=>{t>=e.max&&(e.max=NaN)},req:["values"],idx:4},argmin:{init:e=>e.argmin=void 0,value:e=>e.argmin||e.cell.data.argmin(e.get),add:(e,t,i)=>{t<e.min&&(e.argmin=i)},rem:(e,t)=>{t<=e.min&&(e.argmin=void 0)},req:["min","values"],idx:3},argmax:{init:e=>e.argmax=void 0,value:e=>e.argmax||e.cell.data.argmax(e.get),add:(e,t,i)=>{t>e.max&&(e.argmax=i)},rem:(e,t)=>{t>=e.max&&(e.argmax=void 0)},req:["max","values"],idx:3},exponential:{init:(e,t)=>{e.exp=0,e.exp_r=t},value:e=>e.valid?e.exp*(1-e.exp_r)/(1-e.exp_r**e.valid):void 0,add:(e,t)=>e.exp=e.exp_r*e.exp+t,rem:(e,t)=>e.exp=(e.exp-t/e.exp_r**(e.valid-1))/e.exp_r},exponentialb:{value:e=>e.valid?e.exp*(1-e.exp_r):void 0,req:["exponential"],idx:1}},I=Object.keys(A).filter(e=>e!=="__count__");function Lt(e,t){return(i,n)=>be({name:e,aggregate_param:n,out:i||e},zt,t)}[...I,"__count__"].forEach(e=>{A[e]=Lt(e,A[e])});function _e(e,t,i){return A[e](i,t)}function Ne(e,t){return e.idx-t.idx}function Pt(e){const t={};e.forEach(n=>t[n.name]=n);const i=n=>{if(!n.req)return;n.req.forEach(r=>{t[r]||i(t[r]=A[r]())})};return e.forEach(i),Object.values(t).sort(Ne)}function Tt(){this.valid=0,this.missing=0,this._ops.forEach(e=>e.aggregate_param==null?e.init(this):e.init(this,e.aggregate_param))}function jt(e,t){if(e==null||e===""){++this.missing;return}if(e!==e)return;++this.valid,this._ops.forEach(i=>i.add(this,e,t))}function $t(e,t){if(e==null||e===""){--this.missing;return}if(e!==e)return;--this.valid,this._ops.forEach(i=>i.rem(this,e,t))}function Vt(e){return this._out.forEach(t=>e[t.out]=t.value(this)),e}function Me(e,t){const i=t||Oe,n=Pt(e),r=e.slice().sort(Ne);function a(s){this._ops=n,this._out=r,this.cell=s,this.init()}return a.prototype.init=Tt,a.prototype.add=jt,a.prototype.rem=$t,a.prototype.set=Vt,a.prototype.get=i,a.fields=e.map(s=>s.out),a}function G(e){this._key=e?W(e):D,this.reset()}const E=G.prototype;E.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},E.add=function(e){this._add.push(e)},E.rem=function(e){this._rem.push(e)},E.values=function(){if(this._get=null,this._rem.length===0)return this._add;const e=this._add,t=this._rem,i=this._key,n=e.length,r=t.length,a=Array(n-r),s={};let o,u,d;for(o=0;o<r;++o)s[i(t[o])]=1;for(o=0,u=0;o<n;++o)s[i(d=e[o])]?s[i(d)]=0:a[u++]=d;return this._rem=[],this._add=a},E.distinct=function(e){const t=this.values(),i={};let n=t.length,r=0,a;for(;--n>=0;)a=e(t[n])+"",z(i,a)||(i[a]=1,++r);return r},E.extent=function(e){if(this._get!==e||!this._ext){const t=this.values(),i=dt(t,e);this._ext=[t[i[0]],t[i[1]]],this._get=e}return this._ext},E.argmin=function(e){return this.extent(e)[0]||{}},E.argmax=function(e){return this.extent(e)[1]||{}},E.min=function(e){const t=this.extent(e)[0];return t!=null?e(t):void 0},E.max=function(e){const t=this.extent(e)[1];return t!=null?e(t):void 0},E.quartile=function(e){return(this._get!==e||!this._q)&&(this._q=vt(this.values(),e),this._get=e),this._q},E.q1=function(e){return this.quartile(e)[0]},E.q2=function(e){return this.quartile(e)[1]},E.q3=function(e){return this.quartile(e)[2]},E.ci=function(e){return(this._get!==e||!this._ci)&&(this._ci=yt(this.values(),1e3,.05,e),this._get=e),this._ci},E.ci0=function(e){return this.ci(e)[0]},E.ci1=function(e){return this.ci(e)[1]};function w(e){h.call(this,null,e),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}w.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:I},{name:"aggregate_params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]},v(w,h,{transform(e,t){const i=this,n=t.fork(t.NO_SOURCE|t.NO_FIELDS),r=e.modified();return i.stamp=n.stamp,i.value&&(r||t.modified(i._inputs,!0))?(i._prev=i.value,i.value=r?i.init(e):Object.create(null),t.visit(t.SOURCE,a=>i.add(a))):(i.value=i.value||i.init(e),t.visit(t.REM,a=>i.rem(a)),t.visit(t.ADD,a=>i.add(a))),n.modifies(i._outputs),i._drop=e.drop!==!1,e.cross&&i._dims.length>1&&(i._drop=!1,i.cross()),t.clean()&&i._drop&&n.clean(!0).runAfter(()=>this.clean()),i.changes(n)},cross(){const e=this,t=e.value,i=e._dnames,n=i.map(()=>({})),r=i.length;function a(o){let u,d,l,f;for(u in o)for(l=o[u].tuple,d=0;d<r;++d)n[d][f=l[i[d]]]=f}a(e._prev),a(t);function s(o,u,d){const l=i[d],f=n[d++];for(const m in f){const g=o?o+"|"+m:m;u[l]=f[m],d<r?s(g,u,d):t[g]||e.cell(g,u)}}s("",{},0)},init(e){const t=this._inputs=[],i=this._outputs=[],n={};function r(b){const O=M(C(b)),R=O.length;let k=0,j;for(;k<R;++k)n[j=O[k]]||(n[j]=1,t.push(j))}this._dims=M(e.groupby),this._dnames=this._dims.map(b=>{const O=q(b);return r(b),i.push(O),O}),this.cellkey=e.key?e.key:Q(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];const a=e.fields||[null],s=e.ops||["count"],o=e.aggregate_params||[null],u=e.as||[],d=a.length,l={};let f,m,g,c,p,y,x;for(d!==s.length&&S("Unmatched number of fields and aggregate ops."),x=0;x<d;++x){if(f=a[x],m=s[x],g=o[x]||null,f==null&&m!=="count"&&S("Null aggregate field specified."),p=q(f),y=Se(m,p,u[x]),i.push(y),m==="count"){this._counts.push(y);continue}c=l[p],c||(r(f),c=l[p]=[],c.field=f,this._measures.push(c)),m!=="count"&&(this._countOnly=!1),c.push(_e(m,g,y))}return this._measures=this._measures.map(b=>Me(b,b.field)),Object.create(null)},cellkey:Q(),cell(e,t){let i=this.value[e];return i?i.num===0&&this._drop&&i.stamp<this.stamp?(i.stamp=this.stamp,this._adds[this._alen++]=i):i.stamp<this.stamp&&(i.stamp=this.stamp,this._mods[this._mlen++]=i):(i=this.value[e]=this.newcell(e,t),this._adds[this._alen++]=i),i},newcell(e,t){const i={key:e,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[e]),stamp:this.stamp,store:!1};if(!this._countOnly){const n=this._measures,r=n.length;i.agg=Array(r);for(let a=0;a<r;++a)i.agg[a]=new n[a](i)}return i.store&&(i.data=new G),i},newtuple(e,t){const i=this._dnames,n=this._dims,r=n.length,a={};for(let s=0;s<r;++s)a[i[s]]=n[s](e);return t?mt(t.tuple,a):N(a)},clean(){const e=this.value;for(const t in e)e[t].num===0&&delete e[t]},add(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num+=1,this._countOnly)return;i.store&&i.data.add(e);const n=i.agg;for(let r=0,a=n.length;r<a;++r)n[r].add(n[r].get(e),e)},rem(e){const t=this.cellkey(e),i=this.cell(t,e);if(i.num-=1,this._countOnly)return;i.store&&i.data.rem(e);const n=i.agg;for(let r=0,a=n.length;r<a;++r)n[r].rem(n[r].get(e),e)},celltuple(e){const t=e.tuple,i=this._counts;e.store&&e.data.values();for(let n=0,r=i.length;n<r;++n)t[i[n]]=e.num;if(!this._countOnly){const n=e.agg;for(let r=0,a=n.length;r<a;++r)n[r].set(t)}return t},changes(e){const t=this._adds,i=this._mods,n=this._prev,r=this._drop,a=e.add,s=e.rem,o=e.mod;let u,d,l,f;if(n)for(d in n)u=n[d],(!r||u.num)&&s.push(u.tuple);for(l=0,f=this._alen;l<f;++l)a.push(this.celltuple(t[l])),t[l]=null;for(l=0,f=this._mlen;l<f;++l)u=i[l],(u.num===0&&r?s:o).push(this.celltuple(u)),i[l]=null;return this._alen=this._mlen=0,this._prev=null,e}});const Wt=1e-14;function J(e){h.call(this,null,e)}J.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]},v(J,h,{transform(e,t){const i=e.interval!==!1,n=this._bins(e),r=n.start,a=n.step,s=e.as||["bin0","bin1"],o=s[0],u=s[1];let d;return e.modified()?(t=t.reflow(!0),d=t.SOURCE):d=t.modified(C(e.field))?t.ADD_MOD:t.ADD,t.visit(d,i?l=>{const f=n(l);l[o]=f,l[u]=f==null?null:r+a*(1+(f-r)/a)}:l=>l[o]=n(l)),t.modifies(i?s:o)},_bins(e){if(this.value&&!e.modified())return this.value;const t=e.field,i=ht(e),n=i.step;let r=i.start,a=r+Math.ceil((i.stop-r)/n)*n,s,o;(s=e.anchor)!=null&&(o=s-(r+n*Math.floor((s-r)/n)),r+=o,a+=o);const u=function(d){let l=De(t(d));return l==null?null:l<r?-Infinity:l>a?Infinity:(l=Math.max(r,Math.min(l,a-n)),r+n*Math.floor(Wt+(l-r)/n))};return u.start=r,u.stop=i.stop,u.step=n,this.value=$(u,C(t),e.name||"bin_"+q(t))}});function Re(e,t,i){const n=e;let r=t||[],a=i||[],s={},o=0;return{add:u=>a.push(u),remove:u=>s[n(u)]=++o,size:()=>r.length,data:(u,d)=>(o&&(r=r.filter(l=>!s[n(l)]),s={},o=0),d&&u&&r.sort(u),a.length&&(r=u?tt(u,r,a.sort(u)):r.concat(a),a=[]),r)}}function Y(e){h.call(this,[],e)}Y.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},v(Y,h,{transform(e,t){const i=t.fork(t.ALL),n=Re(D,this.value,i.materialize(i.ADD).add),r=e.sort,a=t.changed()||r&&(e.modified("sort")||t.modified(r.fields));return i.visit(i.REM,n.remove),this.modified(a),this.value=i.source=n.data(L(r),a),t.source&&t.source.root&&(this.value.root=t.source.root),i}});function Ce(e){_.call(this,null,Kt,e)}v(Ce,_);function Kt(e){return this.value&&!e.modified()?this.value:it(e.fields,e.orders)}function Z(e){h.call(this,null,e)}Z.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]};function Qt(e,t,i){switch(t){case"upper":e=e.toUpperCase();break;case"lower":e=e.toLowerCase();break}return e.match(i)}v(Z,h,{transform(e,t){const i=f=>m=>{for(var g=Qt(o(m),e.case,a)||[],c,p=0,y=g.length;p<y;++p)s.test(c=g[p])||f(c)},n=this._parameterCheck(e,t),r=this._counts,a=this._match,s=this._stop,o=e.field,u=e.as||["text","count"],d=i(f=>r[f]=1+(r[f]||0)),l=i(f=>r[f]-=1);return n?t.visit(t.SOURCE,d):(t.visit(t.ADD,d),t.visit(t.REM,l)),this._finish(t,u)},_parameterCheck(e,t){let i=!1;return(e.modified("stopwords")||!this._stop)&&(this._stop=new RegExp("^"+(e.stopwords||"")+"$","i"),i=!0),(e.modified("pattern")||!this._match)&&(this._match=new RegExp(e.pattern||"[\\w']+","g"),i=!0),(e.modified("field")||t.modified(e.field.fields))&&(i=!0),i&&(this._counts={}),i},_finish(e,t){const i=this._counts,n=this._tuples||(this._tuples={}),r=t[0],a=t[1],s=e.fork(e.NO_SOURCE|e.NO_FIELDS);let o,u,d;for(o in i)u=n[o],d=i[o]||0,!u&&d?(n[o]=u=N({}),u[r]=o,u[a]=d,s.add.push(u)):d===0?(u&&s.rem.push(u),i[o]=null,n[o]=null):u[a]!==d&&(u[a]=d,s.mod.push(u));return s.modifies(t)}});function H(e){h.call(this,null,e)}H.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},v(H,h,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.as||["a","b"],r=n[0],a=n[1],s=!this.value||t.changed(t.ADD_REM)||e.modified("as")||e.modified("filter");let o=this.value;return s?(o&&(i.rem=o),o=t.materialize(t.SOURCE).source,i.add=this.value=Bt(o,r,a,e.filter||nt)):i.mod=o,i.source=this.value,i.modifies(n)}});function Bt(e,t,i,n){for(var r=[],a={},s=e.length,o=0,u,d;o<s;++o)for(a[t]=d=e[o],u=0;u<s;++u)a[i]=e[u],n(a)&&(r.push(N(a)),a={},a[t]=d);return r}const we={kde:ke,mixture:bt,normal:Dt,lognormal:Ot,uniform:Et},Gt="distributions",Ue="function",Jt="field";function Ae(e,t){const i=e[Ue];z(we,i)||S("Unknown distribution function: "+i);const n=we[i]();for(const r in e)r===Jt?n.data((e.from||t()).map(e[r])):r===Gt?n[r](e[r].map(a=>Ae(a,t))):typeof n[r]===Ue&&n[r](e[r]);return n}function X(e){h.call(this,null,e)}const Ie=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"lognormal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],Yt={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:Ie},{name:"weights",type:"number",array:!0}]};X.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:Ie.concat(Yt)},{name:"as",type:"string",array:!0,default:["value","density"]}]},v(X,h,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const n=Ae(e.distribution,Zt(t)),r=e.steps||e.minsteps||25,a=e.steps||e.maxsteps||200;let s=e.method||"pdf";s!=="pdf"&&s!=="cdf"&&S("Invalid density method: "+s),!e.extent&&!n.data&&S("Missing density extent parameter."),s=n[s];const o=e.as||["value","density"],u=e.extent||U(n.data()),d=Ee(s,u,r,a).map(l=>{const f={};return f[o[0]]=l[0],f[o[1]]=l[1],N(f)});this.value&&(i.rem=this.value),this.value=i.add=i.source=d}return i}});function Zt(e){return()=>e.materialize(e.SOURCE).source}function Fe(e,t){return e?e.map((i,n)=>t[n]||q(i)):null}function ee(e,t,i){const n=[],r=f=>f(u);let a,s,o,u,d,l;if(t==null)n.push(e.map(i));else for(a={},s=0,o=e.length;s<o;++s)u=e[s],d=t.map(r),l=a[d],l||(a[d]=l=[],l.dims=d,n.push(l)),l.push(i(u));return n}const ze="bin";function te(e){h.call(this,null,e)}te.Definition={type:"DotBin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"groupby",type:"field",array:!0},{name:"step",type:"number"},{name:"smooth",type:"boolean",default:!1},{name:"as",type:"string",default:ze}]};const Ht=(e,t)=>at(U(e,t))/30;v(te,h,{transform(e,t){if(this.value&&!(e.modified()||t.changed()))return t;const i=t.materialize(t.SOURCE).source,n=ee(t.source,e.groupby,Oe),r=e.smooth||!1,a=e.field,s=e.step||Ht(i,a),o=L((c,p)=>a(c)-a(p)),u=e.as||ze,d=n.length;let l=Infinity,f=-Infinity,m=0,g;for(;m<d;++m){const c=n[m].sort(o);g=-1;for(const p of pt(c,s,r,a))p<l&&(l=p),p>f&&(f=p),c[++g][u]=p}return this.value={start:l,stop:f,step:s},t.reflow(!0).modifies(u)}});function Le(e){_.call(this,null,Xt,e),this.modified(!0)}v(Le,_);function Xt(e){const t=e.expr;return this.value&&!e.modified("expr")?this.value:$(i=>t(i,e),C(t),q(t))}function ie(e){h.call(this,[void 0,void 0],e)}ie.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},v(ie,h,{transform(e,t){const i=this.value,n=e.field,r=t.changed()||t.modified(n.fields)||e.modified("field");let a=i[0],s=i[1];if((r||a==null)&&(a=Infinity,s=-Infinity),t.visit(r?t.SOURCE:t.ADD,o=>{const u=De(n(o));u!=null&&(u<a&&(a=u),u>s&&(s=u))}),!Number.isFinite(a)||!Number.isFinite(s)){let o=q(n);o&&(o=` for field "${o}"`),t.dataflow.warn(`Infinite extent${o}: [${a}, ${s}]`),a=s=void 0}this.value=[a,s]}});function ne(e,t){_.call(this,e),this.parent=t,this.count=0}v(ne,_,{connect(e){return this.detachSubflow=e.detachSubflow,this.targets().add(e),e.source=this},add(e){this.count+=1,this.value.add.push(e)},rem(e){this.count-=1,this.value.rem.push(e)},mod(e){this.value.mod.push(e)},init(e){this.value.init(e,e.NO_SOURCE)},evaluate(){return this.value}});function P(e){h.call(this,{},e),this._keys=V();const t=this._targets=[];t.active=0,t.forEach=i=>{for(let n=0,r=t.active;n<r;++n)i(t[n],n,t)}}v(P,h,{activate(e){this._targets[this._targets.active++]=e},subflow(e,t,i,n){const r=this.value;let a=z(r,e)&&r[e],s,o;return a?a.value.stamp<i.stamp&&(a.init(i),this.activate(a)):(o=n||(o=this._group[e])&&o.tuple,s=i.dataflow,a=new ne(i.fork(i.NO_SOURCE),this),s.add(a).connect(t(s,e,o)),r[e]=a,this.activate(a)),a},clean(){const e=this.value;let t=0;for(const i in e)if(e[i].count===0){const n=e[i].detachSubflow;n&&n(),delete e[i],++t}if(t){const i=this._targets.filter(n=>n&&n.count>0);this.initTargets(i)}},initTargets(e){const t=this._targets,i=t.length,n=e?e.length:0;let r=0;for(;r<n;++r)t[r]=e[r];for(;r<i&&t[r]!=null;++r)t[r]=null;t.active=n},transform(e,t){const i=t.dataflow,n=e.key,r=e.subflow,a=this._keys,s=e.modified("key"),o=u=>this.subflow(u,r,t);return this._group=e.group||{},this.initTargets(),t.visit(t.REM,u=>{const d=D(u),l=a.get(d);l!==void 0&&(a.delete(d),o(l).rem(u))}),t.visit(t.ADD,u=>{const d=n(u);a.set(D(u),d),o(d).add(u)}),s||t.modified(n.fields)?t.visit(t.MOD,u=>{const d=D(u),l=a.get(d),f=n(u);l===f?o(f).mod(u):(a.set(d,f),o(l).rem(u),o(f).add(u))}):t.changed(t.MOD)&&t.visit(t.MOD,u=>{o(a.get(D(u))).mod(u)}),s&&t.visit(t.REFLOW,u=>{const d=D(u),l=a.get(d),f=n(u);l!==f&&(a.set(d,f),o(l).rem(u),o(f).add(u))}),t.clean()?i.runAfter(()=>{this.clean(),a.clean()}):a.empty>i.cleanThreshold&&i.runAfter(a.clean),t}});function Pe(e){_.call(this,null,ei,e)}v(Pe,_);function ei(e){return this.value&&!e.modified()?this.value:rt(e.name)?M(e.name).map(t=>W(t)):W(e.name,e.as)}function ae(e){h.call(this,V(),e)}ae.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},v(ae,h,{transform(e,t){const i=t.dataflow,n=this.value,r=t.fork(),a=r.add,s=r.rem,o=r.mod,u=e.expr;let d=!0;t.visit(t.REM,f=>{const m=D(f);n.has(m)?n.delete(m):s.push(f)}),t.visit(t.ADD,f=>{u(f,e)?a.push(f):n.set(D(f),1)});function l(f){const m=D(f),g=u(f,e),c=n.get(m);g&&c?(n.delete(m),a.push(f)):!g&&!c?(n.set(m,1),s.push(f)):d&&g&&!c&&o.push(f)}return t.visit(t.MOD,l),e.modified()&&(d=!1,t.visit(t.REFLOW,l)),n.empty>i.cleanThreshold&&i.runAfter(n.clean),r}});function re(e){h.call(this,[],e)}re.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"index",type:"string"},{name:"as",type:"string",array:!0}]},v(re,h,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=Fe(n,e.as||[]),a=e.index||null,s=r.length;return i.rem=this.value,t.visit(t.SOURCE,o=>{const u=n.map(c=>c(o)),d=u.reduce((c,p)=>Math.max(c,p.length),0);let l=0,f,m,g;for(;l<d;++l){for(m=K(o),f=0;f<s;++f)m[r[f]]=(g=u[f][l])==null?null:g;a&&(m[a]=l),i.add.push(m)}}),this.value=i.source=i.add,a&&i.modifies(a),i.modifies(r)}});function se(e){h.call(this,[],e)}se.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},v(se,h,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=n.map(q),a=e.as||["key","value"],s=a[0],o=a[1],u=n.length;return i.rem=this.value,t.visit(t.SOURCE,d=>{for(let l=0,f;l<u;++l)f=K(d),f[s]=r[l],f[o]=n[l](d),i.add.push(f)}),this.value=i.source=i.add,i.modifies(a)}});function oe(e){h.call(this,null,e)}oe.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},v(oe,h,{transform(e,t){const i=e.expr,n=e.as,r=e.modified(),a=e.initonly?t.ADD:r?t.SOURCE:t.modified(i.fields)||t.modified(n)?t.ADD_MOD:t.ADD;return r&&(t=t.materialize().reflow(!0)),e.initonly||t.modifies(n),t.visit(a,s=>s[n]=i(s,e))}});function Te(e){h.call(this,[],e)}v(Te,h,{transform(e,t){const i=t.fork(t.ALL),n=e.generator;let r=this.value,a=e.size-r.length,s,o,u;if(a>0){for(s=[];--a>=0;)s.push(u=N(n(e))),r.push(u);i.add=i.add.length?i.materialize(i.ADD).add.concat(s):s}else o=r.slice(0,-a),i.rem=i.rem.length?i.materialize(i.REM).rem.concat(o):o,r=r.slice(-a);return i.source=this.value=r,i}});const T={value:"value",median:qt,mean:St,min:_t,max:Nt},ti=[];function ue(e){h.call(this,[],e)}ue.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]};function ii(e){var t=e.method||T.value,i;if(T[t]==null)S("Unrecognized imputation method: "+t);else return t===T.value?(i=e.value!==void 0?e.value:0,()=>i):T[t]}function ni(e){const t=e.field;return i=>i?t(i):NaN}v(ue,h,{transform(e,t){var i=t.fork(t.ALL),n=ii(e),r=ni(e),a=q(e.field),s=q(e.key),o=(e.groupby||[]).map(q),u=ai(t.source,e.groupby,e.key,e.keyvals),d=[],l=this.value,f=u.domain.length,m,g,c,p,y,x,b,O,R,k;for(y=0,O=u.length;y<O;++y)for(m=u[y],c=m.values,g=NaN,b=0;b<f;++b){if(m[b]!=null)continue;for(p=u.domain[b],k={_impute:!0},x=0,R=c.length;x<R;++x)k[o[x]]=c[x];k[s]=p,k[a]=Number.isNaN(g)?g=n(m,r):g,d.push(N(k))}return d.length&&(i.add=i.materialize(i.ADD).add.concat(d)),l.length&&(i.rem=i.materialize(i.REM).rem.concat(l)),this.value=d,i}});function ai(e,t,i,n){var r=x=>x(y),a=[],s=n?n.slice():[],o={},u={},d,l,f,m,g,c,p,y;for(s.forEach((x,b)=>o[x]=b+1),m=0,p=e.length;m<p;++m)y=e[m],c=i(y),g=o[c]||(o[c]=s.push(c)),l=(d=t?t.map(r):ti)+"",(f=u[l])||(f=u[l]=[],a.push(f),f.values=d),f[g-1]=y;return a.domain=s,a}function le(e){w.call(this,e)}le.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:I},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]},v(le,w,{transform(e,t){const i=this,n=e.modified();let r;return i.value&&(n||t.modified(i._inputs,!0))?(r=i.value=n?i.init(e):{},t.visit(t.SOURCE,a=>i.add(a))):(r=i.value=i.value||this.init(e),t.visit(t.REM,a=>i.rem(a)),t.visit(t.ADD,a=>i.add(a))),i.changes(),t.visit(t.SOURCE,a=>{be(a,r[i.cellkey(a)].tuple)}),t.reflow(n).modifies(this._outputs)},changes(){const e=this._adds,t=this._mods;let i,n;for(i=0,n=this._alen;i<n;++i)this.celltuple(e[i]),e[i]=null;for(i=0,n=this._mlen;i<n;++i)this.celltuple(t[i]),t[i]=null;this._alen=this._mlen=0}});function de(e){h.call(this,null,e)}de.Definition={type:"KDE",metadata:{generates:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"cumulative",type:"boolean",default:!1},{name:"counts",type:"boolean",default:!1},{name:"bandwidth",type:"number",default:0},{name:"extent",type:"number",array:!0,length:2},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"as",type:"string",array:!0,default:["value","density"]}]},v(de,h,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const n=t.materialize(t.SOURCE).source,r=ee(n,e.groupby,e.field),a=(e.groupby||[]).map(q),s=e.bandwidth,o=e.cumulative?"cdf":"pdf",u=e.as||["value","density"],d=[];let l=e.extent,f=e.steps||e.minsteps||25,m=e.steps||e.maxsteps||200;o!=="pdf"&&o!=="cdf"&&S("Invalid density method: "+o),e.resolve==="shared"&&(l||(l=U(n,e.field)),f=m=e.steps||m),r.forEach(g=>{const c=ke(g,s)[o],p=e.counts?g.length:1,y=l||U(g);Ee(c,y,f,m).forEach(x=>{const b={};for(let O=0;O<a.length;++O)b[a[O]]=g.dims[O];b[u[0]]=x[0],b[u[1]]=x[1]*p,d.push(N(b))})}),this.value&&(i.rem=this.value),this.value=i.add=i.source=d}return i}});function je(e){_.call(this,null,ri,e)}v(je,_);function ri(e){return this.value&&!e.modified()?this.value:st(e.fields,e.flat)}function $e(e){h.call(this,[],e),this._pending=null}v($e,h,{transform(e,t){const i=t.dataflow;if(this._pending)return fe(this,t,this._pending);if(si(e))return t.StopPropagation;if(e.values)return fe(this,t,i.parse(e.values,e.format));if(e.async){const n=i.request(e.url,e.format).then(r=>(this._pending=M(r.data),a=>a.touch(this)));return{async:n}}else return i.request(e.url,e.format).then(n=>fe(this,t,M(n.data)))}});function si(e){return e.modified("async")&&!(e.modified("values")||e.modified("url")||e.modified("format"))}function fe(e,t,i){i.forEach(N);const n=t.fork(t.NO_FIELDS&t.NO_SOURCE);return n.rem=e.value,e.value=n.source=n.add=i,e._pending=null,n.rem.length&&n.clean(!0),n}function me(e){h.call(this,{},e)}me.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},v(me,h,{transform(e,t){const i=e.fields,n=e.index,r=e.values,a=e.default==null?null:e.default,s=e.modified(),o=i.length;let u=s?t.SOURCE:t.ADD,d=t,l=e.as,f,m,g;return r?(m=r.length,o>1&&!l&&S('Multi-field lookup requires explicit "as" parameter.'),l&&l.length!==o*m&&S('The "as" parameter has too few output field names.'),l=l||r.map(q),f=function(c){for(var p=0,y=0,x,b;p<o;++p)if(b=n.get(i[p](c)),b==null)for(x=0;x<m;++x,++y)c[l[y]]=a;else for(x=0;x<m;++x,++y)c[l[y]]=r[x](b)}):(l||S("Missing output field names."),f=function(c){for(var p=0,y;p<o;++p)y=n.get(i[p](c)),c[l[p]]=y??a}),s?d=t.reflow(!0):(g=i.some(c=>t.modified(c.fields)),u|=g?t.MOD:0),t.visit(u,f),d.modifies(l)}});function Ve(e){_.call(this,null,oi,e)}v(Ve,_);function oi(e){if(this.value&&!e.modified())return this.value;const t=e.extents,i=t.length;let n=Infinity,r=-Infinity,a,s;for(a=0;a<i;++a)s=t[a],s[0]<n&&(n=s[0]),s[1]>r&&(r=s[1]);return[n,r]}function We(e){_.call(this,null,ui,e)}v(We,_);function ui(e){return this.value&&!e.modified()?this.value:e.values.reduce((t,i)=>t.concat(i),[])}function Ke(e){h.call(this,null,e)}v(Ke,h,{transform(e,t){return this.modified(e.modified()),this.value=e,t.fork(t.NO_SOURCE|t.NO_FIELDS)}});function ce(e){w.call(this,e)}ce.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:I,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]},v(ce,w,{_transform:w.prototype.transform,transform(e,t){return this._transform(li(e,t),t)}});function li(e,t){const i=e.field,n=e.value,r=(e.op==="count"?"__count__":e.op)||"sum",a=C(i).concat(C(n)),s=fi(i,e.limit||0,t);return t.changed()&&e.set("__pivot__",null,null,!0),{key:e.key,groupby:e.groupby,ops:s.map(()=>r),fields:s.map(o=>di(o,i,n,a)),as:s.map(o=>o+""),modified:e.modified.bind(e)}}function di(e,t,i,n){return $(r=>t(r)===e?i(r):NaN,n,e+"")}function fi(e,t,i){const n={},r=[];return i.visit(i.SOURCE,a=>{const s=e(a);n[s]||(n[s]=1,r.push(s))}),r.sort(ot),t?r.slice(0,t):r}function Qe(e){P.call(this,e)}v(Qe,P,{transform(e,t){const i=e.subflow,n=e.field,r=a=>this.subflow(D(a),i,t,a);return(e.modified("field")||n&&t.modified(C(n)))&&S("PreFacet does not support field modification."),this.initTargets(),n?(t.visit(t.MOD,a=>{const s=r(a);n(a).forEach(o=>s.mod(o))}),t.visit(t.ADD,a=>{const s=r(a);n(a).forEach(o=>s.add(N(o)))}),t.visit(t.REM,a=>{const s=r(a);n(a).forEach(o=>s.rem(o))})):(t.visit(t.MOD,a=>r(a).mod(a)),t.visit(t.ADD,a=>r(a).add(a)),t.visit(t.REM,a=>r(a).rem(a))),t.clean()&&t.runAfter(()=>this.clean()),t}});function he(e){h.call(this,null,e)}he.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},v(he,h,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.fields,r=Fe(e.fields,e.as||[]),a=n?(o,u)=>mi(o,u,n,r):ct;let s;return this.value?s=this.value:(t=t.addAll(),s=this.value={}),t.visit(t.REM,o=>{const u=D(o);i.rem.push(s[u]),s[u]=null}),t.visit(t.ADD,o=>{const u=a(o,N({}));s[D(o)]=u,i.add.push(u)}),t.visit(t.MOD,o=>{i.mod.push(a(o,s[D(o)]))}),i}});function mi(e,t,i,n){for(let r=0,a=i.length;r<a;++r)t[n[r]]=i[r](e);return t}function Be(e){h.call(this,null,e)}v(Be,h,{transform(e,t){return this.value=e.value,e.modified("value")?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});function pe(e){h.call(this,null,e)}pe.Definition={type:"Quantile",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"probs",type:"number",array:!0},{name:"step",type:"number",default:.01},{name:"as",type:"string",array:!0,default:["prob","value"]}]};const ci=1e-14;v(pe,h,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS),n=e.as||["prob","value"];if(this.value&&!e.modified()&&!t.changed())return i.source=this.value,i;const r=t.materialize(t.SOURCE).source,a=ee(r,e.groupby,e.field),s=(e.groupby||[]).map(q),o=[],u=e.step||.01,d=e.probs||qe(u/2,1-ci,u),l=d.length;return a.forEach(f=>{const m=gt(f,d);for(let g=0;g<l;++g){const c={};for(let p=0;p<s.length;++p)c[s[p]]=f.dims[p];c[n[0]]=d[g],c[n[1]]=m[g],o.push(N(c))}}),this.value&&(i.rem=this.value),this.value=i.add=i.source=o,i}});function Ge(e){h.call(this,null,e)}v(Ge,h,{transform(e,t){let i,n;return this.value?n=this.value:(i=t=t.addAll(),n=this.value={}),e.derive&&(i=t.fork(t.NO_SOURCE),t.visit(t.REM,r=>{const a=D(r);i.rem.push(n[a]),n[a]=null}),t.visit(t.ADD,r=>{const a=K(r);n[D(r)]=a,i.add.push(a)}),t.visit(t.MOD,r=>{const a=n[D(r)];for(const s in r)a[s]=r[s],i.modifies(s);i.mod.push(a)})),i}});function ge(e){h.call(this,[],e),this.count=0}ge.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]},v(ge,h,{transform(e,t){const i=t.fork(t.NO_SOURCE),n=e.modified("size"),r=e.size,a=this.value.reduce((l,f)=>(l[D(f)]=1,l),{});let s=this.value,o=this.count,u=0;function d(l){let f,m;s.length<r?s.push(l):(m=~~((o+1)*xt()),m<s.length&&m>=u&&(f=s[m],a[D(f)]&&i.rem.push(f),s[m]=l)),++o}if(t.rem.length&&(t.visit(t.REM,l=>{const f=D(l);a[f]&&(a[f]=-1,i.rem.push(l)),--o}),s=s.filter(l=>a[D(l)]!==-1)),(t.rem.length||n)&&s.length<r&&t.source&&(u=o=s.length,t.visit(t.SOURCE,l=>{a[D(l)]||d(l)}),u=-1),n&&s.length>r){const l=s.length-r;for(let f=0;f<l;++f)a[D(s[f])]=-1,i.rem.push(s[f]);s=s.slice(l)}return t.mod.length&&t.visit(t.MOD,l=>{a[D(l)]&&i.mod.push(l)}),t.add.length&&t.visit(t.ADD,d),(t.add.length||u<0)&&(i.add=s.filter(l=>!a[D(l)])),this.count=o,this.value=i.source=s,i}});function ve(e){h.call(this,null,e)}ve.Definition={type:"Sequence",metadata:{generates:!0,changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]},v(ve,h,{transform(e,t){if(this.value&&!e.modified())return;const i=t.materialize().fork(t.MOD),n=e.as||"data";return i.rem=this.value?t.rem.concat(this.value):t.rem,this.value=qe(e.start,e.stop,e.step||1).map(r=>{const a={};return a[n]=r,N(a)}),i.add=t.add.concat(this.value),i}});function Je(e){h.call(this,null,e),this.modified(!0)}v(Je,h,{transform(e,t){return this.value=t.source,t.changed()?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});function ye(e){h.call(this,null,e)}const Ye=["unit0","unit1"];ye.Definition={type:"TimeUnit",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"units",type:"enum",values:Mt,array:!0},{name:"step",type:"number",default:1},{name:"maxbins",type:"number",default:40},{name:"extent",type:"date",array:!0},{name:"timezone",type:"enum",default:"local",values:["local","utc"]},{name:"as",type:"string",array:!0,length:2,default:Ye}]},v(ye,h,{transform(e,t){const i=e.field,n=e.interval!==!1,r=e.timezone==="utc",a=this._floor(e,t),s=(r?Rt:Ct)(a.unit).offset,o=e.as||Ye,u=o[0],d=o[1],l=a.step;let f=a.start||Infinity,m=a.stop||-Infinity,g=t.ADD;return(e.modified()||t.changed(t.REM)||t.modified(C(i)))&&(t=t.reflow(!0),g=t.SOURCE,f=Infinity,m=-Infinity),t.visit(g,c=>{const p=i(c);let y,x;p==null?(c[u]=null,n&&(c[d]=null)):(c[u]=y=x=a(p),n&&(c[d]=x=s(y,l)),y<f&&(f=y),x>m&&(m=x))}),a.start=f,a.stop=m,t.modifies(n?o:u)},_floor(e,t){const i=e.timezone==="utc",{units:n,step:r}=e.units?{units:e.units,step:e.step||1}:wt({extent:e.extent||U(t.materialize(t.SOURCE).source,e.field),maxbins:e.maxbins}),a=Ut(n),s=this.value||{},o=(i?At:It)(a,r);return o.unit=ut(a),o.units=a,o.step=r,o.start=s.start,o.stop=s.stop,this.value=o}});function Ze(e){h.call(this,V(),e)}v(Ze,h,{transform(e,t){const i=t.dataflow,n=e.field,r=this.value,a=o=>r.set(n(o),o);let s=!0;return e.modified("field")||t.modified(n.fields)?(r.clear(),t.visit(t.SOURCE,a)):t.changed()?(t.visit(t.REM,o=>r.delete(n(o))),t.visit(t.ADD,a)):s=!1,this.modified(s),r.empty>i.cleanThreshold&&i.runAfter(r.clean),t.fork()}});function He(e){h.call(this,null,e)}v(He,h,{transform(e,t){const i=!this.value||e.modified("field")||e.modified("sort")||t.changed()||e.sort&&t.modified(e.sort.fields);i&&(this.value=(e.sort?t.source.slice().sort(L(e.sort)):t.source).map(e.field))}});function hi(e,t,i,n){const r=F[e](t,i);return{init:r.init||ft,update:function(a,s){s[n]=r.next(a)}}}const F={row_number:function(){return{next:e=>e.index+1}},rank:function(){let e;return{init:()=>e=1,next:t=>{const i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?e=i+1:e}}},dense_rank:function(){let e;return{init:()=>e=1,next:t=>{const i=t.index,n=t.data;return i&&t.compare(n[i-1],n[i])?++e:e}}},percent_rank:function(){const e=F.rank(),t=e.next;return{init:e.init,next:i=>(t(i)-1)/(i.data.length-1)}},cume_dist:function(){let e;return{init:()=>e=0,next:t=>{const i=t.data,n=t.compare;let r=t.index;if(e<r){for(;r+1<i.length&&!n(i[r],i[r+1]);)++r;e=r}return(1+e)/i.length}}},ntile:function(e,t){t=+t,t>0||S("ntile num must be greater than zero.");const i=F.cume_dist(),n=i.next;return{init:i.init,next:r=>Math.ceil(t*n(r))}},lag:function(e,t){return t=+t||1,{next:i=>{const n=i.index-t;return n>=0?e(i.data[n]):null}}},lead:function(e,t){return t=+t||1,{next:i=>{const n=i.index+t,r=i.data;return n<r.length?e(r[n]):null}}},first_value:function(e){return{next:t=>e(t.data[t.i0])}},last_value:function(e){return{next:t=>e(t.data[t.i1-1])}},nth_value:function(e,t){return t=+t,t>0||S("nth_value nth must be greater than zero."),{next:i=>{const n=i.i0+(t-1);return n<i.i1?e(i.data[n]):null}}},prev_value:function(e){let t;return{init:()=>t=null,next:i=>{const n=e(i.data[i.index]);return n!=null?t=n:t}}},next_value:function(e){let t,i;return{init:()=>(t=null,i=-1),next:n=>{const r=n.data;return n.index<=i?t:(i=pi(e,r,n.index))<0?(i=r.length,t=null):t=e(r[i])}}}};function pi(e,t,i){for(let n=t.length;i<n;++i){const r=e(t[i]);if(r!=null)return i}return-1}const gi=Object.keys(F);function Xe(e){const t=M(e.ops),i=M(e.fields),n=M(e.params),r=M(e.aggregate_params),a=M(e.as),s=this.outputs=[],o=this.windows=[],u={},d={},l=[],f=[];let m=!0;function g(c){M(C(c)).forEach(p=>u[p]=1)}g(e.sort),t.forEach((c,p)=>{const y=i[p],x=n[p],b=r[p]||null,O=q(y),R=Se(c,O,a[p]);if(g(y),s.push(R),z(F,c))o.push(hi(c,y,x,R));else{if(y==null&&c!=="count"&&S("Null aggregate field specified."),c==="count"){l.push(R);return}m=!1;let k=d[O];k||(k=d[O]=[],k.field=y,f.push(k)),k.push(_e(c,b,R))}}),(l.length||f.length)&&(this.cell=vi(f,l,m)),this.inputs=Object.keys(u)}const et=Xe.prototype;et.init=function(){this.windows.forEach(e=>e.init()),this.cell&&this.cell.init()},et.update=function(e,t){const i=this.cell,n=this.windows,r=e.data,a=n&&n.length;let s;if(i){for(s=e.p0;s<e.i0;++s)i.rem(r[s]);for(s=e.p1;s<e.i1;++s)i.add(r[s]);i.set(t)}for(s=0;s<a;++s)n[s].update(e,t)};function vi(e,t,i){e=e.map(u=>Me(u,u.field));const n={num:0,agg:null,store:!1,count:t};if(!i)for(var r=e.length,a=n.agg=Array(r),s=0;s<r;++s)a[s]=new e[s](n);if(n.store)var o=n.data=new G;return n.add=function(u){if(n.num+=1,i)return;o&&o.add(u);for(let d=0;d<r;++d)a[d].add(a[d].get(u),u)},n.rem=function(u){if(n.num-=1,i)return;o&&o.rem(u);for(let d=0;d<r;++d)a[d].rem(a[d].get(u),u)},n.set=function(u){let d,l;for(o&&o.values(),d=0,l=t.length;d<l;++d)u[t[d]]=n.num;if(!i)for(d=0,l=a.length;d<l;++d)a[d].set(u)},n.init=function(){n.num=0,o&&o.reset();for(let u=0;u<r;++u)a[u].init()},n}function xe(e){h.call(this,{},e),this._mlen=0,this._mods=[]}xe.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:gi.concat(I)},{name:"params",type:"number",null:!0,array:!0},{name:"aggregate_params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]},v(xe,h,{transform(e,t){this.stamp=t.stamp;const i=e.modified(),n=L(e.sort),r=Q(e.groupby),a=o=>this.group(r(o));let s=this.state;(!s||i)&&(s=this.state=new Xe(e)),i||t.modified(s.inputs)?(this.value={},t.visit(t.SOURCE,o=>a(o).add(o))):(t.visit(t.REM,o=>a(o).remove(o)),t.visit(t.ADD,o=>a(o).add(o)));for(let o=0,u=this._mlen;o<u;++o)yi(this._mods[o],s,n,e);return this._mlen=0,this._mods=[],t.reflow(i).modifies(s.outputs)},group(e){let t=this.value[e];return t||(t=this.value[e]=Re(D),t.stamp=-1),t.stamp<this.stamp&&(t.stamp=this.stamp,this._mods[this._mlen++]=t),t}});function yi(e,t,i,n){const r=n.sort,a=r&&!n.ignorePeers,s=n.frame||[null,0],o=e.data(i),u=o.length,d=a?kt(r):null,l={i0:0,i1:0,p0:0,p1:0,index:0,data:o,compare:r||lt(-1)};t.init();for(let f=0;f<u;++f)xi(l,s,f,u),a&&bi(l,d),t.update(l,o[f])}function xi(e,t,i,n){e.p0=e.i0,e.p1=e.i1,e.i0=t[0]==null?0:Math.max(0,i-Math.abs(t[0])),e.i1=t[1]==null?n:Math.min(n,i+Math.abs(t[1])+1),e.index=i}function bi(e,t){const i=e.i0,n=e.i1-1,r=e.compare,a=e.data,s=a.length-1;i>0&&!r(a[i],a[i-1])&&(e.i0=t.left(a,a[i])),n<s&&!r(a[n],a[n+1])&&(e.i1=t.right(a,a[n]))}export{w as aggregate,J as bin,Y as collect,Ce as compare,Z as countpattern,H as cross,X as density,te as dotbin,Le as expression,ie as extent,P as facet,Pe as field,ae as filter,re as flatten,se as fold,oe as formula,Te as generate,ue as impute,le as joinaggregate,de as kde,je as key,$e as load,me as lookup,Ve as multiextent,We as multivalues,Ke as params,ce as pivot,Qe as prefacet,he as project,Be as proxy,pe as quantile,Ge as relay,ge as sample,ve as sequence,Je as sieve,ne as subflow,ye as timeunit,Ze as tupleindex,He as values,xe as window};export default null;
