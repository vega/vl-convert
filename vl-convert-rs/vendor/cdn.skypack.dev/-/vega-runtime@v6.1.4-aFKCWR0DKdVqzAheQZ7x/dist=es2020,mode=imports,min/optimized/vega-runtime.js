import{toSet as h,stringValue as p,error as d,isArray as w,isObject as m,hasOwnProperty as E,truthy as O,accessor as g,key as S,field as j,array as P,compare as C}from"/-/vega-util@v1.17.2-LUfkDhormMyfWqy3Ts6U/dist=es2020,mode=imports,min/optimized/vega-util.js";import{tupleid as $}from"/-/vega-dataflow@v5.7.5-asKYS4gpPLMPf64pSozt/dist=es2020,mode=imports,min/optimized/vega-dataflow.js";function F(t){const e=this,r=t.operators||[];return t.background&&(e.background=t.background),t.eventConfig&&(e.eventConfig=t.eventConfig),t.locale&&(e.locale=t.locale),r.forEach(n=>e.parseOperator(n)),r.forEach(n=>e.parseOperatorParameters(n)),(t.streams||[]).forEach(n=>e.parseStream(n)),(t.updates||[]).forEach(n=>e.parseUpdate(n)),e.resolve()}const I=h(["rule"]),v=h(["group","image","rect"]);function q(t,e){let r="";return I[e]||(t.x2&&(t.x?(v[e]&&(r+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),r+="o.width=o.x2-o.x;"):r+="o.x=o.x2-(o.width||0);"),t.xc&&(r+="o.x=o.xc-(o.width||0)/2;"),t.y2&&(t.y?(v[e]&&(r+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),r+="o.height=o.y2-o.y;"):r+="o.y=o.y2-(o.height||0);"),t.yc&&(r+="o.y=o.yc-(o.height||0)/2;")),r}function c(t){return(t+"").toLowerCase()}function z(t){return c(t)==="operator"}function D(t){return c(t)==="collect"}function f(t,e,r){r.endsWith(";")||(r="return("+r+");");const n=Function(...e.concat(r));return t&&t.functions?n.bind(t.functions):n}function K(t,e,r,n){return`((u = ${t}) < (v = ${e}) || u == null) && v != null ? ${r}
  : (u > v || v == null) && u != null ? ${n}
  : ((v = v instanceof Date ? +v : v), (u = u instanceof Date ? +u : u)) !== u && v === v ? ${r}
  : v !== v && u === u ? ${n} : `}var L={operator:(t,e)=>f(t,["_"],e.code),parameter:(t,e)=>f(t,["datum","_"],e.code),event:(t,e)=>f(t,["event"],e.code),handler:(t,e)=>{const r=`var datum=event.item&&event.item.datum;return ${e.code};`;return f(t,["_","event"],r)},encode:(t,e)=>{const{marktype:r,channels:n}=e;let o="var o=item,datum=o.datum,m=0,$;";for(const a in n){const i="o["+p(a)+"]";o+=`$=${n[a].code};if(${i}!==$)${i}=$,m=1;`}return o+=q(n,r),o+="return m;",f(t,["item","_"],o)},codegen:{get(t){const e=`[${t.map(p).join("][")}]`,r=Function("_",`return _${e};`);return r.path=e,r},comparator(t,e){let r;const n=(a,i)=>{const s=e[i];let u,l;return a.path?(u=`a${a.path}`,l=`b${a.path}`):((r=r||{})["f"+i]=a,u=`this.f${i}(a)`,l=`this.f${i}(b)`),K(u,l,-s,s)},o=Function("a","b","var u, v; return "+t.map(n).join("")+"0;");return r?o.bind(r):o}}};function R(t){const e=this;z(t.type)||!t.type?e.operator(t,t.update?e.operatorExpression(t.update):null):e.transform(t,t.type)}function A(t){const e=this;if(t.params){const r=e.get(t.id);r||d("Invalid operator id: "+t.id),e.dataflow.connect(r,r.parameters(e.parseParameters(t.params),t.react,t.initonly))}}function T(t,e){e=e||{};const r=this;for(const n in t){const o=t[n];e[n]=w(o)?o.map(a=>x(a,r,e)):x(o,r,e)}return e}function x(t,e,r){if(!t||!m(t))return t;for(let n=0,o=y.length,a;n<o;++n)if(a=y[n],E(t,a.key))return a.parse(t,e,r);return t}var y=[{key:"$ref",parse:U},{key:"$key",parse:Y},{key:"$expr",parse:X},{key:"$field",parse:B},{key:"$encode",parse:M},{key:"$compare",parse:J},{key:"$context",parse:N},{key:"$subflow",parse:V},{key:"$tupleid",parse:W}];function U(t,e){return e.get(t.$ref)||d("Operator not defined: "+t.$ref)}function X(t,e,r){t.$params&&e.parseParameters(t.$params,r);const n="e:"+t.$expr.code;return e.fn[n]||(e.fn[n]=g(e.parameterExpression(t.$expr),t.$fields))}function Y(t,e){const r="k:"+t.$key+"_"+!!t.$flat;return e.fn[r]||(e.fn[r]=S(t.$key,t.$flat,e.expr.codegen))}function B(t,e){if(!t.$field)return null;const r="f:"+t.$field+"_"+t.$name;return e.fn[r]||(e.fn[r]=j(t.$field,t.$name,e.expr.codegen))}function J(t,e){const r="c:"+t.$compare+"_"+t.$order,n=P(t.$compare).map(o=>o&&o.$tupleid?$:o);return e.fn[r]||(e.fn[r]=C(n,t.$order,e.expr.codegen))}function M(t,e){const r=t.$encode,n={};for(const o in r){const a=r[o];n[o]=g(e.encodeExpression(a.$expr),a.$fields),n[o].output=a.$output}return n}function N(t,e){return e}function V(t,e){const r=t.$subflow;return function(n,o,a){const i=e.fork().parse(r),s=i.get(r.operators[0].id),u=i.signals.parent;return u&&u.set(a),s.detachSubflow=()=>e.detach(i),s}}function W(){return $}function Z(t){var e=this,r=t.filter!=null?e.eventExpression(t.filter):void 0,n=t.stream!=null?e.get(t.stream):void 0,o;t.source?n=e.events(t.source,t.type,r):t.merge&&(o=t.merge.map(a=>e.get(a)),n=o[0].merge.apply(o[0],o.slice(1))),t.between&&(o=t.between.map(a=>e.get(a)),n=n.between(o[0],o[1])),t.filter&&(n=n.filter(r)),t.throttle!=null&&(n=n.throttle(+t.throttle)),t.debounce!=null&&(n=n.debounce(+t.debounce)),n==null&&d("Invalid stream definition: "+JSON.stringify(t)),t.consume&&n.consume(!0),e.stream(t,n)}function G(t){var e=this,r=m(r=t.source)?r.$ref:r,n=e.get(r),o=null,a=t.update,i=void 0;n||d("Source not defined: "+t.source),o=t.target&&t.target.$expr?e.eventExpression(t.target.$expr):e.get(t.target),a&&a.$expr&&(a.$params&&(i=e.parseParameters(a.$params)),a=e.handlerExpression(a.$expr)),e.update(t,n,o,a,i)}const H={skip:!0};function Q(t){var e=this,r={};if(t.signals){var n=r.signals={};Object.keys(e.signals).forEach(a=>{const i=e.signals[a];t.signals(a,i)&&(n[a]=i.value)})}if(t.data){var o=r.data={};Object.keys(e.data).forEach(a=>{const i=e.data[a];t.data(a,i)&&(o[a]=i.input.value)})}return e.subcontext&&t.recurse!==!1&&(r.subcontext=e.subcontext.map(a=>a.getState(t))),r}function _(t){var e=this,r=e.dataflow,n=t.data,o=t.signals;Object.keys(o||{}).forEach(a=>{r.update(e.signals[a],o[a],H)}),Object.keys(n||{}).forEach(a=>{r.pulse(e.data[a].input,r.changeset().remove(O).insert(n[a]))}),(t.subcontext||[]).forEach((a,i)=>{const s=e.subcontext[i];s&&s.setState(a)})}function tt(t,e,r,n){return new b(t,e,r,n)}function b(t,e,r,n){this.dataflow=t,this.transforms=e,this.events=t.events.bind(t),this.expr=n||L,this.signals={},this.scales={},this.nodes={},this.data={},this.fn={},r&&(this.functions=Object.create(r),this.functions.context=this)}function k(t){this.dataflow=t.dataflow,this.transforms=t.transforms,this.events=t.events,this.expr=t.expr,this.signals=Object.create(t.signals),this.scales=Object.create(t.scales),this.nodes=Object.create(t.nodes),this.data=Object.create(t.data),this.fn=Object.create(t.fn),t.functions&&(this.functions=Object.create(t.functions),this.functions.context=this)}b.prototype=k.prototype={fork(){const t=new k(this);return(this.subcontext||(this.subcontext=[])).push(t),t},detach(t){this.subcontext=this.subcontext.filter(r=>r!==t);const e=Object.keys(t.nodes);for(const r of e)t.nodes[r]._targets=null;for(const r of e)t.nodes[r].detach();t.nodes=null},get(t){return this.nodes[t]},set(t,e){return this.nodes[t]=e},add(t,e){const r=this,n=r.dataflow,o=t.value;if(r.set(t.id,e),D(t.type)&&o&&(o.$ingest?n.ingest(e,o.$ingest,o.$format):o.$request?n.preload(e,o.$request,o.$format):n.pulse(e,n.changeset().insert(o))),t.root&&(r.root=e),t.parent){let a=r.get(t.parent.$ref);a?(n.connect(a,[e]),e.targets().add(a)):(r.unresolved=r.unresolved||[]).push(()=>{a=r.get(t.parent.$ref),n.connect(a,[e]),e.targets().add(a)})}if(t.signal&&(r.signals[t.signal]=e),t.scale&&(r.scales[t.scale]=e),t.data)for(const a in t.data){const i=r.data[a]||(r.data[a]={});t.data[a].forEach(s=>i[s]=e)}},resolve(){return(this.unresolved||[]).forEach(t=>t()),delete this.unresolved,this},operator(t,e){this.add(t,this.dataflow.add(t.value,e))},transform(t,e){this.add(t,this.dataflow.add(this.transforms[c(e)]))},stream(t,e){this.set(t.id,e)},update(t,e,r,n,o){this.dataflow.on(e,r,n,o,t.options)},operatorExpression(t){return this.expr.operator(this,t)},parameterExpression(t){return this.expr.parameter(this,t)},eventExpression(t){return this.expr.event(this,t)},handlerExpression(t){return this.expr.handler(this,t)},encodeExpression(t){return this.expr.encode(this,t)},parse:F,parseOperator:R,parseOperatorParameters:A,parseParameters:T,parseStream:Z,parseUpdate:G,getState:Q,setState:_};export{tt as context};export default null;
