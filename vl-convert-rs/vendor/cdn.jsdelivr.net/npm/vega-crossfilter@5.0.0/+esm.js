/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/vega-crossfilter@5.0.0/build/vega-crossfilter.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{bisectLeft as e,bisectRight as t,permute as r}from"/npm/d3-array@3.2.4/+esm";import{Transform as i}from"/npm/vega-dataflow@6.0.0/+esm";import{inherits as n}from"/npm/vega-util@2.0.0/+esm";const s=e=>new Uint8Array(e),o=e=>new Uint16Array(e),l=e=>new Uint32Array(e);function a(e,t,r){const i=(t<257?s:t<65537?o:l)(e);return r&&i.set(r),i}function d(e,t,r){const i=1<<t;return{one:i,zero:~i,range:r.slice(),bisect:e.bisect,index:e.index,size:e.size,onAdd(e,t){const r=this,n=r.bisect(r.range,e.value),s=e.index,o=n[0],l=n[1],a=s.length;let d;for(d=0;d<o;++d)t[s[d]]|=i;for(d=l;d<a;++d)t[s[d]]|=i;return r}}}function f(){let i=l(0),n=[],s=0;return{insert:function(e,t,o){if(!t.length)return[];const a=s,d=t.length,f=l(d);let u,h,m,c=Array(d);for(m=0;m<d;++m)c[m]=e(t[m]),f[m]=m;if(c=function(e,t){return e.sort.call(t,((t,r)=>{const i=e[t],n=e[r];return i<n?-1:i>n?1:0})),r(e,t)}(c,f),a)u=n,h=i,n=Array(a+d),i=l(a+d),function(e,t,r,i,n,s,o,l,a){let d,f=0,u=0;for(d=0;f<i&&u<o;++d)t[f]<n[u]?(l[d]=t[f],a[d]=r[f++]):(l[d]=n[u],a[d]=s[u++]+e);for(;f<i;++f,++d)l[d]=t[f],a[d]=r[f];for(;u<o;++u,++d)l[d]=n[u],a[d]=s[u]+e}(o,u,h,a,c,f,d,n,i);else{if(o>0)for(m=0;m<d;++m)f[m]+=o;n=c,i=f}return s=a+d,{index:f,value:c}},remove:function(e,t){const r=s;let o,l,a;for(l=0;!t[i[l]]&&l<r;++l);for(a=l;l<r;++l)t[o=i[l]]||(i[a]=o,n[a]=n[l],++a);s=r-e},bisect:function(r,i){let o;return i?o=i.length:(i=n,o=s),[e(i,r[0],0,o),t(i,r[1],0,o)]},reindex:function(e){for(let t=0,r=s;t<r;++t)i[t]=e[i[t]]},index:()=>i,size:()=>s}}function u(e){i.call(this,function(){let e=8,t=[],r=l(0),i=a(0,e),n=a(0,e);return{data:()=>t,seen:()=>r=function(e,t,r){return e.length>=t?e:((r=r||new e.constructor(t)).set(e),r)}(r,t.length),add(e){for(let r,i=0,n=t.length,s=e.length;i<s;++i)r=e[i],r._index=n++,t.push(r)},remove(e,r){const s=t.length,o=Array(s-e),l=t;let a,d,f;for(d=0;!r[d]&&d<s;++d)o[d]=t[d],l[d]=d;for(f=d;d<s;++d)a=t[d],r[d]?l[d]=-1:(l[d]=f,i[f]=i[d],n[f]=n[d],o[f]=a,a._index=f++),i[d]=0;return t=o,l},size:()=>t.length,curr:()=>i,prev:()=>n,reset:e=>n[e]=i[e],all:()=>e<257?255:e<65537?65535:4294967295,set(e,t){i[e]|=t},clear(e,t){i[e]&=~t},resize(t,r){(t>i.length||r>e)&&(e=Math.max(r,e),i=a(t,e,i),n=a(t,e))}}}(),e),this._indices=null,this._dims=null}function h(e){i.call(this,null,e)}u.Definition={type:"CrossFilter",metadata:{},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"query",type:"array",array:!0,required:!0,content:{type:"number",array:!0,length:2}}]},n(u,i,{transform(e,t){return this._dims?e.modified("fields")||e.fields.some((e=>t.modified(e.fields)))?this.reinit(e,t):this.eval(e,t):this.init(e,t)},init(e,t){const r=e.fields,i=e.query,n=this._indices={},s=this._dims=[],o=i.length;let l,a,u=0;for(;u<o;++u)l=r[u].fname,a=n[l]||(n[l]=f()),s.push(d(a,u,i[u]));return this.eval(e,t)},reinit(e,t){const r=t.materialize().fork(),i=e.fields,n=e.query,s=this._indices,o=this._dims,l=this.value,a=l.curr(),u=l.prev(),h=l.all(),m=r.rem=r.add,c=r.mod,p=n.length,g={};let v,y,x,_,A,b,M,q,z;if(u.set(a),t.rem.length&&(A=this.remove(e,t,r)),t.add.length&&l.add(t.add),t.mod.length)for(b={},_=t.mod,M=0,q=_.length;M<q;++M)b[_[M]._index]=1;for(M=0;M<p;++M)z=i[M],(!o[M]||e.modified("fields",M)||t.modified(z.fields))&&(x=z.fname,(v=g[x])||(s[x]=y=f(),g[x]=v=y.insert(z,t.source,0)),o[M]=d(y,M,n[M]).onAdd(v,a));for(M=0,q=l.data().length;M<q;++M)A[M]||(u[M]!==a[M]?m.push(M):b[M]&&a[M]!==h&&c.push(M));return l.mask=(1<<p)-1,r},eval(e,t){const r=t.materialize().fork(),i=this._dims.length;let n=0;return t.rem.length&&(this.remove(e,t,r),n|=(1<<i)-1),e.modified("query")&&!e.modified("fields")&&(n|=this.update(e,t,r)),t.add.length&&(this.insert(e,t,r),n|=(1<<i)-1),t.mod.length&&(this.modify(t,r),n|=(1<<i)-1),this.value.mask=n,r},insert(e,t,r){const i=t.add,n=this.value,s=this._dims,o=this._indices,l=e.fields,a={},d=r.add,f=n.size()+i.length,u=s.length;let h,m,c,p=n.size();n.resize(f,u),n.add(i);const g=n.curr(),v=n.prev(),y=n.all();for(h=0;h<u;++h)m=l[h].fname,c=a[m]||(a[m]=o[m].insert(l[h],i,p)),s[h].onAdd(c,g);for(;p<f;++p)v[p]=y,g[p]!==y&&d.push(p)},modify(e,t){const r=t.mod,i=this.value,n=i.curr(),s=i.all(),o=e.mod;let l,a,d;for(l=0,a=o.length;l<a;++l)d=o[l]._index,n[d]!==s&&r.push(d)},remove(e,t,r){const i=this._indices,n=this.value,s=n.curr(),o=n.prev(),l=n.all(),a={},d=r.rem,f=t.rem;let u,h,m,c;for(u=0,h=f.length;u<h;++u)m=f[u]._index,a[m]=1,o[m]=c=s[m],s[m]=l,c!==l&&d.push(m);for(m in i)i[m].remove(h,a);return this.reindex(t,h,a),a},reindex(e,t,r){const i=this._indices,n=this.value;e.runAfter((()=>{const e=n.remove(t,r);for(const t in i)i[t].reindex(e)}))},update(e,t,r){const i=this._dims,n=e.query,s=t.stamp,o=i.length;let l,a,d=0;for(r.filters=0,a=0;a<o;++a)e.modified("query",a)&&(l=a,++d);if(1===d)d=i[l].one,this.incrementOne(i[l],n[l],r.add,r.rem);else for(a=0,d=0;a<o;++a)e.modified("query",a)&&(d|=i[a].one,this.incrementAll(i[a],n[a],s,r.add),r.rem=r.add);return d},incrementAll(e,t,r,i){const n=this.value,s=n.seen(),o=n.curr(),l=n.prev(),a=e.index(),d=e.bisect(e.range),f=e.bisect(t),u=f[0],h=f[1],m=d[0],c=d[1],p=e.one;let g,v,y;if(u<m)for(g=u,v=Math.min(m,h);g<v;++g)y=a[g],s[y]!==r&&(l[y]=o[y],s[y]=r,i.push(y)),o[y]^=p;else if(u>m)for(g=m,v=Math.min(u,c);g<v;++g)y=a[g],s[y]!==r&&(l[y]=o[y],s[y]=r,i.push(y)),o[y]^=p;if(h>c)for(g=Math.max(u,c),v=h;g<v;++g)y=a[g],s[y]!==r&&(l[y]=o[y],s[y]=r,i.push(y)),o[y]^=p;else if(h<c)for(g=Math.max(m,h),v=c;g<v;++g)y=a[g],s[y]!==r&&(l[y]=o[y],s[y]=r,i.push(y)),o[y]^=p;e.range=t.slice()},incrementOne(e,t,r,i){const n=this.value.curr(),s=e.index(),o=e.bisect(e.range),l=e.bisect(t),a=l[0],d=l[1],f=o[0],u=o[1],h=e.one;let m,c,p;if(a<f)for(m=a,c=Math.min(f,d);m<c;++m)p=s[m],n[p]^=h,r.push(p);else if(a>f)for(m=f,c=Math.min(a,u);m<c;++m)p=s[m],n[p]^=h,i.push(p);if(d>u)for(m=Math.max(a,u),c=d;m<c;++m)p=s[m],n[p]^=h,r.push(p);else if(d<u)for(m=Math.max(f,d),c=u;m<c;++m)p=s[m],n[p]^=h,i.push(p);e.range=t.slice()}}),h.Definition={type:"ResolveFilter",metadata:{},params:[{name:"ignore",type:"number",required:!0,description:"A bit mask indicating which filters to ignore."},{name:"filter",type:"object",required:!0,description:"Per-tuple filter bitmaps from a CrossFilter transform."}]},n(h,i,{transform(e,t){const r=~(e.ignore||0),i=e.filter,n=i.mask;if(!(n&r))return t.StopPropagation;const s=t.fork(t.ALL),o=i.data(),l=i.curr(),a=i.prev(),d=e=>l[e]&r?null:o[e];return s.filter(s.MOD,d),n&n-1?(s.filter(s.ADD,(e=>{const t=l[e]&r;return!t&&t^a[e]&r?o[e]:null})),s.filter(s.REM,(e=>{const t=l[e]&r;return t&&!(0^a[e]&r)?o[e]:null}))):(s.filter(s.ADD,d),s.filter(s.REM,(e=>(l[e]&r)===n?o[e]:null))),s.filter(s.SOURCE,(e=>d(e._index)))}});export{u as crossfilter,h as resolvefilter};export default null;
//# sourceMappingURL=/sm/0165c371eb5cc437c6d71e4168de44bddbb6e59ae6e4824ce3cfc77f948cba4d.map