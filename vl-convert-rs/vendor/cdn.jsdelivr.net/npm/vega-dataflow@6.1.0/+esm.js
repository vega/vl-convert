/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/vega-dataflow@6.1.0/build/vega-dataflow.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{isArray as t,visitArray as e,inherits as n,error as s,array as r,isFunction as i,constant as o,truthy as l,identity as u,debounce as a,logger as h,Error as c,hasOwnProperty as d,id as f,extend as p}from"/npm/vega-util@2.1.0/+esm";import{loader as g,read as m,responseType as _}from"/npm/vega-loader@5.1.0/+esm";import{defaultLocale as v}from"/npm/vega-format@2.1.0/+esm";function k(t){const e=t||u,n=[],s={};return n.add=t=>{const r=e(t);return s[r]||(s[r]=1,n.push(t)),n},n.remove=t=>{const r=e(t);if(s[r]){s[r]=0;const e=n.indexOf(t);e>=0&&n.splice(e,1)}return n},n}async function w(t,e){try{await e(t)}catch(e){t.error(e)}}const y=Symbol("vega_id");let F=1;function D(t){return!(!t||!E(t))}function E(t){return t[y]}function A(t,e){return t[y]=e,t}function O(t){const e=t===Object(t)?t:{data:t};return E(e)?e:A(e,F++)}function P(t){return q(t,O({}))}function q(t,e){for(const n in t)e[n]=t[n];return e}function M(t,e){return A(e,E(t))}function b(t,e){return t?e?(n,s)=>t(n,s)||E(e(n))-E(e(s)):(e,n)=>t(e,n)||E(e)-E(n):null}function S(t){return t&&t.constructor===L}function L(){const t=[],e=[],n=[],s=[],l=[];let u=null,a=!1;return{constructor:L,insert(e){const n=r(e),s=n.length;for(let e=0;e<s;++e)t.push(n[e]);return this},remove(t){const n=i(t)?s:e,o=r(t),l=o.length;for(let t=0;t<l;++t)n.push(o[t]);return this},modify(t,e,s){const r={field:e,value:o(s)};return i(t)?(r.filter=t,l.push(r)):(r.tuple=t,n.push(r)),this},encode(t,e){return i(t)?l.push({filter:t,field:e}):n.push({tuple:t,field:e}),this},clean(t){return u=t,this},reflow(){return a=!0,this},pulse(r,i){const o={},h={};let c,d,f,p,g,m;for(c=0,d=i.length;c<d;++c)o[E(i[c])]=1;for(c=0,d=e.length;c<d;++c)g=e[c],o[E(g)]=-1;for(c=0,d=s.length;c<d;++c)p=s[c],i.forEach((t=>{p(t)&&(o[E(t)]=-1)}));for(c=0,d=t.length;c<d;++c)g=t[c],m=E(g),o[m]?o[m]=1:r.add.push(O(t[c]));for(c=0,d=i.length;c<d;++c)g=i[c],o[E(g)]<0&&r.rem.push(g);function _(t,e,n){n?t[e]=n(t):r.encode=e,a||(h[E(t)]=t)}for(c=0,d=n.length;c<d;++c)f=n[c],g=f.tuple,p=f.field,m=o[E(g)],m>0&&(_(g,p,f.value),r.modifies(p));for(c=0,d=l.length;c<d;++c)f=l[c],p=f.filter,i.forEach((t=>{p(t)&&o[E(t)]>0&&_(t,f.field,f.value)})),r.modifies(f.field);if(a)r.mod=e.length||s.length?i.filter((t=>o[E(t)]>0)):i.slice();else for(m in h)r.mod.push(h[m]);return(u||null==u&&(e.length||s.length))&&r.clean(!0),r}}}const R="_:mod:_";function x(){Object.defineProperty(this,R,{writable:!0,value:{}})}x.prototype={set(e,n,s,r){const i=this,o=i[e],l=i[R];return null!=n&&n>=0?(o[n]!==s||r)&&(o[n]=s,l[n+":"+e]=-1,l[e]=-1):(o!==s||r)&&(i[e]=s,l[e]=t(s)?1+s.length:-1),i},modified(e,n){const s=this[R];if(!arguments.length){for(const t in s)if(s[t])return!0;return!1}if(t(e)){for(let t=0;t<e.length;++t)if(s[e[t]])return!0;return!1}return null!=n&&n>=0?n+1<s[e]||!!s[n+":"+e]:!!s[e]},clear(){return this[R]={},this}};let z=0;const C=new x;function U(t,e,n,s){this.id=++z,this.value=t,this.stamp=-1,this.rank=-1,this.qrank=-1,this.flags=0,e&&(this._update=e),n&&this.parameters(n,s)}function N(t){return function(e){const n=this.flags;return 0===arguments.length?!!(n&t):(this.flags=e?n|t:n&~t,this)}}U.prototype={targets(){return this._targets||(this._targets=k(f))},set(t){return this.value!==t?(this.value=t,1):0},skip:N(1),modified:N(2),parameters(e,n,i){n=!1!==n;const o=this._argval=this._argval||new x,l=this._argops=this._argops||[],u=[];let a,h,c,d;const f=(t,e,s)=>{s instanceof U?(s!==this&&(n&&s.targets().add(this),u.push(s)),l.push({op:s,name:t,index:e})):o.set(t,e,s)};for(a in e)if(h=e[a],"pulse"===a)r(h).forEach((t=>{t instanceof U?t!==this&&(t.targets().add(this),u.push(t)):s("Pulse parameters must be operator instances.")})),this.source=h;else if(t(h))for(o.set(a,-1,Array(c=h.length)),d=0;d<c;++d)f(a,d,h[d]);else f(a,-1,h);return this.marshall().clear(),i&&(l.initonly=!0),u},marshall(t){const e=this._argval||C,n=this._argops;let s,r,i,o;if(n){const l=n.length;for(r=0;r<l;++r)s=n[r],i=s.op,o=i.modified()&&i.stamp===t,e.set(s.name,s.index,i.value,o);if(n.initonly){for(r=0;r<l;++r)s=n[r],s.op.targets().remove(this);this._argops=null,this._update=null}}return e},detach(){const t=this._argops;let e,n,s,r;if(t)for(e=0,n=t.length;e<n;++e)s=t[e],r=s.op,r._targets&&r._targets.remove(this);this.pulse=null,this.source=null},evaluate(t){const e=this._update;if(e){const n=this.marshall(t.stamp),s=e.call(this,n,t);if(n.clear(),s!==this.value)this.value=s;else if(!this.modified())return t.StopPropagation}},run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?(this.skip(!1),e=0):e=this.evaluate(t),this.pulse=e||t}};let j=0;function I(t,e,n){this.id=++j,this.value=null,n&&(this.receive=n),t&&(this._filter=t),e&&(this._apply=e)}function $(t,e,n){return new I(t,e,n)}I.prototype={_filter:l,_apply:u,targets(){return this._targets||(this._targets=k(f))},consume(t){return arguments.length?(this._consume=!!t,this):!!this._consume},receive(t){if(this._filter(t)){const e=this.value=this._apply(t),n=this._targets,s=n?n.length:0;for(let t=0;t<s;++t)n[t].receive(e);this._consume&&(t.preventDefault(),t.stopPropagation())}},filter(t){const e=$(t);return this.targets().add(e),e},apply(t){const e=$(null,t);return this.targets().add(e),e},merge(){const t=$();this.targets().add(t);for(let e=0,n=arguments.length;e<n;++e)arguments[e].targets().add(t);return t},throttle(t){let e=-1;return this.filter((()=>{const n=Date.now();return n-e>t?(e=n,1):0}))},debounce(t){const e=$();return this.targets().add($(null,null,a(t,(t=>{const n=t.dataflow;e.receive(t),n&&n.run&&n.run()})))),e},between(t,e){let n=!1;return t.targets().add($(null,null,(()=>n=!0))),e.targets().add($(null,null,(()=>n=!1))),this.filter((()=>n))},detach(){this._filter=l,this._targets=null}};const T={skip:!0};function W(t,e,n,s,r,l){const u=p({},l,T);let a,h;i(n)||(n=o(n)),void 0===s?a=e=>t.touch(n(e)):i(s)?(h=new U(null,s,r,!1),a=e=>{h.evaluate(e);const s=n(e),r=h.value;S(r)?t.pulse(s,r,l):t.update(s,r,u)}):a=e=>t.update(n(e),s,u),e.apply(a)}function B(t,e,n,s,r,l){if(void 0===s)e.targets().add(n);else{const u=l||{},a=new U(null,function(t,e){return e=i(e)?e:o(e),t?function(n,s){const r=e(n,s);return t.skip()||(t.skip(r!==this.value).value=r),r}:e}(n,s),r,!1);a.modified(u.force),a.rank=e.rank,e.targets().add(a),n&&(a.skip(!0),a.value=n.value,a.targets().add(n),t.connect(n,[a]))}}const G={};function H(t,e,n){this.dataflow=t,this.stamp=null==e?-1:e,this.add=[],this.rem=[],this.mod=[],this.fields=null,this.encode=n||null}function J(t,n){const s=[];return e(t,n,(t=>s.push(t))),s}function K(t,e){const n={};return t.visit(e,(t=>{n[E(t)]=1})),t=>n[E(t)]?null:t}function Q(t,e){return t?(n,s)=>t(n,s)&&e(n,s):e}function V(t,e,n,s){const r=this;let i=0;this.dataflow=t,this.stamp=e,this.fields=null,this.encode=s||null,this.pulses=n;for(const t of n)if(t.stamp===e){if(t.fields){const e=r.fields||(r.fields={});for(const n in t.fields)e[n]=1}t.changed(r.ADD)&&(i|=r.ADD),t.changed(r.REM)&&(i|=r.REM),t.changed(r.MOD)&&(i|=r.MOD)}this.changes=i}function X(t){return t.error("Dataflow already running. Use runAsync() to chain invocations."),t}H.prototype={StopPropagation:G,ADD:1,REM:2,MOD:4,ADD_REM:3,ADD_MOD:5,ALL:7,REFLOW:8,SOURCE:16,NO_SOURCE:32,NO_FIELDS:64,fork(t){return new H(this.dataflow).init(this,t)},clone(){const t=this.fork(7);return t.add=t.add.slice(),t.rem=t.rem.slice(),t.mod=t.mod.slice(),t.source&&(t.source=t.source.slice()),t.materialize(23)},addAll(){let t=this;return!t.source||t.add===t.rem||!t.rem.length&&t.source.length===t.add.length||(t=new H(this.dataflow).init(this),t.add=t.source,t.rem=[]),t},init(t,e){const n=this;return n.stamp=t.stamp,n.encode=t.encode,!t.fields||64&e||(n.fields=t.fields),1&e?(n.addF=t.addF,n.add=t.add):(n.addF=null,n.add=[]),2&e?(n.remF=t.remF,n.rem=t.rem):(n.remF=null,n.rem=[]),4&e?(n.modF=t.modF,n.mod=t.mod):(n.modF=null,n.mod=[]),32&e?(n.srcF=null,n.source=null):(n.srcF=t.srcF,n.source=t.source,t.cleans&&(n.cleans=t.cleans)),n},runAfter(t){this.dataflow.runAfter(t)},changed(t){const e=t||7;return 1&e&&this.add.length||2&e&&this.rem.length||4&e&&this.mod.length},reflow(t){if(t)return this.fork(7).reflow();const e=this.add.length,n=this.source&&this.source.length;return n&&n!==e&&(this.mod=this.source,e&&this.filter(4,K(this,1))),this},clean(t){return arguments.length?(this.cleans=!!t,this):this.cleans},modifies(e){const n=this.fields||(this.fields={});return t(e)?e.forEach((t=>n[t]=!0)):n[e]=!0,this},modified(e,n){const s=this.fields;return!(!n&&!this.mod.length||!s)&&(arguments.length?t(e)?e.some((t=>s[t])):s[e]:!!s)},filter(t,e){const n=this;return 1&t&&(n.addF=Q(n.addF,e)),2&t&&(n.remF=Q(n.remF,e)),4&t&&(n.modF=Q(n.modF,e)),16&t&&(n.srcF=Q(n.srcF,e)),n},materialize(t){const e=this;return 1&(t=t||7)&&e.addF&&(e.add=J(e.add,e.addF),e.addF=null),2&t&&e.remF&&(e.rem=J(e.rem,e.remF),e.remF=null),4&t&&e.modF&&(e.mod=J(e.mod,e.modF),e.modF=null),16&t&&e.srcF&&(e.source=e.source.filter(e.srcF),e.srcF=null),e},visit(t,n){const s=this,r=n;if(16&t)return e(s.source,s.srcF,r),s;1&t&&e(s.add,s.addF,r),2&t&&e(s.rem,s.remF,r),4&t&&e(s.mod,s.modF,r);const i=s.source;if(8&t&&i){const t=s.add.length+s.mod.length;t===i.length||e(i,t?K(s,5):s.srcF,r)}return s}},n(V,H,{fork(t){const e=new H(this.dataflow).init(this,t&this.NO_FIELDS);return void 0!==t&&(t&e.ADD&&this.visit(e.ADD,(t=>e.add.push(t))),t&e.REM&&this.visit(e.REM,(t=>e.rem.push(t))),t&e.MOD&&this.visit(e.MOD,(t=>e.mod.push(t)))),e},changed(t){return this.changes&t},modified(e){const n=this,s=n.fields;return s&&n.changes&n.MOD?t(e)?e.some((t=>s[t])):s[e]:0},filter(){s("MultiPulse does not support filtering.")},materialize(){s("MultiPulse does not support materialization.")},visit(t,e){const n=this,s=n.pulses,r=s.length;let i=0;if(t&n.SOURCE)for(;i<r;++i)s[i].visit(t,e);else for(;i<r;++i)s[i].stamp===n.stamp&&s[i].visit(t,e);return n}});const Y={skip:!1,force:!1};function Z(t){let e=[];return{clear:()=>e=[],size:()=>e.length,peek:()=>e[0],push:n=>(e.push(n),tt(e,0,e.length-1,t)),pop:()=>{const n=e.pop();let s;return e.length?(s=e[0],e[0]=n,function(t,e,n){const s=e,r=t.length,i=t[e];let o,l=1+(e<<1);for(;l<r;)o=l+1,o<r&&n(t[l],t[o])>=0&&(l=o),t[e]=t[l],l=1+((e=l)<<1);t[e]=i,tt(t,s,e,n)}(e,0,t)):s=n,s}}}function tt(t,e,n,s){let r,i;const o=t[n];for(;n>e&&(i=n-1>>1,r=t[i],s(o,r)<0);)t[n]=r,n=i;return t[n]=o}function et(){this.logger(h()),this.logLevel(c),this._clock=0,this._rank=0,this._locale=v();try{this._loader=g()}catch(t){}this._touched=k(f),this._input={},this._pulse=null,this._heap=Z(((t,e)=>t.qrank-e.qrank)),this._postrun=[]}function nt(t){return function(){return this._log[t].apply(this,arguments)}}function st(t,e){U.call(this,t,null,e)}et.prototype={stamp(){return this._clock},loader(t){return arguments.length?(this._loader=t,this):this._loader},locale(t){return arguments.length?(this._locale=t,this):this._locale},logger(t){return arguments.length?(this._log=t,this):this._log},error:nt("error"),warn:nt("warn"),info:nt("info"),debug:nt("debug"),logLevel:nt("level"),cleanThreshold:1e4,add:function(t,e,n,s){let r,o=1;return t instanceof U?r=t:t&&t.prototype instanceof U?r=new t:i(t)?r=new U(null,t):(o=0,r=new U(t,e)),this.rank(r),o&&(s=n,n=e),n&&this.connect(r,r.parameters(n,s)),this.touch(r),r},connect:function(t,e){const n=t.rank,s=e.length;for(let r=0;r<s;++r)if(n<e[r].rank)return void this.rerank(t)},rank:function(t){t.rank=++this._rank},rerank:function(t){const e=[t];let n,r,i;for(;e.length;)if(this.rank(n=e.pop()),r=n._targets)for(i=r.length;--i>=0;)e.push(n=r[i]),n===t&&s("Cycle detected in dataflow graph.")},pulse:function(t,e,n){this.touch(t,n||Y);const s=new H(this,this._clock+(this._pulse?0:1)),r=t.pulse&&t.pulse.source||[];return s.target=t,this._input[t.id]=e.pulse(s,r),this},touch:function(t,e){const n=e||Y;return this._pulse?this._enqueue(t):this._touched.add(t),n.skip&&t.skip(!0),this},update:function(t,e,n){const s=n||Y;return(t.set(e)||s.force)&&this.touch(t,s),this},changeset:L,ingest:function(t,e,n){return e=this.parse(e,n),this.pulse(t,this.changeset().insert(e))},parse:function(t,e){const n=this.locale();return m(t,e,n.timeParse,n.utcParse)},preload:async function(t,e,n){const s=this,r=s._pending||function(t){let e;const n=new Promise((t=>e=t));return n.requests=0,n.done=()=>{0==--n.requests&&(t._pending=null,e(t))},t._pending=n}(s);r.requests+=1;const i=await s.request(e,n);return s.pulse(t,s.changeset().remove(l).insert(i.data||[])),r.done(),i},request:async function(t,e){const n=this;let s,r=0;try{s=await n.loader().load(t,{context:"dataflow",response:_(e&&e.type)});try{s=n.parse(s,e)}catch(e){r=-2,n.warn("Data ingestion failed",t,e)}}catch(e){r=-1,n.warn("Loading failed",t,e)}return{data:s,status:r}},events:function(t,e,n,s){const i=this,o=$(n,s),l=function(t){t.dataflow=i;try{o.receive(t)}catch(t){i.error(t)}finally{i.run()}};let u;u="string"==typeof t&&"undefined"!=typeof document?document.querySelectorAll(t):r(t);const a=u.length;for(let t=0;t<a;++t)u[t].addEventListener(e,l);return o},on:function(t,e,n,s,r){return(t instanceof U?B:W)(this,t,e,n,s,r),this},evaluate:async function(t,e,n){const s=this,r=[];if(s._pulse)return X(s);if(s._pending&&await s._pending,e&&await w(s,e),!s._touched.length)return s.debug("Dataflow invoked, but nothing to do."),s;const i=++s._clock;s._pulse=new H(s,i,t),s._touched.forEach((t=>s._enqueue(t,!0))),s._touched=k(f);let o,l,u,a=0;try{for(;s._heap.size()>0;)o=s._heap.pop(),o.rank===o.qrank?(l=o.run(s._getPulse(o,t)),l.then?l=await l:l.async&&(r.push(l.async),l=G),l!==G&&o._targets&&o._targets.forEach((t=>s._enqueue(t))),++a):s._enqueue(o,!0)}catch(t){s._heap.clear(),u=t}if(s._input={},s._pulse=null,s.debug(`Pulse ${i}: ${a} operators`),u&&(s._postrun=[],s.error(u)),s._postrun.length){const t=s._postrun.sort(((t,e)=>e.priority-t.priority));s._postrun=[];for(let e=0;e<t.length;++e)await w(s,t[e].callback)}return n&&await w(s,n),r.length&&Promise.all(r).then((t=>s.runAsync(null,(()=>{t.forEach((t=>{try{t(s)}catch(t){s.error(t)}}))})))),s},run:function(t,e,n){return this._pulse?X(this):(this.evaluate(t,e,n),this)},runAsync:async function(t,e,n){for(;this._running;)await this._running;const s=()=>this._running=null;return(this._running=this.evaluate(t,e,n)).then(s,s),this._running},runAfter:function(t,e,n){if(this._pulse||e)this._postrun.push({priority:n||0,callback:t});else try{t(this)}catch(t){this.error(t)}},_enqueue:function(t,e){const n=t.stamp<this._clock;n&&(t.stamp=this._clock),(n||e)&&(t.qrank=t.rank,this._heap.push(t))},_getPulse:function(e,n){const s=e.source,r=this._clock;return s&&t(s)?new V(this,r,s.map((t=>t.pulse)),n):this._input[e.id]||function(t,e){if(e&&e.stamp===t.stamp)return e;t=t.fork(),e&&e!==G&&(t.source=e.source);return t}(this._pulse,s&&s.pulse)}},n(st,U,{run(t){if(t.stamp<this.stamp)return t.StopPropagation;let e;return this.skip()?this.skip(!1):e=this.evaluate(t),e=e||t,e.then?e=e.then((t=>this.pulse=t)):e!==t.StopPropagation&&(this.pulse=e),e},evaluate(t){const e=this.marshall(t.stamp),n=this.transform(e,t);return e.clear(),n},transform(){}});const rt={};function it(t){const e=ot(t);return e&&e.Definition||null}function ot(t){return t=t&&t.toLowerCase(),d(rt,t)?rt[t]:null}export{et as Dataflow,I as EventStream,V as MultiPulse,U as Operator,x as Parameters,H as Pulse,st as Transform,k as UniqueList,w as asyncCallback,L as changeset,it as definition,P as derive,O as ingest,S as isChangeSet,D as isTuple,q as rederive,M as replace,b as stableCompare,ot as transform,rt as transforms,E as tupleid};export default null;
//# sourceMappingURL=/sm/3e57814b5031b8872839131c706b80f984407b9d67687b79a1ce65f240f748b5.map