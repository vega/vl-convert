/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/vega-transforms@5.0.0/build/vega-transforms.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{inherits as e,array as t,accessorName as n,error as i,accessorFields as a,accessor as s,truthy as r,extent as l,toNumber as u,hasOwnProperty as o,extend as d,ascending as m,peek as f,constant as c,field as h,extentIndex as p,merge as v,compare as g,span as y,identity as _,fastmap as x,isArray as b,key as D,zero as O}from"/npm/vega-util@2.0.0/+esm";import{Transform as E,replace as k,ingest as q,tupleid as w,stableCompare as R,Operator as S,derive as N,rederive as M}from"/npm/vega-dataflow@6.0.0/+esm";import{bin as C,sampleCurve as U,dotbin as A,randomKDE as z,quantiles as L,quartiles as F,bootstrapCI as I,random as j,randomMixture as P,randomNormal as T,randomLogNormal as $,randomUniform as W}from"/npm/vega-statistics@2.0.0/+esm";import{range as B,bisector as J,median as K,mean as Q,min as G,max as H}from"/npm/d3-array@3.2.4/+esm";import{utcInterval as V,timeInterval as X,timeBin as Y,timeUnits as Z,utcFloor as ee,timeFloor as te,TIME_UNITS as ne}from"/npm/vega-time@3.0.0/+esm";function ie(e){return e&&e.length?1===e.length?e[0]:(t=e,e=>{const n=t.length;let i=1,a=String(t[0](e));for(;i<n;++i)a+="|"+t[i](e);return a}):function(){return""};var t}function ae(e,t,n){return n||e+(t?"_"+t:"")}const se=()=>{},re={init:se,add:se,rem:se,idx:0},le={values:{init:e=>e.cell.store=!0,value:e=>e.cell.data.values(),idx:-1},count:{value:e=>e.cell.num},__count__:{value:e=>e.missing+e.valid},missing:{value:e=>e.missing},valid:{value:e=>e.valid},sum:{init:e=>e.sum=0,value:e=>e.valid?e.sum:void 0,add:(e,t)=>e.sum+=+t,rem:(e,t)=>e.sum-=t},product:{init:e=>e.product=1,value:e=>e.valid?e.product:void 0,add:(e,t)=>e.product*=t,rem:(e,t)=>e.product/=t},mean:{init:e=>e.mean=0,value:e=>e.valid?e.mean:void 0,add:(e,t)=>(e.mean_d=t-e.mean,e.mean+=e.mean_d/e.valid),rem:(e,t)=>(e.mean_d=t-e.mean,e.mean-=e.valid?e.mean_d/e.valid:e.mean)},average:{value:e=>e.valid?e.mean:void 0,req:["mean"],idx:1},variance:{init:e=>e.dev=0,value:e=>e.valid>1?e.dev/(e.valid-1):void 0,add:(e,t)=>e.dev+=e.mean_d*(t-e.mean),rem:(e,t)=>e.dev-=e.mean_d*(t-e.mean),req:["mean"],idx:1},variancep:{value:e=>e.valid>1?e.dev/e.valid:void 0,req:["variance"],idx:2},stdev:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid-1)):void 0,req:["variance"],idx:2},stdevp:{value:e=>e.valid>1?Math.sqrt(e.dev/e.valid):void 0,req:["variance"],idx:2},stderr:{value:e=>e.valid>1?Math.sqrt(e.dev/(e.valid*(e.valid-1))):void 0,req:["variance"],idx:2},distinct:{value:e=>e.cell.data.distinct(e.get),req:["values"],idx:3},ci0:{value:e=>e.cell.data.ci0(e.get),req:["values"],idx:3},ci1:{value:e=>e.cell.data.ci1(e.get),req:["values"],idx:3},median:{value:e=>e.cell.data.q2(e.get),req:["values"],idx:3},q1:{value:e=>e.cell.data.q1(e.get),req:["values"],idx:3},q3:{value:e=>e.cell.data.q3(e.get),req:["values"],idx:3},min:{init:e=>e.min=void 0,value:e=>e.min=Number.isNaN(e.min)?e.cell.data.min(e.get):e.min,add:(e,t)=>{(t<e.min||void 0===e.min)&&(e.min=t)},rem:(e,t)=>{t<=e.min&&(e.min=NaN)},req:["values"],idx:4},max:{init:e=>e.max=void 0,value:e=>e.max=Number.isNaN(e.max)?e.cell.data.max(e.get):e.max,add:(e,t)=>{(t>e.max||void 0===e.max)&&(e.max=t)},rem:(e,t)=>{t>=e.max&&(e.max=NaN)},req:["values"],idx:4},argmin:{init:e=>e.argmin=void 0,value:e=>e.argmin||e.cell.data.argmin(e.get),add:(e,t,n)=>{t<e.min&&(e.argmin=n)},rem:(e,t)=>{t<=e.min&&(e.argmin=void 0)},req:["min","values"],idx:3},argmax:{init:e=>e.argmax=void 0,value:e=>e.argmax||e.cell.data.argmax(e.get),add:(e,t,n)=>{t>e.max&&(e.argmax=n)},rem:(e,t)=>{t>=e.max&&(e.argmax=void 0)},req:["max","values"],idx:3},exponential:{init:(e,t)=>{e.exp=0,e.exp_r=t},value:e=>e.valid?e.exp*(1-e.exp_r)/(1-e.exp_r**e.valid):void 0,add:(e,t)=>e.exp=e.exp_r*e.exp+t,rem:(e,t)=>e.exp=(e.exp-t/e.exp_r**(e.valid-1))/e.exp_r},exponentialb:{value:e=>e.valid?e.exp*(1-e.exp_r):void 0,req:["exponential"],idx:1}},ue=Object.keys(le).filter((e=>"__count__"!==e));function oe(e,t,n){return le[e](n,t)}function de(e,t){return e.idx-t.idx}function me(){this.valid=0,this.missing=0,this._ops.forEach((e=>null==e.aggregate_param?e.init(this):e.init(this,e.aggregate_param)))}function fe(e,t){null!=e&&""!==e?e==e&&(++this.valid,this._ops.forEach((n=>n.add(this,e,t)))):++this.missing}function ce(e,t){null!=e&&""!==e?e==e&&(--this.valid,this._ops.forEach((n=>n.rem(this,e,t)))):--this.missing}function he(e){return this._out.forEach((t=>e[t.out]=t.value(this))),e}function pe(e,t){const n=t||_,i=function(e){const t={};e.forEach((e=>t[e.name]=e));const n=e=>{e.req&&e.req.forEach((e=>{t[e]||n(t[e]=le[e]())}))};return e.forEach(n),Object.values(t).sort(de)}(e),a=e.slice().sort(de);function s(e){this._ops=i,this._out=a,this.cell=e,this.init()}return s.prototype.init=me,s.prototype.add=fe,s.prototype.rem=ce,s.prototype.set=he,s.prototype.get=n,s.fields=e.map((e=>e.out)),s}function ve(e){this._key=e?h(e):w,this.reset()}[...ue,"__count__"].forEach((e=>{le[e]=function(e,t){return(n,i)=>d({name:e,aggregate_param:i,out:n||e},re,t)}(e,le[e])}));const ge=ve.prototype;function ye(e){E.call(this,null,e),this._adds=[],this._mods=[],this._alen=0,this._mlen=0,this._drop=!0,this._cross=!1,this._dims=[],this._dnames=[],this._measures=[],this._countOnly=!1,this._counts=null,this._prev=null,this._inputs=null,this._outputs=null}ge.reset=function(){this._add=[],this._rem=[],this._ext=null,this._get=null,this._q=null},ge.add=function(e){this._add.push(e)},ge.rem=function(e){this._rem.push(e)},ge.values=function(){if(this._get=null,0===this._rem.length)return this._add;const e=this._add,t=this._rem,n=this._key,i=e.length,a=t.length,s=Array(i-a),r={};let l,u,o;for(l=0;l<a;++l)r[n(t[l])]=1;for(l=0,u=0;l<i;++l)r[n(o=e[l])]?r[n(o)]=0:s[u++]=o;return this._rem=[],this._add=s},ge.distinct=function(e){const t=this.values(),n={};let i,a=t.length,s=0;for(;--a>=0;)i=e(t[a])+"",o(n,i)||(n[i]=1,++s);return s},ge.extent=function(e){if(this._get!==e||!this._ext){const t=this.values(),n=p(t,e);this._ext=[t[n[0]],t[n[1]]],this._get=e}return this._ext},ge.argmin=function(e){return this.extent(e)[0]||{}},ge.argmax=function(e){return this.extent(e)[1]||{}},ge.min=function(e){const t=this.extent(e)[0];return null!=t?e(t):void 0},ge.max=function(e){const t=this.extent(e)[1];return null!=t?e(t):void 0},ge.quartile=function(e){return this._get===e&&this._q||(this._q=F(this.values(),e),this._get=e),this._q},ge.q1=function(e){return this.quartile(e)[0]},ge.q2=function(e){return this.quartile(e)[1]},ge.q3=function(e){return this.quartile(e)[2]},ge.ci=function(e){return this._get===e&&this._ci||(this._ci=I(this.values(),1e3,.05,e),this._get=e),this._ci},ge.ci0=function(e){return this.ci(e)[0]},ge.ci1=function(e){return this.ci(e)[1]},ye.Definition={type:"Aggregate",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:ue},{name:"aggregate_params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"drop",type:"boolean",default:!0},{name:"cross",type:"boolean",default:!1},{name:"key",type:"field"}]},e(ye,E,{transform(e,t){const n=this,i=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=e.modified();return n.stamp=i.stamp,n.value&&(a||t.modified(n._inputs,!0))?(n._prev=n.value,n.value=a?n.init(e):Object.create(null),t.visit(t.SOURCE,(e=>n.add(e)))):(n.value=n.value||n.init(e),t.visit(t.REM,(e=>n.rem(e))),t.visit(t.ADD,(e=>n.add(e)))),i.modifies(n._outputs),n._drop=!1!==e.drop,e.cross&&n._dims.length>1&&(n._drop=!1,n.cross()),t.clean()&&n._drop&&i.clean(!0).runAfter((()=>this.clean())),n.changes(i)},cross(){const e=this,t=e.value,n=e._dnames,i=n.map((()=>({}))),a=n.length;function s(e){let t,s,r,l;for(t in e)for(r=e[t].tuple,s=0;s<a;++s)i[s][l=r[n[s]]]=l}s(e._prev),s(t),function s(r,l,u){const o=n[u],d=i[u++];for(const n in d){const i=r?r+"|"+n:n;l[o]=d[n],u<a?s(i,l,u):t[i]||e.cell(i,l)}}("",{},0)},init(e){const s=this._inputs=[],r=this._outputs=[],l={};function u(e){const n=t(a(e)),i=n.length;let r,u=0;for(;u<i;++u)l[r=n[u]]||(l[r]=1,s.push(r))}this._dims=t(e.groupby),this._dnames=this._dims.map((e=>{const t=n(e);return u(e),r.push(t),t})),this.cellkey=e.key?e.key:ie(this._dims),this._countOnly=!0,this._counts=[],this._measures=[];const o=e.fields||[null],d=e.ops||["count"],m=e.aggregate_params||[null],f=e.as||[],c=o.length,h={};let p,v,g,y,_,x,b;for(c!==d.length&&i("Unmatched number of fields and aggregate ops."),b=0;b<c;++b)p=o[b],v=d[b],g=m[b]||null,null==p&&"count"!==v&&i("Null aggregate field specified."),_=n(p),x=ae(v,_,f[b]),r.push(x),"count"!==v?(y=h[_],y||(u(p),y=h[_]=[],y.field=p,this._measures.push(y)),"count"!==v&&(this._countOnly=!1),y.push(oe(v,g,x))):this._counts.push(x);return this._measures=this._measures.map((e=>pe(e,e.field))),Object.create(null)},cellkey:ie(),cell(e,t){let n=this.value[e];return n?0===n.num&&this._drop&&n.stamp<this.stamp?(n.stamp=this.stamp,this._adds[this._alen++]=n):n.stamp<this.stamp&&(n.stamp=this.stamp,this._mods[this._mlen++]=n):(n=this.value[e]=this.newcell(e,t),this._adds[this._alen++]=n),n},newcell(e,t){const n={key:e,num:0,agg:null,tuple:this.newtuple(t,this._prev&&this._prev[e]),stamp:this.stamp,store:!1};if(!this._countOnly){const e=this._measures,t=e.length;n.agg=Array(t);for(let i=0;i<t;++i)n.agg[i]=new e[i](n)}return n.store&&(n.data=new ve),n},newtuple(e,t){const n=this._dnames,i=this._dims,a=i.length,s={};for(let t=0;t<a;++t)s[n[t]]=i[t](e);return t?k(t.tuple,s):q(s)},clean(){const e=this.value;for(const t in e)0===e[t].num&&delete e[t]},add(e){const t=this.cellkey(e),n=this.cell(t,e);if(n.num+=1,this._countOnly)return;n.store&&n.data.add(e);const i=n.agg;for(let t=0,n=i.length;t<n;++t)i[t].add(i[t].get(e),e)},rem(e){const t=this.cellkey(e),n=this.cell(t,e);if(n.num-=1,this._countOnly)return;n.store&&n.data.rem(e);const i=n.agg;for(let t=0,n=i.length;t<n;++t)i[t].rem(i[t].get(e),e)},celltuple(e){const t=e.tuple,n=this._counts;e.store&&e.data.values();for(let i=0,a=n.length;i<a;++i)t[n[i]]=e.num;if(!this._countOnly){const n=e.agg;for(let e=0,i=n.length;e<i;++e)n[e].set(t)}return t},changes(e){const t=this._adds,n=this._mods,i=this._prev,a=this._drop,s=e.add,r=e.rem,l=e.mod;let u,o,d,m;if(i)for(o in i)u=i[o],a&&!u.num||r.push(u.tuple);for(d=0,m=this._alen;d<m;++d)s.push(this.celltuple(t[d])),t[d]=null;for(d=0,m=this._mlen;d<m;++d)u=n[d],(0===u.num&&a?r:l).push(this.celltuple(u)),n[d]=null;return this._alen=this._mlen=0,this._prev=null,e}});function _e(e){E.call(this,null,e)}function xe(e,t,n){const i=e;let a=t||[],s=n||[],r={},l=0;return{add:e=>s.push(e),remove:e=>r[i(e)]=++l,size:()=>a.length,data:(e,t)=>(l&&(a=a.filter((e=>!r[i(e)])),r={},l=0),t&&e&&a.sort(e),s.length&&(a=e?v(e,a,s.sort(e)):a.concat(s),s=[]),a)}}function be(e){E.call(this,[],e)}function De(e){S.call(this,null,Oe,e)}function Oe(e){return this.value&&!e.modified()?this.value:g(e.fields,e.orders)}function Ee(e){E.call(this,null,e)}function ke(e){E.call(this,null,e)}_e.Definition={type:"Bin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"anchor",type:"number"},{name:"maxbins",type:"number",default:20},{name:"base",type:"number",default:10},{name:"divide",type:"number",array:!0,default:[5,2]},{name:"extent",type:"number",array:!0,length:2,required:!0},{name:"span",type:"number"},{name:"step",type:"number"},{name:"steps",type:"number",array:!0},{name:"minstep",type:"number",default:0},{name:"nice",type:"boolean",default:!0},{name:"name",type:"string"},{name:"as",type:"string",array:!0,length:2,default:["bin0","bin1"]}]},e(_e,E,{transform(e,t){const n=!1!==e.interval,i=this._bins(e),s=i.start,r=i.step,l=e.as||["bin0","bin1"],u=l[0],o=l[1];let d;return d=e.modified()?(t=t.reflow(!0)).SOURCE:t.modified(a(e.field))?t.ADD_MOD:t.ADD,t.visit(d,n?e=>{const t=i(e);e[u]=t,e[o]=null==t?null:s+r*(1+(t-s)/r)}:e=>e[u]=i(e)),t.modifies(n?l:u)},_bins(e){if(this.value&&!e.modified())return this.value;const t=e.field,i=C(e),r=i.step;let l,o,d=i.start,m=d+Math.ceil((i.stop-d)/r)*r;null!=(l=e.anchor)&&(o=l-(d+r*Math.floor((l-d)/r)),d+=o,m+=o);const f=function(e){let n=u(t(e));return null==n?null:n<d?-1/0:n>m?1/0:(n=Math.max(d,Math.min(n,m-r)),d+r*Math.floor(1e-14+(n-d)/r))};return f.start=d,f.stop=i.stop,f.step=r,this.value=s(f,a(t),e.name||"bin_"+n(t))}}),be.Definition={type:"Collect",metadata:{source:!0},params:[{name:"sort",type:"compare"}]},e(be,E,{transform(e,t){const n=t.fork(t.ALL),i=xe(w,this.value,n.materialize(n.ADD).add),a=e.sort,s=t.changed()||a&&(e.modified("sort")||t.modified(a.fields));return n.visit(n.REM,i.remove),this.modified(s),this.value=n.source=i.data(R(a),s),t.source&&t.source.root&&(this.value.root=t.source.root),n}}),e(De,S),Ee.Definition={type:"CountPattern",metadata:{generates:!0,changes:!0},params:[{name:"field",type:"field",required:!0},{name:"case",type:"enum",values:["upper","lower","mixed"],default:"mixed"},{name:"pattern",type:"string",default:'[\\w"]+'},{name:"stopwords",type:"string",default:""},{name:"as",type:"string",array:!0,length:2,default:["text","count"]}]},e(Ee,E,{transform(e,t){const n=t=>n=>{for(var i,a=function(e,t,n){switch(t){case"upper":e=e.toUpperCase();break;case"lower":e=e.toLowerCase()}return e.match(n)}(l(n),e.case,s)||[],u=0,o=a.length;u<o;++u)r.test(i=a[u])||t(i)},i=this._parameterCheck(e,t),a=this._counts,s=this._match,r=this._stop,l=e.field,u=e.as||["text","count"],o=n((e=>a[e]=1+(a[e]||0))),d=n((e=>a[e]-=1));return i?t.visit(t.SOURCE,o):(t.visit(t.ADD,o),t.visit(t.REM,d)),this._finish(t,u)},_parameterCheck(e,t){let n=!1;return!e.modified("stopwords")&&this._stop||(this._stop=new RegExp("^"+(e.stopwords||"")+"$","i"),n=!0),!e.modified("pattern")&&this._match||(this._match=new RegExp(e.pattern||"[\\w']+","g"),n=!0),(e.modified("field")||t.modified(e.field.fields))&&(n=!0),n&&(this._counts={}),n},_finish(e,t){const n=this._counts,i=this._tuples||(this._tuples={}),a=t[0],s=t[1],r=e.fork(e.NO_SOURCE|e.NO_FIELDS);let l,u,o;for(l in n)u=i[l],o=n[l]||0,!u&&o?(i[l]=u=q({}),u[a]=l,u[s]=o,r.add.push(u)):0===o?(u&&r.rem.push(u),n[l]=null,i[l]=null):u[s]!==o&&(u[s]=o,r.mod.push(u));return r.modifies(t)}}),ke.Definition={type:"Cross",metadata:{generates:!0},params:[{name:"filter",type:"expr"},{name:"as",type:"string",array:!0,length:2,default:["a","b"]}]},e(ke,E,{transform(e,t){const n=t.fork(t.NO_SOURCE),i=e.as||["a","b"],a=i[0],s=i[1],l=!this.value||t.changed(t.ADD_REM)||e.modified("as")||e.modified("filter");let u=this.value;return l?(u&&(n.rem=u),u=t.materialize(t.SOURCE).source,n.add=this.value=function(e,t,n,i){for(var a,s,r=[],l={},u=e.length,o=0;o<u;++o)for(l[t]=s=e[o],a=0;a<u;++a)l[n]=e[a],i(l)&&(r.push(q(l)),(l={})[t]=s);return r}(u,a,s,e.filter||r)):n.mod=u,n.source=this.value,n.modifies(i)}});const qe={kde:z,mixture:P,normal:T,lognormal:$,uniform:W},we="function";function Re(e,t){const n=e[we];o(qe,n)||i("Unknown distribution function: "+n);const a=qe[n]();for(const n in e)"field"===n?a.data((e.from||t()).map(e[n])):"distributions"===n?a[n](e[n].map((e=>Re(e,t)))):typeof a[n]===we&&a[n](e[n]);return a}function Se(e){E.call(this,null,e)}const Ne=[{key:{function:"normal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"lognormal"},params:[{name:"mean",type:"number",default:0},{name:"stdev",type:"number",default:1}]},{key:{function:"uniform"},params:[{name:"min",type:"number",default:0},{name:"max",type:"number",default:1}]},{key:{function:"kde"},params:[{name:"field",type:"field",required:!0},{name:"from",type:"data"},{name:"bandwidth",type:"number",default:0}]}],Me={key:{function:"mixture"},params:[{name:"distributions",type:"param",array:!0,params:Ne},{name:"weights",type:"number",array:!0}]};function Ce(e,t){return e?e.map(((e,i)=>t[i]||n(e))):null}function Ue(e,t,n){const i=[],a=e=>e(u);let s,r,l,u,o,d;if(null==t)i.push(e.map(n));else for(s={},r=0,l=e.length;r<l;++r)u=e[r],o=t.map(a),d=s[o],d||(s[o]=d=[],d.dims=o,i.push(d)),d.push(n(u));return i}Se.Definition={type:"Density",metadata:{generates:!0},params:[{name:"extent",type:"number",array:!0,length:2},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"method",type:"string",default:"pdf",values:["pdf","cdf"]},{name:"distribution",type:"param",params:Ne.concat(Me)},{name:"as",type:"string",array:!0,default:["value","density"]}]},e(Se,E,{transform(e,t){const n=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const a=Re(e.distribution,function(e){return()=>e.materialize(e.SOURCE).source}(t)),s=e.steps||e.minsteps||25,r=e.steps||e.maxsteps||200;let u=e.method||"pdf";"pdf"!==u&&"cdf"!==u&&i("Invalid density method: "+u),e.extent||a.data||i("Missing density extent parameter."),u=a[u];const o=e.as||["value","density"],d=e.extent||l(a.data()),m=U(u,d,s,r).map((e=>{const t={};return t[o[0]]=e[0],t[o[1]]=e[1],q(t)}));this.value&&(n.rem=this.value),this.value=n.add=n.source=m}return n}});function Ae(e){E.call(this,null,e)}Ae.Definition={type:"DotBin",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"groupby",type:"field",array:!0},{name:"step",type:"number"},{name:"smooth",type:"boolean",default:!1},{name:"as",type:"string",default:"bin"}]};function ze(e){S.call(this,null,Le,e),this.modified(!0)}function Le(e){const t=e.expr;return this.value&&!e.modified("expr")?this.value:s((n=>t(n,e)),a(t),n(t))}function Fe(e){E.call(this,[void 0,void 0],e)}function Ie(e,t){S.call(this,e),this.parent=t,this.count=0}function je(e){E.call(this,{},e),this._keys=x();const t=this._targets=[];t.active=0,t.forEach=e=>{for(let n=0,i=t.active;n<i;++n)e(t[n],n,t)}}function Pe(e){S.call(this,null,Te,e)}function Te(e){return this.value&&!e.modified()?this.value:b(e.name)?t(e.name).map((e=>h(e))):h(e.name,e.as)}function $e(e){E.call(this,x(),e)}function We(e){E.call(this,[],e)}function Be(e){E.call(this,[],e)}function Je(e){E.call(this,null,e)}function Ke(e){E.call(this,[],e)}e(Ae,E,{transform(e,t){if(this.value&&!e.modified()&&!t.changed())return t;const n=t.materialize(t.SOURCE).source,i=Ue(t.source,e.groupby,_),a=e.smooth||!1,s=e.field,r=e.step||((e,t)=>y(l(e,t))/30)(n,s),u=R(((e,t)=>s(e)-s(t))),o=e.as||"bin",d=i.length;let m,f=1/0,c=-1/0,h=0;for(;h<d;++h){const e=i[h].sort(u);m=-1;for(const t of A(e,r,a,s))t<f&&(f=t),t>c&&(c=t),e[++m][o]=t}return this.value={start:f,stop:c,step:r},t.reflow(!0).modifies(o)}}),e(ze,S),Fe.Definition={type:"Extent",metadata:{},params:[{name:"field",type:"field",required:!0}]},e(Fe,E,{transform(e,t){const i=this.value,a=e.field,s=t.changed()||t.modified(a.fields)||e.modified("field");let r=i[0],l=i[1];if((s||null==r)&&(r=1/0,l=-1/0),t.visit(s?t.SOURCE:t.ADD,(e=>{const t=u(a(e));null!=t&&(t<r&&(r=t),t>l&&(l=t))})),!Number.isFinite(r)||!Number.isFinite(l)){let e=n(a);e&&(e=` for field "${e}"`),t.dataflow.warn(`Infinite extent${e}: [${r}, ${l}]`),r=l=void 0}this.value=[r,l]}}),e(Ie,S,{connect(e){return this.detachSubflow=e.detachSubflow,this.targets().add(e),e.source=this},add(e){this.count+=1,this.value.add.push(e)},rem(e){this.count-=1,this.value.rem.push(e)},mod(e){this.value.mod.push(e)},init(e){this.value.init(e,e.NO_SOURCE)},evaluate(){return this.value}}),e(je,E,{activate(e){this._targets[this._targets.active++]=e},subflow(e,t,n,i){const a=this.value;let s,r,l=o(a,e)&&a[e];return l?l.value.stamp<n.stamp&&(l.init(n),this.activate(l)):(r=i||(r=this._group[e])&&r.tuple,s=n.dataflow,l=new Ie(n.fork(n.NO_SOURCE),this),s.add(l).connect(t(s,e,r)),a[e]=l,this.activate(l)),l},clean(){const e=this.value;let t=0;for(const n in e)if(0===e[n].count){const i=e[n].detachSubflow;i&&i(),delete e[n],++t}if(t){const e=this._targets.filter((e=>e&&e.count>0));this.initTargets(e)}},initTargets(e){const t=this._targets,n=t.length,i=e?e.length:0;let a=0;for(;a<i;++a)t[a]=e[a];for(;a<n&&null!=t[a];++a)t[a]=null;t.active=i},transform(e,t){const n=t.dataflow,i=e.key,a=e.subflow,s=this._keys,r=e.modified("key"),l=e=>this.subflow(e,a,t);return this._group=e.group||{},this.initTargets(),t.visit(t.REM,(e=>{const t=w(e),n=s.get(t);void 0!==n&&(s.delete(t),l(n).rem(e))})),t.visit(t.ADD,(e=>{const t=i(e);s.set(w(e),t),l(t).add(e)})),r||t.modified(i.fields)?t.visit(t.MOD,(e=>{const t=w(e),n=s.get(t),a=i(e);n===a?l(a).mod(e):(s.set(t,a),l(n).rem(e),l(a).add(e))})):t.changed(t.MOD)&&t.visit(t.MOD,(e=>{l(s.get(w(e))).mod(e)})),r&&t.visit(t.REFLOW,(e=>{const t=w(e),n=s.get(t),a=i(e);n!==a&&(s.set(t,a),l(n).rem(e),l(a).add(e))})),t.clean()?n.runAfter((()=>{this.clean(),s.clean()})):s.empty>n.cleanThreshold&&n.runAfter(s.clean),t}}),e(Pe,S),$e.Definition={type:"Filter",metadata:{changes:!0},params:[{name:"expr",type:"expr",required:!0}]},e($e,E,{transform(e,t){const n=t.dataflow,i=this.value,a=t.fork(),s=a.add,r=a.rem,l=a.mod,u=e.expr;let o=!0;function d(t){const n=w(t),a=u(t,e),d=i.get(n);a&&d?(i.delete(n),s.push(t)):a||d?o&&a&&!d&&l.push(t):(i.set(n,1),r.push(t))}return t.visit(t.REM,(e=>{const t=w(e);i.has(t)?i.delete(t):r.push(e)})),t.visit(t.ADD,(t=>{u(t,e)?s.push(t):i.set(w(t),1)})),t.visit(t.MOD,d),e.modified()&&(o=!1,t.visit(t.REFLOW,d)),i.empty>n.cleanThreshold&&n.runAfter(i.clean),a}}),We.Definition={type:"Flatten",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"index",type:"string"},{name:"as",type:"string",array:!0}]},e(We,E,{transform(e,t){const n=t.fork(t.NO_SOURCE),i=e.fields,a=Ce(i,e.as||[]),s=e.index||null,r=a.length;return n.rem=this.value,t.visit(t.SOURCE,(e=>{const t=i.map((t=>t(e))),l=t.reduce(((e,t)=>Math.max(e,t.length)),0);let u,o,d,m=0;for(;m<l;++m){for(o=N(e),u=0;u<r;++u)o[a[u]]=null==(d=t[u][m])?null:d;s&&(o[s]=m),n.add.push(o)}})),this.value=n.source=n.add,s&&n.modifies(s),n.modifies(a)}}),Be.Definition={type:"Fold",metadata:{generates:!0},params:[{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0,length:2,default:["key","value"]}]},e(Be,E,{transform(e,t){const i=t.fork(t.NO_SOURCE),a=e.fields,s=a.map(n),r=e.as||["key","value"],l=r[0],u=r[1],o=a.length;return i.rem=this.value,t.visit(t.SOURCE,(e=>{for(let t,n=0;n<o;++n)t=N(e),t[l]=s[n],t[u]=a[n](e),i.add.push(t)})),this.value=i.source=i.add,i.modifies(r)}}),Je.Definition={type:"Formula",metadata:{modifies:!0},params:[{name:"expr",type:"expr",required:!0},{name:"as",type:"string",required:!0},{name:"initonly",type:"boolean"}]},e(Je,E,{transform(e,t){const n=e.expr,i=e.as,a=e.modified(),s=e.initonly?t.ADD:a?t.SOURCE:t.modified(n.fields)||t.modified(i)?t.ADD_MOD:t.ADD;return a&&(t=t.materialize().reflow(!0)),e.initonly||t.modifies(i),t.visit(s,(t=>t[i]=n(t,e)))}}),e(Ke,E,{transform(e,t){const n=t.fork(t.ALL),i=e.generator;let a,s,r,l=this.value,u=e.size-l.length;if(u>0){for(a=[];--u>=0;)a.push(r=q(i(e))),l.push(r);n.add=n.add.length?n.materialize(n.ADD).add.concat(a):a}else s=l.slice(0,-u),n.rem=n.rem.length?n.materialize(n.REM).rem.concat(s):s,l=l.slice(-u);return n.source=this.value=l,n}});const Qe={value:"value",median:K,mean:Q,min:G,max:H},Ge=[];function He(e){E.call(this,[],e)}function Ve(e){ye.call(this,e)}function Xe(e){E.call(this,null,e)}function Ye(e){S.call(this,null,Ze,e)}function Ze(e){return this.value&&!e.modified()?this.value:D(e.fields,e.flat)}function et(e){E.call(this,[],e),this._pending=null}function tt(e,t,n){n.forEach(q);const i=t.fork(t.NO_FIELDS&t.NO_SOURCE);return i.rem=e.value,e.value=i.source=i.add=n,e._pending=null,i.rem.length&&i.clean(!0),i}function nt(e){E.call(this,{},e)}function it(e){S.call(this,null,at,e)}function at(e){if(this.value&&!e.modified())return this.value;const t=e.extents,n=t.length;let i,a,s=1/0,r=-1/0;for(i=0;i<n;++i)a=t[i],a[0]<s&&(s=a[0]),a[1]>r&&(r=a[1]);return[s,r]}function st(e){S.call(this,null,rt,e)}function rt(e){return this.value&&!e.modified()?this.value:e.values.reduce(((e,t)=>e.concat(t)),[])}function lt(e){E.call(this,null,e)}function ut(e){ye.call(this,e)}function ot(e){je.call(this,e)}function dt(e){E.call(this,null,e)}function mt(e){E.call(this,null,e)}function ft(e){E.call(this,null,e)}He.Definition={type:"Impute",metadata:{changes:!0},params:[{name:"field",type:"field",required:!0},{name:"key",type:"field",required:!0},{name:"keyvals",array:!0},{name:"groupby",type:"field",array:!0},{name:"method",type:"enum",default:"value",values:["value","mean","median","max","min"]},{name:"value",default:0}]},e(He,E,{transform(e,t){var a,s,r,l,u,o,d,m,f,c,h=t.fork(t.ALL),p=function(e){var t,n=e.method||Qe.value;if(null!=Qe[n])return n===Qe.value?(t=void 0!==e.value?e.value:0,()=>t):Qe[n];i("Unrecognized imputation method: "+n)}(e),v=function(e){const t=e.field;return e=>e?t(e):NaN}(e),g=n(e.field),y=n(e.key),_=(e.groupby||[]).map(n),x=function(e,t,n,i){var a,s,r,l,u,o,d,m,f=e=>e(m),c=[],h=i?i.slice():[],p={},v={};for(h.forEach(((e,t)=>p[e]=t+1)),l=0,d=e.length;l<d;++l)o=n(m=e[l]),u=p[o]||(p[o]=h.push(o)),(r=v[s=(a=t?t.map(f):Ge)+""])||(r=v[s]=[],c.push(r),r.values=a),r[u-1]=m;return c.domain=h,c}(t.source,e.groupby,e.key,e.keyvals),b=[],D=this.value,O=x.domain.length;for(u=0,m=x.length;u<m;++u)for(r=(a=x[u]).values,s=NaN,d=0;d<O;++d)if(null==a[d]){for(l=x.domain[d],c={_impute:!0},o=0,f=r.length;o<f;++o)c[_[o]]=r[o];c[y]=l,c[g]=Number.isNaN(s)?s=p(a,v):s,b.push(q(c))}return b.length&&(h.add=h.materialize(h.ADD).add.concat(b)),D.length&&(h.rem=h.materialize(h.REM).rem.concat(D)),this.value=b,h}}),Ve.Definition={type:"JoinAggregate",metadata:{modifies:!0},params:[{name:"groupby",type:"field",array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"ops",type:"enum",array:!0,values:ue},{name:"as",type:"string",null:!0,array:!0},{name:"key",type:"field"}]},e(Ve,ye,{transform(e,t){const n=this,i=e.modified();let a;return n.value&&(i||t.modified(n._inputs,!0))?(a=n.value=i?n.init(e):{},t.visit(t.SOURCE,(e=>n.add(e)))):(a=n.value=n.value||this.init(e),t.visit(t.REM,(e=>n.rem(e))),t.visit(t.ADD,(e=>n.add(e)))),n.changes(),t.visit(t.SOURCE,(e=>{d(e,a[n.cellkey(e)].tuple)})),t.reflow(i).modifies(this._outputs)},changes(){const e=this._adds,t=this._mods;let n,i;for(n=0,i=this._alen;n<i;++n)this.celltuple(e[n]),e[n]=null;for(n=0,i=this._mlen;n<i;++n)this.celltuple(t[n]),t[n]=null;this._alen=this._mlen=0}}),Xe.Definition={type:"KDE",metadata:{generates:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"cumulative",type:"boolean",default:!1},{name:"counts",type:"boolean",default:!1},{name:"bandwidth",type:"number",default:0},{name:"extent",type:"number",array:!0,length:2},{name:"resolve",type:"enum",values:["shared","independent"],default:"independent"},{name:"steps",type:"number"},{name:"minsteps",type:"number",default:25},{name:"maxsteps",type:"number",default:200},{name:"as",type:"string",array:!0,default:["value","density"]}]},e(Xe,E,{transform(e,t){const a=t.fork(t.NO_SOURCE|t.NO_FIELDS);if(!this.value||t.changed()||e.modified()){const s=t.materialize(t.SOURCE).source,r=Ue(s,e.groupby,e.field),u=(e.groupby||[]).map(n),o=e.bandwidth,d=e.cumulative?"cdf":"pdf",m=e.as||["value","density"],f=[];let c=e.extent,h=e.steps||e.minsteps||25,p=e.steps||e.maxsteps||200;"pdf"!==d&&"cdf"!==d&&i("Invalid density method: "+d),"shared"===e.resolve&&(c||(c=l(s,e.field)),h=p=e.steps||p),r.forEach((t=>{const n=z(t,o)[d],i=e.counts?t.length:1,a=c||l(t);U(n,a,h,p).forEach((e=>{const n={};for(let e=0;e<u.length;++e)n[u[e]]=t.dims[e];n[m[0]]=e[0],n[m[1]]=e[1]*i,f.push(q(n))}))})),this.value&&(a.rem=this.value),this.value=a.add=a.source=f}return a}}),e(Ye,S),e(et,E,{transform(e,n){const i=n.dataflow;if(this._pending)return tt(this,n,this._pending);if(function(e){return e.modified("async")&&!(e.modified("values")||e.modified("url")||e.modified("format"))}(e))return n.StopPropagation;if(e.values)return tt(this,n,i.parse(e.values,e.format));if(e.async){const n=i.request(e.url,e.format).then((e=>(this._pending=t(e.data),e=>e.touch(this))));return{async:n}}return i.request(e.url,e.format).then((e=>tt(this,n,t(e.data))))}}),nt.Definition={type:"Lookup",metadata:{modifies:!0},params:[{name:"index",type:"index",params:[{name:"from",type:"data",required:!0},{name:"key",type:"field",required:!0}]},{name:"values",type:"field",array:!0},{name:"fields",type:"field",array:!0,required:!0},{name:"as",type:"string",array:!0},{name:"default",default:null}]},e(nt,E,{transform(e,t){const a=e.fields,s=e.index,r=e.values,l=null==e.default?null:e.default,u=e.modified(),o=a.length;let d,m,f,c=u?t.SOURCE:t.ADD,h=t,p=e.as;return r?(m=r.length,o>1&&!p&&i('Multi-field lookup requires explicit "as" parameter.'),p&&p.length!==o*m&&i('The "as" parameter has too few output field names.'),p=p||r.map(n),d=function(e){for(var t,n,i=0,u=0;i<o;++i)if(null==(n=s.get(a[i](e))))for(t=0;t<m;++t,++u)e[p[u]]=l;else for(t=0;t<m;++t,++u)e[p[u]]=r[t](n)}):(p||i("Missing output field names."),d=function(e){for(var t,n=0;n<o;++n)t=s.get(a[n](e)),e[p[n]]=null==t?l:t}),u?h=t.reflow(!0):(f=a.some((e=>t.modified(e.fields))),c|=f?t.MOD:0),t.visit(c,d),h.modifies(p)}}),e(it,S),e(st,S),e(lt,E,{transform(e,t){return this.modified(e.modified()),this.value=e,t.fork(t.NO_SOURCE|t.NO_FIELDS)}}),ut.Definition={type:"Pivot",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"value",type:"field",required:!0},{name:"op",type:"enum",values:ue,default:"sum"},{name:"limit",type:"number",default:0},{name:"key",type:"field"}]},e(ut,ye,{_transform:ye.prototype.transform,transform(e,t){return this._transform(function(e,t){const n=e.field,i=e.value,r=("count"===e.op?"__count__":e.op)||"sum",l=a(n).concat(a(i)),u=function(e,t,n){const i={},a=[];return n.visit(n.SOURCE,(t=>{const n=e(t);i[n]||(i[n]=1,a.push(n))})),a.sort(m),t?a.slice(0,t):a}(n,e.limit||0,t);t.changed()&&e.set("__pivot__",null,null,!0);return{key:e.key,groupby:e.groupby,ops:u.map((()=>r)),fields:u.map((e=>function(e,t,n,i){return s((i=>t(i)===e?n(i):NaN),i,e+"")}(e,n,i,l))),as:u.map((e=>e+"")),modified:e.modified.bind(e)}}(e,t),t)}}),e(ot,je,{transform(e,t){const n=e.subflow,s=e.field,r=e=>this.subflow(w(e),n,t,e);return(e.modified("field")||s&&t.modified(a(s)))&&i("PreFacet does not support field modification."),this.initTargets(),s?(t.visit(t.MOD,(e=>{const t=r(e);s(e).forEach((e=>t.mod(e)))})),t.visit(t.ADD,(e=>{const t=r(e);s(e).forEach((e=>t.add(q(e))))})),t.visit(t.REM,(e=>{const t=r(e);s(e).forEach((e=>t.rem(e)))}))):(t.visit(t.MOD,(e=>r(e).mod(e))),t.visit(t.ADD,(e=>r(e).add(e))),t.visit(t.REM,(e=>r(e).rem(e)))),t.clean()&&t.runAfter((()=>this.clean())),t}}),dt.Definition={type:"Project",metadata:{generates:!0,changes:!0},params:[{name:"fields",type:"field",array:!0},{name:"as",type:"string",null:!0,array:!0}]},e(dt,E,{transform(e,t){const n=t.fork(t.NO_SOURCE),i=e.fields,a=Ce(e.fields,e.as||[]),s=i?(e,t)=>function(e,t,n,i){for(let a=0,s=n.length;a<s;++a)t[i[a]]=n[a](e);return t}(e,t,i,a):M;let r;return this.value?r=this.value:(t=t.addAll(),r=this.value={}),t.visit(t.REM,(e=>{const t=w(e);n.rem.push(r[t]),r[t]=null})),t.visit(t.ADD,(e=>{const t=s(e,q({}));r[w(e)]=t,n.add.push(t)})),t.visit(t.MOD,(e=>{n.mod.push(s(e,r[w(e)]))})),n}}),e(mt,E,{transform(e,t){return this.value=e.value,e.modified("value")?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}}),ft.Definition={type:"Quantile",metadata:{generates:!0,changes:!0},params:[{name:"groupby",type:"field",array:!0},{name:"field",type:"field",required:!0},{name:"probs",type:"number",array:!0},{name:"step",type:"number",default:.01},{name:"as",type:"string",array:!0,default:["prob","value"]}]};function ct(e){E.call(this,null,e)}function ht(e){E.call(this,[],e),this.count=0}function pt(e){E.call(this,null,e)}function vt(e){E.call(this,null,e),this.modified(!0)}function gt(e){E.call(this,null,e)}e(ft,E,{transform(e,t){const i=t.fork(t.NO_SOURCE|t.NO_FIELDS),a=e.as||["prob","value"];if(this.value&&!e.modified()&&!t.changed())return i.source=this.value,i;const s=Ue(t.materialize(t.SOURCE).source,e.groupby,e.field),r=(e.groupby||[]).map(n),l=[],u=e.step||.01,o=e.probs||B(u/2,1-1e-14,u),d=o.length;return s.forEach((e=>{const t=L(e,o);for(let n=0;n<d;++n){const i={};for(let t=0;t<r.length;++t)i[r[t]]=e.dims[t];i[a[0]]=o[n],i[a[1]]=t[n],l.push(q(i))}})),this.value&&(i.rem=this.value),this.value=i.add=i.source=l,i}}),e(ct,E,{transform(e,t){let n,i;return this.value?i=this.value:(n=t=t.addAll(),i=this.value={}),e.derive&&(n=t.fork(t.NO_SOURCE),t.visit(t.REM,(e=>{const t=w(e);n.rem.push(i[t]),i[t]=null})),t.visit(t.ADD,(e=>{const t=N(e);i[w(e)]=t,n.add.push(t)})),t.visit(t.MOD,(e=>{const t=i[w(e)];for(const i in e)t[i]=e[i],n.modifies(i);n.mod.push(t)}))),n}}),ht.Definition={type:"Sample",metadata:{},params:[{name:"size",type:"number",default:1e3}]},e(ht,E,{transform(e,t){const n=t.fork(t.NO_SOURCE),i=e.modified("size"),a=e.size,s=this.value.reduce(((e,t)=>(e[w(t)]=1,e)),{});let r=this.value,l=this.count,u=0;function o(e){let t,i;r.length<a?r.push(e):(i=~~((l+1)*j()),i<r.length&&i>=u&&(t=r[i],s[w(t)]&&n.rem.push(t),r[i]=e)),++l}if(t.rem.length&&(t.visit(t.REM,(e=>{const t=w(e);s[t]&&(s[t]=-1,n.rem.push(e)),--l})),r=r.filter((e=>-1!==s[w(e)]))),(t.rem.length||i)&&r.length<a&&t.source&&(u=l=r.length,t.visit(t.SOURCE,(e=>{s[w(e)]||o(e)})),u=-1),i&&r.length>a){const e=r.length-a;for(let t=0;t<e;++t)s[w(r[t])]=-1,n.rem.push(r[t]);r=r.slice(e)}return t.mod.length&&t.visit(t.MOD,(e=>{s[w(e)]&&n.mod.push(e)})),t.add.length&&t.visit(t.ADD,o),(t.add.length||u<0)&&(n.add=r.filter((e=>!s[w(e)]))),this.count=l,this.value=n.source=r,n}}),pt.Definition={type:"Sequence",metadata:{generates:!0,changes:!0},params:[{name:"start",type:"number",required:!0},{name:"stop",type:"number",required:!0},{name:"step",type:"number",default:1},{name:"as",type:"string",default:"data"}]},e(pt,E,{transform(e,t){if(this.value&&!e.modified())return;const n=t.materialize().fork(t.MOD),i=e.as||"data";return n.rem=this.value?t.rem.concat(this.value):t.rem,this.value=B(e.start,e.stop,e.step||1).map((e=>{const t={};return t[i]=e,q(t)})),n.add=t.add.concat(this.value),n}}),e(vt,E,{transform(e,t){return this.value=t.source,t.changed()?t.fork(t.NO_SOURCE|t.NO_FIELDS):t.StopPropagation}});const yt=["unit0","unit1"];function _t(e){E.call(this,x(),e)}function xt(e){E.call(this,null,e)}gt.Definition={type:"TimeUnit",metadata:{modifies:!0},params:[{name:"field",type:"field",required:!0},{name:"interval",type:"boolean",default:!0},{name:"units",type:"enum",values:ne,array:!0},{name:"step",type:"number",default:1},{name:"maxbins",type:"number",default:40},{name:"extent",type:"date",array:!0},{name:"timezone",type:"enum",default:"local",values:["local","utc"]},{name:"as",type:"string",array:!0,length:2,default:yt}]},e(gt,E,{transform(e,t){const n=e.field,i=!1!==e.interval,s="utc"===e.timezone,r=this._floor(e,t),l=(s?V:X)(r.unit).offset,u=e.as||yt,o=u[0],d=u[1],m=r.step;let f=r.start||1/0,c=r.stop||-1/0,h=t.ADD;return(e.modified()||t.changed(t.REM)||t.modified(a(n)))&&(h=(t=t.reflow(!0)).SOURCE,f=1/0,c=-1/0),t.visit(h,(e=>{const t=n(e);let a,s;null==t?(e[o]=null,i&&(e[d]=null)):(e[o]=a=s=r(t),i&&(e[d]=s=l(a,m)),a<f&&(f=a),s>c&&(c=s))})),r.start=f,r.stop=c,t.modifies(i?u:o)},_floor(e,t){const n="utc"===e.timezone,{units:i,step:a}=e.units?{units:e.units,step:e.step||1}:Y({extent:e.extent||l(t.materialize(t.SOURCE).source,e.field),maxbins:e.maxbins}),s=Z(i),r=this.value||{},u=(n?ee:te)(s,a);return u.unit=f(s),u.units=s,u.step=a,u.start=r.start,u.stop=r.stop,this.value=u}}),e(_t,E,{transform(e,t){const n=t.dataflow,i=e.field,a=this.value,s=e=>a.set(i(e),e);let r=!0;return e.modified("field")||t.modified(i.fields)?(a.clear(),t.visit(t.SOURCE,s)):t.changed()?(t.visit(t.REM,(e=>a.delete(i(e)))),t.visit(t.ADD,s)):r=!1,this.modified(r),a.empty>n.cleanThreshold&&n.runAfter(a.clean),t.fork()}}),e(xt,E,{transform(e,t){(!this.value||e.modified("field")||e.modified("sort")||t.changed()||e.sort&&t.modified(e.sort.fields))&&(this.value=(e.sort?t.source.slice().sort(R(e.sort)):t.source).map(e.field))}});const bt={row_number:function(){return{next:e=>e.index+1}},rank:function(){let e;return{init:()=>e=1,next:t=>{const n=t.index,i=t.data;return n&&t.compare(i[n-1],i[n])?e=n+1:e}}},dense_rank:function(){let e;return{init:()=>e=1,next:t=>{const n=t.index,i=t.data;return n&&t.compare(i[n-1],i[n])?++e:e}}},percent_rank:function(){const e=bt.rank(),t=e.next;return{init:e.init,next:e=>(t(e)-1)/(e.data.length-1)}},cume_dist:function(){let e;return{init:()=>e=0,next:t=>{const n=t.data,i=t.compare;let a=t.index;if(e<a){for(;a+1<n.length&&!i(n[a],n[a+1]);)++a;e=a}return(1+e)/n.length}}},ntile:function(e,t){(t=+t)>0||i("ntile num must be greater than zero.");const n=bt.cume_dist(),a=n.next;return{init:n.init,next:e=>Math.ceil(t*a(e))}},lag:function(e,t){return t=+t||1,{next:n=>{const i=n.index-t;return i>=0?e(n.data[i]):null}}},lead:function(e,t){return t=+t||1,{next:n=>{const i=n.index+t,a=n.data;return i<a.length?e(a[i]):null}}},first_value:function(e){return{next:t=>e(t.data[t.i0])}},last_value:function(e){return{next:t=>e(t.data[t.i1-1])}},nth_value:function(e,t){return(t=+t)>0||i("nth_value nth must be greater than zero."),{next:n=>{const i=n.i0+(t-1);return i<n.i1?e(n.data[i]):null}}},prev_value:function(e){let t;return{init:()=>t=null,next:n=>{const i=e(n.data[n.index]);return null!=i?t=i:t}}},next_value:function(e){let t,n;return{init:()=>(t=null,n=-1),next:i=>{const a=i.data;return i.index<=n?t:(n=function(e,t,n){for(let i=t.length;n<i;++n){if(null!=e(t[n]))return n}return-1}(e,a,i.index))<0?(n=a.length,t=null):t=e(a[n])}}}};const Dt=Object.keys(bt);function Ot(e){const s=t(e.ops),r=t(e.fields),l=t(e.params),u=t(e.aggregate_params),d=t(e.as),m=this.outputs=[],f=this.windows=[],c={},h={},p=[],v=[];let g=!0;function y(e){t(a(e)).forEach((e=>c[e]=1))}y(e.sort),s.forEach(((e,t)=>{const a=r[t],s=l[t],c=u[t]||null,_=n(a),x=ae(e,_,d[t]);if(y(a),m.push(x),o(bt,e))f.push(function(e,t,n,i){const a=bt[e](t,n);return{init:a.init||O,update:function(e,t){t[i]=a.next(e)}}}(e,a,s,x));else{if(null==a&&"count"!==e&&i("Null aggregate field specified."),"count"===e)return void p.push(x);g=!1;let t=h[_];t||(t=h[_]=[],t.field=a,v.push(t)),t.push(oe(e,c,x))}})),(p.length||v.length)&&(this.cell=function(e,t,n){e=e.map((e=>pe(e,e.field)));const i={num:0,agg:null,store:!1,count:t};if(!n)for(var a=e.length,s=i.agg=Array(a),r=0;r<a;++r)s[r]=new e[r](i);if(i.store)var l=i.data=new ve;return i.add=function(e){if(i.num+=1,!n){l&&l.add(e);for(let t=0;t<a;++t)s[t].add(s[t].get(e),e)}},i.rem=function(e){if(i.num-=1,!n){l&&l.rem(e);for(let t=0;t<a;++t)s[t].rem(s[t].get(e),e)}},i.set=function(e){let a,r;for(l&&l.values(),a=0,r=t.length;a<r;++a)e[t[a]]=i.num;if(!n)for(a=0,r=s.length;a<r;++a)s[a].set(e)},i.init=function(){i.num=0,l&&l.reset();for(let e=0;e<a;++e)s[e].init()},i}(v,p,g)),this.inputs=Object.keys(c)}const Et=Ot.prototype;function kt(e){E.call(this,{},e),this._mlen=0,this._mods=[]}function qt(e,t,n,i){const a=i.sort,s=a&&!i.ignorePeers,r=i.frame||[null,0],l=e.data(n),u=l.length,o=s?J(a):null,d={i0:0,i1:0,p0:0,p1:0,index:0,data:l,compare:a||c(-1)};t.init();for(let e=0;e<u;++e)wt(d,r,e,u),s&&Rt(d,o),t.update(d,l[e])}function wt(e,t,n,i){e.p0=e.i0,e.p1=e.i1,e.i0=null==t[0]?0:Math.max(0,n-Math.abs(t[0])),e.i1=null==t[1]?i:Math.min(i,n+Math.abs(t[1])+1),e.index=n}function Rt(e,t){const n=e.i0,i=e.i1-1,a=e.compare,s=e.data,r=s.length-1;n>0&&!a(s[n],s[n-1])&&(e.i0=t.left(s,s[n])),i<r&&!a(s[i],s[i+1])&&(e.i1=t.right(s,s[i]))}Et.init=function(){this.windows.forEach((e=>e.init())),this.cell&&this.cell.init()},Et.update=function(e,t){const n=this.cell,i=this.windows,a=e.data,s=i&&i.length;let r;if(n){for(r=e.p0;r<e.i0;++r)n.rem(a[r]);for(r=e.p1;r<e.i1;++r)n.add(a[r]);n.set(t)}for(r=0;r<s;++r)i[r].update(e,t)},kt.Definition={type:"Window",metadata:{modifies:!0},params:[{name:"sort",type:"compare"},{name:"groupby",type:"field",array:!0},{name:"ops",type:"enum",array:!0,values:Dt.concat(ue)},{name:"params",type:"number",null:!0,array:!0},{name:"aggregate_params",type:"number",null:!0,array:!0},{name:"fields",type:"field",null:!0,array:!0},{name:"as",type:"string",null:!0,array:!0},{name:"frame",type:"number",null:!0,array:!0,length:2,default:[null,0]},{name:"ignorePeers",type:"boolean",default:!1}]},e(kt,E,{transform(e,t){this.stamp=t.stamp;const n=e.modified(),i=R(e.sort),a=ie(e.groupby),s=e=>this.group(a(e));let r=this.state;r&&!n||(r=this.state=new Ot(e)),n||t.modified(r.inputs)?(this.value={},t.visit(t.SOURCE,(e=>s(e).add(e)))):(t.visit(t.REM,(e=>s(e).remove(e))),t.visit(t.ADD,(e=>s(e).add(e))));for(let t=0,n=this._mlen;t<n;++t)qt(this._mods[t],r,i,e);return this._mlen=0,this._mods=[],t.reflow(n).modifies(r.outputs)},group(e){let t=this.value[e];return t||(t=this.value[e]=xe(w),t.stamp=-1),t.stamp<this.stamp&&(t.stamp=this.stamp,this._mods[this._mlen++]=t),t}});export{ye as aggregate,_e as bin,be as collect,De as compare,Ee as countpattern,ke as cross,Se as density,Ae as dotbin,ze as expression,Fe as extent,je as facet,Pe as field,$e as filter,We as flatten,Be as fold,Je as formula,Ke as generate,He as impute,Ve as joinaggregate,Xe as kde,Ye as key,et as load,nt as lookup,it as multiextent,st as multivalues,lt as params,ut as pivot,ot as prefacet,dt as project,mt as proxy,ft as quantile,ct as relay,ht as sample,pt as sequence,vt as sieve,Ie as subflow,gt as timeunit,_t as tupleindex,xt as values,kt as window};export default null;
//# sourceMappingURL=/sm/e4c0991149bb1af563a22eb8ab85c28c1e33c814bf943f873cd7a36584b09927.map