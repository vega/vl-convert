import{toSet as h,stringValue as m,error as c,isArray as w,isObject as p,hasOwnProperty as E,truthy as O,accessor as g,key as S,field as j,array as C,compare as P}from"/-/vega-util@v1.17.0-uRskU0IBL2vWCP4Va8OC/dist=es2020,mode=imports,min/optimized/vega-util.js";import{tupleid as v}from"/-/vega-dataflow@v5.7.4-DrCzG6Luqf74SfPN5Hxw/dist=es2020,mode=imports,min/optimized/vega-dataflow.js";function I(t){const e=this,n=t.operators||[];return t.background&&(e.background=t.background),t.eventConfig&&(e.eventConfig=t.eventConfig),t.locale&&(e.locale=t.locale),n.forEach(r=>e.parseOperator(r)),n.forEach(r=>e.parseOperatorParameters(r)),(t.streams||[]).forEach(r=>e.parseStream(r)),(t.updates||[]).forEach(r=>e.parseUpdate(r)),e.resolve()}const F=h(["rule"]),$=h(["group","image","rect"]);function q(t,e){let n="";return F[e]||(t.x2&&(t.x?($[e]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),t.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),t.y2&&(t.y?($[e]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),t.yc&&(n+="o.y=o.yc-(o.height||0)/2;")),n}function l(t){return(t+"").toLowerCase()}function z(t){return l(t)==="operator"}function D(t){return l(t)==="collect"}function f(t,e,n){n[n.length-1]!==";"&&(n="return("+n+");");const r=Function(...e.concat(n));return t&&t.functions?r.bind(t.functions):r}function L(t,e,n,r){return"((u = ".concat(t,") < (v = ").concat(e,") || u == null) && v != null ? ").concat(n,`
  : (u > v || v == null) && u != null ? `).concat(r,`
  : ((v = v instanceof Date ? +v : v), (u = u instanceof Date ? +u : u)) !== u && v === v ? `).concat(n,`
  : v !== v && u === u ? `).concat(r," : ")}var R={operator:(t,e)=>f(t,["_"],e.code),parameter:(t,e)=>f(t,["datum","_"],e.code),event:(t,e)=>f(t,["event"],e.code),handler:(t,e)=>{const n="var datum=event.item&&event.item.datum;return ".concat(e.code,";");return f(t,["_","event"],n)},encode:(t,e)=>{const{marktype:n,channels:r}=e;let o="var o=item,datum=o.datum,m=0,$;";for(const a in r){const i="o["+m(a)+"]";o+="$=".concat(r[a].code,";if(").concat(i,"!==$)").concat(i,"=$,m=1;")}return o+=q(r,n),o+="return m;",f(t,["item","_"],o)},codegen:{get(t){const e="[".concat(t.map(m).join("]["),"]"),n=Function("_","return _".concat(e,";"));return n.path=e,n},comparator(t,e){let n;const r=(a,i)=>{const s=e[i];let u,d;return a.path?(u="a".concat(a.path),d="b".concat(a.path)):((n=n||{})["f"+i]=a,u="this.f".concat(i,"(a)"),d="this.f".concat(i,"(b)")),L(u,d,-s,s)},o=Function("a","b","var u, v; return "+t.map(r).join("")+"0;");return n?o.bind(n):o}}};function U(t){const e=this;z(t.type)||!t.type?e.operator(t,t.update?e.operatorExpression(t.update):null):e.transform(t,t.type)}function A(t){const e=this;if(t.params){const n=e.get(t.id);n||c("Invalid operator id: "+t.id),e.dataflow.connect(n,n.parameters(e.parseParameters(t.params),t.react,t.initonly))}}function K(t,e){e=e||{};const n=this;for(const r in t){const o=t[r];e[r]=w(o)?o.map(a=>x(a,n,e)):x(o,n,e)}return e}function x(t,e,n){if(!t||!p(t))return t;for(let r=0,o=y.length,a;r<o;++r)if(a=y[r],E(t,a.key))return a.parse(t,e,n);return t}var y=[{key:"$ref",parse:N},{key:"$key",parse:V},{key:"$expr",parse:T},{key:"$field",parse:B},{key:"$encode",parse:H},{key:"$compare",parse:G},{key:"$context",parse:J},{key:"$subflow",parse:W},{key:"$tupleid",parse:M}];function N(t,e){return e.get(t.$ref)||c("Operator not defined: "+t.$ref)}function T(t,e,n){t.$params&&e.parseParameters(t.$params,n);const r="e:"+t.$expr.code+"_"+t.$name;return e.fn[r]||(e.fn[r]=g(e.parameterExpression(t.$expr),t.$fields,t.$name))}function V(t,e){const n="k:"+t.$key+"_"+!!t.$flat;return e.fn[n]||(e.fn[n]=S(t.$key,t.$flat,e.expr.codegen))}function B(t,e){if(!t.$field)return null;const n="f:"+t.$field+"_"+t.$name;return e.fn[n]||(e.fn[n]=j(t.$field,t.$name,e.expr.codegen))}function G(t,e){const n="c:"+t.$compare+"_"+t.$order,r=C(t.$compare).map(o=>o&&o.$tupleid?v:o);return e.fn[n]||(e.fn[n]=P(r,t.$order,e.expr.codegen))}function H(t,e){const n=t.$encode,r={};for(const o in n){const a=n[o];r[o]=g(e.encodeExpression(a.$expr),a.$fields),r[o].output=a.$output}return r}function J(t,e){return e}function W(t,e){const n=t.$subflow;return function(r,o,a){const i=e.fork().parse(n),s=i.get(n.operators[0].id),u=i.signals.parent;return u&&u.set(a),s.detachSubflow=()=>e.detach(i),s}}function M(){return v}function Q(t){var e=this,n=t.filter!=null?e.eventExpression(t.filter):void 0,r=t.stream!=null?e.get(t.stream):void 0,o;t.source?r=e.events(t.source,t.type,n):t.merge&&(o=t.merge.map(a=>e.get(a)),r=o[0].merge.apply(o[0],o.slice(1))),t.between&&(o=t.between.map(a=>e.get(a)),r=r.between(o[0],o[1])),t.filter&&(r=r.filter(n)),t.throttle!=null&&(r=r.throttle(+t.throttle)),t.debounce!=null&&(r=r.debounce(+t.debounce)),r==null&&c("Invalid stream definition: "+JSON.stringify(t)),t.consume&&r.consume(!0),e.stream(t,r)}function X(t){var e=this,n=p(n=t.source)?n.$ref:n,r=e.get(n),o=null,a=t.update,i=void 0;r||c("Source not defined: "+t.source),o=t.target&&t.target.$expr?e.eventExpression(t.target.$expr):e.get(t.target),a&&a.$expr&&(a.$params&&(i=e.parseParameters(a.$params)),a=e.handlerExpression(a.$expr)),e.update(t,r,o,a,i)}const Y={skip:!0};function Z(t){var e=this,n={};if(t.signals){var r=n.signals={};Object.keys(e.signals).forEach(a=>{const i=e.signals[a];t.signals(a,i)&&(r[a]=i.value)})}if(t.data){var o=n.data={};Object.keys(e.data).forEach(a=>{const i=e.data[a];t.data(a,i)&&(o[a]=i.input.value)})}return e.subcontext&&t.recurse!==!1&&(n.subcontext=e.subcontext.map(a=>a.getState(t))),n}function _(t){var e=this,n=e.dataflow,r=t.data,o=t.signals;Object.keys(o||{}).forEach(a=>{n.update(e.signals[a],o[a],Y)}),Object.keys(r||{}).forEach(a=>{n.pulse(e.data[a].input,n.changeset().remove(O).insert(r[a]))}),(t.subcontext||[]).forEach((a,i)=>{const s=e.subcontext[i];s&&s.setState(a)})}function tt(t,e,n,r){return new b(t,e,n,r)}function b(t,e,n,r){this.dataflow=t,this.transforms=e,this.events=t.events.bind(t),this.expr=r||R,this.signals={},this.scales={},this.nodes={},this.data={},this.fn={},n&&(this.functions=Object.create(n),this.functions.context=this)}function k(t){this.dataflow=t.dataflow,this.transforms=t.transforms,this.events=t.events,this.expr=t.expr,this.signals=Object.create(t.signals),this.scales=Object.create(t.scales),this.nodes=Object.create(t.nodes),this.data=Object.create(t.data),this.fn=Object.create(t.fn),t.functions&&(this.functions=Object.create(t.functions),this.functions.context=this)}b.prototype=k.prototype={fork(){const t=new k(this);return(this.subcontext||(this.subcontext=[])).push(t),t},detach(t){this.subcontext=this.subcontext.filter(n=>n!==t);const e=Object.keys(t.nodes);for(const n of e)t.nodes[n]._targets=null;for(const n of e)t.nodes[n].detach();t.nodes=null},get(t){return this.nodes[t]},set(t,e){return this.nodes[t]=e},add(t,e){const n=this,r=n.dataflow,o=t.value;if(n.set(t.id,e),D(t.type)&&o&&(o.$ingest?r.ingest(e,o.$ingest,o.$format):o.$request?r.preload(e,o.$request,o.$format):r.pulse(e,r.changeset().insert(o))),t.root&&(n.root=e),t.parent){let a=n.get(t.parent.$ref);a?(r.connect(a,[e]),e.targets().add(a)):(n.unresolved=n.unresolved||[]).push(()=>{a=n.get(t.parent.$ref),r.connect(a,[e]),e.targets().add(a)})}if(t.signal&&(n.signals[t.signal]=e),t.scale&&(n.scales[t.scale]=e),t.data)for(const a in t.data){const i=n.data[a]||(n.data[a]={});t.data[a].forEach(s=>i[s]=e)}},resolve(){return(this.unresolved||[]).forEach(t=>t()),delete this.unresolved,this},operator(t,e){this.add(t,this.dataflow.add(t.value,e))},transform(t,e){this.add(t,this.dataflow.add(this.transforms[l(e)]))},stream(t,e){this.set(t.id,e)},update(t,e,n,r,o){this.dataflow.on(e,n,r,o,t.options)},operatorExpression(t){return this.expr.operator(this,t)},parameterExpression(t){return this.expr.parameter(this,t)},eventExpression(t){return this.expr.event(this,t)},handlerExpression(t){return this.expr.handler(this,t)},encodeExpression(t){return this.expr.encode(this,t)},parse:I,parseOperator:U,parseOperatorParameters:A,parseParameters:K,parseStream:Q,parseUpdate:X,getState:Z,setState:_};export{tt as context};export default null;
