import{textMetrics as F,Marks as oe}from"/-/vega-scenegraph@v4.10.0-2GCI9CL2cGgIKRDV0eDe/dist=es2020,mode=imports,min/optimized/vega-scenegraph.js";import{canvas as K}from"/-/vega-canvas@v1.2.6-LOIUlXMv11fR2KwlkAGG/dist=es2020,mode=imports,min/optimized/vega-canvas.js";import{Transform as ne,rederive as fe}from"/-/vega-dataflow@v5.7.4-DrCzG6Luqf74SfPN5Hxw/dist=es2020,mode=imports,min/optimized/vega-dataflow.js";import{inherits as le,isFunction as ue,error as se,array as re}from"/-/vega-util@v1.17.0-uRskU0IBL2vWCP4Va8OC/dist=es2020,mode=imports,min/optimized/vega-util.js";const V=4278190080;function me(e,a){const f=e.bitmap();return(a||[]).forEach(l=>f.set(e(l.boundary[0]),e(l.boundary[3]))),[f,void 0]}function ce(e,a,f,l,i){const n=e.width,t=e.height,s=l||i,v=K(n,t).getContext("2d"),r=K(n,t).getContext("2d"),m=s&&K(n,t).getContext("2d");f.forEach(g=>j(v,g,!1)),j(r,a,!1),s&&j(m,a,!0);const c=X(v,n,t),o=X(r,n,t),u=s&&X(m,n,t),d=e.bitmap(),y=s&&e.bitmap();let p,w,b,x,k,A,R,h;for(w=0;w<t;++w)for(p=0;p<n;++p)k=w*n+p,A=c[k]&V,h=o[k]&V,R=s&&u[k]&V,(A||R||h)&&(b=e(p),x=e(w),!i&&(A||h)&&d.set(b,x),s&&(A||R)&&y.set(b,x));return[d,y]}function X(e,a,f){return new Uint32Array(e.getImageData(0,0,a,f).data.buffer)}function j(e,a,f){if(!a.length)return;const l=a[0].mark.marktype;l==="group"?a.forEach(i=>{i.items.forEach(n=>j(e,n.items,f))}):oe[l].draw(e,{items:f?a.map(de):a})}function de(e){const a=fe(e,{});return a.stroke&&a.strokeOpacity!==0||a.fill&&a.fillOpacity!==0?{...a,strokeOpacity:1,stroke:"#000",fillOpacity:0}:a}const T=5,L=31,U=32,W=new Uint32Array(U+1),B=new Uint32Array(U+1);B[0]=0,W[0]=~B[0];for(let e=1;e<=U;++e)B[e]=B[e-1]<<1|1,W[e]=~B[e];function he(e,a){const f=new Uint32Array(~~((e*a+U)/U));function l(n,t){f[n]|=t}function i(n,t){f[n]&=t}return{array:f,get:(n,t)=>{const s=t*e+n;return f[s>>>T]&1<<(s&L)},set:(n,t)=>{const s=t*e+n;l(s>>>T,1<<(s&L))},clear:(n,t)=>{const s=t*e+n;i(s>>>T,~(1<<(s&L)))},getRange:(n,t,s,v)=>{let r=v,m,c,o,u;for(;r>=t;--r)if(m=r*e+n,c=r*e+s,o=m>>>T,u=c>>>T,o===u){if(f[o]&W[m&L]&B[(c&L)+1])return!0}else{if(f[o]&W[m&L])return!0;if(f[u]&B[(c&L)+1])return!0;for(let d=o+1;d<u;++d)if(f[d])return!0}return!1},setRange:(n,t,s,v)=>{let r,m,c,o,u;for(;t<=v;++t)if(r=t*e+n,m=t*e+s,c=r>>>T,o=m>>>T,c===o)l(c,W[r&L]&B[(m&L)+1]);else for(l(c,W[r&L]),l(o,B[(m&L)+1]),u=c+1;u<o;++u)l(u,4294967295)},clearRange:(n,t,s,v)=>{let r,m,c,o,u;for(;t<=v;++t)if(r=t*e+n,m=t*e+s,c=r>>>T,o=m>>>T,c===o)i(c,B[r&L]|W[(m&L)+1]);else for(i(c,B[r&L]),i(o,W[(m&L)+1]),u=c+1;u<o;++u)i(u,0)},outOfBounds:(n,t,s,v)=>n<0||t<0||v>=a||s>=e}}function xe(e,a,f){const l=Math.max(1,Math.sqrt(e*a/1e6)),i=~~((e+2*f+l)/l),n=~~((a+2*f+l)/l),t=s=>~~((s+f)/l);return t.invert=s=>s*l-f,t.bitmap=()=>he(i,n),t.ratio=l,t.padding=f,t.width=e,t.height=a,t}function ye(e,a,f,l){const i=e.width,n=e.height;return function(t){const s=t.datum.datum.items[l].items,v=s.length,r=t.datum.fontSize,m=F.width(t.datum,t.datum.text);let c=0,o,u,d,y,p,w,b;for(let x=0;x<v;++x)o=s[x].x,d=s[x].y,u=s[x].x2===void 0?o:s[x].x2,y=s[x].y2===void 0?d:s[x].y2,p=(o+u)/2,w=(d+y)/2,b=Math.abs(u-o+y-d),b>=c&&(c=b,t.x=p,t.y=w);return p=m/2,w=r/2,o=t.x-p,u=t.x+p,d=t.y-w,y=t.y+w,t.align="center",o<0&&u<=i?t.align="left":0<=o&&i<u&&(t.align="right"),t.baseline="middle",d<0&&y<=n?t.baseline="top":0<=d&&n<y&&(t.baseline="bottom"),!0}}function q(e,a,f,l,i,n){let t=f/2;return e-t<0||e+t>i||a-(t=l/2)<0||a+t>n}function G(e,a,f,l,i,n,t,s){const v=i*n/(l*2),r=e(a-v),m=e(a+v),c=e(f-(n=n/2)),o=e(f+n);return t.outOfBounds(r,c,m,o)||t.getRange(r,c,m,o)||s&&s.getRange(r,c,m,o)}function ge(e,a,f,l){const i=e.width,n=e.height,t=a[0],s=a[1];function v(r,m,c,o,u){const d=e.invert(r),y=e.invert(m);let p=c,w=n,b;if(!q(d,y,o,u,i,n)&&!G(e,d,y,u,o,p,t,s)&&!G(e,d,y,u,o,u,t,null)){for(;w-p>=1;)b=(p+w)/2,G(e,d,y,u,o,b,t,s)?w=b:p=b;if(p>c)return[d,y,p,!0]}}return function(r){const m=r.datum.datum.items[l].items,c=m.length,o=r.datum.fontSize,u=F.width(r.datum,r.datum.text);let d=f?o:0,y=!1,p=!1,w=0,b,x,k,A,R,h,g,I,M,O,z,E,P,S,C,N,H;for(let D=0;D<c;++D){for(b=m[D].x,k=m[D].y,x=m[D].x2===void 0?b:m[D].x2,A=m[D].y2===void 0?k:m[D].y2,b>x&&(H=b,b=x,x=H),k>A&&(H=k,k=A,A=H),M=e(b),z=e(x),O=~~((M+z)/2),E=e(k),S=e(A),P=~~((E+S)/2),g=O;g>=M;--g)for(I=P;I>=E;--I)N=v(g,I,d,u,o),N&&([r.x,r.y,d,y]=N);for(g=O;g<=z;++g)for(I=P;I<=S;++I)N=v(g,I,d,u,o),N&&([r.x,r.y,d,y]=N);!y&&!f&&(C=Math.abs(x-b+A-k),R=(b+x)/2,h=(k+A)/2,C>=w&&!q(R,h,u,o,i,n)&&!G(e,R,h,o,u,o,t,null)&&(w=C,r.x=R,r.y=h,p=!0))}return y||p?(R=u/2,h=o/2,t.setRange(e(r.x-R),e(r.y-h),e(r.x+R),e(r.y+h)),r.align="center",r.baseline="middle",!0):!1}}const pe=[-1,-1,1,1],be=[-1,1,-1,1];function ve(e,a,f,l){const i=e.width,n=e.height,t=a[0],s=a[1],v=e.bitmap();return function(r){const m=r.datum.datum.items[l].items,c=m.length,o=r.datum.fontSize,u=F.width(r.datum,r.datum.text),d=[];let y=f?o:0,p=!1,w=!1,b=0,x,k,A,R,h,g,I,M,O,z,E,P;for(let S=0;S<c;++S){for(x=m[S].x,A=m[S].y,k=m[S].x2===void 0?x:m[S].x2,R=m[S].y2===void 0?A:m[S].y2,d.push([e((x+k)/2),e((A+R)/2)]);d.length;){if([I,M]=d.pop(),t.get(I,M)||s.get(I,M)||v.get(I,M))continue;v.set(I,M);for(let C=0;C<4;++C)h=I+pe[C],g=M+be[C],v.outOfBounds(h,g,h,g)||d.push([h,g]);if(h=e.invert(I),g=e.invert(M),O=y,z=n,!q(h,g,u,o,i,n)&&!G(e,h,g,o,u,O,t,s)&&!G(e,h,g,o,u,o,t,null)){for(;z-O>=1;)E=(O+z)/2,G(e,h,g,o,u,E,t,s)?z=E:O=E;O>y&&(r.x=h,r.y=g,y=O,p=!0)}}!p&&!f&&(P=Math.abs(k-x+R-A),h=(x+k)/2,g=(A+R)/2,P>=b&&!q(h,g,u,o,i,n)&&!G(e,h,g,o,u,o,t,null)&&(b=P,r.x=h,r.y=g,w=!0))}return p||w?(h=u/2,g=o/2,t.setRange(e(r.x-h),e(r.y-g),e(r.x+h),e(r.y+g)),r.align="center",r.baseline="middle",!0):!1}}const Ae=["right","center","left"],Me=["bottom","middle","top"];function we(e,a,f,l){const i=e.width,n=e.height,t=a[0],s=a[1],v=l.length;return function(r){var m;const c=r.boundary,o=r.datum.fontSize;if(c[2]<0||c[5]<0||c[0]>i||c[3]>n)return!1;let u=(m=r.textWidth)!==null&&m!==void 0?m:0,d,y,p,w,b,x,k,A,R,h,g,I,M,O,z;for(let E=0;E<v;++E){if(d=(f[E]&3)-1,y=(f[E]>>>2&3)-1,p=d===0&&y===0||l[E]<0,w=d&&y?Math.SQRT1_2:1,b=l[E]<0?-1:1,x=c[1+d]+l[E]*d*w,g=c[4+y]+b*o*y/2+l[E]*y*w,A=g-o/2,R=g+o/2,I=e(x),O=e(A),z=e(R),!u)if(ae(I,I,O,z,t,s,x,x,A,R,c,p))u=F.width(r.datum,r.datum.text);else continue;if(h=x+b*u*d/2,x=h-u/2,k=h+u/2,I=e(x),M=e(k),ae(I,M,O,z,t,s,x,k,A,R,c,p))return r.x=d?d*b<0?k:x:h,r.y=y?y*b<0?R:A:g,r.align=Ae[d*b+1],r.baseline=Me[y*b+1],t.setRange(I,O,M,z),!0}return!1}}function ae(e,a,f,l,i,n,t,s,v,r,m,c){return!(i.outOfBounds(e,f,a,l)||(c&&n||i).getRange(e,f,a,l))}const Q=0,Y=4,Z=8,J=0,_=1,$=2,ke={"top-left":Q+J,top:Q+_,"top-right":Q+$,left:Y+J,middle:Y+_,right:Y+$,"bottom-left":Z+J,bottom:Z+_,"bottom-right":Z+$},Re={naive:ye,"reduced-search":ge,floodfill:ve};function Ie(e,a,f,l,i,n,t,s,v,r,m){if(!e.length)return e;const c=Math.max(l.length,i.length),o=Oe(l,c),u=ze(i,c),d=Ee(e[0].datum),y=d==="group"&&e[0].datum.items[v].marktype,p=y==="area",w=Le(d,y,s,v),b=r===null||r===Infinity,x=p&&m==="naive";let k=-1,A=-1;const R=e.map(M=>{const O=b?F.width(M,M.text):void 0;return k=Math.max(k,O),A=Math.max(A,M.fontSize),{datum:M,opacity:0,x:void 0,y:void 0,align:void 0,baseline:void 0,boundary:w(M),textWidth:O}});r=r===null||r===Infinity?Math.max(k,A)+Math.max(...l):r;const h=xe(a[0],a[1],r);let g;if(!x){f&&R.sort((z,E)=>f(z.datum,E.datum));let M=!1;for(let z=0;z<u.length&&!M;++z)M=u[z]===5||o[z]<0;const O=(d&&t||p)&&e.map(z=>z.datum);g=n.length||O?ce(h,O||[],n,M,p):me(h,t&&R)}const I=p?Re[m](h,g,t,v):we(h,g,u,o);return R.forEach(M=>M.opacity=+I(M)),R}function Oe(e,a){const f=new Float64Array(a),l=e.length;for(let i=0;i<l;++i)f[i]=e[i]||0;for(let i=l;i<a;++i)f[i]=f[l-1];return f}function ze(e,a){const f=new Int8Array(a),l=e.length;for(let i=0;i<l;++i)f[i]|=ke[e[i]];for(let i=l;i<a;++i)f[i]=f[l-1];return f}function Ee(e){return e&&e.mark&&e.mark.marktype}function Le(e,a,f,l){const i=n=>[n.x,n.x,n.x,n.y,n.y,n.y];return e?e==="line"||e==="area"?n=>i(n.datum):a==="line"?n=>{const t=n.datum.items[l].items;return i(t.length?t[f==="start"?0:t.length-1]:{x:NaN,y:NaN})}:n=>{const t=n.datum.bounds;return[t.x1,(t.x1+t.x2)/2,t.x2,t.y1,(t.y1+t.y2)/2,t.y2]}:i}const ee=["x","y","opacity","align","baseline"],ie=["top-left","left","bottom-left","top","bottom","top-right","right","bottom-right"];function te(e){ne.call(this,null,e)}te.Definition={type:"Label",metadata:{modifies:!0},params:[{name:"size",type:"number",array:!0,length:2,required:!0},{name:"sort",type:"compare"},{name:"anchor",type:"string",array:!0,default:ie},{name:"offset",type:"number",array:!0,default:[1]},{name:"padding",type:"number",default:0,null:!0},{name:"lineAnchor",type:"string",values:["start","end"],default:"end"},{name:"markIndex",type:"number",default:0},{name:"avoidBaseMark",type:"boolean",default:!0},{name:"avoidMarks",type:"data",array:!0},{name:"method",type:"string",default:"naive"},{name:"as",type:"string",array:!0,length:ee.length,default:ee}]},le(te,ne,{transform(e,a){function f(n){const t=e[n];return ue(t)&&a.modified(t.fields)}const l=e.modified();if(!(l||a.changed(a.ADD_REM)||f("sort")))return;(!e.size||e.size.length!==2)&&se("Size parameter should be specified as a [width, height] array.");const i=e.as||ee;return Ie(a.materialize(a.SOURCE).source||[],e.size,e.sort,re(e.offset==null?1:e.offset),re(e.anchor||ie),e.avoidMarks||[],e.avoidBaseMark!==!1,e.lineAnchor||"end",e.markIndex||0,e.padding===void 0?0:e.padding,e.method||"naive").forEach(n=>{const t=n.datum;t[i[0]]=n.x,t[i[1]]=n.y,t[i[2]]=n.opacity,t[i[3]]=n.align,t[i[4]]=n.baseline}),a.reflow(l).modifies(i)}});export{te as label};export default null;
