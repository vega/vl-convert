name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Temporarily commented out to focus on wheel builds
  # build-cli-linux-x86:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install latest stable Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Install protoc
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install protobuf-compiler
  #     - name: Build vl-convert
  #       run: |
  #         cargo build --release -p vl-convert
  #     - name: Move executable to bin directory
  #       run: |
  #         mkdir -p bin
  #         cp target/release/vl-convert bin/
  #         cp LICENSE bin/
  #         cp thirdparty_* bin/
  #         zip -r vl-convert_linux-64.zip bin/
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: vl-convert-linux-x86
  #         path: |
  #           vl-convert_linux-64.zip

  # build-cli-linux-aarch64:
  #   runs-on: ubuntu-24.04-arm
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install latest stable Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Install protoc
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install protobuf-compiler
  #     - name: Build vl-convert
  #       run: |
  #         cargo build --release -p vl-convert
  #     - name: Move executable to bin directory
  #       run: |
  #         mkdir -p bin
  #         cp target/release/vl-convert bin/
  #         cp LICENSE bin/
  #         cp thirdparty_* bin/
  #         zip -r vl-convert_linux-aarch64.zip bin/
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: vl-convert-linux-aarch64
  #         path: |
  #           vl-convert_linux-aarch64.zip

  # build-cli-win-64:
  #   runs-on: windows-2022
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install latest stable Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Install Protoc
  #       uses: arduino/setup-protoc@v2
  #       with:
  #         repo-token: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Build vl-convert
  #       run: |
  #         cargo build --release -p vl-convert
  #     - name: Move executable to bin directory
  #       run: |
  #         New-Item -Path "artifacts\bin" -ItemType Directory
  #         Copy-Item "target\release\vl-convert.exe" -Destination "artifacts\bin"
  #         Copy-Item "LICENSE" -Destination "artifacts\bin"
  #         Copy-Item "thirdparty_*" -Destination "artifacts\bin"
  #     - name: zip executable
  #       uses: papeloto/action-zip@v1
  #       with:
  #         files: artifacts/
  #         dest: vl-convert_win-64.zip
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: vl-convert-win-64
  #         path: |
  #           vl-convert_win-64.zip

  # build-cli-osx-64:
  #   runs-on: macos-15-intel
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install latest stable Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Install Protoc
  #       uses: arduino/setup-protoc@v2
  #       with:
  #         repo-token: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Build vl-convert
  #       run: |
  #         cargo build --release -p vl-convert
  #     - name: Move executable to bin directory
  #       run: |
  #         mkdir -p bin
  #         cp target/release/vl-convert bin/
  #         cp LICENSE bin/
  #         cp thirdparty_* bin/
  #         zip -r vl-convert_osx-64.zip bin/
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: vl-convert-osx-64
  #         path: |
  #           vl-convert_osx-64.zip

  # build-cli-osx-arm64:
  #   runs-on: macos-14
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install latest stable Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #     - name: Install Protoc
  #       uses: arduino/setup-protoc@v2
  #       with:
  #         repo-token: ${{ secrets.GITHUB_TOKEN }}
  #     - name: Build vl-convert
  #       run: |
  #         cargo build --release -p vl-convert
  #     - name: Move executable to bin directory
  #       run: |
  #         mkdir -p bin
  #         cp target/release/vl-convert bin/
  #         cp LICENSE bin/
  #         cp thirdparty_* bin/
  #         zip -r vl-convert_osx-arm64.zip bin/
  #     - name: Upload artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: vl-convert-osx-arm64
  #         path: |
  #           vl-convert_osx-arm64.zip

  build-wheels-linux-x86_64:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-x86_64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "Pre-built V8 downloaded successfully"
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "No pre-built V8 available, will build from source"
          fi

      - uses: messense/maturin-action@v1
        with:
          manylinux: 2_28
          target: x86_64-unknown-linux-gnu
          command: build
          args: --release -m vl-convert-python/Cargo.toml --sdist -o dist --strip
          docker-options: >-
            -v ${{ github.workspace }}/v8-prebuilt:/v8-prebuilt
            ${{ steps.download-v8.outputs.downloaded == 'true' && '-e RUSTY_V8_ARCHIVE=/v8-prebuilt/librusty_v8.a' || '-e V8_FROM_SOURCE=1' }}
            ${{ steps.download-v8.outputs.downloaded != 'true' && '-e GN_ARGS=v8_monolithic=true v8_monolithic_for_shared_library=true is_component_build=false v8_enable_temporal_support=false enable_rust=false treat_warnings_as_errors=false symbol_level=0' || '' }}
          before-script-linux: |
            # Install build dependencies
            dnf install -y glib2-devel libffi-devel clang-devel || yum install -y glib2-devel libffi-devel clang-devel

            # Install protoc
            PB_REL="https://github.com/protocolbuffers/protobuf/releases"
            curl -LO $PB_REL/download/v24.0/protoc-24.0-linux-x86_64.zip
            unzip protoc-24.0-linux-x86_64.zip -d /usr/

      - name: Test wheel
        run: |
          docker run --rm -v $(pwd)/dist:/dist python:3.11-slim \
            bash -c "pip install /dist/*x86_64*.whl && python -c \"import vl_convert as vlc; themes = vlc.get_themes(); assert 'dark' in themes, f'dark theme not found in {themes}'; print('Wheel test passed: found', len(themes), 'themes including dark')\""

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-x86_64
          path: dist

  build-wheels-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-aarch64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "Pre-built V8 downloaded successfully"
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "No pre-built V8 available, will build from source"
          fi

      - uses: messense/maturin-action@v1
        with:
          manylinux: 2_28
          target: aarch64-unknown-linux-gnu
          command: build
          args: --release -m vl-convert-python/Cargo.toml -o dist --strip
          docker-options: >-
            -v ${{ github.workspace }}/v8-prebuilt:/v8-prebuilt
            ${{ steps.download-v8.outputs.downloaded == 'true' && '-e RUSTY_V8_ARCHIVE=/v8-prebuilt/librusty_v8.a' || '-e V8_FROM_SOURCE=1' }}
            ${{ steps.download-v8.outputs.downloaded != 'true' && '-e GN_ARGS=v8_monolithic=true v8_monolithic_for_shared_library=true is_component_build=false v8_enable_temporal_support=false enable_rust=false treat_warnings_as_errors=false symbol_level=0' || '' }}
          before-script-linux: |
            # Install build dependencies
            dnf install -y glib2-devel libffi-devel clang-devel || yum install -y glib2-devel libffi-devel clang-devel

            # Install protoc
            PB_REL="https://github.com/protocolbuffers/protobuf/releases"
            curl -LO $PB_REL/download/v24.0/protoc-24.0-linux-aarch_64.zip
            unzip protoc-24.0-linux-aarch_64.zip -d /usr/

      - name: Test wheel
        run: |
          docker run --rm -v $(pwd)/dist:/dist python:3.11-slim \
            bash -c "pip install /dist/*aarch64*.whl && python -c \"import vl_convert as vlc; themes = vlc.get_themes(); assert 'dark' in themes, f'dark theme not found in {themes}'; print('Wheel test passed: found', len(themes), 'themes including dark')\""

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-linux-aarch64
          path: dist

  build-wheels-win-64:
    runs-on: windows-latest
    steps:
      - name: Enable long paths
        run: git config --system core.longpaths true
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install NASM
        uses: ilammy/setup-nasm@v1
      - uses: messense/maturin-action@v1
        with:
          command: build
          args: --release -m vl-convert-python/Cargo.toml -o dist --strip
      - name: Test wheel
        run: |
          pip install (Get-ChildItem dist/*.whl)
          python -c "import vl_convert as vlc; themes = vlc.get_themes(); assert 'dark' in themes, f'dark theme not found in {themes}'; print('Wheel test passed: found', len(themes), 'themes including dark')"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-win-64
          path: dist

  build-wheels-osx-64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build Intel wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          args: --release -m vl-convert-python/Cargo.toml -i python3.10 -o dist --strip
          target: x86_64-apple-darwin
      - name: Test wheel
        run: |
          pip install dist/*.whl
          python -c "import vl_convert as vlc; themes = vlc.get_themes(); assert 'dark' in themes, f'dark theme not found in {themes}'; print('Wheel test passed: found', len(themes), 'themes including dark')"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-osx-64
          path: dist

  build-wheels-osx-arm64:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Build arm64 wheels
        uses: messense/maturin-action@v1
        with:
          command: build
          args: --release -m vl-convert-python/Cargo.toml -i python3.10 -o dist --strip
      - name: Test wheel
        run: |
          pip install dist/*.whl
          python -c "import vl_convert as vlc; themes = vlc.get_themes(); assert 'dark' in themes, f'dark theme not found in {themes}'; print('Wheel test passed: found', len(themes), 'themes including dark')"
      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-osx-arm64
          path: dist

  publish-pypi:
    name: Publish to PyPI
    environment: PyPI Upload
    runs-on: ubuntu-latest
    needs:
      [
        build-wheels-linux-x86_64,
        build-wheels-linux-aarch64,
        build-wheels-win-64,
        build-wheels-osx-64,
        build-wheels-osx-arm64,
      ]
    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist/
          merge-multiple: true
      - name: Publish to PyPI
        uses: messense/maturin-action@v1
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_API_TOKEN }}
        with:
          command: upload
          args: --skip-existing dist/*
