name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  # Build V8 from source with fPIC flags for Linux shared library builds (Python wheels)
  # This job skips if the pre-built artifact already exists in GitHub Releases
  build-v8-linux-x86_64:
    runs-on: ubuntu-latest
    outputs:
      v8-version: ${{ steps.v8-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Check if release already exists
        id: check-release
        run: |
          if gh release view "v8-${{ steps.v8-version.outputs.version }}" --json assets -q '.assets[].name' | grep -q "librusty_v8-linux-x86_64.a"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release with linux-x86_64 asset already exists, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build V8 from source
        if: steps.check-release.outputs.exists != 'true'
        run: |
          mkdir -p v8-out
          docker run --rm \
            -v "${{ github.workspace }}:/io" \
            -v "${{ github.workspace }}/v8-out:/v8-out" \
            -w /io \
            -e V8_FROM_SOURCE=1 \
            -e "GN_ARGS=v8_monolithic=true v8_monolithic_for_shared_library=true is_component_build=false v8_enable_temporal_support=false enable_rust=false treat_warnings_as_errors=false symbol_level=0" \
            quay.io/pypa/manylinux_2_28_x86_64 \
            bash -c '
              set -ex

              # Install build dependencies including protoc
              dnf install -y glib2-devel libffi-devel clang-devel protobuf-compiler
              protoc --version

              # Install Rust
              curl --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
              source "$HOME/.cargo/env"

              # Build vl-convert-python (this will compile V8)
              cd /io
              cargo build --release -p vl-convert-python

              # Copy V8 artifact to output volume
              find /io/target -name "librusty_v8.a" -type f 2>/dev/null | head -5
              cp /io/target/release/gn_out/obj/librusty_v8.a /v8-out/librusty_v8-linux-x86_64.a
              ls -la /v8-out/
            '

      - name: Verify V8 artifact
        if: steps.check-release.outputs.exists != 'true'
        run: |
          ls -la v8-out/
          file v8-out/librusty_v8-linux-x86_64.a

      - name: Create or update release
        if: steps.check-release.outputs.exists != 'true'
        run: |
          # Create release if it doesn't exist
          gh release create "v8-${{ steps.v8-version.outputs.version }}" \
            --title "V8 ${{ steps.v8-version.outputs.version }} Pre-built Binaries" \
            --notes "Pre-built V8 static libraries with PIC support for Python wheel builds." \
            --prerelease \
            2>/dev/null || true

          # Upload the artifact
          gh release upload "v8-${{ steps.v8-version.outputs.version }}" \
            v8-out/librusty_v8-linux-x86_64.a \
            --clobber
        env:
          GH_TOKEN: ${{ github.token }}

  build-v8-linux-aarch64:
    runs-on: ubuntu-24.04-arm
    outputs:
      v8-version: ${{ steps.v8-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Check if release already exists
        id: check-release
        run: |
          if gh release view "v8-${{ steps.v8-version.outputs.version }}" --json assets -q '.assets[].name' | grep -q "librusty_v8-linux-aarch64.a"; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Release with linux-aarch64 asset already exists, skipping build"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Build V8 from source
        if: steps.check-release.outputs.exists != 'true'
        run: |
          set -ex
          mkdir -p v8-out
          docker pull quay.io/pypa/manylinux_2_28_aarch64

          cat > /tmp/build-v8.sh << 'SCRIPT'
          set -ex
          dnf install -y glib2-devel libffi-devel clang clang-devel lld compiler-rt protobuf-compiler

          CLANG_VERSION=$(clang++ --version | grep -oP "clang version \K[0-9]+")
          BUILTINS_PATH=$(find /usr/lib*/clang -name "libclang_rt.builtins*.a" 2>/dev/null | head -1)
          if [ -n "$BUILTINS_PATH" ]; then
            for VER in $CLANG_VERSION 19 20 21 22; do
              EXPECTED_DIR="/usr/lib/clang/${VER}/lib/aarch64-unknown-linux-gnu"
              mkdir -p "$EXPECTED_DIR"
              ln -sf "$BUILTINS_PATH" "$EXPECTED_DIR/libclang_rt.builtins.a"
            done
          else
            echo "ERROR: Could not find libclang_rt.builtins.a"
            exit 1
          fi

          curl --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          source "$HOME/.cargo/env"
          cd /io
          cargo build --release -p vl-convert-python
          cp /io/target/release/gn_out/obj/librusty_v8.a /v8-out/librusty_v8-linux-aarch64.a
          SCRIPT

          chmod +x /tmp/build-v8.sh
          docker run --rm \
            -v "${{ github.workspace }}:/io" \
            -v "${{ github.workspace }}/v8-out:/v8-out" \
            -v "/tmp/build-v8.sh:/tmp/build-v8.sh:ro" \
            -w /io \
            -e V8_FROM_SOURCE=1 \
            -e "GN_ARGS=v8_monolithic=true v8_monolithic_for_shared_library=true is_component_build=false v8_enable_temporal_support=false enable_rust=false treat_warnings_as_errors=false symbol_level=0" \
            -e CLANG_BASE_PATH=/usr \
            quay.io/pypa/manylinux_2_28_aarch64 \
            bash /tmp/build-v8.sh

      - name: Create or update release
        if: steps.check-release.outputs.exists != 'true'
        run: |
          gh release create "v8-${{ steps.v8-version.outputs.version }}" \
            --title "V8 ${{ steps.v8-version.outputs.version }} Pre-built Binaries" \
            --notes "Pre-built V8 static libraries with PIC support for Python wheel builds." \
            --prerelease \
            2>/dev/null || true
          gh release upload "v8-${{ steps.v8-version.outputs.version }}" \
            v8-out/librusty_v8-linux-aarch64.a \
            --clobber
        env:
          GH_TOKEN: ${{ github.token }}

  python-fmt:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Check cargo fmt compliance
        run: pixi run fmt-py-check

  # Run on Linux without Pixi due to glibc linker issues with conda toolchain
  rust-fmt-clippy:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-D warnings"
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Check cargo fmt compliance
        run: cargo fmt --all -- --check
      - name: Check no rustc warnings
        run: cargo check --all
      - name: Check for clippy warnings
        run: cargo clippy --all -- -D warnings

  cargo-bundle-license:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Check that license is up to date
        run: pixi run bundle-licenses
      - name: Check that git detects no file changes
        run: git diff --exit-code

  # Run linux tests without Pixi due to undiagnosed linker issues
  #   - undefined reference to fcntl64
  #   - undefined reference to memfd_create
  vl-convert-rs-tests-linux:
    needs: [build-v8-linux-x86_64]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-x86_64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "Pre-built V8 downloaded successfully"
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "No pre-built V8 available, will build from source"
          fi

      - name: Install fonts on Linux
        if: runner.os == 'Linux'
        run: |
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install ttf-mscorefonts-installer
      - name: Run rs tests
        # Run tests on single thread for Deno, which expects this
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: |
          cargo test -p vl-convert-rs -- --test-threads=1
      - name: Run CLI tests
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: |
          cargo test -p vl-convert -- --test-threads=1

      # HTML bundle validation with Chrome headless
      - name: Build CLI for HTML validation
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: cargo build --release -p vl-convert

      - name: Generate HTML files (bundled and unbundled)
        run: |
          mkdir -p html-validation
          # Generate bundled HTML
          ./target/release/vl-convert vl2html \
            -i vl-convert-rs/tests/vl-specs/circle_binned.vl.json \
            -o html-validation/circle_binned_bundled.html \
            --bundle
          ./target/release/vl-convert vl2html \
            -i vl-convert-rs/tests/vl-specs/stacked_bar_h.vl.json \
            -o html-validation/stacked_bar_bundled.html \
            --bundle
          # Generate unbundled HTML (uses CDN)
          ./target/release/vl-convert vl2html \
            -i vl-convert-rs/tests/vl-specs/circle_binned.vl.json \
            -o html-validation/circle_binned_cdn.html
          echo "Generated HTML files:"
          ls -la html-validation/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Puppeteer
        run: npm install puppeteer

      - name: Validate bundled HTML files with Chrome headless
        run: |
          mkdir -p html-validation/screenshots
          # Validate bundled HTML files (these should work offline)
          node scripts/validate-html.mjs \
            html-validation/circle_binned_bundled.html \
            html-validation/screenshots/circle_binned_bundled.png
          node scripts/validate-html.mjs \
            html-validation/stacked_bar_bundled.html \
            html-validation/screenshots/stacked_bar_bundled.png
          echo "All bundled HTML files validated successfully"

      - name: Upload HTML validation screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: html-validation-screenshots
          path: html-validation/

      - name: Upload test failures
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failed-images-linux
          path: |
            vl-convert-rs/tests/vl-specs/failed

  # Run Windows/macOS tests without Pixi to avoid environment issues with V8 and aws-lc-sys
  vl-convert-rs-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - windows-2022
          - macos-15-intel
    # Windows needs larger stack for Deno runtime (default is 1MB vs 8MB on Linux/macOS)
    env:
      RUST_MIN_STACK: 8388608
    steps:
      - name: Enable long paths on Windows
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1
      - name: Run rs tests
        run: cargo test -p vl-convert-rs -- --test-threads=1
      - name: Run CLI tests
        run: cargo test -p vl-convert -- --test-threads=1
      - name: Upload test failures
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failed-images-${{ matrix.os }}
          path: |
            vl-convert-rs/tests/vl-specs/failed

  # Run Linux Python tests without Pixi's conda toolchain due to glibc linker issues
  vl-convert-python-tests-linux:
    needs: [build-v8-linux-x86_64]
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install fonts on Linux
        run: |
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install ttf-mscorefonts-installer
      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-x86_64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi
      - name: Create virtualenv and install dependencies
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install maturin pytest scikit-image pypdfium2
      - name: Build and install package
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: |
          source .venv/bin/activate
          cd vl-convert-python
          maturin develop --release
      - name: Run tests
        run: |
          source .venv/bin/activate
          cd vl-convert-python
          pytest

  vl-convert-python-tests:
    runs-on: ${{ matrix.options[0] }}
    defaults:
      run:
        shell: ${{ matrix.options[2] }}
    strategy:
      fail-fast: false
      matrix:
        options:
          - [windows-2022, "3.10", "pwsh"]
          - [macos-15-intel, "3.10", "bash -l {0}"]
    # Windows needs larger stack for Deno runtime (default is 1MB vs 8MB on Linux/macOS)
    env:
      RUST_MIN_STACK: 8388608
    steps:
      - name: Enable long paths on Windows
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1
      - name: Build package
        run: pixi run dev-py
      - name: Run tests
        run: pixi run test-py

  # Build and test aarch64 Linux wheel using manylinux container
  vl-convert-python-tests-linux-aarch64:
    needs: [build-v8-linux-aarch64]
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT

      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-aarch64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi

      - uses: messense/maturin-action@v1
        with:
          manylinux: 2_28
          target: aarch64-unknown-linux-gnu
          command: build
          args: --release -m vl-convert-python/Cargo.toml -o dist
          docker-options: >-
            -v ${{ github.workspace }}/v8-prebuilt:/v8-prebuilt
            ${{ steps.download-v8.outputs.downloaded == 'true' && '-e RUSTY_V8_ARCHIVE=/v8-prebuilt/librusty_v8.a' || '-e V8_FROM_SOURCE=1' }}
            ${{ steps.download-v8.outputs.downloaded != 'true' && '-e GN_ARGS=v8_monolithic=true v8_monolithic_for_shared_library=true is_component_build=false v8_enable_temporal_support=false enable_rust=false treat_warnings_as_errors=false symbol_level=0' || '' }}
          before-script-linux: |
            dnf install -y glib2-devel libffi-devel clang-devel || yum install -y glib2-devel libffi-devel clang-devel
            PB_REL="https://github.com/protocolbuffers/protobuf/releases"
            curl -LO $PB_REL/download/v24.0/protoc-24.0-linux-aarch_64.zip
            unzip protoc-24.0-linux-aarch_64.zip -d /usr/

      - name: Create image generation script
        run: |
          cat > generate_images.py << 'PYSCRIPT'
          import vl_convert as vlc
          from pathlib import Path

          output_dir = Path("/test-output")
          specs_dir = Path("/workspace/vl-convert-rs/tests/vl-specs")

          vlc.register_font_directory(str(Path("/workspace/vl-convert-rs/tests/fonts")))

          for name in ["circle_binned", "stacked_bar_h", "seattle-weather"]:
              spec_path = specs_dir / f"{name}.vl.json"
              if spec_path.exists():
                  with open(spec_path) as f:
                      spec = f.read()
                  svg = vlc.vegalite_to_svg(spec, vl_version="v5_8")
                  (output_dir / f"{name}.svg").write_text(svg)
                  png = vlc.vegalite_to_png(spec, vl_version="v5_8")
                  (output_dir / f"{name}.png").write_bytes(png)
                  print(f"Generated {name}.svg and {name}.png")
          PYSCRIPT

      - name: Install wheel and run tests
        run: |
          mkdir -p test-output
          docker run --rm \
            -v $(pwd)/dist:/dist \
            -v $(pwd):/workspace \
            -v $(pwd)/test-output:/test-output \
            -v $(pwd)/generate_images.py:/generate_images.py \
            -e RUST_BACKTRACE=1 \
            python:3.11-bookworm \
            bash -c "
              # Enable contrib repo and install MS TrueType core fonts for consistent font metrics
              sed -i 's/^Components: main/Components: main contrib/' /etc/apt/sources.list.d/debian.sources &&
              apt-get update &&
              echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections &&
              apt-get install -y ttf-mscorefonts-installer fontconfig &&
              fc-cache -f &&
              pip install /dist/*aarch64*.whl pytest scikit-image pypdfium2 &&
              cd /workspace/vl-convert-python &&
              python /generate_images.py &&
              pytest -v
            "

      - name: Upload test output images
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: aarch64-test-output
          path: test-output/
