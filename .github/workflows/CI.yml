name: CI

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  python-fmt:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Check cargo fmt compliance
        run: pixi run fmt-py-check

  rust-fmt-clippy:
    runs-on: ubuntu-latest
    env:
      RUSTFLAGS: "-D warnings"
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: True
      - name: Check cargo fmt compliance
        run: pixi run fmt-rs-check
      - name: Check no rustc warnings
        run: pixi run check-rs
      - name: Check for clippy warnings
        run: pixi run clippy

  cargo-bundle-license:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Check that license is up to date
        run: pixi run bundle-licenses
      - name: Check that git detects no file changes
        run: git diff --exit-code

  # Run linux tests without Pixi due to undiagnosed linker issues
  #   - undefined reference to fcntl64
  #   - undefined reference to memfd_create
  vl-convert-rs-tests-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get V8 version from Cargo.lock
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
          echo "V8 version: $V8_VERSION"

      - name: Download pre-built V8
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-x86_64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "Pre-built V8 downloaded successfully"
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "No pre-built V8 available, will build from source"
          fi

      - name: Install fonts on Linux
        if: runner.os == 'Linux'
        run: |
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install ttf-mscorefonts-installer
      - name: Run rs tests
        # Run tests on single thread for Deno, which expects this
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: |
          cargo test -p vl-convert-rs -- --test-threads=1
      - name: Run CLI tests
        env:
          RUSTY_V8_ARCHIVE: ${{ steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: |
          cargo test -p vl-convert -- --test-threads=1
      - name: Upload test failures
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failed-images-linux
          path: |
            vl-convert-rs/tests/vl-specs/failed

  # Run Windows/macOS tests without Pixi to avoid environment issues with V8 and aws-lc-sys
  vl-convert-rs-tests:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - windows-2022
          - macos-15-intel
    steps:
      - name: Enable long paths on Windows
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - name: Check out repository code
        uses: actions/checkout@v4
      - name: Install latest stable Rust toolchain
        uses: dtolnay/rust-toolchain@stable
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install Protoc
        uses: arduino/setup-protoc@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1
      - name: Run rs tests
        run: cargo test -p vl-convert-rs -- --test-threads=1
      - name: Run CLI tests
        run: cargo test -p vl-convert -- --test-threads=1
      - name: Upload test failures
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: failed-images-${{ matrix.os }}
          path: |
            vl-convert-rs/tests/vl-specs/failed

  vl-convert-python-tests:
    runs-on: ${{ matrix.options[0] }}
    defaults:
      run:
        shell: ${{ matrix.options[2] }}
    strategy:
      matrix:
        options:
          - [ubuntu-latest, "3.10", "bash -l {0}"]
          - [windows-2022, "3.10", "pwsh"]
          - [macos-15-intel, "3.10", "bash -l {0}"]
    steps:
      - name: Enable long paths on Windows
        if: runner.os == 'Windows'
        run: git config --system core.longpaths true
      - name: Check out repository code
        uses: actions/checkout@v4
      - uses: prefix-dev/setup-pixi@v0.8.8
        with:
          pixi-version: v0.47.0
      - name: Cache rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          prefix-key: "v1-rust"
          cache-on-failure: True
      - name: Install NASM (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/setup-nasm@v1
      - name: Install fonts on Linux
        if: runner.os == 'Linux'
        run: |
          echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | sudo debconf-set-selections
          sudo apt-get install ttf-mscorefonts-installer

      # Download pre-built V8 with fPIC for Linux (required for shared library builds)
      - name: Get V8 version from Cargo.lock
        if: runner.os == 'Linux'
        id: v8-version
        run: |
          V8_VERSION=$(cargo metadata --format-version 1 | jq -r '.packages[] | select(.name == "v8") | .version')
          echo "version=$V8_VERSION" >> $GITHUB_OUTPUT
      - name: Download pre-built V8
        if: runner.os == 'Linux'
        id: download-v8
        run: |
          mkdir -p v8-prebuilt
          if curl -L -f -o v8-prebuilt/librusty_v8.a \
            "https://github.com/vega/vl-convert/releases/download/v8-${{ steps.v8-version.outputs.version }}/librusty_v8-linux-x86_64.a"; then
            echo "downloaded=true" >> $GITHUB_OUTPUT
            ls -la v8-prebuilt/
          else
            echo "downloaded=false" >> $GITHUB_OUTPUT
            echo "Pre-built V8 not available"
          fi

      - name: Build package
        env:
          RUSTY_V8_ARCHIVE: ${{ runner.os == 'Linux' && steps.download-v8.outputs.downloaded == 'true' && format('{0}/v8-prebuilt/librusty_v8.a', github.workspace) || '' }}
        run: pixi run dev-py
      - name: Run tests
        run: pixi run test-py
